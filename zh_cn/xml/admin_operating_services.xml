<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph-operating-services">
 <title>操作 Ceph 服务</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  您可以使用 <systemitem class="daemon">systemd</systemitem> 或通过 DeepSea 来操作 Ceph 服务。
 </para>
 <sect1 xml:id="operate-services-systemd">
  <title>使用 <systemitem class="daemon">systemd</systemitem> 操作与 Ceph Cluster 相关的服务</title>

  <para>
   使用 <command>systemctl</command> 命令操作所有与 Ceph 相关的服务。操作在您当前登录的节点上进行。您需要具备 <systemitem class="username">root</systemitem> 特权才能操作 Ceph 服务。
  </para>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>使用目标启动、停止和重启动服务</title>
   <para>
    为了简化启动、停止和重启动节点上特定类型的所有服务（例如所有 Ceph 服务、所有 MON 或所有 OSD）的操作，Ceph 提供了以下 <systemitem class="daemon">systemd</systemitem> 单元文件：
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    要启动/停止/重启动节点上的所有 Ceph 服务，请运行以下命令：
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl restart ceph.target
</screen>
   <para>
    要启动/停止/重启动节点上的所有 OSD，请运行以下命令：
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target
</screen>
   <para>
    针对其他目标的命令与此类似。
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-individual">
   <title>启动、停止和重启动个别服务</title>
   <para>
    可以使用以下参数化 <systemitem class="daemon">systemd</systemitem> 单元文件操作个别服务：
   </para>
<screen>
ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-mgr@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service
</screen>
   <para>
    要使用这些命令，首先需要确定要操作的服务的名称。请参见<xref linkend="ceph-operating-services-finding-names"/>了解有关如何识别服务的更多信息。
   </para>
   <para>
    要启动/停止/重启动 <literal>osd.1</literal> 服务，请运行以下命令：
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service
</screen>
   <para>
    针对其他服务类型的命令与此类似。
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>识别个别服务</title>
   <para>
    您可以通过以下几种方式获得某种服务类型的名称/编号。以下命令提供 <literal>ceph*</literal> 服务的结果。您可以在 Ceph 集群的任何节点上运行这些命令。
   </para>
   <para>
    要列出 <literal>ceph*</literal> 类型的所有（甚至是非活跃）服务，请运行以下命令：
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --type=service ceph*
</screen>
   <para>
    如果只想列出非活跃服务，请运行以下命令：
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --state=inactive --type=service ceph*
</screen>
   <para>
    您也可以使用 <command>salt</command> 查询多个节点上的服务：
   </para>
<screen>
<prompt>root@master # </prompt>salt <replaceable>TARGET</replaceable> cmd.shell \
 "systemctl list-units --all --type=service ceph* | sed -e '/^$/,$ d'"
</screen>
   <para>
    仅查询存储节点：
   </para>
<screen>
<prompt>root@master # </prompt>salt -I 'roles:storage' cmd.shell \
 'systemctl list-units --all --type=service ceph*'
</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>服务状态</title>
   <para>
    可以查询 <systemitem class="daemon">systemd</systemitem> 来了解服务的状态。例如：
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    请将 <replaceable>HOSTNAME</replaceable> 替换为运行守护进程的主机名。
   </para>
   <para>
    如果您不知道服务的确切名称/编号，请参见<xref linkend="ceph-operating-services-finding-names"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea-restart">
  <title>使用 DeepSea 重启动 Ceph 服务</title>

  <para>
   将更新应用到集群节点后，需要重启动与 Ceph 相关的受影响服务。通常情况下，DeepSea 会自动执行重启动操作。本节介绍如何手动重启动服务。
  </para>

  <tip>
   <title>检查重启动</title>
   <para>
    重启动集群的过程可能需要一段时间。可通过运行以下命令来使用 Salt 事件总线检查事件：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
   <para>
    另一个用于监视活跃作业的命令为：
   </para>
<screen>
<prompt>root@master # </prompt>salt-run jobs.active
</screen>
  </tip>

  <sect2 xml:id="deepsea-restart-all">
   <title>重启动所有服务</title>
   <warning>
    <title>服务中断</title>
    <para>
     如果与 Ceph 相关的服务（特别是 iSCSI 或 NFS Ganesha）配置为单点访问，并且未设置高可用性，重启动这些服务将导致从客户端进行查看时会出现暂时中断现象。
    </para>
   </warning>
   <tip>
    <title>Samba 不受 DeepSea 管理</title>
    <para>
     由于 DeepSea 和 Ceph Dashboard 当前不支持 Samba 部署，您需要手动管理与 Samba 相关的服务。有关细节，请参见<xref linkend="cha-ses-cifs"/>。
    </para>
   </tip>
   <para>
    要重启动集群上的<emphasis>所有</emphasis>服务，请运行以下命令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <itemizedlist>
    <listitem>
     <para>
      如果 DeepSea 版本低于 0.8.4，则元数据服务器、iSCSI 网关、对象网关和 NFS Ganesha 服务将并行重启动。
     </para>
    </listitem>
    <listitem>
     <para>
      如果 DeepSea 为 0.8.4 或更高版本，您已配置的所有角色将按以下顺序重启动：Ceph Monitor、Ceph Manager、Ceph OSD、元数据服务器、对象网关、iSCSI 网关、NFS Ganesha。为了保持较短的停机时间并尽早发现潜在问题，请按顺序重启动各节点。例如，一次只重启动一个监视节点。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    如果集群处于降级、非健康状况，该命令会等待集群恢复。
   </para>
  </sect2>

  <sect2 xml:id="deepsea-restart-specific">
   <title>重启动特定服务</title>
   <para>
    要重启动集群上的特定服务，请运行以下命令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    例如，要重启动所有对象网关，请运行以下命令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    您可以使用以下目标：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>正常关闭整个 Ceph 集群</title>

  <para>
   在某些情况下，您需要按建议的顺序停止集群中所有与 Ceph 相关的服务，然后才能再次按任意顺序将其启动。例如，发生计划停电的情况时。
  </para>

  <para>
   要关闭整个 Ceph 集群，请禁用安全措施并运行 <command>ceph.shutdown</command> 运行程序：
  </para>

<screen>
<prompt>root@master # </prompt>salt-run disengage.safety
<prompt>root@master # </prompt>salt-run state.orch ceph.shutdown
</screen>

  <para>
   要启动整个 Ceph 集群，请运行 <command>ceph.startup</command> 运行程序：
  </para>

<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.startup
</screen>
 </sect1>
</chapter>
