<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="containerized-kubernetes.xml" version="5.0" xml:id="cha-container-kubernetes">

 <title>部署于 SUSE CaaS Platform 4 Kubernetes 集群上的 SUSE Enterprise Storage 6</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/master/xml/</dm:editurl>
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>编辑</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <warning>
  <title>技术预览</title>
  <para>
   在 SUSE CaaS Platform 上运行容器化 Ceph 集群是一项技术预览功能。请不要在生产 Kubernetes 集群上部署。
  </para>
 </warning>
 <para>
  本章介绍如何在 SUSE CaaS Platform 4 Kubernetes 集群上部署容器化 SUSE Enterprise Storage 6。
 </para>
 <sect1 xml:id="kube-consider">
  <title>注意事项</title>

  <para>
   开始部署前，请考虑以下事项：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     要在 Kubernetes 中运行 Ceph，SUSE Enterprise Storage 6 会使用名为 Rook 的上游项目 (<link xlink:href="https://rook.io/"/>)。
    </para>
   </listitem>
   <listitem>
    <para>
     Rook 可能会占用 Kubernetes 集群中所有节点的<emphasis>全部</emphasis>未使用磁盘，具体视配置而定。
    </para>
   </listitem>
   <listitem>
    <para>
     该设置需要特权容器。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-prereq">
  <title>先决条件</title>

  <para>
   开始部署前，您需要具有以下资源：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     正在运行的 SUSE CaaS Platform 4 集群。
    </para>
   </listitem>
   <listitem>
    <para>
     挂接了一些额外磁盘作为 Ceph 集群存储的 SUSE CaaS Platform 4 工作节点。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-rook-manifests">
  <title>获取 Rook 清单</title>

  <para>
   Rook 协调程序使用称为<emphasis>清单</emphasis>的 YAML 格式配置文件。您所需的清单包含在
   <package>rook-k8s-yaml</package> RPM 包中。可通过运行以下命令来安装该包：
  </para>

<screen><prompt>root # </prompt>zypper install rook-k8s-yaml</screen>
 </sect1>
 <sect1 xml:id="kube-install">
  <title>安装</title>

  <para>
   Rook-Ceph 包含两个主要组件：由 Kubernetes 运行且可用于创建 Ceph 集群的“操作器”，以及 Ceph“集群”本身，由操作器创建并管理它的一部分。
  </para>

  <sect2 xml:id="kube-configure">
   <title>配置</title>
   <sect3 xml:id="kube-configure-global">
    <title>全局配置</title>
    <para>
     此设置中使用的清单会将所有 Rook 和 Ceph 组件都安装在“rook-ceph”名称空间中。如果您需要更改该设置，请相应地将对该名称空间的所有参照纳入 Kubernetes 清单。
    </para>
    <para>
     根据您要使用的 Rook 特性，更改 <filename>common.yaml</filename> 中的“Pod 安全策略”配置，以限制 Rook 的安全要求。按照清单文件中的注释操作。
    </para>
   </sect3>
   <sect3 xml:id="kube-config-operator">
    <title>操作器配置</title>
    <para>
     清单 <filename>operator.yaml</filename> 用于配置 Rook 操作器。通常情况下，您不需要进行更改。有关详细信息，请查阅清单文件中的注释。
    </para>
   </sect3>
   <sect3 xml:id="kube-config-ceph">
    <title>Ceph 集群配置</title>
    <para>
     清单 <filename>cluster.yaml</filename> 负责配置将在 Kubernetes 中运行的实际的 Ceph 集群。有关所有可用选项的详细说明，请参见 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html"/> 中的上游 Rook 文档。
    </para>
    <para>
     Rook 默认配置为使用未通过 <option>node-role.kubernetes.io/master:NoSchedule</option> 污染的所有节点，并将按照配置的归置设置运行（请参见 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html#placement-configuration-settings"/>）。下面的示例禁止此类行为，并仅使用节点部分明确列出的节点：
    </para>
<screen>
storage:
  useAllNodes: false
  nodes:
    - name: caasp4-worker-0
    - name: caasp4-worker-1
    - name: caasp4-worker-2
</screen>
    <note>
     <para>
      Rook 默认配置为使用每个节点上的所有可用和空磁盘来作为 Ceph 存储。
     </para>
    </note>
   </sect3>
   <sect3 xml:id="kube-config-docs">
    <title>文档</title>
    <itemizedlist>
     <listitem>
      <para>
       Rook-Ceph 上游文档 (<link xlink:href="https://rook.github.io/docs/rook/master/ceph-storage.html"/>) 包含有关配置更高级部署的更多详细信息。在进行更高级的配置前，请参考此文档了解 Rook-Ceph 的基本知识。
      </para>
     </listitem>
     <listitem>
      <para>
       有关 SUSE CaaS Platform 产品的更多详细信息，请参见 <link xlink:href="https://www.suse.com/documentation/suse-caasp"/>。
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>

  <sect2 xml:id="kube-config-rook-operator">
   <title>创建 Rook 操作器</title>
   <para>
    通过在 SUSE CaaS Platform 主节点上执行以下命令，安装 Rook-Ceph 通用组件、CSI 角色和 Rook-Ceph 操作器：
   </para>
<screen><prompt>root # </prompt>kubectl apply -f common.yaml -f operator.yaml</screen>
   <para>
    <filename>common.yaml</filename> 将创建“rook-ceph”名称空间、Ceph 自定义资源定义（Custom Resource Definitions，CRD）（请参见 <link xlink:href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/"/>），以使 Kubernetes 可感知 Ceph 对象（例如“CephCluster”）以及 Rook 管理集群特定资源所必需的 RBAC 角色和 Pod 安全策略（请参见 <link xlink:href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/"/>）。
   </para>
   <tip>
    <title><option>hostNetwork</option> 和 <option>hostPorts</option> 的使用</title>
    <para>
     如果在集群资源定义中使用 <option>hostNetwork: true</option>，则必须允许使用 <option>hostNetwork</option>。还需要在 <literal>PodSecurityPolicy</literal> 中允许使用 <option>hostPorts</option>。
    </para>
   </tip>
   <para>
    通过在 SUSE CaaS Platform 主节点上运行 <command>kubectl get pods -n rook-ceph</command> 命令来确认安装，例如：
   </para>
<screen><prompt>root # </prompt>kubectl get pods -n rook-ceph
NAME                                     READY   STATUS      RESTARTS   AGE
rook-ceph-agent-57c9j                    1/1     Running     0          22h
rook-ceph-agent-b9j4x                    1/1     Running     0          22h
rook-ceph-operator-cf6fb96-lhbj7         1/1     Running     0          22h
rook-discover-mb8gv                      1/1     Running     0          22h
rook-discover-tztz4                      1/1     Running     0          22h</screen>
  </sect2>

  <sect2 xml:id="kube-create-ceph-cluster">
   <title>创建 Ceph 集群</title>
   <para>
    根据需要修改 <filename>cluster.yaml</filename> 后，您便可创建 Ceph 集群。在 SUSE CaaS Platform 主节点上运行以下命令：
   </para>
<screen><prompt>root # </prompt>kubectl apply -f cluster.yaml</screen>
   <para>
    监视“rook-ceph”名称空间以查看 Ceph 集群的创建过程。您将看到 <filename>cluster.yaml</filename> 清单中所配置数量的 Ceph Monitor（默认为 3）、一个 Ceph Manager，以及与可用磁盘数量一样多的 Ceph OSD。
   </para>
   <tip>
    <title>临时 OSD Pod</title>
    <para>
     在引导 Ceph 集群时，您会发现一些名为 <literal>rook-ceph-osd-prepare-<replaceable>NODE-NAME</replaceable></literal> 的 Pod 在运行一段时间后会以“已完成”状态终止。其名称表明了这些 Pod 用于供应 Ceph OSD。这些 Pod 将保留下来，不会被删除，以便您可在其终止后检查其日志。例如：
    </para>
<screen><prompt>root # </prompt>kubectl get pods --namespace rook-ceph
NAME                                         READY STATUS    RESTARTS AGE
rook-ceph-agent-57c9j                        1/1   Running   0        22h
rook-ceph-agent-b9j4x                        1/1   Running   0        22h
rook-ceph-mgr-a-6d48564b84-k7dft             1/1   Running   0        22h
rook-ceph-mon-a-cc44b479-5qvdb               1/1   Running   0        22h
rook-ceph-mon-b-6c6565ff48-gm9wz             1/1   Running   0        22h
rook-ceph-operator-cf6fb96-lhbj7             1/1   Running   0        22h
rook-ceph-osd-0-57bf997cbd-4wspg             1/1   Running   0        22h
rook-ceph-osd-1-54cf468bf8-z8jhp             1/1   Running   0        22h
rook-ceph-osd-prepare-caasp4-worker-0-f2tmw  0/2   Completed 0        9m35s
rook-ceph-osd-prepare-caasp4-worker-1-qsfhz  0/2   Completed 0        9m33s
rook-ceph-tools-76c7d559b6-64rkw             1/1   Running   0        22h
rook-discover-mb8gv                          1/1   Running   0        22h
rook-discover-tztz4                          1/1   Running   0        22h</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="kube-using-rook">
  <title>使用 Rook 作为 Kubernetes 工作负载的存储</title>

  <para>
   Rook 允许您使用三种不同类型的存储：
  </para>

  <variablelist>
   <varlistentry>
    <term><emphasis role="bold">对象存储</emphasis></term>
    <listitem>
     <para>
      对象存储会向存储集群公开 S3 API，以供应用存放和获取数据。有关详细说明，请参见 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-object.html"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共享文件系统</term>
    <listitem>
     <para>
      可以使用读/写权限从多个 Pod 装入共享文件系统。这对于使用共享文件系统集群化的应用非常有用。有关详细说明，请参见 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-filesystem.html"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>块存储</term>
    <listitem>
     <para>
      块存储可让您将存储装入到单个 Pod。有关详细说明，请参见 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-block.html"/>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="kube-uninstall">
  <title>卸装 Rook</title>

  <para>
   要卸装 Rook，请执行以下步骤：
  </para>

  <procedure>
   <step>
    <para>
     删除任何占用 Rook 存储的 Kubernetes 应用。
    </para>
   </step>
   <step>
    <para>
     删除您按照<xref linkend="kube-using-rook"/>所述创建的所有对象、文件和/或块存储项目。
    </para>
   </step>
   <step>
    <para>
     删除 Ceph 集群、操作器和相关资源：
    </para>
<screen>
<prompt>root # </prompt>kubectl delete -f cluster.yaml
<prompt>root # </prompt>kubectl delete -f operator.yaml
<prompt>root # </prompt>kubectl delete -f common.yaml
</screen>
   </step>
   <step>
    <para>
     删除主机上的数据：
    </para>
<screen><prompt>root # </prompt>rm -rf /var/lib/rook</screen>
   </step>
   <step>
    <para>
     必要时，擦除 Rook 已使用的磁盘。有关更多详细信息，请参见 <link xlink:href="https://rook.io/docs/rook/master/ceph-teardown.html"/>。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
