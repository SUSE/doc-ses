<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_libvirt.xml" version="5.0" xml:id="cha-ceph-libvirt">
 <title>将 <systemitem class="library">libvirt</systemitem> 与 Ceph 搭配使用</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>编辑</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  <systemitem class="library">libvirt</systemitem> 库在超级管理程序接口与使用这些接口的软件应用之间建立了一个虚拟机抽象层。使用 <systemitem class="library">libvirt</systemitem>，开发人员和系统管理员可将工作重心放在通用管理框架、通用 API、通用外壳接口 (<command>virsh</command>) 以及诸多不同的超级管理程序（包括 QEMU/KVM、Xen、LXC 或 VirtualBox）上。
 </para>
 <para>
  Ceph 块设备支持 QEMU/KVM。您可以通过与 <systemitem class="library">libvirt</systemitem> 连接的软件来使用 Ceph 块设备。云解决方案使用 <systemitem class="library">libvirt</systemitem> 来与 QEMU/KVM 交互，而 QEMU/KVM 通过 <systemitem>librbd</systemitem> 来与 Ceph 块设备交互。
 </para>
 <para>
  要创建使用 Ceph 块设备的 VM，请按以下各节中所述的过程操作。在示例中，我们分别使用了 <literal>libvirt-pool</literal>、<literal>client.libvirt</literal> 和 <literal>new-libvirt-image</literal> 作为存储池名称、用户名和映像名称。您可以根据个人喜好使用任何值，但在执行后续过程中的命令时，请务必替换这些值。
 </para>
 <sect1 xml:id="ceph-libvirt-cfg-ceph">
  <title>配置 Ceph</title>

  <para>
   要将 Ceph 配置为与 <systemitem class="library">libvirt</systemitem> 搭配使用，请执行以下步骤：
  </para>

  <procedure>
   <step>
    <para>
     创建存储池。下面的示例使用存储池名称 <literal>libvirt-pool</literal> 和 128 个归置组。
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     校验该存储池是否存在。
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     创建 Ceph 用户。下面的示例使用 Ceph 用户名 <literal>client.libvirt</literal> 并引用 <literal>libvirt-pool</literal>。
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth get-or-create client.libvirt mon 'profile rbd' osd \
 'profile rbd pool=libvirt-pool'</screen>
    <para>
     校验该名称是否存在。
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth list</screen>
    <note>
     <title>用户名或 ID</title>
     <para>
      <systemitem class="library">libvirt</systemitem> 将使用 ID <literal>libvirt</literal>，而不是 Ceph 名称 <literal>client.libvirt</literal> 来访问 Ceph。有关 ID 与名称之间的差别的详细说明，请参见 <xref linkend="cephx-user"/>。
     </para>
    </note>
   </step>
   <step>
    <para>
     使用 QEMU 在 RBD 池中创建映像。下面的示例使用映像名称 <literal>new-libvirt-image</literal> 并引用 <literal>libvirt-pool</literal>。
    </para>
    <tip>
     <title>密钥环文件位置</title>
     <para>
      <systemitem class="library">libvirt</systemitem> 用户密钥存储在 <filename>/etc/ceph</filename> 目录下的密钥环文件中。需要为密钥环文件指定适当的名称，其中应包含其所属 Ceph 集群的名称。如果集群名称为默认名称“ceph”，则密钥环文件名为 <filename>/etc/ceph/ceph.client.libvirt.keyring</filename>。
     </para>
     <para>
      如果该密钥环不存在，请使用以下命令创建它：
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth get client.libvirt &gt; /etc/ceph/ceph.client.libvirt.keyring</screen>
    </tip>
<screen><prompt>root # </prompt>qemu-img create -f raw rbd:libvirt-pool/new-libvirt-image:id=libvirt 2G</screen>
    <para>
     校验该映像是否存在。
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-virt-manager">
  <title>准备 VM 管理器</title>

  <para>
   虽然您可以单独使用 <systemitem class="library">libvirt</systemitem>，而不借助 VM 管理器，但您可能会发现，使用 <command>virt-manager</command> 创建第一个域会更简单。
  </para>

  <procedure>
   <step>
    <para>
     安装虚拟机管理器。
    </para>
<screen><prompt>root # </prompt>zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     准备/下载要运行虚拟化的系统的 OS 映像。
    </para>
   </step>
   <step>
    <para>
     起动虚拟机管理器。
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-create-vm">
  <title>创建 VM</title>

  <para>
   要使用 <command>virt-manager</command> 创建 VM，请执行以下步骤：
  </para>

  <procedure>
   <step>
    <para>
     从列表中选择连接，右键点击该连接，然后选择<guimenu>新建</guimenu>。
    </para>
   </step>
   <step>
    <para>
     通过提供现有存储的路径来<guimenu>导入现有的磁盘映像</guimenu>。指定 OS 类型和内存设置，并给虚拟机<guimenu>命名</guimenu>，例如 <literal>libvirt-virtual-machine</literal>。
    </para>
   </step>
   <step>
    <para>
     完成配置并启动 VM。
    </para>
   </step>
   <step>
    <para>
     使用 <command>sudo virsh list</command> 校验新建的域是否存在。如果需要，请指定连接字符串，例如
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     在将 VM 配置为与 Ceph 搭配使用前，登录 VM 并将其停止。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-cfg-vm">
  <title>配置 VM</title>

  <para>
   本章重点介绍如何使用 <command>virsh</command> 配置 VM，以与 Ceph 集成。<command>virsh</command> 命令通常需要 root 特权 (<command>sudo</command>)，它不会返回相应的结果，也不会告知您需要 root 特权。有关 <command>virsh</command> 命令的参考信息，请参见 <command>man 1 virsh</command>（需要安装 <package>libvirt-client</package> ）。

  </para>

  <procedure>
   <step>
    <para>
     使用 <command>virsh edit</command>
     <replaceable>vm-domain-name</replaceable> 打开配置文件。
    </para>
<screen><prompt>root # </prompt>virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     &lt;devices&gt; 下面应有一个 &lt;disk&gt; 项。
    </para>
<screen>&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/image/recent-linux.img'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='drive' controller='0' bus='0' unit='0'/&gt;
    &lt;/disk&gt;</screen>
    <para>
     将 <filename>/path/to/image/recent-linux.img</filename> 替换为 OS 映像的路径。
    </para>
    <important>
     <para>
      请使用 <command>sudo virsh edit</command>，不要使用文本编辑器。如果使用文本编辑器编辑 <filename>/etc/libvirt/qemu</filename> 下的配置文件，<systemitem class="library">libvirt</systemitem> 可能无法识别更改。如果 <filename>/etc/libvirt/qemu</filename> 下的 XML 文件内容与 <command>sudo virsh dumpxml</command> <replaceable>vm-domain-name</replaceable> 返回的结果有差异，则表示 VM 可能没有正常工作。
     </para>
    </important>
   </step>
   <step>
    <para>
     将之前创建的 Ceph RBD 映像添加为 &lt;disk&gt; 项。
    </para>
<screen>&lt;disk type='network' device='disk'&gt;
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'&gt;
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/&gt;
        &lt;/source&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;</screen>
    <para>
     将 <replaceable>monitor-host</replaceable> 替换为主机的名称，并根据需要替换存储池名称和/或映像名称。可为 Ceph Monitor 添加多个 &lt;host&gt; 项。<literal>dev</literal> 属性是逻辑设备名称，将显示在 VM 的 <filename>/dev</filename> 目录下。可选的 bus 属性表示要模拟的磁盘设备类型。有效的设置都特定于驱动程序（例如 ide、scsi、virtio、xen、usb 或 sata）。
    </para>
   </step>
   <step>
    <para>
     保存文件。
    </para>
   </step>
   <step>
    <para>
     如果 Ceph 集群已启用身份验证（默认会启用），则您必须生成机密。打开所选的编辑器，并创建包含以下内容的 <filename>secret.xml</filename> 文件：
    </para>
<screen>&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;</screen>
   </step>
   <step>
    <para>
     定义机密。
    </para>
<screen><prompt>root # </prompt>virsh secret-define --file secret.xml
&lt;uuid of secret is output here&gt;</screen>
   </step>
   <step>
    <para>
     获取 <literal>client.libvirt</literal> 密钥，并将密钥字符串保存到某个文件中。
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     设置机密的 UUID。
    </para>
<screen><prompt>root # </prompt>virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     此外，必须通过将以下 <literal>&lt;auth&gt;</literal> 项添加到前面输入的 <literal>&lt;disk&gt;</literal> 元素（请将 uuid 值替换为上述命令行示例的结果），来手动设置机密。
    </para>
<screen><prompt>root # </prompt>virsh edit libvirt-virtual-machine</screen>
    <para>
     然后，在域配置文件中添加 <literal>&lt;auth&gt;&lt;/auth&gt;</literal> 元素：
    </para>
<screen>...
&lt;/source&gt;
&lt;auth username='libvirt'&gt;
        &lt;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/&gt;
&lt;/auth&gt;
&lt;target ...</screen>
    <note>
     <para>
      示例 ID 为 <literal>libvirt</literal>，而不是在<xref linkend="ceph-libvirt-cfg-ceph"/>的步骤 2 中生成的 Ceph 名称 <literal>client.libvirt</literal>。请务必使用所生成的 Ceph 名称的 ID 组成部分。如果出于某种原因需要重新生成机密，则在再次执行 <command>sudo virsh secret-set-value</command> 之前，需要执行 <command>sudo virsh secret-undefine</command> <replaceable>uuid</replaceable>。
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-summary">
  <title>总结</title>

  <para>
   配置要与 Ceph 搭配使用的 VM 之后，便可启动该 VM。要校验 VM 与 Ceph 是否可相互通讯，可执行以下过程。
  </para>

  <procedure>
   <step>
    <para>
     检查 Ceph 是否在运行：
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph health</screen>
   </step>
   <step>
    <para>
     检查 VM 是否在运行：
    </para>
<screen><prompt>root # </prompt>virsh list</screen>
   </step>
   <step>
    <para>
     检查 VM 是否在与 Ceph 通讯。将 <replaceable>vm-domain-name</replaceable> 替换为 VM 域的名称：
    </para>
<screen><prompt>root # </prompt>virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     检查 <filename>/dev</filename> 或 <filename>/proc/partitions</filename> 下是否存在 <literal>&amp;target dev='hdb' bus='ide'/&gt;</literal> 中的设备：
    </para>
<screen><prompt>tux &gt; </prompt>ls /dev
<prompt>tux &gt; </prompt>cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
