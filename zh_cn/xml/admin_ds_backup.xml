<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>备份集群配置和数据</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>编辑</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  本章说明您应当备份 Ceph 集群的哪些部分才能恢复集群功能。
 </para>
 <sect1 xml:id="backup-ceph">
  <title>备份 Ceph 配置</title>

  <para>
   备份 <filename>/etc/ceph</filename> 目录。该目录包含至关重要的集群配置。比如，当您需要更换管理节点时，就需要备份 <filename>/etc/ceph</filename>。
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-salt">
  <title>备份 Salt 配置</title>

  <para>
   您需要备份 <filename>/etc/salt/</filename> 目录。该目录包含 Salt 配置文件，例如 Salt Master 密钥和已接受的客户端密钥。
  </para>

  <para>
   从严格意义上来说，备份管理节点并不需要备份 Salt 文件，但这些文件能够简化 Salt 集群的重新部署。如果不备份这些文件，就需要在新管理节点上重新注册 Salt Minion。
  </para>

  <note>
   <title>Salt Master 私用密钥的安全性</title>
   <para>
    务必将 Salt Master 私用密钥的备份存储在安全位置。Salt Master 密钥可用于操纵所有集群节点。
   </para>
  </note>

  <para>
   从备份恢复 <filename>/etc/salt</filename> 目录后，请重启动 Salt 服务：
  </para>

<screen><prompt>root@master # </prompt><command>systemctl</command> restart salt-master
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion</screen>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-deepsea">
  <title>备份 DeepSea 配置</title>

  <para>
   DeepSea 所需的所有文件都存储在 <filename>/srv/pillar/</filename>、<filename>/srv/salt/</filename> 和 <filename>/etc/salt/master.d</filename> 中。
  </para>

  <para>
   如果您需要重新部署管理节点，请在新节点上安装 DeepSea 包，并将备份的数据移回这些目录。然后，无需做出更多更改，即可再次使用 DeepSea。在再次使用 DeepSea 之前，请确保已在管理节点上正确注册所有 Salt Minion。
  </para>
 </sect1>
 <sect1 xml:id="backup-config-files">
  <title>备份自定义配置</title>

  <itemizedlist>
   <listitem>
    <para>
     Prometheus 数据和自定义。
    </para>
   </listitem>
   <listitem>
    <para>
     Grafana 自定义。
    </para>
   </listitem>
   <listitem>
    <para>
     确认您拥有现有 openATTIC 用户的记录，这样您才能在 Ceph Dashboard 中为这些用户创建新帐户。
    </para>
   </listitem>
   <listitem>
    <para>
     在 DeepSea 之外手动对 <filename>ceph.conf</filename> 进行的更改。
    </para>
   </listitem>
   <listitem>
    <para>
     在 DeepSea 之外手动对 iSCSI 配置进行的更改。
    </para>
   </listitem>
   <listitem>
    <para>
     Ceph 密钥。
    </para>
   </listitem>
   <listitem>
    <para>
     CRUSH 索引和 CRUSH 规则。通过运行以下命令将包含 CRUSH 规则的反编译 CRUSH 索引保存到 <filename>crushmap-backup.txt</filename> 中：
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
   </listitem>
   <listitem>
    <para>
     Samba 网关配置。如果您使用的是单个网关，请备份 <filename>/etc/samba/smb.conf</filename>。如果您使用的是 HA 设置，另请备份 CTDB 和 Pacemaker 配置文件。有关 Samba 网关所使用配置的详细信息，请参见<xref linkend="cha-ses-cifs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     NFS Ganesha 配置。仅当使用 HA 设置时需要备份。有关 NFS Ganesha 所使用配置的详细信息，请参见<xref linkend="cha-ceph-nfsganesha"/>。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
