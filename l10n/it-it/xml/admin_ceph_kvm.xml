<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_kvm.xml" version="5.0" xml:id="cha-ceph-kvm">
 <title>Ceph come back-end per l'istanza QEMU KVM</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sì</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Il caso di utilizzo Ceph più frequente riguarda l'inserimento di immagini di dispositivi di blocco nelle macchine virtuali. Ad esempio, un utente può creare un'immagine "golden" con un sistema operativo e qualsiasi software pertinente in una configurazione ideale. L'utente, quindi, effettua uno snapshot dell'immagine. Infine, l'utente clona lo snapshot (di solito molte volte, vedere <xref linkend="cha-ceph-snapshots-rbd"/> per ulteriori informazioni). La capacità di creare cloni copia su scrittura di uno snapshot significa che Ceph è in grado di fornire rapidamente immagini di dispositivi di blocco alle macchine virtuali, perché il client non deve effettuare il download di un'immagine intera ogni volta che esegue lo spin-up di una nuova macchina virtuale.
 </para>
 <para>
  I dispositivi di blocco Ceph possono essere integrati con le macchine virtuali QEMU. Per ulteriori informazioni su QEMU KVM, vedere <link xlink:href="https://documentation.suse.com/sles/15-SP1/single-html/SLES-virtualization/#part-virt-qemu"/> (in lingua inglese).
 </para>
 <sect1 xml:id="ceph-kvm-install">
  <title>Installazione di <systemitem>qemu-block-rbd</systemitem></title>

  <para>
   Per utilizzare i dispositivi di blocco Ceph, è necessario che in QEMU sia installato il driver appropriato. Verificare che il pacchetto <systemitem>qemu-block-rbd</systemitem> sia installato e installarlo se necessario:
  </para>

<screen><prompt role="root">root # </prompt>zypper install qemu-block-rbd</screen>
 </sect1>
 <sect1 xml:id="ceph-kvm-usage">
  <title>Uso di QEMU</title>

  <para>
   Nella riga di comando QEMU ci si aspetta che venga specificato il nome pool e il nome immagine. È anche possibile specificare il nome di uno snapshot.
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable><replaceable>:option1=value1</replaceable><replaceable>:option2=value2...</replaceable></screen>

  <para>
   Ad esempio, se si specificano le opzioni <replaceable>id</replaceable> e <replaceable>conf</replaceable> si potrebbe ottenere:
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable>:<option>id=glance:conf=/etc/ceph/ceph.conf</option></screen>
 </sect1>
 <sect1 xml:id="creating-images-qemu">
  <title>Creazione di immagini con QEMU</title>

  <para>
   È possibile creare un'immagine del dispositivo di blocco da QEMU. Specificare <literal>rbd</literal>, il nome pool e il nome dell'immagine che si desidera creare. Si devono specificare anche le dimensioni dell'immagine.
  </para>

<screen>qemu-img create -f raw rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Esempio:
  </para>

<screen>qemu-img create -f raw rbd:pool1/image1 10G
Formatting 'rbd:pool1/image1', fmt=raw size=10737418240 nocow=off cluster_size=0</screen>

  <important>
   <para>
    Il formato dati <literal>raw</literal> è effettivamente la sola opzione di formato sensibile da utilizzare con RBD. Tecnicamente si potrebbero utilizzare altri formati supportati da QEMU, come <literal>qcow2</literal>, ma in tal modo si aggiungerebbe ulteriore overhead e il volume non sarebbe sicuro per la migrazione in tempo reale della macchina virtuale quando la memorizzazione nella cache è abilitata.
   </para>
  </important>
 </sect1>
 <sect1 xml:id="resizing-images-qemu">
  <title>Ridimensionamento delle immagini con QEMU</title>

  <para>
   È possibile ridimensionare un'immagine del dispositivo di blocco da QEMU. Specificare <literal>rbd</literal>, il nome pool e il nome dell'immagine che si desidera ridimensionare. Si devono specificare anche le dimensioni dell'immagine.
  </para>

<screen>qemu-img resize rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Esempio:
  </para>

<screen>qemu-img resize rbd:pool1/image1 9G
Image resized.</screen>
 </sect1>
 <sect1 xml:id="retrieving-image-info-qemu">
  <title>Recupero delle informazioni sull'immagine con QEMU</title>

  <para>
   È possibile recuperare informazioni sull'immagine del dispositivo di blocco da QEMU. Specificare <literal>rbd</literal>, il nome pool e il nome dell'immagine.
  </para>

<screen>qemu-img info rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>

  <para>
   Esempio:
  </para>

<screen>qemu-img info rbd:pool1/image1
image: rbd:pool1/image1
file format: raw
virtual size: 9.0G (9663676416 bytes)
disk size: unavailable
cluster_size: 4194304</screen>
 </sect1>
 <sect1 xml:id="running-qemu-rbd">
  <title>Esecuzione di QEMU con RBD</title>

  <para>
   Con QEMU è possibile accedere a un'immagine come un dispositivo di blocco virtuale direttamente tramite <systemitem>librbd</systemitem>. In tal modo si evita un ulteriore passaggio contestuale ed è possibile sfruttare la memorizzazione nella cache RBD.
  </para>

  <para>
   È possibile utilizzare <command>qemu-img</command> per convertire le immagini della macchina virtuale esistenti in immagini del dispositivo di blocco Ceph. Ad esempio, se si dispone di un'immagine qcow2, si potrebbe eseguire:
  </para>

<screen>qemu-img convert -f qcow2 -O raw sles12.qcow2 rbd:pool1/sles12</screen>

  <para>
   Per eseguire un avvio della macchina virtuale da tale immagine, si potrebbe eseguire:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12</screen>

  <para>
   La memorizzazione nella cache RBD può migliorare le prestazioni in modo significativo. Le opzioni di cache QEMU controllano la memorizzazione nella cache <systemitem>librbd</systemitem> caching:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=rbd,file=rbd:pool1/sles12,cache=writeback</screen>

  <para>
   Per ulteriori informazioni sulla memorizzazione nella cache RBD, fare riferimento alla <xref linkend="rbd-cache-settings"/>.
  </para>
 </sect1>
 <sect1 xml:id="enabling-dicard-trim">
  <title>Abilitazione dell'operazione di scarto e TRIM</title>

  <para>
   I dispositivi di blocco Ceph supportano l'operazione di scarto. Vale a dire che un guest può inviare richieste TRIM per consentire a un dispositivo di blocco Ceph di recuperare spazio inutilizzato. Tale operazione può essere abilitata nel guest tramite il montaggio di <systemitem>XFS</systemitem> con l'opzione di scarto.
  </para>

  <para>
   Affinché questa sia disponibile nel guest, è necessario abilitarla esplicitamente per il dispositivo di blocco. A tal fine, specificare una <option>discard_granularity</option> associata all'unità:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12,id=drive1,if=none \
-device driver=ide-hd,drive=drive1,discard_granularity=512</screen>

  <note>
   <para>
    Nell'esempio di cui sopra è utilizzato il driver IDE. Il driver virtio non supporta l'opzione di scarto.
   </para>
  </note>

  <para>
   Se si utilizza <systemitem>libvirt</systemitem>, modificare il file di configurazione del dominio libvirt utilizzando <command>virsh edit</command> per includere il valore <literal>xmlns:qemu</literal>. Aggiungere quindi un <literal>qemu:commandline block</literal> come secondario per tale dominio. Nell'esempio seguente è illustrato come impostare due dispositivi con <literal>qemu id=</literal> su valori <literal>discard_granularity</literal> diversi.
  </para>

<screen>
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
 &lt;qemu:commandline&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-0.discard_granularity=4096'/&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-1.discard_granularity=65536'/&gt;
 &lt;/qemu:commandline&gt;
&lt;/domain&gt;</screen>
 </sect1>
 <sect1 xml:id="qemu-cache-options">
  <title>Impostazione delle opzioni cache QEMU</title>

  <para>
   Le opzioni cache QEMU corrispondono alle seguenti impostazioni cache RBD Ceph.
  </para>

  <para>
   Writeback:
  </para>

<screen>rbd_cache = true</screen>

  <para>
   Write-through:
  </para>

<screen>rbd_cache = true
rbd_cache_max_dirty = 0</screen>

  <para>
   Nessuno:
  </para>

<screen>rbd_cache = false</screen>

  <para>
   Le impostazioni cache QEMU sostituiscono le impostazioni di default Ceph (impostazioni non impostate esplicitamente nel file di configurazione Ceph). Se si impostano esplicitamente le impostazioni cache RBD nel file di configurazione Ceph, (fare riferimento alla <xref linkend="rbd-cache-settings"/>), le impostazioni Ceph sostituiscono le impostazioni della cache QEMU. Se si configurano le impostazioni cache nella riga di comando QEMU, le rispettive impostazioni sostituiscono quelle del file di configurazione Ceph.
  </para>
 </sect1>
</chapter>
