<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_libvirt.xml" version="5.0" xml:id="cha-ceph-libvirt">
 <title><systemitem class="library">libvirt</systemitem> e Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sì</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  La libreria <systemitem class="library">libvirt</systemitem> consente di creare uno strato di astrazione della macchina virtuale tra le interfacce dell'Hypervisor e le applicazioni software che le utilizzano. Con <systemitem class="library">libvirt</systemitem>, sviluppatori e amministratori di sistema possono focalizzarsi su un framework di gestione, un'API e un'interfaccia shell (<command>virsh</command>) comuni a Hypervisor diversi, tra cui QEMU/KVM, Xen, LXC o VirtualBox.
 </para>
 <para>
  I dispositivi di blocco Ceph supportano QEMU/KVM. È possibile utilizzare i dispositivi di blocco Ceph con software che si interfaccia con <systemitem class="library">libvirt</systemitem>. Nella soluzione cloud si utilizza <systemitem class="library">libvirt</systemitem> per l'iterazione con QEMU/KVM e quest'ultimo esegue l'iterazione con i dispositivi di blocco Ceph tramite <systemitem>librbd</systemitem>.
 </para>
 <para>
  Per creare macchine virtuali in cui vengono utilizzati dispositivi di blocco Ceph, seguire le procedure riportate nelle sezioni seguenti. Negli esempi, sono stati utilizzati <literal>libvirt-pool</literal> per il nome pool, <literal>client.libvirt</literal> per il nome utente e <literal>new-libvirt-image</literal> per il nome immagine. È possibile utilizzare qualsiasi valore desiderato, ma assicurarsi di sostituire tali valori quando si eseguono i comandi nelle procedure successive.
 </para>
 <sect1 xml:id="ceph-libvirt-cfg-ceph">
  <title>Configurazione di Ceph con <systemitem class="library">libvirt</systemitem></title>

  <para>
   Per configurare Ceph per l'uso con <systemitem class="library">libvirt</systemitem>, eseguire i seguenti passaggi:
  </para>

  <procedure>
   <step>
    <para>
     Creare un pool. Nell'esempio seguente viene utilizzato il nome pool <literal>libvirt-pool</literal> con 128 gruppi di posizionamento.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     Verificare l'esistenza del pool.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     Creare un utente Ceph. Nell'esempio seguente viene utilizzato il nome utente Ceph <literal>client.libvirt</literal> e si fa riferimento a <literal>libvirt-pool</literal>.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-or-create client.libvirt mon 'profile rbd' osd \
 'profile rbd pool=libvirt-pool'</screen>
    <para>
     Verificare l'esistenza del nome.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth list</screen>
    <note>
     <title>nome utente o ID</title>
     <para>
      <systemitem class="library">libvirt</systemitem> accederà a Ceph tramite l'ID <literal>libvirt</literal>, non il nome Ceph <literal>client.libvirt</literal>. Per una spiegazione dettagliata della differenza tra ID e nome, vedere <xref linkend="cephx-user"/> (in lingua inglese).
     </para>
    </note>
   </step>
   <step>
    <para>
     Utilizzare QEMU per creare un'immagine nel pool RBD. Nell'esempio seguente viene utilizzato il nome immagine <literal>new-libvirt-image</literal> e si fa riferimento a <literal>libvirt-pool</literal>.
    </para>
    <tip>
     <title>ubicazione del file portachiavi</title>
     <para>
      La chiave utente <systemitem class="library">libvirt</systemitem> è memorizzata in un file portachiavi ubicato nella directory <filename>/etc/ceph</filename>. Occorre assegnare al file portachiavi un nome appropriato in cui sia incluso il nome del cluster Ceph a cui appartiene. Per il nome del cluster di default "ceph", il nome del file portachiavi è <filename>/etc/ceph/ceph.client.libvirt.keyring</filename>.
     </para>
     <para>
      Se il portachiavi non esiste, crearlo con:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get client.libvirt &gt; /etc/ceph/ceph.client.libvirt.keyring</screen>
    </tip>
<screen><prompt role="root">root # </prompt>qemu-img create -f raw rbd:libvirt-pool/new-libvirt-image:id=libvirt 2G</screen>
    <para>
     Verificare l'esistenza dell'immagine.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-virt-manager">
  <title>Preparazione del programma di gestione VM</title>

  <para>
   È possibile utilizzare <systemitem class="library">libvirt</systemitem> senza un programma di gestione VM, ma è più semplice creare prima il dominio con <command>virt-manager</command>.
  </para>

  <procedure>
   <step>
    <para>
     Installare un programma di gestione delle macchine virtuali.
    </para>
<screen><prompt role="root">root # </prompt>zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     Preparare/effettuare il download di un'immagine del sistema operativo che si desidera eseguire come virtualizzato.
    </para>
   </step>
   <step>
    <para>
     Avviare il programma di gestione delle macchine virtuali.
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-create-vm">
  <title>Creazione di una macchina virtuale (VM)</title>

  <para>
   Per creare una VM con <command>virt-manager</command>, eseguire i passaggi seguenti:
  </para>

  <procedure>
   <step>
    <para>
     Scegliere la connessione dall'elenco, fare clic con il pulsante destro del mouse su di essa e selezionare <guimenu>New (Nuovo)</guimenu>.
    </para>
   </step>
   <step>
    <para>
     <guimenu>Importare l'immagine disco esistente</guimenu> specificando il percorso di memorizzazione esistente. Specificare il tipo di sistema operativo, le impostazioni della memoria e il <guimenu>nome</guimenu> della macchina virtuale, ad esempio <literal>libvirt-virtual-machine</literal>.
    </para>
   </step>
   <step>
    <para>
     Completare la configurazione e avviare la VM.
    </para>
   </step>
   <step>
    <para>
     Verificare l'esistenza del dominio appena creato con <command>sudo virsh list</command>. Se necessario, specificare la stringa di connessione, come
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     Eseguire il login alla VM e interromperla prima di configurarla per l'uso con Ceph.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-cfg-vm">
  <title>Configurazione della macchina virtuale (VM)</title>

  <para>
   Questo capitolo è incentrato sulla configurazione delle VM per l'integrazione con Ceph mediante l'uso di <command>virsh</command>. Spesso per i comandi <command>virsh</command> sono richiesti i privilegi radice (<command>sudo</command>) e non verranno restituiti i risultati appropriati né notifiche in merito ai privilegi radice richiesti. Per informazioni sui comandi <command>virsh</command>, fare riferimento a <command>man 1 virsh</command> (deve essere installato <package>il pacchetto</package> libvirt-client).
  </para>

  <procedure>
   <step>
    <para>
     Aprire il file di configurazione con <command>virsh edit</command>
     <replaceable>vm-domain-name</replaceable>.
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     In &lt;devices&gt; deve essere presente una voce &lt;disk&gt;.
    </para>
<screen>&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-<replaceable>SYSTEM-ARCH</replaceable>&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/image/recent-linux.img'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='drive' controller='0' bus='0' unit='0'/&gt;
    &lt;/disk&gt;</screen>
    <para>
     Sostituire <filename>/path/to/image/recent-linux.img</filename> con il percorso dell'immagine del sistema operativo.
    </para>
    <important>
     <para>
      Utilizzare <command>sudo virsh edit</command> al posto di un editor di testo. Se si modifica il file di configurazione in <filename>/etc/libvirt/qemu</filename> con un editor di testo, è possibile che <systemitem class="library">libvirt</systemitem> non riconosca la modifica. Se è presente una discrepanza tra i contenuti del file XML in <filename>/etc/libvirt/qemu</filename> e il risultato di <command>sudo virsh dumpxml</command> <replaceable>vm-domain-name</replaceable>, la VM potrebbe non funzionare correttamente.
     </para>
    </important>
   </step>
   <step>
    <para>
     Aggiungere l'immagine Ceph RBD creata precedentemente come voce &lt;disk&gt;.
    </para>
<screen>&lt;disk type='network' device='disk'&gt;
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'&gt;
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/&gt;
        &lt;/source&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;</screen>
    <para>
     Sostituire <replaceable>monitor-host</replaceable> con il nome host e sostituire il pool e/o il nome immagine secondo necessità. È possibile aggiungere più voci &lt;host&gt; per i Ceph Monitor. L'attributo <literal>dev</literal> è il nome dispositivo logico che verrà visualizzato nella directory <filename>/dev</filename> della VM. L'attributo bus facoltativo indica il tipo di dispositivo disco da emulare. Le impostazioni valide sono specifiche per il driver (ad esempio ide, scsi, virtio, xen, usb o sata).
    </para>
   </step>
   <step>
    <para>
     salvataggio del file.
    </para>
   </step>
   <step>
    <para>
     Se nel cluster Ceph è abilitata l'autenticazione (impostazione di default), è necessario generare un segreto. Aprire l'editor desiderato e creare un file denominato <filename>secret.xml</filename> con il contenuto seguente:
    </para>
<screen>&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;</screen>
   </step>
   <step>
    <para>
     Definire il segreto.
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-define --file secret.xml
&lt;uuid of secret is output here&gt;</screen>
   </step>
   <step>
    <para>
     Ottenere la chiave <literal>client.libvirt</literal> e salvare la stringa chiave in un file.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     Impostare l'UUID del segreto.
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     È inoltre necessario impostare manualmente il segreto aggiungendo la seguente voce <literal>&lt;auth&gt;</literal> all'elemento <literal>&lt;disk&gt;</literal> immesso precedentemente (sostituendo il valore uuid con il risultato dell'esempio della riga di comando di cui sopra).
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
    <para>
     Quindi, aggiungere l'elemento <literal>&lt;auth&gt;&lt;/auth&gt;</literal> al file di configurazione del dominio:
    </para>
<screen>...
&lt;/source&gt;
&lt;auth username='libvirt'&gt;
        &lt;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/&gt;
&lt;/auth&gt;
&lt;target ...</screen>
    <note>
     <para>
      L'ID di esempio è <literal>libvirt</literal>, non il nome Ceph <literal>client.libvirt</literal> generato al passaggio 2 della <xref linkend="ceph-libvirt-cfg-ceph"/>. Assicurarsi di utilizzare il componente ID del nome Ceph generato. Se per qualche motivo è necessario generare di nuovo il segreto, si dovrà eseguire <command>sudo virsh secret-undefine</command> <replaceable>uuid</replaceable> prima di eseguire di nuovo <command>sudo virsh secret-set-value</command>.
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-summary">
  <title>Riepilogo</title>

  <para>
   Una volta configurata la VM per l'uso con Ceph, è possibile avviarla. Per verificare che la VM e Ceph comunichino tra loro, è possibile eseguire la procedura seguente.
  </para>

  <procedure>
   <step>
    <para>
     Verificare che Ceph sia in esecuzione:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph health</screen>
   </step>
   <step>
    <para>
     Verificare che la VM sia in esecuzione:
    </para>
<screen><prompt role="root">root # </prompt>virsh list</screen>
   </step>
   <step>
    <para>
     Verificare che la VM stia comunicando con Ceph. Sostituire <replaceable>vm-domain-name</replaceable> con il nome di dominio della VM:
    </para>
<screen><prompt role="root">root # </prompt>virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     Verificare che il dispositivo di <literal>&amp;target dev='hdb' bus='ide'/&gt;</literal> venga visualizzato in <filename>/dev</filename> o in <filename>/proc/partitions</filename>:
    </para>
<screen><prompt>tux &gt; </prompt>ls /dev
<prompt>tux &gt; </prompt>cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
