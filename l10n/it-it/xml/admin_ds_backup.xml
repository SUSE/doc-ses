<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Backup e ripristino</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sì</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Questo capitolo illustra quali parti del cluster Ceph sottoporre a backup per il ripristino della funzionalità.
 </para>
 <sect1 xml:id="backrest-ceph">
  <title>Backup della configurazione e dei dati del cluster</title>

  <sect2 xml:id="backrest-ceph-cephsalt">
   <title>Backup della configurazione <systemitem class="resource">ceph-salt</systemitem></title>
   <para>
    Esportare la configurazione del cluster. Per ulteriori informazioni, vedere <xref linkend="deploy-cephadm-configure-export"/>.
   </para>
  </sect2>

  <sect2 xml:id="backup-ceph">
   <title>Backup della configurazione Ceph</title>
   <para>
    Eseguire il backup della directory <filename>/etc/ceph</filename> contenente la configurazione fondamentale del cluster. Ad esempio, il backup di <filename>/etc/ceph</filename> sarà necessario quando occorre sostituire il nodo admin.
   </para>
  </sect2>

  <sect2 xml:id="sec-deployment-backup-salt">
   <title>Backup della configurazione Salt</title>
   <para>
    È necessario eseguire il backup della directory <filename>/etc/salt</filename> contenente i file di configurazione Salt, ad esempio la chiave del Salt Master e le chiavi del client accettate.
   </para>
   <para>
    I file Salt non sono obbligatori per il backup del nodo admin, ma semplificano la ridistribuzione del cluster Salt. Se il backup di tali file non è presente, minion è necessario registrare nuovamente i Salt minion nel nuovo nodo admin.
   </para>
   <note>
    <title>sicurezza della chiave privata del Salt master</title>
    <para>
     Verificare che il backup della chiave privata del Salt Master sia memorizzato in un'ubicazione sicura. La chiave del Salt Master può essere utilizzata per modificare tutti i nodi del cluster.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="backup-config-files">
   <title>Backup delle configurazioni personalizzate</title>
   <itemizedlist>
    <listitem>
     <para>
      Dati e personalizzazione di Prometheus.
     </para>
    </listitem>
    <listitem>
     <para>
      Personalizzazione di Grafana.
     </para>
    </listitem>
    <listitem>
     <para>
      Modifiche manuali alla configurazione iSCSI.
     </para>
    </listitem>
    <listitem>
     <para>
      Chiavi Ceph.
     </para>
    </listitem>
    <listitem>
     <para>
      Mappa CRUSH e regole CRUSH. Salvare la mappa CRUSH non compilata, incluse le regole CRUSH, in <filename>crushmap-backup.txt</filename> eseguendo il comando seguente:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
    </listitem>
    <listitem>
     <para>
      Configurazione del gateway Samba. Se si utilizza un gateway singolo, eseguire il backup di <filename>/etc/samba/smb.conf</filename>. Se si utilizza una configurazione ad elevata disponibilità, eseguire il backup anche dei file di configurazione CTDB e Pacemaker. Fare riferimento al <xref linkend="cha-ses-cifs"/> per i dettagli sulla configurazione utilizzata dai gateway Samba.
     </para>
    </listitem>
    <listitem>
     <para>
      Configurazione di NFS Ganesha. Necessaria soltanto se si utilizza una configurazione ad elevata disponibilità. Fare riferimento al <xref linkend="cha-ceph-nfsganesha"/> per i dettagli sulla configurazione utilizzata da NFS Ganesha.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="restore-ceph">
  <title>Ripristino di un nodo Ceph</title>

  <para>
   Per recuperare un nodo dal backup reinstallare il nodo, sostituire i relativi file di configurazione e riorganizzare il cluster per fare in modo che venga nuovamente aggiunto il nodo di sostituzione.
  </para>

  <para>
   Se è necessario ridistribuire il nodo admin, fare riferimento alla <xref linkend="moving-saltmaster"/>.
  </para>

  <para>
   Per i minion, è in genere più semplice eseguire una nuova ricompilazione e la ridistribuzione.
  </para>

  <orderedlist>
   <listitem>
    <para>
     Reinstallare il nodo. Per ulteriori informazioni, vedere <xref linkend="deploy-os"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Installare Salt. Per ulteriori informazioni, vedere <xref linkend="deploy-salt"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     In seguito al ripristino della directory <filename>/etc/salt</filename> dal backup, abilitare e riavviare i servizi Salt applicabili, ad esempio:
    </para>
<screen>
<prompt>root@master # </prompt><command>systemctl</command> enable salt-master
<prompt>root@master # </prompt><command>systemctl</command> start salt-master
<prompt>root@master # </prompt><command>systemctl</command> enable salt-minion
<prompt>root@master # </prompt><command>systemctl</command> start salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Rimuovere la chiave master pubblica relativa al nodo Salt Master precedente da tutti i minion.
    </para>
<screen>
<prompt>root@master # </prompt><command>rm</command> /etc/salt/pki/minion/minion_master.pub
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Ripristinare gli elementi locali nel nodo admin.
    </para>
   </listitem>
   <listitem>
    <para>
     Importare la configurazione del cluster dal file JSON esportato in precedenza. Per ulteriori dettagli, fare riferimento al <xref linkend="deploy-cephadm-configure-export"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Applicare la configurazione del cluster importata:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt apply</screen>
   </listitem>
  </orderedlist>
 </sect1>
</chapter>
