<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Funzionamento dei servizi Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sì</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  È possibile utilizzare i servizi Ceph a livello di daemon, nodo o cluster. A seconda dell'approccio richiesto, utilizzare cephadm o il comando <command>systemctl</command>.
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>Attivazione dei servizi singoli</title>

  <para>
   Se è necessario utilizzare un singolo servizio, per prima cosa individuarlo:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   Per identificare un servizio su un nodo specifico, eseguire:
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   Esempio:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    Il comando <command>ceph orch ps</command> supporta diversi formati di output. Per modificare il formato, aggiungere l'opzione <option>--format <replaceable>FORMAT</replaceable></option>, dove <replaceable>FORMAT</replaceable> indica uno tra i formati <literal>json</literal>, <literal>json-pretty</literal> o <literal>yaml</literal>. Esempio:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   Una volta individuato il nome del servizio, è possibile avviarlo, riavviarlo o interromperlo:
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   Ad esempio, per riavviare il servizio OSD con l'ID 0, eseguire:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>Attivazione dei tipi di servizio</title>

  <para>
   Se è necessario utilizzare un tipo di servizio specifico nell'intero cluster Ceph, immettere il comando seguente:
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   Sostituire <replaceable>COMMAND</replaceable> con <literal>start</literal>, <literal>stop</literal> o <literal>restart</literal>.
  </para>

  <para>
   Ad esempio, il comando seguente riavvia tutti i MON nel cluster, a prescindere dai nodi su cui sono effettivamente in esecuzione:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>Attivazione dei servizi su un singolo nodo</title>

  <para>
   Tramite il comando <command>systemctl</command>, è possibile utilizzare le destinazioni e i servizi <systemitem class="daemon">systemd</systemitem> correlati a Ceph su un singolo nodo.
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identificazione di servizi e destinazioni</title>
   <para>
    Prima di utilizzare le destinazioni e i servizi <systemitem class="daemon">systemd</systemitem> correlati a Ceph, individuare i nomi di file dei relativi file di unità. I nomi di file dei servizi seguono il modello seguente:
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    Esempio:
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       ID univoco del cluster Ceph. È possibile trovarlo nell'output del comando <command>ceph fsid</command>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       Tipo di servizio, ad esempio <literal>osd</literal>, <literal>mon</literal> o <literal>rgw</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       Stringa identificativa del servizio. Per gli OSD, si tratta del numero di ID del servizio. Per gli altri servizi, può corrispondere al nome host del nodo o a stringhe aggiuntive rilevanti per il tipo di servizio.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     La porzione <replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable> è identica al contenuto della colonna <literal>NAME</literal> nell'output del comando <command>ceph orch ps</command>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Attivazione di tutti i servizi su un nodo</title>
   <para>
    Tramite le destinazioni <systemitem class="daemon">systemd</systemitem> di Ceph, è possibile utilizzare contemporaneamente <emphasis>tutti</emphasis> i servizi su un nodo oppure tutti i servizi <emphasis>appartenenti a un cluster</emphasis> identificato dal relativo <replaceable>FSID</replaceable>.
   </para>
   <para>
    Ad esempio, per interrompere tutti i servizi Ceph su un nodo a prescindere dal cluster a cui appartengono, eseguire:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    Per riavviare tutti i servizi appartenenti a un cluster Ceph con ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, eseguire:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>Attivazione di un singolo servizio su un nodo</title>
   <para>
    Dopo aver identificato il nome di un servizio specifico, attivarlo come segue:
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    Ad esempio, per riavviare un singolo servizio OSD con ID 1 su un cluster con ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, eseguire:
   </para>
<screen><prompt role="root">root # </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Interrogazione dello stato del servizio</title>
   <para>
    È possibile interrogare <systemitem class="daemon">systemd</systemitem> per lo stato dei servizi. Esempio:
   </para>
<screen><prompt role="root">root # </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Spegnimento e riavvio dell'intero cluster Ceph</title>

  <para>
   Se è in programma un'interruzione di corrente, potrebbe essere necessario spegnere e riavviare il cluster. Per interrompere e riavviare senza problemi tutti i servizi correlati a Ceph, seguire la procedura indicata di seguito:
  </para>

  <procedure>
   <title>Spegnimento dell'intero cluster Ceph</title>
   <step>
    <para>
     Spegnere o disconnettere i client con accesso al cluster.
    </para>
   </step>
   <step>
    <para>
     Per impedire il ribilanciamento automatico del cluster da parte di CRUSH, impostare il cluster su <literal>noout</literal>:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     Interrompere tutti i servizi Ceph su tutti i nodi del cluster:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     Disattivare tutti i nodi del cluster:
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>Avvio dell'intero cluster Ceph</title>
   <step>
    <para>
     Attivare il nodo admin.
    </para>
   </step>
   <step>
    <para>
     Attivare i nodi Ceph Monitor.
    </para>
   </step>
   <step>
    <para>
     Attivare i nodi Ceph OSD.
    </para>
   </step>
   <step>
    <para>
     Annullare l'impostazione del flag <literal>noout</literal> configurata in precedenza:
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     Attivare tutti i gateway configurati.
    </para>
   </step>
   <step>
    <para>
     Attivare o connettere i client del cluster.
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
