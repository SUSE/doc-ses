<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_libvirt.xml" version="5.0" xml:id="cha-ceph-libvirt">
 <title><systemitem class="library">libvirt</systemitem> 和 Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  <systemitem class="library">libvirt</systemitem> 程式庫在監管程式介面與使用這些介面的軟體應用程式之間建立了一個虛擬機器抽象層。使用 <systemitem class="library">libvirt</systemitem>，開發人員和系統管理員可將工作重心放在通用管理架構、通用 API、通用外圍程序介面 (<command>virsh</command>)，以及諸多不同的監管程式 (包括 QEMU/KVM、Xen、LXC 或 VirtualBox) 上。
 </para>
 <para>
  Ceph 區塊裝置支援 QEMU/KVM。您可以透過與 <systemitem class="library">libvirt</systemitem> 連接的軟體來使用 Ceph 區塊裝置。雲端解決方案使用 <systemitem class="library">libvirt</systemitem> 來與 QEMU/KVM 互動，而 QEMU/KVM 透過 <systemitem>librbd</systemitem> 來與 Ceph 區塊裝置互動。
 </para>
 <para>
  若要建立使用 Ceph 區塊裝置的虛擬機器，請依以下各節所述的程序操作。在範例中，我們分別使用了 <literal>libvirt-pool</literal>、<literal>client.libvirt</literal> 和 <literal>new-libvirt-image</literal> 做為池名稱、使用者名稱和影像名稱。您可以根據個人喜好使用任何值，但在執行後續程序中的指令時，請務必取代這些值。
 </para>
 <sect1 xml:id="ceph-libvirt-cfg-ceph">
  <title>設定 Ceph 與 <systemitem class="library">libvirt</systemitem> 搭配使用</title>

  <para>
   若要將 Ceph 設定為與 <systemitem class="library">libvirt</systemitem> 搭配使用，請執行以下步驟：
  </para>

  <procedure>
   <step>
    <para>
     建立池。下面的範例使用池名稱 <literal>libvirt-pool</literal> 和 128 個放置群組。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     驗證該池是否存在。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     建立 Ceph 使用者。下面的範例使用 Ceph 使用者名稱 <literal>client.libvirt</literal> 並參考 <literal>libvirt-pool</literal>。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-or-create client.libvirt mon 'profile rbd' osd \
 'profile rbd pool=libvirt-pool'</screen>
    <para>
     驗證該名稱是否存在。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth list</screen>
    <note>
     <title>使用者名稱或 ID</title>
     <para>
      <systemitem class="library">libvirt</systemitem> 將使用 ID <literal>libvirt</literal>，而不是 Ceph 名稱 <literal>client.libvirt</literal> 來存取 Ceph。如需 ID 與名稱之間的差別的詳細說明，請參閱<xref linkend="cephx-user"/>。
     </para>
    </note>
   </step>
   <step>
    <para>
     使用 QEMU 在 RBD 池中建立影像。下面的範例使用影像名稱 <literal>new-libvirt-image</literal> 並參考 <literal>libvirt-pool</literal>。
    </para>
    <tip>
     <title>金鑰圈檔案位置</title>
     <para>
      <systemitem class="library">libvirt</systemitem> 使用者金鑰儲存在 <filename>/etc/ceph</filename> 目錄下的金鑰圈檔案中。需要為金鑰圈檔案指定適當的名稱，其中應包含其所屬 Ceph 叢集的名稱。如果叢集名稱為預設名稱「ceph」，則金鑰圈檔案名稱為 <filename>/etc/ceph/ceph.client.libvirt.keyring</filename>。
     </para>
     <para>
      如果該金鑰圈不存在，請使用以下指令建立它：
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get client.libvirt &gt; /etc/ceph/ceph.client.libvirt.keyring</screen>
    </tip>
<screen><prompt role="root">root # </prompt>qemu-img create -f raw rbd:libvirt-pool/new-libvirt-image:id=libvirt 2G</screen>
    <para>
     驗證該影像是否存在。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-virt-manager">
  <title>準備虛擬機器管理員</title>

  <para>
   雖然您可以單獨使用 <systemitem class="library">libvirt</systemitem>，而不藉助虛擬機器管理員，但您可能會發現，使用 <command>virt-manager</command> 來建立第一個網域會更簡單。
  </para>

  <procedure>
   <step>
    <para>
     安裝虛擬機器管理員。
    </para>
<screen><prompt role="root">root # </prompt>zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     準備/下載要執行虛擬化的系統的 OS 影像。
    </para>
   </step>
   <step>
    <para>
     啟動虛擬機器管理員。
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-create-vm">
  <title>建立虛擬機器</title>

  <para>
   若要使用 <command>virt-manager</command> 建立虛擬機器，請執行以下步驟：
  </para>

  <procedure>
   <step>
    <para>
     從清單中選擇連接，在其上按一下滑鼠右鍵，然後選取<guimenu>新增</guimenu>。
    </para>
   </step>
   <step>
    <para>
     透過提供現有儲存的路徑來<guimenu>輸入現有的磁碟影像</guimenu>。指定 OS 類型和記憶體設定，並為虛擬機器<guimenu>命名</guimenu>，例如 <literal>libvirt-virtual-machine</literal>。
    </para>
   </step>
   <step>
    <para>
     完成組態並啟動虛擬機器。
    </para>
   </step>
   <step>
    <para>
     使用 <command>sudo virsh list</command> 驗證新建立的網域是否存在。如果需要，請指定連接字串，例如
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     在將虛擬機器設定為與 Ceph 搭配使用前，登入虛擬機器並將其停止。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-cfg-vm">
  <title>設定虛擬機器</title>

  <para>
   本章重點介紹如何使用 <command>virsh</command> 設定虛擬機器，以與 Ceph 整合。<command>virsh</command> 指令通常需要 root 特權 (<command>sudo</command>)，它不會傳回相應的結果，也不會告知您需要 root 特權。如需 <command>virsh</command> 指令的參考資訊，請參閱 <command>man 1 virsh</command> (需要安裝 <package>libvirt-client</package> )。
  </para>

  <procedure>
   <step>
    <para>
     使用 <command>virsh edit</command>
     <replaceable>vm-domain-name</replaceable> 開啟組態檔案。
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     &lt;devices&gt; 下面應該包含 &lt;disk&gt; 項目。
    </para>
<screen>&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-<replaceable>SYSTEM-ARCH</replaceable>&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/image/recent-linux.img'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='drive' controller='0' bus='0' unit='0'/&gt;
    &lt;/disk&gt;</screen>
    <para>
     以 OS 影像的路徑取代 <filename>/path/to/image/recent-linux.img</filename>。
    </para>
    <important>
     <para>
      請使用 <command>sudo virsh edit</command>，不要使用文字編輯器。如果使用文字編輯器編輯 <filename>/etc/libvirt/qemu</filename> 下的組態檔案，<systemitem class="library">libvirt</systemitem> 可能無法辨識變更。如果 <filename>/etc/libvirt/qemu</filename> 下的 XML 檔案內容與 <command>sudo virsh dumpxml</command> <replaceable>vm-domain-name</replaceable> 傳回的結果有差異，則表示虛擬機器可能沒有正常運作。
     </para>
    </important>
   </step>
   <step>
    <para>
     將先前建立的 Ceph RBD 影像新增為 &lt;disk&gt; 項目。
    </para>
<screen>&lt;disk type='network' device='disk'&gt;
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'&gt;
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/&gt;
        &lt;/source&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;</screen>
    <para>
     以您主機的名稱取代 <replaceable>monitor-host</replaceable>，並視需要取代池名稱和/或影像名稱。您可為 Ceph 監控程式新增多個 &lt;host&gt; 項目。<literal>dev</literal> 屬性是邏輯裝置名稱，將顯示在虛擬機器的 <filename>/dev</filename> 目錄下。選擇性 bus 屬性表示要模擬的磁碟裝置類型。有效的設定都是驅動程式特定的 (例如 ide、scsi、virtio、xen、usb 或 sata)。
    </para>
   </step>
   <step>
    <para>
     儲存檔案。
    </para>
   </step>
   <step>
    <para>
     如果 Ceph 叢集已啟用驗證 (預設會啟用)，您必須產生一個機密。開啟所選的編輯器，並建立包含以下內容的 <filename>secret.xml</filename> 檔案：
    </para>
<screen>&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;</screen>
   </step>
   <step>
    <para>
     定義機密。
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-define --file secret.xml
&lt;uuid of secret is output here&gt;</screen>
   </step>
   <step>
    <para>
     獲取 <literal>client.libvirt</literal> 金鑰，並將金鑰字串儲存到某個檔案中。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     設定機密的 UUID。
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     此外，必須透過將以下 <literal>&lt;auth&gt;</literal> 項目新增至前面輸入的 <literal>&lt;disk&gt;</literal> 元素 (請以上述指令行範例的結果取代 uuid 值)，來手動設定機密。
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
    <para>
     然後，將 <literal>&lt;auth&gt;&lt;/auth&gt;</literal> 元素新增至網域組態檔案：
    </para>
<screen>...
&lt;/source&gt;
&lt;auth username='libvirt'&gt;
        &lt;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/&gt;
&lt;/auth&gt;
&lt;target ...</screen>
    <note>
     <para>
      示範的 ID 為 <literal>libvirt</literal>，而不是在<xref linkend="ceph-libvirt-cfg-ceph"/>的步驟 2 中產生的 Ceph 名稱 <literal>client.libvirt</literal>。請務必使用所產生 Ceph 名稱的 ID 組成部分。如果您出於某個原因需要重新產生機密，則在再次執行 <command>sudo virsh secret-set-value</command> 之前，需要執行 <command>sudo virsh secret-undefine</command> <replaceable>uuid</replaceable>。
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-summary">
  <title>摘要</title>

  <para>
   設定要與 Ceph 搭配使用的虛擬機器之後，便可啟動該虛擬機器。若要驗證虛擬機器與 Ceph 是否可相互通訊，可執行以下程序。
  </para>

  <procedure>
   <step>
    <para>
     檢查 Ceph 是否在執行：
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph health</screen>
   </step>
   <step>
    <para>
     檢查虛擬機器是否在執行：
    </para>
<screen><prompt role="root">root # </prompt>virsh list</screen>
   </step>
   <step>
    <para>
     檢查虛擬機器是否在與 Ceph 通訊。以虛擬機器網域的名稱取代 <replaceable>vm-domain-name</replaceable>：
    </para>
<screen><prompt role="root">root # </prompt>virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     檢查 <filename>/dev</filename> 或 <filename>/proc/partitions</filename> 下是否存在 <literal>&amp;target dev='hdb' bus='ide'/&gt;</literal> 中的裝置：
    </para>
<screen><prompt>tux &gt; </prompt>ls /dev
<prompt>tux &gt; </prompt>cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
