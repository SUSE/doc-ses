<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>備份及還原</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  本章說明您應當備份 Ceph 叢集的哪些部分才能還原叢集功能。
 </para>
 <sect1 xml:id="backrest-ceph">
  <title>備份叢集組態和資料</title>

  <sect2 xml:id="backrest-ceph-cephsalt">
   <title>備份 <systemitem class="resource">ceph-salt</systemitem> 組態</title>
   <para>
    輸出叢集組態。您可以在 <xref linkend="deploy-cephadm-configure-export"/> 找到更多的資訊。
   </para>
  </sect2>

  <sect2 xml:id="backup-ceph">
   <title>備份 Ceph 組態</title>
   <para>
    備份 <filename>/etc/ceph</filename> 目錄。該目錄包含至關重要的叢集組態。例如，當您需要更換管理節點時，就需要備份 <filename>/etc/ceph</filename>。
   </para>
  </sect2>

  <sect2 xml:id="sec-deployment-backup-salt">
   <title>備份 Salt 組態</title>
   <para>
    您需要備份 <filename>/etc/salt/</filename> 目錄。該目錄包含 Salt 組態檔案，例如 Salt Master 金鑰和已接受的用戶端金鑰。
   </para>
   <para>
    從嚴格意義上來說，備份管理節點並不需要備份 Salt 檔案，但這些檔案能夠簡化 Salt 叢集的重新部署。如果不備份這些檔案，就需要在新管理節點上重新註冊 Salt Minion。
   </para>
   <note>
    <title>Salt Master 私密金鑰的安全性</title>
    <para>
     請務必將 Salt Master 私密金鑰的備份儲存在安全位置。Salt Master 金鑰可用於操縱所有叢集節點。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="backup-config-files">
   <title>備份自訂組態</title>
   <itemizedlist>
    <listitem>
     <para>
      Prometheus 資料和自訂。
     </para>
    </listitem>
    <listitem>
     <para>
      Grafana 自訂。
     </para>
    </listitem>
    <listitem>
     <para>
      手動變更 iSCSI 組態。
     </para>
    </listitem>
    <listitem>
     <para>
      Ceph 金鑰。
     </para>
    </listitem>
    <listitem>
     <para>
      CRUSH 地圖和 CRUSH 規則。透過執行以下指令將包含 CRUSH 規則的反編譯 CRUSH 地圖儲存到 <filename>crushmap-backup.txt</filename> 中：
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
    </listitem>
    <listitem>
     <para>
      Samba 閘道組態。如果您使用的是單一閘道，請備份 <filename>/etc/samba/smb.conf</filename>。如果您使用的是 HA 設定，還需要備份 CTDB 和 Pacemaker 組態檔案。如需 Samba 閘道所使用組態的詳細資料，請參閱<xref linkend="cha-ses-cifs"/>。
     </para>
    </listitem>
    <listitem>
     <para>
      NFS Ganesha 組態。僅當使用 HA 設定時需要備份。如需 NFS Ganesha 所使用組態的詳細資料，請參閱<xref linkend="cha-ceph-nfsganesha"/>。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="restore-ceph">
  <title>還原 Ceph 節點</title>

  <para>
   從備份中復原節點的程序就是重新安裝節點，更換其組態檔案，然後重新協調叢集，以便重新新增取代節點。
  </para>

  <para>
   如果您需要重新部署管理節點，請參閱<xref linkend="moving-saltmaster"/>。
  </para>

  <para>
   對於 Minion，通常更易於簡化重建和重新部署。
  </para>

  <orderedlist>
   <listitem>
    <para>
     重新安裝節點。如需詳細資訊，請參閱<xref linkend="deploy-os"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     安裝 Salt。如需詳細資訊，請參閱<xref linkend="deploy-salt"/>
    </para>
   </listitem>
   <listitem>
    <para>
     從備份還原 <filename>/etc/salt</filename> 目錄後，啟用並重新啟動適用的 Salt 服務，例如：
    </para>
<screen>
<prompt>root@master # </prompt><command>systemctl</command> enable salt-master
<prompt>root@master # </prompt><command>systemctl</command> start salt-master
<prompt>root@master # </prompt><command>systemctl</command> enable salt-minion
<prompt>root@master # </prompt><command>systemctl</command> start salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     從所有 Minion 中移除舊 Salt Master 節點的公用 Master 金鑰。
    </para>
<screen>
<prompt>root@master # </prompt><command>rm</command> /etc/salt/pki/minion/minion_master.pub
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     還原管理節點的所有本地內容。
    </para>
   </listitem>
   <listitem>
    <para>
     從先前輸出的 JSON 檔案輸入叢集組態。如需更多詳細資料，請參閱<xref linkend="deploy-cephadm-configure-export"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     套用輸入的叢集組態：
    </para>
<screen><prompt>root@master # </prompt>ceph-salt apply</screen>
   </listitem>
  </orderedlist>
 </sect1>
</chapter>
