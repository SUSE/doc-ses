<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_kvm.xml" version="5.0" xml:id="cha-ceph-kvm">
 <title>Ceph 用作 QEMU KVM 实例的后端</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  最常见的 Ceph 用例涉及到向虚拟机提供块设备映像。例如，在理想的配置中，用户可以创建包含 OS 和所有相关软件的“黄金”映像。然后，用户可以创建该映像的快照。最后，用户可以克隆该快照（通常要克隆多次，有关详细信息，请参见<xref linkend="cha-ceph-snapshots-rbd"/>）。能够创建快照的写入时复制克隆，就意味着 Ceph 能够快速向虚拟机供应块设备映像，因为客户端不需要在每次运转新的虚拟机时都下载整个映像。
 </para>
 <para>
  Ceph 块设备可与 QEMU 虚拟机集成。有关 QEMU KVM 的详细信息，请参见 <link xlink:href="https://documentation.suse.com/sles/15-SP1/single-html/SLES-virtualization/#part-virt-qemu"/>。
 </para>
 <sect1 xml:id="ceph-kvm-install">
  <title>安装 <systemitem>qemu-block-rbd</systemitem></title>

  <para>
   要使用 Ceph 块设备，需在 QEMU 上安装相应的驱动程序。请检查是否已安装 <systemitem>qemu-block-rbd</systemitem> 包，并根据需要予以安装：
  </para>

<screen><prompt role="root">root # </prompt>zypper install qemu-block-rbd</screen>
 </sect1>
 <sect1 xml:id="ceph-kvm-usage">
  <title>使用 QEMU</title>

  <para>
   使用 QEMU 命令行时，您需要指定存储池名称和映像名称。您也可以指定快照名称。
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable><replaceable>:option1=value1</replaceable><replaceable>:option2=value2...</replaceable></screen>

  <para>
   例如，可按如下所示指定 <replaceable>id</replaceable> 和 <replaceable>conf</replaceable> 选项：
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable>:<option>id=glance:conf=/etc/ceph/ceph.conf</option></screen>
 </sect1>
 <sect1 xml:id="creating-images-qemu">
  <title>使用 QEMU 创建映像</title>

  <para>
   可以通过 QEMU 创建块设备映像。必须指定 <literal>rbd</literal>、存储池名称，以及要创建的映像的名称。此外，必须指定映像的大小。
  </para>

<screen>qemu-img create -f raw rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   例如：
  </para>

<screen>qemu-img create -f raw rbd:pool1/image1 10G
Formatting 'rbd:pool1/image1', fmt=raw size=10737418240 nocow=off cluster_size=0</screen>

  <important>
   <para>
    事实上，<literal>raw</literal> 数据格式是可对 RBD 使用的唯一合理格式选项。从技术上讲，您也可以使用 QEMU 支持的其他格式（例如 <literal>qcow2</literal>），但这会增加额外的开销，如果启用了缓存，还会在实时迁移虚拟机时让卷变得不安全。
   </para>
  </important>
 </sect1>
 <sect1 xml:id="resizing-images-qemu">
  <title>使用 QEMU 调整映像大小</title>

  <para>
   可以通过 QEMU 调整块设备映像的大小。必须指定 <literal>rbd</literal>、存储池名称，以及要调整大小的映像的名称。此外，必须指定映像的大小。
  </para>

<screen>qemu-img resize rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   例如：
  </para>

<screen>qemu-img resize rbd:pool1/image1 9G
Image resized.</screen>
 </sect1>
 <sect1 xml:id="retrieving-image-info-qemu">
  <title>使用 QEMU 检索映像信息</title>

  <para>
   可以通过 QEMU 检索块设备映像的信息。必须指定 <literal>rbd</literal>、存储池名称和映像名称。
  </para>

<screen>qemu-img info rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>

  <para>
   例如：
  </para>

<screen>qemu-img info rbd:pool1/image1
image: rbd:pool1/image1
file format: raw
virtual size: 9.0G (9663676416 bytes)
disk size: unavailable
cluster_size: 4194304</screen>
 </sect1>
 <sect1 xml:id="running-qemu-rbd">
  <title>使用 RBD 运行 QEMU</title>

  <para>
   QEMU 可以通过 <systemitem>librbd</systemitem> 直接将映像作为虚拟块设备来访问。这可以避免额外的环境切换，并可利用 RBD 缓存的优势。
  </para>

  <para>
   您可以使用 <command>qemu-img</command> 将现有的虚拟机映像转换成 Ceph 块设备映像。例如，如果您有一个 qcow2 映像，则可以运行：
  </para>

<screen>qemu-img convert -f qcow2 -O raw sles12.qcow2 rbd:pool1/sles12</screen>

  <para>
   要运行从该映像引导的虚拟机，可以运行：
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12</screen>

  <para>
   RBD 缓存可大幅提高性能。QEMU 的缓存选项可控制 <systemitem>librbd</systemitem> 缓存：
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=rbd,file=rbd:pool1/sles12,cache=writeback</screen>

  <para>
   有关 RBD 缓存的详细信息，请参见<xref linkend="rbd-cache-settings"/>。
  </para>
 </sect1>
 <sect1 xml:id="enabling-dicard-trim">
  <title>启用丢弃和 TRIM</title>

  <para>
   Ceph 块设备支持丢弃操作。这意味着，guest 可以发送 TRIM 请求，让 Ceph 块设备回收未使用的空间。可以通过结合 discard 选项装入 <systemitem>XFS</systemitem>，在 guest 中启用此功能。
  </para>

  <para>
   要让 guest 可使用此功能，必须为块设备显式启用此功能。为此，您必须指定与驱动器关联的 <option>discard_granularity</option>：
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12,id=drive1,if=none \
-device driver=ide-hd,drive=drive1,discard_granularity=512</screen>

  <note>
   <para>
    上面的示例使用 IDE 驱动程序。Virtio 驱动程序不支持丢弃功能。
   </para>
  </note>

  <para>
   如果使用 <systemitem>libvirt</systemitem>，请使用 <command>virsh edit</command> 编辑 libvirt 域的配置文件，以包含 <literal>xmlns:qemu</literal> 值。然后，将 <literal>qemu:commandline block</literal> 添加为该域的子级。下面的示例说明如何将包含 <literal>qemu id=</literal> 的两个设备设置为不同的 <literal>discard_granularity</literal> 值。
  </para>

<screen>
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
 &lt;qemu:commandline&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-0.discard_granularity=4096'/&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-1.discard_granularity=65536'/&gt;
 &lt;/qemu:commandline&gt;
&lt;/domain&gt;</screen>
 </sect1>
 <sect1 xml:id="qemu-cache-options">
  <title>设置 QEMU 缓存选项</title>

  <para>
   QEMU 的缓存选项与以下 Ceph RBD 缓存设置对应。
  </para>

  <para>
   写回:
  </para>

<screen>rbd_cache = true</screen>

  <para>
   直写：
  </para>

<screen>rbd_cache = true
rbd_cache_max_dirty = 0</screen>

  <para>
   无:
  </para>

<screen>rbd_cache = false</screen>

  <para>
   QEMU 的缓存设置会覆盖 Ceph 的默认设置（未在 Ceph 配置文件中显式指定的设置）。如果在 Ceph 配置文件中明确指定了 RBD 缓存设置（请参见<xref linkend="rbd-cache-settings"/>），您的 Ceph 设置将会覆盖 QEMU 缓存设置。如果在 QEMU 命令行中指定了缓存设置，则 QEMU 命令行设置会覆盖 Ceph 配置文件设置。
  </para>
 </sect1>
</chapter>
