<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha-ceph-nfsganesha">

 <title>NFS Ganesha</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  NFS Ganesha 是一种 NFS 服务器，它在用户地址空间中运行，而不是作为操作系统内核的一部分运行。借助 NFS Ganesha，您可以插入自己的存储机制（例如 Ceph），并从任何 NFS 客户端访问它。有关安装说明，请参阅<xref linkend="deploy-cephadm-day2-service-nfs"/>。
 </para>
 <note>
  <title>NFS Ganesha 性能</title>
  <para>
   由于客户端与存储区之间的额外网络跃点会导致协议开销增加并产生额外的延迟，因此与使用本机 CephFS 相比，通过 NFS 网关访问 Ceph 可能会大幅降低应用性能。
  </para>
 </note>
 <para>
  每个 NFS Ganesha 服务都含有一个配置层次结构，其中包含：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    引导 <filename>ganesha.conf</filename>
   </para>
  </listitem>
  <listitem>
   <para>
    每个服务的 RADOS 通用配置对象
   </para>
  </listitem>
  <listitem>
   <para>
    每个导出的 RADOS 配置对象
   </para>
  </listitem>
 </itemizedlist>
 <para>
  引导配置是要在容器中启动 <systemitem class="daemon">nfs-ganesha</systemitem> 守护进程的最低配置。每个引导配置都将包含一个 <literal>%url</literal> 指令，该指令中包含来自 RADOS 通用配置对象的任何额外配置。通用配置对象可以为导出 RADOS 配置对象中定义的每个 NFS 导出包含额外的 <literal>%url</literal> 指令。
 </para>
 <figure>
  <title>NFS Ganesha 结构</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
  </mediaobject>
 </figure>
 <sect1 xml:id="ceph-nfsganesha-nfservice">
  <title>创建 NFS 服务</title>

  <para>
   指定 Ceph 服务部署的推荐方法是创建一个 YAML 格式的文件，其中包含所要部署服务的规范。您可以为每种类型的服务创建单独的规范文件，也可以在一个文件中指定多个（或所有）服务类型。
  </para>

  <para>
   根据您的选择，您将需要更新或创建相关的 YAML 格式文件来创建 NFS Ganesha 服务。有关创建该文件的详细信息，请参见<xref linkend="cephadm-service-and-placement-specs"/>。
  </para>

  <para>
   更新或创建该文件之后，请执行以下命令以创建 <literal>nfs-ganesha</literal> 服务：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>FILE_NAME</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-services">
  <title>启动或重启动 NFS Ganesha</title>

  <para>
   要启动 NFS Ganesha 服务，请运行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch start nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   要重启动 NFS Ganesha 服务，请运行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   如果您只想重启动单个 NFS Ganesha 守护进程，请运行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   启动或重启动 NFS Ganesha 时，NFS v4 会有 90 秒的超时宽限期。在宽限期内，会主动拒绝来自客户端的新请求。因此，当 NFS 处于宽限期内，客户端可能会发生请求处理速度变慢的情况。
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-list-objects">
  <title>列出 NFS 恢复存储池中的对象</title>

  <para>
   执行以下命令以列出 NFS 恢复存储池中的对象：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> ls</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-create-export">
  <title>创建 NFS 导出</title>

  <para>
   执行以下命令以创建 NFS 导出。
  </para>

  <note>
   <para>
    应修改 FSAL 块以包含所需的 cephx 用户 ID 和秘密访问密钥。
   </para>
  </note>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> put <replaceable>export-1</replaceable> <replaceable>export-1</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-verify">
  <title>确认 NFS 导出</title>

  <para>
   NFS v4 将在伪文件系统的根目录下构建导出列表。您可以通过装入 NFS Ganesha 服务器节点的 <filename>/</filename> 来确认 NFS 共享是否已导出：
  </para>

<screen><prompt role="root">root # </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable>
<prompt role="root">root # </prompt><command>ls</command> <replaceable>/path/to/local/mountpoint</replaceable> cephfs</screen>

  <note>
   <title>NFS Ganesha 仅限 v4</title>
   <para>
    默认情况下，cephadm 将配置 NFS v4 服务器。NFS v4 不会与 <literal>rpcbind</literal> 或 <literal>mountd</literal> 守护进程进行交互。NFS 客户端工具（例如 <command>showmount</command>）将不会显示任何已配置的导出。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-mount">
  <title>装入 NFS 导出</title>

  <para>
   要在客户端主机上装入导出的 NFS 共享，请运行：
  </para>

<screen><prompt role="root">root # </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-customrole">
  <title>多个 NFS Ganesha 集群</title>

  <para>
   可以定义多个 NFS Ganesha 集群。如此便可：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     分隔 NFS Ganesha 集群，以便访问 CephFS。
    </para>
   </listitem>
  </itemizedlist>


 </sect1>
</chapter>
