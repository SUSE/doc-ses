<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Ceph 服务的操作</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  您可以在守护进程、节点或集群级别操作 Ceph 服务。根据您需要的方法，使用 cephadm 或 <command>systemctl</command> 命令。
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>操作单个服务</title>

  <para>
   如果您需要操作单个服务，请先标识该服务：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   要标识特定节点上的服务，请运行：
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   例如：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    <command>ceph orch ps</command> 命令支持多种输出格式。要更改格式，请追加 <option>--format <replaceable>FORMAT</replaceable></option> 选项，其中 <replaceable>FORMAT</replaceable> 是 <literal>json</literal>、<literal>json-pretty</literal> 或 <literal>yaml</literal> 其中之一。例如：
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   知道服务名称后，您就可以启动、重启动或停止该服务：
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   例如，要重启动 ID 为 0 的 OSD 服务，请运行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>操作服务类型</title>

  <para>
   如果您需要操作整个 Ceph 集群中特定类型的服务，请使用以下命令：
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   将 <replaceable>COMMAND</replaceable> 替换为 <literal>start</literal>、<literal>stop</literal> 或 <literal>restart</literal>。
  </para>

  <para>
   例如，以下命令会重启动集群中的所有 MON，无论它们实际是在哪个节点上运行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>操作单个节点上的服务</title>

  <para>
   通过使用 <command>systemctl</command> 命令，您可以操作单个节点上与 Ceph 有关的 <systemitem class="daemon">systemd</systemitem> 服务和目标。
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>标识服务和目标</title>
   <para>
    在操作与 Ceph 有关的 <systemitem class="daemon">systemd</systemitem> 服务和目标之前，您需要标识其单元文件的文件名。服务的文件名具有以下格式：
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    例如：
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       Ceph 集群的唯一 ID。您可以在 <command>ceph fsid</command> 命令的输出中找到该 ID。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       服务的类型，例如 <literal>osd</literal>、<literal>mon</literal> 或 <literal>rgw</literal>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       服务的标识字符串。对于 OSD，它是服务的 ID 号。对于其他服务，它可以是节点的主机名，也可以是与服务类型相关的其他字符串。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     <replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable> 部分与 <command>ceph orch ps</command> 命令输出中的 <literal>NAME</literal> 列的内容相同。
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>操作一个节点上所有服务</title>
   <para>
    通过使用 Ceph 的 <systemitem class="daemon">systemd</systemitem> 目标，您可以同时操作某个节点上的<emphasis>所有</emphasis>服务，或者同时操作<emphasis>属于</emphasis>由其 <replaceable>FSID</replaceable> 标识的集群的所有服务。
   </para>
   <para>
    例如，要停止某个节点上的所有 Ceph 服务，而不考虑服务所属的集群，请运行：
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    要重启动属于 ID 为 <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal> 的 Ceph 集群的所有服务，请运行：
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>操作一个节点上的单个服务</title>
   <para>
    标识特定服务的名称后，请如下所示操作该服务：
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    例如，要重启动 ID 为 <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal> 的集群上 ID 为 1 的单个 OSD 服务，请运行：
   </para>
<screen><prompt role="root">root # </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>查询服务状态</title>
   <para>
    可以查询 <systemitem class="daemon">systemd</systemitem> 来了解服务的状态。例如：
   </para>
<screen><prompt role="root">root # </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>关闭并重启动整个 Ceph 集群</title>

  <para>
   如果发生计划停电，可能需要关闭并重启动集群。要停止与 Ceph 有关的所有服务然后再重启动而不会出现问题，请按照以下步骤进行操作。
  </para>

  <procedure>
   <title>关闭整个 Ceph 集群</title>
   <step>
    <para>
     关闭或断开访问集群的任何客户端。
    </para>
   </step>
   <step>
    <para>
     要阻止 CRUSH 自动重新平衡集群，请将集群设置为 <literal>noout</literal>：
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     停止所有集群节点上的所有 Ceph 服务：
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     关闭所有集群节点的电源：
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>启动整个 Ceph 集群</title>
   <step>
    <para>
     打开管理节点的电源。
    </para>
   </step>
   <step>
    <para>
     打开 Ceph Monitor 节点的电源。
    </para>
   </step>
   <step>
    <para>
     打开 Ceph OSD 节点的电源。
    </para>
   </step>
   <step>
    <para>
     取消设置之前设置的 <literal>noout</literal> 标志：
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     打开所有已配置网关的电源。
    </para>
   </step>
   <step>
    <para>
     打开集群客户端的电源或连接集群客户端。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
