<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_salt.xml" version="5.0" xml:id="deploy-salt">
 <info>
  <title>Distribución de Salt</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storage utiliza Salt y <systemitem class="resource">ceph-salt</systemitem> para la preparación inicial del clúster. Salt le ayuda a configurar y ejecutar comandos en varios nodos de clúster de forma simultánea desde un host dedicado llamado <emphasis>máster de Salt</emphasis>. Antes de distribuir Salt, tenga en cuenta los siguientes puntos importantes:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Los <emphasis>minions de Salt</emphasis> son los nodos que se controlan mediante un nodo dedicado denominado master de Salt.
   </para>
  </listitem>
  <listitem>
   <para>
    Si el host del master de Salt debe formar parte del clúster de Ceph, debe ejecutar su propio minion de Salt, pero esto no es un requisito.
   </para>
   <tip>
    <title>uso compartido de varias funciones por servidor</title>
    <para>
     Conseguirá el mejor rendimiento del clúster de Ceph si cada función se distribuye en un nodo independiente. Pero las distribuciones reales requieren en ocasiones que se comparta un nodo para varias funciones. Para evitar problemas de rendimiento y en el procedimiento de actualización, no distribuya las funciones de Ceph OSD, el servidor de metadatos ni Ceph Monitor al nodo de administración.
    </para>
   </tip>
  </listitem>
  <listitem>
   <para>
    Los minions de Salt deben resolver correctamente el nombre de host del master de Salt en la red. Por defecto, buscan el nombre de host <systemitem>salt</systemitem>, pero puede especificar cualquier otro nombre de host al que se pueda acceder por la red en el archivo <filename>/etc/salt/minion</filename>.
   </para>
  </listitem>
 </itemizedlist>
 <procedure>
  <step>
   <para>
    Instale <literal>salt-master</literal> en el nodo master de Salt:
   </para>
<screen><prompt>root@master # </prompt>zypper in salt-master</screen>
  </step>
  <step>
   <para>
    Compruebe que el servicio <systemitem>salt-master</systemitem> esté habilitado y se haya iniciado, y si no lo estuviera, habilítelo e inícielo:
   </para>
<screen><prompt>root@master # </prompt>systemctl enable salt-master.service
<prompt>root@master # </prompt>systemctl start salt-master.service</screen>
  </step>
  <step>
   <para>
    Si va a utilizar un cortafuegos, asegúrese de que el nodo master de Salt tiene los puertos 4505 y 4506 abiertos para todos los nodos minion de Salt. Si los puertos están cerrados, puede abrirlos con el comando <command>yast2 firewall</command> permitiendo el servicio <guimenu>salt-master</guimenu> para la zona oportuna. Por ejemplo, <literal>public</literal>.
   </para>
  </step>
  <step>
   <para>
    Instale el paquete <literal>salt-minion</literal> en todos los nodos minion.
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper in salt-minion</screen>
  </step>
  <step>
   <para>
    Edite <filename>/etc/salt/minion</filename> y elimine el comentario de la siguiente línea:
   </para>
<screen>#log_level_logfile: warning</screen>
   <para>
    Cambie el nivel de registro de <literal>warning</literal> a <literal>info</literal>.
   </para>
   <note>
    <title><option>log_level_logfile</option> y <option>log_level</option></title>
    <para>
     Mientras que <option>log_level</option> controla qué mensajes de registro se mostrarán en la pantalla, <option>log_level_logfile</option> controla qué mensajes de registro se escribirán en <filename>/var/log/salt/minion</filename>.
    </para>
   </note>
   <note>
    <para>
     Asegúrese de cambiar el nivel de registro en <emphasis>todos</emphasis> los nodos del clúster (minions).
    </para>
   </note>
  </step>
  <step>
   <para>
    Asegúrese de que todos los demás nodos pueden resolver el <emphasis>nombre de dominio completo</emphasis> de cada nodo en una dirección IP en la red pública del clúster.
   </para>
  </step>
  <step>
   <para>
    Configure todos los minions para que se conecten con el master. Si el host denominado <literal>salt</literal> no puede acceder al master de Salt, edite el archivo <filename>/etc/salt/minion</filename> o cree un archivo nuevo <filename>/etc/salt/minion.d/master.conf</filename> con el siguiente contenido:
   </para>
<screen>master: <replaceable>host_name_of_salt_master</replaceable></screen>
   <para>
    Si ha realizado cambios en los archivos de configuración mencionados anteriormente, reinicie el servicio Salt en todos los minions de Salt:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart salt-minion.service</screen>
  </step>
  <step>
   <para>
    Compruebe que el servicio <systemitem>salt-minion</systemitem> está habilitado e iniciado en todos los nodos. Habilítelo e inícielo si fuera necesario:
   </para>
<screen><prompt role="root"># </prompt>systemctl enable salt-minion.service
<prompt role="root"># </prompt>systemctl start salt-minion.service</screen>
  </step>
  <step>
   <para>
    Verifique la huella digital de cada minion de Salt y acepte todas las claves salt del master de Salt si las huellas coinciden.
   </para>
   <note>
    <para>
     Si la huella digital del minion de Salt vuelve vacía, asegúrese de que el minion de Salt tenga una configuración de master de Salt y que pueda comunicarse con el master de Salt.
    </para>
   </note>
   <para>
    Para ver la huella digital de cada minion:
   </para>
<screen><prompt>root@minion &gt; </prompt>salt-call --local key.finger
local:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Después de recopilar las huellas digitales de todos los minions de Salt, muestre las huellas de todas las claves de minion no aceptadas del master de Salt:
   </para>
<screen><prompt>root@master # </prompt>salt-key -F
[...]
Unaccepted Keys:
minion1:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Si las huellas digitales de los minions coinciden, acéptelas:
   </para>
<screen><prompt>root@master # </prompt>salt-key --accept-all</screen>
  </step>
  <step>
   <para>
    Verifique que las claves se han aceptado:
   </para>
<screen><prompt>root@master # </prompt>salt-key --list-all</screen>
  </step>
  <step>
   <para>
    Compruebe si todos los minions de Salt responden:
   </para>
<screen><prompt>root@master # </prompt>salt-run manage.status</screen>
  </step>
 </procedure>
</chapter>
