<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_gateway.xml" version="5.0" xml:id="cha-ceph-gw">
 
 <title>Ceph Object Gateway</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  En este capítulo se presentan las tareas de administración relacionadas con Object Gateway, como la comprobación del estado del servicio, la gestión de cuentas, las pasarelas de varios sitios o la autenticación LDAP.
 </para>
 <sect1 xml:id="sec-ceph-rgw-limits">
  <title>Restricciones y limitaciones de denominación de Object Gateway</title>

  <para>
   A continuación encontrará una lista de limitaciones importantes de Object Gateway.
  </para>

  <sect2 xml:id="ogw-limits-bucket">
   <title>Limitaciones de los depósitos</title>
   <para>
    Cuando se accede a Object Gateway a través de la API de S3, los nombres de depósito deben ser nombres compatibles con DNS y solo se permite el carácter de guión &quot;-&quot;. Cuando se accede a Object Gateway a través de la API de Swift, puede utilizar cualquier combinación de caracteres UTF-8 compatibles, excepto el carácter de barra &quot;/&quot;. La longitud máxima de los nombres de depósito es de 255 caracteres. Los nombres de depósitos deben ser exclusivos.
   </para>
   <tip>
    <title>uso de nombres de depósitos compatibles con DNS</title>
    <para>
     Aunque puede utilizar cualquier nombre de depósito basado en UTF-8 en la API de Swift, se recomienda respetar la limitación existente para los nombre en S3, a fin de evitar problemas al acceder al mismo depósito a través de la API de S3.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ogw-limits-object">
   <title>Limitaciones de los objetos almacenados</title>
   <variablelist>
    <varlistentry>
     <term>Número máximo de objetos por usuario</term>
     <listitem>
      <para>
       No hay restricciones por defecto (limitado a ~2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Número máximo de objetos por depósito</term>
     <listitem>
      <para>
       No hay restricciones por defecto (limitado a ~2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Tamaño máximo de un objeto para cargar o almacenar</term>
     <listitem>
      <para>
       Las cargas sencillas están restringidas a 5 GB. Divida varias partes para objetos más grandes. El número máximo de porciones de varias partes es 10 000.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ogw-limits-http">
   <title>Limitaciones de los encabezados HTTP</title>
   <para>
    El encabezado HTTP y la limitación de la petición dependen de la interfaz Web que se utilice. La instancia por defecto de Beast restringe el tamaño del encabezado HTTP a 16 kB.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-deploy">
  <title>Distribución de Object Gateway</title>

  <para>
   La distribución de Ceph Object Gateway sigue el mismo procedimiento que la distribución de otros servicios de Ceph, mediante cephadm. Para obtener más información, consulte el <xref linkend="cephadm-service-and-placement-specs"/>, específicamente el <xref linkend="deploy-cephadm-day2-service-ogw"/>.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-operating">
  <title>Funcionamiento del servicio de Object Gateway</title>

  <para>
   Puede utilizar las pasarelas Object Gateway de la misma forma que otros servicios de Ceph: identificando primero el nombre del servicio con el comando <command>ceph orch ps</command> y ejecutando el comando siguiente para los servicios operativos, por ejemplo:
  </para>

<screen>ceph orch daemon restart <replaceable>OGW_SERVICE_NAME</replaceable></screen>

  <para>
   Consulte el <xref linkend="cha-ceph-operating"/> para obtener información completa sobre el funcionamiento de los servicios de Ceph.
  </para>
 </sect1>
 <sect1 xml:id="ogw-config-parameters">
  <title>Opciones de configuración</title>

  <para>
   Consulte en la <xref linkend="config-ogw"/> una lista de opciones de configuración de Object Gateway.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-access">
  <title>Gestión del acceso a Object Gateway</title>

  <para>
   Es posible comunicarse con Object Gateway mediante una interfaz compatible con S3 o con Swift. La interfaz de S3 es compatible con un gran subconjunto de la API RESTful de Amazon S3. La interfaz de Swift es compatible con un gran subconjunto de la API de OpenStack Swift.
  </para>

  <para>
   Ambas interfaces requieren que cree un usuario específico y que instale el software cliente relevante para comunicarse con la pasarela mediante la clave de secreto del usuario.
  </para>

  <sect2 xml:id="accessing-ragos-gateway">
   <title>Acceso a Object Gateway</title>
   <sect3 xml:id="ogw-s3-interface-access">
    <title>Acceso a la interfaz de S3</title>
    <para>
     Para acceder a la interfaz de S3, necesita un cliente de REST. <command>S3cmd</command> es un cliente de S3 de línea de comandos. Lo encontrará en <link xlink:href="https://build.opensuse.org/package/show/Cloud:Tools/s3cmd">OpenSUSE Build Service</link>. El repositorio contiene versiones tanto para SUSE Linux Enterprise como para distribuciones basadas en openSUSE.
    </para>
    <para>
     Si desea probar el acceso a la interfaz de S3, también puede escribir un pequeño guion de Python. El guion se conectará con Object Gateway, creará un depósito nuevo y mostrará todos los depósitos. Los valores de <option>aws_access_key_id</option> y <option>aws_secret_access_key</option> se toman de los valores de <option>access_key</option> y <option>secret_key</option> devueltos por el comando <command>radosgw_admin</command> de la <xref linkend="adding-s3-swift-users"/>.
    </para>
    <procedure>
     <step>
      <para>
       Instale el paquete <systemitem>python-boto</systemitem>:
      </para>
<screen><prompt role="root"># </prompt>zypper in python-boto</screen>
     </step>
     <step>
      <para>
       Cree un nuevo guion de Python denominado <filename>s3test.py</filename> con el siguiente contenido:
       <remark role="fixme">Provide script in RPM? Is it really necessary to create pool? This script is not necessary at all, remove it from documentation?</remark>
      </para>
<screen>import boto
import boto.s3.connection
access_key = '11BS02LGFB6AL6H1ADMW'
secret_key = 'vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY'
conn = boto.connect_s3(
aws_access_key_id = access_key,
aws_secret_access_key = secret_key,
host = '<replaceable>HOSTNAME</replaceable>',
is_secure=False,
calling_format = boto.s3.connection.OrdinaryCallingFormat(),
)
bucket = conn.create_bucket('my-new-bucket')
for bucket in conn.get_all_buckets():
  print "<replaceable>NAME</replaceable>\t<replaceable>CREATED</replaceable>".format(
  name = bucket.name,
  created = bucket.creation_date,
  )</screen>
      <para>
       Sustituya <literal><replaceable>HOSTNAME</replaceable></literal> por el nombre del host donde haya configurado el servicio de Object Gateway; por ejemplo <literal>gateway_host</literal>.
      </para>
     </step>
     <step>
      <para>
       Ejecute el guion:
      </para>
<screen>python s3test.py</screen>
      <para>
       El guion da como resultado algo parecido a lo siguiente:
      </para>
<screen>my-new-bucket 2015-07-22T15:37:42.000Z</screen>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="swift-interface-access">
    <title>Acceso a la interfaz de Swift</title>
    <para>
     Para acceder a Object Gateway a través de una interfaz de Swift, necesita el cliente de línea de comandos <command>swift</command>. La página <command>man 1 swift</command> incluye más información sobre las opciones de la línea de comandos.
    </para>
    <para>
     El paquete se incluye en el módulo &quot;Nube pública&quot; de SUSE Linux Enterprise 12 de la versión SP3 y en SUSE Linux Enterprise 15. Antes de instalar el paquete, debe activar el módulo y actualizar el repositorio de software:
    </para>
<screen><prompt role="root"># </prompt>SUSEConnect -p sle-module-public-cloud/12/<replaceable>SYSTEM-ARCH</replaceable>
sudo zypper refresh</screen>
    <para>
     O bien
    </para>
<screen><prompt role="root"># </prompt>SUSEConnect -p sle-module-public-cloud/15/<replaceable>SYSTEM-ARCH</replaceable>
<prompt role="root"># </prompt>zypper refresh</screen>
    <para>
     Para instalar el comando <command>swift</command>, ejecute lo siguiente:
    </para>
<screen><prompt role="root"># </prompt>zypper in python-swiftclient</screen>
    <para>
     El acceso swift utiliza la sintaxis siguiente:
    </para>
<screen><prompt>&gt; </prompt>swift -A http://<replaceable>IP_ADDRESS</replaceable>/auth/1.0 \
-U example_user:swift -K '<replaceable>SWIFT_SECRET_KEY</replaceable>' list</screen>
    <para>
     Sustituya <replaceable>IP_ADDRESS</replaceable> por la dirección IP del servidor de pasarela, y <replaceable>_SECRET_KEY</replaceable> por el valor de la clave de secreto de Swift que se obtiene al ejecutar el comando <command>radosgw-admin key create</command> para el usuario de <systemitem>swift</systemitem>swift en la <xref linkend="adding-s3-swift-users"/>.
    </para>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>&gt; </prompt>swift -A http://gateway.example.com/auth/1.0 -U example_user:swift \
-K 'r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h' list</screen>
    <para>
     El resultado es:
    </para>
<screen>my-new-bucket</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="s3-swift-accounts-managment">
   <title>Gestión de cuentas de S3 y Swift</title>
   <sect3 xml:id="adding-s3-swift-users">
    <title>Adición de usuarios de S3 y Swift</title>
    <para>
     Debe crear un usuario, una clave de acceso y un secreto para permitir que los usuarios finales puedan interactuar con la pasarela. Existen dos tipos de usuarios: <emphasis>usuario</emphasis> y <emphasis>subusuario</emphasis>. Los <emphasis>usuarios</emphasis> se utilizan cuando se interactúa con la interfaz de S3, mientras que los <emphasis>subusuarios</emphasis> son usuarios de la interfaz de Swift. Cada subusuario está asociado a un usuario.
    </para>
    <para>
     Para crear un usuario de Swift, siga estos pasos:
    </para>
    <procedure>
     <step>
      <para>
       Para crear un usuario de Swift, que es un <emphasis>subusuario</emphasis> en nuestra terminología, debe crear primero el <emphasis>usuario</emphasis> asociado.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
      <para>
       Por ejemplo:
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
     </step>
     <step>
      <para>
       Para crear un subusuario (interfaz de Swift) para el usuario, debe especificar el ID de usuario (‑‑uid=<replaceable>USERNAME</replaceable>), el ID de subusuario y el nivel de acceso para el subusuario.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser create --uid=<replaceable>UID</replaceable> \
 --subuser=<replaceable>UID</replaceable> \
 --access=[ <replaceable>read | write | readwrite | full</replaceable> ]</screen>
      <para>
       Por ejemplo:
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser create --uid=example_user \
 --subuser=example_user:swift --access=full</screen>
     </step>
     <step>
      <para>
       Genere una clave de secreto para el usuario.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create \
   --gen-secret \
   --subuser=example_user:swift \
   --key-type=swift</screen>
     </step>
     <step>
      <para>
       Ambos comandos darán como resultado datos con formato JSON que muestran el estado del usuario. Fíjese en las siguientes líneas y recuerde el valor de <literal>secret_key</literal>:
      </para>
<screen>"swift_keys": [
   { "user": "example_user:swift",
     "secret_key": "r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h"}],</screen>
     </step>
    </procedure>
    <para/>
    <para>
     Cuando acceda a Object Gateway a través de la interfaz de S3, deberá crear un usuario de S3 ejecutando:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
    <para>
     El comando también crea la clave de acceso y la clave de secreto del usuario. Compruebe el resultado de las palabras clave <literal>access_key</literal> y <literal>secret_key</literal> y sus valores correspondientes:
    </para>
<screen>[...]
 "keys": [
       { "user": "example_user",
         "access_key": "11BS02LGFB6AL6H1ADMW",
         "secret_key": "vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY"}],
 [...]</screen>
   </sect3>
   <sect3 xml:id="removing-s3-swift-users">
    <title>Eliminación de usuarios de S3 y Swift</title>
    <para>
     El procedimiento para suprimir usuarios es similar para los usuarios de S3 y de Swift. Pero en el caso de los usuarios de Swift, puede ser necesario suprimir el usuario incluyendo sus subusuarios.
    </para>
    <para>
     Para eliminar un usuario de S3 o Swift (incluidos todos sus subusuarios), especifique <option>user rm</option> y el ID de usuario en el siguiente comando:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user rm --uid=example_user</screen>
    <para>
     Para eliminar un subusuario, especifique <option>subuser rm</option> y el ID de subusuario.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser rm --uid=example_user:swift</screen>
    <para>
     Puede usar las siguientes opciones:
    </para>
    <variablelist>
     <varlistentry>
      <term>--purge-data</term>
      <listitem>
       <para>
        Limpia todos los datos asociados al ID de usuario.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>--purge-keys</term>
      <listitem>
       <para>
        Limpia todas las claves asociadas al ID de usuario.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <tip>
     <title>eliminación de un subusuario</title>
     <para>
      Cuando se elimina un subusuario, se elimina el acceso a la interfaz de Swift. El usuario permanecerá en el sistema.
     </para>
    </tip>
   </sect3>
   <sect3 xml:id="changing-s3-swift-users-password">
    <title>Cambio del acceso de usuario y las claves de secreto de S3 y Swift</title>
    <para>
     Los parámetros <literal>access_key</literal> y <literal>secret_key</literal> identifican al usuario de Object Gateway cuando se accede a la pasarela. Cambiar las claves de usuario existentes es igual a crear otras nuevas, ya que las claves antiguas se sobrescriben.
    </para>
    <para>
     Para los usuarios de S3, ejecute lo siguiente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create --uid=<replaceable>EXAMPLE_USER</replaceable> --key-type=s3 --gen-access-key --gen-secret</screen>
    <para>
     Para los usuarios de Swift, ejecute lo siguiente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create --subuser=<replaceable>EXAMPLE_USER</replaceable>:swift --key-type=swift --gen-secret</screen>
    <variablelist>
     <varlistentry>
      <term><option>‑‑key-type=<replaceable>TYPE</replaceable></option></term>
      <listitem>
       <para>
        Especifica el tipo de clave. Puede ser <literal>swift</literal> o <literal>s3</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-access-key</option></term>
      <listitem>
       <para>
        Genera una clave de acceso aleatoria (por defecto, para el usuario de S3).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-secret</option></term>
      <listitem>
       <para>
        Genera una clave de secreto aleatoria.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>‑‑secret=<replaceable>KEY</replaceable></option></term>
      <listitem>
       <para>
        Especifica una clave de secreto; por ejemplo, una generada manualmente.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="user-quota-managment">
    <title>Habilitación de la gestión de cuotas de usuario</title>
    <para>
     Ceph Object Gateway permite definir cuotas en usuarios y depósitos que pertenezcan a los usuarios. Las cuotas incluyen el número máximo de objetos de un depósito y el tamaño de almacenamiento máximo en megabytes.
    </para>
    <para>
     Antes de habilitar una cuota de usuario, debe definir los parámetros correspondientes:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota set --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable> \
 --max-objects=1024 --max-size=1024</screen>
    <variablelist>
     <varlistentry>
      <term><option>--max-objects</option></term>
      <listitem>
       <para>
        Especifica el número máximo de objetos. Un valor negativo inhabilita la comprobación.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--max-size</option></term>
      <listitem>
       <para>
        Especifica el número máximo de bytes. Un valor negativo inhabilita la comprobación.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--quota-scope</option></term>
      <listitem>
       <para>
        Define el ámbito para la cuota. Las opciones son <literal>depósito</literal> y <literal>usuario</literal>. Las cuotas de depósito se aplican a los depósitos que posee un usuario. Las cuotas de usuario se aplican a un usuario.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Una vez definida una cuota de usuario, se puede habilitar:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota enable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Para inhabilitar una cuota:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota disable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Para mostrar la configuración de la cuota:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Para actualizar las estadísticas de la cuota:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user stats --uid=<replaceable>EXAMPLE_USER</replaceable> --sync-stats</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-http-frontends">
  <title>Procesadores frontales HTTP</title>

  <para>
   Ceph Object Gateway admite dos front-ends HTTP incrustados: <emphasis>Beast</emphasis> y <emphasis>Civetweb</emphasis>.
  </para>

  <para>
   El front-end Beast utiliza la biblioteca Boost.Beast para el análisis HTTP y la biblioteca Boost.Asio para la E/S de red asincrónica.
  </para>

  <para>
   El front-end Civetweb utiliza la biblioteca HTTP Civetweb, que es una derivación de Mongoose.
  </para>

  <para>
   Puede configurarlos con la opción <option>rgw_frontends</option>. Consulte la <xref linkend="config-ogw"/> para obtener una lista de las opciones de configuración.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-https">
  <title>Habilitación de HTTPS/SSL para pasarelas Object Gateway</title>

  <para>
   Para permitir que Object Gateway se pueda comunicar de forma segura mediante SSL, debe tener un certificado emitido por una CA o crear uno autofirmado.
  </para>

  <sect2 xml:id="ogw-selfcert">
   <title>Creación de certificados autofirmados</title>
   <tip>
    <para>
     Omita esta sección si ya dispone de un certificado válido firmado por una CA.
    </para>
   </tip>
   <para>
    El siguiente procedimiento describe cómo generar un certificado SSL autofirmado en el master de Salt.
   </para>
   <procedure>
    <step>
     <para>
      Si necesita que identidades de sujeto adicionales conozcan Object Gateway, añádalas a la opción <option>subjectAltName</option> en la sección <literal>[v3_req]</literal> del archivo <filename>/etc/ssl/openssl.cnf</filename>:
     </para>
<screen>
[...]
[ v3_req ]
subjectAltName = DNS:server1.example.com DNS:server2.example.com
[...]
</screen>
     <tip>
      <title>direcciones IP en <option>subjectAltName</option></title>
      <para>
       Para utilizar direcciones IP en lugar de nombres de dominio en la opción <option>subjectAltName</option>, sustituya la línea de ejemplo por lo siguiente:
      </para>
<screen>
subjectAltName = IP:10.0.0.10 IP:10.0.0.11
</screen>
     </tip>
    </step>
    <step>
     <para>
      Cree la clave y el certificado con <command>openssl</command>. Introduzca todos los datos que necesite incluir en el certificado. Es recomendable introducir el nombre completo como nombre común. Antes de firmar el certificado, verifique que en las extensiones pedidas se incluye &quot;X509v3 Subject Alternative Name:&quot; y que el certificado resultante tiene definido &quot;X509v3 Subject Alternative Name:&quot;.
     </para>
<screen>
<prompt>root@master # </prompt>openssl req -x509 -nodes -days 1095 \
 -newkey rsa:4096 -keyout rgw.key
 -out rgw.pem
</screen>
    </step>
    <step>
     <para>
      Añada la clave al final del archivo de certificado:
     </para>
<screen>
<prompt>root@master # </prompt>cat rgw.key &gt;&gt; rgw.pem
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-sssl-config">
   <title>Configuración de Object Gateway con SSL</title>
   <para>
    Para configurar Object Gateway para que utilice certificados SSL, utilice la opción <option>rgw_frontends</option>. Por ejemplo:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set <replaceable>WHO</replaceable> rgw_frontends \
 beast ssl_port=443 ssl_certificate=config://<replaceable>CERT</replaceable> ssl_key=config://<replaceable>KEY</replaceable>
</screen>
   <para>
    Si no especifica las claves de configuración <replaceable>CERT</replaceable> y <replaceable>KEY</replaceable>, el servicio de Object Gateway buscará el certificado SSL y la clave en las siguientes claves de configuración:
   </para>
<screen>
rgw/cert/<replaceable>RGW_REALM</replaceable>/<replaceable>RGW_ZONE</replaceable>.key
rgw/cert/<replaceable>RGW_REALM</replaceable>/<replaceable>RGW_ZONE</replaceable>.crt
</screen>
   <para>
    Si desea anular la clave SSL por defecto y la ubicación del certificado, impórtelos a la base de datos de configuración mediante el comando siguiente:
   </para>
<screen>ceph config-key set <replaceable>CUSTOM_CONFIG_KEY</replaceable> -i <replaceable>PATH_TO_CERT_FILE</replaceable></screen>
   <para>
    A continuación, utilice las claves de configuración personalizadas mediante la directiva <literal>config://</literal>. 
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-sync">
  <title>Módulos de sincronización</title>

  <para>
   Object Gateway se distribuye como un servicio multisitio y puede duplicar datos y metadatos entre las zonas. Los <emphasis>módulos de sincronización</emphasis> se crean sobre la infraestructura de varios sitios y permiten el envío de datos y metadatos a un nivel externo diferente. Con un módulo de sincronización es posible realizar un conjunto de acciones siempre que se produzca un cambio en los datos (por ejemplo, las operaciones de metadatos como la creación de depósitos o usuarios). Como los cambios en varios sitios de Object Gateway al final acaban siendo consistentes en los sitios remotos, estos cambios se propagan de forma asíncrona. Esto cubre situaciones de uso como realizar una copia de seguridad del almacenamiento de objetos en un clúster de nube externa o una solución de copia de seguridad personalizada mediante unidades de cinta; o también indexar metadatos en ElasticSearch,
  </para>

  <sect2 xml:id="ogw-sync-general-config">
   <title>Configuración de módulos de sincronización</title>
   <para>
    Todos los módulos de sincronización se configuran de forma similar. Debe crear una zona nueva (consulte la <xref linkend="ceph-rgw-fed"/> para obtener más detalles) y defina su opción <option>‑‑tier_type</option>, por ejemplo <option>‑‑tier-type-cloud</option> para el módulo de sincronización en la nube:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --endpoints=http://endpoint1.example.com,http://endpoint2.example.com, [...] \
 --tier-type=cloud
</screen>
   <para>
    Puede configurar el nivel específico mediante el siguiente comando:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=<replaceable>KEY1</replaceable>=<replaceable>VALUE1</replaceable>,<replaceable>KEY2</replaceable>=<replaceable>VALUE2</replaceable>
</screen>
   <para>
    El elemento <replaceable>KEY</replaceable> de la configuración especifica la variable de configuración que desea actualizar y <replaceable>VALUE</replaceable> especifica su nuevo valor. Es posible acceder a los valores anidados usando un punto. Por ejemplo:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=connection.access_key=<replaceable>KEY</replaceable>,connection.secret=<replaceable>SECRET</replaceable>
</screen>
   <para>
    Puede acceder a las entradas de matriz añadiendo corchetes &quot;[]&quot; detrás de la entrada a la que se hace referencia. Es posible añadir una entrada de matriz nueva utilizando corchetes &quot;[]&quot;. El valor de índice de -1 hace referencia a la última entrada de la matriz. No es posible crear una entrada nueva y volver a hacer referencia a ella en el mismo comando. Por ejemplo, se muestra un comando para crear un perfil nuevo para depósitos que empiecen con <replaceable>PREFIX</replaceable>:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[].source_bucket=<replaceable>PREFIX</replaceable>'*'
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[-1].connection_id=<replaceable>CONNECTION_ID</replaceable>,profiles[-1].acls_id=<replaceable>ACLS_ID</replaceable>
</screen>
   <tip>
    <title>adición y eliminación de entradas de configuración</title>
    <para>
     Puede añadir una nueva entrada de configuración de nivel con el parámetro <option>‑‑tier-config-add=<replaceable>KEY</replaceable>=<replaceable>VALUE</replaceable></option>.
    </para>
    <para>
     Para quitar una entrada existente, use <option>‑‑tier-config-rm=<replaceable>KEY</replaceable></option>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-zones">
   <title>Sincronización de zonas</title>
   <para>
    La configuración del módulo de sincronización es local en una zona. El módulo de sincronización determina si la zona exporta los datos o si solo puede utilizar los datos que se ha modificado en otra zona. A partir de la versión Luminous, los complementos de sincronización compatibles son <literal>ElasticSearch</literal>, <literal>rgw</literal> (el complemento por defecto que sincroniza los datos entre las zonas) y <literal>log</literal>, un complemento de sincronización trivial que registra la operación de metadatos que se produce en las zonas remotas. Las secciones siguientes muestran como ejemplo una zona con el módulo de sincronización <literal>ElasticSearch</literal>. El proceso será similar para configurar cualquier otro complemento de sincronización.
   </para>
   <note>
    <title>complemento de sincronización por defecto</title>
    <para>
     El complemento de sincronización por defecto es <literal>rgw</literal> y no es necesario configurarlo de forma explícita.
    </para>
   </note>
   <sect3 xml:id="ceph-rgw-sync-zones-req">
    <title>Requisitos y supuestos</title>
    <para>
     Supongamos que tenemos una configuración sencilla de varios sitios, descrita en la <xref linkend="ceph-rgw-fed"/>, formada por 2 zonas: <literal>us-east</literal> y <literal>us-west</literal>. Se añade una tercera zona <literal>us-east-es</literal>, que es una zona que solo procesa metadatos de los otros sitios. Esta zona puede estar en el mismo clúster de Ceph o en uno distinto a <literal>us-east</literal>. Esta zona solo consumirá metadatos de otras zonas y la pasarela Object Gateway de esta zona no atenderá directamente a ninguna petición del usuario final.
    </para>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-zones-configure">
    <title>Configuración de zonas</title>
    <procedure>
     <step>
      <para>
       Cree una tercera zona similar a la que se describe en la <xref linkend="ceph-rgw-fed"/>, por ejemplo:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone create --rgw-zonegroup=us --rgw-zone=us-east-es \
--access-key=<replaceable>SYSTEM-KEY</replaceable> --secret=<replaceable>SECRET</replaceable> --endpoints=http://rgw-es:80
      </screen>
     </step>
     <step>
      <para>
       Puede configurar un módulo de sincronización para esta zona así:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=<replaceable>TIER-TYPE</replaceable> \
--tier-config={set of key=value pairs}
      </screen>
     </step>
     <step>
      <para>
       Por ejemplo, en el módulo de sincronización <literal>ElasticSearch</literal>:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=elasticsearch \
--tier-config=endpoint=http://localhost:9200,num_shards=10,num_replicas=1
      </screen>
      <para>
       Para las distintas opciones de configuración de niveles admitidas, consulte la <xref linkend="ceph-rgw-sync-elastic"/>.
      </para>
     </step>
     <step>
      <para>
       Por último, actualice el período:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> period update --commit
      </screen>
     </step>
     <step>
      <para>
       Inicie ahora Object Gateway en la zona:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch start rgw.<replaceable>REALM-NAME</replaceable>.<replaceable>ZONE-NAME</replaceable>
      </screen>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-elastic">
   <title>Módulo de sincronización ElasticSearch</title>
   <para>
    Este módulo de sincronización escribe los metadatos de otras zonas en ElasticSearch. A partir de la versión Luminous, este es el código JSON de campos de datos que se almacenan en ElasticSearch.
   </para>
<screen>
{
  "_index" : "rgw-gold-ee5863d6",
  "_type" : "object",
  "_id" : "34137443-8592-48d9-8ca7-160255d52ade.34137.1:object1:null",
  "_score" : 1.0,
  "_source" : {
    "bucket" : "testbucket123",
    "name" : "object1",
    "instance" : "null",
    "versioned_epoch" : 0,
    "owner" : {
      "id" : "user1",
      "display_name" : "user1"
    },
    "permissions" : [
      "user1"
    ],
    "meta" : {
      "size" : 712354,
      "mtime" : "2017-05-04T12:54:16.462Z",
      "etag" : "7ac66c0f148de9519b8bd264312c4d64"
    }
  }
}
   </screen>
   <sect3 xml:id="ceph-rgw-sync-elastic-config">
    <title>Parámetros de configuración de tipo de nivel de ElasticSearch</title>
    <variablelist>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        Especifica el puesto final del servidor de ElasticSearch al que se accede.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_shards</term>
      <listitem>
       <para>
        <emphasis>(número entero)</emphasis> El número de particiones con las que se configurará ElasticSearch al inicializar la sincronización de datos. Tenga en cuenta que este valor no se puede cambiar después de la inicialización. Cualquier cambio que se haga aquí requiere que se vuelva a crear el índice de ElasticSearch y se reinicialice el proceso de sincronización de datos.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_replicas</term>
      <listitem>
       <para>
        <emphasis>(número entero)</emphasis> El número de réplicas con las que se configurará ElasticSearch al inicializar la sincronización de datos.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>explicit_custom_meta</term>
      <listitem>
       <para>
        <emphasis>(true | false)</emphasis> Especifica si se indexarán todos los metadatos personalizados del usuario, o si el usuario deberá configurar (en el nivel de depósitos) las entradas de metadatos del cliente que se deben indexar. La opción por defecto es &quot;false&quot; (falso).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>index_buckets_list</term>
      <listitem>
       <para>
        <emphasis>(lista de cadenas separadas por comas)</emphasis> Si está vacío, todos los depósitos se indexarán. De lo contrario, solo se indexarán los depósitos que se especifiquen aquí. Es posible proporcionar prefijos de depósito (por ejemplo, &quot;foo*&quot;) o sufijos de depósito (por ejemplo, &quot;*bar&quot;).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>approved_owners_list</term>
      <listitem>
       <para>
        <emphasis>(lista de cadenas separadas por comas)</emphasis> Si está vacío, se indexarán los depósitos de todos los propietarios (esto está sujeto a otras restricciones). En caso contrario, se indexarán solo los depósitos de los propietarios especificados. También es posible proporcionar prefijos y sufijos.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>override_index_path</term>
      <listitem>
       <para>
        <emphasis>(cadena) </emphasis> Si no está vacío, esta cadena se utilizará como la vía de índice de ElasticSearch. De lo contrario, la vía de índice se determinará y se generará durante la inicialización de la sincronización.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>username</term>
      <listitem>
       <para>
        Indica un nombre de usuario para ElasticSearch si se requiere autenticación.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>password</term>
      <listitem>
       <para>
        Indica una contraseña para ElasticSearch si se requiere autenticación.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-elastic-query">
    <title>Consultas de metadatos</title>
    <para>
     Dado que el clúster de ElasticSearch almacena ahora metadatos de objeto, es importante que el puesto final de ElasticSearch no esté expuesto al público y solo puedan acceder los administradores de clúster. Exponer las consultas de metadatos a los usuarios finales plantea un problema, ya que queremos que los usuarios solo puedan consultar sus propios metadatos y no los de otros usuarios. Esto último requeriría que el clúster de ElasticSearch autenticara a los usuarios de forma similar a como lo hace RGW, lo que supone un problema.
    </para>
    <para>
     A partir de la versión Luminous, la instancia de RGW de la zona principal de metadatos puede atender a las peticiones del usuario final. De este modo, no se expone el puesto final de ElasticSearch al público y también se resuelve el problema de la autenticación y la autorización, ya que RGW realiza estas labores para las peticiones del usuario final. Por este motivo, RGW presenta una nueva consulta en las API de depósito que pueden atender las peticiones de ElasticSearch. Todas estas peticiones deben enviarse a la zona principal de metadatos.
    </para>
    <variablelist>
     <varlistentry>
      <term>Cómo obtener una consulta de ElasticSearch</term>
      <listitem>
<screen>
GET /<replaceable>BUCKET</replaceable>?query=<replaceable>QUERY-EXPR</replaceable>
       </screen>
       <para>
        Parámetros de la petición:
       </para>
       <itemizedlist>
        <listitem>
         <para>
          max-keys: el número máximo de entradas que se deben devolver.
         </para>
        </listitem>
        <listitem>
         <para>
          marker: el marcador de paginación.
         </para>
        </listitem>
       </itemizedlist>
<screen>
expression := [(]&lt;arg&gt; &lt;op&gt; &lt;value&gt; [)][&lt;and|or&gt; ...]
       </screen>
       <para>
        El operador &quot;op&quot; es uno de los siguientes: &lt;, &lt;=, ==, &gt;=, &gt;
       </para>
       <para>
        Por ejemplo:
       </para>
<screen>
GET /?query=name==foo
       </screen>
       <para>
        devolverá todas las claves indexadas para las que el usuario tiene permiso de lectura y que tienen como nombre &quot;foo&quot;. El resultado será una lista de claves en formato XML similar a la respuesta de lista de depósitos de S3.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Cómo configurar campos de metadatos personalizados</term>
      <listitem>
       <para>
        Defina las entradas de metadatos personalizados que se deben indexar (en el depósito especificado) y cuáles son los tipos de estas claves. Si se ha configurado el indexado explícito de metadatos personalizados, esto es obligatorio para que rgw indexe los valores de los metadatos personalizados especificados. También es necesario en casos en los que las claves de metadatos indexadas sean de un tipo distinto a cadena.
       </para>
<screen>
POST /<replaceable>BUCKET</replaceable>?mdsearch
x-amz-meta-search: &lt;key [; type]&gt; [, ...]
       </screen>
       <para>
        Si hay varios campos de metadatos, deben separarse con comas. Es posible aplicar un tipo para un campo con punto y coma &quot;;&quot;. Los tipos permitidos actualmente son string (valor por defecto), integer y date. Por ejemplo, si desea indexar un metadato de objeto personalizado x-amz-meta-year como int, x-amz-meta-date como fecha de tipo y x-amz-meta-title como cadena, debería hacer lo siguiente:
       </para>
<screen>
POST /mybooks?mdsearch
x-amz-meta-search: x-amz-meta-year;int, x-amz-meta-release-date;date, x-amz-meta-title;string
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Cómo suprimir una configuración personalizada de metadatos</term>
      <listitem>
       <para>
        Puede suprimir una configuración personalizada de metadatos.
       </para>
<screen>
DELETE /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Cómo obtener una configuración personalizada de metadatos</term>
      <listitem>
       <para>
        Puede recuperar una configuración personalizada de metadatos.
       </para>
<screen>
GET /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-cloud-sync">
   <title>Módulo de sincronización en la nube</title>
   <para>
    En esta sección se presenta un módulo que sincroniza los datos de zona con un servicio remoto en la nube. La sincronización es unidireccional: la fecha no se sincroniza de nuevo desde la zona remota. El objetivo principal de este módulo es habilitar la sincronización de datos con varios proveedores de servicios en la nube. Actualmente es compatible con proveedores de nube compatibles con AWS (S3).
   </para>
   <para>
    Para sincronizar los datos con un servicio remoto en la nube, debe configurar las credenciales de usuario. Dado que muchos servicios en la nube incluyen límites en el número de depósitos que puede crear cada usuario, es posible configurar la asignación de objetos y depósitos de origen, diferentes destinos para a distintos depósitos y prefijos de depósito. Tenga en cuenta que las listas de acceso de origen (ACL) no se conservarán. Es posible asignar permisos de usuarios de origen específicos a usuarios de destino concretos.
   </para>
   <para>
    Debido a las limitaciones de la API, no hay manera de conservar la hora de modificación del objeto original ni la etiqueta de entidad HTTP (ETag). El módulo de sincronización en la nube los almacena como atributos de metadatos en los objetos de destino.
   </para>
   <sect3 xml:id="cloud-sync-module">
    <title>Configuración del módulo de sincronización en la nube</title>
    <para>
     A continuación se muestran ejemplos de una configuración trivial y no trivial para el módulo de sincronización en la nube. Tenga en cuenta que la configuración trivial puede presentar conflictos con la no trivial.
    </para>
    <example>
     <title>Configuración trivial</title>
<screen>
{
  "connection": {
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,
  },
  "acls": [ { "type": <replaceable>id | email | uri</replaceable>,
    "source_id": <replaceable>SOURCE_ID</replaceable>,
    "dest_id": <replaceable>DEST_ID</replaceable> } ... ],
  "target_path": <replaceable>TARGET_PATH</replaceable>,
}
</screen>
    </example>
    <example>
     <title>Configuración no trivial</title>
<screen>
{
  "default": {
    "connection": {
      "access_key": <replaceable>ACCESS</replaceable>,
      "secret": <replaceable>SECRET</replaceable>,
      "endpoint": <replaceable>ENDPOINT</replaceable>,
      "host_style" <replaceable>path | virtual</replaceable>,
    },
    "acls": [
    {
      "type": <replaceable>id | email | uri</replaceable>,   #  optional, default is id
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
    "target_path": <replaceable>PATH</replaceable> # optional
  },
  "connections": [
  {
    "connection_id": <replaceable>ID</replaceable>,
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,  # optional
  } ... ],
  "acl_profiles": [
  {
    "acls_id": <replaceable>ID</replaceable>, # acl mappings
    "acls": [ {
      "type": <replaceable>id | email | uri</replaceable>,
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
  }
  ],
  "profiles": [
  {
   "source_bucket": <replaceable>SOURCE</replaceable>,
   "connection_id": <replaceable>CONNECTION_ID</replaceable>,
   "acls_id": <replaceable>MAPPINGS_ID</replaceable>,
   "target_path": <replaceable>DEST</replaceable>,          # optional
  } ... ],
}
</screen>
    </example>
    <para>
     A continuación se explican los términos de configuración utilizados:
    </para>
    <variablelist>
     <varlistentry>
      <term>connection</term>
      <listitem>
       <para>
        Representa una conexión con el servicio remoto en la nube. Contiene &quot;connection_id&quot;, &quot;access_key&quot;, &quot;secret&quot;, &quot;endpoint&quot; y &quot;host_style&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>access_key</term>
      <listitem>
       <para>
        La clave de acceso remoto a la nube que se usará para la conexión específica.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>secret</term>
      <listitem>
       <para>
        La clave secreta para el servicio remoto en la nube.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        Dirección URL del puesto final del servicio remoto en la nube.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>host_style</term>
      <listitem>
       <para>
        El tipo de estilo del host (&quot;path&quot; o &quot;virtual&quot;) que se usará al acceder de forma remota al puesto final en la nube. El valor por defecto es &quot;path&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acls</term>
      <listitem>
       <para>
        La matriz de asignaciones de la lista de acceso.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_mapping</term>
      <listitem>
       <para>
        Cada estructura &quot;acl_mapping&quot; contiene &quot;type&quot;, &quot;source_id&quot; y &quot;dest_id&quot;. Estos elementos definen la mutación de la ACL para cada objeto. Una mutación de la ACL permite convertir el ID de usuario de origen en un ID de destino.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>type</term>
      <listitem>
       <para>
        El tipo de ACL &quot;id&quot; define el ID de usuario, &quot;email&quot; define al usuario por correo electrónico y &quot;uri&quot; define al usuario por uri (grupo).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>source_id</term>
      <listitem>
       <para>
        El ID de usuario en la zona de origen.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>dest_id</term>
      <listitem>
       <para>
        El ID de usuario en el destino.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>target_path</term>
      <listitem>
       <para>
        Cadena que define cómo se crea la vía de destino. La vía de destino especifica un prefijo al que se anexa el nombre del objeto de origen. La vía de destino configurable puede incluir cualquiera de las variables siguientes:
       </para>
       <variablelist>
        <varlistentry>
         <term>SID</term>
         <listitem>
          <para>
           Una cadena exclusiva que representa el ID de instancia de sincronización.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP</term>
         <listitem>
          <para>
           El nombre del grupo de zonas.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP_ID</term>
         <listitem>
          <para>
           El ID de grupo de zonas.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE</term>
         <listitem>
          <para>
           Nombre de zona.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE_ID</term>
         <listitem>
          <para>
           El ID de zona.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>BUCKET</term>
         <listitem>
          <para>
           El nombre del depósito de origen.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>OWNER</term>
         <listitem>
          <para>
           El ID de propietario del depósito de origen.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        Por ejemplo: target_path = rgwx-<replaceable>ZONA</replaceable>-<replaceable>SID</replaceable>/<replaceable>PROPIETARIO</replaceable>/<replaceable>DEPÓSITO</replaceable>
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profiles</term>
      <listitem>
       <para>
        Una matriz de perfiles de lista de acceso.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profile</term>
      <listitem>
       <para>
        Cada perfil contiene &quot;acls_id&quot;, que representa el perfil y una matriz &quot;acls&quot; que contiene una lista &quot;acl_mappings&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>profiles</term>
      <listitem>
       <para>
        Una lista de perfiles. Cada perfil contiene lo siguiente:
       </para>
       <variablelist>
        <varlistentry>
         <term>source_bucket</term>
         <listitem>
          <para>
           Un nombre de depósito o un prefijo de depósito (si termina con *) que define los depósitos de origen para este perfil.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>target_path</term>
         <listitem>
          <para>
           Consulte arriba la explicación.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>connection_id</term>
         <listitem>
          <para>
           El ID de la conexión que se utilizará para este perfil.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>acls_id</term>
         <listitem>
          <para>
           El ID del perfil de ACL que se utilizará para este perfil.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="s3-specific-configurables">
    <title>Elementos configurables específicos de S3</title>
    <para>
     El módulo de sincronización en la nube solo funciona con back-ends compatibles con AWS S3. Hay algunos elementos configurables que se pueden utilizar para ajustar su comportamiento al acceder a los servicios en la nube de S3:
    </para>
<screen>
{
  "multipart_sync_threshold": <replaceable>OBJECT_SIZE</replaceable>,
  "multipart_min_part_size": <replaceable>PART_SIZE</replaceable>
}
</screen>
    <variablelist>
     <varlistentry>
      <term>multipart_sync_threshold</term>
      <listitem>
       <para>
        Los objetos cuyo tamaño sea igual o mayor que este valor se sincronizarán con el servicio en la nube mediante la carga de varias partes.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>multipart_min_part_size</term>
      <listitem>
       <para>
        El tamaño mínimo de las partes que se debe utilizar al sincronizar objetos mediante la carga de varias partes.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="archive-sync-module">
   <title>Módulo de sincronización de archivador</title>
   <para>
    El módulo <emphasis>archive sync module</emphasis> usa la característica de control de versiones de objetos S3 en Object Gateway. Puede configurar una <emphasis>zona de archivador</emphasis> que capture las diferentes versiones de los objetos S3 a medida que se producen en otras zonas. El historial de versiones que conserva la zona de archivador solo se puede eliminar a través de pasarelas asociadas con la zona de archivador.
   </para>
   <para>
    Con esta arquitectura, es posible que varias zonas sin versiones pueden duplicar sus datos y metadatos a través de sus pasarelas de zona, lo que proporciona alta disponibilidad a los usuarios finales, mientras que la zona de archivador captura todas las actualizaciones de datos para consolidarlos como versiones de objetos S3.
   </para>
   <para>
    Al incluir la zona de archivador en una configuración multizona, se consigue la flexibilidad de un historial de objetos dS3 en una zona, al tiempo que se ahorra el espacio que las réplicas de los objetos S3 versionados consumirían en las zonas restantes.
   </para>
   <sect3 xml:id="archive-sync-module-configuration">
    <title>Configuración del módulo de sincronización de archivador</title>
    <tip>
     <title>más información</title>
     <para>
      Consulte la <xref linkend="ceph-rgw-fed"/> para obtener más información sobre la configuración de pasarelas de varios sitios.
     </para>
     <para>
      Consulte la <xref linkend="ceph-rgw-sync"/> para obtener información detallada sobre cómo configurar los módulos de sincronización.
     </para>
    </tip>
    <para>
     Para utilizar el módulo de sincronización de archivador, debe crear una zona nueva cuyo tipo de nivel esté definido como <literal>archive</literal>:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE_GROUP_NAME</replaceable> \
 --rgw-zone=<replaceable>OGW_ZONE_NAME</replaceable> \
 --endpoints=<replaceable>http://OGW_ENDPOINT1_URL[,http://OGW_ENDPOINT2_URL,...]</replaceable>
 --tier-type=archive
</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-ldap">
  <title>Autenticación LDAP</title>

  <para>
   Aparte de la autenticación de usuario local por defecto, Object Gateway también puede utilizar servicios del servidor LDAP para autenticar a los usuarios.
  </para>

  <sect2 xml:id="ceph-rgw-ldap-how-works">
   <title>Mecanismo de autenticación</title>
   <para>
    Object Gateway extrae las credenciales LDAP del usuario de un testigo. Se construye un filtro de búsqueda a partir del nombre de usuario. Object Gateway utiliza la cuenta del servicio configurado para buscar una entrada que coincida en el directorio. Si se encuentra una entrada, Object Gateway intenta vincularse al nombre completo encontrado con la contraseña del testigo. Si las credenciales son válidas, la vinculación se realizará correctamente y Object Gateway otorgará acceso.
   </para>
   <para>
    Puede limitar los usuarios permitidos estableciendo como base para la búsqueda una unidad organizativa específica o especificando un filtro de búsqueda personalizado; por ejemplo, un filtro que requiera la pertenencia a un grupo específico, clases de objetos personalizados o atributos.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-reqs">
   <title>Requisitos</title>
   <itemizedlist>
    <listitem>
     <para>
      <emphasis>LDAP o Active Directory:</emphasis> una instancia de LDAP en ejecución a la que Object Gateway pueda acceder.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Cuenta de servicio:</emphasis> credenciales LDAP que utilizará Object Gateway con los permisos de búsqueda.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Cuenta de usuario:</emphasis> al menos una cuenta de usuario en el directorio LDAP.
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>LDAP y los usuarios locales no se deben solapar</title>
    <para>
     No debe utilizar los mismos nombres de usuario para los usuarios locales y los usuarios que se van a autenticar mediante LDAP. Object Gateway no puede distinguirlos y los trata como el mismo usuario.
    </para>
   </important>
   <tip>
    <title>comprobaciones de estado</title>
    <para>
     Emplee la utilidad <command>ldapsearch</command> para verificar la cuenta de servicio o la conexión LDAP. Por ejemplo:
    </para>
<screen><prompt>&gt; </prompt>ldapsearch -x -D "uid=ceph,ou=system,dc=example,dc=com" -W \
-H ldaps://example.com -b "ou=users,dc=example,dc=com" 'uid=*' dn</screen>
    <para>
     Asegúrese de utilizar los mismos parámetros LDAP del archivo de configuración de Ceph para eliminar posibles problemas.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-config">
   <title>Configuración de Object Gateway para utilizar la autenticación LDAP</title>
   <para>
    Los siguientes parámetros están relacionados con la autenticación LDAP:
   </para>
   <variablelist>
    <varlistentry>
     <term><option>rgw_s3_auth_use_ldap</option></term>
     <listitem>
      <para>
       Defina esta opción en <literal>true</literal> para habilitar la autenticación S3 con LDAP.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_uri</option></term>
     <listitem>
      <para>
       Especifica el servidor LDAP que se debe usar. Asegúrese de usar el parámetro <literal>ldaps://<replaceable>nombre_completo</replaceable>:<replaceable>puerto</replaceable></literal> para evitar la transmisión de credenciales de forma abierta en formato de texto sin cifrar.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_binddn</option></term>
     <listitem>
      <para>
       El nombre completo (DN) de la cuenta de servicio que utiliza Object Gateway.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_secret</option></term>
     <listitem>
      <para>
       La contraseña de la cuenta de servicio.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>rgw_ldap_searchdn</term>
     <listitem>
      <para>
       Especifica la base en el árbol de información del directorio para buscar usuarios. Puede tratarse de la unidad organizativa de los usuarios o alguna unidad organizativa (OU) más específica.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_dnattr</option></term>
     <listitem>
      <para>
       El atributo que se utiliza en el filtro de búsqueda construido para que coincida con un nombre de usuario. Dependiendo de su árbol de información de directorio (DIT), probablemente será <literal>uid</literal> o <literal>cn</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_search_filter</option></term>
     <listitem>
      <para>
       Si no se especifica, Object Gateway crea automáticamente el filtro de búsqueda con el valor <option>rgw_ldap_dnattr</option>. Este parámetro se puede usar para restringir la lista de usuarios permitidos de formas muy flexibles. Consulte la <xref linkend="ceph-rgw-ldap-filter"/> para obtener más información.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-filter">
   <title>Uso de un filtro de búsqueda personalizado para limitar el acceso de usuario</title>
   <para>
    Existen dos formas de utilizar el parámetro <option>rgw_search_filter</option>.
   </para>
   <sect3 xml:id="partial-filter-search-filter">
    <title>Filtro parcial para restringir aún más el filtro de búsqueda construido</title>
    <para>
     Un ejemplo de un filtro parcial:
    </para>
<screen>"objectclass=inetorgperson"</screen>
    <para>
     Object Gateway generará el filtro de búsqueda de la forma habitual con el nombre de usuario tomado del testigo y el valor de <option>rgw_ldap_dnattr</option>. El filtro construido se combina a continuación con el filtro parcial del atributo <option>rgw_search_filter</option>. Según el nombre de usuario y la configuración, el filtro de búsqueda final puede ser:
    </para>
<screen>"(&amp;(uid=hari)(objectclass=inetorgperson))"</screen>
    <para>
     En este caso, solo se otorgará acceso al usuario &quot;hari&quot; si se encuentra en el directorio LDAP, tiene la clase de objeto &quot;inetorgperson&quot; y ha especificado una contraseña válida.
    </para>
   </sect3>
   <sect3 xml:id="complete-filter">
    <title>Filtro completo</title>
    <para>
     Un filtro completo debe contener un testigo <option>USERNAME</option> que se sustituirá por el nombre de usuario durante el intento de autenticación. El parámetro <option>rgw_ldap_dnattr</option> ya no se usa en este caso. Por ejemplo, para limitar los usuarios válidos a un grupo específico, utilice el filtro siguiente:
    </para>
<screen>"(&amp;(uid=USERNAME)(memberOf=cn=ceph-users,ou=groups,dc=mycompany,dc=com))"</screen>
    <note>
     <title>atributo <literal>memberOf</literal></title>
     <para>
      Para poder usar el atributo <literal>memberOf</literal> en las búsquedas LDAP se requiere compatibilidad en el servidor LDAP específico implementado.
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-token">
   <title>Generación de un testigo de acceso para la autenticación LDAP</title>
   <para>
    La utilidad <command>radosgw-token</command> genera el testigo de acceso en función del nombre de usuario y la contraseña LDAP. Cree una cadena codificada en base 64 que es el testigo de acceso real. Utilice su cliente de S3 favorito (consulte la <xref linkend="accessing-ragos-gateway"/>) y especifique el testigo como clave de acceso y utilice una clave de secreto vacía.
   </para>
<screen><prompt>&gt; </prompt>export RGW_ACCESS_KEY_ID="<replaceable>USERNAME</replaceable>"
<prompt>&gt; </prompt>export RGW_SECRET_ACCESS_KEY="<replaceable>PASSWORD</replaceable>"
<prompt>cephuser@adm &gt; </prompt>radosgw-token --encode --ttype=ldap</screen>
   <important>
    <title>credenciales en texto no cifrado</title>
    <para>
     El testigo de acceso es una estructura JSON codificada en base 64 y contiene las credenciales LDAP en texto sin cifrar.
    </para>
   </important>
   <note>
    <title>Active Directory </title>
    <para>
     Para Active Directory, utilice el parámetro <option>‑‑type=ad</option>.
    </para>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-bucket-sharding">
  <title>Partición del índice de depósito</title>

  <para>
   Object Gateway almacena los datos del índice de depósito en un repositorio de índice, que usa por defecto <literal>.rgw.buckets.index</literal>. Si coloca demasiados objetos (cientos de miles) en un único depósito y no se define la cuota del número máximo de objetos por depósito (<option>rgw bucket default quota max objects</option>), el rendimiento del repositorio de índice se puede degradar. La <emphasis>partición del índice de depósito</emphasis> evita esa disminución del rendimiento y permite un número elevado de objetos por depósito.
  </para>

  <sect2 xml:id="ogw-bucket-reshard">
   <title>Nueva partición del índice de depósito</title>
   <para>
    Si un depósito ha crecido mucho y su configuración inicial ya no es suficiente, es preciso volver a partir el repositorio de índice del depósito. Se puede usar la partición de índice de depósito en línea automática (consulte la <xref linkend="ogw-bucket-sharding-dyn"/>, o partir el índice de depósito manualmente sin conexión (consulte la <xref linkend="ogw-bucket-sharding-re"/>).
   </para>
   <sect3 xml:id="ogw-bucket-sharding-dyn">
    <title>Partición dinámica</title>
    <para>
     Desde SUSE Enterprise Storage 5, se admite la partición de depósito en línea. Esto detecta si el número de objetos por depósito alcanza un umbral determinado y aumenta automáticamente el número de particiones utilizado por el índice de depósito. Este proceso reduce el número de entradas de cada partición de índice de depósito.
    </para>
    <para>
     El proceso de detección se ejecuta en estos casos:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Cuando se añaden nuevos objetos al depósito.
      </para>
     </listitem>
     <listitem>
      <para>
       En un proceso en segundo plano que explora periódicamente todos los depósitos. Esto es necesario para tratar con los depósitos existentes que no se van a actualizar.
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Si un depósito requiere partición, se añade a la cola <option>reshard_log</option> y se programa para su partición más tarde. Los hilos de partición se ejecutan en segundo plano y ejecutan la partición programada de una en una.
    </para>
    <variablelist>
     <title>Configuración de la partición dinámica</title>
     <varlistentry>
      <term><option>rgw_dynamic_resharding</option></term>
      <listitem>
       <para>
        Habilita o inhabilita la partición del índice de depósito dinámica. Los valores válidos son &quot;true&quot; (verdadero) o &quot;false&quot; (falso). Por defecto es &quot;true&quot; (verdadero).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_num_logs</option></term>
      <listitem>
       <para>
        El número de particiones para el registro. Se usa el valor por defecto de 16.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_bucket_lock_duration</option></term>
      <listitem>
       <para>
        Duración del bloqueo en el objeto de depósito durante la partición. Se usa el valor por defecto de 120 segundos.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_max_objs_per_shard</option></term>
      <listitem>
       <para>
        El número máximo de objetos por partición de índice de depósito. Por defecto es 100 000 objetos.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_thread_interval</option></term>
      <listitem>
       <para>
        El tiempo máximo entre las rondas de procesamiento de hilos de partición. Se usa el valor por defecto de 600 segundos.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <variablelist>
     <title>Comandos para administrar el proceso de partición</title>
     <varlistentry>
      <term>Añadir un depósito a la cola de partición:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard add \
 --bucket <replaceable>BUCKET_NAME</replaceable> \
 --num-shards <replaceable>NEW_NUMBER_OF_SHARDS</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Mostrar la cola de partición:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard list
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Procesar o programar una partición de depósito:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard process
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Mostrar el estado de partición del depósito:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard status --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Cancelar las particiones de depósito pendientes:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard cancel --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ogw-bucket-sharding-re">
    <title>Partición manual</title>
    <para>
     La partición dinámica mencionada en la <xref linkend="ogw-bucket-sharding-dyn"/> solo se admite en configuraciones sencilla de Object Gateway. Para las configuraciones de varios sitios, utilice la partición manual que se describe en esta sección.
    </para>
    <para>
     Para particionar manualmente el índice de depósito sin conexión, utilice el comando siguiente:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket reshard
</screen>
    <para>
     El comando <command>bucket reshard</command> realiza las acciones siguientes:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Crea un nuevo conjunto de objetos de índice de depósito para el objeto especificado.
      </para>
     </listitem>
     <listitem>
      <para>
       Distribuye todas las entradas de estos objetos de índice.
      </para>
     </listitem>
     <listitem>
      <para>
       Crea una nueva instancia del depósito.
      </para>
     </listitem>
     <listitem>
      <para>
       Enlaza la nueva instancia del depósito con el depósito para que todas las operaciones de índice nuevas pasen por los nuevos índices de depósito.
      </para>
     </listitem>
     <listitem>
      <para>
       Imprime el ID de depósito antiguo y el nuevo en una salida estándar.
      </para>
     </listitem>
    </itemizedlist>
    <tip>
     <para>
      Cuando elija un número de particiones, tenga en cuenta lo siguiente: no debe haber más de 100.000 entradas por partición. Las particiones del índice de depósito que son números primos tienden a funcionar mejor para distribuir uniformemente las entradas de índice de depósito entre las particiones. Por ejemplo, tener 503 particiones de índice de depósito es mejor que tener 500, ya que 503 es un número primo.
     </para>
    </tip>
    <procedure>
     <title>partición del índice de depósito</title>
     <step>
      <para>
       Asegúrese de que se han detenido todas las operaciones dirigidas al depósito.
      </para>
     </step>
     <step>
      <para>
       Realice una copia de seguridad del índice de depósito original:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bi list \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 &gt; <replaceable>BUCKET_NAME</replaceable>.list.backup
</screen>
     </step>
     <step>
      <para>
       Vuelva a particionar el índice de depósito:
      </para>
<screen>
 <prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket reshard \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 --num-shards=<replaceable>NEW_SHARDS_NUMBER</replaceable>
</screen>
      <tip>
       <title>ID de depósito antiguo</title>
       <para>
        Como parte del resultado, este comando también imprime los ID nuevo y antiguo.
       </para>
      </tip>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-bucket-sharding-new">
   <title>Partición de índice de depósito para depósitos nuevos</title>
   <para>
    Existen dos opciones que afectan a la partición de índice de depósito:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Utilice la opción <option>rgw_override_bucket_index_max_shards</option> para las configuraciones sencillas.
     </para>
    </listitem>
    <listitem>
     <para>
      Utilice la opción <option>bucket_index_max_shards</option> para las configuraciones de varios sitios.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Si se define el valor <literal>0</literal> en las opciones, se inhabilita la partición de índice de depósito. Un valor mayor que <literal>0</literal> permite la partición de índice de depósito y establece el número máximo de particiones.
   </para>
   <para>
    La fórmula siguiente le permitirá calcular el número recomendado de particiones:
   </para>
<screen>
number_of_objects_expected_in_a_bucket / 100000
</screen>
   <para>
    Tenga en cuenta que el número máximo de particiones es de 7877.
   </para>
   <sect3 xml:id="multisite-config-bucket">
    <title>Configuraciones de varios sitios</title>
    <para>
     Las configuraciones de varios sitios pueden tener un repositorio de índice diferente para gestionar el failover. Para configurar un número de particiones coherente para las zonas de un grupo de zonas, defina la opción <option>bucket_index_max_shards</option> en la configuración del grupo de zonas:
    </para>
    <procedure>
     <step>
      <para>
       Exporte la configuración del grupo de zonas al archivo <filename>zonegroup.json</filename>:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup get &gt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Edite el archivo <filename>zonegroup.json</filename> y defina la opción <option>bucket_index_max_shards</option> para cada zona con nombre.
      </para>
     </step>
     <step>
      <para>
       Restablezca el grupo de zonas:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup set &lt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Actualice el período. Consulte la <xref linkend="ceph-rgw-fed-masterzone-updateperiod"/>.
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-keystone">
  <title>Integración con OpenStack Keystone</title>

  <para>
   OpenStack Keystone es un servicio de identidad para el producto OpenStack. Puede integrar Object Gateway con Keystone a fin de configurar una pasarela que acepte un testigo de autenticación de Keystone. Un usuario autorizado por Keystone para acceder a la pasarela se verificará en Ceph Object Gateway y, si fuera necesario, se creará automáticamente. Object Gateway pide periódicamente a Keystone una lista de los testigos revocados.
  </para>

  <sect2 xml:id="ogw-keystone-ostack">
   <title>Configuración de OpenStack</title>
   <para>
    Antes de configurar Ceph Object Gateway, debe configurar OpenStack Keystone para habilitar el servicio de Swift y dirigirlo a Ceph Object Gateway:
   </para>
   <procedure>
    <step>
     <para>
      <emphasis>Defina el servicio de Swift.</emphasis>Para utilizar OpenStack a fin de validar usuarios de Swift, cree primero el servicio de Swift:
     </para>
<screen>
<prompt>&gt; </prompt>openstack service create \
 --name=swift \
 --description="Swift Service" \
 object-store
</screen>
    </step>
    <step>
     <para>
      <emphasis>Defina los puestos finales.</emphasis>Después de crear el servicio de Swift, diríjalo a Ceph Object Gateway. Sustituya <replaceable>REGION_NAME</replaceable> por el nombre del grupo de zonas o el nombre de la región de la pasarela.
     </para>
<screen>
<prompt>&gt; </prompt>openstack endpoint create --region <replaceable>REGION_NAME</replaceable> \
 --publicurl   "http://radosgw.example.com:8080/swift/v1" \
 --adminurl    "http://radosgw.example.com:8080/swift/v1" \
 --internalurl "http://radosgw.example.com:8080/swift/v1" \
 swift
</screen>
    </step>
    <step>
     <para>
      <emphasis>Verifique los ajustes.</emphasis>Después de crear el servicio de Swift y definir los puestos finales, muestre los puestos finales para verificar que todos los valores son correctos.
     </para>
<screen>
<prompt>&gt; </prompt>openstack endpoint show object-store
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-keystone-ogw">
   <title>Configuración de Ceph Object Gateway</title>
   <sect3>
    <title>Configuración de certificados SSL</title>
    <para>
     Ceph Object Gateway pide periódicamente a Keystone una lista de los testigos revocados. Estas peticiones están codificadas y firmadas. Keystone también puede configurarse para que proporcione testigos autofirmados, que también están codificados y firmados. Debe configurar la pasarela para que pueda descodificar y verificar estos mensajes firmados. Por lo tanto, los certificados OpenSSL que Keystone utiliza para crear las peticiones deben convertirse al formato &quot;nss db&quot;:
    </para>
<screen>
<prompt role="root"># </prompt>mkdir /var/ceph/nss
<prompt role="root"># </prompt>openssl x509 -in /etc/keystone/ssl/certs/ca.pem \
 -pubkey | certutil -d /var/ceph/nss -A -n ca -t "TCu,Cu,Tuw"
<systemitem class="username">root</systemitem>openssl x509 -in /etc/keystone/ssl/certs/signing_cert.pem \
 -pubkey | certutil -A -d /var/ceph/nss -n signing_cert -t "P,P,P"
</screen>
    <para>
     Para permitir que Ceph Object Gateway interactúe con OpenStack Keystone, OpenStack Keystone puede utilizar un certificado SSL autofirmado. Instale el certificado SSL de Keystone en el nodo donde se ejecuta Ceph Object Gateway o, de forma alternativa, defina el valor de la opción <option>rgw keystone verify ssl</option> como &quot;false&quot; (falso). Si define <option>rgw keystone verify ssl</option> como &quot;false&quot;, la pasarela no intentará verificar el certificado.
    </para>
   </sect3>
   <sect3 xml:id="config-ogw-options">
    <title>Configuración de las opciones de Object Gateway</title>
    <para>
     Puede configurar la integración de Keystone utilizando las siguientes opciones:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone api version</option></term>
      <listitem>
       <para>
        Versión de la API de Keystone. Las opciones válidas son 2 o 3. Se usa el valor por defecto de 2.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone url</option></term>
      <listitem>
       <para>
        La URL y el número de puerto de la API RESTful administrativa en el servidor de Keystone. Sigue el patrón <replaceable>URL_SERVIDOR:NÚMERO_PUERTO</replaceable>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin token</option></term>
      <listitem>
       <para>
        El testigo o secreto compartido que se configura internamente en Keystone para las peticiones administrativas.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted roles</option></term>
      <listitem>
       <para>
        Las funciones necesarias para atender las peticiones. Por defecto es &quot;Member, admin&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted admin roles</option></term>
      <listitem>
       <para>
        La lista de funciones que permiten a un usuario obtener privilegios administrativos.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone token cache size</option></term>
      <listitem>
       <para>
        El número máximo de entradas en el caché de testigo de Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone revocation interval</option></term>
      <listitem>
       <para>
        El número de segundos antes de comprobar los testigos revocados. Por defecto es 15 * 60.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone implicit tenants</option></term>
      <listitem>
       <para>
        Crea nuevos usuarios en sus propios inquilinos del mismo nombre. Se usa el valor por defecto, &quot;false&quot; (falso).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw s3 auth use keystone</option></term>
      <listitem>
       <para>
        Si se establece como &quot;true&quot; (verdadero), Ceph Object Gateway autenticará a los usuarios mediante Keystone. Se usa el valor por defecto, &quot;false&quot; (falso).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>nss db path</option></term>
      <listitem>
       <para>
        La vía a la base de datos NSS.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     También es posible configurar el inquilino del servicio de Keystone, el usuario y la contraseña para Keystone (para la versión 2.0 de la API de identidades de OpenStack), de modo similar a cómo se suelen configurar los servicios de OpenStack. De este modo, puede evitar establecer el secreto compartido <option>rgw keystone admin token</option> en el archivo de configuración, que se debe inhabilitar en entornos de producción. Las credenciales del inquilino de servicio deben tener privilegios de administrador. Para obtener más información, consulte la <link xlink:href="https://docs.openstack.org/keystone/latest/#setting-up-projects-users-and-roles">documentación oficial de OpenStack Keystone</link>. A continuación se muestran las opciones de configuración relacionadas:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin user</option></term>
      <listitem>
       <para>
        El nombre de usuario del administrador de Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin password</option></term>
      <listitem>
       <para>
        La contraseña del usuario administrador de Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin tenant</option></term>
      <listitem>
       <para>
        El inquilino del usuario administrador de Keystone versión 2.0.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Se asigna un usuario de Ceph Object Gateway a un inquilino de Keystone. Un usuario de Keystone tiene diferentes funciones asignadas, posiblemente en más de un inquilino. Cuando Ceph Object Gateway obtiene el ticket, busca en las funciones de inquilino y usuario que se han asignado a dicho ticket y acepta o rechaza la petición de acuerdo con el valor de la opción <option>rgw keystone accepted roles</option>.
    </para>
    <tip>
     <title>asignación a inquilinos de OpenStack</title>
     <para>
      Aunque los inquilinos de Swift se asignan por defecto al usuario de Object Gateway, también pueden asignarse a inquilinos de OpenStack mediante la opción <option>rgw keystone implicit tenants</option>. Esto hará que los contenedores usen el espacio de nombres del inquilino en lugar del espacio de nombres global de S3, que es la opción por defecto de Object Gateway. Se recomienda decidir de antemano el método de asignación en la fase de planificación para evitar confusiones. La razón es que si se cambia la opción más tarde, solo se verán afectadas las peticiones nuevas que se asignen bajo un inquilino, mientras que los depósitos antiguos creados anteriormente seguirán en el espacio de nombres global.
     </para>
    </tip>
    <para>
     En la versión 3 de la API de identidades de OpenStack, deber sustituir la opción <option>rgw keystone admin tenant</option> por:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin domain</option></term>
      <listitem>
       <para>
        El dominio de usuario administrador de Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin project</option></term>
      <listitem>
       <para>
        El proyecto de usuario administrador de Keystone.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-storage-classes">
  <title>Colocación de repositorios y clases de almacenamiento</title>

  <sect2 xml:id="ogw-storage-classes-placement-targets">
   <title>Visualización de destinos de colocación</title>
   <para>
    Los destinos de colocación controlan qué repositorios están asociados con un depósito determinado. El destino de colocación de un depósito se selecciona durante la creación y no se puede modificar. Es posible mostrar su valor de <literal>placement_rule</literal> ejecutando el siguiente comando:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket stats
</screen>
   <para>
    La configuración del grupo de zonas contiene una lista de destinos de colocación con un destino inicial denominado &quot;default-placement&quot;. A continuación, la configuración de zona asigna cada nombre de destino de la colocación del grupo de zona a su almacenamiento local. Esta información de colocación de zona incluye el nombre &quot;index_pool&quot; para el índice del depósito, el nombre &quot;data_extra_pool&quot; para los metadatos sobre cargas de varias incompletas y un nombre de &quot;data_pool&quot; para cada clase de almacenamiento.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-itself">
   <title>Clases de almacenamiento</title>
   <para>
    Las clases de almacenamiento ayudan a personalizar la colocación de los datos de objeto. Las reglas del ciclo de vida del depósito S3 pueden automatizar la transición de objetos entre clases de almacenamiento.
   </para>
   <para>
    Las clases de almacenamiento se definen en términos de destinos de colocación. Cada destino de colocación de grupo de zonas muestra sus clases de almacenamiento disponibles con una clase inicial denominada &quot;STANDARD&quot;. La configuración de zona es responsable de proporcionar un nombre de repositorio &quot;data_pool&quot; para cada una de las clases de almacenamiento del grupo de zonas.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-zone-config">
   <title>Configuración de grupos de zonas y zonas</title>
   <para>
    Utilice el comando <command>radosgw-admin</command> en los grupos de zona y las zonas para configurar su colocación. Puede consultar la configuración de la colocación del grupo de zonas con el comando siguiente:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup get
{
    "id": "ab01123f-e0df-4f29-9d71-b44888d67cd5",
    "name": "default",
    "api_name": "default",
    ...
    "placement_targets": [
        {
            "name": "default-placement",
            "tags": [],
            "storage_classes": [
                "STANDARD"
            ]
        }
    ],
    "default_placement": "default-placement",
    ...
}
</screen>
   <para>
    Para consultar la configuración de colocación de la zona, ejecute:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone get
{
    "id": "557cdcee-3aae-4e9e-85c7-2f86f5eddb1f",
    "name": "default",
    "domain_root": "default.rgw.meta:root",
    ...
    "placement_pools": [
        {
            "key": "default-placement",
            "val": {
                "index_pool": "default.rgw.buckets.index",
                "storage_classes": {
                    "STANDARD": {
                        "data_pool": "default.rgw.buckets.data"
                    }
                },
                "data_extra_pool": "default.rgw.buckets.non-ec",
                "index_type": 0
            }
        }
    ],
    ...
}
</screen>
   <note>
    <title>sin configuración de varios sitios anterior</title>
    <para>
     Si no ha realizado ninguna configuración de varios sitios anterior, se crean automáticamente una zona por defecto (&quot;default&quot;) y un grupo de zonas. Los cambios en el grupo de zonas o las zonas no tendrán efecto hasta que reinicie Ceph Object Gateway. Si ha creado un reino para varios sitios, los cambios de la zona o el grupo de zonas surtirán efecto después de confirmar los cambios con el comando <command>radosgw-admin period update ‑‑commit</command>.
    </para>
   </note>
   <sect3 xml:id="adding-placement-target">
    <title>Adición de un destino de colocación</title>
    <para>
     Para crear un nuevo destino de colocación denominado &quot;temporary&quot;, comience añadiéndolo al grupo de zonas:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id temporary
</screen>
    <para>
     A continuación, proporcione la información de colocación de zona para ese destino:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id temporary \
      --data-pool default.rgw.temporary.data \
      --index-pool default.rgw.temporary.index \
      --data-extra-pool default.rgw.temporary.non-ec
</screen>
   </sect3>
   <sect3 xml:id="adding-storage-class">
    <title>Adición de una clase de almacenamiento</title>
    <para>
     Para añadir una nueva clase de almacenamiento denominada &quot;COLD&quot; al destino &quot;default-placement&quot;, empiece añadiéndola al grupo de zonas:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id default-placement \
      --storage-class COLD
</screen>
    <para>
     A continuación, proporcione la información de colocación de zona para esa clase de almacenamiento:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id default-placement \
      --storage-class COLD \
      --data-pool default.rgw.cold.data \
      --compression lz4
</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-customizing-placement">
   <title>Personalización de colocación</title>
   <sect3 xml:id="edit-default-zgroup-placement">
    <title>Edición de la colocación del grupo de zonas por defecto</title>
    <para>
     Por defecto, los nuevos depósitos utilizan el destino <literal>default_placement</literal> del grupo de zonas. Puede cambiar este valor del grupo de zonas con:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement default \
      --rgw-zonegroup default \
      --placement-id new-placement
</screen>
   </sect3>
   <sect3 xml:id="edit-default-user-placement">
    <title>Edición de la colocación del usuario por defecto</title>
    <para>
     Un usuario de Ceph Object Gateway puede sustituir el destino de la colocación por defecto del grupo de zonas definiendo un campo <literal>default_placement</literal> no vacío en la información del usuario. De forma similar, el valor de <literal>default_storage_class</literal> puede sustituir la clase de almacenamiento <option>STANDARD</option> aplicada a los objetos por defecto.
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid testid
{
    ...
    "default_placement": "",
    "default_storage_class": "",
    "placement_tags": [],
    ...
}
</screen>
    <para>
     Si el destino de colocación de un grupo de zonas contiene etiquetas, los usuarios no podrán crear depósitos con ese destino de colocación a menos que su información de usuario contenga al menos una etiqueta que coincida en su campo &quot;placement_tags&quot;. Esto puede ser útil para restringir el acceso a ciertos tipos de almacenamiento.
    </para>
    <para>
     El comando <command>radosgw-admin</command> no puede modificar estos campos directamente; por lo tanto, debe editar el formato JSON manualmente:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin metadata get user:<replaceable>USER-ID</replaceable> &gt; user.json
<prompt>&gt; </prompt>vi user.json     # edit the file as required
<prompt>cephuser@adm &gt; </prompt>radosgw-admin metadata put user:<replaceable>USER-ID</replaceable> &lt; user.json
</screen>
   </sect3>
   <sect3 xml:id="s3-bucket-default-placement">
    <title>Edición de la colocación del depósito por S3 por defecto</title>
    <para>
     Al crear un depósito con el protocolo S3, es posible proporcionar un destino de colocación como parte de <option>LocationConstraint</option> para sustituir los destinos de colocación por defecto del usuario y del grupo de zonas.
    </para>
    <para>
     Normalmente, <option>LocationConstraint</option> debe coincidir con el valor de <option>api_name</option> del grupo de zonas:
    </para>
<screen>&lt;LocationConstraint&gt;default&lt;/LocationConstraint&gt;</screen>
    <para>
     Puede añadir un destino de colocación personalizado a <option>api_name</option> detrás de un signo de dos puntos:
    </para>
<screen>&lt;LocationConstraint&gt;default:new-placement&lt;/LocationConstraint&gt;</screen>
   </sect3>
   <sect3 xml:id="swift-default-bucket-placement">
    <title>Edición de la colocación del depósito por Swift</title>
    <para>
     Cuando se crea un depósito con el protocolo Swift, es posible proporcionar un destino de colocación en el parámetro <literal>X-Storage-Policy</literal> del encabezado HTTP:
    </para>
<screen>X-Storage-Policy: <replaceable>NEW-PLACEMENT</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-usage">
   <title>Uso de clases de almacenamiento</title>
   <para>
    Todos los destinos de colocación tienen una clase de almacenamiento <option>STANDARD</option> que se aplica por defecto a los nuevos objetos. Puede sustituir este valor por defecto con su valor de <literal>default_storage_class</literal>.
   </para>
   <para>
    Para crear un objeto en una clase de almacenamiento que no sea la clase por defecto, proporcione ese nombre de clase de almacenamiento en un encabezado HTTP con la petición. El protocolo S3 utiliza el encabezado <literal>X-Amz-Storage-Class</literal>, mientras que el protocolo Swift utiliza el encabezado <literal>X-Object-Storage-Class</literal>.
   </para>
   <para>
    Puede utilizar la <emphasis>gestión del ciclo de vida del objeto S3</emphasis> para mover datos de objetos entre clases de almacenamiento mediante acciones <option>de transición</option>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-fed">
  <title>Pasarelas Object Gateway de varios sitios</title>

  <para>
   Ceph admite varias opciones de configuración de varios sitios para Ceph Object Gateway:
  </para>

  <variablelist>
   <varlistentry>
    <term>Multizona</term>
    <listitem>
     <para>
      Una configuración que consta de un grupo de zonas y varias zonas, y cada zona tiene una o más instancias de <systemitem class="daemon">ceph-radosgw</systemitem>. Cada zona tiene el respaldo de su propio clúster de almacenamiento de Ceph. Varias zonas de un grupo de zonas proporcionan recuperación tras fallos para el grupo de zonas en caso de que una de las zonas experimente un fallo importante. Todas las zonas están activas y pueden recibir operaciones de escritura. Además de la recuperación tras fallos, varias zonas activas también pueden servir como base para las redes de distribución de contenido.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Grupo multizona</term>
    <listitem>
     <para>
      Ceph Object Gateway admite varios grupos de zonas, cada grupo de zonas con una o más zonas. Los objetos almacenados en zonas de un grupo de zonas dentro del mismo dominio que otro grupo de zonas comparten un espacio de nombres de objeto global, lo que garantiza que haya ID de objeto exclusivos en los grupos de zonas y las zonas.
     </para>
     <note>
      <para>
       Es importante tener en cuenta que los grupos de zonas <emphasis>solo</emphasis> sincronizan metadatos entre sí. Los datos y los metadatos se replican entre las zonas del grupo de zonas. No se comparten datos ni metadatos en un dominio.
      </para>
     </note>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Varios dominios</term>
    <listitem>
     <para>
      Ceph Object Gateway admite la noción de dominios; un espacio de nombres exclusivo global. Se admiten varios dominios que pueden abarcar uno o varios grupos de zonas.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Puede configurar cada instancia de Object Gateway para que funcione con una configuración de zona activa-activa, lo que permite la escritura en zonas no principales. La configuración de varios sitios se almacena en un contenedor denominado &quot;dominio&quot;. El dominio almacena grupos de zonas, zonas y un período de tiempo con varias épocas para realizar un seguimiento de los cambios en la configuración. Los daemons <systemitem class="daemon">rgw</systemitem> gestionan la sincronización, eliminando la necesidad de un agente de sincronización independiente. Este enfoque de la sincronización permite que Ceph Object Gateway funcione con una configuración activa-activa, en lugar de con una activa-pasiva.
  </para>

  <sect2 xml:id="ceph-rgw-multi-req-assump">
   <title>Requisitos y supuestos</title>
   <para>
    Una configuración de varios sitios requiere al menos dos clústeres de almacenamiento de Ceph y al menos dos instancias de Ceph Object Gateway, una para cada clúster de almacenamiento de Ceph. En la siguiente configuración se presupone que hay al menos dos clústeres de almacenamiento de Ceph en ubicaciones separadas geográficamente. Sin embargo, la configuración puede funcionar en el mismo sitio. Por ejemplo, se pueden llamar <literal>rgw1</literal> y <literal>rgw2</literal>.
   </para>
   <para>
    Una configuración de varios sitios requiere un grupo de zonas principal y una zona principal. Una zona principal es la fuente de información con respecto a todas las operaciones de metadatos de un clúster de varios sitios. Además, cada grupo de zonas requiere una zona principal. Los grupos de zonas pueden tener una o más zonas secundarias o no principales. En esta guía, el host <literal>rgw1</literal> actúa como zona principal del grupo de zonas principal y el host <literal>rgw2</literal> actúa como zona secundaria del grupo de zonas principal.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-config-master-zone">
   <title>Configuración de una zona principal</title>
   <para>
    Todas las pasarelas de una configuración de varios sitios recuperan su configuración de un daemon <systemitem class="daemon">ceph-radosgw</systemitem> situado en un host dentro del grupo de zonas principal y la zona principal. Para configurar las pasarelas en una configuración de varios sitios, seleccione una instancia de <systemitem class="daemon">ceph-radosgw</systemitem> para configurar el grupo de zonas principal y la zona principal.
   </para>
   <sect3 xml:id="ceph-rgw-fed-realm">
    <title>Creación de un dominio</title>
    <para>
     Un dominio representa un espacio de nombres único global que consta de uno o más grupos de zonas, que a su vez contienen una o más zonas. Las zonas contienen depósitos, que a su vez contienen objetos. Un dominio permite que Ceph Object Gateway admita varios espacios de nombres y su configuración en el mismo hardware. Un dominio contiene la noción de períodos. Cada período representa el estado del grupo de zonas y la configuración de la zona en el tiempo. Cada vez que realice un cambio en un grupo de zonas o en una zona, debe actualizar el período y asignarlo. Por defecto, Ceph Object Gateway no crea un dominio para la compatibilidad con versiones anteriores. Como práctica recomendada, se recomienda crear dominios para los clústeres nuevos.
    </para>
    <para>
     Cree un nuevo dominio denominado <literal>gold</literal> para la configuración de varios sitios abriendo una interfaz de línea de comandos en un host identificado para servir en el grupo de zonas principal y la zona. A continuación, ejecute lo siguiente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm create --rgw-realm=gold --default</screen>
    <para>
     Si el clúster tiene un solo dominio, especifique el indicador <option>--default</option>. Si se especifica <option>‑‑default</option>, <command>radosgw-admin</command> utiliza este dominio por defecto. Si no se especifica <option>--default</option>, para añadir grupos de zonas y zonas es necesario especificar el indicador <option>--rgw-realm</option> o el indicador <option>--realm-id</option> para identificar el dominio al añadir grupos de zonas y zonas.
    </para>
    <para>
     Después de crear el dominio, <command>radosgw-admin</command> devuelve la configuración del dominio:
    </para>
<screen>
{
  "id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "name": "gold",
  "current_period": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "epoch": 1
}</screen>
    <note>
     <para>
      Ceph genera un ID exclusivo para el dominio, que permite renombrar el dominio si es necesario.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-createmasterzonegrp">
    <title>Creación de un grupo de zonas principal</title>
    <para>
     Un dominio debe tener al menos un grupo de zonas para servir como grupo de zonas principal para el dominio. Cree un nuevo grupo de zonas principal para la configuración de varios sitios abriendo una interfaz de línea de comandos en un host identificado para servir en el grupo de zonas principal y la zona. Cree un grupo de zonas principal llamado <literal>us</literal> ejecutando lo siguiente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup create --rgw-zonegroup=us \
--endpoints=http://rgw1:80 --master --default</screen>
    <para>
     Si el dominio solo tiene un grupo de zonas, especifique el indicador <option>--default</option>. Si se especifica <option>--default</option>, <command>radosgw-admin</command> utiliza este grupo de zonas por defecto al añadir nuevas zonas. Si no se especifica <option>--default</option>, para añadir zonas se necesitará el indicador <option>--rgw-zonegroup</option> o el indicador <option>--zonegroup-id</option> para identificar el grupo de zonas al añadir o modificar zonas.
    </para>
    <para>
     Después de crear el grupo de zonas principal, <command>radosgw-admin</command> devuelve la configuración del grupo de zonas. Por ejemplo:
    </para>
<screen>{
 "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
 "name": "us",
 "api_name": "us",
 "is_master": "true",
 "endpoints": [
     "http:\/\/rgw1:80"
 ],
 "hostnames": [],
 "hostnames_s3website": [],
 "master_zone": "",
 "zones": [],
 "placement_targets": [],
 "default_placement": "",
 "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
}</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone">
    <title>Creación de una zona principal</title>
    <important>
     <para>
      Las zonas deben crearse en un nodo de Ceph Object Gateway que se encuentre dentro de la zona.
     </para>
    </important>
    <para>
     Cree una nueva zona principal para la configuración de varios sitios abriendo una interfaz de línea de comandos en un host identificado para servir en el grupo de zonas principal y la zona. Realice lo siguiente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --rgw-zone=us-east-1 \
--endpoints=http://rgw1:80 --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>SYSTEM_SECRET_KEY</replaceable></screen>
    <note>
     <para>
      Las opciones <option>--access-key</option> y <option>--secret</option> no se especifican en el ejemplo anterior. Estos ajustes se añaden a la zona cuando se crea el usuario en la siguiente sección.
     </para>
    </note>
    <para>
     Después de crear la zona principal, <command>radosgw-admin</command> devuelve la configuración de la zona. Por ejemplo:
    </para>
<screen>
  {
      "id": "56dfabbb-2f4e-4223-925e-de3c72de3866",
      "name": "us-east-1",
      "domain_root": "us-east-1.rgw.meta:root",
      "control_pool": "us-east-1.rgw.control",
      "gc_pool": "us-east-1.rgw.log:gc",
      "lc_pool": "us-east-1.rgw.log:lc",
      "log_pool": "us-east-1.rgw.log",
      "intent_log_pool": "us-east-1.rgw.log:intent",
      "usage_log_pool": "us-east-1.rgw.log:usage",
      "reshard_pool": "us-east-1.rgw.log:reshard",
      "user_keys_pool": "us-east-1.rgw.meta:users.keys",
      "user_email_pool": "us-east-1.rgw.meta:users.email",
      "user_swift_pool": "us-east-1.rgw.meta:users.swift",
      "user_uid_pool": "us-east-1.rgw.meta:users.uid",
      "otp_pool": "us-east-1.rgw.otp",
      "system_key": {
          "access_key": "1555b35654ad1656d804",
          "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
      },
      "placement_pools": [
          {
              "key": "us-east-1-placement",
              "val": {
                  "index_pool": "us-east-1.rgw.buckets.index",
                  "storage_classes": {
                      "STANDARD": {
                          "data_pool": "us-east-1.rgw.buckets.data"
                      }
                  },
                  "data_extra_pool": "us-east-1.rgw.buckets.non-ec",
                  "index_type": 0
              }
          }
      ],
      "metadata_heap": "",
      "realm_id": ""
  }</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-deldefzonegrp">
    <title>Supresión de la zona y el grupo de zonas por defecto</title>
    <important>
     <para>
      En los siguientes pasos se presupone que hay una configuración de varios sitios que utiliza sistemas recién instalados en los que aún no se almacenan datos. <emphasis role="bold">No suprima</emphasis> la zona por defecto ni sus repositorios si ya la está utilizando para almacenar datos, o los datos se suprimirán y no se podrán recuperar.
     </para>
    </important>
    <para>
     La instalación por defecto de Object Gateway crea el grupo de zonas por defecto denominado <literal>default</literal>. Suprima la zona por defecto si existe. Asegúrese de eliminarla primero del grupo de zonas por defecto.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup delete --rgw-zonegroup=default</screen>
    <para>
     Suprima los repositorios por defecto del clúster de almacenamiento de Ceph, si existen:
    </para>
    <important>
     <para>
      En el siguiente paso se presupone que hay una configuración de varios sitios que utiliza sistemas recién instalados en los que no se almacenan datos. <emphasis role="bold">No suprima</emphasis> el grupo de zonas por defecto si ya lo está utilizando para almacenar datos.
     </para>
    </important>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.meta default.rgw.meta --yes-i-really-really-mean-it</screen>
    <warning>
     <para>
      Si suprime el grupo de zonas por defecto, también está suprimiendo el usuario del sistema. Si las claves del usuario administrador no se propagan, la funcionalidad de gestión de Object Gateway de Ceph Dashboard fallará. Continúe en la siguiente sección para volver a crear el usuario del sistema si continúa con este paso.
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-createuser">
    <title>Creación de usuarios del sistema</title>
    <para>
     Los daemons <systemitem class="daemon">ceph-radosgw</systemitem> deben autenticarse antes de extraer información del dominio y el período. En la zona principal, cree un usuario del sistema para simplificar la autenticación entre los daemons:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=zone.user \
--display-name="Zone User" --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> \
--secret=<replaceable>SYSTEM_SECRET_KEY</replaceable> --system</screen>
    <para>
     Anote la <option>clave de acceso</option> y la <option>clave secreta</option>, ya que las zonas secundarias deben autenticarse con la zona principal.
    </para>
    <para>
     Añada el usuario del sistema a la zona principal:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=us-east-1 \
--access-key=<replaceable>ACCESS-KEY</replaceable> --secret=<replaceable>SECRET</replaceable></screen>
    <para>
     Actualice el período para que los cambios surtan efecto:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-updateperiod">
    <title>Actualice el período</title>
    <para>
     Después de actualizar la configuración de la zona principal, actualice el período:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    <para>
     Después de actualizar el período, <command>radosgw-admin</command> devuelve la configuración del período. Por ejemplo:
    </para>
<screen>{
  "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "epoch": 1, "predecessor_uuid": "", "sync_status": [], "period_map":
  {
    "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "zonegroups": [], "short_zone_ids": []
  }, "master_zonegroup": "", "master_zone": "", "period_config":
  {
     "bucket_quota": {
     "enabled": false, "max_size_kb": -1, "max_objects": -1
     }, "user_quota": {
       "enabled": false, "max_size_kb": -1, "max_objects": -1
     }
  }, "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7", "realm_name": "gold", "realm_epoch": 1
}</screen>
    <note>
     <para>
      La actualización del período cambia la época y garantiza que otras zonas reciban la configuración actualizada.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-startrgw">
    <title>Inicio de Gateway</title>
    <para>
     En el host de Object Gateway, inicie y habilite el servicio Ceph Object Gateway. Para identificar el FSID exclusivo del clúster, ejecute <command>ceph fsid</command>. Para identificar el nombre del daemon de Object Gateway, ejecute <command>ceph orch ps --hostname <replaceable>NOMBREHOST</replaceable></command>.
    </para>
<screen><prompt>cephuser@ogw &gt; </prompt>systemctl start ceph-<replaceable>FSID</replaceable>@<replaceable>DAEMON_NAME</replaceable>
<prompt>cephuser@ogw &gt; </prompt>systemctl enable ceph-<replaceable>FSID</replaceable>@<replaceable>DAEMON_NAME</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-config-secondaryzone">
   <title>Configuración de zonas secundarias</title>
   <para>
    Las zonas de un grupo de zonas replican todos los datos para asegurarse de que cada zona tiene los mismos datos. Cuando cree la zona secundaria, ejecute todas las operaciones siguientes en un host identificado para servir a la zona secundaria.
   </para>
   <note>
    <para>
     Para añadir una tercera zona, siga los mismos procedimientos que para añadir la zona secundaria. Utilice un nombre de zona diferente.
    </para>
   </note>
   <important>
    <para>
     Debe realizar las operaciones de metadatos, como crear usuarios, en un host de la zona principal. La zona principal y la zona secundaria pueden recibir operaciones de depósito, pero la zona secundaria redirige las operaciones de depósito a la zona principal. Si la zona principal está inactiva, las operaciones de depósito fallarán.
    </para>
   </important>
   <sect3 xml:id="ceph-rgw-pull-realm">
    <title>Extracción del dominio</title>
    <para>
     Mediante la vía URL, la clave de acceso y el secreto de la zona principal del grupo de zonas principal, extraiga la configuración del dominio en el host. Para extraer un dominio que no sea el dominio por defecto, especifique el dominio mediante las opciones de configuración <option>--rgw-realm</option> o <option>--realm-id</option>.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm pull --url=<replaceable>url-to-master-zone-gateway</replaceable> --access-key=<replaceable>access-key</replaceable> --secret=<replaceable>secret</replaceable></screen>
    <note>
     <para>
      Al importar el dominio, también se recupera la configuración del período actual del host remoto, que se convierte también en el período actual en este host.
     </para>
    </note>
    <para>
     Si este dominio es el dominio por defecto, o el único dominio, conviértalo en el dominio por defecto.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm default --rgw-realm=<replaceable>REALM-NAME</replaceable></screen>
   </sect3>
   <sect3 xml:id="cceph-rgw-create-secondaryzone">
    <title>Creación de una zona secundaria</title>
    <para>
     Cree una zona secundaria para la configuración de varios sitios abriendo una interfaz de línea de comandos en un host identificado para servir a la zona secundaria. Especifique el ID del grupo de zonas, el nombre de la nueva zona y un puesto final para la zona. <emphasis>No utilice</emphasis> el indicador <option>‑‑master</option>. Todas las zonas se ejecutan con una configuración activa-activa por defecto. Si la zona secundaria no debe aceptar operaciones de escritura, especifique el indicador <option>--read-only</option> para crear una configuración activa-pasiva entre la zona principal y la zona secundaria. Además, proporcione la <option>clave de acceso</option> y la <option>clave secreta</option> del usuario del sistema generado almacenado en la zona principal del grupo de zonas principal. Realice lo siguiente:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable>\
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> --endpoints=<replaceable>URL</replaceable> \
 --access-key=<replaceable>SYSTEM-KEY</replaceable> --secret=<replaceable>SECRET</replaceable>\
 --endpoints=http://<replaceable>FQDN</replaceable>:80 \
 [--read-only]
</screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --endpoints=http://rgw2:80 \
--rgw-zone=us-east-2 --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>SYSTEM_SECRET_KEY</replaceable>
{
  "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
  "name": "us-east-2",
  "domain_root": "us-east-2.rgw.data.root",
  "control_pool": "us-east-2.rgw.control",
  "gc_pool": "us-east-2.rgw.gc",
  "log_pool": "us-east-2.rgw.log",
  "intent_log_pool": "us-east-2.rgw.intent-log",
  "usage_log_pool": "us-east-2.rgw.usage",
  "user_keys_pool": "us-east-2.rgw.users.keys",
  "user_email_pool": "us-east-2.rgw.users.email",
  "user_swift_pool": "us-east-2.rgw.users.swift",
  "user_uid_pool": "us-east-2.rgw.users.uid",
  "system_key": {
      "access_key": "1555b35654ad1656d804",
      "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
  },
  "placement_pools": [
      {
          "key": "default-placement",
          "val": {
              "index_pool": "us-east-2.rgw.buckets.index",
              "data_pool": "us-east-2.rgw.buckets.data",
              "data_extra_pool": "us-east-2.rgw.buckets.non-ec",
              "index_type": 0
          }
      }
  ],
  "metadata_heap": "us-east-2.rgw.meta",
  "realm_id": "815d74c2-80d6-4e63-8cfc-232037f7ff5c"
}</screen>
    <important>
     <para>
      En los pasos siguientes se presupone que hay una configuración de varios sitios en la que se usan sistemas recién instalados en los que aún no se almacenan datos. <emphasis role="bold">No suprima</emphasis> la zona por defecto ni sus repositorios si ya la está utilizando para almacenar datos, o los datos se perderán y no se podrán recuperar.
     </para>
    </important>
    <para>
     Suprima la zona por defecto si es necesario:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone delete --rgw-zone=default</screen>
    <para>
     Suprima los repositorios por defecto del clúster de almacenamiento de Ceph si es necesario:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.users.uid default.rgw.users.uid --yes-i-really-really-mean-it</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-secondzone-update-config">
    <title>Actualización del archivo de configuración de Ceph</title>
    <para>
     Actualice el archivo de configuración de Ceph en los hosts de la zona secundaria añadiendo la opción de configuración <literal>rgw_zone</literal> y el nombre de la zona secundaria a la entrada de la instancia.
    </para>
    <para>
     Para ello, ejecute el comando siguiente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set <replaceable>SERVICE_NAME</replaceable> rgw_zone us-west</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-secondzone-updateperiod">
    <title>Actualización del período</title>
    <para>
     Después de actualizar la configuración de la zona principal, actualice el período:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit
{
  "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
  "epoch": 2,
  "predecessor_uuid": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "sync_status": [ "[...]"
  ],
  "period_map": {
      "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
      "zonegroups": [
          {
              "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
              "name": "us",
              "api_name": "us",
              "is_master": "true",
              "endpoints": [
                  "http:\/\/rgw1:80"
              ],
              "hostnames": [],
              "hostnames_s3website": [],
              "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "zones": [
                  {
                      "id": "83859a9a-9901-4f00-aa6d-285c777e10f0",
                      "name": "us-east-1",
                      "endpoints": [
                          "http:\/\/rgw1:80"
                      ],
                      "log_meta": "true",
                      "log_data": "false",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  },
                  {
                      "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
                      "name": "us-east-2",
                      "endpoints": [
                          "http:\/\/rgw2:80"
                      ],
                      "log_meta": "false",
                      "log_data": "true",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  }

              ],
              "placement_targets": [
                  {
                      "name": "default-placement",
                      "tags": []
                  }
              ],
              "default_placement": "default-placement",
              "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
          }
      ],
      "short_zone_ids": [
          {
              "key": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "val": 630926044
          },
          {
              "key": "950c1a43-6836-41a2-a161-64777e07e8b8",
              "val": 4276257543
          }

      ]
  },
  "master_zonegroup": "d4018b8d-8c0d-4072-8919-608726fa369e",
  "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
  "period_config": {
      "bucket_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      },
      "user_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      }
  },
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "realm_name": "gold",
  "realm_epoch": 2
}</screen>
    <note>
     <para>
      La actualización del período cambia la época y garantiza que otras zonas reciban la configuración actualizada.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-secondzone-startrgw">
    <title>Inicio de Object Gateway</title>
    <para>
     En el host de Object Gateway, inicie y habilite el servicio Ceph Object Gateway:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch start rgw.us-east-2
</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-check-sync-status">
    <title>Comprobación del estado de sincronización</title>
    <para>
     Cuando la zona secundaria esté activa y en ejecución, compruebe el estado de sincronización. La sincronización copia los usuarios y depósitos creados en la zona principal en la zona secundaria.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin sync status</screen>
    <para>
     La salida proporciona el estado de las operaciones de sincronización. Por ejemplo:
    </para>
<screen>realm f3239bc5-e1a8-4206-a81d-e1576480804d (gold)
    zonegroup c50dbb7e-d9ce-47cc-a8bb-97d9b399d388 (us)
         zone 4c453b70-4a16-4ce8-8185-1893b05d346e (us-west)
metadata sync syncing
              full sync: 0/64 shards
              metadata is caught up with master
              incremental sync: 64/64 shards
    data sync source: 1ee9da3e-114d-4ae3-a8a4-056e8a17f532 (us-east)
                      syncing
                      full sync: 0/128 shards
                      incremental sync: 128/128 shards
                      data is caught up with source</screen>
    <note>
     <para>
      Las zonas secundarias aceptan operaciones de depósito; sin embargo, las zonas secundarias redirigen las operaciones de depósito a la zona principal y, a continuación, se sincronizan con la zona principal para recibir el resultado de las operaciones de depósito. Si la zona principal está inactiva, las operaciones de depósito que se ejecuten en la zona secundaria fallarán, pero las operaciones de objeto deberían realizarse correctamente.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-object-verification">
    <title>Verificación de un objeto</title>
    <para>
     Por defecto, los objetos no se vuelven a verificar después de que la sincronización de un objeto se haya realizado correctamente. Para habilitar la verificación, defina la opción <option>rgw_sync_obj_etag_verify</option> en <option>true</option>. Cuando estén habilitados, los objetos opcionales se sincronizarán. Una suma de comprobación MD5 adicional verificará que se calcula en el origen y en el destino. Esto garantiza la integridad de los objetos obtenidos de un servidor remoto a través de HTTP, incluida la sincronización de varios sitios. Esta opción puede reducir el rendimiento de los RGW, ya que se necesita más capacidad de cálculo.
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-maintenance">
   <title>Mantenimiento general de Object Gateway</title>
   <sect3 xml:id="ceph-rgw-check-sync">
    <title>Comprobación del estado de sincronización</title>
    <para>
     La información sobre el estado de réplica de una zona se puede consultar con:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin sync status
        realm b3bc1c37-9c44-4b89-a03b-04c269bea5da (gold)
    zonegroup f54f9b22-b4b6-4a0e-9211-fa6ac1693f49 (us)
         zone adce11c9-b8ed-4a90-8bc5-3fc029ff0816 (us-west)
        metadata sync syncing
              full sync: 0/64 shards
              incremental sync: 64/64 shards
              metadata is behind on 1 shards
              oldest incremental change not applied: 2017-03-22 10:20:00.0.881361s
data sync source: 341c2d81-4574-4d08-ab0f-5a2a7b168028 (us-east)
                  syncing
                  full sync: 0/128 shards
                  incremental sync: 128/128 shards
                  data is caught up with source
          source: 3b5d1a3f-3f27-4e4a-8f34-6072d4bb1275 (us-3)
                  syncing
                  full sync: 0/128 shards
                  incremental sync: 128/128 shards
                  data is caught up with source</screen>
    <para>
     El resultado puede variar según el estado de sincronización. Durante la sincronización, se describen dos tipos distintos de fragmentos:
    </para>
    <variablelist>
     <varlistentry>
      <term>Fragmentos desactualizados</term>
      <listitem>
       <para>
        Los fragmentos desactualizados son los que necesitan una sincronización de datos completa y los que necesitan una sincronización de datos incremental, ya que no están actualizados.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Fragmentos de recuperación</term>
      <listitem>
       <para>
        Los fragmentos de recuperación son fragmentos que han encontrado un error durante la sincronización y se han marcado para que se vuelva a intentar el proceso. Los errores suelen ser menores, como la aparición de un bloqueo en un depósito. Normalmente, se resolverán por sí mismos.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph-rgw-multisite-logs">
    <title>Compruebe los registros</title>
    <para>
     Solo en la funcionalidad de varios sitios, puede consultar el registro de metadatos (<option>mdlog</option>), el registro de índice de papelera (<option>bilog</option>) y el registro de datos (<option>datalog</option>). Es posible mostrarlos y recortarlos. No es necesario hacerlo en la mayoría de los casos, ya que la opción <option>rgw_sync_log_trim_interval</option> está definida en 20 minutos por defecto. Si no se establece manualmente en 0, no será necesario recortarlos en ningún momento, ya que de lo contrario podría provocar efectos secundarios.
    </para>
   </sect3>
   <sect3 xml:id="ceph-rgw-metadata-master">
    <title>Cambio de la zona principal de metadatos</title>
    <important>
     <para>
      Tenga cuidado cuando cambie qué zona es la principal para los metadatos. Si una zona no ha terminado de sincronizar los metadatos de la zona principal actual, no puede servir las entradas restantes cuando se asciende a principal, y esos cambios se pierden. Por este motivo, se recomienda esperar a que el estado de sincronización <command>radosgw-admin</command> de una zona se ponga al día con la sincronización de los metadatos antes de subirla de nivel a zona principal. Del mismo modo, si la zona principal actual está procesando cambios en los metadatos mientras otra zona se está subiendo a principal, es probable que se pierdan dichos cambios. Para evitarlo, se recomienda cerrar todas las instancias de Object en la zona principal anterior. Después de subir de nivel otra zona, su nuevo período se puede recuperar con la el comando de extracción de período <command>radosgw-admin</command> y se las pasarelas se pueden reiniciar.
     </para>
    </important>
    <para>
     Para subir de nivel una zona (por ejemplo, la zona <literal>us-west</literal> del grupo de zonas <literal>us</literal>) a zona principal de metadatos, ejecute los comandos siguientes en esa zona:
    </para>
<screen><prompt>cephuser@ogw &gt; </prompt>radosgw-admin zone modify --rgw-zone=us-west --master
<prompt>cephuser@ogw &gt; </prompt>radosgw-admin zonegroup modify --rgw-zonegroup=us --master
<prompt>cephuser@ogw &gt; </prompt>radosgw-admin period update --commit</screen>
    <para>
     Esto genera un nuevo período y las instancias de Object Gateway de la zona <literal>us-west</literal> envían este período a otras zonas.
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-failover-dr">
   <title>Realización de failover y recuperación tras fallos</title>
   <para>
    Si la zona principal fallara, realice un failover a la zona secundaria para recuperarse tras los fallos.
   </para>
   <procedure>
    <step>
     <para>
      Convierta la zona secundaria en la zona principal y por defecto. Por ejemplo:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default</screen>
     <para>
      Por defecto, Ceph Object Gateway ejecuta una configuración activa-activa. Si el clúster se ha configurado para ejecutarse en una configuración activa-pasiva, la zona secundaria será una zona de solo lectura. Elimine el estado <option>--read-only</option> para permitir que la zona reciba operaciones de escritura. Por ejemplo:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default \
                                                   --read-only=false
</screen>
    </step>
    <step>
     <para>
      Actualice el período para que los cambios surtan efecto:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Reinicie Ceph Object Gateway:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart rgw</screen>
    </step>
   </procedure>
   <para>
    Si la zona principal anterior se recupera, revierta la operación.
   </para>
   <procedure>
    <step>
     <para>
      Desde la zona recuperada, extraiga la última configuración de dominio de la zona principal actual.
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm pull --url=<replaceable>URL-TO-MASTER-ZONE-GATEWAY</replaceable> \
                           --access-key=<replaceable>ACCESS-KEY</replaceable> --secret=<replaceable>SECRET</replaceable>
</screen>
    </step>
    <step>
     <para>
      Convierta la zona recuperada en la zona principal y por defecto:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default</screen>
    </step>
    <step>
     <para>
      Actualice el período para que los cambios surtan efecto:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Reinicie Ceph Object Gateway en la zona recuperada:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart rgw@rgw</screen>
    </step>
    <step>
     <para>
      Si la zona secundaria debe tener una configuración de solo lectura, actualice la zona secundaria:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --read-only</screen>
    </step>
    <step>
     <para>
      Actualice el período para que los cambios surtan efecto:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Reinicie Ceph Object Gateway en la zona secundaria:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart@rgw</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
