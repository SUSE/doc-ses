<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Copia de seguridad y recuperación</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  En este capítulo se explica de qué partes del clúster de Ceph se debe realizar una copia de seguridad para poder restaurarlo.
 </para>
 <sect1 xml:id="backrest-ceph">
  <title>Copia de seguridad de la configuración y los datos del clúster</title>

  <sect2 xml:id="backrest-ceph-cephsalt">
   <title>Copia de seguridad de la configuración de <systemitem class="resource">ceph-salt</systemitem></title>
   <para>
    Exporte la configuración del clúster. Encontrará más información en <xref linkend="deploy-cephadm-configure-export"/>.
   </para>
  </sect2>

  <sect2 xml:id="backup-ceph">
   <title>Copia de seguridad de la configuración de Ceph</title>
   <para>
    Realice una copia de seguridad del directorio <filename>/etc/ceph</filename>. Contiene configuración crucial del clúster. Por ejemplo, necesitará una copia de seguridad de <filename>/etc/ceph</filename> cuando deba sustituir el nodo de administración.
   </para>
  </sect2>

  <sect2 xml:id="sec-deployment-backup-salt">
   <title>Copia de seguridad de la configuración de Salt</title>
   <para>
    Debe realizar una copia de seguridad del directorio <filename>/etc/salt/</filename>. Contiene los archivos de configuración de Salt, por ejemplo la clave del master de Salt y las claves de cliente aceptadas.
   </para>
   <para>
    No es estrictamente necesario incluir los archivos de Salt al realizar una copia de seguridad del nodo de administración, pero facilita la posterior redistribución del clúster de Salt. Si no se hace una copia de seguridad de estos archivos, los minions de Salt deben registrarse de nuevo en el nuevo nodo de administración.
   </para>
   <note>
    <title>seguridad de la clave privada de master de Salt</title>
    <para>
     Asegúrese de que la copia de seguridad de la clave privada del master de Salt se guarda en una ubicación segura. La clave del master de Salt puede emplearse para manipular todos los nodos del clúster.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="backup-config-files">
   <title>Copia de seguridad de configuraciones personalizadas</title>
   <itemizedlist>
    <listitem>
     <para>
      Datos y personalizaciones de Prometheus.
     </para>
    </listitem>
    <listitem>
     <para>
      Personalizaciones de Grafana.
     </para>
    </listitem>
    <listitem>
     <para>
      Cambios manuales en la configuración de iSCSI.
     </para>
    </listitem>
    <listitem>
     <para>
      Claves de ceph.
     </para>
    </listitem>
    <listitem>
     <para>
      Mapa y reglas de CRUSH. Guarde el mapa de CRUSH descompilado, incluidas las reglas de CRUSH, en <filename>crushmap-backup.txt</filename> ejecutando el siguiente comando:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
    </listitem>
    <listitem>
     <para>
      Configuración de Samba Gateway. Si utiliza una única pasarela, realice una copia de seguridad de <filename>/etc/samba/smb.conf</filename>. Si utiliza una configuración de alta disponibilidad, realice también una copia de seguridad de los archivos de configuración de CTDB y Pacemaker. Consulte el <xref linkend="cha-ses-cifs"/> para ver detalles sobre la configuración que se usa en las pasarelas Samba Gateway.
     </para>
    </listitem>
    <listitem>
     <para>
      Configuración de NFS Ganesha. Solo se necesita si se utiliza una configuración de alta disponibilidad. Consulte el <xref linkend="cha-ceph-nfsganesha"/> para ver detalles sobre la configuración que se usa en NFS Ganesha.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="restore-ceph">
  <title>Restauración de un nodo de Ceph</title>

  <para>
   El procedimiento para recuperar un nodo de la copia de seguridad consiste en volver a instalar el nodo, sustituir sus archivos de configuración y, a continuación, volver a organizar el clúster para que se vuelva a añadir el nodo de sustitución.
  </para>

  <para>
   Si necesita volver a distribuir el nodo de administración, consulte la <xref linkend="moving-saltmaster"/>.
  </para>

  <para>
   En el caso de los minions, suele ser más fácil volver a crearlos y distribuirlos.
  </para>

  <orderedlist>
   <listitem>
    <para>
     Vuelva a instalar el nodo. Encontrará más información en <xref linkend="deploy-sles"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Instale Salt. Encontrará más información en <xref linkend="deploy-salt"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Después de restaurar el directorio <filename>/etc/salt</filename> desde una copia de seguridad, habilite y reinicie los servicios de Salt aplicables, por ejemplo:
    </para>
<screen>
<prompt>root@master # </prompt><command>systemctl</command> enable salt-master
<prompt>root@master # </prompt><command>systemctl</command> start salt-master
<prompt>root@master # </prompt><command>systemctl</command> enable salt-minion
<prompt>root@master # </prompt><command>systemctl</command> start salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Elimine la clave principal pública del nodo del master de Salt de todos los minions.
    </para>
<screen>
<prompt>root@master # </prompt><command>rm</command> /etc/salt/pki/minion/minion_master.pub
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Restaure cualquier elemento que fuera local en el nodo de administración.
    </para>
   </listitem>
   <listitem>
    <para>
     Importe la configuración del clúster desde el archivo JSON exportado anteriormente. Consulte el <xref linkend="deploy-cephadm-configure-export"/> para obtener más información.
    </para>
   </listitem>
   <listitem>
    <para>
     Aplique la configuración de clúster importada:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt apply</screen>
   </listitem>
  </orderedlist>
 </sect1>
</chapter>
