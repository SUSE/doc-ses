<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_kvm.xml" version="5.0" xml:id="cha-ceph-kvm">
 <title>Ceph como procesador final para la instancia de QEMU KVM</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sí</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  El caso de uso más frecuente de Ceph implica proporcionar imágenes de dispositivo de bloques a máquinas virtuales. Por ejemplo, un usuario puede crear una imagen lista para usar con un sistema operativo y cualquier software relevante en una configuración ideal. A continuación, el usuario toma una instantánea de la imagen. Por último, el usuario clona la instantánea (normalmente muchas veces, consulte la <xref linkend="cha-ceph-snapshots-rbd"/> para más información). La capacidad para crear clones de copia de escritura de una instantánea significa que Ceph puede provisionar imágenes de dispositivos de bloques a máquinas virtuales rápidamente, ya que el cliente no necesita descargar una imagen completa cada vez que invoca una máquina virtual nueva.
 </para>
 <para>
  Los dispositivos de bloques de Ceph pueden integrarse con máquinas virtuales QEMU. Para obtener más información sobre QEMU KVM, consulte <link xlink:href="https://documentation.suse.com/sles/15-SP1/single-html/SLES-virtualization/#part-virt-qemu"/>.
 </para>
 <sect1 xml:id="ceph-kvm-install">
  <title>Instalación de <systemitem>qemu-block-rbd</systemitem></title>

  <para>
   Para poder utilizar dispositivos de bloques de Ceph, QEMU debe tener instalado el controlador adecuado. Compruebe si el paquete <systemitem>qemu-block-rbd</systemitem> está instalado e instálelo si fuera necesario:
  </para>

<screen><prompt role="root">root # </prompt>zypper install qemu-block-rbd</screen>
 </sect1>
 <sect1 xml:id="ceph-kvm-usage">
  <title>Uso de QEMU</title>

  <para>
   La línea de comandos de QEMU espera que se especifique el nombre de repositorio y el nombre de imagen. También puede especificar un nombre de instantánea.
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable><replaceable>:option1=value1</replaceable><replaceable>:option2=value2...</replaceable></screen>

  <para>
   Por ejemplo, si especifica las opciones <replaceable>id</replaceable> y <replaceable>conf</replaceable>, se puede obtener un resultado parecido al siguiente:
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable>:<option>id=glance:conf=/etc/ceph/ceph.conf</option></screen>
 </sect1>
 <sect1 xml:id="creating-images-qemu">
  <title>Creación de imágenes con QEMU</title>

  <para>
   Puede crear una imagen de dispositivo de bloques en QEMU. Debe especificar el <literal>rbd</literal>, el nombre del repositorio y el nombre de la imagen que desea crear. También debe especificar el tamaño de la imagen.
  </para>

<screen>qemu-img create -f raw rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Por ejemplo:
  </para>

<screen>qemu-img create -f raw rbd:pool1/image1 10G
Formatting 'rbd:pool1/image1', fmt=raw size=10737418240 nocow=off cluster_size=0</screen>

  <important>
   <para>
    El formato de datos <literal>raw</literal> es en realidad la única opción que se puede usar con RBD. Técnicamente, se podrían utilizar otros formatos compatibles con QEMU, como <literal>qcow2</literal>, pero se requiere mucha más supervisión y haría que el volumen no fuera seguro para la migración en directo de la máquina virtual si el almacenamiento en caché está habilitado.
   </para>
  </important>
 </sect1>
 <sect1 xml:id="resizing-images-qemu">
  <title>Cambio de tamaño de las imágenes con QEMU</title>

  <para>
   Puede cambiar el tamaño de una imagen de dispositivo de bloques en QEMU. Debe especificar el <literal>rbd</literal>, el nombre del repositorio y el nombre de la imagen cuyo tamaño desea cambiar. También debe especificar el tamaño de la imagen.
  </para>

<screen>qemu-img resize rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Por ejemplo:
  </para>

<screen>qemu-img resize rbd:pool1/image1 9G
Image resized.</screen>
 </sect1>
 <sect1 xml:id="retrieving-image-info-qemu">
  <title>Recuperación de información de la imagen con QEMU</title>

  <para>
   Puede recuperar información de la imagen del dispositivo de bloques en QEMU. Debe especificar el <literal>rbd</literal>, el nombre del repositorio y el nombre de la imagen.
  </para>

<screen>qemu-img info rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>

  <para>
   Por ejemplo:
  </para>

<screen>qemu-img info rbd:pool1/image1
image: rbd:pool1/image1
file format: raw
virtual size: 9.0G (9663676416 bytes)
disk size: unavailable
cluster_size: 4194304</screen>
 </sect1>
 <sect1 xml:id="running-qemu-rbd">
  <title>Ejecución de QEMU con RBD</title>

  <para>
   QEMU puede acceder a una imagen como dispositivo de bloques virtual directamente a través de <systemitem>librbd</systemitem>. Esto evita una conmutación de contexto adicional y puede aprovechar las ventajas del almacenamiento en caché de RBD.
  </para>

  <para>
   Puede utilizar <command>qemu-img</command> para convertir las imágenes de la máquina virtual existentes a imágenes de dispositivos de bloques de Ceph. Por ejemplo, si dispone de una imagen qcow2, ejecute:
  </para>

<screen>qemu-img convert -f qcow2 -O raw sles12.qcow2 rbd:pool1/sles12</screen>

  <para>
   Para ejecutar un arranque de la máquina virtual desde esa imagen, ejecute:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12</screen>

  <para>
   El almacenamiento en caché de RBD puede mejorar significativamente el rendimiento. Las opciones de caché de QEMU controlan el almacenamiento en caché de <systemitem>librbd</systemitem>:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=rbd,file=rbd:pool1/sles12,cache=writeback</screen>

  <para>
   Para obtener más información sobre el almacenamiento en caché de RBD, consulte la <xref linkend="rbd-cache-settings"/>.
  </para>
 </sect1>
 <sect1 xml:id="enabling-dicard-trim">
  <title>Habilitación de descartes y TRIM</title>

  <para>
   Los dispositivos de bloques de Ceph admiten la operación de descarte. Esto significa que un invitado puede enviar peticiones TRIM para permitir que un dispositivo de bloques de Ceph reclame espacio no utilizado. Esto se puede habilitar en el invitado montando <systemitem>XFS</systemitem> con la opción de descarte.
  </para>

  <para>
   Para que esto esté disponible para el invitado, se debe habilitar explícitamente para el dispositivo de bloques. Para ello, debe especificar una opción <option>discard_granularity</option> asociada a la unidad:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12,id=drive1,if=none \
-device driver=ide-hd,drive=drive1,discard_granularity=512</screen>

  <note>
   <para>
    En el ejemplo anterior se utiliza el controlador IDE. El controlador virtio no admite el descarte.
   </para>
  </note>

  <para>
   Si utiliza <systemitem>libvirt</systemitem>, edite el archivo de configuración del dominio de libvirt con el comando <command>virsh edit</command> e incluya el valor <literal>xmlns:qemu</literal>. A continuación, añada <literal>qemu:commandline block</literal> como hijo de dicho dominio. El siguiente ejemplo muestra cómo definir dos dispositivos con <literal>qemu id=</literal> con valores <literal>discard_granularity</literal> distintos.
  </para>

<screen>
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
 &lt;qemu:commandline&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-0.discard_granularity=4096'/&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-1.discard_granularity=65536'/&gt;
 &lt;/qemu:commandline&gt;
&lt;/domain&gt;</screen>
 </sect1>
 <sect1 xml:id="qemu-cache-options">
  <title>Configuración de las opciones de caché de QEMU</title>

  <para>
   Las opciones de caché de QEMU se corresponden con los siguientes valores de caché de Ceph RBD.
  </para>

  <para>
   Writeback (actualización de la memoria a través de datos de caché):
  </para>

<screen>rbd_cache = true</screen>

  <para>
   WriteThrough (escritura integral caché-memoria):
  </para>

<screen>rbd_cache = true
rbd_cache_max_dirty = 0</screen>

  <para>
   None (Ninguna):
  </para>

<screen>rbd_cache = false</screen>

  <para>
   Los valores de caché de QEMU sustituyen a los valores por defecto de Ceph (los valores que no se definan explícitamente en el archivo de configuración de Ceph). Si define explícitamente los valores de caché de RBD en el archivo de configuración de Ceph (consulte la <xref linkend="rbd-cache-settings"/>), los valores de Ceph sustituirán a los valores de caché de QEMU. Si define los valores de caché en la línea de comandos de QEMU, los valores de la línea de comandos de QEMU sustituyen a los valores del archivo de configuración de Ceph.
  </para>
 </sect1>
</chapter>
