<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha-ceph-nfsganesha">

 <title>NFS Ganesha</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  NFS Ganesha es un servidor NFS que se ejecuta en un espacio de dirección de usuario, en lugar de hacerlo como parte del kernel del sistema operativo. Con NFS Ganesha, puede poner en marcha su propio mecanismo de almacenamiento, como Ceph, y acceder a él desde cualquier cliente NFS. Para obtener instrucciones sobre la instalación, consulte <xref linkend="deploy-cephadm-day2-service-nfs"/>.
 </para>
 <note>
  <title>rendimiento de NFS Ganesha</title>
  <para>
   Debido al aumento de la sobrecarga de protocolo y a la latencia adicional causados por saltos de red adicionales entre el cliente y el almacenamiento, el acceso a Ceph a través de una pasarela de NFS puede reducir de forma significativa el rendimiento de la aplicación en comparación con los clientes nativos de CephFS.
  </para>
 </note>
 <para>
  Cada servicio de NFS Ganesha consta de una jerarquía de configuración que contiene:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Un archivo de carga (bootstrap) <filename>ganesha.conf</filename>
   </para>
  </listitem>
  <listitem>
   <para>
    Un objeto de configuración común RADOS por servicio
   </para>
  </listitem>
  <listitem>
   <para>
    Un objeto de configuración RADOS por exportación
   </para>
  </listitem>
 </itemizedlist>
 <para>
  La configuración de carga es la configuración mínima para iniciar el daemon <systemitem class="daemon">nfs-ganesha</systemitem> dentro de un contenedor. Cada configuración de carga contendrá una directiva <literal>%url</literal> que incluya cualquier configuración adicional del objeto de configuración común RADOS. El objeto de configuración común puede incluir directivas <literal>%url</literal> adicionales para cada una de las exportaciones NFS definidas en los objetos de configuración RADOS de exportación.
 </para>
 <figure>
  <title>Estructura de NFS Ganesha</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
  </mediaobject>
 </figure>
 <sect1 xml:id="ceph-nfsganesha-nfservice">
  <title>Creación de un servicio NFS</title>

  <para>
   La forma recomendada de especificar la distribución de los servicios de Ceph es crear un archivo con formato YAML con la especificación de los servicios que desea distribuir. Puede crear un archivo de especificación independiente para cada tipo de servicio, o bien especificar varios (o todos) los tipos de servicios en un archivo.
  </para>

  <para>
   Dependiendo de lo que haya decidido hacer, deberá actualizar o crear un archivo con formato YAML relevante para crear un servicio de NFS Ganesha. Para obtener más información sobre la creación del archivo, consulte el <xref linkend="cephadm-service-and-placement-specs"/>.
  </para>

  <para>
   Una vez que haya actualizado o creado el archivo, ejecute lo siguiente para crear un servicio <literal>nfs-ganesha</literal>:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>FILE_NAME</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-services">
  <title>Inicio o reinicio de NFS Ganesha</title>

  <important>
   <para>
    Cuando el servicio de NFS Ganesha se inicia, no se exporta automáticamente un sistema de archivos CephFS. Para exportar un sistema de archivos CephFS, cree un archivo de configuración de exportación. Consulte <xref linkend="ceph-nfsganesha-create-export"/> para obtener más información.
   </para>
  </important>

  <para>
   Para iniciar el servicio de NFS Ganesha, ejecute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch start nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Para reiniciar el servicio de NFS Ganesha, ejecute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Si solo desea reiniciar un único daemon de NFS Ganesha, ejecute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Cuando se inicia o se reinicia NFS Ganesha, tiene un tiempo límite de gracia de 90 segundos para NFS v4. Durante el período de gracia, las peticiones nuevas de los clientes se rechazan de forma activa. Por lo tanto, los clientes pueden observar una ralentización de las peticiones cuando NFS se encuentra en período de gracia.
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-list-objects">
  <title>Listado de objetos en el repositorio de recuperación NFS</title>

  <para>
   Ejecute lo siguiente para mostrar los objetos del repositorio de recuperación de NFS:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> ls</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-create-export">
  <title>Creación de una exportación NFS</title>

  <para>
   Puede crear una exportación NFS en Ceph Dashboard, o bien manualmente en la línea de comandos. Para crear la exportación mediante Ceph Dashboard, consulte el <xref linkend="dash-webui-nfs"/>, más específicamente la <xref linkend="dash-webui-nfs-create"/>.
  </para>

  <para>
   Para crear una exportación NFS manualmente, cree un archivo de configuración para la exportación. Por ejemplo, un archivo <filename>/tmp/export-1</filename> con el siguiente contenido:
  </para>

<screen>
EXPORT {
    export_id = 1;
    path = "/";
    pseudo = "/";
    access_type = "RW";
    squash = "no_root_squash";
    protocols = 3, 4;
    transports = "TCP", "UDP";
    FSAL {
        name = "CEPH";
        user_id = "admin";
        filesystem = "a";
        secret_access_key = "<replaceable>SECRET_ACCESS_KEY</replaceable>";
    }
}
</screen>

  <para>
   Después de crear y guardar el archivo de configuración para la nueva exportación, ejecute el siguiente comando para crear la exportación:
  </para>

<screen>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> put <replaceable>EXPORT_NAME</replaceable> <replaceable>EXPORT_CONFIG_FILE</replaceable></screen>

  <para>
   Por ejemplo:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool example_pool --namespace example_namespace put export-1 /tmp/export-1</screen>

  <note>
   <para>
    El bloque FSAL debe modificarse para incluir el ID de usuario de <systemitem class="service">cephx</systemitem> deseado y la clave de acceso secreta.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-verify">
  <title>Verificación de la exportación NFS</title>

  <para>
   NFS v4 creará una lista de exportaciones en la raíz de un sistema de archivos simulado. Puede verificar que los recursos compartidos NFS se exportan montando la raíz (<filename>/</filename>) del nodo del servidor NFS Ganesha:
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable>
<prompt role="root"># </prompt><command>ls</command> <replaceable>/path/to/local/mountpoint</replaceable> cephfs</screen>

  <note>
   <title>NFS Ganesha solo funciona en v4</title>
   <para>
    Por defecto, cephadm configura un servidor NFS v4. NFS v4 no interactúa con <literal>rpcbind</literal> ni con el daemon <literal>mountd</literal>. Las herramientas del cliente NFS, como <command>showmount</command>, no muestran ninguna exportación configurada.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-mount">
  <title>Montaje de la exportación NFS</title>

  <para>
   Para montar el recurso compartido NFS exportado en un host de cliente, ejecute:
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-customrole">
  <title>Varios clústeres de NFS Ganesha</title>

  <para>
   Es posible definir varios clústeres de NFS Ganesha, lo que permite:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Clústeres de NFS Ganesha separados para acceder a CephFS.
    </para>
   </listitem>
  </itemizedlist>


 </sect1>
</chapter>
