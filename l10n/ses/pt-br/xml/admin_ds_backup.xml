<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Backup e restauração</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Este capítulo explica quais partes do cluster do Ceph devem ser incluídas no backup para que seja possível restaurar a funcionalidade dele.
 </para>
 <sect1 xml:id="backrest-ceph">
  <title>Fazer backup da configuração e dos dados do cluster</title>

  <sect2 xml:id="backrest-ceph-cephsalt">
   <title>Fazer backup da configuração do <systemitem class="resource">ceph-salt</systemitem></title>
   <para>
    Exporte a configuração do cluster. Mais informações podem ser encontradas em <xref linkend="deploy-cephadm-configure-export"/>.
   </para>
  </sect2>

  <sect2 xml:id="backup-ceph">
   <title>Fazer backup da configuração do Ceph</title>
   <para>
    Faça backup do diretório <filename>/etc/ceph</filename>. Ele inclui a configuração essencial do cluster. Por exemplo, você precisará fazer backup do <filename>/etc/ceph</filename> quando for necessário substituir o Nó de Admin.
   </para>
  </sect2>

  <sect2 xml:id="sec-deployment-backup-salt">
   <title>Fazer backup da configuração do Salt</title>
   <para>
    Você precisa fazer backup do diretório <filename>/etc/salt/</filename>. Ele contém os arquivos de configuração do Salt, por exemplo, a chave do Master Salt e as chaves aceitas do cliente.
   </para>
   <para>
    Os arquivos do Salt não são estritamente necessários para fazer backup do Nó de Admin, mas facilitam a reimplantação do cluster do Salt. Se não houver nenhum backup desses arquivos, os minions Salt precisarão ser registrados novamente no novo Nó de Admin.
   </para>
   <note>
    <title>Segurança da chave privada master do Salt</title>
    <para>
     Garanta que o backup da chave privada do Master Salt seja armazenada em um local seguro. A chave do Master Salt pode ser usada para manipular todos os nós do cluster.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="backup-config-files">
   <title>Fazer backup das configurações personalizadas</title>
   <itemizedlist>
    <listitem>
     <para>
      Dados e personalização do Prometheus.
     </para>
    </listitem>
    <listitem>
     <para>
      Personalização do Grafana.
     </para>
    </listitem>
    <listitem>
     <para>
      Mudanças manuais na configuração do iSCSI.
     </para>
    </listitem>
    <listitem>
     <para>
      Chaves do Ceph.
     </para>
    </listitem>
    <listitem>
     <para>
      Mapa CRUSH e regras CRUSH. Execute o comando a seguir para gravar o Mapa CRUSH descompilado incluindo as regras CRUSH no <filename>crushmap-backup.txt</filename>:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
    </listitem>
    <listitem>
     <para>
      Configuração do Gateway do Samba. Se você usa um único gateway, faça backup do <filename>/etc/samba/smb.conf</filename>. Se você usa uma configuração de HA, faça backup também dos arquivos de configuração do CTDB e do Pacemaker. Consulte o <xref linkend="cha-ses-cifs"/> para obter detalhes sobre a configuração que é usada pelos Gateways do Samba.
     </para>
    </listitem>
    <listitem>
     <para>
      Configuração do NFS Ganesha. Necessário apenas ao usar uma configuração de HA. Consulte o <xref linkend="cha-ceph-nfsganesha"/> para obter detalhes sobre a configuração que é usada pelo NFS Ganesha.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="restore-ceph">
  <title>Restaurando um nó do Ceph</title>

  <para>
   O procedimento para recuperar um nó do backup é reinstalar o nó, substituir seus arquivos de configuração e, em seguida, reorquestar o cluster para que o nó de substituição seja adicionado novamente.
  </para>

  <para>
   Se você precisar reimplantar o Nó de Admin, consulte a <xref linkend="moving-saltmaster"/>.
  </para>

  <para>
   Para os minions, geralmente é mais fácil apenas reconstruir e reimplantar.
  </para>

  <orderedlist>
   <listitem>
    <para>
     Reinstale o nó. Mais informações podem ser encontradas em <xref linkend="deploy-sles"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Instale o Salt. Encontre mais informações no <xref linkend="deploy-salt"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Após restaurar o diretório <filename>/etc/salt</filename> de um backup, habilite e reinicie os serviços do Salt aplicáveis, por exemplo:
    </para>
<screen>
<prompt>root@master # </prompt><command>systemctl</command> enable salt-master
<prompt>root@master # </prompt><command>systemctl</command> start salt-master
<prompt>root@master # </prompt><command>systemctl</command> enable salt-minion
<prompt>root@master # </prompt><command>systemctl</command> start salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Remova a chave master pública do nó do Master Salt antigo de todos os minions.
    </para>
<screen>
<prompt>root@master # </prompt><command>rm</command> /etc/salt/pki/minion/minion_master.pub
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Restaure para o Nó de Admin tudo o que era local.
    </para>
   </listitem>
   <listitem>
    <para>
     Importe a configuração do cluster do arquivo JSON exportado anteriormente. Consulte <xref linkend="deploy-cephadm-configure-export"/> para obter mais detalhes.
    </para>
   </listitem>
   <listitem>
    <para>
     Aplique a configuração importada do cluster:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt apply</screen>
   </listitem>
  </orderedlist>
 </sect1>
</chapter>
