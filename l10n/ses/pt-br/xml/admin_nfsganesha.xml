<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha-ceph-nfsganesha">

 <title>NFS Ganesha</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  NFS Ganesha é um servidor NFS executado em um espaço de endereço do usuário, e não como parte do kernel do sistema operacional. Com o NFS Ganesha, você pode conectar seu próprio mecanismo de armazenamento, como Ceph, e acessá-lo de qualquer cliente NFS. Para obter instruções, consulte o <xref linkend="deploy-cephadm-day2-service-nfs"/>.
 </para>
 <note>
  <title>Desempenho do NFS Ganesha</title>
  <para>
   Devido ao aumento da sobrecarga do protocolo e da latência adicional causado por saltos extras de rede entre o cliente e o armazenamento, o acesso ao Ceph por meio de um NFS Gateway pode reduzir significativamente o desempenho do aplicativo quando comparado ao CephFS nativo.
  </para>
 </note>
 <para>
  Cada serviço do NFS Ganesha consiste em uma hierarquia de configuração que contém:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Um <filename>ganesha.conf</filename> de boot
   </para>
  </listitem>
  <listitem>
   <para>
    Um objeto de configuração comum RADOS por serviço
   </para>
  </listitem>
  <listitem>
   <para>
    Um objeto de configuração RADOS por exportação
   </para>
  </listitem>
 </itemizedlist>
 <para>
  A configuração de boot é a configuração mínima para iniciar o daemon <systemitem class="daemon">nfs-ganesha</systemitem> em um container. Cada configuração de boot incluirá uma diretiva <literal>%url</literal> com qualquer configuração adicional do objeto de configuração comum RADOS. O objeto de configuração comum pode incluir diretivas <literal>%url</literal> adicionais para cada uma das exportações NFS definidas nos objetos de configuração RADOS de exportação.
 </para>
 <figure>
  <title>Estrutura do NFS Ganesha</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
  </mediaobject>
 </figure>
 <sect1 xml:id="ceph-nfsganesha-nfservice">
  <title>Criando um serviço do NFS</title>

  <para>
   A maneira recomendada de especificar a implantação dos serviços do Ceph é criar um arquivo no formato YAML com a especificação dos serviços que você pretende implantar. Você pode criar um arquivo de especificação separado para cada tipo de serviço ou especificar vários (ou todos) tipos de serviços em um arquivo.
  </para>

  <para>
   Dependendo do que você escolheu fazer, será necessário atualizar ou criar um arquivo relevante no formato YAML para criar um serviço do NFS Ganesha. Para obter mais informações sobre como criar o arquivo, consulte o <xref linkend="cephadm-service-and-placement-specs"/>.
  </para>

  <para>
   Após atualizar ou criar o arquivo, execute o seguinte comando para criar um serviço <literal>nfs-ganesha</literal>:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>FILE_NAME</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-services">
  <title>Iniciando ou reiniciando o NFS Ganesha</title>

  <important>
   <para>
    A inicialização do serviço NFS Ganesha não exporta automaticamente um sistema de arquivos CephFS. Para exportar um sistema de arquivos CephFS, crie um arquivo de configuração de exportação. Consulte a <xref linkend="ceph-nfsganesha-create-export"/> para obter mais detalhes.
   </para>
  </important>

  <para>
   Para iniciar o serviço do NFS Ganesha, execute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch start nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Para reiniciar o serviço do NFS Ganesha, execute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Para reiniciar apenas um daemon do NFS Ganesha, execute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Quando o NFS Ganesha é iniciado ou reiniciado, ele tem um tempo de espera extra de 90 segundos para o NFS v4. Durante o período extra, as novas solicitações dos clientes são ativamente rejeitadas. Portanto, os clientes podem enfrentar lentidão nas solicitações durante o período extra do NFS.
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-list-objects">
  <title>Listando objetos no pool de recuperação do NFS</title>

  <para>
   Execute o seguinte comando para listar os objetos no pool de recuperação do NFS:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> ls</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-create-export">
  <title>Criando uma exportação do NFS</title>

  <para>
   Você pode criar uma exportação do NFS no Ceph Dashboard ou manualmente por linha de comando. Para criar a exportação usando o Ceph Dashboard, consulte a <xref linkend="dash-webui-nfs"/>, mais especificamente a <xref linkend="dash-webui-nfs-create"/>.
  </para>

  <para>
   Para criar uma exportação do NFS manualmente, crie um arquivo de configuração para a exportação. Por exemplo, um arquivo <filename>/tmp/export-1</filename> com o seguinte conteúdo:
  </para>

<screen>
EXPORT {
    export_id = 1;
    path = "/";
    pseudo = "/";
    access_type = "RW";
    squash = "no_root_squash";
    protocols = 3, 4;
    transports = "TCP", "UDP";
    FSAL {
        name = "CEPH";
        user_id = "admin";
        filesystem = "a";
        secret_access_key = "<replaceable>SECRET_ACCESS_KEY</replaceable>";
    }
}
</screen>

  <para>
   Depois de criar e gravar o arquivo de configuração para a nova exportação, execute o seguinte comando para criar a exportação:
  </para>

<screen>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> put <replaceable>EXPORT_NAME</replaceable> <replaceable>EXPORT_CONFIG_FILE</replaceable></screen>

  <para>
   Por exemplo:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool example_pool --namespace example_namespace put export-1 /tmp/export-1</screen>

  <note>
   <para>
    O bloco FSAL deve ser modificado para incluir o ID de usuário e a chave de acesso secreta do <systemitem class="service">cephx</systemitem> desejado.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-verify">
  <title>Verificando a exportação do NFS</title>

  <para>
   O NFS v4 criará uma lista de exportações na raiz de um pseudo sistema de arquivos. Você pode verificar se os compartilhamentos NFS foram exportados montando <filename>/</filename> do nó do servidor NFS Ganesha:
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable>
<prompt role="root"># </prompt><command>ls</command> <replaceable>/path/to/local/mountpoint</replaceable> cephfs</screen>

  <note>
   <title>O NFS Ganesha é apenas v4</title>
   <para>
    Por padrão, o cephadm configurará um servidor NFS v4. O NFS v4 não interage com os daemons <literal>rpcbind</literal> ou <literal>mountd</literal>. As ferramentas do cliente NFS, como <command>showmount</command>, não mostrarão nenhuma exportação configurada.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-mount">
  <title>Montando a exportação do NFS</title>

  <para>
   Para montar o compartilhamento NFS exportado em um host de cliente, execute:
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-customrole">
  <title>Vários clusters do NFS Ganesha</title>

  <para>
   É possível definir vários clusters do NFS Ganesha. Esse procedimento permite:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Clusters separados do NFS Ganesha para acessar o CephFS.
    </para>
   </listitem>
  </itemizedlist>


 </sect1>
</chapter>
