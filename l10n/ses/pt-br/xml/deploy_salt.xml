<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_salt.xml" version="5.0" xml:id="deploy-salt">
 <info>
  <title>Implantando o Salt</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  O SUSE Enterprise Storage usa o Salt e o <systemitem class="resource">ceph-salt</systemitem> para a preparação inicial do cluster. O Salt ajuda você a configurar e executar comandos em vários nós do cluster simultaneamente, de um host dedicado chamado <emphasis>Master Salt</emphasis>. Antes de implantar o Salt, considere os seguintes pontos importantes:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Os <emphasis>Minions Salt</emphasis> são os nós controlados por um nó dedicado denominado Master Salt.
   </para>
  </listitem>
  <listitem>
   <para>
    Se o host Master Salt fizer parte do cluster do Ceph, ele precisará executar seu próprio Minion Salt, mas isso não é um requisito.
   </para>
   <tip>
    <title>Compartilhando várias funções por servidor</title>
    <para>
     O desempenho do cluster do Ceph é melhor quando cada função é implantada em um nó separado. Porém, as implantações reais às vezes exigem que um nó seja compartilhado com várias funções. Para evitar problema de desempenho e de procedimento de upgrade, não implante a função Ceph OSD, Servidor de Metadados ou Ceph Monitor no Nó de Admin.
    </para>
   </tip>
  </listitem>
  <listitem>
   <para>
    Os Minions Salt precisam resolver corretamente o nome de host do Master Salt na rede. Por padrão, eles procuram o nome de host <systemitem>salt</systemitem>, mas você pode especificar qualquer outro nome de host acessível por rede no arquivo <filename>/etc/salt/minion</filename>.
   </para>
  </listitem>
 </itemizedlist>
 <procedure>
  <step>
   <para>
    Instale o <literal>salt-master</literal> no nó do Master Salt:
   </para>
<screen><prompt>root@master # </prompt>zypper in salt-master</screen>
  </step>
  <step>
   <para>
    Verifique se o serviço <systemitem>salt-master</systemitem> está habilitado e foi iniciado. Se necessário, habilite-o e inicie-o:
   </para>
<screen><prompt>root@master # </prompt>systemctl enable salt-master.service
<prompt>root@master # </prompt>systemctl start salt-master.service</screen>
  </step>
  <step>
   <para>
    Se você pretende usar o firewall, verifique se o nó do Master Salt tem as portas 4505 e 4506 abertas para todos os nós do Minion Salt. Se as portas estiverem fechadas, você poderá abri-las usando o comando <command>yast2 firewall</command> e permitindo o serviço <guimenu>salt-master</guimenu> para a zona apropriada. Por exemplo, <literal>public</literal>.
   </para>
  </step>
  <step>
   <para>
    Instale o pacote <literal>salt-minion</literal> em todos os nós do minion.
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper in salt-minion</screen>
  </step>
  <step>
   <para>
    Edite o <filename>/etc/salt/minion</filename> e remova o comentário da seguinte linha:
   </para>
<screen>#log_level_logfile: warning</screen>
   <para>
    Mude o nível de registro de <literal>warning</literal> para <literal>info</literal>.
   </para>
   <note>
    <title><option>log_level_logfile</option> e <option>log_level</option></title>
    <para>
     <option>log_level</option> controla quais mensagens de registro serão exibidas na tela, e <option>log_level_logfile</option> controla quais mensagens de registro serão gravadas no <filename>/var/log/salt/minion</filename>.
    </para>
   </note>
   <note>
    <para>
     Verifique se você mudou o nível de registro em <emphasis>todos</emphasis> os nós do cluster (minion).
    </para>
   </note>
  </step>
  <step>
   <para>
    Verifique se o <emphasis>nome de domínio completo e qualificado</emphasis> de cada nó pode ser resolvido para um endereço IP na rede pública do cluster por todos os outros nós.
   </para>
  </step>
  <step>
   <para>
    Configure todos os minions para se conectarem ao master. Se o Master Salt não puder ser acessado pelo nome de host <literal>salt</literal>, edite o arquivo <filename>/etc/salt/minion</filename> ou crie um novo arquivo <filename>/etc/salt/minion.d/master.conf</filename> com o seguinte conteúdo:
   </para>
<screen>master: <replaceable>host_name_of_salt_master</replaceable></screen>
   <para>
    Se você efetuou quaisquer mudanças nos arquivos de configuração mencionados acima, reinicie o serviço Salt em todos os Minions Salt relacionados:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart salt-minion.service</screen>
  </step>
  <step>
   <para>
    Verifique se o serviço <systemitem>salt-minion</systemitem> está habilitado e foi iniciado em todos os nós. Se necessário, habilite-o e inicie-o:
   </para>
<screen><prompt role="root"># </prompt>systemctl enable salt-minion.service
<prompt role="root"># </prompt>systemctl start salt-minion.service</screen>
  </step>
  <step>
   <para>
    Verifique a impressão digital de cada Minion Salt e aceite todas as chaves do Salt no Master Salt, se as impressões digitais forem correspondentes.
   </para>
   <note>
    <para>
     Se a impressão digital do Minion Salt retornar vazia, verifique se o Minion Salt tem uma configuração do Master Salt e pode se comunicar com o Master Salt.
    </para>
   </note>
   <para>
    Ver a impressão digital de cada minion:
   </para>
<screen><prompt>root@minion &gt; </prompt>salt-call --local key.finger
local:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Após coletar as impressões digitais de todos os Minions Salt, liste as impressões digitais de todas as chaves de minion não aceitas no Master Salt:
   </para>
<screen><prompt>root@master # </prompt>salt-key -F
[...]
Unaccepted Keys:
minion1:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Se houver correspondência de impressões digitais dos minions, aceite-as:
   </para>
<screen><prompt>root@master # </prompt>salt-key --accept-all</screen>
  </step>
  <step>
   <para>
    Verifique se as chaves foram aceitas:
   </para>
<screen><prompt>root@master # </prompt>salt-key --list-all</screen>
  </step>
  <step>
   <para>
    Faça o teste para verificar se todos os Minions Salt respondem:
   </para>
<screen><prompt>root@master # </prompt>salt-run manage.status</screen>
  </step>
 </procedure>
</chapter>
