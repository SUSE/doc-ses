<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Operação de serviços do Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Você pode operar os serviços do Ceph no nível do daemon, nó ou cluster. Dependendo da abordagem necessária, use o comando cephadm ou <command>systemctl</command>.
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>Operando serviços individuais</title>

  <para>
   Se você precisa operar um serviço individual, identifique-o primeiro:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   Para identificar um serviço em um nó específico, execute:
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   Por exemplo:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    O comando <command>ceph orch ps</command> suporta vários formatos de saída. Para mudá-lo, anexe a opção <option>--format <replaceable>FORMAT</replaceable></option>, em que <replaceable>FORMAT</replaceable> é <literal>json</literal>, <literal>json-pretty</literal> ou <literal>yaml</literal>. Por exemplo:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   Depois de saber o nome do serviço, você poderá iniciá-lo, reiniciá-lo ou pará-lo:
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   Por exemplo, para reiniciar o serviço OSD com ID 0, execute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>Operando tipos de serviço</title>

  <para>
   Se você precisar operar um tipo específico de serviço em todo o cluster do Ceph, use o seguinte comando:
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   Substitua <replaceable>COMMAND</replaceable> por <literal>start</literal>, <literal>stop</literal> ou <literal>restart</literal>.
  </para>

  <para>
   Por exemplo, o comando a seguir reinicia todos os MONs no cluster, sejam quais forem os nós em que eles são executados de fato:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>Operando serviços em um único nó</title>

  <para>
   Usando o comando <command>systemctl</command>, você pode operar os serviços e destinos do <systemitem class="daemon">systemd</systemitem> relacionados ao Ceph em um único nó.
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identificando serviços e destinos</title>
   <para>
    Antes de operar os serviços e destinos do <systemitem class="daemon">systemd</systemitem> relacionados ao Ceph, você precisa identificar os nomes dos seus arquivos unitários. Os nomes de arquivo dos serviços têm o seguinte padrão:
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    Por exemplo:
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       ID exclusivo do cluster do Ceph. Você pode encontrá-lo na saída do comando <command>ceph fsid</command>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       Tipo de serviço, por exemplo <literal>osd</literal>, <literal>mon</literal> ou <literal>rgw</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       String de identificação do serviço. Para os OSDs, esse é o número de ID do serviço. Para outros serviços, ele pode ser um nome de host do nó ou strings adicionais relevantes ao tipo de serviço.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     O <replaceable>SERVICE_TYPE</replaceable>.A parte <replaceable>ID</replaceable> é idêntica ao conteúdo da coluna <literal>NAME</literal> na saída do comando <command>ceph orch ps</command>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Operando todos os serviços em um nó</title>
   <para>
    Ao usar os destinos do <systemitem class="daemon">systemd</systemitem> do Ceph, você pode ao mesmo tempo operar <emphasis>todos</emphasis> os serviços em um nó ou todos os serviços que <emphasis>pertencem a um cluster</emphasis> identificado por seu <replaceable>FSID</replaceable>.
   </para>
   <para>
    Por exemplo, para parar todos os serviços do Ceph em um nó, iseja qual for o cluster ao qual eles pertençam, execute:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    Para reiniciar todos os serviços que pertencem a um cluster do Ceph com ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, execute:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>Operando um serviço individual em um nó</title>
   <para>
    Depois de identificar o nome de um serviço específico, opere-o da seguinte maneira:
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    Por exemplo, para reiniciar um único serviço OSD com ID 1 em um cluster com ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, execute:
   </para>
<screen><prompt role="root"># </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Consultando o status do serviço</title>
   <para>
    É possível consultar o <systemitem class="daemon">systemd</systemitem> para saber o status dos serviços. Por exemplo:
   </para>
<screen><prompt role="root"># </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Encerrando e reiniciando todo o cluster do Ceph</title>

  <para>
   Pode ser necessário encerrar e reiniciar o cluster em caso de queda de energia planejada. Para parar todos os serviços relacionados ao Ceph e reiniciá-los sem problemas, siga as etapas abaixo.
  </para>

  <procedure>
   <title>Encerrando todo o cluster do Ceph</title>
   <step>
    <para>
     Encerre ou desconecte todos os clientes que acessam o cluster.
    </para>
   </step>
   <step>
    <para>
     Para impedir que o CRUSH reequilibre automaticamente o cluster, defina o cluster como <literal>noout</literal>:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     Pare todos os serviços do Ceph em todos os nós do cluster:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     Desligue todos os nós do cluster:
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>Iniciando todo o cluster do Ceph</title>
   <step>
    <para>
     Ligue o Nó de Admin.
    </para>
   </step>
   <step>
    <para>
     Ligue os nós do Ceph Monitor.
    </para>
   </step>
   <step>
    <para>
     Ligue os nós do Ceph OSD.
    </para>
   </step>
   <step>
    <para>
     Cancele a definição do flag <literal>noout</literal>:
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     Ligue todos os gateways configurados.
    </para>
   </step>
   <step>
    <para>
     Ligue ou conecte os clientes do cluster.
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
