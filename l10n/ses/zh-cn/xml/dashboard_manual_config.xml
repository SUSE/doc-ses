<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="dashboard_manual_config.xml" version="5.0" xml:id="dashboard-initial-configuration">
 <title>手动配置</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  本节为更喜欢在命令行上手动配置仪表盘设置的用户提供了较深入的信息。
 </para>
 <sect1 xml:id="dashboard-ssl">
  <title>配置 TLS/SSL 支持</title>

  <para>
   所有连至仪表盘的 HTTP 连接默认都使用 TLS/SSL 来保障安全。安全连接需要 SSL 证书。您可以使用自我签名证书，也可以生成证书并让知名证书颁发机构 (CA) 对其签名。
  </para>

  <tip>
   <title>禁用 SSL</title>
   <para>
    您可能会出于某种原因需要禁用 SSL 支持。例如，如果仪表盘是在不支持 SSL 的代理之后运行。
   </para>
   <para>
    禁用 SSL 要慎重，因为禁用 SSL 后，<emphasis role="bold">用户名和密码</emphasis>将以<emphasis role="bold">未加密</emphasis>的形式发送到仪表盘。
   </para>
   <para>
    要禁用 SSL，请运行以下命令：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/ssl false
</screen>
  </tip>

  <tip>
   <title>重启动 Ceph Manager 进程</title>
   <para>
    更改 SSL 证书和密钥后，您需要手动重启动 Ceph Manager 进程。您可以通过运行以下命令
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr fail <replaceable>ACTIVE-MANAGER-NAME</replaceable></screen>
   <para>
    或禁用后再重新启用仪表盘扩展模块的方式来执行此操作，如此还会触发 Manager 的自我重新生成：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph mgr module disable dashboard
<prompt>cephuser@adm &gt; </prompt>ceph mgr module enable dashboard
</screen>
  </tip>

  <sect2 xml:id="self-sign-certificates">
   <title>创建自我签名证书</title>
   <para>
    为了安全通讯而创建自我签名证书的过程非常简单。采用这种方式可迅速让仪表盘运行起来。
   </para>
   <note>
    <title>Web 浏览器控诉</title>
    <para>
     大多数 Web 浏览器都将对自我签名证书发起控诉，并需要在建立与仪表盘的安全连接前进行明确确认。
    </para>
   </note>
   <para>
    要生成并安装自我签名证书，请使用以下内置命令：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard create-self-signed-cert
</screen>
  </sect2>

  <sect2 xml:id="cert-sign-CA">
   <title>使用 CA 签名的证书</title>
   <para>
    为了正确保障连至仪表盘的连接安全，以及消除 Web 浏览器对自我签名证书的控诉，我们建议使用 CA 签名的证书。
   </para>
   <para>
    您可以使用如下命令生成证书密钥对：
   </para>
<screen>
<prompt role="root"># </prompt>openssl req -new -nodes -x509 \
  -subj "/O=IT/CN=ceph-mgr-dashboard" -days 3650 \
  -keyout dashboard.key -out dashboard.crt -extensions v3_ca
</screen>
   <para>
    以上命令会输出 <filename>dashboard.key</filename> 和 <filename>dashboard.crt</filename> 文件。获得 CA 签名的 <filename>dashboard.crt</filename> 文件后，请运行以下命令为所有 Ceph Manager 实例启用该证书：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate -i dashboard.crt
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate-key -i dashboard.key
</screen>
   <tip>
    <title>每个 Manager 实例使用不同的证书</title>
    <para>
     如果您需要为每个 Ceph Manager 实例使用不同的证书，请按如下所示修改命令，在其中指定实例的名称。将 <replaceable>NAME</replaceable> 替换为 Ceph Manager 实例的名称（通常是相关的主机名）：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate <replaceable>NAME</replaceable> -i dashboard.crt
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate-key <replaceable>NAME</replaceable> -i dashboard.key
</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="dashboard-hostname-port">
  <title>更改主机名和端口号</title>

  <para>
   Ceph Dashboard 与特定 TCP/IP 地址和 TCP 端口绑定。默认情况下，托管仪表盘的当前活跃 Ceph Manager 会与 TCP 端口 8443 绑定（如果禁用 SSL，则与 8080 端口绑定）。
  </para>

  <note>
   <para>
    如果在运行 Ceph Manager（以及 Ceph Dashboard）的主机上启用了防火墙，则您可能需要更改配置以启用对这些端口的访问。有关 Ceph 防火墙设置的详细信息，请参见<xref linkend="storage-bp-net-firewall"/>。
   </para>
  </note>

  <para>
   Ceph Dashboard 默认与“::”绑定，该符号表示所有可用的 IPv4 和 IPv6 地址。您可以使用以下命令更改 Web 应用的 IP 地址和端口号，以使它们适用于所有 Ceph Manager 实例：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/server_addr <replaceable>IP_ADDRESS</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/server_port <replaceable>PORT_NUMBER</replaceable>
</screen>

  <tip>
   <title>分别配置 Ceph Manager 实例</title>
   <para>
    因为每个 <systemitem class="daemon">ceph-mgr</systemitem> 守护进程都托管着各自的仪表盘实例，您可能需要分别配置每个 Ceph Manager 实例。使用以下命令（将 <replaceable>NAME</replaceable> 替换为 <systemitem class="daemon">ceph-mgr</systemitem> 实例的 ID）更改特定 Manager 实例的 IP 地址和端口号：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/<replaceable>NAME</replaceable>/server_addr <replaceable>IP_ADDRESS</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/<replaceable>NAME</replaceable>/server_port <replaceable>PORT_NUMBER</replaceable>
</screen>
  </tip>

  <tip>
   <title>列出配置的端点</title>
   <para>
    <command>ceph mgr services</command> 命令会显示当前配置的所有端点。查找 <literal>dashboard</literal> 键可获取用于访问仪表盘的 URL。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="dashboard-username-password">
  <title>调整用户名和密码</title>

  <para>
   如果您不想使用默认管理员帐户，可创建其他用户帐户并将其与至少一个角色相关联。我们提供了一组预定义的系统角色供您使用。有关详细信息，请参见<xref linkend="dashboard-user-roles"/>。
  </para>

  <para>
   要创建具有管理员权限的用户，请使用以下命令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard ac-user-create <replaceable>USER_NAME</replaceable> <replaceable>PASSWORD</replaceable> administrator
</screen>
 </sect1>
 <sect1 xml:id="dashboard-ogw-enabling">
  <title>启用对象网关管理前端</title>

  <para>
   要使用仪表盘的对象网关管理功能，您需要提供启用了 <option>system</option> 标志的用户的登录身份凭证：
  </para>

  <procedure>
   <step>
    <para>
     如果您没有带 <option>system</option> 标志的用户，请创建一个：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USER_ID</replaceable> --display-name=<replaceable>DISPLAY_NAME</replaceable> --system
</screen>
    <para>
     记下命令输出中的 <replaceable>access_key</replaceable> 和 <replaceable>secret_key</replaceable> 密钥。
    </para>
   </step>
   <step>
    <para>
     您还可以使用 <command>radosgw-admin</command> 命令来获取现有用户的身份凭证：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid=<replaceable>USER_ID</replaceable>
</screen>
   </step>
   <step>
    <para>
     在单独的文件中向仪表盘提供收到的身份凭证：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-access-key <replaceable>ACCESS_KEY_FILE</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-secret-key <replaceable>SECRET_KEY_FILE</replaceable>
</screen>
   </step>
  </procedure>

  <note>
   <para>
    默认情况下，SUSE Linux Enterprise Server 15 SP3 中会启用防火墙。有关防火墙配置的详细信息，请参见<xref linkend="storage-bp-net-firewall"/>。
   </para>
  </note>

  <para>
   请注意以下几点事项：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     对象网关的主机名和端口号是自动确定的。
    </para>
   </listitem>
   <listitem>
    <para>
     如果使用多个区域，对象网关会自动确定主区域组和主区域内的主机。此方式足以满足大部分设置的需求，但在某些情况下，您可能需要手动设置主机名和端口：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-host <replaceable>HOST</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-port <replaceable>PORT</replaceable>
</screen>
   </listitem>
   <listitem>
    <para>
     下面是您可能需要进行的额外设置：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-scheme <replaceable>SCHEME</replaceable>  # http or https
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-admin-resource <replaceable>ADMIN_RESOURCE</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-user-id <replaceable>USER_ID</replaceable>
</screen>
   </listitem>
   <listitem>
    <para>
     如果您在对象网关设置中使用的是自我签名证书（<xref linkend="dashboard-ssl"/>），请在仪表盘中禁用证书验证，以免发生因证书是由未知 CA 签名或与主机名不符而导致连接被拒。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-ssl-verify False
</screen>
   </listitem>
   <listitem>
    <para>
     如果对象网关处理请求所花的时间过长，导致仪表盘超时，则可调整超时值（默认为 45 秒）：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rest-requests-timeout <replaceable>SECONDS</replaceable>
</screen>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="dashboard-iscsi-management">
  <title>启用 iSCSI 管理</title>

  <para>
   Ceph Dashboard 使用 Ceph iSCSI 网关的 <systemitem class="service">rbd-target-api</systemitem> 服务所提供的 REST API 管理 iSCSI 目标。确保已在 iSCSI 网关上安装并启用它。
  </para>

  <note>
   <para>
    Ceph Dashboard 的 iSCSI 管理功能取决于 <literal>ceph-iscsi</literal> 项目的最新版本 3。请确保您的操作系统提供了正确的版本，否则 Ceph Dashboard 将无法启用管理功能。
   </para>
  </note>

  <para>
   如果 <literal>ceph-iscsi</literal> REST API 以 HTTPS 模式配置并使用自我签名证书，请配置仪表盘以避免在访问 ceph-iscsi API 时发生 SSL 证书验证。
  </para>

  <para>
   禁用 API SSL 验证：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard set-iscsi-api-ssl-verification false</screen>

  <para>
   定义可用的 iSCSI 网关：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-list
<prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-add <replaceable>scheme</replaceable>://<replaceable>username</replaceable>:<replaceable>password</replaceable>@<replaceable>host</replaceable>[:port]
<prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-rm <replaceable>gateway_name</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="dashboard-sso">
  <title>启用单点登录</title>

  <para>
   <emphasis>单点登录</emphasis> (SSO) 是一种允许用户以单个 ID 和密码同时登录多个应用的访问控制方法。
  </para>

  <para>
   Ceph Dashboard 支持通过 SAML 2.0 协议对用户进行外部身份验证。由于<emphasis>授权</emphasis>仍由仪表盘执行，因此您需要先创建用户帐户并将其与所需角色相关联。不过，<emphasis>身份验证</emphasis>过程可由现有<emphasis>身份提供者</emphasis> (IdP) 执行。
  </para>

  <para>
   要配置单点登录，请使用以下命令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso setup saml2 <replaceable>CEPH_DASHBOARD_BASE_URL</replaceable> \
 <replaceable>IDP_METADATA</replaceable> <replaceable>IDP_USERNAME_ATTRIBUTE</replaceable> \
 <replaceable>IDP_ENTITY_ID</replaceable> <replaceable>SP_X_509_CERT</replaceable> \
 <replaceable>SP_PRIVATE_KEY</replaceable>
</screen>

  <para>
   参数：
  </para>

  <variablelist>
   <varlistentry>
    <term><replaceable>CEPH_DASHBOARD_BASE_URL</replaceable></term>
    <listitem>
     <para>
      可用于访问 Ceph Dashboard 的基本 URL（例如“https://cephdashboard.local”）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_METADATA</replaceable></term>
    <listitem>
     <para>
      IdP 元数据 XML 的 URL、文件路径或内容（例如“https://myidp/metadata”）。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_USERNAME_ATTRIBUTE</replaceable></term>
    <listitem>
     <para>
      可选。将用于从身份验证响应中获取用户名的属性。默认为“uid”。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_ENTITY_ID</replaceable></term>
    <listitem>
     <para>
      可选。当 IdP 元数据上存在多个实体 ID 时，请使用该参数。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>SP_X_509_CERT</replaceable> / <replaceable>SP_PRIVATE_KEY</replaceable></term>
    <listitem>
     <para>
      可选。Ceph Dashboard（服务提供程序）进行签名和加密时将使用的证书的文件路径或内容。活动的 Ceph Manager 实例需要能访问这些文件路径。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <note>
   <title>SAML 请求</title>
   <para>
    SAML 请求的发出者值将采用以下格式：
   </para>
<screen>
<replaceable>CEPH_DASHBOARD_BASE_URL</replaceable>/auth/saml2/metadata
</screen>
  </note>

  <para>
   要显示当前 SAML 2.0 配置，请运行以下命令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso show saml2
</screen>

  <para>
   要禁用单点登录，请运行以下命令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso disable
</screen>

  <para>
   要检查是否启用了 SSO，请运行以下命令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso status
</screen>

  <para>
   要启用 SSO，请运行以下命令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso enable saml2
</screen>
 </sect1>
</chapter>
