<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Exécution des services Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>oui</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Vous pouvez exécuter les services Ceph au niveau d'un daemon, d'un noeud ou d'une grappe. Selon l'approche dont vous avez besoin, utilisez cephadm ou la commande <command>systemctl</command>.
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>Exécution de services individuels</title>

  <para>
   Si vous devez exécuter un service spécifique, commencez par l'identifier :
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   Pour identifier un service sur un noeud spécifique, exécutez :
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   Par exemple :
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    La commande <command>ceph orch ps</command> prend en charge plusieurs formats de sortie. Pour changer de format, ajoutez l'option <option>--format <replaceable>FORMAT</replaceable></option>, <replaceable>FORMAT</replaceable> correspondant au format <literal>json</literal>, <literal>json-pretty</literal> ou <literal>yaml</literal>. Par exemple :
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   Une fois que vous connaissez le nom du service, vous pouvez le démarrer, le redémarrer ou l'arrêter :
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   Par exemple, pour redémarrer le service OSD avec l'ID 0, exécutez :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>Exécution de types de service</title>

  <para>
   Si vous devez exécuter un type de service spécifique sur l'ensemble de la grappe Ceph, utilisez la commande suivante :
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   Remplacez <replaceable>COMMAND</replaceable> par <literal>start</literal>, <literal>stop</literal> ou <literal>restart</literal>.
  </para>

  <para>
   Par exemple, la commande suivante permet de redémarrer toutes les instances MON de la grappe, quels que soient les noeuds sur lesquels elles s'exécutent :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>Exécution de services sur un seul noeud</title>

  <para>
   La commande <command>systemctl</command> permet d'exécuter des cibles et des services <systemitem class="daemon">systemd</systemitem> associés à Ceph sur un seul noeud.
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identification des services et des cibles</title>
   <para>
    Avant d'exécuter des cibles et des services <systemitem class="daemon">systemd</systemitem> associés à Ceph, vous devez identifier les noms de leurs fichiers unité. Les noms de fichier des services se présentent comme suit :
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    Par exemple :
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       ID unique de la grappe Ceph. Celui-ci figure dans la sortie de la commande <command>ceph fsid</command>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       Type du service, par exemple <literal>osd</literal>, <literal>mon</literal> ou <literal>rgw</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       Chaîne d'identification du service. Pour les OSD, il s'agit du numéro d'ID du service. Pour les autres services, il peut s'agir d'un nom d'hôte du noeud ou d'autres chaînes pertinentes pour le type de service.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     La partie <replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable> est identique au contenu de la colonne <literal>NAME</literal> dans la sortie de la commande <command>ceph orch ps</command>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Exécution de l'ensemble des services sur un noeud</title>
   <para>
    Les cibles <systemitem class="daemon">systemd</systemitem> de Ceph permettent d'exécuter simultanément <emphasis>tous</emphasis> les services sur un noeud ou tous les services <emphasis>appartenant à une grappe</emphasis> identifiée par son <replaceable>FSID</replaceable>.
   </para>
   <para>
    Par exemple, pour arrêter tous les services Ceph sur un noeud, quelle que soit la grappe à laquelle ils appartiennent, exécutez :
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    Pour redémarrer tous les services appartenant à une grappe Ceph avec l'ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, exécutez :
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>Exécution d'un service spécifique sur un noeud</title>
   <para>
    Après avoir identifié le nom d'un service spécifique, exécutez-le comme suit :
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    Par exemple, pour redémarrer un seul service OSD avec l'ID 1 sur une grappe avec l'ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, exécutez :
   </para>
<screen><prompt role="root">root # </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Vérification de l'état des services</title>
   <para>
    Vous pouvez interroger <systemitem class="daemon">systemd</systemitem> pour connaître l'état des services. Par exemple :
   </para>
<screen><prompt role="root">root # </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Arrêt et redémarrage de l'ensemble de la grappe Ceph</title>

  <para>
   Une panne de courant programmée peut nécessiter l'arrêt et le redémarrage de la grappe. Pour arrêter tous les services associés à Ceph et redémarrer sans problème, suivez les étapes ci-dessous.
  </para>

  <procedure>
   <title>Arrêt de l'ensemble de la grappe Ceph</title>
   <step>
    <para>
     Arrêtez ou déconnectez tous les clients qui accèdent à la grappe.
    </para>
   </step>
   <step>
    <para>
     Pour empêcher CRUSH de rééquilibrer automatiquement la grappe, définissez la grappe sur <literal>noout</literal> :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     Arrêtez tous les services Ceph sur tous les noeuds de la grappe :
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     Mettez tous les noeuds de grappe hors tension :
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>Démarrage de l'ensemble de la grappe Ceph</title>
   <step>
    <para>
     Mettez le noeud Admin sous tension.
    </para>
   </step>
   <step>
    <para>
     Mettez les noeuds Ceph Monitor sous tension.
    </para>
   </step>
   <step>
    <para>
     Mettez les noeuds Ceph OSD sous tension.
    </para>
   </step>
   <step>
    <para>
     Désélectionnez l'option <literal>noout</literal> préalablement sélectionnée :
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     Mettez toutes les passerelles configurées sous tension.
    </para>
   </step>
   <step>
    <para>
     Mettez sous tension ou connectez les clients de la grappe.
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
