<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha-ceph-nfsganesha">

 <title>NFS Ganesha</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  NFS Ganesha est un serveur NFS qui s&apos;exécute dans un espace d&apos;adressage utilisateur et non pas dans le kernel du système d&apos;exploitation. Avec NFS Ganesha, vous pouvez brancher votre propre mécanisme de stockage, tel que Ceph, et y accéder depuis n&apos;importe quel client NFS. Pour connaître la procédure d&apos;installation, reportez-vous au <xref linkend="deploy-cephadm-day2-service-nfs"/>.
 </para>
 <note>
  <title>performances de NFS Ganesha</title>
  <para>
   En raison du overhead accru du protocole et de la latence supplémentaire causée par des sauts de réseau additionnels entre le client et le stockage, l&apos;accès à Ceph via NFS Gateway peut réduire considérablement les performances de l&apos;application par rapport aux clients CephFS natifs.
  </para>
 </note>
 <para>
  Chaque service NFS Ganesha se compose d&apos;une hiérarchie de configuration contenant :
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Un fichier Bootstrap <filename>ganesha.conf</filename>
   </para>
  </listitem>
  <listitem>
   <para>
    Un objet de configuration commun RADOS par service
   </para>
  </listitem>
  <listitem>
   <para>
    Un objet de configuration RADOS par exportation
   </para>
  </listitem>
 </itemizedlist>
 <para>
  La configuration Bootstrap est la configuration minimale pour démarrer le daemon <systemitem class="daemon">nfs-ganesha</systemitem> dans un conteneur. Chaque configuration Bootstrap contient une directive <literal>%url</literal> qui inclut toute configuration supplémentaire de l&apos;objet de configuration commun RADOS. L&apos;objet de configuration commun peut inclure des directives <literal>%url</literal> supplémentaires pour chacune des exportations NFS définies dans les objets de configuration RADOS d&apos;exportation.
 </para>
 <figure>
  <title>Structure de NFS Ganesha</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
  </mediaobject>
 </figure>
 <sect1 xml:id="ceph-nfsganesha-nfservice">
  <title>Création d&apos;un service NFS</title>

  <para>
   La méthode recommandée pour spécifier le déploiement des services Ceph consiste à créer un fichier au format YAML spécifiant les services que vous avez l&apos;intention de déployer. Vous pouvez créer un fichier de spécification distinct pour chaque type de service ou spécifier plusieurs (ou tous les) types de services dans un seul fichier.
  </para>

  <para>
   Selon ce que vous avez choisi de faire, vous devrez mettre à jour ou créer un fichier au format YAML approprié pour créer un service NFS Ganesha. Pour en savoir plus sur la création du fichier, reportez-vous au <xref linkend="cephadm-service-and-placement-specs"/>.
  </para>

  <para>
   Une fois le fichier mis à jour ou créé, exécutez la commande suivante pour créer un service <literal>nfs-ganesha</literal> :
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>FILE_NAME</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-services">
  <title>Démarrage ou redémarrage de NFS Ganesha</title>

  <important>
   <para>
    Le démarrage du service NFS Ganesha n&apos;exporte pas automatiquement un système de fichiers CephFS. Pour exporter un système de fichiers CephFS, créez un fichier de configuration d&apos;exportation. Pour plus d&apos;informations, reportez-vous à la <xref linkend="ceph-nfsganesha-create-export"/>.
   </para>
  </important>

  <para>
   Pour démarrer le service NFS Ganesha, exécutez :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch start nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Pour redémarrer le service NFS Ganesha, exécutez :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Si vous ne souhaitez redémarrer qu&apos;un seul daemon NFS Ganesha, exécutez :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   Lorsque NFS Ganesha est démarré ou redémarré, le délai de grâce est de 90 secondes pour NFS v4. Au cours de cette période bonus, les nouvelles requêtes provenant des clients sont activement rejetées. Par conséquent, les clients peuvent être confrontés au ralentissement des requêtes lorsque NFS se trouve dans la période bonus.
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-list-objects">
  <title>Liste des objets dans la réserve de récupération NFS</title>

  <para>
   Exécutez la commande suivante pour lister les objets figurant dans la réserve de récupération NFS :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> ls</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-create-export">
  <title>Création d&apos;une exportation NFS</title>

  <para>
   Vous pouvez créer une exportation NFS dans le tableau de bord Ceph ou manuellement sur la ligne de commande. Pour créer l&apos;exportation à l&apos;aide du tableau de bord Ceph, reportez-vous au <xref linkend="dash-webui-nfs"/> et en particulier à la <xref linkend="dash-webui-nfs-create"/>.
  </para>

  <para>
   Pour créer manuellement une exportation NFS, créez un fichier de configuration à exporter. Par exemple, un fichier <filename>/tmp/export-1</filename> avec le contenu suivant :
  </para>

<screen>
EXPORT {
    export_id = 1;
    path = "/";
    pseudo = "/";
    access_type = "RW";
    squash = "no_root_squash";
    protocols = 3, 4;
    transports = "TCP", "UDP";
    FSAL {
        name = "CEPH";
        user_id = "admin";
        filesystem = "a";
        secret_access_key = "<replaceable>SECRET_ACCESS_KEY</replaceable>";
    }
}
</screen>

  <para>
   Après avoir créé et enregistré le fichier de configuration pour la nouvelle exportation, exécutez la commande suivante pour créer l&apos;exportation :
  </para>

<screen>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> put <replaceable>EXPORT_NAME</replaceable> <replaceable>EXPORT_CONFIG_FILE</replaceable></screen>

  <para>
   Par exemple :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool example_pool --namespace example_namespace put export-1 /tmp/export-1</screen>

  <note>
   <para>
    Le bloc FSAL doit être modifié pour inclure l&apos;ID utilisateur <systemitem class="service">cephx</systemitem> et la clé d&apos;accès secrète souhaités.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-verify">
  <title>Vérification de l&apos;exportation NFS</title>

  <para>
   NFS v4 crée une liste d&apos;exportations à la racine d&apos;un pseudo-système de fichiers. Vous pouvez vérifier que les partages NFS sont exportés en montant <filename>/</filename> du noeud du serveur NFS Ganesha :
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable>
<prompt role="root"># </prompt><command>ls</command> <replaceable>/path/to/local/mountpoint</replaceable> cephfs</screen>

  <note>
   <title>NFS Ganesha est uniquement v4</title>
   <para>
    Par défaut, cephadm configurera un serveur NFS v4. NFS v4 n&apos;interagit pas avec <literal>rpcbind</literal> ni avec le daemon <literal>mountd</literal>. Les outils de client NFS, tels que <command>showmount</command> n&apos;afficheront aucune exportation configurée.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-mount">
  <title>Montage de l&apos;exportation NFS</title>

  <para>
   Pour monter le partage NFS exporté sur un hôte client, exécutez :
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-customrole">
  <title>Plusieurs grappes NFS Ganesha</title>

  <para>
   Plusieurs grappes NFS Ganesha peuvent être définies. Cela permet :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     À des grappes NFS Ganesha distinctes d&apos;accéder à CephFS.
    </para>
   </listitem>
  </itemizedlist>


 </sect1>
</chapter>
