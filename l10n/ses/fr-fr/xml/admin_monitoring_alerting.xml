<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_monitoring_alerting.xml" version="5.0" xml:id="monitoring-alerting">
 <title>Surveillance et alertes</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Dans SUSE Enterprise Storage 7.1, cephadm déploie une pile de surveillance et d&apos;alerte. Les utilisateurs doivent soit définir les services (p. ex., Prometheus, Alertmanager et Grafana) qu&apos;ils souhaitent déployer à l&apos;aide de cephadm dans un fichier de configuration YAML, soit utiliser l&apos;interface de ligne de commande pour les déployer. En cas de déploiement de plusieurs services du même type, une configuration hautement disponible est déployée. Le service Node exporter fait figure d&apos;exception à cette règle.
 </para>
 <para>
  Les services de surveillance suivants peuvent être déployés à l&apos;aide de cephadm :
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis role="bold">Prometheus</emphasis> est le toolkit de surveillance et d&apos;alerte. Il collecte les données fournies par les exportateurs Prometheus et déclenche les alertes préconfigurées lorsque les seuils prédéfinis sont atteints.
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">Alertmanager</emphasis> traite les alertes envoyées par le serveur Prometheus. Il déduplique les alertes, les regroupe et les achemine vers le récepteur approprié. Par défaut, Ceph Dashboard est automatiquement configuré en tant que récepteur.
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">Grafana</emphasis> est le logiciel de visualisation et d&apos;alerte. La fonctionnalité d&apos;alerte de Grafana n&apos;est pas utilisée par cette pile de surveillance. Pour les alertes, le service Alertmanager est utilisé.
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">Node exporter</emphasis> est un exportateur pour Prometheus qui fournit des données à propos du noeud sur lequel il est installé. Il est recommandé d&apos;installer Node exporter sur tous les noeuds.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Le module Prometheus Manager fournit un exportateur Prometheus pour transmettre les compteurs de performance Ceph à partir du point de collecte dans <literal>ceph-mgr</literal>.
 </para>
 <para>
  La configuration de Prometheus, y compris les cibles de <emphasis>récupération</emphasis> (mesures fournissant des daemons), est définie automatiquement par cephadm. cephadm déploie également une liste d&apos;alertes par défaut, par exemple <literal>health error</literal> (erreur de santé), <literal>10% OSDs down</literal> (10 % OSD arrêtés) ou <literal>pgs inactive</literal> (GP inactifs).
 </para>
 <para>
  Par défaut, le trafic vers Grafana est chiffré par TLS. Vous pouvez fournir votre propre certificat TLS ou utiliser un certificat auto-signé. Si aucun certificat personnalisé n&apos;a été configuré avant le déploiement de Grafana, un certificat auto-signé est automatiquement créé et configuré pour Grafana.
 </para>
 <para>
  Vous pouvez configurer des certificats personnalisés pour Grafana en procédant comme suit :
 </para>
 <procedure>
  <step>
   <para>
    Configurez les fichiers de certificat :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt> ceph config-key set mgr/cephadm/grafana_key -i $PWD/key.pem
<prompt>cephuser@adm &gt; </prompt> ceph config-key set mgr/cephadm/grafana_crt -i $PWD/certificate.pem
</screen>
  </step>
  <step>
   <para>
    Redémarrez le service Ceph Manager :
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mgr</screen>
  </step>
  <step>
   <para>
    Reconfigurez le service Grafana pour refléter les nouveaux chemins de certificat et définissez l&apos;URL correcte pour Ceph Dashboard :
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch reconfig grafana</screen>
  </step>
 </procedure>
 <para>
  Alertmanager gère les alertes envoyées par le serveur Prometheus. Il s&apos;occupe de les dédupliquer, de les regrouper et de les acheminer vers le bon récepteur. Les alertes peuvent être désactivées à l&apos;aide d&apos;Alertmanager, mais les silences peuvent également être gérés au moyen de Ceph Dashboard.
 </para>
 <para>
  Il est recommandé de déployer <systemitem class="daemon">Node exporter</systemitem> sur tous les noeuds. Pour ce faire, vous pouvez utiliser le fichier <filename>monitoring.yaml</filename> avec le type de service <literal>node-exporter</literal>. Pour plus d&apos;informations sur le déploiement des services, reportez-vous au <xref linkend="deploy-cephadm-day2-service-monitoring"/>.
 </para>
 <sect1 xml:id="monitoring-custom-images">
  <title>Configuration d&apos;images personnalisées ou locales</title>

  <tip>
   <para>
    Cette section explique comment modifier la configuration des images de conteneur utilisées lors du déploiement ou de la mise à jour de services. Elle n&apos;inclut pas les commandes nécessaires au déploiement ou au redéploiement des services.
   </para>
   <para>
    La méthode recommandée pour déployer la pile de surveillance consiste à appliquer sa spécification comme décrit dans le <xref linkend="deploy-cephadm-day2-service-monitoring"/>.
   </para>
  </tip>

  <para>
   Pour déployer des images de conteneur personnalisées ou locales, celles-ci doivent être définies dans cephadm. Pour ce faire, vous devez exécuter la commande suivante :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/cephadm/<replaceable>OPTION_NAME</replaceable> <replaceable>VALUE</replaceable></screen>

  <para>
   Dans laquelle <replaceable>OPTION_NAME</replaceable> correspond à l&apos;un des noms suivants :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     container_image_prometheus
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_node_exporter
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_alertmanager
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_grafana
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Si aucune option n&apos;est définie ou si le paramètre a été supprimé, les images suivantes sont utilisées comme <replaceable>VALUE</replaceable> :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/prometheus-server:2.32.1
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/prometheus-node-exporter:1.1.2
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/prometheus-alertmanager:0.21.0
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/grafana:7.5.12
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Par exemple :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/cephadm/container_image_prometheus prom/prometheus:v1.4.1</screen>

  <note>
   <para>
    Si vous définissez une image personnalisée, la valeur par défaut sera remplacée (mais pas écrasée). La valeur par défaut change lorsque des mises à jour sont disponibles. Si vous définissez une image personnalisée, vous ne pourrez pas mettre à jour automatiquement le composant pour lequel vous avez configuré l&apos;image personnalisée. Vous devez mettre à jour manuellement la configuration (nom de l&apos;image et balise) pour pouvoir installer des mises à jour.
   </para>
   <para>
    Si vous choisissez plutôt de suivre les recommandations, vous pouvez réinitialiser l&apos;image personnalisée que vous avez définie auparavant, après quoi la valeur par défaut sera de nouveau utilisée. Utilisez <command>ceph config rm</command> pour réinitialiser l&apos;option de configuration :
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config rm mgr mgr/cephadm/<replaceable>OPTION_NAME</replaceable></screen>
   <para>
    Par exemple :
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config rm mgr mgr/cephadm/container_image_prometheus</screen>
  </note>
 </sect1>
 <sect1 xml:id="monitoring-applying-updates">
  <title>Mise à jour des services de surveillance</title>

  <para>
   Comme indiqué dans la <xref linkend="monitoring-custom-images"/>, cephadm est fourni avec les URL des images de conteneur recommandées et testées, lesquelles sont utilisées par défaut.
  </para>

  <para>
   Si vous mettez à jour les paquetages Ceph, de nouvelles versions de ces URL peuvent être fournies. Cette opération met simplement à jour l&apos;emplacement à partir duquel les images de conteneur sont extraites, mais ne met à jour aucun service.
  </para>

  <para>
   Une fois les URL des nouvelles images de conteneur mises à jour, que ce soit manuellement comme décrit dans la <xref linkend="monitoring-custom-images"/> ou automatiquement via une mise à jour du paquetage Ceph, les services de surveillance peuvent être mis à jour.
  </para>

  <para>
   Pour ce faire, utilisez <command>ceph orch reconfig</command> comme suit :
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig node-exporter
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig prometheus
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig alertmanager
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig grafana
</screen>

  <para>
   Il n&apos;existe actuellement aucune commande unique permettant de mettre à jour tous les services de surveillance. L&apos;ordre dans lequel ces services sont mis à jour n&apos;a pas d&apos;importance.
  </para>

  <note>
   <para>
    Si vous utilisez des images de conteneur personnalisées, les URL spécifiées pour les services de surveillance ne seront pas modifiées automatiquement en cas de mise à jour des paquetages Ceph. Si vous avez spécifié des images de conteneur personnalisées, vous devrez indiquer manuellement les URL des nouvelles images de conteneur, notamment si vous utilisez un registre local de conteneurs.
   </para>
   <para>
    Les URL des images de conteneur recommandées à utiliser sont indiquées dans la <xref linkend="monitoring-custom-images"/>.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="monitoring-stack-disable">
  <title>Désactivation de la surveillance</title>

  <para>
   Pour désactiver la pile de surveillance, exécutez les commandes suivantes :
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch rm grafana
<prompt>cephuser@adm &gt; </prompt>ceph orch rm prometheus --force   # this will delete metrics data collected so far
<prompt>cephuser@adm &gt; </prompt>ceph orch rm node-exporter
<prompt>cephuser@adm &gt; </prompt>ceph orch rm alertmanager
<prompt>cephuser@adm &gt; </prompt>ceph mgr module disable prometheus
      </screen>
 </sect1>
 <sect1 xml:id="monitoring-grafana-config">
  <title>Configuration de Grafana</title>

  <para>
   Le back-end Ceph Dashboard a besoin de l&apos;URL de Grafana pour pouvoir vérifier l&apos;existence des tableaux de bord Grafana avant même que le front-end ne les charge. En raison de la nature de l&apos;implémentation de Grafana dans Ceph Dashboard, cela signifie que deux connexions fonctionnelles sont nécessaires pour pouvoir afficher les graphiques Grafana dans Ceph Dashboard :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Le back-end (module Ceph MGR) doit vérifier l&apos;existence du graphique demandé. Si cette requête aboutit, il informe le front-end qu&apos;il peut accéder à Grafana en toute sécurité.
    </para>
   </listitem>
   <listitem>
    <para>
     Le front-end demande alors les graphiques Grafana directement à partir du navigateur de l&apos;utilisateur à l&apos;aide d&apos;une <literal>iframe</literal>. L&apos;instance Grafana est accessible directement, sans détour, via Ceph Dashboard.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Cela dit, il se peut qu&apos;en raison de votre environnement, le navigateur de l&apos;utilisateur puisse difficilement accéder directement à l&apos;URL configurée dans Ceph Dashboard. Pour résoudre ce problème, vous pouvez configurer une URL distincte qui sera uniquement utilisée pour indiquer au front-end (le navigateur de l&apos;utilisateur) l&apos;URL à utiliser pour accéder à Grafana.
  </para>

  <para>
   Pour modifier l&apos;URL renvoyée au front-end, exécutez la commande suivante :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard set-grafana-frontend-api-url <replaceable>GRAFANA-SERVER-URL</replaceable></screen>

  <para>
   Si aucune valeur n&apos;est définie pour cette option, elle sera simplement redéfinie sur la valeur de l&apos;option <replaceable>Grafana_API_URL</replaceable>, laquelle est définie automatiquement et mise à jour périodiquement par cephadm. Si elle est définie, elle indiquera au navigateur d&apos;utiliser cette URL pour accéder à Grafana.
  </para>
 </sect1>
 <sect1 xml:id="monitoring-cephadm-config">
  <title>Configuration du module Prometheus Manager</title>

  <para>
   Le module Prometheus Manager est un module intégré à Ceph qui étend les fonctionnalités de Ceph. Le module lit les (méta)données de Ceph concernant son état et sa santé, et fournit à Prometheus les données (récupérées) dans un format exploitable.
  </para>

  <note>
   <para>
    Le module Prometheus Manager doit être redémarré pour que les modifications apportées à la configuration soient appliquées.
   </para>
  </note>

  <sect2 xml:id="monitoring-http-requests">
   <title>Configuration de l&apos;interface réseau</title>
   <para>
    Par défaut, le module Prometheus Manager accepte les requêtes HTTP sur le port 9283 sur toutes les adresses IPv4 et IPv6 de l&apos;hôte. Le port et l&apos;adresse d&apos;écoute peuvent être configurés avec <option>ceph config-key set</option>, avec les clés <option>mgr/prometheus/server_addr</option> et <option>mgr/prometheus/server_port</option>. Ce port est inscrit dans le registre de Prometheus.
   </para>
   <para>
    Pour mettre à jour le paramètre <literal>server_addr</literal>, exécutez la commande suivante :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/server_addr <replaceable>0.0.0.0</replaceable>
      </screen>
   <para>
    Pour mettre à jour le paramètre <literal>server_port</literal>, exécutez la commande suivante :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/server_port <replaceable>9283</replaceable>
      </screen>
  </sect2>

  <sect2 xml:id="monitoring-scrape-intervals">
   <title>Configuration du paramètre <literal>scrape_interval</literal></title>
   <para>
    Par défaut, le module Prometheus Manager est configuré avec un intervalle de récupération de 15 secondes. Nous vous déconseillons d&apos;utiliser un intervalle de récupération inférieur à 10 secondes. Pour configurer un intervalle de récupération différent dans le module Prometheus, définissez le paramètre <literal>scrape_interval</literal> sur la valeur souhaitée :
   </para>
   <important>
    <para>
     Pour fonctionner correctement et ne causer aucun problème, le paramètre <literal>scrape_interval</literal> de ce module doit toujours être défini de manière à correspondre à l&apos;intervalle de récupération de Prometheus.
    </para>
   </important>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/scrape_interval <replaceable>15</replaceable>
      </screen>
  </sect2>

  <sect2 xml:id="monitoring-stale-cache">
   <title>Configuration du cache</title>
   <para>
    Sur les grandes grappes (plus de 1 000 OSD), le temps nécessaire à la récupération des mesures peut devenir considérable. Sans le cache, le module Prometheus Manager peut surcharger le gestionnaire et causer l&apos;arrêt ou l&apos;absence de réponse des instances de Ceph Manager. Le cache est donc activé par défaut et ne peut pas être désactivé, mais cela signifie qu&apos;il peut devenir obsolète. Le cache est considéré comme obsolète lorsque le temps nécessaire à la récupération des mesures à partir de Ceph dépasse l&apos;intervalle de récupération (<literal>scrape_interval</literal>) configuré.
   </para>
   <para>
    Dans ce cas-là, un avertissement est consigné et le module :
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Répond avec un code d&apos;état HTTP 503 (service non disponible).
     </para>
    </listitem>
    <listitem>
     <para>
      Renvoie le contenu du cache, même s&apos;il est obsolète.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Ce comportement peut être configuré à l&apos;aide des commandes <command>ceph config set</command>.
   </para>
   <para>
    Pour indiquer au module de répondre avec des données potentiellement obsolètes, configurez-le pour qu&apos;il <literal>renvoie</literal> :
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/stale_cache_strategy return</screen>
   <para>
    Pour indiquer au module de répondre avec un message de <literal>service non disponible</literal>, configurez-le pour <literal>échouer</literal> :
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/stale_cache_strategy fail</screen>
  </sect2>

  <sect2 xml:id="monitoring-rbd-image">
   <title>Activation de la surveillance des images RBD</title>
   <para>
    Le module Prometheus Manager peut éventuellement collecter des statistiques d&apos;E/S par image RBD en activant des compteurs de performances d&apos;OSD dynamiques. Les statistiques sont recueillies pour toutes les images figurant dans les réserves spécifiées dans le paramètre de configuration <literal>mgr/prometheus/rbd_stats_pools</literal>.
   </para>
   <para>
    Le paramètre est une liste d&apos;entrées <literal>pool[/namespace]</literal> séparées par des virgules ou des espaces. Si l&apos;espace de noms n&apos;est pas spécifié, les statistiques sont collectées pour tous les espaces de noms de la réserve.
   </para>
   <para>
    Par exemple :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/rbd_stats_pools "<replaceable>pool1,pool2,poolN</replaceable>"
      </screen>
   <para>
    Le module analyse les réserves et espaces de noms spécifiés, établit une liste de toutes les images disponibles et la rafraîchit périodiquement. L&apos;intervalle peut être configuré à l&apos;aide du paramètre <literal>mgr/prometheus/rbd_stats_pools_refresh_interval</literal> (en secondes) et est de 300 secondes (cinq minutes) par défaut.
   </para>
   <para>
    Par exemple, si vous avez modifié et défini l&apos;intervalle de synchronisation sur 10 minutes :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/rbd_stats_pools_refresh_interval <replaceable>600</replaceable>
      </screen>
  </sect2>
 </sect1>
 <sect1 xml:id="prometheus-security-model">
  <title>Modèle de sécurité de Prometheus</title>

  <para>
   Le modèle de sécurité de Prometheus part du principe que les utilisateurs non approuvés ont accès au noeud d&apos;extrémité HTTP et aux journaux de Prometheus. Les utilisateurs non approuvés ont accès à l&apos;ensemble des (méta)données collectées par Prometheus et contenues dans la base de données, ainsi qu&apos;à diverses informations opérationnelles et de débogage.
  </para>

  <para>
   Cependant, l&apos;API HTTP de Prometheus est limitée aux opérations en lecture seule. Les configurations ne peuvent pas être modifiées à l&apos;aide de l&apos;API et les secrets ne sont pas exposés. Prometheus dispose par ailleurs de mesures intégrées pour limiter l&apos;impact des attaques par déni de service.
  </para>
 </sect1>
 <sect1 xml:id="prometheus-webhook-snmp">
  <title>Passerelle SNMP de Prometheus Alertmanager</title>

  <para>
   Si vous voulez être informé des alertes Prometheus via des trappes SNMP, vous pouvez installer la passerelle SNMP de Prometheus Alertmanager via cephadm ou Ceph Dashboard. Pour effectuer cette opération pour SNMPv2c, par exemple, vous devez créer un fichier de spécification de service et de placement incluant le contenu suivant :
  </para>

  <note>
   <para>
    Pour plus d&apos;informations sur les fichiers de service et de placement, reportez-vous au <xref linkend="cephadm-service-and-placement-specs"/>.
   </para>
  </note>

<screen>
service_type: snmp-gateway
service_name: snmp-gateway
placement:
    <replaceable>ADD_PLACEMENT_HERE</replaceable>
spec:
  credentials:
    snmp_community: <replaceable>ADD_COMMUNITY_STRING_HERE</replaceable>
  snmp_destination: <replaceable>ADD_FQDN_HERE</replaceable>:<replaceable>ADD_PORT_HERE</replaceable>
  snmp_version: V2c
</screen>

  <para>
   Vous pouvez également utiliser Ceph Dashboard pour déployer le service de passerelle SNMP pour SNMPv2c et SNMPv3. Pour plus d&apos;informations, reportez-vous à la page <xref linkend="dashboard-cluster-services"/>.
  </para>
 </sect1>
</chapter>
