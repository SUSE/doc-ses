<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_bootstrap.xml" version="5.0" xml:id="deploy-bootstrap">
 <info>
  <title>Déploiement de la grappe Bootstrap à l&apos;aide de <systemitem class="resource">ceph-salt</systemitem></title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Cette section vous guide tout au long du processus de déploiement d&apos;une grappe Ceph de base. Lisez attentivement les sous-sections suivantes et exécutez les commandes incluses dans l&apos;ordre indiqué.
 </para>
 <sect1 xml:id="deploy-cephadm-cephsalt">
  <title>Installation <systemitem class="resource">ceph-salt</systemitem></title>

  <para>
   <systemitem class="resource">ceph-salt</systemitem> fournit des outils pour le déploiement de grappes Ceph gérées par cephdm. <systemitem class="resource">ceph-salt</systemitem> utilise l&apos;infrastructure Salt pour gérer le système d&apos;exploitation (par exemple, les mises à jour logicielles ou la synchronisation horaire) et définir les rôles pour les minions Salt.
  </para>

  <para>
   Sur Salt Master, installez le paquetage <package>ceph-salt</package> :
  </para>

<screen><prompt>root@master # </prompt>zypper install ceph-salt</screen>

  <para>
   La commande ci-dessus a installé <package>ceph-salt-formula</package> en tant que dépendance ayant modifié la configuration de Salt Master en insérant des fichiers supplémentaires dans le répertoire <filename>/etc/salt/master.d</filename>. Pour appliquer les modifications, redémarrez <systemitem class="daemon">salt-master.service</systemitem> et synchronisez les modules Salt :
  </para>

<screen>
<prompt>root@master # </prompt>systemctl restart salt-master.service
<prompt>root@master # </prompt>salt \* saltutil.sync_all
</screen>
 </sect1>
 <sect1 xml:id="deploy-cephadm-configure">
  <title>Configuration des propriétés de grappe</title>

  <para>
   Utilisez la commande <command>ceph-salt config</command> pour configurer les propriétés de base de la grappe.
  </para>

  <important>
   <para>
    Le fichier <filename>/etc/ceph/ceph.conf</filename> est géré par cephadm et les utilisateurs ne doivent <emphasis>pas</emphasis> le modifier. Les paramètres de configuration Ceph doivent être définis à l&apos;aide de la nouvelle commande <command>ceph config</command>. Pour plus d&apos;informations, reportez-vous au <xref linkend="cha-ceph-configuration-db"/>.
   </para>
  </important>

  <sect2 xml:id="deploy-cephadm-configure-shell">
   <title>Utilisation du shell <systemitem class="resource">ceph-salt</systemitem></title>
   <para>
    Si vous exécutez <command> config</command> sans chemin ni sous-commande, vous accédez à un shell <systemitem class="resource">ceph-salt</systemitem>ceph-salt interactif. Le shell est pratique si vous devez configurer plusieurs propriétés dans un seul lot sans devoir saisir la syntaxe complète de la commande.
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config
<prompt>/&gt;</prompt> ls
o- / ............................................................... [...]
  o- ceph_cluster .................................................. [...]
  | o- minions .............................................. [no minions]
  | o- roles ....................................................... [...]
  |   o- admin .............................................. [no minions]
  |   o- bootstrap ........................................... [no minion]
  |   o- cephadm ............................................ [no minions]
  |   o- tuned ..................................................... [...]
  |     o- latency .......................................... [no minions]
  |     o- throughput ....................................... [no minions]
  o- cephadm_bootstrap ............................................. [...]
  | o- advanced .................................................... [...]
  | o- ceph_conf ................................................... [...]
  | o- ceph_image_path .................................. [ no image path]
  | o- dashboard ................................................... [...]
  | | o- force_password_update ................................. [enabled]
  | | o- password ................................................ [admin]
  | | o- ssl_certificate ....................................... [not set]
  | | o- ssl_certificate_key ................................... [not set]
  | | o- username ................................................ [admin]
  | o- mon_ip .................................................. [not set]
  o- containers .................................................... [...]
  | o- registries_conf ......................................... [enabled]
  | | o- registries .............................................. [empty]
  | o- registry_auth ............................................... [...]
  |   o- password .............................................. [not set]
  |   o- registry .............................................. [not set]
  |   o- username .............................................. [not set]
  o- ssh ............................................... [no key pair set]
  | o- private_key .................................. [no private key set]
  | o- public_key .................................... [no public key set]
  o- time_server ........................... [enabled, no server host set]
    o- external_servers .......................................... [empty]
    o- servers ................................................... [empty]
    o- subnet .................................................. [not set]
</screen>
   <para>
    Comme vous pouvez le constater dans la sortie de la commande <systemitem class="resource">ceph-salt</systemitem>ls de <command></command>, la configuration de la grappe est organisée en arborescence. Pour configurer une propriété spécifique de la grappe dans le shell <systemitem class="resource">ceph-salt</systemitem>, deux options s&apos;offrent à vous :
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Exécutez la commande à partir de la position actuelle et entrez le chemin absolu de la propriété comme premier argument :
     </para>
<screen>
<prompt>/&gt;</prompt> /cephadm_bootstrap/dashboard ls
o- dashboard ....................................................... [...]
  o- force_password_update ..................................... [enabled]
  o- password .................................................... [admin]
  o- ssl_certificate ........................................... [not set]
  o- ssl_certificate_key ....................................... [not set]
  o- username .................................................... [admin]
<prompt>/&gt; /cephadm_bootstrap/dashboard/username set ceph-admin</prompt>
Value set.
</screen>
    </listitem>
    <listitem>
     <para>
      Accédez au chemin dont vous devez configurer la propriété et exécutez la commande :
     </para>
<screen>
<prompt>/&gt;</prompt> cd /cephadm_bootstrap/dashboard/
<prompt>/ceph_cluster/minions&gt;</prompt> ls
o- dashboard ....................................................... [...]
  o- force_password_update ..................................... [enabled]
  o- password .................................................... [admin]
  o- ssl_certificate ........................................... [not set]
  o- ssl_certificate_key ....................................... [not set]
  o- username ................................................[ceph-admin]
</screen>
    </listitem>
   </itemizedlist>
   <tip>
    <title>saisie semi-automatique des extraits de configuration</title>
    <para>
     Lorsque vous êtes dans un shell <systemitem class="resource">ceph-salt</systemitem>, vous pouvez utiliser la fonction de saisie semi-automatique similaire à celle d&apos;un shell Linux normal (bash). Il complète les chemins de configuration, les sous-commandes ou les noms des minions Salt. Lors de la saisie semi-automatique d&apos;un chemin de configuration, deux options s&apos;offrent à vous :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Pour laisser le shell terminer un chemin par rapport à votre position actuelle, appuyez deux fois sur la touche TAB <keycap function="tab"/>.
      </para>
     </listitem>
     <listitem>
      <para>
       Pour laisser le shell terminer un chemin absolu, entrez <keycap>/</keycap> et appuyez deux fois sur la touche TAB <keycap function="tab"/>.
      </para>
     </listitem>
    </itemizedlist>
   </tip>
   <tip>
    <title>navigation avec les flèches du clavier</title>
    <para>
     Si vous entrez <command>cd</command> à partir du shell <systemitem class="resource">ceph-salt</systemitem> sans aucun chemin, la commande imprime une structure d&apos;arborescence de la configuration de grappe avec la ligne du chemin actuellement actif. Vous pouvez utiliser les flèches Haut et Bas pour parcourir les différentes lignes. Après avoir confirmé avec la touche <keycap function="enter"/>, le chemin de configuration est remplacé par le dernier chemin actif.
    </para>
   </tip>
   <important>
    <title>convention</title>
    <para>
     Pour assurer la cohérence de la documentation, nous utiliserons une syntaxe de commande unique sans accéder au shell <systemitem class="resource">ceph-salt</systemitem>. Par exemple, vous pouvez répertorier l&apos;arborescence de configuration de la grappe à l&apos;aide de la commande suivante :
    </para>
<screen><prompt>root@master # </prompt>ceph-salt config ls</screen>
   </important>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-minions">
   <title>Ajout de minions Salt</title>
   <para>
    Incluez tout ou partie des minions Salt que vous avez déployés et acceptés au <xref linkend="deploy-salt"/> dans la configuration de la grappe Ceph. Vous pouvez spécifier les minions Salt à l&apos;aide de leur nom complet ou utiliser une expression globale « * » et « ? » pour inclure plusieurs minions Salt simultanément. Utilisez la sous-commande <command>add</command> sous le chemin <literal>/ceph_cluster/minions</literal>. La commande suivante inclut tous les minions Salt acceptés :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt config /ceph_cluster/minions add '*'</screen>
   <para>
    Vérifiez que les minions Salt spécifiés ont été ajoutés :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /ceph_cluster/minions ls
o- minions ................................................. [Minions: 5]
  o- ses-master.example.com .................................. [no roles]
  o- ses-min1.example.com .................................... [no roles]
  o- ses-min2.example.com .................................... [no roles]
  o- ses-min3.example.com .................................... [no roles]
  o- ses-min4.example.com .................................... [no roles]
</screen>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-cephadm">
   <title>Spécification des minions Salt gérés par cephadm</title>
   <para>
    Spécifiez les noeuds qui appartiendront à la grappe Ceph et qui seront gérés par cephadm. Incluez tous les noeuds qui exécuteront les services Ceph ainsi que le noeud Admin :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt config /ceph_cluster/roles/cephadm add '*'</screen>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-admin">
   <title>Spécification du noeud Admin</title>
   <para>
    Le noeud Admin est le noeud sur lequel le fichier de configuration <filename>ceph.conf</filename> et le trousseau de clés Ceph admin sont installés. les commandes liées à Ceph sont généralement exécutées sur le noeud Admin.
   </para>
   <tip>
    <title>noeud Admin et Salt Master sur le même noeud</title>
    <para>
     Dans un environnement homogène dans lequel tous les hôtes ou la plupart d&apos;entre eux appartiennent à SUSE Enterprise Storage, il est recommandé de placer le noeud Admin sur le même hôte que Salt Master.
    </para>
    <para>
     Dans un environnement hétérogène dans lequel une infrastructure Salt héberge plusieurs grappes, par exemple SUSE Enterprise Storage avec SUSE Manager, ne placez <emphasis>pas</emphasis> le noeud Admin sur le même hôte que Salt Master.
    </para>
   </tip>
   <para>
    Pour spécifier le noeud Admin, exécutez la commande suivante :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /ceph_cluster/roles/admin add ses-master.example.com
1 minion added.
<prompt>root@master # </prompt>ceph-salt config /ceph_cluster/roles/admin ls
o- admin ................................................... [Minions: 1]
  o- ses-master.example.com ...................... [Other roles: cephadm]
</screen>
   <tip>
    <title>installation de <filename>ceph.conf</filename> et du trousseau de clés admin sur plusieurs noeuds</title>
    <para>
     Vous pouvez installer le fichier de configuration Ceph et le trousseau de clés admin sur plusieurs noeuds si votre déploiement l&apos;exige. Pour des raisons de sécurité, évitez de les installer sur tous les noeuds de la grappe.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-mon">
   <title>Spécification du premier noeud MON/MGR</title>
   <para>
    Vous devez spécifier quel minion Salt de la grappe va démarrer la grappe. Ce minion sera alors le premier à exécuter les services Ceph Monitor et Ceph Manager.
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /ceph_cluster/roles/bootstrap set ses-min1.example.com
Value set.
<prompt>root@master # </prompt>ceph-salt config /ceph_cluster/roles/bootstrap ls
o- bootstrap ..................................... [ses-min1.example.com]
</screen>
   <para>
    En outre, vous devez spécifier l&apos;adresse IP de démarrage du service MON sur le réseau public pour vous assurer que le paramètre <option>public_network</option> est correctement défini, par exemple :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/mon_ip set 192.168.10.20
</screen>
  </sect2>

  <sect2 xml:id="deploy-cephadm-tuned-profiles">
   <title>Spécification de profils ajustés</title>
   <para>
    Vous devez spécifier quels minions de la grappe ont des profils activement ajustés. Pour ce faire, ajoutez ces rôles explicitement à l&apos;aide des commandes suivantes :
   </para>
   <note>
    <para>
     Un minion ne peut pas cumuler les rôles de <literal>latency</literal> (latence) et <literal>throughput</literal> (débit).
    </para>
   </note>
<screen>
<prompt>root@master # </prompt>ceph-salt config /ceph_cluster/roles/tuned/latency add ses-min1.example.com
Adding ses-min1.example.com...
1 minion added.
<prompt>root@master # </prompt>ceph-salt config /ceph_cluster/roles/tuned/throughput add ses-min2.example.com
Adding ses-min2.example.com...
1 minion added.
</screen>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-ssh">
   <title>Génération d&apos;une paire de clés SSH</title>
   <para>
    cephadm utilise le protocole SSH pour communiquer avec les noeuds de la grappe. Un compte utilisateur nommé <literal>cephadm</literal> est automatiquement créé et utilisé pour la communication SSH.
   </para>
   <para>
    Vous devez générer la partie privée et la partie publique de la paire de clés SSH :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /ssh generate
Key pair generated.
<prompt>root@master # </prompt>ceph-salt config /ssh ls
o- ssh .................................................. [Key Pair set]
  o- private_key ..... [53:b1:eb:65:d2:3a:ff:51:6c:e2:1b:ca:84:8e:0e:83]
  o- public_key ...... [53:b1:eb:65:d2:3a:ff:51:6c:e2:1b:ca:84:8e:0e:83]
</screen>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-ntp">
   <title>Configuration du serveur horaire</title>
   <para>
    L&apos;heure de tous les noeuds de la grappe doit être synchronisée avec une source horaire fiable. Plusieurs scénarios existent pour aborder la synchronisation horaire :
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Si tous les noeuds de la grappe sont déjà configurés pour synchroniser leur heure à l&apos;aide du service NTP de votre choix, désactivez complètement la gestion du serveur horaire :
     </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /time_server disable
</screen>
    </listitem>
    <listitem>
     <para>
      Si votre site possède déjà une seule source horaire, spécifiez le nom d&apos;hôte de la source horaire :
     </para>
<screen>
 <prompt>root@master # </prompt>ceph-salt config /time_server/servers add <replaceable>time-server.example.com</replaceable>
</screen>
    </listitem>
    <listitem>
     <para>
      Dans le cas contraire, <systemitem class="resource">ceph-salt</systemitem> a la possibilité de configurer l&apos;un des minions Salt pour qu&apos;il fasse office de serveur horaire pour le reste de la grappe. Il est parfois appelé « serveur horaire interne ». Dans ce scénario, <systemitem class="resource">ceph-salt</systemitem> configure le serveur horaire interne (qui doit être l&apos;un des minions Salt) pour synchroniser son heure avec celle d&apos;un serveur horaire externe, tel que <literal>pool.ntp.org</literal> et configure tous les autres minions pour obtenir leur heure à partir du serveur horaire interne. Pour ce faire, procédez comme suit :
     </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /time_server/servers add ses-master.example.com
<prompt>root@master # </prompt>ceph-salt config /time_server/external_servers add pool.ntp.org
</screen>
     <para>
      L&apos;option <option>/time_server/subnet</option> spécifie le sous-réseau à partir duquel les clients NTP sont autorisés à accéder au serveur NTP. Elle est définie automatiquement lorsque vous spécifiez <option>/time_server/servers</option>. Si vous devez la modifier ou la spécifier manuellement, exécutez :
     </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /time_server/subnet set 10.20.6.0/24
</screen>
    </listitem>
   </itemizedlist>
   <para>
    Vérifiez les paramètres du serveur horaire :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /time_server ls
o- time_server ................................................ [enabled]
  o- external_servers ............................................... [1]
  | o- pool.ntp.org ............................................... [...]
  o- servers ........................................................ [1]
  | o- ses-master.example.com ..................................... [...]
  o- subnet .............................................. [10.20.6.0/24]
</screen>
   <para>
    Pour plus d&apos;informations sur la configuration de la synchronisation horaire, reportez-vous à l&apos;adresse <link xlink:href="https://documentation.suse.com/sles/15-SP3/html/SLES-all/cha-ntp.html#sec-ntp-yast"/>.
   </para>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-dashboardlogin">
   <title>Configuration des informations d&apos;identification de connexion de Ceph Dashboard</title>
   <para>
    Ceph Dashboard sera disponible après le déploiement de la grappe de base. Pour y accéder, vous devez définir un nom d&apos;utilisateur et un mot de passe valides, par exemple :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/dashboard/username set admin
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/dashboard/password set <replaceable>PWD</replaceable>
</screen>
   <tip>
    <title>mise à jour forcée du mot de passe</title>
    <para>
     Par défaut, le premier utilisateur du tableau de bord est obligé de modifier son mot de passe lors de la première connexion au tableau de bord. Pour désactiver cette fonction, exécutez la commande suivante :
    </para>
<screen><prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/dashboard/force_password_update disable</screen>
   </tip>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-registry">
   <title>Utilisation du registre de conteneurs</title>
   <para>
    La grappe Ceph doit avoir accès à un registre de conteneurs afin de pouvoir télécharger et déployer des services Ceph conteneurisés. Il existe deux façons d&apos;accéder au registre :
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Si votre grappe peut accéder au registre par défaut à l&apos;adresse <literal>registration.suse.com</literal> (directement ou via un proxy), vous pouvez faire pointer <systemitem class="resource">ceph-salt</systemitem> directement vers cette URL sans créer de registre local. Continuez en suivant les étapes de la <xref linkend="deploy-cephadm-configure-imagepath"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      Si votre grappe ne peut pas accéder au registre par défaut (par exemple, pour un déploiement à vide), vous devez configurer un registre de conteneurs local. Une fois le registre local créé et configuré, vous devez faire pointer <systemitem class="resource">ceph-salt</systemitem> sur ce registre.
     </para>
    </listitem>
   </itemizedlist>
   <sect3 xml:id="updating-ceph-local-registry">
    <title>Création et configuration du registre local (facultatif)</title>
    <important>
     <para>
      Il existe de nombreuses méthodes pour créer un registre local. Les instructions de cette section proposent des exemples de création de registres sécurisés et non sécurisés. Pour obtenir des informations générales sur l&apos;exécution d&apos;un registre d&apos;images de conteneur, consultez le site <link xlink:href="https://documentation.suse.com/sles/15-SP3/single-html/SLES-container/#sec-docker-registry-installation"/>.
     </para>
    </important>
    <tip>
     <title>placement et utilisation des ports</title>
     <para>
      Déployez le registre sur une machine accessible par tous les noeuds de la grappe. Nous recommandons le noeud Admin. Par défaut, le registre écoute sur le port 5000.
     </para>
     <para>
      Dans le noeud de registre, utilisez la commande suivante pour vérifier que le port est libre :
     </para>
<screen>ss -tulpn | grep :5000</screen>
     <para>
      Si d&apos;autres processus (tels que <literal>iscsi-tcmu</literal>) écoutent déjà sur le port 5000, définissez un autre port libre qui peut être utilisé pour l&apos;assignation au port 5000 dans le conteneur de registres.
     </para>
    </tip>
    <procedure>
     <title>Création du registre local</title>
     <step>
      <para>
       Vérifiez que l&apos;extension <package>Containers Module</package> est activée :
      </para>
<screen>
<prompt>&gt; </prompt>SUSEConnect --list-extensions | grep -A2 "Containers Module"
Containers Module 15 SP3 x86_64 (Activated)
</screen>
     </step>
     <step>
      <para>
       Vérifiez que les paquetages suivants sont installés : <package>apache2-utils</package> (en cas d&apos;activation d&apos;un registre sécurisé), <package>cni</package>, <package>cni-plugins</package>, <package>podman</package>, <package>podman-cni-config</package> et <package>skopeo</package>.
      </para>
     </step>
     <step>
      <para>
       Réunissez les informations suivantes :
      </para>
      <itemizedlist>
       <listitem>
        <para>
         Nom de domaine complet de l&apos;hôte de registre (<option>REG_HOST_FQDN</option>).
        </para>
       </listitem>
       <listitem>
        <para>
         <option>Numéro de port disponible utilisé pour l&apos;assignation du port 5000 au conteneur de registres (REG_HOST_PORT)</option>
        </para>
       </listitem>
       <listitem>
        <para>
         Si le registre doit être sécurisé ou non (<option>insecure=[true|false]</option>).
        </para>
       </listitem>
      </itemizedlist>
     </step>
     <step>
      <para>
       Pour démarrer un registre non sécurisé (sans chiffrement SSL), procédez comme suit :
      </para>
      <substeps>
       <step>
        <para>
         Configurez <systemitem class="resource">ceph-salt</systemitem> pour le registre non sécurisé :
        </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph-salt config containers/registries_conf enable
<prompt>cephuser@adm &gt; </prompt>ceph-salt config containers/registries_conf/registries \
 add prefix=<option>REG_HOST_FQDN</option> insecure=true \
 location=<option>REG_HOST_PORT</option>:5000
</screen>
       </step>
       <step>
        <para>
         Démarrez le registre non sécurisé en créant le répertoire nécessaire (par exemple, <filename>/var/lib/registry</filename>) et en démarrant le registre avec la commande <command>podman</command> :
        </para>
<screen>
<prompt role="root"># </prompt>mkdir -p /var/lib/registry
<prompt role="root"># </prompt>podman run --privileged -d --name registry \
 -p <option>REG_HOST_PORT</option>:5000 -v /var/lib/registry:/var/lib/registry \
 --restart=always registry:2
</screen>
       </step>
       <step>
        <para>
         Pour que le registre se lance après un redémarrage, créez un fichier d&apos;unité <systemitem class="daemon">systemd</systemitem> et activez-le :
        </para>
<screen>
<prompt>&gt; </prompt><command>sudo</command> podman generate systemd --files --name registry
<prompt>&gt; </prompt><command>sudo</command> mv container-registry.service /etc/systemd/system/
<prompt>&gt; </prompt><command>sudo</command> systemctl enable container-registry.service
</screen>
       </step>
      </substeps>
     </step>
     <step>
      <para>
       Pour démarrer un registre sécurisé, procédez comme suit :
      </para>
      <substeps>
       <step>
        <para>
         Créez les répertoires nécessaires :
        </para>
<screen><prompt role="root"># </prompt>mkdir -p /var/lib/registry/{auth,certs}</screen>
       </step>
       <step>
        <para>
         Générez un certificat SSL :
        </para>
<screen>
<prompt role="root"># </prompt>openssl req -newkey rsa:4096 -nodes -sha256 \
 -keyout /var/lib/registry/certs/domain.key -x509 -days 365 \
 -out /var/lib/registry/certs/domain.crt
</screen>
        <note>
         <para>
          Définissez la valeur <literal>CN=[valeur]</literal> sur le nom de domaine complet de l&apos;hôte ([<option>FQDN_HÔTE_REG</option>]).
         </para>
        </note>
       </step>
       <step>
        <para>
         Copiez le certificat sur tous les noeuds de la grappe et rafraîchissez le cache du certificat :
        </para>
<screen>
<prompt role="root"># </prompt>salt-cp '*' /var/lib/registry/certs/domain.crt \
 /etc/pki/trust/anchors/
<prompt role="root"># </prompt>salt '*' cmd.shell "update-ca-certificates"
</screen>
       </step>
       <step>
        <para>
         Générez une combinaison de nom d&apos;utilisateur et de mot de passe pour l&apos;authentification auprès du registre :
        </para>
<screen>
<prompt role="root"># </prompt>htpasswd2 -bBc /var/lib/registry/auth/htpasswd \
 <option>REG_USERNAME</option> <option>REG_PASSWORD</option>
</screen>
       </step>
       <step>
        <para>
         Démarrez le registre sécurisé. Utilisez le drapeau <option>REGISTRY_STORAGE_DELETE_ENABLED=true</option> pour pouvoir supprimer les images par la suite à l&apos;aide de la commande <command>skopeo delete</command>.
        </para>
<screen>
podman run --name myregistry -p <option>REG_HOST_PORT</option>:5000 \
 -v /var/lib/registry:/var/lib/registry \
 -v /var/lib/registry/auth:/auth:z \
 -e "REGISTRY_AUTH=htpasswd" \
 -e "REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm" \
 -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
 -v /var/lib/registry/certs:/certs:z \
 -e "REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt" \
 -e "REGISTRY_HTTP_TLS_KEY=/certs/domain.key" \
 -e REGISTRY_STORAGE_DELETE_ENABLED=true \
 -e REGISTRY_COMPATIBILITY_SCHEMA1_ENABLED=true -d registry:2
</screen>
       </step>
       <step>
        <para>
         Testez l&apos;accès sécurisé au registre :
        </para>
<screen>
<prompt>&gt; </prompt>curl https://<option>REG_HOST_FQDN</option>:<option>REG_HOST_PORT</option>/v2/_catalog \
 -u <option>REG_USERNAME</option>:<option>REG_PASSWORD</option>
</screen>
       </step>
      </substeps>
     </step>
     <step>
      <para>
       Lorsque le registre local a été créé, vous devez synchroniser les images de conteneur du registre SUSE officiel sur le site <literal>registration.suse.com</literal> avec le registre local. Vous pouvez utiliser la commande <command>skopeo sync</command> trouvée dans le paquetage <package>skopeo</package> à cette fin. Pour plus de détails, reportez-vous à la page de manuel (<command>man 1 skopeo-sync</command>). Prenez en considération les exemples suivants :
      </para>
      <example>
       <title>affichage des fichiers de manifeste</title>
<screen>
skopeo inspect docker://registry.suse.com/ses/7.1/ceph/ceph | jq .RepoTags
skopeo inspect docker://registry.suse.com/ses/7.1/ceph/grafana | jq .RepoTags
skopeo inspect docker://registry.suse.com/ses/7.1/ceph/prometheus-server:2.32.1 | jq .RepoTags
skopeo inspect docker://registry.suse.com/ses/7.1/ceph/prometheus-node-exporter:1.1.2 | jq .RepoTags
skopeo inspect docker://registry.suse.com/ses/7.1/ceph/prometheus-alertmanager:0.21.0 | jq .RepoTags
</screen>
      </example>
      <example>
       <title>synchronisation avec un répertoire</title>
       <para>
        Synchronisez toutes les images Ceph :
       </para>
<screen>skopeo sync --src docker --dest dir registry.suse.com/ses/7.1/ceph/ceph /root/images/</screen>
       <para>
        Synchronisez les dernières images uniquement :
       </para>
<screen>skopeo sync --src docker --dest dir registry.suse.com/ses/7.1/ceph/ceph:latest /root/images/</screen>
      </example>
      <example>
       <title>synchronisation des images Grafana :</title>
<screen>skopeo sync --src docker --dest dir registry.suse.com/ses/7.1/ceph/grafana /root/images/</screen>
       <para>
        Synchronisez uniquement les dernières images Grafana :
       </para>
<screen>skopeo sync --src docker --dest dir registry.suse.com/ses/7.1/ceph/grafana:latest /root/images/</screen>
      </example>
      <example>
       <title>synchronisation des dernières images Prometheus</title>
<screen>
skopeo sync --src docker --dest dir registry.suse.com/ses/7.1/ceph/prometheus-server:2.32.1 /root/images/
skopeo sync --src docker --dest dir registry.suse.com/ses/7.1/ceph/prometheus-node-exporter:1.1.2 /root/images/
skopeo sync --src docker --dest dir registry.suse.com/ses/7.1/ceph/prometheus-alertmanager:0.21.0 /root/images/
</screen>
      </example>
     </step>
    </procedure>
    <procedure>
     <title>configuration du registre local et des informations d&apos;identification d&apos;accès</title>
     <step>
      <para>
       Configurez l&apos;URL du registre local :
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph-salt config /containers/registry_auth/registry set <replaceable>REG_HOST_URL</replaceable></screen>
     </step>
     <step>
      <para>
       Configurez le nom d&apos;utilisateur et le mot de passe pour accéder au registre local :
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph-salt config /containers/registry_auth/username set <replaceable>REG_USERNAME</replaceable></screen>
<screen><prompt>cephuser@adm &gt; </prompt>ceph-salt config /containers/registry_auth/password set <replaceable>REG_PASSWORD</replaceable></screen>
     </step>
    </procedure>
    <tip>
     <title>cache de registre</title>
     <para>
      Pour éviter de resynchroniser le registre local lorsque de nouveaux conteneurs mis à jour apparaissent, vous pouvez configurer un <emphasis>cache de registre</emphasis>.
     </para>
    </tip>
   </sect3>
   <sect3 xml:id="deploy-cephadm-configure-imagepath">
    <title>Configuration du chemin d&apos;accès aux images du conteneur</title>
    <important>
     <para>
      Cette section vous aide à configurer le chemin d&apos;accès aux images de conteneur de la grappe Bootstrap (déploiement de la première paire Ceph Monitor et Ceph Manager). Le chemin d&apos;accès ne s&apos;applique pas aux images de conteneur de services supplémentaires, par exemple, la pile de surveillance.
     </para>
    </important>
    <tip>
     <title>configuration du proxy HTTPS</title>
     <para>
      Si vous devez utiliser un proxy pour communiquer avec le serveur de registre de conteneur, effectuez les étapes de configuration suivantes sur tous les noeuds de grappe :
     </para>
     <procedure>
      <step>
       <para>
        Copiez le fichier de configuration des conteneurs :
       </para>
<screen><prompt>&gt; </prompt><command>sudo</command> cp /usr/share/containers/containers.conf /etc/containers/containers.conf</screen>
      </step>
      <step>
       <para>
        Modifiez le fichier que vous venez de copier et ajoutez le paramètre <option>http_proxy</option> à sa section <literal>[moteur]</literal>, par exemple :
       </para>
<screen><prompt>&gt; </prompt>cat /etc/containers/containers.conf
 [engine]
 http_proxy=proxy.example.com
 [...]
 </screen>
      </step>
     </procedure>
    </tip>
    <para>
     cephadm doit connaître un chemin URI valide vers les images de conteneur. Vérifiez le paramètre par défaut en exécutant
    </para>
<screen><prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_image_path ls</screen>
    <para>
     Si vous n&apos;avez pas besoin d&apos;un autre registre ou d&apos;un registre local, spécifiez le registre de conteneurs SUSE par défaut :
    </para>
<screen><prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_image_path set registry.suse.com/ses/7.1/ceph/ceph</screen>
    <para>
     Si votre déploiement nécessite un chemin d&apos;accès spécifique, par exemple, un chemin d&apos;accès à un registre local, configurez-le comme suit :
    </para>
<screen><prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_image_path set <replaceable>LOCAL_REGISTRY_PATH</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="deploy-cephadm-inflight-encryption">
   <title>Activation du chiffrement des données à la volée (msgr2)</title>
   <para>
    Le protocole Messenger v2 (MSGR2) est le protocole on-wire de Ceph. Il offre un mode de sécurité qui chiffre toutes les données passant sur le réseau, l&apos;encapsulation des charges utiles d&apos;authentification et l&apos;activation de l&apos;intégration future de nouveaux modes d&apos;authentification (tels que Kerberos).
   </para>
   <important>
    <para>
     msgr2 n&apos;est actuellement pas pris en charge par les clients Ceph du kernel Linux, tels que le périphérique de bloc RADOS et CephFS.
    </para>
   </important>
   <para>
    Les daemons Ceph peuvent se lier à plusieurs ports, ce qui permet aux clients Ceph hérités et aux nouveaux clients compatibles v2 de se connecter à la même grappe. Par défaut, les instances MON se lient désormais au nouveau port 3300 assigné par l&apos;IANA (CE4h ou 0xCE4) pour le nouveau protocole v2, tout en se liant également à l&apos;ancien port par défaut 6789 pour le protocole v1 hérité.
   </para>
   <para>
    Le protocole v2 (MSGR2) prend en charge deux modes de connexion :
   </para>
   <variablelist>
    <varlistentry>
     <term>crc mode</term>
     <listitem>
      <para>
       Authentification initiale forte lorsque la connexion est établie et contrôle d&apos;intégrité CRC32C.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>secure mode</term>
     <listitem>
      <para>
       Authentification initiale forte lorsque la connexion est établie et un chiffrement complet de tout le trafic post-authentification, y compris une vérification de l&apos;intégrité cryptographique.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    Pour la plupart des connexions, il existe des options qui contrôlent les modes utilisés :
   </para>
   <variablelist>
    <varlistentry>
     <term>ms_cluster_mode</term>
     <listitem>
      <para>
       Mode de connexion (ou modes autorisés) utilisé(s) pour la communication entre les daemons Ceph au sein de la grappe. Si plusieurs modes sont répertoriés, ceux s&apos;affichant en haut de la liste sont les préférés.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ms_service_mode</term>
     <listitem>
      <para>
       Liste des modes que les clients sont autorisés à utiliser lors de la connexion à la grappe.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ms_client_mode</term>
     <listitem>
      <para>
       Liste des modes de connexion, par ordre de préférence, que les clients peuvent ou sont autorisés à utiliser lorsqu&apos;ils communiquent avec une grappe Ceph.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    Il existe un ensemble parallèle d&apos;options qui s&apos;appliquent spécifiquement aux moniteurs, ce qui permet aux administrateurs de définir d&apos;autres exigences (généralement plus sécurisées) en matière de communication avec les moniteurs.
   </para>
   <variablelist>
    <varlistentry>
     <term>ms_mon_cluster_mode</term>
     <listitem>
      <para>
       Mode de connexion (ou modes autorisés) à utiliser entre les moniteurs.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ms_mon_service_mode</term>
     <listitem>
      <para>
       Liste des modes autorisés que les clients ou les autres daemons Ceph sont autorisés à utiliser lors de la connexion aux moniteurs.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ms_mon_client_mode</term>
     <listitem>
      <para>
       Liste des modes de connexion, par ordre de préférence, que les clients ou les daemons non-moniteurs peuvent utiliser pour se connecter à des moniteurs.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    Pour activer le mode de chiffrement MSGR2 pendant le déploiement, vous devez ajouter certaines options de configuration à la configuration de <systemitem class="resource">ceph-salt</systemitem> avant d&apos;exécuter <command>ceph-salt apply</command>.
   </para>
   <para>
    Pour utiliser le mode <literal>secure</literal>, exécutez les commandes suivantes.
   </para>
   <para>
    Ajoutez la section globale à <filename>ceph_conf</filename> dans l&apos;outil de configuration <systemitem class="resource">ceph-salt</systemitem> :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf add global</screen>
   <para>
    Paramétrez les options suivantes :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf/global set ms_cluster_mode "secure crc"
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf/global set ms_service_mode "secure crc"
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf/global set ms_client_mode "secure crc"
</screen>
   <note>
    <para>
     Vérifiez que <literal>secure</literal> se trouve devant <literal>crc</literal>.
    </para>
   </note>
   <para>
    Pour <emphasis>forcer</emphasis> le mode <literal>secure</literal>, exécutez les commandes suivantes :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf/global set ms_cluster_mode secure
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf/global set ms_service_mode secure
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf/global set ms_client_mode secure
</screen>
   <tip xml:id="update-inflight-encryption-settings">
    <title>mise à jour des paramètres</title>
    <para>
     Si vous souhaitez modifier l&apos;un des paramètres ci-dessus, définissez les modifications à apporter à la configuration dans la zone de stockage de la configuration du moniteur. Pour ce faire, utilisez la commande <command>ceph config set</command>.
    </para>
<screen><prompt>root@master # </prompt>ceph config set global <replaceable>CONNECTION_OPTION</replaceable> <replaceable>CONNECTION_MODE</replaceable> [--force]</screen>
    <para>
     Par exemple :
    </para>
<screen><prompt>root@master # </prompt>ceph config set global ms_cluster_mode "secure crc"</screen>
    <para>
     Si vous souhaitez vérifier la valeur actuelle, y compris la valeur par défaut, exécutez la commande suivante :
    </para>
<screen><prompt>root@master # </prompt>ceph config get <replaceable>CEPH_COMPONENT</replaceable> <replaceable>CONNECTION_OPTION</replaceable></screen>
    <para>
     Par exemple, pour obtenir le mode <literal>ms_cluster_mode</literal> pour les OSD, exécutez :
    </para>
<screen><prompt>root@master # </prompt>ceph config get osd ms_cluster_mode</screen>
   </tip>
  </sect2>

  <sect2 xml:id="deploy-cephadm-enable-network">
   <title>Configuration du réseau de grappes</title>
   <para>
    Éventuellement, si vous exécutez un réseau de grappe distinct, vous devrez peut-être définir l&apos;adresse IP réseau de la grappe suivie de la partie masque de sous-réseau après la barre oblique, par exemple <literal>192.168.10.22/24</literal>.
   </para>
   <para>
    Exécutez les commandes suivantes pour activer <literal>cluster_network</literal> :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf add global
<prompt>root@master # </prompt>ceph-salt config /cephadm_bootstrap/ceph_conf/global set cluster_network <replaceable>NETWORK_ADDR</replaceable>
</screen>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-verify">
   <title>Vérification de la configuration de la grappe</title>
   <para>
    La configuration de grappe minimale est terminée. Inspectez-la pour voir si elle contient des d&apos;erreurs flagrantes :
   </para>
<screen>
<prompt>root@master # </prompt>ceph-salt config ls
o- / ............................................................... [...]
  o- ceph_cluster .................................................. [...]
  | o- minions .............................................. [Minions: 5]
  | | o- ses-master.example.com .................................. [admin]
  | | o- ses-min1.example.com ......................... [bootstrap, admin]
  | | o- ses-min2.example.com ................................. [no roles]
  | | o- ses-min3.example.com ................................. [no roles]
  | | o- ses-min4.example.com ................................. [no roles]
  | o- roles ....................................................... [...]
  |   o- admin .............................................. [Minions: 2]
  |   | o- ses-master.example.com ....................... [no other roles]
  |   | o- ses-min1.example.com ................. [other roles: bootstrap]
  |   o- bootstrap ................................ [ses-min1.example.com]
  |   o- cephadm ............................................ [Minions: 5]
  |   o- tuned ..................................................... [...]
  |     o- latency .......................................... [no minions]
  |     o- throughput ....................................... [no minions]
  o- cephadm_bootstrap ............................................. [...]
  | o- advanced .................................................... [...]
  | o- ceph_conf ................................................... [...]
  | o- ceph_image_path .............. [registry.suse.com/ses/7.1/ceph/ceph]
  | o- dashboard ................................................... [...]
  |   o- force_password_update ................................. [enabled]
  |   o- password ................................... [randomly generated]
  |   o- username ................................................ [admin]
  | o- mon_ip ............................................ [192.168.10.20]
  o- containers .................................................... [...]
  | o- registries_conf ......................................... [enabled]
  | | o- registries .............................................. [empty]
  | o- registry_auth ............................................... [...]
  |   o- password .............................................. [not set]
  |   o- registry .............................................. [not set]
  |   o- username .............................................. [not set]
  o- ssh .................................................. [Key Pair set]
  | o- private_key ..... [53:b1:eb:65:d2:3a:ff:51:6c:e2:1b:ca:84:8e:0e:83]
  | o- public_key ...... [53:b1:eb:65:d2:3a:ff:51:6c:e2:1b:ca:84:8e:0e:83]
  o- time_server ............................................... [enabled]
    o- external_servers .............................................. [1]
    | o- 0.pt.pool.ntp.org ......................................... [...]
    o- servers ....................................................... [1]
    | o- ses-master.example.com .................................... [...]
    o- subnet ............................................. [10.20.6.0/24]
</screen>
   <tip>
    <title>état de la configuration de la grappe</title>
    <para>
     Vous pouvez vérifier si la configuration de la grappe est valide en exécutant la commande suivante :
    </para>
<screen>
<prompt>root@master # </prompt>ceph-salt status
cluster: 5 minions, 0 hosts managed by cephadm
config: OK
</screen>
   </tip>
  </sect2>

  <sect2 xml:id="deploy-cephadm-configure-export">
   <title>Exportation des configurations de grappe</title>
   <para>
    Une fois que vous avez configuré la grappe de base et que sa configuration est valide, il est recommandé d&apos;exporter sa configuration dans un fichier :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt export &gt; cluster.json</screen>
   <warning>
    <para>
     La sortie de l&apos;exportation <command>ceph-salt export</command> inclut la clé privée SSH. Si les implications au niveau de la sécurité vous inquiètent, n&apos;exécutez pas cette commande sans prendre les précautions appropriées.
    </para>
   </warning>
   <para>
    Si vous interrompez la configuration de la grappe et que vous devez rétablir un état de sauvegarde, exécutez :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt import cluster.json</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="deploy-cephadm-deploy">
  <title>Mise à jour des noeuds et de la grappe minimale de démarrage</title>

  <para>
   Avant de déployer la grappe, mettez à jour tous les paquetages logiciels sur l&apos;ensemble des noeuds :
  </para>

<screen><prompt>root@master # </prompt>ceph-salt update</screen>

  <para>
   Si un noeud signale <literal>Reboot is needed</literal> (Redémarrage requis) au cours de la mise à jour, cela signifie que des paquetages de système d&apos;exploitation importants, tels que le kernel, ont été mis à jour vers une version plus récente. Vous devrez alors redémarrer le noeud pour que les modifications soient prises en compte.
  </para>

  <para>
   Pour redémarrer tous les noeuds requis, ajoutez l&apos;option <option>--reboot</option>.
  </para>

<screen><prompt>root@master # </prompt>ceph-salt update --reboot</screen>

  <para>
   Vous pouvez également les redémarrer dans le cadre d&apos;une étape distincte :
  </para>

<screen><prompt>root@master # </prompt>ceph-salt reboot</screen>

  <important>
   <para>
    Salt Master n&apos;est jamais redémarré par les commandes <command>ceph-salt update --reboot</command> ou <command>ceph-salt reboot</command>. Si Salt Master doit être redémarré, vous devez le redémarrer manuellement.
   </para>
  </important>

  <para>
   Une fois les noeuds mis à jour, démarrez la grappe minimale :
  </para>

<screen><prompt>root@master # </prompt>ceph-salt apply</screen>

  <note>
   <para>
    Une fois démarrée, la grappe dispose d&apos;une instance de Ceph Monitor et d&apos;une instance de Ceph Manager.
   </para>
  </note>

  <para>
   La commande ci-dessus ouvre une interface utilisateur interactive qui affiche la progression actuelle de chaque minion.
  </para>

  <figure>
   <title>Déploiement d&apos;une grappe minimale</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="cephadm_deploy.png" width="75%"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="cephadm_deploy.png" width="75%"/>
    </imageobject>
   </mediaobject>
  </figure>

  <tip>
   <title>mode non interactif</title>
   <para>
    Si vous devez appliquer la configuration à partir d&apos;un script, il existe également un mode de déploiement non interactif. Ce mode est aussi utile lors du déploiement de la grappe à partir d&apos;une machine distante, car la mise à jour constante des informations de progression à l&apos;écran sur le réseau risque de vous distraire :
   </para>
<screen><prompt>root@master # </prompt>ceph-salt apply --non-interactive</screen>
  </tip>
 </sect1>
 <sect1 xml:id="deploy-min-cluster-final-steps">
  <title>Examen des dernières étapes</title>

  <para>
   Une fois la commande <command>ceph-salt apply</command> exécutée, vous devez disposer d&apos;une instance de Ceph Monitor et d&apos;une instance de Ceph Manager. Vous devriez pouvoir exécuter la commande <command>ceph status</command> sur n&apos;importe quel minion ayant reçu le rôle <literal>admin</literal> en tant que <literal>root</literal> ou sur l&apos;utilisateur de <literal>cephadm</literal> à l&apos;aide de <literal>sudo</literal>.
  </para>

  <para>
   Pour les étapes suivantes, vous devrez utiliser cephadm pour déployer des instances Ceph Monitor ou Ceph Manager, des OSD, la pile de surveillance et des passerelles supplémentaires.
  </para>

  <para>
   Avant de continuer, passez en revue les paramètres réseau de votre nouvelle grappe. À ce stade, le paramètre <literal>public_network</literal> a été renseigné en fonction de ce qui a été entré pour <literal>/cephadm_bootstrap/mon_ip</literal> dans la configuration <literal>ceph-salt</literal>. Toutefois, ce paramètre était uniquement appliqué à Ceph Monitor. Vous pouvez vérifier ce paramètre à l&apos;aide de la commande suivante :
  </para>

<screen><prompt>root@master # </prompt>ceph config get mon public_network</screen>

  <para>
   Il s&apos;agit du paramètre minimal pour que Ceph puisse fonctionner, mais nous vous recommandons de définir le paramètre <literal>public_network</literal> sur <literal>global</literal>, ce qui signifie qu&apos;il s&apos;appliquera à tous les types de daemons Ceph, et pas uniquement aux instances MON :
  </para>

<screen><prompt>root@master # </prompt>ceph config set global public_network "$(ceph config get mon public_network)"</screen>

  <note>
   <para>
    Cette étape n&apos;est pas obligatoire. Toutefois, si vous n&apos;utilisez pas ce paramètre, les OSD Ceph et les autres daemons (à l&apos;exception de Ceph Monitor) écouteront <emphasis>toutes les adresses</emphasis>.
   </para>
   <para>
    Si vous souhaitez que vos OSD communiquent entre eux au moyen d&apos;un réseau totalement distinct, exécutez la commande suivante :
   </para>
<screen><prompt>root@master # </prompt>ceph config set global cluster_network "<replaceable>cluster_network_in_cidr_notation</replaceable>"</screen>
   <para>
    L&apos;exécution de cette commande garantit que les OSD créés dans votre déploiement utiliseront le réseau de grappe prévu dès le début.
   </para>
  </note>

  <para>
   Si votre grappe est configurée pour contenir des noeuds denses (plus de 62 OSD par hôte), veillez à assigner suffisamment de ports aux OSD Ceph. La plage par défaut (6800-7300) n&apos;autorise pas plus de 62 OSD par hôte. Pour une grappe contenant des noeuds denses, configurez le paramètre <literal>ms_bind_port_max</literal> sur une valeur appropriée. Chaque OSD consomme huit ports supplémentaires. Par exemple, si un hôte est configuré pour exécuter 96 OSD, 768 ports seront nécessaires. <literal>ms_bind_port_max</literal> doit au moins être défini sur 7568 en exécutant la commande suivante :
  </para>

<screen><prompt>root@master # </prompt>ceph config set osd.* ms_bind_port_max 7568</screen>

  <para>
   Vous devrez ajuster vos paramètres de pare-feu en conséquence pour que cela fonctionne. Pour plus d&apos;informations, reportez-vous au <xref linkend="storage-bp-net-firewall"/>.
  </para>
 </sect1>
 <sect1 xml:id="deploy-min-cluster-disable-insecure">
  <title>Désactivation des clients non sécurisés</title>

  <para>
   Depuis la version 15.2.11 de Pacific, un nouvel avertissement relatif à l&apos;état de santé vous informe que les clients non sécurisés sont autorisés à rejoindre la grappe. Cet avertissement est <emphasis>activé</emphasis> par défaut. Le tableau de bord Ceph affiche la grappe dans l&apos;état <literal>HEALTH_WARN</literal> et la vérification de l&apos;état de la grappe sur la ligne de commande vous informe comme suit :
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph status
cluster:
  id:     3fe8b35a-689f-4970-819d-0e6b11f6707c
  health: HEALTH_WARN
  mons are allowing insecure global_id reclaim
[...]
</screen>

  <para>
   Cet avertissement signifie que les moniteurs Ceph autorisent toujours les anciens clients non corrigés à se connecter à la grappe. De cette façon, les clients existants peuvent toujours se connecter pendant la mise à niveau de la grappe, mais le système vous avertit qu&apos;un problème doit être résolu. Une fois la grappe et tous les clients mis à niveau vers la dernière version de Ceph, interdisez les clients non corrigés en exécutant la commande suivante :
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mon auth_allow_insecure_global_id_reclaim false</screen>
 </sect1>
</chapter>
