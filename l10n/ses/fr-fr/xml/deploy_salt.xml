<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_salt.xml" version="5.0" xml:id="deploy-salt">
 <info>
  <title>Déploiement de Salt</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storage utilise Salt et <systemitem class="resource">ceph-salt</systemitem> pour la préparation initiale de la grappe. Salt vous aide à configurer et à exécuter des commandes sur plusieurs noeuds de grappe simultanément à partir d&apos;un hôte dédié appelé <emphasis>Salt Master</emphasis>. Avant de déployer Salt, tenez compte des points importants suivants :
 </para>
 <itemizedlist>
  <listitem>
   <para>
    Les <emphasis>minions Salt</emphasis> sont les noeuds contrôlés par un noeud dédié appelé Salt Master.
   </para>
  </listitem>
  <listitem>
   <para>
    Si l&apos;hôte Salt Master doit faire partie de la grappe Ceph, il doit exécuter son propre minion Salt, mais ce n&apos;est pas obligatoire.
   </para>
   <tip>
    <title>partage de plusieurs rôles par serveur</title>
    <para>
     Vous obtiendrez les meilleures performances de votre grappe Ceph lorsque chaque rôle est déployé sur un noeud distinct. Toutefois, les déploiements réels nécessitent parfois le partage d&apos;un noeud entre plusieurs rôles. Pour éviter les problèmes liés aux performances et à la procédure de mise à niveau, ne déployez pas le rôle Ceph OSD, Serveur de métadonnées ou Ceph Monitor sur le noeud Admin.
    </para>
   </tip>
  </listitem>
  <listitem>
   <para>
    Les minions Salt doivent résoudre correctement le nom d&apos;hôte de Salt Master sur le réseau. Par défaut, ils recherchent le nom d&apos;hôte <systemitem>salt</systemitem>, mais vous pouvez spécifier tout autre nom d&apos;hôte accessible par le réseau dans le fichier <filename>/etc/salt/minion</filename>.
   </para>
  </listitem>
 </itemizedlist>
 <procedure>
  <step>
   <para>
    Installez <literal>salt-master</literal> sur le noeud Salt Master :
   </para>
<screen><prompt>root@master # </prompt>zypper in salt-master</screen>
  </step>
  <step>
   <para>
    Vérifiez si le service <systemitem>salt-master</systemitem> est activé et démarré, puis activez-le et démarrez-le, le cas échéant :
   </para>
<screen><prompt>root@master # </prompt>systemctl enable salt-master.service
<prompt>root@master # </prompt>systemctl start salt-master.service</screen>
  </step>
  <step>
   <para>
    Si vous envisagez d&apos;utiliser le pare-feu, vérifiez si les ports 4505 et 4506 du noeud Salt Master sont ouverts pour tous les noeuds minions Salt. Si les ports sont fermés, vous pouvez les ouvrir à l&apos;aide de la commande <command>yast2 firewall</command> en autorisant le service <guimenu>salt-master</guimenu> à accéder à la zone appropriée. Par exemple, <literal>public</literal>.
   </para>
  </step>
  <step>
   <para>
    Installez le paquetage <literal>salt-minion</literal> sur tous les noeuds des minions.
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper in salt-minion</screen>
  </step>
  <step>
   <para>
    Modifiez <filename>/etc/salt/minion</filename> et supprimez les commentaires de la ligne suivante :
   </para>
<screen>#log_level_logfile: warning</screen>
   <para>
    Remplacez le niveau de consignation <literal>warning</literal> par <literal>info</literal>.
   </para>
   <note>
    <title><option>log_level_logfile</option> et <option>log_level</option></title>
    <para>
     Tandis que <option>log_level</option> contrôle quels messages du journal seront affichés à l&apos;écran, <option>log_level_logfile</option> contrôle quels messages du journal seront écrits dans <filename>/var/log/salt/minion</filename>.
    </para>
   </note>
   <note>
    <para>
     Veillez à modifier le niveau de consignation sur <emphasis>tous</emphasis> les noeuds de grappe (minion).
    </para>
   </note>
  </step>
  <step>
   <para>
    Assurez-vous que le <emphasis>nom de domaine complet</emphasis> de chaque noeud peut être résolu sur une adresse IP du réseau de grappes public par tous les autres noeuds.
   </para>
  </step>
  <step>
   <para>
    Configurez tous les minions pour qu&apos;ils se connectent au maître. Si le nom d&apos;hôte <literal>salt</literal> ne parvient pas à joindre votre Salt Master, modifiez le fichier <filename>/etc/salt/minion</filename> ou créez un fichier <filename>/etc/salt/minion.d/master.conf</filename> avec le contenu suivant :
   </para>
<screen>master: <replaceable>host_name_of_salt_master</replaceable></screen>
   <para>
    Si vous avez apporté des modifications aux fichiers de configuration mentionnés ci-dessus, redémarrez le service Salt sur tous les minions Salt qui y sont associés :
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart salt-minion.service</screen>
  </step>
  <step>
   <para>
    Vérifiez que le service <systemitem>salt-minion</systemitem> est activé et démarré sur tous les noeuds. Activez et démarrez-le, le cas échéant :
   </para>
<screen><prompt role="root"># </prompt>systemctl enable salt-minion.service
<prompt role="root"># </prompt>systemctl start salt-minion.service</screen>
  </step>
  <step>
   <para>
    Vérifiez l&apos;empreinte digitale de chaque minion Salt et acceptez toutes les clés Salt sur Salt Master si les empreintes digitales correspondent.
   </para>
   <note>
    <para>
     Si l&apos;empreinte de minion Salt revient vide, vérifiez que le minion Salt a une configuration Salt Master et qu&apos;il peut communiquer avec Salt Master.
    </para>
   </note>
   <para>
    Affichez l&apos;empreinte digitale de chaque minion :
   </para>
<screen><prompt>root@minion &gt; </prompt>salt-call --local key.finger
local:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Après avoir collecté les empreintes digitales de tous les minions Salt, répertoriez les empreintes de toutes les clés de minions non acceptées sur Salt Master :
   </para>
<screen><prompt>root@master # </prompt>salt-key -F
[...]
Unaccepted Keys:
minion1:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Si les empreintes des minions correspondent, acceptez-les :
   </para>
<screen><prompt>root@master # </prompt>salt-key --accept-all</screen>
  </step>
  <step>
   <para>
    Vérifiez que les clés ont été acceptées :
   </para>
<screen><prompt>root@master # </prompt>salt-key --list-all</screen>
  </step>
  <step>
   <para>
    Testez si tous les minions Salt répondent :
   </para>
<screen><prompt>root@master # </prompt>salt-run manage.status</screen>
  </step>
 </procedure>
</chapter>
