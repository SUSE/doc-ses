<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Ceph 服務的操作</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  您可以在精靈、節點或叢集層級操作 Ceph 服務。依據您需要的方法，使用 cephadm 或 <command>systemctl</command> 指令。
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>操作個別服務</title>

  <para>
   如果您需要操作個別服務，請先識別該服務：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   若要識別特定節點上的服務，請執行：
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   例如：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    <command>ceph orch ps</command> 指令支援多種輸出格式。若要變更格式，請附加 <option>--format <replaceable>FORMAT</replaceable></option> 選項，其中 <replaceable>FORMAT</replaceable> 是 <literal>json</literal>、<literal>json-pretty</literal> 或 <literal>yaml</literal> 其中之一。例如：
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   知道服務名稱後，您就可以啟動、重新啟動或停止該服務：
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   例如，若要重新啟動 ID 為 0 的 OSD 服務，請執行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>操作服務類型</title>

  <para>
   如果您需要操作整個 Ceph 叢集中特定類型的服務，請使用以下指令：
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   以 <literal>start</literal>、<literal>stop</literal> 或 <literal>restart</literal> 取代 <replaceable>COMMAND</replaceable>。
  </para>

  <para>
   例如，以下指令會重新啟動叢集中的所有 MON，無論它們實際是在哪個節點上執行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>操作單個節點上的服務</title>

  <para>
   透過使用 <command>systemctl</command> 指令，您可以操作單個節點上與 Ceph 相關的 <systemitem class="daemon">systemd</systemitem> 服務和目標。
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>識別服務和目標</title>
   <para>
    在操作與 Ceph 相關的 <systemitem class="daemon">systemd</systemitem> 服務和目標之前，您需要識別其單位檔案的檔案名稱。服務的檔案名稱具有以下格式：
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    例如：
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       Ceph 叢集的唯一 ID。您可以在 <command>ceph fsid</command> 指令的輸出中找到該 ID。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       服務的類型，例如 <literal>osd</literal>、<literal>mon</literal> 或 <literal>rgw</literal>。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       服務的識別字串。對於 OSD，它是服務的 ID 編號。對於其他服務，它可以是節點的主機名稱，也可以是與服務類型相關的其他字串。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     <replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable> 部分與 <command>ceph orch ps</command> 指令輸出中的 <literal>NAME</literal> 欄的內容相同。
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>操作一個節點上所有服務</title>
   <para>
    透過使用 Ceph 的 <systemitem class="daemon">systemd</systemitem> 目標，您可以同時操作某個節點上的<emphasis>所有</emphasis>服務，或者同時操作<emphasis>屬於</emphasis>由其 <replaceable>FSID</replaceable> 識別的叢集的所有服務。
   </para>
   <para>
    例如，若要停止某個節點上的所有 Ceph 服務，而不考慮服務所屬的叢集，請執行：
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    若要重新啟動屬於 ID 為 <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal> 的 Ceph 叢集的所有服務，請執行：
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>操作一個節點上的個別服務</title>
   <para>
    識別特定服務的名稱後，請如下所示操作該服務：
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    例如，若要重新啟動 ID 為 <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal> 的叢集上 ID 為 1 的單個 OSD 服務，請執行：
   </para>
<screen><prompt role="root">root # </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>查詢服務狀態</title>
   <para>
    您可以查詢 <systemitem class="daemon">systemd</systemitem> 來瞭解服務的狀態。例如：
   </para>
<screen><prompt role="root">root # </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>關閉並重新啟動整個 Ceph 叢集</title>

  <para>
   如果發生計劃電源中斷，可能需要關閉並重新啟動叢集。若要停止與 Ceph 相關的所有服務然後再重新啟動而不會出現問題，請遵循以下步驟進行操作。
  </para>

  <procedure>
   <title>關閉整個 Ceph 叢集</title>
   <step>
    <para>
     關閉存取叢集的任何用戶端或斷開其連接。
    </para>
   </step>
   <step>
    <para>
     若要阻止 CRUSH 自動重新平衡叢集，請將叢集設定為 <literal>noout</literal>：
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     停止所有叢集節點上的所有 Ceph 服務：
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     關閉所有叢集節點的電源：
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>啟動整個 Ceph 叢集</title>
   <step>
    <para>
     開啟管理節點的電源。
    </para>
   </step>
   <step>
    <para>
     開啟 Ceph 監控程式節點的電源。
    </para>
   </step>
   <step>
    <para>
     開啟 Ceph OSD 節點的電源。
    </para>
   </step>
   <step>
    <para>
     取消設定先前設定的 <literal>noout</literal> 旗標：
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     開啟所有已設定閘道的電源。
    </para>
   </step>
   <step>
    <para>
     開啟叢集用戶端的電源或連接叢集用戶端。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
