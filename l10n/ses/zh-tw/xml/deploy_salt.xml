<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_salt.xml" version="5.0" xml:id="deploy-salt">
 <info>
  <title>部署 Salt</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storage 使用 Salt 和 <systemitem class="resource">ceph-salt</systemitem> 進行初始叢集準備。Salt 可協助您從一個名為 <emphasis>Salt Master</emphasis> 的專屬主機同時針對多個叢集節點設定和執行指令。在部署 Salt 之前，請考慮以下重要事項：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis>Salt Minion</emphasis> 是由一個名為 Salt Master 的專屬節點控制的節點。
   </para>
  </listitem>
  <listitem>
   <para>
    如果 Salt Master 主機應屬於 Ceph 叢集的一部分，則它需要執行自己的 Salt Minion，但這不是必須的。
   </para>
   <tip>
    <title>每部伺服器共用多個角色</title>
    <para>
     如果將每個角色都部署在一個獨立節點上，則 Ceph 叢集的效能是最佳的。但實際部署有時會要求多個角色共用一個節點。為避免效能欠佳以及升級程序出現問題，請勿向管理節點部署 Ceph OSD、中繼資料伺服器或 Ceph 監控程式角色。
    </para>
   </tip>
  </listitem>
  <listitem>
   <para>
    Salt Minion 需要能透過網路正確解析 Salt Master 的主機名稱。依預設，Minion 會尋找 <systemitem>salt</systemitem> 主機名稱，但您可以在 <filename>/etc/salt/minion</filename> 檔案中指定可透過網路連接的其他任何主機名稱。
   </para>
  </listitem>
 </itemizedlist>
 <procedure>
  <step>
   <para>
    在 Salt Master 節點上安裝 <literal>salt-master</literal>：
   </para>
<screen><prompt>root@master # </prompt>zypper in salt-master</screen>
  </step>
  <step>
   <para>
    檢查 <systemitem>salt-master</systemitem> 服務是否已啟用並啟動，並視需要進行啟用和啟動：
   </para>
<screen><prompt>root@master # </prompt>systemctl enable salt-master.service
<prompt>root@master # </prompt>systemctl start salt-master.service</screen>
  </step>
  <step>
   <para>
    如果您要使用防火牆，請確認 Salt Master 節點是否為所有 Salt Minion 節點開啟了連接埠 4505 和 4506。如果這些連接埠處於關閉狀態，您可以使用 <command>yast2 firewall</command> 指令並透過允許相應區域的 <guimenu>salt-master</guimenu> 服務來開啟這些連接埠。例如，<literal>public</literal>。
   </para>
  </step>
  <step>
   <para>
    在所有 Minion 節點上安裝 <literal>salt-minion</literal> 套件。
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper in salt-minion</screen>
  </step>
  <step>
   <para>
    編輯 <filename>/etc/salt/minion</filename> 並取消註解下行：
   </para>
<screen>#log_level_logfile: warning</screen>
   <para>
    將 <literal>warning</literal> 記錄層級變更為 <literal>info</literal>。
   </para>
   <note>
    <title><option>log_level_logfile</option> 和 <option>log_level</option></title>
    <para>
     <option>log_level</option> 用於控制螢幕上將顯示的記錄訊息，而 <option>log_level_logfile</option> 用於控制哪些記錄訊息將寫入到 <filename>/var/log/salt/minion</filename>。
    </para>
   </note>
   <note>
    <para>
     請務必變更<emphasis>所有</emphasis>叢集 (Minion) 節點上的記錄層級。
    </para>
   </note>
  </step>
  <step>
   <para>
    確定所有其他節點都可以將每個節點的<emphasis>完整網域名稱</emphasis>解析為公用叢集網路上的 IP 位址。
   </para>
  </step>
  <step>
   <para>
    將所有 Minion 設定為連接至 Master。如果無法透過主機名稱 <literal>salt</literal> 連接 Salt Master，請編輯檔案 <filename>/etc/salt/minion</filename>，或建立包含以下內容的新檔案 <filename>/etc/salt/minion.d/master.conf</filename>：
   </para>
<screen>master: <replaceable>host_name_of_salt_master</replaceable></screen>
   <para>
    如果對上述組態檔案執行了任何變更，請在所有相關的 Salt Minion 上重新啟動 Salt 服務：
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart salt-minion.service</screen>
  </step>
  <step>
   <para>
    檢查所有節點上是否已啟用並啟動 <systemitem>salt-minion</systemitem> 服務。依據需要啟用並啟動該服務：
   </para>
<screen><prompt role="root"># </prompt>systemctl enable salt-minion.service
<prompt role="root"># </prompt>systemctl start salt-minion.service</screen>
  </step>
  <step>
   <para>
    確認每個 Salt Minion 的指紋，如果指紋相符，則接受 Salt Master 上的所有 Salt 金鑰。
   </para>
   <note>
    <para>
     如果 Salt Minion 指紋傳回空白，請確定 Salt Minion 具有 Salt Master 組態且可與 Salt Master 通訊。
    </para>
   </note>
   <para>
    檢視每個 Minion 的指紋：
   </para>
<screen><prompt>root@minion &gt; </prompt>salt-call --local key.finger
local:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    收集到所有 Salt Minion 的指紋後，將列出 Salt Master 上所有未接受 Minion 金鑰的指紋：
   </para>
<screen><prompt>root@master # </prompt>salt-key -F
[...]
Unaccepted Keys:
minion1:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    如果 Minion 的指紋相符，則接受這些金鑰：
   </para>
<screen><prompt>root@master # </prompt>salt-key --accept-all</screen>
  </step>
  <step>
   <para>
    驗證是否已接受金鑰：
   </para>
<screen><prompt>root@master # </prompt>salt-key --list-all</screen>
  </step>
  <step>
   <para>
    測試是否所有 Salt Minion 都回應：
   </para>
<screen><prompt>root@master # </prompt>salt-run manage.status</screen>
  </step>
 </procedure>
</chapter>
