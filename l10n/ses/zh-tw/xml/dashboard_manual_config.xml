<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="dashboard_manual_config.xml" version="5.0" xml:id="dashboard-initial-configuration">
 <title>手動設定</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  本節為更喜歡在指令行上手動設定儀表板設定的使用者提供了進階資訊。
 </para>
 <sect1 xml:id="dashboard-ssl">
  <title>設定 TLS/SSL 支援</title>

  <para>
   所有連至儀表板的 HTTP 連接預設均使用 TLS/SSL 來保障安全。安全連接需要 SSL 證書。您可以使用自行簽署的證書，也可以產生證書並讓知名證書管理中心 (CA) 簽署該證書。
  </para>

  <tip>
   <title>停用 SSL</title>
   <para>
    您可能會出於某種原因需要停用 SSL 支援。例如，如果儀表板是在不支援 SSL 的代理之後執行。
   </para>
   <para>
    停用 SSL 要慎重，因為停用 SSL 後，<emphasis role="bold">使用者名稱和密碼</emphasis>將以<emphasis role="bold">未加密</emphasis>的形式傳送至儀表板。
   </para>
   <para>
    若要停用 SSL，請執行以下指令：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/ssl false
</screen>
  </tip>

  <tip>
   <title>重新啟動 Ceph 管理員程序</title>
   <para>
    變更 SSL 證書和金鑰後，您需要手動重新啟動 Ceph 管理員程序。您可以透過執行以下指令
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr fail <replaceable>ACTIVE-MANAGER-NAME</replaceable></screen>
   <para>
    或停用儀表板模組之後再重新將其啟用的方式來執行此操作，如此還會觸發管理員自行重新繁衍：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph mgr module disable dashboard
<prompt>cephuser@adm &gt; </prompt>ceph mgr module enable dashboard
</screen>
  </tip>

  <sect2 xml:id="self-sign-certificates">
   <title>建立自行簽署的證書</title>
   <para>
    為了安全通訊而建立自行簽署的證書的過程非常簡單。採用這種方式可迅速讓儀表板執行起來。
   </para>
   <note>
    <title>網頁瀏覽器控訴</title>
    <para>
     大多數網頁瀏覽器都將對自行簽署的證書發起控訴，並需要在建立與儀表板的安全連接前進行明確確認。
    </para>
   </note>
   <para>
    若要產生並安裝自行簽署的證書，請使用以下內建指令：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard create-self-signed-cert
</screen>
  </sect2>

  <sect2 xml:id="cert-sign-CA">
   <title>使用 CA 簽署的證書</title>
   <para>
    為了正確保障連至儀表板的連接安全，以及消除網頁瀏覽器對自行簽署的證書的控訴，我們建議使用 CA 簽署的證書。
   </para>
   <para>
    您可以使用如下指令產生證書金鑰組：
   </para>
<screen>
<prompt role="root"># </prompt>openssl req -new -nodes -x509 \
  -subj "/O=IT/CN=ceph-mgr-dashboard" -days 3650 \
  -keyout dashboard.key -out dashboard.crt -extensions v3_ca
</screen>
   <para>
    以上指令會輸出 <filename>dashboard.key</filename> 和 <filename>dashboard.key.crt</filename> 檔案。獲得 CA 簽署的 <filename>dashboard.key.crt</filename> 檔案後，請執行以下指令為所有 Ceph 管理員例項啟用該證書：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate -i dashboard.crt
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate-key -i dashboard.key
</screen>
   <tip>
    <title>每個管理員例項使用不同的證書</title>
    <para>
     如果您需要為每個 Ceph 管理員例項使用不同的證書，請依如下所示修改指令，並在其中指定例項的名稱。以 Ceph 管理員例項的名稱 (通常是相關的主機名稱) 取代 <replaceable>NAME</replaceable>：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate <replaceable>NAME</replaceable> -i dashboard.crt
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-ssl-certificate-key <replaceable>NAME</replaceable> -i dashboard.key
</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="dashboard-hostname-port">
  <title>變更主機名稱和連接埠號碼</title>

  <para>
   Ceph Dashboard 結合至特定 TCP/IP 位址和 TCP 連接埠。依預設，代管儀表板的目前使用中 Ceph 管理員會結合至 TCP 連接埠 8443 (如果停用 SSL，則結合至 8080 連接埠)。
  </para>

  <note>
   <para>
    如果在執行 Ceph 管理員 (以及 Ceph Dashboard) 的主機上啟用了防火牆，則您可能需要變更組態以啟用對這些連接埠的存取。如需 Ceph 防火牆設定的詳細資訊，請參閱<xref linkend="storage-bp-net-firewall"/>。
   </para>
  </note>

  <para>
   Ceph Dashboard 預設結合至「::」，該符號表示所有可用的 IPv4 和 IPv6 位址。您可以使用以下指令變更 Web 應用程式的 IP 位址和連接埠號碼，以使它們適用於所有 Ceph 管理員例項：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/server_addr <replaceable>IP_ADDRESS</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/server_port <replaceable>PORT_NUMBER</replaceable>
</screen>

  <tip>
   <title>單獨設定 Ceph 管理員例項</title>
   <para>
    因為每個 <systemitem class="daemon">ceph-mgr</systemitem> 精靈都代管著各自的儀表板例項，您可能需要單獨設定每個 Ceph 管理員例項。使用以下指令 (以 <replaceable> 例項的 ID 取代 </replaceable>NAME<systemitem class="daemon">ceph-mgr</systemitem>) 變更特定管理員例項的 IP 位址和連接埠號碼：
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/<replaceable>NAME</replaceable>/server_addr <replaceable>IP_ADDRESS</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/<replaceable>NAME</replaceable>/server_port <replaceable>PORT_NUMBER</replaceable>
</screen>
  </tip>

  <tip>
   <title>列出設定的端點</title>
   <para>
    <command>ceph mgr services</command> 指令會顯示目前設定的所有端點。尋找 <literal>dashboard</literal> 鍵可獲取用於存取儀表板的 URL。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="dashboard-username-password">
  <title>調整使用者名稱和密碼</title>

  <para>
   如果您不想使用預設管理員帳戶，可建立其他使用者帳戶，並將其與至少一個角色相關聯。我們提供了一組預先定義的系統角色供您使用。如需詳細資訊，請參閱<xref linkend="dashboard-user-roles"/>。
  </para>

  <para>
   若要建立具有管理員權限的使用者，請使用以下指令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard ac-user-create <replaceable>USER_NAME</replaceable> <replaceable>PASSWORD</replaceable> administrator
</screen>
 </sect1>
 <sect1 xml:id="dashboard-ogw-enabling">
  <title>啟用物件閘道管理前端</title>

  <para>
   若要使用儀表板的物件閘道管理功能，您需要提供啟用了 <option>system</option> 旗標的使用者的登入身分證明：
  </para>

  <procedure>
   <step>
    <para>
     如果您沒有帶 <option>system</option> 旗標的使用者，請建立一個：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USER_ID</replaceable> --display-name=<replaceable>DISPLAY_NAME</replaceable> --system
</screen>
    <para>
     記下指令輸出中的 <replaceable>access_key</replaceable> 和 <replaceable>secret_key</replaceable> 金鑰。
    </para>
   </step>
   <step>
    <para>
     您還可以使用 <command>radosgw-admin</command> 指令來獲取現有使用者的身分證明：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid=<replaceable>USER_ID</replaceable>
</screen>
   </step>
   <step>
    <para>
     在單獨的檔案中向儀表板提供收到的身分證明：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-access-key <replaceable>ACCESS_KEY_FILE</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-secret-key <replaceable>SECRET_KEY_FILE</replaceable>
</screen>
   </step>
  </procedure>

  <note>
   <para>
    依預設，SUSE Linux Enterprise Server 15 SP3 中會啟用防火牆。如需防火牆組態的詳細資訊，請參閱<xref linkend="storage-bp-net-firewall"/>。
   </para>
  </note>

  <para>
   請注意以下幾點事項：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     系統會自動確定物件閘道的主機名稱和連接埠號碼。
    </para>
   </listitem>
   <listitem>
    <para>
     如果使用多個區域，物件閘道會自動確定主區域群組和主區域內的主機。此方式足以符合大部分設定的需求，但在某些情況下，您可能需要手動設定主機名稱和連接埠：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-host <replaceable>HOST</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-port <replaceable>PORT</replaceable>
</screen>
   </listitem>
   <listitem>
    <para>
     您可能需要進行的額外設定如下：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-scheme <replaceable>SCHEME</replaceable>  # http or https
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-admin-resource <replaceable>ADMIN_RESOURCE</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-user-id <replaceable>USER_ID</replaceable>
</screen>
   </listitem>
   <listitem>
    <para>
     如果您在物件閘道設定中使用的是自行簽署的證書 (<xref linkend="dashboard-ssl"/>)，請在儀表板中停用證書驗證，以避免發生因證書是由未知 CA 簽署或與主機名稱不符而導致連接遭拒。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-ssl-verify False
</screen>
   </listitem>
   <listitem>
    <para>
     如果物件閘道處理要求所花的時間過長，導致儀表板逾時，則可調整逾時值 (預設為 45 秒)：
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rest-requests-timeout <replaceable>SECONDS</replaceable>
</screen>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="dashboard-iscsi-management">
  <title>啟用 iSCSI 管理</title>

  <para>
   Ceph Dashboard 使用 Ceph iSCSI 閘道的 <systemitem class="service">rbd-target-api</systemitem> 服務所提供的 REST API 管理 iSCSI 目標。確定已在 iSCSI 閘道上安裝並啟用它。
  </para>

  <note>
   <para>
    Ceph Dashboard 的 iSCSI 管理功能取決於 <literal>ceph-iscsi</literal> 專案的最新版本 3。請確定您的作業系統提供了正確的版本，否則 Ceph Dashboard 將無法啟用管理功能。
   </para>
  </note>

  <para>
   如果 <literal>ceph-iscsi</literal> REST API 以 HTTPS 模式設定並使用自行簽署的證書，請設定該儀表板以避免在存取 ceph-iscsi API 時發生 SSL 證書驗證。
  </para>

  <para>
   停用 API SSL 驗證：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard set-iscsi-api-ssl-verification false</screen>

  <para>
   定義可用的 iSCSI 閘道：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-list
<prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-add <replaceable>scheme</replaceable>://<replaceable>username</replaceable>:<replaceable>password</replaceable>@<replaceable>host</replaceable>[:port]
<prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-rm <replaceable>gateway_name</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="dashboard-sso">
  <title>啟用單一登入</title>

  <para>
   <emphasis>單一登入</emphasis> (SSO) 是一種允許使用者以單個 ID 和密碼同時登入多個應用程式的存取控制方法。
  </para>

  <para>
   Ceph Dashboard 支援透過 SAML 2.0 通訊協定對使用者進行外部驗證。由於仍由儀表板負責進行<emphasis>授權</emphasis>，因此您需要先建立使用者帳戶，並將其與所需角色相關聯。不過，可由現有<emphasis>身分提供者</emphasis> (IdP) 來執行<emphasis>驗證</emphasis>。
  </para>

  <para>
   若要設定單一登入，請使用以下指令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso setup saml2 <replaceable>CEPH_DASHBOARD_BASE_URL</replaceable> \
 <replaceable>IDP_METADATA</replaceable> <replaceable>IDP_USERNAME_ATTRIBUTE</replaceable> \
 <replaceable>IDP_ENTITY_ID</replaceable> <replaceable>SP_X_509_CERT</replaceable> \
 <replaceable>SP_PRIVATE_KEY</replaceable>
</screen>

  <para>
   參數：
  </para>

  <variablelist>
   <varlistentry>
    <term><replaceable>CEPH_DASHBOARD_BASE_URL</replaceable></term>
    <listitem>
     <para>
      可用於存取 Ceph Dashboard 的基本 URL (例如「https://cephdashboard.local」)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_METADATA</replaceable></term>
    <listitem>
     <para>
      IdP 中繼資料 XML 的 URL、檔案路徑或內容 (例如「https://myidp/metadata」)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_USERNAME_ATTRIBUTE</replaceable></term>
    <listitem>
     <para>
      選擇性。將用於從驗證回應中獲取使用者名稱的屬性。預設為「uid」。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_ENTITY_ID</replaceable></term>
    <listitem>
     <para>
      選擇性。當 IdP 中繼資料上存在多個實體 ID 時，請使用該參數。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>SP_X_509_CERT</replaceable> / <replaceable>SP_PRIVATE_KEY</replaceable></term>
    <listitem>
     <para>
      選擇性。Ceph Dashboard (服務提供者) 進行簽署和加密時將使用的證書的檔案路徑或內容。作用中 Ceph 管理員例項需要能存取這些檔案路徑。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <note>
   <title>SAML 要求</title>
   <para>
    SAML 要求的發出者值將採用以下格式：
   </para>
<screen>
<replaceable>CEPH_DASHBOARD_BASE_URL</replaceable>/auth/saml2/metadata
</screen>
  </note>

  <para>
   若要顯示目前的 SAML 2.0 組態，請執行以下指令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso show saml2
</screen>

  <para>
   若要停用單一登入，請執行以下指令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso disable
</screen>

  <para>
   若要檢查是否啟用了 SSO，請執行以下指令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso status
</screen>

  <para>
   若要啟用 SSO，請執行以下指令：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso enable saml2
</screen>
 </sect1>
</chapter>
