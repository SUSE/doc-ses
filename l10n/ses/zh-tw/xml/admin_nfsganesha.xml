<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha-ceph-nfsganesha">

 <title>NFS Ganesha</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  NFS Ganesha 是一部 NFS 伺服器，它在使用者位址空間中執行，而不是做為作業系統核心的一部分執行。憑藉 NFS Ganesha，您可以插入自己的儲存機制 (例如 Ceph)，並從任何 NFS 用戶端存取它。如需安裝說明，請參閱<xref linkend="deploy-cephadm-day2-service-nfs"/>。
 </para>
 <note>
  <title>NFS Ganesha 效能</title>
  <para>
   由於用戶端與儲存區之間的額外網路躍程會導致通訊協定負擔新增並產生額外的延遲，因此與使用原生 CephFS 相比，透過 NFS 閘道存取 Ceph 可能會使應用程式效能大幅降低。
  </para>
 </note>
 <para>
  每個 NFS Ganesha 服務都含有一個組態階層，其中包含：
 </para>
 <itemizedlist>
  <listitem>
   <para>
    開機 <filename>ganesha.conf</filename>
   </para>
  </listitem>
  <listitem>
   <para>
    每個服務的 RADOS 通用組態物件
   </para>
  </listitem>
  <listitem>
   <para>
    每個輸出的 RADOS 組態物件
   </para>
  </listitem>
 </itemizedlist>
 <para>
  開機組態是要在容器中啟動 <systemitem class="daemon">nfs-ganesha</systemitem> 精靈的最低組態。每個開機組態都將包含一個 <literal>%url</literal> 指令，該指令中包含來自 RADOS 通用組態物件的任何額外組態。通用組態物件可以為輸出 RADOS 組態物件中定義的每個 NFS 輸出包含額外的 <literal>%url</literal> 指令。
 </para>
 <figure>
  <title>NFS Ganesha 結構</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
  </mediaobject>
 </figure>
 <sect1 xml:id="ceph-nfsganesha-nfservice">
  <title>建立 NFS 服務</title>

  <para>
   指定 Ceph 服務部署的推薦方法是建立一個 YAML 格式的檔案，其中包含所要部署服務的規格。您可以為每種類型的服務建立單獨的規格檔案，也可以在一個檔案中指定多個 (或所有) 服務類型。
  </para>

  <para>
   依據您的選擇，您將需要更新或建立相關的 YAML 格式檔案來建立 NFS Ganesha 服務。如需建立該檔案的詳細資訊，請參閱<xref linkend="cephadm-service-and-placement-specs"/>。
  </para>

  <para>
   更新或建立該檔案之後，請執行以下指令以建立 <literal>nfs-ganesha</literal> 服務：
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>FILE_NAME</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-services">
  <title>啟動或重新啟動 NFS Ganesha</title>

  <important>
   <para>
    啟動 NFS Ganesha 服務不會自動輸出 CephFS 檔案系統。若要輸出 CephFS 檔案系統，請建立輸出組態檔案。如需更多詳細資料，請參閱 <xref linkend="ceph-nfsganesha-create-export"/>。
   </para>
  </important>

  <para>
   若要啟動 NFS Ganesha 服務，請執行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch start nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   若要重新啟動 NFS Ganesha 服務，請執行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   如果您只想重新啟動單個 NFS Ganesha 精靈，請執行：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   啟動或重新啟動 NFS Ganesha 時，NFS v4 會有 90 秒的逾時寬限期間。在寬限期間，系統會主動拒絕來自用戶端的新要求。因此，當 NFS 處於寬限期內，用戶端可能會發生要求處理速度變慢的情況。
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-list-objects">
  <title>列出 NFS 復原池中的物件</title>

  <para>
   執行以下指令以列出 NFS 復原池中的物件：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> ls</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-create-export">
  <title>建立 NFS 輸出</title>

  <para>
   您可以在 Ceph Dashboard 中建立 NFS 輸出，也可以在指令行上以手動方式建立。若要使用 Ceph Dashboard 建立 NFS 輸出，請參閱<xref linkend="dash-webui-nfs"/>，更具體地說，請參閱<xref linkend="dash-webui-nfs-create"/>。
  </para>

  <para>
   若要以手動方式建立 NFS 輸出，請建立輸出的組態檔案。例如，包含以下內容的 <filename>/tmp/export-1</filename> 檔案：
  </para>

<screen>
EXPORT {
    export_id = 1;
    path = "/";
    pseudo = "/";
    access_type = "RW";
    squash = "no_root_squash";
    protocols = 3, 4;
    transports = "TCP", "UDP";
    FSAL {
        name = "CEPH";
        user_id = "admin";
        filesystem = "a";
        secret_access_key = "<replaceable>SECRET_ACCESS_KEY</replaceable>";
    }
}
</screen>

  <para>
   建立並儲存新輸出的組態檔案後，執行以下指令來建立該輸出：
  </para>

<screen>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> put <replaceable>EXPORT_NAME</replaceable> <replaceable>EXPORT_CONFIG_FILE</replaceable></screen>

  <para>
   例如：
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool example_pool --namespace example_namespace put export-1 /tmp/export-1</screen>

  <note>
   <para>
    應修改 FSAL 區塊以包含所需的 <systemitem class="service">cephx</systemitem> 使用者 ID 和機密存取金鑰。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-verify">
  <title>確認 NFS 輸出</title>

  <para>
   NFS v4 將在虛擬檔案系統的根目錄下構建輸出清單。您可以透過掛接 NFS Ganesha 伺服器節點的 <filename>/</filename> 來確認 NFS 共用是否已輸出：
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable>
<prompt role="root"># </prompt><command>ls</command> <replaceable>/path/to/local/mountpoint</replaceable> cephfs</screen>

  <note>
   <title>NFS Ganesha 僅限 v4</title>
   <para>
    依預設，cephadm 將設定 NFS v4 伺服器。NFS v4 不會與 <literal>rpcbind</literal> 或 <literal>mountd</literal> 精靈進行互動。NFS 用戶端工具 (例如 <command>showmount</command>) 將不會顯示任何已設定的輸出。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-mount">
  <title>掛接 NFS 輸出</title>

  <para>
   若要在用戶端主機上掛接輸出的 NFS 共用，請執行：
  </para>

<screen><prompt role="root"># </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-customrole">
  <title>多個 NFS Ganesha 叢集</title>

  <para>
   可以定義多個 NFS Ganesha 叢集。如此便可：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     分隔 NFS Ganesha 叢集，以便存取 CephFS。
    </para>
   </listitem>
  </itemizedlist>


 </sect1>
</chapter>
