<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_kvm.xml" version="5.0" xml:id="cha-ceph-kvm">
 <title>Ceph als Back-End für die QEMU KVM-Instanz</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>Ja</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Der häufigste Anwendungsfall von Ceph ist die Bereitstellung von Blockgeräte-Images für virtuelle Maschinen. Ein Benutzer erstellt beispielsweise ein Klon-Image („Golden Image“) mit Betriebssystem und der relevanten Software in einer idealen Konfiguration. Dann erstellt der Benutzer einen Snapshot des Image. Schließlich klont der Benutzer den Snapshot (normalerweise viele Male, weitere detaillierte Informationen finden Sie in <xref linkend="cha-ceph-snapshots-rbd"/>). Die Fähigkeit zum Erstellen von Klonen aus Snapshots durch Kopien beim Schreibvorgang bedeutet, dass Ceph schnell Blockgeräte-Images für virtuelle Maschinen bereitstellen kann, weil der Client nicht bei jeder Erstellung einer neuen virtuellen Maschine ein gesamtes Image herunterladen muss.
 </para>
 <para>
  Ceph-Blockgeräte können in virtuelle QEMU-Maschinen integriert werden. Weitere Informationen zu QEMU KVM finden Sie unter <link xlink:href="https://documentation.suse.com/sles/15-SP2/html/SLES-all/part-virt-qemu.html"/>.
 </para>
 <sect1 xml:id="ceph-kvm-install">
  <title>Installieren von <systemitem>qemu-block-rbd</systemitem></title>

  <para>
   Zur Verwendung von Ceph-Blockgeräten muss für QEMU der entsprechende Treiber installiert sein. Prüfen Sie, ob das Paket <systemitem>qemu-block-rbd</systemitem> installiert ist und installieren Sie es, falls erforderlich:
  </para>

<screen><prompt role="root">root # </prompt>zypper install qemu-block-rbd</screen>
 </sect1>
 <sect1 xml:id="ceph-kvm-usage">
  <title>Verwenden von QEMU</title>

  <para>
   In der QEMU-Kommandozeile müssen Sie den Poolnamen und den Image-Namen angeben. Sie können außerdem auch einen Snapshot-Namen angeben.
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable><replaceable>:option1=value1</replaceable><replaceable>:option2=value2...</replaceable></screen>

  <para>
   Beispielsweise könnte die Angabe der Optionen <replaceable>id</replaceable> und <replaceable>conf</replaceable> wie folgt aussehen:
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable>:<option>id=glance:conf=/etc/ceph/ceph.conf</option></screen>
 </sect1>
 <sect1 xml:id="creating-images-qemu">
  <title>Erstellen von Images mit QEMU</title>

  <para>
   Sie können ein Blockgeräte-Image von QEMU aus erstellen. Sie müssen <literal>rbd</literal>, den Poolnamen und den Namen des zu erstellenden Image angeben. Sie müssen auch die Größe des Image angeben. 
  </para>

<screen>qemu-img create -f raw rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Beispiel:
  </para>

<screen>qemu-img create -f raw rbd:pool1/image1 10G
Formatting 'rbd:pool1/image1', fmt=raw size=10737418240 nocow=off cluster_size=0</screen>

  <important>
   <para>
    Das Datenformat <literal>raw</literal> ist wirklich die einzige sinnvolle Formatoption für RBD. Eigentlich könnten Sie auch andere QEMU-unterstützte Formate verwenden wie <literal>qcow2</literal>, doch das würde zusätzlichen Overhead bedeuten. Außerdem würde bei Live-Migration der virtuellen Maschine das Volume unsicher, wenn Caching aktiviert ist.
   </para>
  </important>
 </sect1>
 <sect1 xml:id="resizing-images-qemu">
  <title>Ändern der Größe von Images mit QEMU</title>

  <para>
   Sie können die Größe eines Blockgeräte-Images von QEMU aus ändern. Sie müssen <literal>rbd</literal>, den Poolnamen und den Namen des Image angeben, dessen Größe geändert werden soll. Sie müssen auch die Größe des Image angeben. 
  </para>

<screen>qemu-img resize rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Beispiel:
  </para>

<screen>qemu-img resize rbd:pool1/image1 9G
Image resized.</screen>
 </sect1>
 <sect1 xml:id="retrieving-image-info-qemu">
  <title>Abrufen von Image-Informationen mit QEMU</title>

  <para>
   Sie können die Informationen zum Blockgeräte-Image von QEMU aus abrufen. Sie müssen dazu <literal>rbd</literal>, den Poolnamen und den Namen des Image angeben.
  </para>

<screen>qemu-img info rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>

  <para>
   Beispiel:
  </para>

<screen>qemu-img info rbd:pool1/image1
image: rbd:pool1/image1
file format: raw
virtual size: 9.0G (9663676416 bytes)
disk size: unavailable
cluster_size: 4194304</screen>
 </sect1>
 <sect1 xml:id="running-qemu-rbd">
  <title>Ausführen von QEMU mit RBD</title>

  <para>
   QEMU kann auf ein Image als virtuelles Blockgerät direkt über <systemitem>librbd</systemitem> zugreifen. Dadurch wird ein zusätzlicher Kontextschalter vermieden und Sie können vom RBD-Caching profitieren.
  </para>

  <para>
   Zum Konvertieren der bestehenden Images von virtuellen Maschinen zu Ceph-Blockgeräte-Images kann <command>qemu-img</command> verwendet werden. Wenn Sie beispielsweise über ein qcow2-Image verfügen, könnten Sie folgendes Kommando ausführen:
  </para>

<screen>qemu-img convert -f qcow2 -O raw sles12.qcow2 rbd:pool1/sles12</screen>

  <para>
   Mit folgendem Kommando könnten Sie eine virtuelle Maschine von diesem Image booten:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12</screen>

  <para>
   RBD Caching kann die Leistung erheblich verbessern. Die Cache-Optionen von QEMU steuern das <systemitem>librbd</systemitem>-Caching:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=rbd,file=rbd:pool1/sles12,cache=writeback</screen>

  <para>
   Weitere Informationen zum RBD-Caching finden Sie in <xref linkend="rbd-cache-settings"/>.
  </para>
 </sect1>
 <sect1 xml:id="enabling-dicard-trim">
  <title>Aktivieren und Verwerfen und TRIM</title>

  <para>
   Ceph-Blockgeräte unterstützen die Verwerfen-Operation. Dies bedeutet, dass ein Gast TRIM-Anforderungen senden kann, damit ein Ceph-Blockgerät nicht genutzten Speicherplatz freigibt. Dies kann beim Gast durch Einhängen von <systemitem>XFS</systemitem> mit der Verwerfen-Option aktiviert werden.
  </para>

  <para>
   Damit dies für den Gast verfügbar ist, muss es explizit für das Blockgerät aktiviert sein. Dazu müssen Sie eine <option>discard_granularity</option> angeben, die mit dem Laufwerk verknüpft ist:
  </para>

<screen><prompt role="root">root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12,id=drive1,if=none \
-device driver=ide-hd,drive=drive1,discard_granularity=512</screen>

  <note>
   <para>
    Im obigen Beispiel wird ein IDE-Treiber verwendet. Der virtio-Treiber unterstützt keine Verwerfen-Vorgänge.
   </para>
  </note>

  <para>
   Wenn Sie <systemitem>libvirt</systemitem> verwenden, bearbeiten Sie die Konfigurationsdatei Ihrer libvirt-Domäne mit <command>virsh edit</command>, um den Wert <literal>xmlns:qemu</literal> hinzuzufügen. Fügen Sie dann einen <literal>qemu:commandline block</literal> als untergeordnetes Element dieser Domäne hinzu. Im folgenden Beispiel sehen Sie, wie zwei Geräte mit <literal>qemu id=</literal> auf verschiedene <literal>discard_granularity</literal>-Werte festgelegt werden.
  </para>

<screen>
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
 &lt;qemu:commandline&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-0.discard_granularity=4096'/&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-1.discard_granularity=65536'/&gt;
 &lt;/qemu:commandline&gt;
&lt;/domain&gt;</screen>
 </sect1>
 <sect1 xml:id="qemu-cache-options">
  <title>Festlegen von QEMU-Cache-Optionen</title>

  <para>
   Die Cache-Optionen von QEMU entsprechen den folgenden Ceph RBD-Cache-Einstellungen.
  </para>

  <para>
   Writeback:
  </para>

<screen>rbd_cache = true</screen>

  <para>
   Writethrough:
  </para>

<screen>rbd_cache = true
rbd_cache_max_dirty = 0</screen>

  <para>
   kein Befehl:
  </para>

<screen>rbd_cache = false</screen>

  <para>
   Die Cache-Einstellungen von QEMU überschreiben die Standardeinstellungen von Ceph (Einstellungen, die nicht explizit in der Ceph-Konfigurationsdatei festgelegt sind). Wenn Sie explizit die RBD Cache-Einstellungen in Ihrer Ceph-Konfigurationsdatei festlegen (siehe <xref linkend="rbd-cache-settings"/>), überschreiben Ihre Ceph-Einstellungen die QEMU-Cache-Einstellungen. Wenn Sie die Cache-Einstellungen in der QEMU-Kommandozeile festlegen, überschreiben die Einstellungen der QEMU-Kommandozeile die Einstellungen der Ceph-Konfigurationsdatei.
  </para>
 </sect1>
</chapter>
