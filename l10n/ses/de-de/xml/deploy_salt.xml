<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_salt.xml" version="5.0" xml:id="deploy-salt">
 <info>
  <title>Bereitstellen von Salt</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storage verwendet Salt und <systemitem class="resource">ceph-salt</systemitem> für die anfängliche Vorbereitung des Clusters. Mit Salt können Sie Kommandos auf mehreren Cluster-Knoten gleichzeitig von einem dedizierten Host, dem <emphasis>Salt Master</emphasis>, aus konfigurieren und ausführen. Vor dem Bereitstellen von Salt sollten Sie folgende wichtige Punkte beachten:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis>Salt Minions</emphasis> sind die Knoten, die von einem dedizierten Knoten namens Salt Master gesteuert werden.
   </para>
  </listitem>
  <listitem>
   <para>
    Wenn der Salt-Master-Host Teil des Ceph-Clusters sein soll, muss er seinen eigenen Salt Minion ausführen, was aber keine Voraussetzung ist.
   </para>
   <tip>
    <title>Freigeben mehrerer Rollen pro Server</title>
    <para>
     Sie erreichen die optimale Leistung Ihres Ceph-Clusters, wenn jede Rolle in einem separaten Knoten bereitgestellt wird. Manchmal ist es jedoch bei Bereitstellungen erforderlich, einen Knoten für mehrere Rollen freizugeben. Stellen Sie die Ceph OSD-, Metadatenserver- oder Ceph Monitor-Rolle nicht auf dem Admin-Knoten bereit, um Probleme mit der Leistung und dem Upgrade-Vorgang zu vermeiden.
    </para>
   </tip>
  </listitem>
  <listitem>
   <para>
    Salt Minions müssen den Hostnamen des Salt Masters im gesamten Netzwerk korrekt auflösen. Standardmäßig suchen sie nach dem Hostnamen <systemitem>salt</systemitem>. Sie können jedoch auch in der Datei <filename>/etc/salt/minion</filename> jeden vom Netzwerk erreichbaren Hostnamen angeben.
   </para>
  </listitem>
 </itemizedlist>
 <procedure>
  <step>
   <para>
    Installieren Sie <literal>salt-master</literal> auf dem Salt-Master-Knoten:
   </para>
<screen><prompt>root@master # </prompt>zypper in salt-master</screen>
  </step>
  <step>
   <para>
    Überprüfen Sie, ob der <systemitem>salt-master</systemitem>-Service aktiviert und gestartet wurde und aktivieren und starten Sie ihn gegebenenfalls:
   </para>
<screen><prompt>root@master # </prompt>systemctl enable salt-master.service
<prompt>root@master # </prompt>systemctl start salt-master.service</screen>
  </step>
  <step>
   <para>
    Falls Sie beabsichtigen, die Firewall zu verwenden, überprüfen Sie, ob im Salt-Master-Knoten die Ports 4505 und 4506 für alle Salt-Minion-Knoten offen sind. Wenn die Ports geschlossen sind, können Sie sie mit dem Kommando <command>yast2 firewall</command> öffnen. Lassen Sie dazu den<guimenu> salt-master</guimenu>-Service für die entsprechende Zone zu. Zum Beispiel <literal>Öffentlich</literal>.
   </para>
  </step>
  <step>
   <para>
    Installieren Sie das Paket <literal>salt-minion</literal> in allen Minion-Knoten.
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper in salt-minion</screen>
  </step>
  <step>
   <para>
    Bearbeiten Sie <filename>/etc/salt/minion</filename> und kommentieren Sie die folgende Zeile aus:
   </para>
<screen>#log_level_logfile: warning</screen>
   <para>
    Ändern Sie die Protokollstufe <literal>Warnung</literal> zu <literal>Info</literal>.
   </para>
   <note>
    <title><option>log_level_logfile</option> und <option>log_level</option></title>
    <para>
     Während mit <option>log_level</option> gesteuert wird, welche Protokollmeldungen auf dem Bildschirm angezeigt werden, wird mit <option>log_level_logfile</option> gesteuert, welche Protokollmeldungen in <filename>/var/log/salt/minion</filename> geschrieben werden.
    </para>
   </note>
   <note>
    <para>
     Stellen Sie sicher, dass Sie die Protokollebene auf <emphasis>allen</emphasis> Cluster-Knoten (Minions) ändern.
    </para>
   </note>
  </step>
  <step>
   <para>
    Vergewissern Sie sich, dass der <emphasis>vollqualifizierte Domänenname</emphasis> jedes Knotens von allen anderen Knoten in eine IP-Adresse im öffentlichen Clusternetzwerk aufgelöst werden kann.
   </para>
  </step>
  <step>
   <para>
    Konfigurieren Sie alle Minions für die Verbindung mit dem Master. Wenn Ihr Salt Master mit dem Hostnamen <literal>salt</literal> nicht erreichbar ist, bearbeiten Sie die Datei <filename>/etc/salt/minion</filename> oder erstellen Sie eine neue Datei <filename>/etc/salt/minion.d/master.conf</filename> mit folgendem Inhalt:
   </para>
<screen>master: <replaceable>host_name_of_salt_master</replaceable></screen>
   <para>
    Wenn Sie an den oben genannten Konfigurationsdateien Änderungen vorgenommen haben, starten Sie den Salt-Service auf allen entsprechenden Salt Minions neu:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart salt-minion.service</screen>
  </step>
  <step>
   <para>
    Überprüfen Sie, ob der <systemitem>salt-minion</systemitem> Service in allen Knoten aktiviert und gestartet wurde. Aktivieren und starten Sie ihn, falls erforderlich:
   </para>
<screen><prompt role="root"># </prompt>systemctl enable salt-minion.service
<prompt role="root"># </prompt>systemctl start salt-minion.service</screen>
  </step>
  <step>
   <para>
    Überprüfen Sie den Fingerabdruck der einzelnen Salt Minions und akzeptieren Sie alle Salt-Schlüssel am Salt Master, wenn die Fingerabdrücke übereinstimmen.
   </para>
   <note>
    <para>
     Wenn ein leerer Fingerabdruck des Salt Minions zurückgegeben wird, prüfen Sie, ob der Salt Minion über eine Salt-Master-Konfiguration verfügt und ob der Minion mit dem Salt Master kommunizieren kann.
    </para>
   </note>
   <para>
    Zeigen Sie den Fingerabdruck der einzelnen Minions an:
   </para>
<screen><prompt>root@minion &gt; </prompt>salt-call --local key.finger
local:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Nachdem Sie die Fingerabdrücke aller Salt Minions gesammelt haben, listen Sie die Fingerabdrücke aller nicht akzeptierten Minion-Schlüssel am Salt Master auf:
   </para>
<screen><prompt>root@master # </prompt>salt-key -F
[...]
Unaccepted Keys:
minion1:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Wenn die Fingerabdrücke der Minions übereinstimmen, akzeptieren Sie sie:
   </para>
<screen><prompt>root@master # </prompt>salt-key --accept-all</screen>
  </step>
  <step>
   <para>
    Verifizieren Sie, dass die Schlüssel akzeptiert wurden:
   </para>
<screen><prompt>root@master # </prompt>salt-key --list-all</screen>
  </step>
  <step>
   <para>
    Testen Sie, ob alle Salt Minions antworten:
   </para>
<screen><prompt>root@master # </prompt>salt-run manage.status</screen>
  </step>
 </procedure>
</chapter>
