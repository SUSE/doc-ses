<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_libvirt.xml" version="5.0" xml:id="cha-ceph-libvirt">
 <title><systemitem class="library">libvirt</systemitem> und Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Die <systemitem class="library">libvirt</systemitem>-Bibliothek erstellt eine Abstraktionsschicht einer virtuellen Maschine zwischen den Hypervisor-Schnittstellen und den Softwareanwendungen, die sie verwenden. Mit <systemitem class="library">libvirt</systemitem> können sich Entwickler und Systemadministratoren auf ein gemeinsames Verwaltungs-Framework, eine gemeinsame API und die gemeinsame Shell-Schnittstelle (<command>virsh</command>) zu vielen verschiedenen Hypervisoren konzentrieren, einschließlich QEMU/KVM, Xen, LXC oder VirtualBox.
 </para>
 <para>
  Ceph-Blockgeräte unterstützen QEMU/KVM. Ceph-Blockgeräte können mit Software verwendet werden, die eine Schnittstelle zu <systemitem class="library">libvirt</systemitem> darstellen. Die Cloud-Lösung verwendet <systemitem class="library">libvirt</systemitem> zur Interaktion mit QEMU/KVM, das wiederum mit Ceph-Blockgeräten über <systemitem>librbd</systemitem> interagiert.
 </para>
 <para>
  Erstellen Sie VMs, die Ceph-Blockgeräte verwenden, anhand der folgenden Verfahren. In den Beispielen haben wir <literal>libvirt-pool</literal> als Poolnamen, <literal>client.libvirt</literal> als Benutzernamen und <literal>new-libvirt-image</literal> als Image-Namen verwendet. Sie können jeden gewünschten Wert verwenden, doch ersetzen Sie auf jeden Fall diese Werte, wenn sie Kommandos in den folgenden Verfahren ausführen.
 </para>
 <sect1 xml:id="ceph-libvirt-cfg-ceph">
  <title>Konfigurieren von Ceph mit <systemitem class="library">libvirt</systemitem></title>

  <para>
   Führen Sie zum Konfigurieren von Ceph zur Verwendung mit <systemitem class="library">libvirt</systemitem> die folgenden Schritte aus:
  </para>

  <procedure>
   <step>
    <para>
     Erstellen Sie einen Pool. Im folgenden Beispiel wird der Poolname <literal>libvirt-pool</literal> mit 128 Placement Groups verwendet.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     Verifizieren Sie, dass der Pool vorhanden ist.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     Erstellen Sie einen Ceph-Benutzer. Das folgende Beispiel verwendet den Ceph-Benutzernamen <literal>client.libvirt</literal> und verweist auf <literal>libvirt-pool</literal>.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-or-create client.libvirt mon 'profile rbd' osd \
 'profile rbd pool=libvirt-pool'</screen>
    <para>
     Verifizieren Sie, dass der Name vorhanden ist.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth list</screen>
    <note>
     <title>Benutzername oder ID</title>
     <para>
      <systemitem class="library">libvirt</systemitem> greift auf Ceph mit der ID <literal>libvirt</literal> zu, nicht mit dem Ceph-Namen <literal>client.libvirt</literal>. Unter <xref linkend="cephx-user"/> finden Sie eine detaillierte Erklärung zum Unterschied zwischen ID und Name.
     </para>
    </note>
   </step>
   <step>
    <para>
     Erstellen Sie ein Image in Ihrem RBD-Pool mit QEMU. Das folgende Beispiel verwendet den Image-Namen <literal>new-libvirt-image</literal> und verweist auf <literal>libvirt-pool</literal>.
    </para>
    <tip>
     <title>Speicherort der Schlüsselbunddatei</title>
     <para>
      Der Benutzerschlüssel <systemitem class="library">libvirt</systemitem> ist in einer Schlüsselbunddatei im Verzeichnis <filename>/etc/ceph</filename> gespeichert. Die Schlüsselbunddatei muss einen geeigneten Namen aufweisen, der den Namen des Ceph-Clusters enthält, zu dem sie gehört. Für den Standard-Cluster-Namen „ceph“ lautet der Name der Schlüsselbunddatei <filename>/etc/ceph/ceph.client.libvirt.keyring</filename>.
     </para>
     <para>
      Wenn der Schlüsselbund nicht vorhanden ist, erstellen Sie ihn mit:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get client.libvirt &gt; /etc/ceph/ceph.client.libvirt.keyring</screen>
    </tip>
<screen><prompt role="root"># </prompt>qemu-img create -f raw rbd:libvirt-pool/new-libvirt-image:id=libvirt 2G</screen>
    <para>
     Verifizieren Sie, dass das Image vorhanden ist.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-virt-manager">
  <title>Vorbereiten des VM-Managers</title>

  <para>
   <systemitem class="library">libvirt</systemitem> kann zwar ohne VM-Manager verwendet werden, doch es ist möglicherweise für Sie einfacher, wenn Sie Ihre erste Domäne mit<command>virt-manager</command> erstellen.
  </para>

  <procedure>
   <step>
    <para>
     Installieren Sie einen Manager für virtuelle Maschinen.
    </para>
<screen><prompt role="root"># </prompt>zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     Bereiten Sie ein Betriebssystem-Image des Systems vor, das Sie virtualisiert ausführen möchten, oder laden Sie es herunter.
    </para>
   </step>
   <step>
    <para>
     Starten Sie den VM-Manager.
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-create-vm">
  <title>Erstellen einer VM</title>

  <para>
   Führen Sie zum Erstellen einer VM mit <command>virt-manager</command> die folgenden Schritte aus:
  </para>

  <procedure>
   <step>
    <para>
     Wählen Sie die Verbindung aus der Liste aus, klicken Sie mit der rechten Maustaste darauf und wählen Sie <guimenu>Neu</guimenu> aus.
    </para>
   </step>
   <step>
    <para>
     <guimenu>Importieren Sie das bestehende Festplatten-Image</guimenu>, indem Sie den Pfad zum bestehenden Speicher angeben. Geben Sie den Betriebssystemtyp, die Arbeitsspeichereinstellungen und den <guimenu>Namen</guimenu> der virtuellen Maschine an, beispielsweise <literal>libvirt-virtual-machine</literal>.
    </para>
   </step>
   <step>
    <para>
     Stellen Sie die Konfiguration fertig und starten Sie die VM.
    </para>
   </step>
   <step>
    <para>
     Verifizieren Sie mit <command>sudo virsh list</command>, dass die neu erstellte Domäne vorhanden ist. Geben Sie die Verbindungszeichenkette wie folgt an, falls erforderlich:
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     Melden Sie sich bei der VM an und stoppen Sie sie, bevor Sie sie zur Verwendung mit Ceph konfigurieren.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-cfg-vm">
  <title>Konfigurieren der VM</title>

  <para>
   In diesem Kapitel konzentrieren wir uns auf die Konfiguration von VMs zur Integration in Ceph über <command>virsh</command>. Für <command>virsh</command>-Kommandos werden oft Root-Berechtigungen (<command>sudo</command>) benötigt. Sie geben außerdem nicht die entsprechenden Ergebnisse zurück und benachrichtigen Sie auch nicht, dass Root-Berechtigungen erforderlich sind. Weitere Informationen zu den <command>virsh</command>-Kommandos finden Sie unter <command>man 1 virsh</command> (das Paket <package>libvirt-client</package> muss installiert sein).
  </para>

  <procedure>
   <step>
    <para>
     Öffnen Sie die Konfigurationsdatei mit <command>virsh edit</command>
     <replaceable>vm-domain-name</replaceable>.
    </para>
<screen><prompt role="root"># </prompt>virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     Unter &lt;devices&gt; sollte ein &lt;disk&gt;-Eintrag vorhanden sein.
    </para>
<screen>&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-<replaceable>SYSTEM-ARCH</replaceable>&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/image/recent-linux.img'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='drive' controller='0' bus='0' unit='0'/&gt;
    &lt;/disk&gt;</screen>
    <para>
     Ersetzen Sie <filename>/path/to/image/recent-linux.img</filename> durch den Pfad zum Betriebssystem-Image.
    </para>
    <important>
     <para>
      Verwenden Sie <command>sudo virsh edit</command> anstelle eines Texteditors. Wenn Sie die Konfigurationsdatei unter <filename>/etc/qemu</filename> mit einem Texteditor ändern, erkennt <systemitem class="library">libvirt</systemitem>libvirt die Änderung möglicherweise nicht. Wenn eine Diskrepanz zwischen dem Inhalt der XML-Datei unter <filename>/etc/libvirt/qemu</filename> und dem Ergebnis aus <command>sudo virsh dumpxml</command> <replaceable>vm-domain-name</replaceable> auftritt, funktioniert Ihre VM möglicherweise nicht ordnungsgemäß.
     </para>
    </important>
   </step>
   <step>
    <para>
     Fügen Sie das vorher erstellte Ceph RBD-Image als &lt;disk&gt;-Eintrag hinzu.
    </para>
<screen>&lt;disk type='network' device='disk'&gt;
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'&gt;
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/&gt;
        &lt;/source&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;</screen>
    <para>
     Ersetzen Sie <replaceable>monitor-host</replaceable> durch den Namen Ihres Hosts und ersetzen Sie den Pool und/oder den Image-Namen wie erforderlich. Sie haben die Möglichkeit, für Ihre Ceph Monitors mehrere &lt;Host&gt;-Einträge hinzuzufügen. Das <literal>dev</literal>-Attribut ist der logische Gerätename, der unter dem <filename>/dev</filename>-Verzeichnis Ihrer VM angezeigt wird. Das optionale Busattribut gibt den Typ des zu emulierenden Datenträgergeräts an. Die gültigen Einstellungen sind treiberspezifisch (zum Beispiel ide, scsi, virtio, xen, usb oder sata).
    </para>
   </step>
   <step>
    <para>
     Datei speichern.
    </para>
   </step>
   <step>
    <para>
     Wenn bei Ihrem Ceph-Cluster die Authentifizierung aktiviert ist (was standardmäßig der Fall ist), dann müssen Sie ein Geheimnis generieren. Öffnen Sie den Editor Ihrer Wahl und erstellen Sie eine Datei namens <filename>secret.xml</filename> mit folgendem Inhalt:
    </para>
<screen>&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;</screen>
   </step>
   <step>
    <para>
     Definieren Sie das Geheimnis.
    </para>
<screen><prompt role="root"># </prompt>virsh secret-define --file secret.xml
&lt;uuid of secret is output here&gt;</screen>
   </step>
   <step>
    <para>
     Rufen Sie den <literal>client.libvirt</literal>-Schlüssel ab und speichern Sie die Schlüsselzeichenkette in eine Datei.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     Legen Sie die UUID für das Geheimnis fest.
    </para>
<screen><prompt role="root"># </prompt>virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     Sie müssen auch das Geheimnis manuell festlegen. Fügen Sie dazu den folgenden <literal>&lt;auth&gt;</literal>-Eintrag zum vorher eingegebenen <literal>&lt;disk&gt;</literal>-Element hinzu (was den UUID-Wert durch das Ergebnis aus dem oben genannten Kommandozeilenbeispiel ersetzt).
    </para>
<screen><prompt role="root"># </prompt>virsh edit libvirt-virtual-machine</screen>
    <para>
     Fügen Sie dann das <literal>&lt;auth&gt;&lt;/auth&gt;</literal>-Element zur Konfigurationsdatei der Domäne hinzu:
    </para>
<screen>...
&lt;/source&gt;
&lt;auth username='libvirt'&gt;
        &lt;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/&gt;
&lt;/auth&gt;
&lt;target ...</screen>
    <note>
     <para>
      Die Beispiel-ID ist <literal>libvirt</literal>, nicht der Ceph-Name <literal>client.libvirt</literal> wie in Schritt 2 in <xref linkend="ceph-libvirt-cfg-ceph"/> generiert. Stellen Sie sicher, dass Sie die ID-Komponente des generierten Ceph-Namens verwenden. Wenn Sie aus irgendeinem Grund das Geheimnis neu generieren müssen, dann müssen Sie <command>sudo virsh secret-undefine</command> <replaceable>uuid</replaceable> ausführen, bevor Sie <command>sudo virsh secret-set-value</command> erneut ausführen.
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-summary">
  <title>Zusammenfassung</title>

  <para>
   Sie können die VM starten, sobald Sie die VM zur Verwendung mit Ceph konfiguriert haben. Führen Sie die folgenden Schritte aus, um zu verifizieren, dass die VM und Ceph miteinander kommunizieren.
  </para>

  <procedure>
   <step>
    <para>
     Prüfen Sie, ob Ceph ausgeführt wird:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph health</screen>
   </step>
   <step>
    <para>
     Prüfen Sie, ob die VM ausgeführt wird:
    </para>
<screen><prompt role="root"># </prompt>virsh list</screen>
   </step>
   <step>
    <para>
     Prüfen Sie, ob die VM mit Ceph kommuniziert: Ersetzen Sie <replaceable>vm-domain-name</replaceable> durch den Namen Ihrer VM-Domäne:
    </para>
<screen><prompt role="root"># </prompt>virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     Überprüfen Sie, ob das Gerät vom <literal>&amp;target dev=&apos;hdb&apos; bus=&apos;ide&apos;/&gt;</literal> unter <filename>/dev</filename> oder unter <filename>/proc/partitions</filename> erscheint:
    </para>
<screen><prompt>&gt; </prompt>ls /dev
<prompt>&gt; </prompt>cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
