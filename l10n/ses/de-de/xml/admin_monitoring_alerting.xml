<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_monitoring_alerting.xml" version="5.0" xml:id="monitoring-alerting">
 <title>Überwachung und Warnungen</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  In SUSE Enterprise Storage 7.1 stellt cephadm einen Überwachungs- und Warnungsstack bereit. Anwender müssen die Services (wie Prometheus, Alertmanager und Grafana), die sie mit cephadm bereitstellen wollen, entweder in einer YAML-Konfigurationsdatei definieren, oder sie können sie über die Kommandozeilenschnittstelle bereitstellen. Wenn mehrere Services desselben Typs bereitgestellt werden, wird eine hochverfügbare Einrichtung bereitgestellt. Der Node Exporter stellt eine Ausnahme von dieser Regel dar.
 </para>
 <para>
  Die folgenden Überwachungsservices können mit cephadm bereitgestellt werden:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis role="bold">Prometheus</emphasis> ist das Überwachungs- und Warnmeldungs-Toolkit. Es sammelt die von Prometheus-Exportern bereitgestellten Daten und löst vorkonfigurierte Warnungen aus, wenn vordefinierte Schwellenwerte erreicht wurden.
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">Alertmanager</emphasis> verarbeitet die durch den Prometheus-Server gesendeten Warnmeldungen. Es dedupliziert und gruppiert die Warnungen und leitet sie an den richtigen Empfänger weiter. Standardmäßig wird das Ceph Dashboard automatisch als Empfänger konfiguriert.
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">Grafana</emphasis> ist die Visualisierungs- und Warnmeldungs-Software. Die Warnungsfunktion von Grafana wird von diesem Überwachungs-Stack nicht genutzt. Für Warnungen wird der Alertmanager verwendet.
   </para>
  </listitem>
  <listitem>
   <para>
    Der <emphasis role="bold">Node Exporter</emphasis> ist ein Exporter für Prometheus, der Daten über den Knoten liefert, auf dem er installiert ist. Es wird empfohlen, den Node Exporter auf allen Knoten zu installieren.
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Das Prometheus-Manager-Modul stellt einen Prometheus-Exporter bereit, um Ceph-Leistungszähler von der Sammelstelle in <literal>ceph-mgr</literal> weiterzugeben.
 </para>
 <para>
  Die Prometheus-Konfiguration, einschließlich der <emphasis>Scrape</emphasis>-Ziele (Daemons, die Kennzahlen bereitstellen), wird automatisch von cephadm eingerichtet. cephadm stellt außerdem eine Liste standardmäßiger Warnungen bereit, z. B. <literal>health error</literal> (Zustandsfehler), <literal>10% OSDs down</literal> (10 % der OSDs inaktiv) oder <literal>pgs inactive</literal> (PGs inaktiv).
 </para>
 <para>
  Standardmäßig wird der Datenverkehr zu Grafana mit TLS verschlüsselt. Sie können entweder ein eigenes TLS-Zertifikat bereitstellen oder ein eigensigniertes Zertifikat verwenden. Wenn vor dem Bereitstellen von Grafana kein benutzerdefiniertes Zertifikat konfiguriert wurde, dann wird automatisch ein eigensigniertes Zertifikat erstellt und für Grafana konfiguriert.
 </para>
 <para>
  Sie können benutzerdefinierte Zertifikate für Grafana konfigurieren, indem Sie diese Schritte ausführen:
 </para>
 <procedure>
  <step>
   <para>
    Konfigurieren Sie Zertifikatsdateien:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt> ceph config-key set mgr/cephadm/grafana_key -i $PWD/key.pem
<prompt>cephuser@adm &gt; </prompt> ceph config-key set mgr/cephadm/grafana_crt -i $PWD/certificate.pem
</screen>
  </step>
  <step>
   <para>
    Starten Sie den Ceph-Manager-Dienst neu:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mgr</screen>
  </step>
  <step>
   <para>
    Konfigurieren Sie den Grafana-Dienst neu, um die neuen Zertifikatspfade zu berücksichtigen und die richtige URL für das Ceph Dashboard festzulegen:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch reconfig grafana</screen>
  </step>
 </procedure>
 <para>
  Alertmanager verarbeitet die durch den Prometheus-Server gesendeten Warnmeldungen. Hiermit werden die Warnmeldungen dedupliziert, gruppiert und an den richtigen Empfänger geleitet. Warnungen können über den Alertmanager stummgeschaltet werden. Stummschaltungen können aber auch über das Ceph Dashboard verwaltet werden.
 </para>
 <para>
  Es wird empfohlen, den <systemitem class="daemon">Node exporter</systemitem> auf allen Knoten zu installieren. Dies kann über die Datei <filename>monitoring.yaml</filename> mit dem Servicetyp <literal>node-exporter</literal> erfolgen. Im <xref linkend="deploy-cephadm-day2-service-monitoring"/> finden Sie weitere Informationen zum Bereitstellen von Services.
 </para>
 <sect1 xml:id="monitoring-custom-images">
  <title>Konfigurieren von benutzerdefinierten oder lokalen Images</title>

  <tip>
   <para>
    In diesem Abschnitt wird beschrieben, wie Sie die Konfiguration von Container-Images ändern, die beim Bereitstellen oder Aktualisieren von Services verwendet werden. Er enthält nicht die Kommandos, die zum Bereitstellen oder erneuten Bereitstellen von Services erforderlich sind.
   </para>
   <para>
    Die empfohlene Methode zum Bereitstellen des Überwachungs-Stacks besteht in der Anwendung seiner Spezifikation, wie im <xref linkend="deploy-cephadm-day2-service-monitoring"/>beschrieben.
   </para>
  </tip>

  <para>
   Zum Bereitstellen benutzerdefinierter oder lokaler Container-Images müssen die Images in cephadm festgelegt werden. Dazu müssen Sie folgendes Kommando ausführen:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/cephadm/<replaceable>OPTION_NAME</replaceable> <replaceable>VALUE</replaceable></screen>

  <para>
   <replaceable>OPTION_NAME</replaceable> bezeichnet einen der folgenden Namen:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     container_image_prometheus
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_node_exporter
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_alertmanager
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_grafana
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Wenn keine Option festgelegt ist oder wenn die Einstellung entfernt wurde, werden die folgenden Images als <replaceable>VALUE</replaceable> verwendet:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/prometheus-server:2.32.1
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/prometheus-node-exporter:1.1.2
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/prometheus-alertmanager:0.21.0
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/ses/7.1/ceph/grafana:7.5.12
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Beispiel:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/cephadm/container_image_prometheus prom/prometheus:v1.4.1</screen>

  <note>
   <para>
    Durch Festlegen eines benutzerdefinierten Image wird der Standardwert außer Kraft gesetzt (aber nicht überschrieben). Der Standardwert ändert sich, wenn Aktualisierungen verfügbar sind. Wenn Sie ein benutzerdefiniertes Bild festlegen, können Sie die Komponente, für die Sie das benutzerdefinierte Image festgelegt haben, nicht automatisch aktualisieren. Sie müssen die Konfiguration (Image-Namen und Tag) manuell aktualisieren, um Aktualisierungen installieren zu können.
   </para>
   <para>
    Wenn Sie sich stattdessen für die Empfehlungen entscheiden, können Sie das zuvor festgelegte benutzerdefinierte Image zurücksetzen. Danach wird wieder der Standardwert verwendet. Verwenden Sie <command>ceph config rm</command>, um die Konfigurationsoption zurückzusetzen:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config rm mgr mgr/cephadm/<replaceable>OPTION_NAME</replaceable></screen>
   <para>
    Beispiel:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config rm mgr mgr/cephadm/container_image_prometheus</screen>
  </note>
 </sect1>
 <sect1 xml:id="monitoring-applying-updates">
  <title>Aktualisieren von Überwachungsservices</title>

  <para>
   Wie in <xref linkend="monitoring-custom-images"/> erwähnt, sind im Lieferumfang von cephadm die URLs der empfohlenen und getesteten Container-Images vorhanden. Diese werden standardmäßig verwendet.
  </para>

  <para>
   In Aktualisierungen der Ceph-Pakete können neue Versionen dieser URLs bereitgestellt werden. Dadurch wird nur aktualisiert, woher die Container-Images abgerufen werden, es werden aber keine Services aktualisiert.
  </para>

  <para>
   Die Überwachungsservices können aktualisiert werden, nachdem die URLs zu den neuen Container-Images aktualisiert wurden – entweder manuell, wie in <xref linkend="monitoring-custom-images"/> beschrieben, oder automatisch durch eine Aktualisierung des Ceph-Pakets.
  </para>

  <para>
   Verwenden Sie dazu <command>ceph orch reconfig</command> wie folgt:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig node-exporter
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig prometheus
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig alertmanager
<prompt>cephuser@adm &gt; </prompt>ceph orch reconfig grafana
</screen>

  <para>
   Zurzeit gibt es kein einzelnes Kommando zum Aktualisieren aller Überwachungsservices. Die Reihenfolge, in der diese Services aktualisiert werden, ist nicht wichtig.
  </para>

  <note>
   <para>
    Wenn Sie benutzerdefinierte Container-Images verwenden, werden die für die Überwachungsservices angegebenen URLs nicht automatisch geändert, wenn die Ceph-Pakete aktualisiert werden. Wenn Sie benutzerdefinierte Container-Images angegeben haben, müssen Sie die URLs der neuen Container-Images manuell angeben. Dies kann der Fall sein, wenn Sie eine lokale Container-Registrierung verwenden.
   </para>
   <para>
    Die URLs der empfohlenen Container-Images, die Sie verwenden sollten, finden Sie in <xref linkend="monitoring-custom-images"/>.
   </para>
  </note>
 </sect1>
 <sect1 xml:id="monitoring-stack-disable">
  <title>Deaktivieren der Überwachung</title>

  <para>
   Deaktivieren Sie den Überwachungs-Stack mit folgenden Kommandos:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch rm grafana
<prompt>cephuser@adm &gt; </prompt>ceph orch rm prometheus --force   # this will delete metrics data collected so far
<prompt>cephuser@adm &gt; </prompt>ceph orch rm node-exporter
<prompt>cephuser@adm &gt; </prompt>ceph orch rm alertmanager
<prompt>cephuser@adm &gt; </prompt>ceph mgr module disable prometheus
      </screen>
 </sect1>
 <sect1 xml:id="monitoring-grafana-config">
  <title>Konfigurieren von Grafana</title>

  <para>
   Das Ceph-Dashboard-Back-End benötigt die Grafana-URL, um das Vorhandensein von Grafana-Dashboards zu verifizieren, noch bevor das Frontend sie lädt. Aufgrund der Art und Weise, wie Grafana in Ceph Dashboard implementiert ist, bedeutet dies, dass zwei funktionierende Verbindungen erforderlich sind, um Grafana-Graphe in Ceph Dashboard sehen zu können:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Das Back-End (Ceph MGR-Modul) muss prüfen, ob der angeforderte Graph vorhanden ist. Wenn diese Anfrage erfolgreich ist, teilt es dem Frontend mit, dass es sicher auf Grafana zugreifen kann.
    </para>
   </listitem>
   <listitem>
    <para>
     Das Frontend fordert dann die Grafana-Graphen direkt vom Browser des Benutzers über einen <literal>iframe</literal> an. Der Zugriff auf die Grafana-Instanz erfolgt direkt und ohne Umweg über das Ceph Dashboard.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   In Ihrer Umgebung kann der Browser des Benutzers womöglich nicht direkt auf die im Ceph Dashboard konfigurierte URL zugreifen. Um dieses Problem zu lösen, kann eine separate URL konfiguriert werden, die ausschließlich dazu dient, dem Frontend (dem Browser des Benutzers) mitzuteilen, welche URL es für den Zugriff auf Grafana verwenden soll.
  </para>

  <para>
   Mit folgendem Kommando ändern Sie die URL, die an das Frontend zurückgegeben wird:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard set-grafana-frontend-api-url <replaceable>GRAFANA-SERVER-URL</replaceable></screen>

  <para>
   Wenn kein Wert für diese Option festgelegt ist, wird einfach auf den Wert der Option <replaceable>GRAFANA_API_URL</replaceable> zurückgegriffen. Er wird automatisch festgelegt und regelmäßig von cephadm aktualisiert. Wenn er festgelegt ist, wird der Browser angewiesen, diese URL für den Zugriff auf Grafana zu verwenden.
  </para>
 </sect1>
 <sect1 xml:id="monitoring-cephadm-config">
  <title>Konfigurieren des Prometheus-Manager-Moduls</title>

  <para>
   Das Prometheus-Manager-Modul ist ein Modul innerhalb von Ceph, mit dem die Funktionalität von Ceph erweitert wird. Das Modul liest (Meta-)Daten von Ceph über seinen Status und Zustand und stellt die (gescrapten) Daten in einem verwertbaren Format für Prometheus bereit.
  </para>

  <note>
   <para>
    Das Prometheus-Manager-Modul muss neu gestartet werden, damit die Konfigurationsänderungen übernommen werden.
   </para>
  </note>

  <sect2 xml:id="monitoring-http-requests">
   <title>Konfigurieren der Netzwerkschnittstelle</title>
   <para>
    Standardmäßig akzeptiert das Prometheus-Manager-Modul HTTP-Anfragen an Port 9283 auf allen IPv4- und IPv6-Adressen des Hosts. Der Port und die Überwachungsadresse sind beide mit <option>ceph config-key set</option> konfigurierbar, mit den Schlüsseln <option>mgr/prometheus/server_addr</option> und <option>mgr/prometheus/server_port</option>. Dieser Port ist in der Registrierung von Prometheus registriert.
   </para>
   <para>
    Aktualisieren Sie die <literal>server_addr</literal> mit folgendem Kommando:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/server_addr <replaceable>0.0.0.0</replaceable>
      </screen>
   <para>
    Aktualisieren Sie den <literal>server_port</literal> mit folgendem Kommando:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/server_port <replaceable>9283</replaceable>
      </screen>
  </sect2>

  <sect2 xml:id="monitoring-scrape-intervals">
   <title>Konfigurieren des <literal>scrape_interval</literal></title>
   <para>
    Standardmäßig ist das Prometheus-Manager-Modul mit einem Scrape-Intervall von 15 Sekunden konfiguriert. Ein Scrape-Intervall unter 10 Sekunden ist nicht zu empfehlen. Legen Sie <literal>scrape_interval</literal> auf den gewünschten Wert fest, um ein anderes Scrape-Intervall im Prometheus-Modul festzulegen:
   </para>
   <important>
    <para>
     Für eine korrekte und problemlose Funktionsweise sollte das <literal>scrape_interval</literal> dieses Moduls immer so festgelegt werden, dass es dem Prometheus-Scrape-Intervall entspricht.
    </para>
   </important>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/scrape_interval <replaceable>15</replaceable>
      </screen>
  </sect2>

  <sect2 xml:id="monitoring-stale-cache">
   <title>Konfigurieren des Caches</title>
   <para>
    Bei großen Clustern (mehr als 1000 OSDs) kann das Abrufen der Kennzahlen viel Zeit in Anspruch nehmen. Ohne den Cache kann das Prometheus-Manager-Modul den Manager überlasten und zu nicht reagierenden oder abstürzenden Ceph-Manager-Instanzen führen. Daher ist der Cache standardmäßig aktiviert und kann nicht deaktiviert werden, was jedoch zu einem veralteten Cache führen kann. Der Cache wird als veraltet angesehen, wenn die Zeit zum Abrufen der Kennzahlen von Ceph das konfigurierte <literal>scrape_interval</literal> überschreitet.
   </para>
   <para>
    Wenn dies der Fall ist, wird eine Warnung protokolliert und das Modul reagiert auf zwei mögliche Arten:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Es antwortet mit einem 503-HTTP-Statuscode (Service nicht verfügbar).
     </para>
    </listitem>
    <listitem>
     <para>
      Es gibt den Inhalt des Caches zurück, auch wenn er womöglich veraltet ist.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Dieses Verhalten kann mit den <command>ceph config set</command>-Kommandos konfiguriert werden.
   </para>
   <para>
    Legen Sie das Modul auf <literal>return</literal> fest, um es anzuweisen, mit möglicherweise veralteten Daten zu antworten:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/stale_cache_strategy return</screen>
   <para>
    Legen Sie das Modul auf <literal>fail</literal> fest, um es anzuweisen, mit <literal>service unavailable</literal> zu antworten:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/stale_cache_strategy fail</screen>
  </sect2>

  <sect2 xml:id="monitoring-rbd-image">
   <title>Aktivieren der RBD-Image-Überwachung</title>
   <para>
    Durch Aktivieren der dynamischen OSD-Leistungszähler kann das Prometheus-Manager-Modul optional RBD-pro-Image-Statistiken sammeln. Die Statistiken werden für alle Images in den Pools gesammelt, die im Konfigurationsparameter <literal>mgr/prometheus/rbd_stats_pools</literal> angegeben sind.
   </para>
   <para>
    Der Parameter ist eine durch Komma oder Leerzeichen getrennte Liste von <literal>pool[/namespace]</literal>-Einträgen. Wenn der Namespace nicht angegeben ist, wird die Statistik für alle Namespaces im Pool gesammelt.
   </para>
   <para>
    Beispiel:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/rbd_stats_pools "<replaceable>pool1,pool2,poolN</replaceable>"
      </screen>
   <para>
    Das Modul sucht die angegebenen Pools und Namespaces ab, erstellt eine Liste aller verfügbaren Images und aktualisiert sie in regelmäßigen Abständen. Das Intervall ist über den Parameter <literal>mgr/prometheus/rbd_stats_pools_refresh_interval</literal> konfigurierbar (in Sekunden) und beträgt standardmäßig 300 Sekunden (fünf Minuten).
   </para>
   <para>
    Wenn Sie beispielsweise das Synchronisierungsintervall auf 10 Minuten geändert haben:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/rbd_stats_pools_refresh_interval <replaceable>600</replaceable>
      </screen>
  </sect2>
 </sect1>
 <sect1 xml:id="prometheus-security-model">
  <title>Prometheus-Sicherheitsmodell</title>

  <para>
   Das Sicherheitsmodell von Prometheus geht davon aus, dass nicht vertrauenswürdige Benutzer Zugriff auf den Prometheus-HTTP-Endpunkt und die Protokolle haben. Nicht vertrauenswürdige Benutzer haben Zugriff auf alle (Meta-)Daten, die Prometheus sammelt und die in der Datenbank enthalten sind, sowie auf eine Vielzahl von Betriebs- und Debugging-Informationen.
  </para>

  <para>
   Die HTTP-API von Prometheus ist jedoch auf reine Lesevorgänge beschränkt. Konfigurationen können nicht über die API geändert werden, und Geheimnisse werden nicht offengelegt. Darüber hinaus verfügt Prometheus über einige integrierte Maßnahmen zur Abschwächung der Auswirkungen von Denial-of-Service-Angriffen.
  </para>
 </sect1>
 <sect1 xml:id="prometheus-webhook-snmp">
  <title>Prometheus Alertmanager SNMP-Gateway</title>

  <para>
   Wenn Sie mithilfe von SNMP-Traps über Prometheus-Warnungen benachrichtigt werden möchten, können Sie den Prometheus-Alertmanager-SNMP-Gateway über cephadm oder das Ceph Dashboard installieren. Für SNMPv2c müssen Sie dazu beispielsweise eine Service- und Platzierungsspezifikationsdatei mit folgendem Inhalt erstellen:
  </para>

  <note>
   <para>
    Weitere Informationen zum Erstellen von Service- und Platzierungsspezifikationsdateien finden Sie in <xref linkend="cephadm-service-and-placement-specs"/>.
   </para>
  </note>

<screen>
service_type: snmp-gateway
service_name: snmp-gateway
placement:
    <replaceable>ADD_PLACEMENT_HERE</replaceable>
spec:
  credentials:
    snmp_community: <replaceable>ADD_COMMUNITY_STRING_HERE</replaceable>
  snmp_destination: <replaceable>ADD_FQDN_HERE</replaceable>:<replaceable>ADD_PORT_HERE</replaceable>
  snmp_version: V2c
</screen>

  <para>
   Alternativ können Sie den SNMP-Gateway-Dienst für SNMPv2c und SNMPv3 auch über das Ceph Dashboard bereitstellen. Weitere Einzelheiten finden Sie unter <xref linkend="dashboard-cluster-services"/>.
  </para>
 </sect1>
</chapter>
