<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_salt.xml" version="5.0" xml:id="deploy-salt">
 <info>
  <title>Distribuzione Salt</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storage utilizza Salt e <systemitem class="resource">ceph-salt</systemitem> per la preparazione iniziale del cluster. Salt consente di configurare ed eseguire contemporaneamente i comandi su più nodi del cluster da un host dedicato denominato <emphasis>Salt Master</emphasis>. Prima della distribuzione Salt, esaminare quanto segue:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    I <emphasis>Salt Minion</emphasis> sono i nodi controllati da un nodo dedicato denominato Salt Master.
   </para>
  </listitem>
  <listitem>
   <para>
    Se l&apos;host Salt Master deve fare parte del cluster Ceph, deve eseguire il proprio Salt Minion, anche se non si tratta di un requisito obbligatorio.
   </para>
   <tip>
    <title>condivisione di più ruoli per server</title>
    <para>
     È possibile ottenere le prestazioni migliori dal cluster Ceph quando ogni ruolo viene distribuito su un nodo separato. Le installazioni reali, tuttavia, a volte richiedono la condivisione di un nodo per più ruoli. Per evitare problemi di prestazioni e con la procedura di upgrade, non distribuire il ruolo Ceph OSD, del server di metadati o Ceph Monitor sul nodo admin.
    </para>
   </tip>
  </listitem>
  <listitem>
   <para>
    I Salt Minion devono risolvere correttamente il nome host del Salt Master in rete. Per default, cercano il nome host <systemitem>salt</systemitem>, ma è possibile specificare altri nomi host individuabili in rete nel file <filename>/etc/salt/minion</filename>.
   </para>
  </listitem>
 </itemizedlist>
 <procedure>
  <step>
   <para>
    Installare il <literal>salt-master</literal> sul nodo Salt Master:
   </para>
<screen><prompt>root@master # </prompt>zypper in salt-master</screen>
  </step>
  <step>
   <para>
    Verificare che il servizio <systemitem>salt-master</systemitem> sia abilitato e avviato, se necessario abilitarlo e avviarlo:
   </para>
<screen><prompt>root@master # </prompt>systemctl enable salt-master.service
<prompt>root@master # </prompt>systemctl start salt-master.service</screen>
  </step>
  <step>
   <para>
    Se si intende utilizzare il firewall, verificare che il nodo Salt Master abbia le porte 4505 e 4506 aperte per tutti i nodi Salt Minion. Se le porte sono chiuse, è possibile aprirle con il comando <command>yast2 firewall</command> consentendo il servizio <guimenu>salt-master</guimenu> per la zona appropriata. Ad esempio, <literal>public</literal>.
   </para>
  </step>
  <step>
   <para>
    Installare il pacchetto <literal>salt-minion</literal> su tutti i nodi minion.
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper in salt-minion</screen>
  </step>
  <step>
   <para>
    Modificare <filename>/etc/salt/minion</filename> e rimuovere i commenti dalla riga seguente:
   </para>
<screen>#log_level_logfile: warning</screen>
   <para>
    Modificare il livello di log da <literal>warning</literal> a <literal>info</literal>.
   </para>
   <note>
    <title><option>log_level_logfile</option> e <option>log_level</option></title>
    <para>
     Mentre <option>log_level</option> controlla i messaggi di log che verranno visualizzati sulla schermata, <option>log_level_logfile</option> controlla i messaggi di log che verranno scritti su <filename>/var/log/salt/minion</filename>.
    </para>
   </note>
   <note>
    <para>
     Assicurarsi di impostare il livello di log su <emphasis>tutti</emphasis> i nodi del cluster (minion).
    </para>
   </note>
  </step>
  <step>
   <para>
    Assicurarsi che il <emphasis>nome di dominio completo</emphasis> di ogni nodo possa essere risolto in un indirizzo IP sulla rete di cluster pubblica da tutti gli altri nodi.
   </para>
  </step>
  <step>
   <para>
    Configurare tutti i minion sulla connessione al master. Se il Salt Master non è raggiungibile dal nome host <literal>salt</literal>, modificare il file <filename>/etc/salt/minion</filename> oppure creare un nuovo file <filename>/etc/salt/minion.d/master.conf</filename> con il contenuto seguente:
   </para>
<screen>master: <replaceable>host_name_of_salt_master</replaceable></screen>
   <para>
    Se sono state apportate modifiche ai file di configurazione menzionati sopra, riavviare il servizio Salt su tutti i Salt Minion correlati:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart salt-minion.service</screen>
  </step>
  <step>
   <para>
    Verificare che il servizio <systemitem>salt-minion</systemitem> sia abilitato e avviato su tutti i nodi. Abilitarlo e avviarlo se necessario:
   </para>
<screen><prompt role="root"># </prompt>systemctl enable salt-minion.service
<prompt role="root"># </prompt>systemctl start salt-minion.service</screen>
  </step>
  <step>
   <para>
    Verificare ogni impronta digitale del Salt Minion e accettare tutte le chiavi salt sul Salt Master se le impronte digitali corrispondono.
   </para>
   <note>
    <para>
     Se l&apos;impronta digitale del Salt Minion viene restituita vuota, assicurarsi che il Salt Minion disponga di una configurazione Salt Master e che sia in grado di comunicare con quest&apos;ultimo.
    </para>
   </note>
   <para>
    Visualizzare l&apos;impronta di ogni minion:
   </para>
<screen><prompt>root@minion &gt; </prompt>salt-call --local key.finger
local:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Dopo aver raccolto le impronte digitali di tutti i Salt Minion, elencare le impronte di tutte le chiavi minion non accettate sul Salt Master:
   </para>
<screen><prompt>root@master # </prompt>salt-key -F
[...]
Unaccepted Keys:
minion1:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    Se le impronte digitali dei minion corrispondono, accettarle:
   </para>
<screen><prompt>root@master # </prompt>salt-key --accept-all</screen>
  </step>
  <step>
   <para>
    Verificare che le chiavi siano state accettate:
   </para>
<screen><prompt>root@master # </prompt>salt-key --list-all</screen>
  </step>
  <step>
   <para>
    Verificare se tutti i Salt Minion rispondono:
   </para>
<screen><prompt>root@master # </prompt>salt-run manage.status</screen>
  </step>
 </procedure>
</chapter>
