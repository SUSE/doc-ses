<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_gateway.xml" version="5.0" xml:id="cha-ceph-gw">
 
 <title>Ceph Object Gateway</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  In questo capitolo vengono fornite ulteriori informazioni sui task amministrativi correlati a Object Gateway, come la verifica dello stato del servizio, la gestione degli account, i gateway multisito o l&apos;autenticazione LDAP.
 </para>
 <sect1 xml:id="sec-ceph-rgw-limits">
  <title>Restrizioni e limitazioni di denominazione di Object Gateway</title>

  <para>
   Di seguito è riportato un elenco di importanti limiti Object Gateway:
  </para>

  <sect2 xml:id="ogw-limits-bucket">
   <title>Limitazioni dei compartimenti</title>
   <para>
    Quando si inizia a utilizzare Object Gateway tramite l&apos;API S3, i nomi dei compartimenti sono limitati ai nomi conformi a DNS in cui è consentito un trattino &quot;-&quot;. Quando si inizia a utilizzare Object Gateway tramite l&apos;API Swift, è possibile utilizzare una combinazione qualsiasi di caratteri UTF-8 supportati, tranne la barra &quot;/&quot;. La lunghezza massima di un nome di compartimento è di 255 caratteri. I nomi dei compartimenti devono essere univoci.
   </para>
   <tip>
    <title>utilizzo di nomi di compartimenti conformi a DNS</title>
    <para>
     Sebbene sia possibile utilizzare qualsiasi nome di compartimento basato su UTF-8 tramite l&apos;API Swift, si consiglia di denominare i compartimenti tenendo in considerazione i limiti di denominazione S3 in modo da evitare problemi di accesso allo stesso compartimento tramite l&apos;API S3.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ogw-limits-object">
   <title>Limitazioni degli oggetti memorizzati</title>
   <variablelist>
    <varlistentry>
     <term>Numero massimo di oggetti per utente</term>
     <listitem>
      <para>
       Per default, nessuna restrizione (limite definito da ~ 2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Numero massimo di oggetti per compartimento</term>
     <listitem>
      <para>
       Per default, nessuna restrizione (limite definito da ~ 2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Dimensioni massime di un oggetto di cui effettuare l&apos;upload/da memorizzare</term>
     <listitem>
      <para>
       Gli upload singoli sono limitati a 5 GB. Utilizzare multipart per dimensioni grandi degli oggetti. Il numero massimo di porzioni multipart è 10000.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ogw-limits-http">
   <title>Limitazioni dell&apos;intestazione HTTP</title>
   <para>
    L&apos;intestazione HTTP e il limite di richiesta dipendono dalla front-end Web utilizzata. L&apos;oggetto beast di default limita le dimensioni dell&apos;intestazione HTTP a 16 KB.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-deploy">
  <title>Distribuzione di Object Gateway</title>

  <para>
   Analogamente agli altri servizi Ceph, Ceph Object Gateway viene distribuito tramite cephadm. Per ulteriori dettagli, fare riferimento a <xref linkend="cephadm-service-and-placement-specs"/>, nello specifico a <xref linkend="deploy-cephadm-day2-service-ogw"/>.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-operating">
  <title>Attivazione del servizio Object Gateway</title>

  <para>
   In modo analogo agli altri servizi Ceph, gli Object Gateway vengono attivati identificando innanzitutto il nome del servizio con il comando <command>ceph orch ps</command> ed eseguendo quindi il comando di attivazione seguente, ad esempio:
  </para>

<screen>ceph orch daemon restart <replaceable>OGW_SERVICE_NAME</replaceable></screen>

  <para>
   Fare riferimento al <xref linkend="cha-ceph-operating"/> per informazioni complete sull&apos;attivazione dei servizi Ceph.
  </para>
 </sect1>
 <sect1 xml:id="ogw-config-parameters">
  <title>Opzioni di configurazione</title>

  <para>
   Fare riferimento alla <xref linkend="config-ogw"/> per un elenco delle opzioni di configurazione di Object Gateway.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-access">
  <title>Gestione dell&apos;accesso a Object Gateway</title>

  <para>
   È possibile comunicare con Object Gateway mediante l&apos;interfaccia compatibile con S3 o Swift. L&apos;interfaccia S3 è compatibile con un grande sottoinsieme dell&apos;API Amazon S3 RESTful. L&apos;interfaccia Swift è compatibile con un grande sottoinsieme dell&apos;API OpenStack Swift.
  </para>

  <para>
   Per entrambe le interfacce è richiesto di creare un utente specifico e installare il software client pertinente per comunicare con il gateway che utilizza la chiave segreta dell&apos;utente.
  </para>

  <sect2 xml:id="accessing-ragos-gateway">
   <title>Accesso a Object Gateway</title>
   <sect3 xml:id="ogw-s3-interface-access">
    <title>Accesso all&apos;interfaccia S3</title>
    <para>
     Per accedere all&apos;interfaccia S3, è necessario un client REST. <command>S3cmd</command> è un client S3 della riga di comando. È possibile trovarlo in <link xlink:href="https://build.opensuse.org/package/show/Cloud:Tools/s3cmd">openSUSE Build Service (OBS)</link> (in lingua inglese). L&apos;archivio contiene versioni di entrambe le distribuzioni basate su SUSE Linux Enterprise e openSUSE.
    </para>
    <para>
     Se si desidera testare l&apos;accesso all&apos;interfaccia S3, è anche possibile scrivere un piccolo script Python, che consentirà di eseguire la connessione a Object Gateway, creare un nuovo compartimento ed elencare tutti i compartimenti. I valori per <option>aws_access_key_id</option> e <option>aws_secret_access_key</option> sono ricavati dai valori di <option>access_key</option> e <option>secret_key</option> restituiti dal comando <command>radosgw_admin</command> di cui alla <xref linkend="adding-s3-swift-users"/>.
    </para>
    <procedure>
     <step>
      <para>
       Installare il pacchetto <systemitem>python-boto</systemitem>:
      </para>
<screen><prompt role="root"># </prompt>zypper in python-boto</screen>
     </step>
     <step>
      <para>
       Creare un nuovo script Python denominato <filename>s3test.py</filename> con il seguente contenuto:
       <remark role="fixme">Provide script in RPM? Is it really necessary to create pool? This script is not necessary at all, remove it from documentation?</remark>
      </para>
<screen>import boto
import boto.s3.connection
access_key = '11BS02LGFB6AL6H1ADMW'
secret_key = 'vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY'
conn = boto.connect_s3(
aws_access_key_id = access_key,
aws_secret_access_key = secret_key,
host = '<replaceable>HOSTNAME</replaceable>',
is_secure=False,
calling_format = boto.s3.connection.OrdinaryCallingFormat(),
)
bucket = conn.create_bucket('my-new-bucket')
for bucket in conn.get_all_buckets():
  print "<replaceable>NAME</replaceable>\t<replaceable>CREATED</replaceable>".format(
  name = bucket.name,
  created = bucket.creation_date,
  )</screen>
      <para>
       Sostituire <literal><replaceable>HOSTNAME</replaceable></literal> con il nome host dell&apos;host in cui è stato configurato il servizio Object Gateway, ad esempio <literal>gateway_host</literal>.
      </para>
     </step>
     <step>
      <para>
       Eseguire lo script:
      </para>
<screen>python s3test.py</screen>
      <para>
       L&apos;output dello script è simile a quanto riportato di seguito:
      </para>
<screen>my-new-bucket 2015-07-22T15:37:42.000Z</screen>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="swift-interface-access">
    <title>Accesso all&apos;interfaccia Swift</title>
    <para>
     Per accedere a Object Gateway tramite l&apos;interfaccia Swift, è necessario il client della riga di comando <command>swift</command>. Nella relativa documentazione <command>man 1 swift</command> sono fornite ulteriori informazioni sulle rispettive opzioni della riga di comando.
    </para>
    <para>
     Il pacchetto è incluso nel modulo &quot;Public cloud&quot; di SUSE Linux Enterprise 12 a partire da SP3 e di SUSE Linux Enterprise 15. Prima di installare il pacchetto, è necessario attivare il modulo e aggiornare l&apos;archivio software:
    </para>
<screen><prompt role="root"># </prompt>SUSEConnect -p sle-module-public-cloud/12/<replaceable>SYSTEM-ARCH</replaceable>
sudo zypper refresh</screen>
    <para>
     Oppure
    </para>
<screen><prompt role="root"># </prompt>SUSEConnect -p sle-module-public-cloud/15/<replaceable>SYSTEM-ARCH</replaceable>
<prompt role="root"># </prompt>zypper refresh</screen>
    <para>
     Per installare il comando <command>swift</command>, eseguire quanto riportato di seguito:
    </para>
<screen><prompt role="root"># </prompt>zypper in python-swiftclient</screen>
    <para>
     Per l&apos;accesso swift si utilizza la seguente sintassi:
    </para>
<screen><prompt>&gt; </prompt>swift -A http://<replaceable>IP_ADDRESS</replaceable>/auth/1.0 \
-U example_user:swift -K '<replaceable>SWIFT_SECRET_KEY</replaceable>' list</screen>
    <para>
     Sostituire <replaceable>IP_ADDRESS</replaceable> con l&apos;indirizzo IP del server gateway e <replaceable>SWIFT_SECRET_KEY</replaceable> con il valore corrispondente dell&apos;output del comando <command>radosgw-admin key create</command> eseguito per l&apos;utente <systemitem>swift</systemitem> nella <xref linkend="adding-s3-swift-users"/>.
    </para>
    <para>
     Esempio:
    </para>
<screen><prompt>&gt; </prompt>swift -A http://gateway.example.com/auth/1.0 -U example_user:swift \
-K 'r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h' list</screen>
    <para>
     L&apos;output è:
    </para>
<screen>my-new-bucket</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="s3-swift-accounts-managment">
   <title>Gestione degli account S3 e Swift</title>
   <sect3 xml:id="adding-s3-swift-users">
    <title>Aggiunta di utenti S3 e Swift</title>
    <para>
     Per abilitare gli utenti finali all&apos;iterazione con il gateway, è necessario creare un utente, una chiave di accesso e un segreto. Esistono due tipi di utenti: un <emphasis>utente</emphasis> e un <emphasis>sottoutente</emphasis>. Mentre gli <emphasis>utenti</emphasis> vengono utilizzati per l&apos;iterazione con l&apos;interfaccia S3, i <emphasis>sottoutenti</emphasis> sono gli utenti dell&apos;interfaccia Swift. Ciascun sottoutente è associato a un utente.
    </para>
    <para>
     Per creare un utente Swift, seguire la procedura indicata:
    </para>
    <procedure>
     <step>
      <para>
       Per creare un utente Swift, che nella nostra terminologia è denominato <emphasis>sottoutente</emphasis>, prima è necessario creare l&apos;<emphasis>utente</emphasis> associato.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
      <para>
       Esempio:
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
     </step>
     <step>
      <para>
       Per creare un sottoutente (interfaccia Swift) per l&apos;utente, occorre specificare l&apos;ID utente (--uid=<replaceable>USERNAME</replaceable>) nonché l&apos;ID e il livello di accesso del sottoutente.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser create --uid=<replaceable>UID</replaceable> \
 --subuser=<replaceable>UID</replaceable> \
 --access=[ <replaceable>read | write | readwrite | full</replaceable> ]</screen>
      <para>
       Esempio:
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser create --uid=example_user \
 --subuser=example_user:swift --access=full</screen>
     </step>
     <step>
      <para>
       Generare una chiave segreta per l&apos;utente.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create \
   --gen-secret \
   --subuser=example_user:swift \
   --key-type=swift</screen>
     </step>
     <step>
      <para>
       L&apos;output di entrambi i comandi saranno i dati formattati per JSON in cui è visualizzato lo stato dell&apos;utente. Osservare le righe seguenti e ricordare il valore di <literal>secret_key</literal>:
      </para>
<screen>"swift_keys": [
   { "user": "example_user:swift",
     "secret_key": "r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h"}],</screen>
     </step>
    </procedure>
    <para/>
    <para>
     Se si accede a Object Gateway tramite l&apos;interfaccia S3, è necessario creare un utente S3 eseguendo:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
    <para>
     Esempio:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
    <para>
     Con questo comando si creano anche la chiave di accesso e la chiave segreta dell&apos;utente. Verificare l&apos;output per le parole chiave <literal>access_key</literal> e <literal>secret_key</literal> e i rispettivi valori:
    </para>
<screen>[...]
 "keys": [
       { "user": "example_user",
         "access_key": "11BS02LGFB6AL6H1ADMW",
         "secret_key": "vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY"}],
 [...]</screen>
   </sect3>
   <sect3 xml:id="removing-s3-swift-users">
    <title>Rimozione di utenti S3 e Swift</title>
    <para>
     La procedura di eliminazione degli utenti S3 e Swift è simile. Nel caso degli utenti Swift però potrebbe essere necessario eliminare l&apos;utente e i rispettivi sottoutenti.
    </para>
    <para>
     Per rimuovere un utente S3 o Swift (inclusi tutti i rispettivi sottoutenti), specificare <option>user rm</option> e l&apos;ID utente nel seguente comando:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user rm --uid=example_user</screen>
    <para>
     Per rimuovere un sottoutente, specificare <option>subuser rm</option> e l&apos;ID sottoutente.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser rm --uid=example_user:swift</screen>
    <para>
     È possibile utilizzare una delle seguenti opzioni:
    </para>
    <variablelist>
     <varlistentry>
      <term>--purge-data</term>
      <listitem>
       <para>
        Elimina definitivamente tutti i dati associato all&apos;ID utente.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>--purge-keys</term>
      <listitem>
       <para>
        Elimina definitivamente tutte le chiavi associate all&apos;ID utente.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <tip>
     <title>rimozione di un sottoutente</title>
     <para>
      Quando si rimuove un sottoutente, si rimuove l&apos;accesso all&apos;interfaccia Swift. L&apos;utente rimarrà nel sistema.
     </para>
    </tip>
   </sect3>
   <sect3 xml:id="changing-s3-swift-users-password">
    <title>Modifica delle chiavi di accesso e segrete degli utenti S3 e Swift</title>
    <para>
     I parametri di <literal>access_key</literal> e <literal>secret_key</literal> identificano l&apos;utente Object Gateway nel momento in cui accede al gateway. Modificare chiavi utente esistenti è come crearne di nuove, in quanto le chiavi precedenti vengono sovrascritte.
    </para>
    <para>
     Per gli utenti S3, eseguire quanto riportato di seguito:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create --uid=<replaceable>EXAMPLE_USER</replaceable> --key-type=s3 --gen-access-key --gen-secret</screen>
    <para>
     Per gli utenti Swift, eseguire quanto riportato di seguito:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create --subuser=<replaceable>EXAMPLE_USER</replaceable>:swift --key-type=swift --gen-secret</screen>
    <variablelist>
     <varlistentry>
      <term><option>--key-type=<replaceable>TYPE</replaceable></option></term>
      <listitem>
       <para>
        Specifica il tipo di chiave. <literal>swift</literal> o <literal>s3</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-access-key</option></term>
      <listitem>
       <para>
        Genera una chiave di accesso casuale (di default per l&apos;utente S3).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-secret</option></term>
      <listitem>
       <para>
        Genera una chiave segreta casuale.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--secret=<replaceable>KEY</replaceable></option></term>
      <listitem>
       <para>
        Specifica una chiave segreta, ad esempio una chiave generata manualmente.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="user-quota-managment">
    <title>Abilitazione della gestione delle quote utente</title>
    <para>
     Ceph Object Gateway consente di impostare le quote su utenti e compartimenti di proprietà degli utenti. Le quote includono il numero massimo di oggetti in un compartimento e le dimensioni massime di memorizzazione espresse in megabyte.
    </para>
    <para>
     Prima di abilitare una quota utente, è necessario impostarne i parametri:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota set --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable> \
 --max-objects=1024 --max-size=1024</screen>
    <variablelist>
     <varlistentry>
      <term><option>--max-objects</option></term>
      <listitem>
       <para>
        Specifica il numero massimo di oggetti. Con un numero negativo la verifica viene disabilitata.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--max-size</option></term>
      <listitem>
       <para>
        Specifica il numero massimo di byte. Con un numero negativo la verifica viene disabilitata.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--quota-scope</option></term>
      <listitem>
       <para>
        Specifica l&apos;ambito della quota. Le opzioni sono <literal>bucket</literal> e <literal>user</literal>. Le quote dei compartimenti si riferiscono ai compartimenti di proprietà di un utente. Le quote utente si riferiscono a un utente.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Una volta impostata una quota utente, è possibile abilitarla:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota enable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Per disabilitare una quota:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota disable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Per elencare le impostazioni della quota:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Per aggiornare le statistiche della quota:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user stats --uid=<replaceable>EXAMPLE_USER</replaceable> --sync-stats</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-http-frontends">
  <title>Front-end HTTP</title>

  <para>
   Ceph Object Gateway supporta due front-end HTTP integrati: <emphasis>oggetto beast</emphasis> e <emphasis>Civetweb</emphasis>.
  </para>

  <para>
   Il front-end dell&apos;oggetto beast utilizza la libreria Boost.Beast per l&apos;analisi HTTP e la libreria Boost.Asio per l&apos;I/O di rete asincrono.
  </para>

  <para>
   Il front-end Civetweb utilizza la libreria HTTP Civetweb, che è un fork di Mongoose.
  </para>

  <para>
   È possibile configurarli con l&apos;opzione <option>rgw_frontends</option>. Fare riferimento alla <xref linkend="config-ogw"/> per un elenco delle opzioni di configurazione.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-https">
  <title>Abilitazione di HTTPS/SSL per gli Object Gateway</title>

  <para>
   Per abilitare la comunicazione sicura di Object Gateway tramite SSL, occorre disporre di un certificato emesso da un&apos;autorità di certificazione o crearne uno autofirmato.
  </para>

  <sect2 xml:id="ogw-selfcert">
   <title>Creazione di un certificato autofirmato</title>
   <tip>
    <para>
     Ignorare questa sezione se si dispone già di un certificato valido firmato dalla CA.
    </para>
   </tip>
   <para>
    Nella procedura seguente è illustrato come generare un certificato SSL autofirmato sul Salt Master.
   </para>
   <procedure>
    <step>
     <para>
      Se è necessario che Object Gateway sia noto ad altre identità di oggetto, aggiungerle all&apos;opzione <option>subjectAltName</option> nella sezione <literal>[v3_req]</literal> del file <filename>/etc/ssl/openssl.cnf</filename>:
     </para>
<screen>
[...]
[ v3_req ]
subjectAltName = DNS:server1.example.com DNS:server2.example.com
[...]
</screen>
     <tip>
      <title>indirizzi IP in <option>subjectAltName</option></title>
      <para>
       Per utilizzare gli indirizzi IP al posto dei nomi di dominio nell&apos;opzione <option>subjectAltName</option>, sostituire la riga di esempio con quanto segue:
      </para>
<screen>
subjectAltName = IP:10.0.0.10 IP:10.0.0.11
</screen>
     </tip>
    </step>
    <step>
     <para>
      Creare la chiave e il certificato utilizzando <command>openssl</command>. Immettere tutti i dati che è necessario includere nel certificato. Si consiglia di immettere FQDN come nome comune. Prima di firmare il certificato, verificare che &quot;X509v3 Subject Alternative Name:&quot; sia incluso nelle estensioni richieste e che sia impostato nel certificato che viene generato.
     </para>
<screen>
<prompt>root@master # </prompt>openssl req -x509 -nodes -days 1095 \
 -newkey rsa:4096 -keyout rgw.key
 -out rgw.pem
</screen>
    </step>
    <step>
     <para>
      Aggiungere la chiave al file di certificato:
     </para>
<screen>
<prompt>root@master # </prompt>cat rgw.key &gt;&gt; rgw.pem
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-sssl-config">
   <title>Configurazione di Object Gateway con SSL</title>
   <para>
    Per configurare Object Gateway sull&apos;uso dei certificati SSL, utilizzare l&apos;opzione <option>rgw_frontends</option>. Esempio:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set <replaceable>WHO</replaceable> rgw_frontends \
 beast ssl_port=443 ssl_certificate=config://<replaceable>CERT</replaceable> ssl_key=config://<replaceable>KEY</replaceable>
</screen>
   <para>
    Se le chiavi di configurazione <replaceable>CERT</replaceable> e <replaceable>KEY</replaceable> non vengono specificate, il servizio Object Gateway cercherà la chiave e il certificato SSL nelle chiavi di configurazione seguenti:
   </para>
<screen>
rgw/cert/<replaceable>RGW_REALM</replaceable>/<replaceable>RGW_ZONE</replaceable>.key
rgw/cert/<replaceable>RGW_REALM</replaceable>/<replaceable>RGW_ZONE</replaceable>.crt
</screen>
   <para>
    Se si desidera sostituire l&apos;ubicazione della chiave e del certificato SSL di default, importarli nel database di configurazione utilizzando il comando seguente:
   </para>
<screen>ceph config-key set <replaceable>CUSTOM_CONFIG_KEY</replaceable> -i <replaceable>PATH_TO_CERT_FILE</replaceable></screen>
   <para>
    Quindi, utilizzare le chiavi di configurazione personalizzate con la direttiva <literal>config://</literal>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-sync">
  <title>Moduli di sincronizzazione</title>

  <para>
   Object Gateway viene distribuito come servizio multisito ed è possibile eseguire la copia speculare dei dati e dei metadati tra le zone. I <emphasis>moduli di sincronizzazione</emphasis> sono costruiti in cima al framework multisito che consente l&apos;inoltro di dati e metadati a un livello esterno diverso. Un modulo di sincronizzazione consente di eseguire un set di azioni ogni volta che ha luogo una modifica dei dati (ad esempio, operazioni correlate ai metadati come la creazione di compartimenti o di utenti). Poiché le modifiche del multisito Object Gateway sono coerenti nei siti remoti, le modifiche vengono propagate in modo asincrono. Questo concetto comprende casi d&apos;uso come il backup della memorizzazione di oggetti in un cluster cloud esterno, una soluzione di backup personalizzata in cui vengono utilizzate unità nastro o l&apos;indicizzazione dei metadati in ElasticSearch.
  </para>

  <sect2 xml:id="ogw-sync-general-config">
   <title>Configurazione dei moduli di sincronizzazione</title>
   <para>
    Tutti i moduli di sincronizzazione vengono configurati in modo simile. È necessario creare una nuova zona (fare riferimento alla <xref linkend="ceph-rgw-fed"/> per ulteriori dettagli) e impostare la relativa opzione <option>--tier_type</option>, ad esempio <option>--tier-type=cloud</option>, per il modulo di sincronizzazione cloud:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --endpoints=http://endpoint1.example.com,http://endpoint2.example.com, [...] \
 --tier-type=cloud
</screen>
   <para>
    È possibile configurare un livello specifico tramite il comando seguente:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=<replaceable>KEY1</replaceable>=<replaceable>VALUE1</replaceable>,<replaceable>KEY2</replaceable>=<replaceable>VALUE2</replaceable>
</screen>
   <para>
    La variabile <replaceable>KEY</replaceable> della configurazione specifica la variabile di configurazione da aggiornare, mentre <replaceable>VALUE</replaceable> specifica il nuovo valore corrispondente. È possibile accedere ai valori nidificati utilizzando il punto. Esempio:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=connection.access_key=<replaceable>KEY</replaceable>,connection.secret=<replaceable>SECRET</replaceable>
</screen>
   <para>
    È possibile accedere agli elementi della matrice aggiungendo delle parentesi quadre &quot;[]&quot; all&apos;elemento a cui si fa riferimento. È possibile aggiungere un nuovo elemento della matrice utilizzando le parentesi quadre &quot;[]&quot;. Il valore di indice -1 fa riferimento all&apos;ultimo elemento della matrice. Non è possibile creare un nuovo elemento e farvi nuovamente riferimento nello stesso comando. Ad esempio, di seguito è riportato un comando per la creazione di un nuovo profilo per i compartimenti che iniziano con <replaceable>PREFIX</replaceable>:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[].source_bucket=<replaceable>PREFIX</replaceable>'*'
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[-1].connection_id=<replaceable>CONNECTION_ID</replaceable>,profiles[-1].acls_id=<replaceable>ACLS_ID</replaceable>
</screen>
   <tip>
    <title>aggiunta e rimozione delle voci di configurazione</title>
    <para>
     Tramite il parametro <option>--tier-config-add=<replaceable></replaceable>=<replaceable>VALUE</replaceable></option>, è possibile aggiungere una nuova voce di configurazione del livello.
    </para>
    <para>
     Per rimuovere una voce esistente, utilizzare <option>--tier-config-rm=<replaceable>KEY</replaceable></option>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-zones">
   <title>Sincronizzazione delle zone</title>
   <para>
    La configurazione di un modulo di sincronizzazione viene eseguita a livello locale in una zona. Il modulo di sincronizzazione determina se i dati vengono esportati dalla zona o se questa utilizza solo dati modificati in un&apos;altra zona. A partire da Luminous, i plug-in di sincronizzazione supportati sono <literal>ElasticSearch</literal>, <literal>rgw</literal>, il plug-in di sincronizzazione di default mediante il quale vengono sincronizzati i dati tra le zone, e <literal>log</literal>, un plug-in di sincronizzazione semplice che registra le operazioni dei metadati che hanno luogo nelle zone remote. Nelle sezioni seguenti è riportato l&apos;esempio di una zona in cui viene utilizzato il modulo di sincronizzazione <literal>ElasticSearch</literal>. Il processo è simile a quello utilizzato per la configurazione di qualsiasi altro plug-in di sincronizzazione.
   </para>
   <note>
    <title>plug-in di sincronizzazione di default</title>
    <para>
     <literal>rgw</literal> è il plug-in di sincronizzazione di default e non è necessario configurarlo esplicitamente.
    </para>
   </note>
   <sect3 xml:id="ceph-rgw-sync-zones-req">
    <title>Requisiti e presupposti</title>
    <para>
     Si supponga una semplice configurazione multisito, come descritta nella <xref linkend="ceph-rgw-fed"/>, costituita da 2 zone: <literal>us-east</literal> e <literal>us-west</literal>. Adesso si aggiunge una terza zona <literal>us-east-es</literal> nella quale vengono elaborati solo i metadati provenienti da altri siti. Questa zona può essere nello stesso cluster Ceph di <literal>us-east</literal> o in uno diverso. In questa zona vengono utilizzati solo i metadati provenienti da altre zone e gli Object Gateway in essa contenuti non serviranno direttamente alcuna richiesta dell&apos;utente finale.
    </para>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-zones-configure">
    <title>Configurazione delle zone</title>
    <procedure>
     <step>
      <para>
       Creare una terza zona simile a quelle descritte nella <xref linkend="ceph-rgw-fed"/>, ad esempio
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone create --rgw-zonegroup=us --rgw-zone=us-east-es \
--access-key=<replaceable>SYSTEM-KEY</replaceable> --secret=<replaceable>SECRET</replaceable> --endpoints=http://rgw-es:80
      </screen>
     </step>
     <step>
      <para>
       È possibile configurare un modulo di sincronizzazione per questa zona nel modo seguente:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=<replaceable>TIER-TYPE</replaceable> \
--tier-config={set of key=value pairs}
      </screen>
     </step>
     <step>
      <para>
       Ad esempio, nel modulo di sincronizzazione <literal>ElasticSearch</literal>
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=elasticsearch \
--tier-config=endpoint=http://localhost:9200,num_shards=10,num_replicas=1
      </screen>
      <para>
       Per le varie opzioni tier-config supportate, fare riferimento a <xref linkend="ceph-rgw-sync-elastic"/>.
      </para>
     </step>
     <step>
      <para>
       Infine, aggiornare il periodo
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> period update --commit
      </screen>
     </step>
     <step>
      <para>
       Adesso, avviare Object Gateway nella zona
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch start rgw.<replaceable>REALM-NAME</replaceable>.<replaceable>ZONE-NAME</replaceable>
      </screen>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-elastic">
   <title>Modulo di sincronizzazione ElasticSearch</title>
   <para>
    Questo modulo di sincronizzazione consente di scrivere in ElasticSearch i metadati provenienti da altre zone. A partire da Luminous, è il formato JSON dei campi dei dati che attualmente vengono memorizzati in ElasticSearch.
   </para>
<screen>
{
  "_index" : "rgw-gold-ee5863d6",
  "_type" : "object",
  "_id" : "34137443-8592-48d9-8ca7-160255d52ade.34137.1:object1:null",
  "_score" : 1.0,
  "_source" : {
    "bucket" : "testbucket123",
    "name" : "object1",
    "instance" : "null",
    "versioned_epoch" : 0,
    "owner" : {
      "id" : "user1",
      "display_name" : "user1"
    },
    "permissions" : [
      "user1"
    ],
    "meta" : {
      "size" : 712354,
      "mtime" : "2017-05-04T12:54:16.462Z",
      "etag" : "7ac66c0f148de9519b8bd264312c4d64"
    }
  }
}
   </screen>
   <sect3 xml:id="ceph-rgw-sync-elastic-config">
    <title>Parametri di configurazione di tipi di livelli ElasticSearch</title>
    <variablelist>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        Specifica l&apos;endpoint del server ElasticSearch cui accedere.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_shards</term>
      <listitem>
       <para>
        <emphasis>(numero intero)</emphasis> Numero di partizioni che verranno configurate da ElasticSearch con l&apos;inizializzazione della sincronizzazione sui dati. Dopo l&apos;inizializzazione non è possibile modificare tale numero. Per qualsiasi modifica sono richieste la ricompilazione dell&apos;indice di ElasticSearch e la reinizializzazione del processo di sincronizzazione dei dati.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_replicas</term>
      <listitem>
       <para>
        <emphasis>(numero intero)</emphasis> Numero di repliche che verranno configurate da ElasticSearch con l&apos;inizializzazione della sincronizzazione sui dati.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>explicit_custom_meta</term>
      <listitem>
       <para>
        <emphasis>(true | false)</emphasis> Specifica se tutti i metadati personalizzati dell&apos;utente verranno indicizzati o se l&apos;utente dovrà configurare (a livello di compartimento) quali voci dei metadati del cliente devono essere indicizzate. Per default, questa opzione è impostata su false.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>index_buckets_list</term>
      <listitem>
       <para>
        <emphasis>(elenco di stringhe separate da virgole)</emphasis> Se vuoti, tutti i compartimenti verranno indicizzati. Altrimenti, verranno indicizzati solo i compartimenti specificati qui. È possibile specificare i prefissi dei compartimenti (ad esempio &quot;foo*&quot;) o i suffissi (ad esempio &quot;*bar&quot;).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>approved_owners_list</term>
      <listitem>
       <para>
        <emphasis>(elenco di stringhe separate da virgole)</emphasis> Se vuoti, i compartimenti di tutti i proprietari verranno indicizzati (operazione soggetta ad altre restrizioni), altrimenti verranno indicizzati solo i compartimenti appartenenti ai proprietari specificati. È possibile specificare anche i suffissi e i prefissi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>override_index_path</term>
      <listitem>
       <para>
        <emphasis>(stringa)</emphasis> Se non è vuota, la stringa verrà utilizzata come percorso di indice di ElasticSearch. Altrimenti il percorso di indice verrà determinato e generato al momento dell&apos;inizializzazione della sincronizzazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>nomeutente</term>
      <listitem>
       <para>
        Specifica un nome utente per ElasticSearch se occorre effettuare l&apos;autenticazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>password</term>
      <listitem>
       <para>
        Specifica una password per ElasticSearch se occorre effettuare l&apos;autenticazione.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-elastic-query">
    <title>Interrogazioni dei metadati</title>
    <para>
     Poiché adesso nel cluster ElasticSearch vengono memorizzati metadati di oggetti, è importante che l&apos;endpoint di ElasticSearch non sia esposto al pubblico e che sia accessibile solo dagli amministratori del cluster. Ciò rappresenta un problema per l&apos;esposizione delle interrogazioni dei metadati all&apos;utente finale, dato che l&apos;utente dovrebbe interrogare solo i propri metadati e non quelli di altri utenti. Pertanto sarebbe opportuno che l&apos;autenticazione degli utenti da parte del cluster ElasticSearch venga eseguita in modo simile a RGW, il che rappresenta un problema.
    </para>
    <para>
     A partire da Luminous RGW, adesso nella zona master dei metadata master è possibile provvedere alle richieste degli utenti finali. In tal modo l&apos;endpoint di ElasticSearch non viene esposto al pubblico e si risolve anche il problema di autenticazione e autorizzazione in quanto RGW stesso è in grado di autenticare le richieste degli utenti finali. A tal fine, RGW introduce una nuova interrogazione nelle API del compartimento che sono in grado di provvedere alle richieste ElasticSearch. Tutte queste richieste devono essere inviate alla zona master dei metadati.
    </para>
    <variablelist>
     <varlistentry>
      <term>Ottenimento di un&apos;interrogazione ElasticSearch</term>
      <listitem>
<screen>
GET /<replaceable>BUCKET</replaceable>?query=<replaceable>QUERY-EXPR</replaceable>
       </screen>
       <para>
        parametri di richiesta:
       </para>
       <itemizedlist>
        <listitem>
         <para>
          max-keys: numero massimo di voci da restituire
         </para>
        </listitem>
        <listitem>
         <para>
          marker: marker di impaginazione
         </para>
        </listitem>
       </itemizedlist>
<screen>
expression := [(]&lt;arg&gt; &lt;op&gt; &lt;value&gt; [)][&lt;and|or&gt; ...]
       </screen>
       <para>
        op è uno dei seguenti: &lt;, &lt;=, ==, &gt;=, &gt;
       </para>
       <para>
        Esempio:
       </para>
<screen>
GET /?query=name==foo
       </screen>
       <para>
        Verranno restituite tutte le chiavi indicizzate per le quali l&apos;utente dispone l&apos;autorizzazione in lettura e vengono denominate &quot;foo&quot;. L&apos;output sarà un elenco di chiavi in XML simile alla risposta dei compartimenti dell&apos;elenco S3.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Configurazione dei campi dei metadati personalizzati</term>
      <listitem>
       <para>
        Definire quali voci dei metadati personalizzati devono essere indicizzate (nel compartimento specificato) e quali sono i tipi di queste chiavi. Se si configura l&apos;indicizzazione esplicita dei metadati personalizzati, tale operazione è necessaria affinché rgw indicizzi i valori dei metadati personalizzati specificati. Altrimenti è necessaria nei casi in cui le chiavi dei metadati indicizzati siano di tipo diverso dalla stringa.
       </para>
<screen>
POST /<replaceable>BUCKET</replaceable>?mdsearch
x-amz-meta-search: &lt;key [; type]&gt; [, ...]
       </screen>
       <para>
        I campi di metadati multipli devono essere separati da virgole, è possibile forzare un tipo per un campo con un punto e virgola &quot;;&quot;. I tipi attualmente consentiti sono stringa (default), numero intero e data. Ad esempio, se si desidera indicizzare i metadati di oggetto personalizzati x-amz-meta-year come int, x-amz-meta-date come tipo di data e x-amz-meta-title come stringa, procedere come indicato di seguito
       </para>
<screen>
POST /mybooks?mdsearch
x-amz-meta-search: x-amz-meta-year;int, x-amz-meta-release-date;date, x-amz-meta-title;string
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Eliminazione della configurazione dei metadati personalizzati</term>
      <listitem>
       <para>
        Eliminare la configurazione del compartimento dei metadati personalizzati.
       </para>
<screen>
DELETE /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Ottenimento della configurazione dei metadati personalizzati</term>
      <listitem>
       <para>
        Recuperare la configurazione del compartimento dei metadati personalizzati.
       </para>
<screen>
GET /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-cloud-sync">
   <title>Modulo di sincronizzazione cloud</title>
   <para>
    Questa sezione descrive un modulo che effettua la sincronizzazione dei dati della zona con un servizio cloud remoto. La sincronizzazione è esclusivamente unidirezionale (ovvero la data non viene risincronizzata dalla zona remota). L&apos;obiettivo principale di questo modulo è quello di abilitare la sincronizzazione dei dati con più provider di servizi cloud. Al momento, questo modulo supporta i provider cloud compatibili con AWS (S3).
   </para>
   <para>
    Per sincronizzare i dati con un servizio cloud remoto, occorre configurare le credenziali utente. Poiché molti servizi cloud introducono dei limiti sul numero di compartimenti che ciascun utente può creare, è possibile configurare la mappatura dei compartimenti e degli oggetti di origine, delle diverse destinazioni su compartimenti diversi e dei prefissi dei compartimenti. Tenere presente che gli elenchi di accesso all&apos;origine (ACL) non verranno conservati. È possibile mappare le autorizzazioni degli utenti di origine specifici a determinati utenti di destinazione.
   </para>
   <para>
    A causa delle limitazioni dell&apos;API, non è possibile conservare l&apos;ora di modifica dell&apos;oggetto originale e il tag dell&apos;entità HTTP (ETag). Il modulo di sincronizzazione cloud memorizza queste informazioni come attributi di metadati sugli oggetti di destinazione.
   </para>
   <sect3 xml:id="cloud-sync-module">
    <title>Configurazione del modulo di sincronizzazione cloud</title>
    <para>
     Di seguito sono riportati degli esempi di configurazione semplice e complessa del modulo di sincronizzazione cloud. Tenere presente che la configurazione semplice può entrare in conflitto con quella complessa.
    </para>
    <example>
     <title>Configurazione semplice</title>
<screen>
{
  "connection": {
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,
  },
  "acls": [ { "type": <replaceable>id | email | uri</replaceable>,
    "source_id": <replaceable>SOURCE_ID</replaceable>,
    "dest_id": <replaceable>DEST_ID</replaceable> } ... ],
  "target_path": <replaceable>TARGET_PATH</replaceable>,
}
</screen>
    </example>
    <example>
     <title>Configurazione complessa</title>
<screen>
{
  "default": {
    "connection": {
      "access_key": <replaceable>ACCESS</replaceable>,
      "secret": <replaceable>SECRET</replaceable>,
      "endpoint": <replaceable>ENDPOINT</replaceable>,
      "host_style" <replaceable>path | virtual</replaceable>,
    },
    "acls": [
    {
      "type": <replaceable>id | email | uri</replaceable>,   #  optional, default is id
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
    "target_path": <replaceable>PATH</replaceable> # optional
  },
  "connections": [
  {
    "connection_id": <replaceable>ID</replaceable>,
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,  # optional
  } ... ],
  "acl_profiles": [
  {
    "acls_id": <replaceable>ID</replaceable>, # acl mappings
    "acls": [ {
      "type": <replaceable>id | email | uri</replaceable>,
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
  }
  ],
  "profiles": [
  {
   "source_bucket": <replaceable>SOURCE</replaceable>,
   "connection_id": <replaceable>CONNECTION_ID</replaceable>,
   "acls_id": <replaceable>MAPPINGS_ID</replaceable>,
   "target_path": <replaceable>DEST</replaceable>,          # optional
  } ... ],
}
</screen>
    </example>
    <para>
     Di seguito è riportata la spiegazione dei termini di configurazione utilizzati:
    </para>
    <variablelist>
     <varlistentry>
      <term>connessione</term>
      <listitem>
       <para>
        Rappresenta la connessione al servizio cloud remoto. Contiene &quot;connection_id&quot;, &quot;access_key&quot;, &quot;secret&quot;, &quot;endpoint&quot;, e &quot;host_style&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>access_key</term>
      <listitem>
       <para>
        La chiave di accesso al cloud remoto che verrà utilizzata per la connessione specifica.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>secret</term>
      <listitem>
       <para>
        La chiave segreta del servizio cloud remoto.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        URL dell&apos;endpoint del servizio cloud remoto.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>host_style</term>
      <listitem>
       <para>
        Tipo di stile host (&quot;path&quot; o &quot;virtual&quot;) da utilizzare per l&apos;accesso all&apos;endpoint cloud remoto. L&apos;impostazione di default è &quot;path&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acls</term>
      <listitem>
       <para>
        Matrice delle mappature dell&apos;elenco accessi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_mapping</term>
      <listitem>
       <para>
        Ciascuna struttura &quot;acl_mapping&quot; contiene &quot;type&quot;, &quot;source_id&quot; e &quot;dest_id&quot;. Questi valori definiscono la mutazione dell&apos;ACL di ciascun oggetto. Le mutazioni dell&apos;ACL consentono di convertire l&apos;ID utente di origine in un ID di destinazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>tipo</term>
      <listitem>
       <para>
        Tipo di ACL: &quot;id&quot; definisce l&apos;ID utente, &quot;email&quot; definisce l&apos;utente tramite l&apos;indirizzo e-mail e &quot;uri&quot; definisce l&apos;utente in base all&apos;uri (gruppo).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>source_id</term>
      <listitem>
       <para>
        ID dell&apos;utente nella zona di origine.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>dest_id</term>
      <listitem>
       <para>
        ID dell&apos;utente nella destinazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>target_path</term>
      <listitem>
       <para>
        Una stringa che definisce la modalità di creazione del percorso di destinazione. Il percorso di destinazione specifica un prefisso al quale viene aggiunto il nome dell&apos;oggetto di origine. Il percorso di destinazione configurabile può includere una delle seguenti variabili:
       </para>
       <variablelist>
        <varlistentry>
         <term>SID</term>
         <listitem>
          <para>
           Una stringa univoca che rappresenta l&apos;ID dell&apos;istanza di sincronizzazione.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP</term>
         <listitem>
          <para>
           Nome del gruppo di zone.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP_ID</term>
         <listitem>
          <para>
           ID del gruppo di zone.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE</term>
         <listitem>
          <para>
           Nome della zona.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE_ID</term>
         <listitem>
          <para>
           ID della zona.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>BUCKET</term>
         <listitem>
          <para>
           Nome del compartimento di origine.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>OWNER</term>
         <listitem>
          <para>
           ID del proprietario del compartimento di origine.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        Ad esempio: target_path = rgwx-<replaceable>ZONE</replaceable>-<replaceable>SID</replaceable>/<replaceable>OWNER</replaceable>/<replaceable>BUCKET</replaceable>
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profiles</term>
      <listitem>
       <para>
        Una matrice dei profili dell&apos;elenco accessi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profile</term>
      <listitem>
       <para>
        Ogni profilo contiene &quot;acls_id&quot;, che rappresenta il profilo, e una matrice &quot;acls&quot; che contiene un elenco delle &quot;acl_mappings&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>profili</term>
      <listitem>
       <para>
        Un elenco dei profili. Ogni profilo contiene quanto segue:
       </para>
       <variablelist>
        <varlistentry>
         <term>source_bucket</term>
         <listitem>
          <para>
           Il nome o il prefisso di un compartimento (se termina con *) che definisce i compartimenti di origine per il profilo.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>target_path</term>
         <listitem>
          <para>
           Vedere sopra per la spiegazione.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>connection_id</term>
         <listitem>
          <para>
           ID della connessione che verrà utilizzato per questo profilo.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>acls_id</term>
         <listitem>
          <para>
           ID del profilo dell&apos;ACL che verrà utilizzato per questo profilo.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="s3-specific-configurables">
    <title>Elementi configurabili specifici di S3</title>
    <para>
     Il modulo di sincronizzazione cloud funziona soltanto con i back-end compatibili con AWS S3. È possibile utilizzare alcuni elementi configurabili per ottimizzarne il comportamento durante l&apos;accesso ai servizi cloud S3:
    </para>
<screen>
{
  "multipart_sync_threshold": <replaceable>OBJECT_SIZE</replaceable>,
  "multipart_min_part_size": <replaceable>PART_SIZE</replaceable>
}
</screen>
    <variablelist>
     <varlistentry>
      <term>multipart_sync_threshold</term>
      <listitem>
       <para>
        Gli oggetti di dimensioni uguali o superiori a questo valore verranno sincronizzati con il servizio cloud tramite l&apos;upload multipart.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>multipart_min_part_size</term>
      <listitem>
       <para>
        Dimensioni minime delle parti da utilizzare durante la sincronizzazione degli oggetti con l&apos;upload multipart.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="archive-sync-module">
   <title>Modulo di sincronizzazione degli archivi</title>
   <para>
    Il <emphasis>modulo di sincronizzazione degli archivi</emphasis> utilizza la funzione del controllo versioni degli oggetti S3 in Object Gateway. È possibile configurare una <emphasis>zona di archiviazione</emphasis> per acquisire le diverse versioni degli oggetti S3 che hanno luogo nel corso del tempo nelle altre zone. Tramite i gateway associati alla zona di archiviazione, è possibile eliminare la cronologia delle versioni conservata nella zona stessa.
   </para>
   <para>
    Grazie a questa architettura, diverse zone senza versione possono eseguire la copia speculare dei relativi dati e metadati tramite i propri gateway di zona fornendo elevata disponibilità agli utenti finali, mentre la zona di archiviazione acquisisce tutti gli aggiornamenti dei dati per consolidarli come versioni degli oggetti S3.
   </para>
   <para>
    Includendo la zona di archiviazione in una configurazione multizona, è possibile ottenere in una zona la flessibilità della cronologia degli oggetti S3 risparmiando al contempo spazio che verrà utilizzato nelle zone rimanenti dalle repliche degli oggetti S3 con versione.
   </para>
   <sect3 xml:id="archive-sync-module-configuration">
    <title>Configurazione del modulo di sincronizzazione degli archivi</title>
    <tip>
     <title>maggiori informazioni</title>
     <para>
      Fare riferimento alla <xref linkend="ceph-rgw-fed"/> per i dettagli sulla configurazione dei gateway multisito.
     </para>
     <para>
      Fare riferimento alla <xref linkend="ceph-rgw-sync"/> per i dettagli sulla configurazione dei moduli di sincronizzazione.
     </para>
    </tip>
    <para>
     Per utilizzare il modulo di sincronizzazione degli archivi, occorre creare una nuova zona con tipo di livello impostato su <literal>archive</literal>:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE_GROUP_NAME</replaceable> \
 --rgw-zone=<replaceable>OGW_ZONE_NAME</replaceable> \
 --endpoints=<replaceable>http://OGW_ENDPOINT1_URL[,http://OGW_ENDPOINT2_URL,...]</replaceable>
 --tier-type=archive
</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-ldap">
  <title>Autenticazione LDAP</title>

  <para>
   Oltre all&apos;autenticazione utente locale di default, con Object Gateway si possono utilizzare i servizi del server LDAP per autenticare anche gli utenti.
  </para>

  <sect2 xml:id="ceph-rgw-ldap-how-works">
   <title>Meccanismo di autenticazione</title>
   <para>
    Object Gateway estrae le credenziali LDAP dell&apos;utente da un token. Dal nome utente viene costruito un filtro di ricerca. In Object Gateway si utilizza il servizio configurato per ricercare la directory di una voce corrispondente. Se si trova la voce, Object Gateway tenta di associare il nome distinto con la password ottenuta dal token. Se le credenziali sono valide, l&apos;associazione avrà esito positivo e verrà concesso l&apos;accesso a Object Gateway.
   </para>
   <para>
    È possibile limitare gli utenti consentiti impostando la base per la ricerca a un&apos;unità organizzativa specifica o definendo un filtro di ricerca personalizzato, ad esempio richiedendo l&apos;appartenenza di un gruppo specifico, classi di oggetti personalizzati o attributi.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-reqs">
   <title>Requisiti</title>
   <itemizedlist>
    <listitem>
     <para>
      <emphasis>LDAP o Active Directory</emphasis>: un&apos;istanza LDAP in esecuzione accessibile da Object Gateway.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Account di servizio</emphasis>: credenziali LDAP che devono essere utilizzate da Object Gateway con autorizzazioni di ricerca.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Account utente</emphasis>: almeno un account utente nella directory LDAP.
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>non sovrapporre utenti LDAP e utenti locali</title>
    <para>
     Non utilizzare gli stessi nomi utente per gli utenti locali e per gli utenti che vengono autenticati mediante l&apos;uso di LDAP. Object Gateway non è in grado di distinguerli e li considera come lo stesso utente.
    </para>
   </important>
   <tip>
    <title>test di integrità</title>
    <para>
     Utilizzare l&apos;utility <command>ldapsearch</command> per verificare l&apos;account di servizio o la connessione LDAP. Esempio:
    </para>
<screen><prompt>&gt; </prompt>ldapsearch -x -D "uid=ceph,ou=system,dc=example,dc=com" -W \
-H ldaps://example.com -b "ou=users,dc=example,dc=com" 'uid=*' dn</screen>
    <para>
     Assicurarsi di utilizzare gli stessi parametri LDAP del file di configurazione Ceph per eliminare eventuali problemi.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-config">
   <title>Configurazione di Object Gateway per utilizzare l&apos;autenticazione LDAP</title>
   <para>
    I seguenti parametri sono correlati all&apos;autenticazione LDAP:
   </para>
   <variablelist>
    <varlistentry>
     <term><option>rgw_s3_auth_use_ldap</option></term>
     <listitem>
      <para>
       Impostare questa opzione su <literal>true</literal> per abilitare l&apos;autenticazione S3 con LDAP.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_uri</option></term>
     <listitem>
      <para>
       Specifica il server LDAP da utilizzare. Assicurarsi di utilizzare il parametro <literal>ldaps://<replaceable>FQDN</replaceable>:<replaceable>PORT</replaceable></literal> per evitare di trasmettere apertamente le credenziali come testo normale.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_binddn</option></term>
     <listitem>
      <para>
       Nome distinto (DN) dell&apos;account di servizio utilizzato da Object Gateway.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_secret</option></term>
     <listitem>
      <para>
       Password per l&apos;account di servizio.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>rgw_ldap_searchdn</term>
     <listitem>
      <para>
       Specifica la base DIT (Directory Information Tree) per la ricerca degli utenti. Questa può essere l&apos;unità organizzativa degli utenti o una più specifica.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_dnattr</option></term>
     <listitem>
      <para>
       Attributo che viene utilizzato nel filtro di ricerca costruito per la corrispondenza con un nome utente. A seconda del DIT, è probabile che tale attributo sia <literal>uid</literal> o <literal>cn</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_search_filter</option></term>
     <listitem>
      <para>
       Se non è specificato, in Object Gateway il filtro di ricerca viene costruito automaticamente con l&apos;impostazione <option>rgw_ldap_dnattr</option>. Utilizzare questo parametro per restringere l&apos;elenco degli utenti consentiti con la massima flessibilità. Consultare <xref linkend="ceph-rgw-ldap-filter"/> per ulteriori informazioni.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-filter">
   <title>Utilizzo di un filtro di ricerca personalizzato per limitare l&apos;accesso degli utenti</title>
   <para>
    È possibile utilizzare il parametro <option>rgw_search_filter</option> in due modi diversi.
   </para>
   <sect3 xml:id="partial-filter-search-filter">
    <title>Filtro parziale per limitare ulteriormente il filtro di ricerca costruito</title>
    <para>
     Di seguito è riportato un esempio di filtro parziale:
    </para>
<screen>"objectclass=inetorgperson"</screen>
    <para>
     In Object Gateway il filtro di ricerca verrà generato come di consueto, con il nome dell&apos;utente ottenuto dal token del valore di <option>rgw_ldap_dnattr</option>. Il filtro costruito viene quindi combinato con il filtro parziale dell&apos;attributo <option>rgw_search_filter</option>. A seconda del nome utente e delle impostazioni, il filtro di ricerca finale può diventare:
    </para>
<screen>"(&amp;(uid=hari)(objectclass=inetorgperson))"</screen>
    <para>
     In tal caso, all&apos;utente &apos;hari&apos; verrà concesso l&apos;accesso solo se è presente nella directory LDAP, dispone di una classe oggetto &apos;inetorgperson&apos; e ha specificato una password valida.
    </para>
   </sect3>
   <sect3 xml:id="complete-filter">
    <title>Filtro completo</title>
    <para>
     Un filtro completo deve contenere un token <option>USERNAME</option> che verrà sostituito con il nome dell&apos;utente durante il tentativo di autenticazione. In tal caso, il parametro <option>rgw_ldap_dnattr</option> non viene più utilizzato. Ad esempio, per limitare gli utenti validi a un gruppo specifico, utilizzare il filtro seguente:
    </para>
<screen>"(&amp;(uid=USERNAME)(memberOf=cn=ceph-users,ou=groups,dc=mycompany,dc=com))"</screen>
    <note>
     <title>attributo <literal>memberOf</literal></title>
     <para>
      Per utilizzare l&apos;attributo <literal>memberOf</literal> nelle richieste LDAP è richiesto il supporto lato server dall&apos;implementazione del server LDAP specificata.
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-token">
   <title>Generazione di un token di accesso per l&apos;autenticazione LDAP</title>
   <para>
    Il token di accesso viene generato dall&apos;utility <command>radosgw-token</command> in base al nome utente e alla password LDAP. L&apos;output è una stringa codificata base-64 che corrisponde al token di accesso effettivo. Utilizzare il client S3 preferito (fare riferimento a <xref linkend="accessing-ragos-gateway"/>), specificare il token come chiave di accesso e utilizzare una chiave segreta vuota.
   </para>
<screen><prompt>&gt; </prompt>export RGW_ACCESS_KEY_ID="<replaceable>USERNAME</replaceable>"
<prompt>&gt; </prompt>export RGW_SECRET_ACCESS_KEY="<replaceable>PASSWORD</replaceable>"
<prompt>cephuser@adm &gt; </prompt>radosgw-token --encode --ttype=ldap</screen>
   <important>
    <title>credenziali non cifrate</title>
    <para>
     Il token di accesso è una struttura JSON codificata base-64 e contiene le credenziali LDAP non cifrate.
    </para>
   </important>
   <note>
    <title>Active Directory</title>
    <para>
     Per Active Directory, utilizzare il parametro <option>--ttype=ad</option>.
    </para>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-bucket-sharding">
  <title>Partizionamento dell&apos;indice del compartimento</title>

  <para>
   In Object Gateway i dati di indice del compartimento vengono memorizzati in un pool di indice, che per default è impostato su <literal>.rgw.buckets.index</literal>. Se si inseriscono troppi (centinaia di migliaia) oggetti in un singolo compartimento e la quota massima per il numero di oggetti per compartimento (<option>rgw bucket default quota max objects</option>) non è impostata, le prestazioni del pool di indice potrebbero essere compromesse. Il <emphasis>partizionamento dell&apos;indice del compartimento</emphasis> impedisce tali riduzioni delle prestazioni e consente un numero maggiore di oggetti per compartimento.
  </para>

  <sect2 xml:id="ogw-bucket-reshard">
   <title>Ripartizionamento dell&apos;indice del compartimento</title>
   <para>
    Se un compartimento è diventato più grande e la rispettiva configurazione iniziale non è più sufficiente, è necessario ripartizionare il pool di indice del compartimento. È possibile utilizzare il ripartizionamento automatico dell&apos;indice del compartimento online (fare riferimento alla <xref linkend="ogw-bucket-sharding-dyn"/>) o eseguire manualmente il ripartizionamento dell&apos;indice del compartimento offline (fare riferimento alla <xref linkend="ogw-bucket-sharding-re"/>).
   </para>
   <sect3 xml:id="ogw-bucket-sharding-dyn">
    <title>Ripartizionamento dinamico</title>
    <para>
     A partire da SUSE Enterprise Storage 5, è supportato il ripartizionamento del compartimento online. Viene rilevato se il numero di oggetti per compartimento raggiunge una determinata soglia e viene aumentato automaticamente il numero di partizioni utilizzate dall&apos;indice del compartimento. Questo processo consente di ridurre il numero di voci in ciascuna partizione dell&apos;indice del compartimento.
    </para>
    <para>
     Il processo di rilevamento viene eseguito:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Quando vengono aggiunti nuovi oggetti al compartimento.
      </para>
     </listitem>
     <listitem>
      <para>
       In un processo in background che esegue periodicamente la scansione di tutti i compartimenti. Questo è necessario per gestire i compartimenti esistenti che non vengono aggiornati.
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Un compartimento per il quale è richiesto il ripartizionamento viene aggiunto alla coda <option>reshard_log</option> e verrà pianificato per un ripartizionamento successivo. I thread della ripartizione vengono eseguiti in background ed eseguono un ripartizionamento pianificato alla volta.
    </para>
    <variablelist>
     <title>Configurazione del ripartizionamento dinamico</title>
     <varlistentry>
      <term><option>rgw_dynamic_resharding</option></term>
      <listitem>
       <para>
        Abilita o disabilita il ripartizionamento dinamico dell&apos;indice del compartimento. I valori possibili sono &quot;true&quot; o &quot;false&quot;. Il valore di default è &quot;true&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_num_logs</option></term>
      <listitem>
       <para>
        Numero di partizioni per il log di ripartizionamento. Il valore di default è 16.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_bucket_lock_duration</option></term>
      <listitem>
       <para>
        Durata del bloccaggio nell&apos;oggetto Compartimento durante il ripartizionamento. Il valore di default è 120 secondi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_max_objs_per_shard</option></term>
      <listitem>
       <para>
        Numero massimo di oggetti per partizione dell&apos;indice del compartimento. Il valore di default è 10.0000 oggetti.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_thread_interval</option></term>
      <listitem>
       <para>
        Durata massima tra i cicli di elaborazione dei thread delle ripartizioni. Il valore di default è 600 secondi.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <variablelist>
     <title>Comandi per amministrare il processo di ripartizionamento</title>
     <varlistentry>
      <term>Aggiungere un compartimento alla coda di ripartizionamento:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard add \
 --bucket <replaceable>BUCKET_NAME</replaceable> \
 --num-shards <replaceable>NEW_NUMBER_OF_SHARDS</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Elencare la coda di ripartizionamento:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard list
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Elaborare/pianificare un ripartizionamento del compartimento:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard process
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Visualizzare lo stato di ripartizionamento del compartimento:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard status --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Annullare il ripartizionamento del compartimento in sospeso:</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard cancel --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ogw-bucket-sharding-re">
    <title>Ripartizionamento manuale</title>
    <para>
     Il ripartizionamento dinamico di cui alla <xref linkend="ogw-bucket-sharding-dyn"/> è supportato solo per le configurazioni Object Gateway semplici. Per le configurazioni multisito, utilizzare il ripartizionamento manuale descritto nella presente sezione.
    </para>
    <para>
     Per eseguire il ripartizionamento manuale dell&apos;indice del compartimento offline, utilizzare il comando seguente:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket reshard
</screen>
    <para>
     Il comando <command>bucket reshard</command> consente di effettuare le seguenti operazioni:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Creare un nuovo set di oggetti Indice compartimento per l&apos;oggetto specificato.
      </para>
     </listitem>
     <listitem>
      <para>
       Distribuire tutte le voci di questi oggetti di indice.
      </para>
     </listitem>
     <listitem>
      <para>
       Creare una nuova istanza del compartimento.
      </para>
     </listitem>
     <listitem>
      <para>
       Collegare la nuova istanza del compartimento al compartimento in modo che tutte le nuove operazioni di indice passino attraverso i nuovi indici del compartimento.
      </para>
     </listitem>
     <listitem>
      <para>
       Stampare il vecchio e il nuovo ID compartimento nell&apos;output standard.
      </para>
     </listitem>
    </itemizedlist>
    <tip>
     <para>
      Quando si sceglie il numero di partizionamenti, non superare le 100.000 voci per partizionamento. I partizionamenti dell&apos;indice del compartimento corrispondenti a numeri primi tendono a funzionare meglio in voci dell&apos;indice del compartimento distribuite uniformemente nei partizionamenti. Ad esempio, invece di impostare 500 partizionamenti dell&apos;indice del compartimento, è consigliabile impostarne 503, dal momento che questo è un numero primo.
     </para>
    </tip>
    <procedure>
     <title>Ripartizionamento dell&apos;indice del compartimento</title>
     <step>
      <para>
       Assicurarsi che tutte le operazioni nel compartimento vengano interrotte
      </para>
     </step>
     <step>
      <para>
       Eseguire il backup dell&apos;indice del compartimento originale:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bi list \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 &gt; <replaceable>BUCKET_NAME</replaceable>.list.backup
</screen>
     </step>
     <step>
      <para>
       Eseguire il ripartizionamento dell&apos;indice del compartimento:
      </para>
<screen>
 <prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket reshard \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 --num-shards=<replaceable>NEW_SHARDS_NUMBER</replaceable>
</screen>
      <tip>
       <title>ID compartimento precedente</title>
       <para>
        Come parte del rispettivo output, questo comando consente inoltre di stampare l&apos;ID compartimento nuovo e quello precedente.
       </para>
      </tip>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-bucket-sharding-new">
   <title>Partizionamento dell&apos;indice del compartimento per nuovi compartimenti</title>
   <para>
    Sono disponibili due opzioni che influenzano il partizionamento dell&apos;indice del compartimento:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Utilizzare l&apos;opzione <option>rgw_override_bucket_index_max_shards</option> per le configurazioni semplici.
     </para>
    </listitem>
    <listitem>
     <para>
      Utilizzare l&apos;opzione <option>bucket_index_max_shards</option> per le configurazioni multisito.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Con l&apos;impostazione delle opzioni su <literal>0</literal> si disabilita il partizionamento dell&apos;indice del compartimento. Con un valore maggiore di <literal>0</literal> si abilita il partizionamento dell&apos;indice del compartimento e si imposta il numero massimo di partizioni.
   </para>
   <para>
    La formula seguente consente di calcolare il numero di partizioni consigliato:
   </para>
<screen>
number_of_objects_expected_in_a_bucket / 100000
</screen>
   <para>
    Si tenga presente che il numero massimo di partizioni è 7877.
   </para>
   <sect3 xml:id="multisite-config-bucket">
    <title>Configurazioni multisito</title>
    <para>
     Le configurazioni multisito possono avere un pool di indice diverso per la gestione dei failover. Per configurare un numero di partizioni coerente per le zone in un gruppo di zone, impostare l&apos;opzione <option>bucket_index_max_shards</option> nella configurazione del gruppo di zone:
    </para>
    <procedure>
     <step>
      <para>
       Esportare la configurazione del gruppo di zone nel file <filename>zonegroup.json</filename>:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup get &gt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Modificare il file <filename>zonegroup.json</filename> e impostare l&apos;opzione <option>bucket_index_max_shards</option> per ciascuna zona con nome.
      </para>
     </step>
     <step>
      <para>
       Reimpostare il gruppo di zone:
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup set &lt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Aggiornare il periodo. Vedere <xref linkend="ceph-rgw-fed-masterzone-updateperiod"/>.
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-keystone">
  <title>Integrazione di OpenStack Keystone</title>

  <para>
   OpenStack Keystone è un servizio di gestione delle identità per il prodotto OpenStack. È possibile integrare Object Gateway con Keystone per configurare un gateway che accetti un token di autenticazione Keystone. Un utente autorizzato da Keystone ad accedere al gateway verrà verificato sul lato Ceph Object Gateway e verrà creato automaticamente se necessario. Object Gateway interroga Keystone periodicamente per un elenco di token revocati.
  </para>

  <sect2 xml:id="ogw-keystone-ostack">
   <title>Configurazione di OpenStack</title>
   <para>
    Prima di configurare Ceph Object Gateway, è necessario configurare OpenStack Keystone all&apos;abilitazione del servizio Swift e fare in modo questo che punti a Ceph Object Gateway:
   </para>
   <procedure>
    <step>
     <para>
      <emphasis>Impostare il servizio Swift.</emphasis> Prima di poter utilizzare OpenStack per la convalida degli utenti Swift, creare il servizio Swift:
     </para>
<screen>
<prompt>&gt; </prompt>openstack service create \
 --name=swift \
 --description="Swift Service" \
 object-store
</screen>
    </step>
    <step>
     <para>
      <emphasis>Impostare gli endpoint.</emphasis> Dopo aver creato il servizio Swift, fare in modo che punti a Ceph Object Gateway. Sostituire <replaceable>REGION_NAME</replaceable> con il nome del gruppo di zone o il nome dell&apos;area del gateway.
     </para>
<screen>
<prompt>&gt; </prompt>openstack endpoint create --region <replaceable>REGION_NAME</replaceable> \
 --publicurl   "http://radosgw.example.com:8080/swift/v1" \
 --adminurl    "http://radosgw.example.com:8080/swift/v1" \
 --internalurl "http://radosgw.example.com:8080/swift/v1" \
 swift
</screen>
    </step>
    <step>
     <para>
      <emphasis>Verificare le impostazioni.</emphasis> Dopo aver creato il servizio Swift e impostati gli endpoint, visualizzare questi ultimi per verificare che tutte le impostazioni siano corrette.
     </para>
<screen>
<prompt>&gt; </prompt>openstack endpoint show object-store
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-keystone-ogw">
   <title>Configurazione di Ceph Object Gateway</title>
   <sect3>
    <title>Configurazione dei certificati SSL</title>
    <para>
     Ceph Object Gateway interroga Keystone periodicamente per un elenco di token revocati. Tali richieste sono codificate e firmate. È inoltre possibile configurare Keystone in modo che vengano forniti token firmati da se stessi, a loro volta codificati e firmati. È necessario configurare il gateway in modo che possa decodificare e verificare tali messaggi firmati. Pertanto, è necessario convertire in formato &quot;nss db&quot; i certificati OpenSSL utilizzati da Keystone per creare le richieste:
    </para>
<screen>
<prompt role="root"># </prompt>mkdir /var/ceph/nss
<prompt role="root"># </prompt>openssl x509 -in /etc/keystone/ssl/certs/ca.pem \
 -pubkey | certutil -d /var/ceph/nss -A -n ca -t "TCu,Cu,Tuw"
<systemitem class="username">root</systemitem>openssl x509 -in /etc/keystone/ssl/certs/signing_cert.pem \
 -pubkey | certutil -A -d /var/ceph/nss -n signing_cert -t "P,P,P"
</screen>
    <para>
     Per consentire l&apos;interazione tra Ceph Object Gateway e OpenStack Keystone, quest&apos;ultimo può utilizzare un certificato SSL firmato da se stessi. Installare il certificato SSL di Keystone sul nodo sul quale è in esecuzione Ceph Object Gateway o in alternativa impostare il valore dell&apos;opzione <option>rgw keystone verify ssl</option> su &quot;false&quot;. L&apos;impostazione di <option>rgw keystone verify ssl</option> su &quot;false&quot; significa che non verrà effettuato alcun tentativo di verifica del certificato da parte del gateway.
    </para>
   </sect3>
   <sect3 xml:id="config-ogw-options">
    <title>Configurazione delle opzioni di Object Gateway</title>
    <para>
     È possibile configurare l&apos;integrazione di Keystone utilizzando le opzioni seguenti:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone api version</option></term>
      <listitem>
       <para>
        Versione dell&apos;API Keystone. Le opzioni valide sono 2 o 3. Il valore di default è 2.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone url</option></term>
      <listitem>
       <para>
        URL e numero di porta dell&apos;API amministrativa RESTful sul server Keystone. Segue il modello <replaceable>SERVER_URL:PORT_NUMBER</replaceable>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin token</option></term>
      <listitem>
       <para>
        Token o segreto condiviso configurato all&apos;interno di Keystone per le richieste amministrative.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted roles</option></term>
      <listitem>
       <para>
        Ruoli richiesti per provvedere alle richieste. L&apos;impostazione di default è &quot;Member, admin&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted admin roles</option></term>
      <listitem>
       <para>
        Elenco dei ruoli che consentono a un utente di ottenere privilegi amministrativi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone token cache size</option></term>
      <listitem>
       <para>
        Numero massimo di voci nella cache dei token Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone revocation interval</option></term>
      <listitem>
       <para>
        Numero di secondi prima della verifica dei token revocati. Il valore di default è 15 * 60.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone implicit tenants</option></term>
      <listitem>
       <para>
        Crea nuovi utenti nei rispettivi tenant con lo stesso nome. L&apos;impostazione di default è &quot;false&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw s3 auth use keystone</option></term>
      <listitem>
       <para>
        Se impostata su &quot;&apos;true&quot;, Ceph Object Gateway eseguirà l&apos;autenticazione degli utenti tramite Keystone. L&apos;impostazione di default è &quot;false&quot;.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>nss db path</option></term>
      <listitem>
       <para>
        Percorso del database NSS.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     È inoltre possibile configurare il tenant del servizio Keystone, l&apos;utente e la password per Keystone (per la versione 2.0 di OpenStack Identity API) in modo simile a quanto avviene per la configurazione dei servizi OpenStack. In tal modo, è possibile evitare di impostare il segreto condiviso <option>rgw keystone admin token</option> nel file di configurazione, che deve essere disabilitato negli ambienti di produzione. Le credenziali del tenant del servizio devono disporre di privilegi amministrativi. Per ulteriori dettagli, fare riferimento alla <link xlink:href="https://docs.openstack.org/keystone/latest/#setting-up-projects-users-and-roles">documentazione ufficiale di OpenStack Keystone</link> (in lingua inglese). Di seguito sono riportate le opzioni di configurazione correlate:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin user</option></term>
      <listitem>
       <para>
        Nome utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin password</option></term>
      <listitem>
       <para>
        Password utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin tenant</option></term>
      <listitem>
       <para>
        Tenant utente amministratore Keystone versione 2.0.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Un utente Ceph Object Gateway viene mappato a un tenant Keystone. A un utente Keystone vengono assegnati diversi ruoli, possibilmente su più tenant. Quando Ceph Object Gateway ottiene il ticket, fa riferimento ai ruoli del tenant e dell&apos;utente assegnati a tale ticket, quindi accetta o rifiuta la richiesta in base all&apos;impostazione definita per l&apos;opzione <option>rgw keystone accepted roles</option>.
    </para>
    <tip>
     <title>mappatura ai tenant OpenStack</title>
     <para>
      Sebbene i tenant Swift vengano mappati per default all&apos;utente Object Gateway, è possibile mapparli anche ai tenant OpenStack tramite l&apos;opzione <option>rgw keystone implicit tenants</option>. In tal modo i container utilizzeranno lo spazio dei nomi dei tenant anziché quello globale uguale a S3 che è l&apos;impostazione di default di Object Gateway. Per evitare di fare confusione, si consiglia di decidere il metodo di mappatura in fase di pianificazione. L&apos;attivazione/disattivazione dell&apos;opzione in un momento successivo influisce solo sulle richieste più recenti che vengono mappate a un tenant, mentre i compartimenti creati precedentemente continuano a risiedere in uno spazio dei nomi globale.
     </para>
    </tip>
    <para>
     Per la versione 3 di OpenStack Identity API, si deve sostituire l&apos;opzione <option>rgw keystone admin tenant</option> con:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin domain</option></term>
      <listitem>
       <para>
        Domino utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin project</option></term>
      <listitem>
       <para>
        Progetto utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-storage-classes">
  <title>Posizionamento di pool e classi di storage</title>

  <sect2 xml:id="ogw-storage-classes-placement-targets">
   <title>Visualizzazione delle destinazioni di posizionamento</title>
   <para>
    Le destinazioni di posizionamento consentono di controllare quali pool sono associati a un determinato compartimento. La destinazione di posizionamento di un compartimento viene selezionata al momento della creazione e non può essere modificata. Per visualizzare la regola <literal>placement_rule</literal> corrispondente, utilizzare il comando seguente:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket stats
</screen>
   <para>
    La configurazione del gruppo di zone contiene un elenco di destinazioni di posizionamento con una destinazione iniziale denominata &quot;default-placement&quot;. La configurazione della zona mappa quindi ogni nome della destinazione di posizionamento del gruppo di zone allo storage locale corrispondente. Queste informazioni sul posizionamento della zona includono il nome &quot;index_pool&quot; per l&apos;indice del compartimento, il nome &quot;data_extra_pool&quot; per i metadati relativi agli upload multipart incompleti e il nome &quot;data_pool&quot; per ogni classe di storage.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-itself">
   <title>Classi di storage</title>
   <para>
    Le classi di storage agevolano la personalizzazione del posizionamento dei dati di oggetto. Le regole di S3 Bucket Lifecycle consentono di automatizzare la transizione degli oggetti tra le classi di storage.
   </para>
   <para>
    Le classi di storage vengono definite in termini di destinazioni di posizionamento. Per ogni destinazione di posizionamento del gruppo di zone sono elencate le relative classi di storage disponibili con una classe iniziale denominata &quot;STANDARD&quot;. La configurazione della zona specifica il nome di pool &quot;data_pool&quot; per ciascuna delle classi di storage del gruppo di zone.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-zone-config">
   <title>Configurazione dei gruppi di zone e delle zone</title>
   <para>
    Per configurare il posizionamento dei gruppi di zone e delle zone, utilizzare il comando <command>radosgw-admin</command>. È possibile interrogare la configurazione del posizionamento del gruppo di zone tramite il comando seguente:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup get
{
    "id": "ab01123f-e0df-4f29-9d71-b44888d67cd5",
    "name": "default",
    "api_name": "default",
    ...
    "placement_targets": [
        {
            "name": "default-placement",
            "tags": [],
            "storage_classes": [
                "STANDARD"
            ]
        }
    ],
    "default_placement": "default-placement",
    ...
}
</screen>
   <para>
    Per interrogare la configurazione del posizionamento della zona, eseguire:
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone get
{
    "id": "557cdcee-3aae-4e9e-85c7-2f86f5eddb1f",
    "name": "default",
    "domain_root": "default.rgw.meta:root",
    ...
    "placement_pools": [
        {
            "key": "default-placement",
            "val": {
                "index_pool": "default.rgw.buckets.index",
                "storage_classes": {
                    "STANDARD": {
                        "data_pool": "default.rgw.buckets.data"
                    }
                },
                "data_extra_pool": "default.rgw.buckets.non-ec",
                "index_type": 0
            }
        }
    ],
    ...
}
</screen>
   <note>
    <title>nessuna configurazione multisito precedente</title>
    <para>
     Se in precedenza non è stata effettuata nessuna configurazione multisito, vengono creati un gruppo di zone e una zona &quot;default&quot; per l&apos;utente e le relative modifiche apportate non saranno effettive fino al riavvio di Ceph Object Gateway. Se è stato creato un dominio per la configurazione multisito, le modifiche alla zona/al gruppo di zone verranno applicate dopo averle confermate tramite il comando <command>radosgw-admin period update --commit</command>.
    </para>
   </note>
   <sect3 xml:id="adding-placement-target">
    <title>Aggiunta di una destinazione di posizionamento</title>
    <para>
     Per creare una nuova destinazione di posizionamento denominata &quot;temporary&quot;, iniziare aggiungendola al gruppo di zone:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id temporary
</screen>
    <para>
     Quindi, fornire le informazioni sul posizionamento della zona per la destinazione specificata:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id temporary \
      --data-pool default.rgw.temporary.data \
      --index-pool default.rgw.temporary.index \
      --data-extra-pool default.rgw.temporary.non-ec
</screen>
   </sect3>
   <sect3 xml:id="adding-storage-class">
    <title>Aggiunta di una classe di storage</title>
    <para>
     Per aggiungere una nuova classe di storage denominata &quot;COLD&quot; alla destinazione &quot;default-placement&quot;, iniziare aggiungendola al gruppo di zone:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id default-placement \
      --storage-class COLD
</screen>
    <para>
     Quindi, fornire le informazioni sul posizionamento della zona per la classe di storage specificata:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id default-placement \
      --storage-class COLD \
      --data-pool default.rgw.cold.data \
      --compression lz4
</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-customizing-placement">
   <title>Personalizzazione del posizionamento</title>
   <sect3 xml:id="edit-default-zgroup-placement">
    <title>Modifica del posizionamento del gruppo di zone di default</title>
    <para>
     Per default, i nuovi compartimenti utilizzeranno la destinazione <literal>default_placement</literal> del gruppo di zone. È possibile modificare questa impostazione del gruppo di zone con quanto segue:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement default \
      --rgw-zonegroup default \
      --placement-id new-placement
</screen>
   </sect3>
   <sect3 xml:id="edit-default-user-placement">
    <title>Modifica del posizionamento dell&apos;utente di default</title>
    <para>
     Gli utenti di Ceph Object Gateway possono sostituire la destinazione di posizionamento di default del gruppo di zone impostando un campo <literal>default_placement</literal> non vuoto nella sezione delle informazioni utente. Analogamente, la classe <literal>default_storage_class</literal> può sostituire la classe di storage <option>STANDARD</option> applicata per default agli oggetti.
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid testid
{
    ...
    "default_placement": "",
    "default_storage_class": "",
    "placement_tags": [],
    ...
}
</screen>
    <para>
     Se la destinazione di posizionamento di un gruppo di zone contiene tag, gli utenti non potranno creare compartimenti con questa destinazione, a meno che le relative informazioni non contengano almeno un tag corrispondente nel campo &quot;placement_tags&quot;. Ciò può essere utile per limitare l&apos;accesso a determinati tipi di storage.
    </para>
    <para>
     Poiché il comando <command>radosgw-admin</command> non è in grado di modificare direttamente questi campi, è necessario modificare manualmente il formato JSON:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin metadata get user:<replaceable>USER-ID</replaceable> &gt; user.json
<prompt>&gt; </prompt>vi user.json     # edit the file as required
<prompt>cephuser@adm &gt; </prompt>radosgw-admin metadata put user:<replaceable>USER-ID</replaceable> &lt; user.json
</screen>
   </sect3>
   <sect3 xml:id="s3-bucket-default-placement">
    <title>Modifica del posizionamento del compartimento S3 di default</title>
    <para>
     Durante la creazione di un compartimento con il protocollo S3, è possibile specificare una destinazione di posizionamento come parte del <option>LocationConstraint</option> al fine di sostituire le destinazioni di posizionamento di default per l&apos;utente e il gruppo di zone.
    </para>
    <para>
     In genere, il <option>LocationConstraint</option> deve corrispondere all&apos;<option>api_name</option> del gruppo di zone:
    </para>
<screen>&lt;LocationConstraint&gt;default&lt;/LocationConstraint&gt;</screen>
    <para>
     È possibile aggiungere una destinazione di posizionamento personalizzata all&apos;<option>api_name</option> dopo i due punti:
    </para>
<screen>&lt;LocationConstraint&gt;default:new-placement&lt;/LocationConstraint&gt;</screen>
   </sect3>
   <sect3 xml:id="swift-default-bucket-placement">
    <title>Modifica del posizionamento del compartimento Swift</title>
    <para>
     Durante la creazione di un compartimento con il protocollo Swift, è possibile specificare una destinazione di posizionamento nell&apos;<literal>X-Storage-Policy</literal> dell&apos;intestazione HTTP:
    </para>
<screen>X-Storage-Policy: <replaceable>NEW-PLACEMENT</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-usage">
   <title>Utilizzo delle classi di storage</title>
   <para>
    Tutte le destinazioni di posizionamento dispongono di una classe di storage <option>STANDARD</option> che viene applicata per default ai nuovi oggetti. È possibile sostituire questa classe di default con la relativa <literal>default_storage_class</literal>.
   </para>
   <para>
    Per creare un oggetto in una classe di storage non di default, specificare il nome di tale classe in un&apos;intestazione HTTP insieme alla richiesta. Il protocollo S3 utilizza l&apos;intestazione <literal>X-Amz-Storage-Class</literal>, mentre il protocollo Swift utilizza l&apos;intestazione <literal>X-Object-Storage-Class</literal>.
   </para>
   <para>
    È possibile utilizzare <emphasis>S3 Object Lifecycle Management</emphasis> per spostare i dati degli oggetti tra le classi di storage con le azioni <option>Transition</option>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-fed">
  <title>Object Gateway multisito</title>

  <para>
   Ceph supporta diverse opzioni di configurazione multisito per Ceph Object Gateway:
  </para>

  <variablelist>
   <varlistentry>
    <term>Multizona</term>
    <listitem>
     <para>
      Configurazione composta da un gruppo di zone e da più zone, ognuna delle quali con una o più istanze <systemitem class="daemon">ceph-radosgw</systemitem>. Ogni zona è supportata dal relativo cluster di memorizzazione Ceph. Le zone multiple all&apos;interno di un gruppo di zone forniscono funzionalità di disaster recovery a quest&apos;ultimo, se dovesse verificarsi un grave errore in una delle zone. Ogni zona è attiva e può ricevere operazioni di scrittura. Oltre alle funzioni di disaster recovery, più zone attive possono fungere anche da base per le reti per la consegna di contenuto.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Gruppo multizona</term>
    <listitem>
     <para>
      Ceph Object Gateway supporta più gruppi di zone, ciascuno costituito da una o più zone. Gli oggetti memorizzati nelle zone di un gruppo di zone all&apos;interno dello stesso dominio di un altro gruppo di zone condividono uno spazio dei nomi di oggetto globale, per fare in modo che gli ID oggetto delle zone e dei gruppi di zone siano univoci.
     </para>
     <note>
      <para>
       È importante tenere presente che i gruppi di zone sincronizzano i metadati <emphasis>soltanto</emphasis> tra di loro. I dati e i metadati vengono replicati tra le zone all&apos;interno del gruppo di zone e non vengono condivisi nel dominio.
      </para>
     </note>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Domini multipli</term>
    <listitem>
     <para>
      Ceph Object Gateway supporta la nozione dei domini, ovvero uno spazio dei nomi univoco a livello globale. I domini multipli sono supportati e possono contenere uno o più gruppi di zone.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   È possibile configurare ciascun Object Gateway per l&apos;esecuzione in una configurazione della zona attiva-attiva, al fine di consentire le operazioni di scrittura nelle zone non master. La configurazione multisito è memorizzata all&apos;interno di un container denominato dominio. Il dominio memorizza gruppi di zone, zone e un intervallo di tempo con più epoche per il monitoraggio delle modifiche apportate alla configurazione. I daemon <systemitem class="daemon">rgw</systemitem> gestiscono la sincronizzazione eliminando la necessità di utilizzare un agente di sincronizzazione separato. Questo approccio alla sincronizzazione consente il funzionamento di Ceph Object Gateway con una configurazione attiva-attiva invece che attiva-passiva.
  </para>

  <sect2 xml:id="ceph-rgw-multi-req-assump">
   <title>Requisiti e presupposti</title>
   <para>
    Per una configurazione multisito sono necessari almeno due cluster di memorizzazione Ceph e almeno due istanze di Ceph Object Gateway, una per ogni cluster di memorizzazione Ceph. Nella configurazione riportata di seguito si presuppone la presenza di almeno due cluster di memorizzazione Ceph in ubicazioni geograficamente separate. Tuttavia, la configurazione può funzionare nello stesso sito. Ad esempio, le zone denominate <literal>rgw1</literal> e <literal>rgw2</literal>.
   </para>
   <para>
    Per la configurazione multisito sono necessari un gruppo di zone master e una zona master, che sarà l&apos;origine di riferimento per quanto riguarda tutte le operazioni dei metadati in un cluster multisito. Inoltre, ogni gruppo di zone deve contenere una zona master. I gruppi di zone possono avere una o più zone non master o secondarie. Nella presente guida, l&apos;host <literal>rgw1</literal> funge da zona master del gruppo di zone master e l&apos;host <literal>rgw2</literal> funge da zona secondaria del gruppo di zone master.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-config-master-zone">
   <title>Configurazione di una zona master</title>
   <para>
    Tutti i gateway di una configurazione multisito recuperano la rispettiva configurazione da un daemon <systemitem class="daemon">ceph-radosgw</systemitem> su un host all&apos;interno del gruppo di zone master e della zona master. Per configurare i gateway in una configurazione multisito, selezionare un&apos;istanza <systemitem class="daemon">ceph-radosgw</systemitem> per configurare il gruppo di zone master e la zona master.
   </para>
   <sect3 xml:id="ceph-rgw-fed-realm">
    <title>Creazione di un dominio</title>
    <para>
     Un dominio rappresenta uno spazio dei nomi univoco a livello globale composto da uno o più gruppi di zone contenenti una o più zone. Le zone contengono i compartimenti, che a loro volta contengono gli oggetti. Tramite i domini, Ceph Object Gateway può supportare più spazi dei nomi e le relative configurazioni sullo stesso hardware. Un dominio contiene la nozione dei periodi. Ogni periodo rappresenta lo stato della configurazione del gruppo di zone e della zona nel tempo. Ogni volta che si apporta una modifica a un gruppo di zone o a una zona, aggiornare il periodo ed eseguirne il commit. Per default, Ceph Object Gateway non crea domini per la compatibilità con le versioni precedenti. Come best practice, si consiglia di creare i domini per i nuovi cluster.
    </para>
    <para>
     Creare un nuovo dominio denominato <literal>gold</literal> per la configurazione multisito aprendo l&apos;interfaccia della riga di comando su un host da utilizzare nel gruppo di zone e nella zona master. Quindi, eseguire quanto riportato di seguito:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm create --rgw-realm=gold --default</screen>
    <para>
     Se il cluster dispone di un dominio singolo, specificare il flag <option>--default</option>. Se il flag <option>--default</option> è specificato, <command>radosgw-admin</command> utilizza per default questo dominio. Se il flag <option>--default</option> non è specificato, per aggiungere gruppi di zone e zone occorre specificare i flag <option>--rgw-realm</option> o <option>--realm-id</option> per identificare il dominio durante l&apos;aggiunta di gruppi di zone e zone.
    </para>
    <para>
     In seguito alla creazione del dominio, <command>radosgw-admin</command> ne restituisce la configurazione:
    </para>
<screen>
{
  "id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "name": "gold",
  "current_period": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "epoch": 1
}</screen>
    <note>
     <para>
      Ceph genera un ID univoco per il dominio, che ne consente la ridenominazione in caso di necessità.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-createmasterzonegrp">
    <title>Creazione di un gruppo di zone master</title>
    <para>
     All&apos;interno di un dominio deve essere presente almeno un gruppo di zone che funge da gruppo di zone master del dominio stesso. Creare un nuovo gruppo di zone master per la configurazione multisito aprendo l&apos;interfaccia della riga di comando su un host da utilizzare nel gruppo di zone e nella zona master. Creare un gruppo di zone master denominato <literal>us</literal> eseguendo quanto riportato di seguito:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup create --rgw-zonegroup=us \
--endpoints=http://rgw1:80 --master --default</screen>
    <para>
     Se il dominio dispone di un singolo gruppo di zone, specificare il flag <option>--default</option>. Se il flag <option>--default</option> è specificato, <command>radosgw-admin</command> utilizza per default questo gruppo di zone per l&apos;aggiunta di nuove zone. Se il flag <option>--default</option> non è specificato, per aggiungere le zone occorre specificare i flag <option>--rgw-zonegroup</option> o <option>--zonegroup-id</option> per identificare il gruppo di zone durante l&apos;aggiunta o la modifica delle zone.
    </para>
    <para>
     In seguito alla creazione del gruppo di zone master, <command>radosgw-admin</command> ne restituisce la configurazione: Esempio:
    </para>
<screen>{
 "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
 "name": "us",
 "api_name": "us",
 "is_master": "true",
 "endpoints": [
     "http:\/\/rgw1:80"
 ],
 "hostnames": [],
 "hostnames_s3website": [],
 "master_zone": "",
 "zones": [],
 "placement_targets": [],
 "default_placement": "",
 "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
}</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone">
    <title>Creazione di una zona master</title>
    <important>
     <para>
      Le zone devono essere create su un nodo Ceph Object Gateway che si trova all&apos;interno della zona.
     </para>
    </important>
    <para>
     Creare una nuova zona master per la configurazione multisito aprendo l&apos;interfaccia della riga di comando su un host da utilizzare nel gruppo di zone e nella zona master. Eseguire le operazioni seguenti:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --rgw-zone=us-east-1 \
--endpoints=http://rgw1:80 --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>SYSTEM_SECRET_KEY</replaceable></screen>
    <note>
     <para>
      Le opzioni <option>--access-key</option> e <option>--secret</option> non sono specificate nell&apos;esempio precedente e vengono aggiunte alla zona al momento della creazione dell&apos;utente nella sezione successiva.
     </para>
    </note>
    <para>
     In seguito alla creazione della zona master, <command>radosgw-admin</command> ne restituisce la configurazione. Esempio:
    </para>
<screen>
  {
      "id": "56dfabbb-2f4e-4223-925e-de3c72de3866",
      "name": "us-east-1",
      "domain_root": "us-east-1.rgw.meta:root",
      "control_pool": "us-east-1.rgw.control",
      "gc_pool": "us-east-1.rgw.log:gc",
      "lc_pool": "us-east-1.rgw.log:lc",
      "log_pool": "us-east-1.rgw.log",
      "intent_log_pool": "us-east-1.rgw.log:intent",
      "usage_log_pool": "us-east-1.rgw.log:usage",
      "reshard_pool": "us-east-1.rgw.log:reshard",
      "user_keys_pool": "us-east-1.rgw.meta:users.keys",
      "user_email_pool": "us-east-1.rgw.meta:users.email",
      "user_swift_pool": "us-east-1.rgw.meta:users.swift",
      "user_uid_pool": "us-east-1.rgw.meta:users.uid",
      "otp_pool": "us-east-1.rgw.otp",
      "system_key": {
          "access_key": "1555b35654ad1656d804",
          "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
      },
      "placement_pools": [
          {
              "key": "us-east-1-placement",
              "val": {
                  "index_pool": "us-east-1.rgw.buckets.index",
                  "storage_classes": {
                      "STANDARD": {
                          "data_pool": "us-east-1.rgw.buckets.data"
                      }
                  },
                  "data_extra_pool": "us-east-1.rgw.buckets.non-ec",
                  "index_type": 0
              }
          }
      ],
      "metadata_heap": "",
      "realm_id": ""
  }</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-deldefzonegrp">
    <title>Eliminazione del gruppo e della zona di default</title>
    <important>
     <para>
      Nella procedura seguente si presuppone che sia stata eseguita una configurazione multisito tramite i sistemi appena installati che non hanno ancora iniziato a memorizzare i dati. <emphasis role="bold">Non eliminare</emphasis> la zona di default e i relativi pool se la si utilizza già per memorizzare i dati, altrimenti questi verranno eliminati e non sarà più possibile recuperarli.
     </para>
    </important>
    <para>
     L&apos;installazione di default di Object Gateway crea un gruppo di zone di default denominato <literal>default</literal>. Eliminare la zona di default se presente. Rimuoverla innanzitutto dal gruppo di zone di default.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup delete --rgw-zonegroup=default</screen>
    <para>
     Eliminare i pool di default dal cluster di memorizzazione Ceph, se presenti:
    </para>
    <important>
     <para>
      Nel passaggio seguente si presuppone che sia stata eseguita una configurazione multisito tramite i sistemi appena installati che non hanno ancora iniziato a memorizzare i dati. <emphasis role="bold">Non eliminare</emphasis> il gruppo di zone di default se lo si utilizza già per memorizzare i dati.
     </para>
    </important>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.meta default.rgw.meta --yes-i-really-really-mean-it</screen>
    <warning>
     <para>
      Se il gruppo di zone di default viene eliminato, verrà eliminato anche l&apos;utente del sistema. Se le chiavi dell&apos;utente amministratore non vengono propagate, la funzionalità di gestione di Object Gateway del Ceph Dashboard restituirà un errore. Andare alla sezione successiva per ricreare l&apos;utente di sistema se si procede con questo passaggio.
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-createuser">
    <title>Creazione di utenti di sistema</title>
    <para>
     I daemon <systemitem class="daemon">ceph-radosgw</systemitem> devono eseguire l&apos;autenticazione prima di eseguire il pull delle informazioni sul dominio e sul periodo. Nella zona master, creare un utente di sistema per semplificare l&apos;autenticazione tra i daemon:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=zone.user \
--display-name="Zone User" --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> \
--secret=<replaceable>SYSTEM_SECRET_KEY</replaceable> --system</screen>
    <para>
     Annotare le variabili <option>access_key</option> e <option>secret_key</option>, poiché saranno necessarie per l&apos;autenticazione delle zone secondarie nella zona master.
    </para>
    <para>
     Aggiungere l&apos;utente di sistema alla zona master:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=us-east-1 \
--access-key=<replaceable>ACCESS-KEY</replaceable> --secret=<replaceable>SECRET</replaceable></screen>
    <para>
     Aggiornare il periodo per applicare le modifiche:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-updateperiod">
    <title>Aggiornare il periodo</title>
    <para>
     Dopo aver aggiornato la configurazione della zona master, aggiornare il periodo:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    <para>
     In seguito all&apos;aggiornamento del periodo, <command>radosgw-admin</command> ne restituisce la configurazione. Esempio:
    </para>
<screen>{
  "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "epoch": 1, "predecessor_uuid": "", "sync_status": [], "period_map":
  {
    "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "zonegroups": [], "short_zone_ids": []
  }, "master_zonegroup": "", "master_zone": "", "period_config":
  {
     "bucket_quota": {
     "enabled": false, "max_size_kb": -1, "max_objects": -1
     }, "user_quota": {
       "enabled": false, "max_size_kb": -1, "max_objects": -1
     }
  }, "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7", "realm_name": "gold", "realm_epoch": 1
}</screen>
    <note>
     <para>
      Tramite l&apos;aggiornamento del periodo viene modificata l&apos;epoca e ci si assicura che le altre zone ricevano la configurazione aggiornata.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-startrgw">
    <title>Avvio di Gateway</title>
    <para>
     Sull&apos;host di Object Gateway, avviare e abilitare il servizio Ceph Object Gateway. Per identificare l&apos;FSID univoco del cluster, eseguire <command>ceph fsid</command>. Per identificare il nome del daemon di Object Gateway, eseguire <command>ceph orch ps --hostname <replaceable>HOSTNAME</replaceable></command>.
    </para>
<screen><prompt>cephuser@ogw &gt; </prompt>systemctl start ceph-<replaceable>FSID</replaceable>@<replaceable>DAEMON_NAME</replaceable>
<prompt>cephuser@ogw &gt; </prompt>systemctl enable ceph-<replaceable>FSID</replaceable>@<replaceable>DAEMON_NAME</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-config-secondaryzone">
   <title>Configurazione delle zone secondarie</title>
   <para>
    Le zone all&apos;interno di un gruppo di zone replicano tutti i dati per fare in modo che in ogni zona siano presenti gli stessi dati. Durante la creazione di una zona secondaria, effettuare tutte le operazioni seguenti su un host identificato per servire tale zona.
   </para>
   <note>
    <para>
     Per aggiungere una terza zona, attenersi alle stesse procedure seguite per l&apos;aggiunta della zona secondaria. Utilizzare un nome diverso per la zona.
    </para>
   </note>
   <important>
    <para>
     Le operazioni dei metadati, come la creazione di un utente, devono essere eseguite su un host all&apos;interno della zona master. La zona master e la zona secondaria possono ricevere le operazioni dei compartimenti, ma la zona secondaria reindirizza tali operazioni alla zona master. Se la zona master è inattiva, le operazioni dei compartimenti non andranno a buon fine.
    </para>
   </important>
   <sect3 xml:id="ceph-rgw-pull-realm">
    <title>Esecuzione del pull del dominio</title>
    <para>
     Utilizzando il percorso URL, la chiave di accesso e il segreto della zona master nel gruppo di zone master, importare la configurazione del dominio nell&apos;host. Per importare un dominio non di default, specificare il dominio tramite le opzioni di configurazione <option>--rgw-realm</option> o <option>--realm-id</option>.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm pull --url=<replaceable>url-to-master-zone-gateway</replaceable> --access-key=<replaceable>access-key</replaceable> --secret=<replaceable>secret</replaceable></screen>
    <note>
     <para>
      Tramite l&apos;importazione del dominio viene recuperata anche la configurazione corrente del periodo, che viene contrassegnato come attuale anche sull&apos;host remoto.
     </para>
    </note>
    <para>
     Se questo dominio è il dominio di default o l&apos;unico dominio, contrassegnarlo come dominio di default.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm default --rgw-realm=<replaceable>REALM-NAME</replaceable></screen>
   </sect3>
   <sect3 xml:id="cceph-rgw-create-secondaryzone">
    <title>Creazione di una zona secondaria</title>
    <para>
     Creare una zona secondaria per la configurazione multisito aprendo l&apos;interfaccia della riga di comando su un host da utilizzare nella zona secondaria. Specificare l&apos;ID del gruppo di zone, il nome della nuova zona e l&apos;endpoint corrispondente. <emphasis>Non</emphasis> utilizzare il flag <option>--master</option>. Per default, tutte le zone vengono eseguite in una configurazione attiva-attiva. Se la zona secondaria non deve accettare le operazioni di scrittura, specificare il flag <option>--read-only</option> per creare una configurazione attiva-passiva tra la zona master e la zona secondaria. Inoltre, specificare le variabili <option>access_key</option> e <option>secret_key</option> dell&apos;utente di sistema generato memorizzate nella zona master del gruppo di zone master. Eseguire le operazioni seguenti:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable>\
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> --endpoints=<replaceable>URL</replaceable> \
 --access-key=<replaceable>SYSTEM-KEY</replaceable> --secret=<replaceable>SECRET</replaceable>\
 --endpoints=http://<replaceable>FQDN</replaceable>:80 \
 [--read-only]
</screen>
    <para>
     Esempio:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --endpoints=http://rgw2:80 \
--rgw-zone=us-east-2 --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>SYSTEM_SECRET_KEY</replaceable>
{
  "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
  "name": "us-east-2",
  "domain_root": "us-east-2.rgw.data.root",
  "control_pool": "us-east-2.rgw.control",
  "gc_pool": "us-east-2.rgw.gc",
  "log_pool": "us-east-2.rgw.log",
  "intent_log_pool": "us-east-2.rgw.intent-log",
  "usage_log_pool": "us-east-2.rgw.usage",
  "user_keys_pool": "us-east-2.rgw.users.keys",
  "user_email_pool": "us-east-2.rgw.users.email",
  "user_swift_pool": "us-east-2.rgw.users.swift",
  "user_uid_pool": "us-east-2.rgw.users.uid",
  "system_key": {
      "access_key": "1555b35654ad1656d804",
      "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
  },
  "placement_pools": [
      {
          "key": "default-placement",
          "val": {
              "index_pool": "us-east-2.rgw.buckets.index",
              "data_pool": "us-east-2.rgw.buckets.data",
              "data_extra_pool": "us-east-2.rgw.buckets.non-ec",
              "index_type": 0
          }
      }
  ],
  "metadata_heap": "us-east-2.rgw.meta",
  "realm_id": "815d74c2-80d6-4e63-8cfc-232037f7ff5c"
}</screen>
    <important>
     <para>
      Nei passaggi seguenti si presuppone che sia stata eseguita una configurazione multisito tramite i sistemi appena installati che non hanno ancora iniziato a memorizzare i dati. <emphasis role="bold">Non eliminare</emphasis> la zona di default e i relativi pool se la si utilizza già per memorizzare i dati, altrimenti questi andranno persi e non sarà più possibile recuperarli.
     </para>
    </important>
    <para>
     Eliminare la zona di default se necessario:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone delete --rgw-zone=default</screen>
    <para>
     Eliminare i pool di default dal cluster di memorizzazione Ceph se necessario:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.users.uid default.rgw.users.uid --yes-i-really-really-mean-it</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-secondzone-update-config">
    <title>Aggiornamento del file di configurazione Ceph</title>
    <para>
     Aggiornare il file di configurazione Ceph sugli host della zona secondaria aggiungendo l&apos;opzione di configurazione <literal>rgw_zone</literal> e il nome della zona secondaria alla voce dell&apos;istanza.
    </para>
    <para>
     Per farlo, eseguire il comando seguente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set <replaceable>SERVICE_NAME</replaceable> rgw_zone us-west</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-secondzone-updateperiod">
    <title>Aggiornamento del periodo</title>
    <para>
     Dopo aver aggiornato la configurazione della zona master, aggiornare il periodo:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit
{
  "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
  "epoch": 2,
  "predecessor_uuid": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "sync_status": [ "[...]"
  ],
  "period_map": {
      "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
      "zonegroups": [
          {
              "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
              "name": "us",
              "api_name": "us",
              "is_master": "true",
              "endpoints": [
                  "http:\/\/rgw1:80"
              ],
              "hostnames": [],
              "hostnames_s3website": [],
              "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "zones": [
                  {
                      "id": "83859a9a-9901-4f00-aa6d-285c777e10f0",
                      "name": "us-east-1",
                      "endpoints": [
                          "http:\/\/rgw1:80"
                      ],
                      "log_meta": "true",
                      "log_data": "false",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  },
                  {
                      "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
                      "name": "us-east-2",
                      "endpoints": [
                          "http:\/\/rgw2:80"
                      ],
                      "log_meta": "false",
                      "log_data": "true",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  }

              ],
              "placement_targets": [
                  {
                      "name": "default-placement",
                      "tags": []
                  }
              ],
              "default_placement": "default-placement",
              "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
          }
      ],
      "short_zone_ids": [
          {
              "key": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "val": 630926044
          },
          {
              "key": "950c1a43-6836-41a2-a161-64777e07e8b8",
              "val": 4276257543
          }

      ]
  },
  "master_zonegroup": "d4018b8d-8c0d-4072-8919-608726fa369e",
  "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
  "period_config": {
      "bucket_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      },
      "user_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      }
  },
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "realm_name": "gold",
  "realm_epoch": 2
}</screen>
    <note>
     <para>
      Tramite l&apos;aggiornamento del periodo viene modificata l&apos;epoca e ci si assicura che le altre zone ricevano la configurazione aggiornata.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-secondzone-startrgw">
    <title>Avvio di Object Gateway</title>
    <para>
     Sull&apos;host di Object Gateway, avviare e abilitare il servizio Ceph Object Gateway:
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch start rgw.us-east-2
</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-check-sync-status">
    <title>Verifica dello stato di sincronizzazione</title>
    <para>
     Una volta configurata la zona secondaria, verificare lo stato di sincronizzazione. La sincronizzazione copia nella zona secondaria gli utenti e i compartimenti creati nella zona master.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin sync status</screen>
    <para>
     L&apos;output fornisce lo stato delle operazioni di sincronizzazione. Esempio:
    </para>
<screen>realm f3239bc5-e1a8-4206-a81d-e1576480804d (gold)
    zonegroup c50dbb7e-d9ce-47cc-a8bb-97d9b399d388 (us)
         zone 4c453b70-4a16-4ce8-8185-1893b05d346e (us-west)
metadata sync syncing
              full sync: 0/64 shards
              metadata is caught up with master
              incremental sync: 64/64 shards
    data sync source: 1ee9da3e-114d-4ae3-a8a4-056e8a17f532 (us-east)
                      syncing
                      full sync: 0/128 shards
                      incremental sync: 128/128 shards
                      data is caught up with source</screen>
    <note>
     <para>
      Le zone secondarie accettano le operazioni dei compartimenti; tuttavia, le reindirizzano alla zona master ed eseguono la sincronizzazione con quest&apos;ultima per ricevere i risultati di tali operazioni. Se la zona master è inattiva, le operazioni dei compartimenti eseguite sulla zona secondaria non andranno a buon fine, ma le operazioni degli oggetti riusciranno correttamente.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-object-verification">
    <title>Verifica di un oggetto</title>
    <para>
     Per default, dopo che la sincronizzazione di un oggetto è riuscita non viene eseguita una nuova verifica degli oggetti. Per abilitare la verifica, impostare l&apos;opzione <option>rgw_sync_obj_etag_verify</option> su <option>true</option>. Dopo l&apos;abilitazione, gli oggetti facoltativi verranno sincronizzati. Un ulteriore checksum MD5 verificherà che il calcolo sia effettuato sull&apos;origine e sulla destinazione. Questo consente di assicurare l&apos;integrità degli oggetti recuperati da un server remoto su HTTP, inclusa la sincronizzazione multisito. L&apos;opzione può ridurre le prestazioni degli RGW poiché è necessaria maggiore potenza di calcolo.
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-maintenance">
   <title>Manutenzione generale di Object Gateway</title>
   <sect3 xml:id="ceph-rgw-check-sync">
    <title>Verifica dello stato di sincronizzazione</title>
    <para>
     È possibile interrogare le informazioni sullo stato della replica di una zona con:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin sync status
        realm b3bc1c37-9c44-4b89-a03b-04c269bea5da (gold)
    zonegroup f54f9b22-b4b6-4a0e-9211-fa6ac1693f49 (us)
         zone adce11c9-b8ed-4a90-8bc5-3fc029ff0816 (us-west)
        metadata sync syncing
              full sync: 0/64 shards
              incremental sync: 64/64 shards
              metadata is behind on 1 shards
              oldest incremental change not applied: 2017-03-22 10:20:00.0.881361s
data sync source: 341c2d81-4574-4d08-ab0f-5a2a7b168028 (us-east)
                  syncing
                  full sync: 0/128 shards
                  incremental sync: 128/128 shards
                  data is caught up with source
          source: 3b5d1a3f-3f27-4e4a-8f34-6072d4bb1275 (us-3)
                  syncing
                  full sync: 0/128 shards
                  incremental sync: 128/128 shards
                  data is caught up with source</screen>
    <para>
     L&apos;output può variare a seconda dello stato di sincronizzazione. Durante la sincronizzazione, i partizionamenti sono descritti come di due tipi diversi:
    </para>
    <variablelist>
     <varlistentry>
      <term>Partizionamenti arretrati</term>
      <listitem>
       <para>
        I partizionamenti arretrati sono quelli che richiedono una sincronizzazione completa dei dati e quelli che richiedono una sincronizzazione dei dati incrementale perché non sono aggiornati.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Partizionamenti di ripristino</term>
      <listitem>
       <para>
        I partizionamenti di ripristino sono quelli contrassegnati per un nuovo tentativo, poiché con un errore durante la sincronizzazione. L&apos;errore riguarda principalmente problemi minori, come l&apos;acquisizione di un blocco su un compartimento, e in genere si risolve da sé.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph-rgw-multisite-logs">
    <title>Controllo dei log</title>
    <para>
     Solo per la configurazione multisito, è possibile controllare il log dei metadati (<option>mdlog</option>), il log dell&apos;indice del compartimento (<option>bilog</option>) e il log dei dati (<option>datalog</option>). È possibile elencarli e troncarli. Nella maggior parte dei casi, l&apos;operazione non è necessaria poiché l&apos;opzione <option>rgw_sync_log_trim_interval</option> è impostata per default a 20 minuti. Se l&apos;opzione non è impostata manualmente su 0, non sarà mai necessario effettuare la troncatura, che può causare effetti collaterali.
    </para>
   </sect3>
   <sect3 xml:id="ceph-rgw-metadata-master">
    <title>Modifica della zona dei metadata master</title>
    <important>
     <para>
      Prestare la massima attenzione quando si modifica la zona dei metadata master. Se una zona non ha terminato la sincronizzazione dei metadati dalla zona master corrente, non sarà in grado di servire alcuna voce rimanente quando viene promossa al ruolo di master e queste modifiche andranno perse. Per questo motivo, prima di promuoverla come master, si consiglia di attendere che lo stato di sincronizzazione <command>radosgw-admin</command> della zona raggiunga lo stesso livello della sincronizzazione dei metadati. Analogamente, se le modifiche ai metadati sono in corso di elaborazione nella zona master corrente, mentre è in corso la promozione di un&apos;altra zona al ruolo di master, è probabile che queste modifiche andranno perse. Per evitarlo, si consiglia di disattivare le istanze di Object Gateway sulla zona master precedente. In seguito alla promozione di un&apos;altra zona, il rispettivo nuovo periodo può essere recuperato con il pull del periodo di <command>radosgw-admin</command> ed è possibile riavviare i gateway.
     </para>
    </important>
    <para>
     Per promuovere una zona (ad esempio, la zona <literal>us-west</literal> nel gruppo di zone <literal>us</literal>) a metadata master, eseguire i comandi seguenti su tale zona:
    </para>
<screen><prompt>cephuser@ogw &gt; </prompt>radosgw-admin zone modify --rgw-zone=us-west --master
<prompt>cephuser@ogw &gt; </prompt>radosgw-admin zonegroup modify --rgw-zonegroup=us --master
<prompt>cephuser@ogw &gt; </prompt>radosgw-admin period update --commit</screen>
    <para>
     In questo modo viene generato un nuovo periodo che verrà inviato ad altre zone dalle istanze di Object Gateway nella zona <literal>us-west</literal>.
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-failover-dr">
   <title>Esecuzione del failover e del disaster recovery</title>
   <para>
    Qualora la zona master dovesse venire meno, eseguire il failover nella zona secondaria per il disaster recovery.
   </para>
   <procedure>
    <step>
     <para>
      Rendere la zona secondaria la zona master e di default. Esempio:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default</screen>
     <para>
      Per default, Ceph Object Gateway viene eseguito in una configurazione attiva-attiva. Se si è configurato il cluster per l&apos;esecuzione in una configurazione attiva-passiva, la zona secondaria è di sola lettura. Rimuovere lo stato <option>--read-only</option> per consentire alla zona di ricevere le operazioni di scrittura. Esempio:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default \
                                                   --read-only=false
</screen>
    </step>
    <step>
     <para>
      Aggiornare il periodo per applicare le modifiche:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Riavviare Ceph Object Gateway:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart rgw</screen>
    </step>
   </procedure>
   <para>
    Se la zona master precedente viene recuperata, ripristinare l&apos;operazione.
   </para>
   <procedure>
    <step>
     <para>
      Dalla zona recuperata, eseguire il pull della configurazione del dominio più recente dall&apos;attuale zona master.
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm pull --url=<replaceable>URL-TO-MASTER-ZONE-GATEWAY</replaceable> \
                           --access-key=<replaceable>ACCESS-KEY</replaceable> --secret=<replaceable>SECRET</replaceable>
</screen>
    </step>
    <step>
     <para>
      Rendere la zona recuperata la zona master e di default:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default</screen>
    </step>
    <step>
     <para>
      Aggiornare il periodo per applicare le modifiche:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Riavviare Ceph Object Gateway nella zona recuperata:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart rgw@rgw</screen>
    </step>
    <step>
     <para>
      Se la configurazione della zona secondaria deve essere in sola lettura, aggiornare la zona secondaria:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --read-only</screen>
    </step>
    <step>
     <para>
      Aggiornare il periodo per applicare le modifiche:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Riavviare Ceph Object Gateway nella zona secondaria:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart@rgw</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
