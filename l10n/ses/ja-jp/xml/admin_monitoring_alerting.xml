<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_monitoring_alerting.xml" version="5.0" xml:id="monitoring-alerting">
 <title>監視とアラート</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storage 7では、cephadmが監視スタックとアラートスタックを展開します。ユーザはcephadmを使用して展開したいサービス(Prometheus、Alertmanager、Grafanaなど)をYAML設定ファイルで指定する必要がありますが、CLIを使用してサービスを展開することもできます。同じ種類のサービスが複数展開される場合は、高可用性セットアップが展開されます。ノードエクスポータはこのルールの例外です。
 </para>
 <para>
  cephadmを使用して以下の監視サービスを展開できます。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis role="bold"/>「Prometheus」は監視およびアラートツールキットです。このツールはPrometheusエクスポータからのデータを収集し、事前に定義されたしきい値に達した場合は事前に設定されたアラートを発します。
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold"/>「Alertmanager」はPrometheusサーバによって送信されるアラートを処理します。このツールはアラートの重複排除、グループ化、ルーティングを行って適切な受信者に届けます。デフォルトでは、自動的にCephダッシュボードが受信者に設定されます。
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold"/>「Grafana」は視覚化およびアラートソフトウェアです。この監視スタックではGrafanaのアラート機能を使用しません。そのかわり、アラートにはAlertmanagerを使用します。
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold"/>「ノードエクスポータ」はPrometheus用エクスポータで、インストールしたノードに関するデータを提供します。すべてのノードにノードエクスポータをインストールすることをお勧めします。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Prometheus Manager ModuleはPrometheusエクスポータを提供し、<literal>ceph-mgr</literal>収集ポイントのCephパフォーマンスカウンタを伝達します。
 </para>
 <para>
  <emphasis/>「スクレイピング」対象(メトリクスを提供するデーモン)などの、Prometheus設定はcephadmが自動的に設定します。cephadmはデフォルトアラートのリストも展開します。たとえば、<literal>health error</literal>、<literal>10% OSDs down</literal>、<literal>pgs inactive</literal>などです。
 </para>
 <para>
  デフォルトでは、GrafanaへのトラフィックはTLSで暗号化されます。ユーザは手持ちのTLS証明書を支給するか、自己署名証明書を利用できます。Grafanaが展開される前にカスタム証明書を設定していない場合は、自動的に自己署名証明書が作成され、Grafana用に設定されます。
 </para>
 <para>
  Grafana用のカスタム証明書は、以下のコマンドを使用して設定できます。
 </para>
<screen>
<prompt>cephuser@adm &gt; </prompt> ceph config-key set mgr/cephadm/grafana_key -i $PWD/key.pem
<prompt>cephuser@adm &gt; </prompt> ceph config-key set mgr/cephadm/grafana_crt -i $PWD/certificate.pem
  </screen>
 <para>
  AlertmanagerはPrometheusサーバによって送信されるアラートを処理します。重複排除、グループ化、正しいレシーバへのルーティングを行います。アラートはAlertmanagerを用いて停止できますが、Cephダッシュボードからも管理できます。
 </para>
 <para>
  すべてのノードに<systemitem class="daemon">ノードエクスポータ</systemitem>を展開することをお勧めします。展開には<literal>node-exporter</literal>サービスタイプを記載した<filename>monitoring.yaml</filename>ファイルを使用できます。サービスの展開の詳細については、<xref linkend="deploy-cephadm-day2-service-monitoring"/>を参照してください。
 </para>
 <sect1 xml:id="monitoring-custom-images">
  <title>カスタムイメージまたはローカルイメージの設定</title>

  <tip>
   <para>
    このセクションでは、サービスの展開やアップグレードを行う際に使用するコンテナイメージの設定を変更する方法を説明します。サービスの展開または再展開に必要なコマンドは含まれません。
   </para>
   <para>
    監視スタックを展開する方法としては、<xref linkend="deploy-cephadm-day2-service-monitoring"/>に記載されているような、監視スタックの仕様を適用する方法をお勧めします。
   </para>
  </tip>

  <para>
   カスタムイメージまたはローカルコンテナイメージを展開するには、イメージをcephadmに設定しなければなりません。そのためには、次のコマンドを実行する必要があります。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/cephadm/<replaceable>OPTION_NAME</replaceable> <replaceable>VALUE</replaceable></screen>

  <para>
   <replaceable>OPTION_NAME</replaceable>には、次のいずれかの名前が入ります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     container_image_prometheus
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_node_exporter
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_alertmanager
    </para>
   </listitem>
   <listitem>
    <para>
     container_image_grafana
    </para>
   </listitem>
  </itemizedlist>

  <para>
   オプションが設定されていないか、設定が削除されている場合は、以下のイメージを<replaceable>VALUE</replaceable>として使用します。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     registry.suse.com/caasp/v4.5/prometheus-server:2.18.0
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/caasp/v4.5/prometheus-node-exporter:0.18.1
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/caasp/v4.5/prometheus-alertmanager:0.16.2
    </para>
   </listitem>
   <listitem>
    <para>
     registry.suse.com/ses/7/ceph/grafana:7.0.3
    </para>
   </listitem>
  </itemizedlist>

  <para>
   以下に例を示します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/cephadm/container_image_prometheus prom/prometheus:v1.4.1</screen>

  <note>
   <para>
    カスタムイメージを設定すると、デフォルトの値は無視されます(ただし、上書きはされません)。デフォルトの値はアップデートが利用可能になった際に変更されます。カスタムイメージを設定すると、カスタムイメージを設定したコンポーネントの自動アップデートができなくなります。アップデートをインストール可能にするには、手動で設定(イメージ名とタグ)をアップデートする必要があります。
   </para>
   <para>
    推奨設定を使用することを選択する場合、以前に設定したカスタムイメージをリセットすることができます。リセット後は再びデフォルト値が使用されます。設定オプションをリセットするには、<command>ceph config rm</command>を使用してください。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config rm mgr mgr/cephadm/<replaceable>OPTION_NAME</replaceable></screen>
   <para>
    以下に例を示します。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config rm mgr mgr/cephadm/container_image_prometheus</screen>
  </note>
 </sect1>
 <sect1 xml:id="monitoring-applying-updates">
  <title>監視サービスのアップデート</title>

  <para>
   <xref linkend="monitoring-custom-images"/>で述べたように、cephadmは推奨されるテスト済みのコンテナイメージのURLが設定された状態で提供されます。これらのイメージはデフォルト値として使用されています。
  </para>

  <para>
   Cephパッケージをアップデートすると、これらのURLの新しいバージョンが提供される場合があります。この場合、コンテナイメージの取得元がアップデートされるだけで、サービスはアップデートされません。
  </para>

  <para>
   <xref linkend="monitoring-custom-images"/>で述べた手動によるアップデート、またはCephパッケージのアップデートにともなう自動アップデートによって、コンテナイメージのURLが最新版にアップデートされると、監視サービスをアップデートできるようになります。
  </para>

  <para>
   監視サービスのアップデートには<command>ceph orch redeploy</command>を使用します。以下に例を示します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch redeploy node-exporter
<prompt>cephuser@adm &gt; </prompt>ceph orch redeploy prometheus
<prompt>cephuser@adm &gt; </prompt>ceph orch redeploy alertmanager
<prompt>cephuser@adm &gt; </prompt>ceph orch redeploy grafana
</screen>

  <para>
   今のところ、1つのコマンドで存在するすべての監視サービスをアップデートすることはできません。監視サービスをアップデートする順番は重要ではありません。
  </para>

  <note>
   <para>
    カスタムコンテナイメージを使用している場合、Cephパッケージがアップデートされても監視サービス用のURLは自動的には変更されません。カスタムコンテナイメージを指定している場合は、手動で新しいコンテナイメージのURLを指定する必要があります。たとえば、ローカルコンテナレジストリを使用する場合に、このようなケースが生じます。
   </para>
   <para>
    使用をお勧めするコンテナイメージのURLについては、<xref linkend="monitoring-custom-images"/>セクションを参照してください。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="monitoring-stack-disable">
  <title>監視の無効化</title>

  <para>
   監視スタックを無効化するには、次のコマンドを実行します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch rm grafana
<prompt>cephuser@adm &gt; </prompt>ceph orch rm prometheus --force   # this will delete metrics data collected so far
<prompt>cephuser@adm &gt; </prompt>ceph orch rm node-exporter
<prompt>cephuser@adm &gt; </prompt>ceph orch rm alertmanager
<prompt>cephuser@adm &gt; </prompt>ceph mgr module disable prometheus
      </screen>
 </sect1>
 <sect1 xml:id="monitoring-grafana-config">
  <title>Grafanaの設定</title>

  <para>
   CephダッシュボードのバックエンドはGrafana URLを必要とします。これは、フロントエンドがGrafanaダッシュボードの有無を確認してからロードできるようにするためです。CephダッシュボードにGrafanaを実装している方法の性質から、CephダッシュボードでGrafanaのグラフを確認できるようにするには、2つの作業を結びつける必要があります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     バックエンド(Ceph MGRモジュール)は要求されたグラフの存在を確認する必要があります。この要求が正常に完了した場合、バックエンドはフロントエンドに対してGrafanaに安全にアクセスできることを通知します。
    </para>
   </listitem>
   <listitem>
    <para>
     その後、フロントエンドは<literal>iframe</literal>を使用してユーザのブラウザから直接Grafanaのグラフを要求します。Cephダッシュボードを通じて、迂回することなくGrafanaのインスタンスに直接アクセスします。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   お客様の環境によっては、ユーザのブラウザがCephダッシュボードで設定したURLに直接アクセスすることが難しい場合もあります。対策としては、フロントエンド(ユーザのブラウザ)がGrafanaへのアクセスに使うべきURLを伝えるためだけに使用する、別のURLを設定する方法があります。
  </para>

  <para>
   フロントエンドに返答するためのURLを変更するには、次のコマンドを実行します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard set-grafana-frontend-api-url <replaceable>GRAFANA-SERVER-URL</replaceable></screen>

  <para>
   コマンド中でオプションの値を指定していない場合は、<replaceable>GRAFANA_API_URL</replaceable>オプションの値が利用されます。この値は、cephadmのアップデートにより自動的かつ定期的に設定されます。オプションの値を指定した場合は、ブラウザが指定したURLを使ってGrafanaにアクセスするように設定されます。
  </para>
 </sect1>
 <sect1 xml:id="monitoring-cephadm-config">
  <title>Prometheus Manager Moduleの設定</title>

  <para>
   Prometheus Manager ModuleはCephの内部モジュールの1つで、Cephの機能を拡張します。このモジュールはCephから(メタ)データを読み込み、Cpehの状態やヘルスに関する情報を取得します。そして、Prometheusが利用できるフォーマットで(スクレイピングされた)データを提供します。
  </para>

  <note>
   <para>
    設定変更を適用するには、Prometheus Manager Moduleを再起動する必要があります。
   </para>
  </note>

  <sect2 xml:id="monitoring-http-requests">
   <title>ネットワークインタフェースの設定</title>
   <para>
    デフォルトでは、Prometheus Manager ModuleはIPv4およびIPv6の全アドレスからのHTTPリクエストをホストのポート9283番で受け付けます。ポートとリッスンアドレスは<option>ceph config-key set</option>で<option>mgr/prometheus/server_addr</option>キーと<option>mgr/prometheus/server_port</option>キーを使用して設定可能です。このポートはPrometheusのレジストリに登録されます。
   </para>
   <para>
    <literal>server_addr</literal>をアップデートするには、次のコマンドを実行します。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/server_addr <replaceable>0.0.0.0</replaceable>
      </screen>
   <para>
    <literal>server_port</literal>をアップデートするには、次のコマンドを実行します。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/server_port <replaceable>9283</replaceable>
      </screen>
  </sect2>

  <sect2 xml:id="monitoring-scrape-intervals">
   <title><literal>scrape_interval</literal>の設定</title>
   <para>
    デフォルトでは、Prometheus Manager Moduleのスクレイピング間隔は15秒に設定されています。スクレイピング間隔を10秒未満にすることはお勧めしません。Prometheusモジュールに別のスクレイピング間隔を設定するには、<literal>scrape_interval</literal>を希望する値に設定してください。
   </para>
   <important>
    <para>
     正常な動作と不具合の防止のため、このモジュールの<literal>scrape_interval</literal>とPrometheusのスクレイピング間隔は常に一致するように設定する必要があります。
    </para>
   </important>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/scrape_interval <replaceable>15</replaceable>
      </screen>
  </sect2>

  <sect2 xml:id="monitoring-stale-cache">
   <title>キャッシュの設定</title>
   <para>
    大規模なクラスタ(OSDが1000を超えるクラスタ)では、メトリクスの取得にかかる時間が重要になる場合があります。キャッシュを使用しないと、Prometheus Manager Moduleがマネージャを過負荷状態に陥らせ、Ceph Managerインスタンスが応答しなくなったり、クラッシュするおそれがあります。そのため、キャッシュ機能はデフォルトで有効に設定してあり、無効にできません。しかしその結果、キャッシュが古くなる可能性があります。Cephからのメトリクスの取得にかかる時間が<literal>scrape_interval</literal>の設定を超えると、キャッシュは古くなったと見なされます。
   </para>
   <para>
    この場合、警告が記録されるとともに、モジュールが次のいずれかの動作をします。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      HTTPステータスコード503(service unavailable)を返します。
     </para>
    </listitem>
    <listitem>
     <para>
      キャッシュが古くなっている可能性を承知の上で、キャッシュのコンテンツを返します。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    この動作は、<command>ceph config set</command>コマンドにより設定できます。
   </para>
   <para>
    古くなっている可能性のあるデータを返すことをモジュールに指示するには、<literal>return</literal>に設定してください。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/stale_cache_strategy return</screen>
   <para>
    <literal>service unavailable</literal>を返すことをモジュールに指示するには、<literal>fail</literal>に設定してください。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/stale_cache_strategy fail</screen>
  </sect2>

  <sect2 xml:id="monitoring-rbd-image">
   <title>RBDイメージ監視の有効化</title>
   <para>
    必要に応じて、Prometheus Manager ModuleはRBDイメージごとのIO統計状態を収集できます。そのためには、動的OSDパフォーマンスカウンタを有効化します。<literal>mgr/prometheus/rbd_stats_pools</literal>設定パラメータで指定したプールのすべてのイメージについて、統計情報が収集されます。
   </para>
   <para>
    パラメータは<literal>pool[/namespace]</literal>エントリのカンマかスペースで区切ったリストです。namespaceを指定しない場合は、プールのすべてのネームスペースについて統計情報が収集されます。
   </para>
   <para>
    以下に例を示します。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/rbd_stats_pools "<replaceable>pool1,pool2,poolN</replaceable>"
      </screen>
   <para>
    モジュールは指定されたプールとネームスペースをスキャンして、利用可能なイメージのリストを作成します。さらに、モジュールはリストを定期的に更新します。更新間隔は<literal>mgr/prometheus/rbd_stats_pools_refresh_interval</literal>パラメータにより設定可能です(秒単位)。デフォルト値は300秒(5分)です。
   </para>
   <para>
    たとえば、同期間隔を10分に変更するには次のコマンドを実行します。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/prometheus/rbd_stats_pools_refresh_interval <replaceable>600</replaceable>
      </screen>
  </sect2>
 </sect1>
 <sect1 xml:id="prometheus-security-model">
  <title>Prometheusのセキュリティモデル</title>

  <para>
   Prometheusのセキュリティモデルは、信頼されていないユーザがPrometheus HTTPのエンドポイントとログにアクセスできる場合を仮定しています。この条件では、信頼されていないユーザが、データベースに格納されているPrometheusが収集したすべての(メタ)データや、さまざまな運用情報とデバッグ情報にアクセスできます。
  </para>

  <para>
   しかし、PrometheusのHTTP APIは読み込み専用の動作しかできないように制限されています。APIにより設定を変更することはできないため、機密情報は持ち出せません。さらに、PrometheusにはDoS攻撃(Denial-of-Service Attack)の被害を軽減するための対策が組み込まれています。
  </para>
 </sect1>
 <sect1 xml:id="prometheus-webhook-snmp">
  <title>Prometheus Alertmanager SNMPウェブフック</title>

  <para>
   SNMPトラップを使用してPrometheusアラートに関する通知を受け取りたい場合は、cephadmを使用してPrometheus Alertmanager SNMPウェブフックをインストールできます。そのためには、以下の内容を含むサービス仕様と配置仕様を記載するファイルを作成する必要があります。
  </para>

  <note>
   <para>
    サービス仕様と配置仕様を記載するファイルの詳細については、<xref linkend="cephadm-service-and-placement-specs"/>を参照してください。
   </para>
  </note>

<screen>
service_type: container
service_id: prometheus-webhook-snmp
placement:
    <replaceable>ADD_PLACEMENT_HERE</replaceable>
image: registry.suse.com/ses/7/prometheus-webhook-snmp:latest
args:
    - "--publish 9099:9099"
envs:
    - ARGS="--debug --snmp-host=<replaceable>ADD_HOST_GATEWAY_HERE</replaceable>"
    - RUN_ARGS="--metrics"
EOF
</screen>

  <para>
   サービスをデフォルト設定で動作させるには、上記のサービス仕様を使用してください。
  </para>

  <para>
   Prometheus受信者がリスンするポートを公開する必要があります。そのためには、サービスの実行中にコマンドライン引数<literal>--publish <replaceable>HOST_PORT</replaceable>:<replaceable>CONTAINER_PORT</replaceable></literal>を使用します。これは、コンテナがポートを自動的には公開しないためです。仕様に以下の行を追加する方法でも、ポートを公開できます。
  </para>

<screen>
args:
    - "--publish 9099:9099"
</screen>

  <para>
   あるいは、コマンドライン引数<literal>--network=host</literal>を使用して、ホストネットワークにコンテナを接続する方法もあります。
  </para>

<screen>
args:
    - "--network=host"
</screen>

  <para>
   SNMPトラップ受信者がコンテナと同じホストにインストールされていない場合、SNMPホストのFQDNも指定する必要があります。container/hostの外部からSNMPトラップを受信できるように、コンテナのネットワークゲートウェイを使用してください。
  </para>

<screen>
envs:
    - ARGS="--debug --snmp-host=<replaceable>CONTAINER_GATEWAY</replaceable>"
</screen>

  <sect2 xml:id="configure-prometheus-webhook-snmp">
   <title><literal>prometheus-webhook-snmp</literal>サービスの設定</title>
   <para>
    コンテナは環境変数または設定ファイルを用いて設定できます。
   </para>
   <para>
    環境変数を使用する場合は、<literal>ARGS</literal>によりグローバルオプションを設定し、<literal>RUN_ARGS</literal>により<command>run</command>コマンドのオプションを指定します。サービス仕様は以下のように編集する必要があります。
   </para>
<screen>
envs:
    - ARGS="--debug --snmp-host=<replaceable>CONTAINER_GATEWAY</replaceable>"
    - RUN_ARGS="--metrics --port=9101"
</screen>
   <para>
    設定ファイルを使用する場合、サービス仕様を以下のように編集する必要があります。
   </para>
<screen>
files:
    etc/prometheus-webhook-snmp.conf:
        - "debug: True"
        - "snmp_host: <replaceable>ADD_HOST_GATEWAY_HERE</replaceable>"
        - "metrics: True"
volume_mounts:
    etc/prometheus-webhook-snmp.conf: /etc/prometheus-webhook-snmp.conf
</screen>
   <para>
    展開には次のコマンドを実行します。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>SERVICE_SPEC_FILE</replaceable></screen>
   <para>
    詳細については、<xref linkend="deploy-cephadm-day2-services"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="configure-prometheus-alertmanager-for-snmp">
   <title>Prometheus AlertmanagerのSNMP用設定</title>
   <para>
    最後に、Prometheus AlertmanagerをSNMPトラップ用に設定する必要があります。このサービスをまだ展開していない場合は、サービス仕様ファイルを作成してください。Prometheus Alertmanager SNMPウェブフックがインストールされているホストのIPアドレスかFQDNで<literal>IP_OR_FQDN</literal>を置き換える必要があります。以下に例を示します。
   </para>
   <note>
    <para>
     すでにこのサービスを展開している場合は、AlertmanagerがSNMP用に正しくセットアップされていることを確認し、以下の設定で再展開してください。
    </para>
   </note>
<screen>
  service_type: alertmanager
  placement:
    hosts:
    - <replaceable>HOSTNAME</replaceable>
  webhook_configs:
    - 'http://<replaceable>IP_OR_FQDN</replaceable>:9099/'
</screen>
   <para>
    次のコマンドを実行して、サービス仕様を適用します。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>SERVICE_SPEC_FILE</replaceable></screen>
  </sect2>
 </sect1>
</chapter>
