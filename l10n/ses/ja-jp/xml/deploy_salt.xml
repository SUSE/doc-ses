<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deploy_salt.xml" version="5.0" xml:id="deploy-salt">
 <info>
  <title>Saltの展開</title>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storageは最初のクラスタの準備にSaltと<systemitem class="resource">ceph-salt</systemitem>を使用します。Saltを使用すると、「Salt Master」<emphasis></emphasis>と呼ばれる単独の専用ホストから複数のクラスタノードに対して、同時に設定やコマンドを実行できます。Saltの展開前に、次の重要な点を考慮してください。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis></emphasis>「Salt Minion」は、Salt Masterと呼ばれる専用のノードによって制御されるノードです。
   </para>
  </listitem>
  <listitem>
   <para>
    仮にSalt MasterホストがCephクラスタの一部である場合は、独自のSalt Minionを実行する必要があります。ただしこれは必須ではありません。
   </para>
   <tip>
    <title>1つのサーバで複数の役割を共有</title>
    <para>
     各役割を別個のノードに展開すると、Cephクラスタで最適なパフォーマンスを実現できます。しかし、実際の展開では、1つのノードを複数の役割のために共有しなければならない場合があります。パフォーマンスやアップグレード手順で問題が起きないようにするため、Ceph OSD、メタデータサーバ、またはCeph Monitorの役割は管理ノードに展開しないでください。
    </para>
   </tip>
  </listitem>
  <listitem>
   <para>
    Salt Minionは、ネットワークでSalt Masterのホスト名を正しく解決する必要があります。Minionは、デフォルトでは<systemitem>salt</systemitem>saltというホスト名を検索しますが、ネットワーク経由でアクセス可能なほかのホスト名を<filename>/etc/salt/minion</filename>ファイルで指定できます。
   </para>
  </listitem>
 </itemizedlist>
 <procedure>
  <step>
   <para>
    Salt Masterノードに<literal>salt-master</literal>をインストールします。
   </para>
<screen><prompt>root@master # </prompt>zypper in salt-master</screen>
  </step>
  <step>
   <para>
    <systemitem>salt-master</systemitem>サービスが有効になっていて起動していることを確認します。必要であれば、サービスを有効にして起動します。
   </para>
<screen><prompt>root@master # </prompt>systemctl enable salt-master.service
<prompt>root@master # </prompt>systemctl start salt-master.service</screen>
  </step>
  <step>
   <para>
    ファイアウォールを使用する場合は、Salt Masterノードのポート4505と4506がすべてのSalt Minionノードに対して開いていることを確認します。これらのポートが閉じている場合は、<command>yast2 firewall</command>コマンドを使用してポートを開き、<guimenu>salt-master</guimenu>サービスに適切なゾーンを許可できます。たとえば、<literal>public</literal>を許可します。
   </para>
  </step>
  <step>
   <para>
    パッケージ<literal>salt-minion</literal>をすべてのミニオンノードにインストールします。
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper in salt-minion</screen>
  </step>
  <step>
   <para>
    <filename>/etc/salt/minion</filename>を編集し、次の行のコメントを解除します。
   </para>
<screen>#log_level_logfile: warning</screen>
   <para>
    <literal>warning</literal>ログレベルを<literal>info</literal>に変更します。
   </para>
   <note>
    <title><option>log_level_logfile</option>と<option>log_level</option></title>
    <para>
     <option>log_level</option>は、どのログメッセージが画面に表示されるかを制御します。一方、<option>log_level_logfile</option>は、どのログメッセージが<filename>/var/log/salt/minion</filename>に書き込まれるかを制御します。
    </para>
   </note>
   <note>
    <para>
     「すべて」の<emphasis></emphasis>クラスタ(ミニオン)ノードのログレベルを変更したか確認してください。
    </para>
   </note>
  </step>
  <step>
   <para>
    すべてのノードが他のノードの「完全修飾ドメイン名」<emphasis></emphasis>をパブリッククラスタネットワークのIPアドレスに解決できることを確認します。
   </para>
  </step>
  <step>
   <para>
    すべてのミニオンをマスターに接続するように設定します。ホスト名<literal>salt</literal>でSalt Masterに接続できない場合は、ファイル<filename>/etc/salt/minion</filename>を編集するか、次の内容で新しいファイル<filename>/etc/salt/minion.d/master.conf</filename>を作成します。
   </para>
<screen>master: <replaceable>host_name_of_salt_master</replaceable></screen>
   <para>
    先に説明した設定ファイルを変更した場合は、すべての関連するSalt MinionのSaltサービスを再起動します。
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart salt-minion.service</screen>
  </step>
  <step>
   <para>
    すべてのノードで<systemitem>salt-minion</systemitem>サービスが有効になっていて起動していることを確認します。必要であれば、次のコマンドを使用して有効にして起動します。
   </para>
<screen><prompt role="root"># </prompt>systemctl enable salt-minion.service
<prompt role="root"># </prompt>systemctl start salt-minion.service</screen>
  </step>
  <step>
   <para>
    各Salt Minionの指紋を確認して、指紋が一致する場合、Salt Master上のすべてのSaltキーを受諾します。
   </para>
   <note>
    <para>
     Salt Minionの指紋が空に戻る場合は、Salt MinionがSalt Masterの設定を持っていて、Salt Masterと通信できることを確認します。
    </para>
   </note>
   <para>
    各ミニオンの指紋を表示します。
   </para>
<screen><prompt>root@minion &gt; </prompt>salt-call --local key.finger
local:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    すべてのSalt Minionの指紋を収集した後、Salt Master上の、受諾されていない全ミニオンキーの指紋を一覧にします。
   </para>
<screen><prompt>root@master # </prompt>salt-key -F
[...]
Unaccepted Keys:
minion1:
3f:a3:2f:3f:b4:d3:d9:24:49:ca:6b:2c:e1:6c:3f:c3:83:37:f0:aa:87:42:e8:ff...</screen>
   <para>
    ミニオンの指紋が一致する場合は、それらを受諾します。
   </para>
<screen><prompt>root@master # </prompt>salt-key --accept-all</screen>
  </step>
  <step>
   <para>
    キーが受諾されたことを確認します。
   </para>
<screen><prompt>root@master # </prompt>salt-key --list-all</screen>
  </step>
  <step>
   <para>
    すべてのSalt Minionが応答するかテストします。
   </para>
<screen><prompt>root@master # </prompt>salt-run manage.status</screen>
  </step>
 </procedure>
</chapter>
