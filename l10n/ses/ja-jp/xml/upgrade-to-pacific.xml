<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="upgrade-to-pacific.xml" version="5.0" xml:id="upgrade-to-pacific">
 <title>SUSE Enterprise Storage 7から7.1へのアップグレード</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  この章では、SUSE Enterprise Storage 7をバージョン7.1にアップグレードする手順について説明します。
 </para>
 <para>
  アップグレードには次のタスクが含まれます。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    基礎となるSUSE Linux Enterprise Server SUSE Linux Enterprise Server 15 SP2からバージョンSUSE Linux Enterprise Server 15 SP3へのアップグレード。
   </para>
  </listitem>
  <listitem>
   <para>
    Ceph OctopusからPacificへのアップグレード。
   </para>
  </listitem>
 </itemizedlist>
 <sect1 xml:id="before-upgrade-7p">
  <title>アップグレード実行前の確認事項</title>

  <para>
   アップグレードの開始前に、必ず以下のタスクを完了させてください。<emphasis></emphasis>このタスクはSUSE Enterprise Storage 7のライフタイムのどの時点でも実行できます。
  </para>

  <sect2 xml:id="upgrade-consider-points-7p">
   <title>考慮すべきポイント</title>
   <para>
    アップグレードの前に以下のセクションを熟読して、実行する必要があるすべてのタスクを十分に理解してください。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <emphasis>リリースノートの確認</emphasis>.リリースノートには、旧リリースのSUSE Enterprise Storageからの変更点に関する追加情報が記載されています。リリースノートを参照して以下を確認します。
     </para>
     <itemizedlist>
      <listitem>
       <para>
        使用しているハードウェアに特別な配慮が必要かどうか
       </para>
      </listitem>
      <listitem>
       <para>
        使用しているソフトウェアパッケージに大幅な変更があるかどうか
       </para>
      </listitem>
      <listitem>
       <para>
        インストールのために特別な注意が必要かどうか
       </para>
      </listitem>
     </itemizedlist>
     <para>
      リリースノートには、マニュアルに記載できなかった情報が記載されています。また、既知の問題に関する注意も記載されています。
     </para>
     <para>
      SES 7.1のリリースノートは<link xlink:href="https://www.suse.com/releasenotes/"/>を参照してください。
     </para>
     <para>
      パッケージ<package>release-notes-ses</package>をSES 7.1リポジトリからインストールすると、ローカルディレクトリ<filename>/usr/share/doc/release-notes</filename>にリリースノートが置かれます。<link xlink:href="https://www.suse.com/releasenotes/"/>にあるオンラインのリリースノートも利用できます。
     </para>
    </listitem>
    <listitem>
     <para>
      <xref linkend="ses-deployment"/>を参照して、<systemitem class="resource">ceph-salt</systemitem>とCephオーケストレータについて理解してください。特に、サービス仕様に記載されている情報は重要です。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="upgrade-backup-config-data-7p">
   <title>クラスタ設定とデータのバックアップ</title>
   <para>
    アップグレードを開始する前に、すべてのクラスタ設定とデータをバックアップすることを強くお勧めします。すべてのデータをバックアップする方法については、<xref linkend="cha-deployment-backup"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="verify-previous-upgrade-patch-repos-7p">
   <title>ソフトウェアリポジトリとコンテナイメージへのアクセス確認</title>
   <para>
    各クラスタノードがSUSE Linux Enterprise Server 15 SP3とSUSE Enterprise Storage 7.1のソフトウェアリポジトリとコンテナイメージのリポジトリにアクセスできることを確認してください。
   </para>
   <sect3 xml:id="verify-previous-upgrade-patch-repos-repos-7p">
    <title>ソフトウェアリポジトリ</title>
    <para>
     すべてのノードがSCCに登録されている場合、<command>zypper migration</command>コマンドによるアップグレードが可能です。詳細については、<link xlink:href="https://documentation.suse.com/sles/15-SP3/html/SLES-all/cha-upgrade-online.html#sec-upgrade-online-zypper"/>を参照してください。
    </para>
    <para>
     ノードがSCCに登録されていない<emphasis role="bold"></emphasis>場合は、すべての既存のソフトウェアリポジトリを無効化し、次に示す各エクステンションに<literal>Pool</literal>リポジトリと<literal>Updates</literal>リポジトリの両方を追加してください。
    </para>
    <itemizedlist>
     <listitem>
      <para>
       SLE-Product-SLES/15-SP3
      </para>
     </listitem>
     <listitem>
      <para>
       SLE-Module-Basesystem/15-SP3
      </para>
     </listitem>
     <listitem>
      <para>
       SLE-Module-Server-Applications/15-SP3
      </para>
     </listitem>
     <listitem>
      <para>
       SUSE-Enterprise-Storage-7.1
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
   <sect3 xml:id="verify-previous-upgrade-patch-repos-images-7p">
    <title>コンテナイメージ</title>
    <para>
     すべてのクラスタノードはコンテナイメージのレジストリにアクセスできる必要があります。多くの場合、<literal>registry.suse.com</literal>のパブリックSUSEレジストリを使用します。必要なイメージは次のとおりです。
    </para>
    <itemizedlist>
     <listitem>
      <para>
       registry.suse.com/ses/7.1/ceph/ceph
      </para>
     </listitem>
     <listitem>
      <para>
       registry.suse.com/ses/7.1/ceph/grafana
      </para>
     </listitem>
     <listitem>
      <para>
       registry.suse.com/ses/7.1/ceph/prometheus-server
      </para>
     </listitem>
     <listitem>
      <para>
       registry.suse.com/ses/7.1/ceph/prometheus-node-exporter
      </para>
     </listitem>
     <listitem>
      <para>
       registry.suse.com/ses/7.1/ceph/prometheus-alertmanager
      </para>
     </listitem>
    </itemizedlist>
    <para>
     もしくは、たとえばエアギャップ環境で展開したい場合などは、ローカルレジストリを設定し、正常なコンテナイメージのセットが利用できることを確認してください。ローカルなコンテナイメージのレジストリを設定する方法の詳細については、<xref linkend="deploy-cephadm-configure-registry"/>を参照してください。
    </para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="upgrade-cluster-nodes">
  <title>各クラスタノードのSUSE Linux Enterprise ServerをバージョンSUSE Linux Enterprise Server 15 SP3に移行</title>

  <para>
   クラスタノードがSUSE Customer Centerを使用するように設定されている場合は、<command>zypper migration</command>コマンドを使用できます。
  </para>

  <para>
   クラスタノードにソフトウェアリポジトリが手動で設定されている場合は、ノードを手動でアップグレードする必要があります。
  </para>

  <para>
   <command>zypper</command>を使用したSUSE Linux Enterprise Serverのアップグレードの詳細については、<link xlink:href="https://documentation.suse.com/sles/15-SP3/html/SLES-all/cha-upgrade-online.html#sec-upgrade-online-zypper"/>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="upgrade-ses-packages">
  <title>各クラスタノードでSUSE Enterprise Storage関連のパッケージを更新する</title>

  <para>
   SUSE Enterprise Storageパッケージを最新バージョンに更新するには、<command>ceph-salt update</command>コマンドを使用します。詳細については、<xref linkend="cephadm-rolling-updates"/>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="upgrade-ses-services">
  <title>既存のCephクラスタサービスのアップグレード</title>

  <para>
   管理ノードから次のコマンドを実行して、Cephクラスタ全体をバージョンPacificにアップグレードします。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch upgrade start --image registry.suse.com/ses/7.1/ceph/ceph</screen>
 </sect1>
</chapter>
