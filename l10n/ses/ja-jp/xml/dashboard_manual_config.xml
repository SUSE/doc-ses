<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="dashboard_manual_config.xml" version="5.0" xml:id="dashboard-initial-configuration">
 <title>手動設定</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  このセクションでは、コマンドラインでダッシュボードを手動で設定したいユーザ向けの詳細情報を紹介します。
 </para>
 <sect1 xml:id="dashboard-ssl">
  <title>TLS/SSLサポートの設定</title>

  <para>
   ダッシュボードとのすべてのHTTP接続は、デフォルトでTLS/SSLによって保護されています。セキュア接続にはSSL証明書が必要です。自己署名証明書を使用することも、証明書を生成して既知のCA (認証局)で署名することもできます。
  </para>

  <tip>
   <title>SSLの無効化</title>
   <para>
    特定の理由がある場合、SSLのサポートを無効にできます。たとえば、SSLをサポートしないプロキシの後方でダッシュボードを実行する場合などです。
   </para>
   <para>
    SSLを無効にする場合は注意してください。「ユーザ名とパスワード」<emphasis role="bold"/>は「暗号化されずに」<emphasis role="bold"/>ダッシュボードに送信されます。
   </para>
   <para>
    SSLを無効にするには、次のコマンドを実行します。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/ssl false
</screen>
  </tip>

  <tip>
   <title>Ceph Managerプロセスの再起動</title>
   <para>
    SSL証明書とキーを変更した後で、Ceph Managerプロセスを手動で再起動する必要があります。このためには、次のコマンドを実行します。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr fail <replaceable>ACTIVE-MANAGER-NAME</replaceable></screen>
   <para>
    または、ダッシュボードモジュールを無効化して再度有効化することもできます。この場合、マネージャが自身を再起動します。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph mgr module disable dashboard
<prompt>cephuser@adm &gt; </prompt>ceph mgr module enable dashboard
</screen>
  </tip>

  <sect2 xml:id="self-sign-certificates">
   <title>自己署名証明書の作成</title>
   <para>
    セキュア通信用の自己署名証明書の作成は簡単です。これにより、ダッシュボードの実行を高速化できます。
   </para>
   <note>
    <title>Webブラウザの警告</title>
    <para>
     ほとんどのWebブラウザでは、自己署名証明書を使用すると警告が表示され、ダッシュボードへのセキュアな接続を確立するには明示的に確認する必要があります。
    </para>
   </note>
   <para>
    自己署名証明書を生成してインストールするには、次の組み込みコマンドを使用します。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard create-self-signed-cert
</screen>
  </sect2>

  <sect2 xml:id="cert-sign-CA">
   <title>CA署名証明書の使用</title>
   <para>
    ダッシュボードへの接続を適切に保護し、Webブラウザで自己署名証明書に関する警告が表示されないようにするため、CAによって署名された証明書を使用することをお勧めします。
   </para>
   <para>
    次のようなコマンドを使用して証明書キーペアを生成できます。
   </para>
<screen>
<prompt role="root">root # </prompt>openssl req -new -nodes -x509 \
  -subj "/O=IT/CN=ceph-mgr-dashboard" -days 3650 \
  -keyout dashboard.key -out dashboard.crt -extensions v3_ca
</screen>
   <para>
    上のコマンドは、<filename>dashboard.key</filename>ファイルと<filename>dashboard.crt</filename>ファイルを出力します。<filename>dashboard.crt</filename>ファイルがCAによって署名されたら、次のコマンドを実行して、すべてのCeph Managerインスタンスに対してその証明書を有効にします。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config-key set mgr/dashboard/crt -i dashboard.crt
<prompt>cephuser@adm &gt; </prompt>ceph config-key set mgr/dashboard/key -i dashboard.key
</screen>
   <tip>
    <title>各マネージャインスタンスに対して異なる証明書が必要な場合</title>
    <para>
     Ceph Managerの各インスタンスに対して異なる証明書が必要な場合は、次のようにコマンドを変更してインスタンスの名前を含めます。<replaceable>NAME</replaceable>は、Ceph Managerインスタンスの名前(通常は関連するホスト名)で置き換えます。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config-key set mgr/dashboard/<replaceable>NAME</replaceable>/crt -i dashboard.crt
<prompt>cephuser@adm &gt; </prompt>ceph config-key set mgr/dashboard/<replaceable>NAME</replaceable>/key -i dashboard.key
</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="dashboard-hostname-port">
  <title>ホスト名とポート番号の変更</title>

  <para>
   Cephダッシュボードは特定のTCP/IPアドレスとTCPポートにバインドされます。デフォルトでは、ダッシュボードをホストする現在アクティブなCeph Managerは、TCPポート8443 (SSLが無効な場合は8080)にバインドされます。
  </para>

  <note>
   <para>
    Ceph Manager(および、Cephダッシュボード)を実行しているホストでファイアウォールが有効化されている場合、ポートにアクセスできるように設定変更が必要な場合があります。Ceph向けファイアウォール設定の詳細については、<xref linkend="storage-bp-net-firewall"/>を参照してください。
   </para>
  </note>

  <para>
   Cephダッシュボードは、デフォルトで「::」にバインドされます。これは、使用可能なすべてのIPv4およびIPv6アドレスに対応します。次のコマンドを使用すると、すべてのCeph Managerインスタンスに適用されるようにWebアプリケーションのIPアドレスとポート番号を変更できます。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/server_addr <replaceable>IP_ADDRESS</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/server_port <replaceable>PORT_NUMBER</replaceable>
</screen>

  <tip>
   <title>Ceph Managerインスタンスの個別の設定</title>
   <para>
    各<systemitem class="daemon">ceph-mgr</systemitem>デーモンは専用のダッシュボードインスタンスをホストするため、インスタンスを個別に設定しなければならない場合があります。次のコマンドを使用して、特定のマネージャインスタンスのIPアドレスとポート番号を変更します(<replaceable>NAME</replaceable>を<systemitem class="daemon">ceph-mgr</systemitem>のIDで置き換えます)。
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/<replaceable>NAME</replaceable>/server_addr <replaceable>IP_ADDRESS</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/dashboard/<replaceable>NAME</replaceable>/server_port <replaceable>PORT_NUMBER</replaceable>
</screen>
  </tip>

  <tip>
   <title>設定済みエンドポイントの一覧</title>
   <para>
    <command>ceph mgr services</command>コマンドは、現在設定されているすべてのエンドポイントを表示します。<literal>dashboard</literal>キーを検索して、ダッシュボードにアクセスするためのURLを取得します。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="dashboard-username-password">
  <title>ユーザ名とパスワードの調整</title>

  <para>
   デフォルトの管理者アカウントを使用しない場合は、別のユーザアカウントを作成して、それを少なくとも1つの役割に関連付けます。事前定義済みの一連のシステム役割が用意されており、これらの役割を使用できます。詳細については、<xref linkend="dashboard-user-roles"/>を参照してください。
  </para>

  <para>
   管理者特権を持つユーザを作成するには、次のコマンドを使用します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard ac-user-create <replaceable>USER_NAME</replaceable> <replaceable>PASSWORD</replaceable> administrator
</screen>
 </sect1>
 <sect1 xml:id="dashboard-ogw-enabling">
  <title>Object Gateway管理フロントエンドの有効化</title>

  <para>
   ダッシュボードのObject Gateway管理機能を使用するには、<option>system</option>フラグが有効なユーザのログインアカウント情報を指定する必要があります。
  </para>

  <procedure>
   <step>
    <para>
     <option>system</option>フラグが設定されたユーザがいない場合は、作成します。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USER_ID</replaceable> --display-name=<replaceable>DISPLAY_NAME</replaceable> --system
</screen>
    <para>
     コマンドが出力する<replaceable>access_key</replaceable>と<replaceable>secret_key</replaceable>を記録します。
    </para>
   </step>
   <step>
    <para>
     <command>radosgw-admin</command>コマンドを使用して、既存のユーザの資格情報を取得することもできます。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid=<replaceable>USER_ID</replaceable>
</screen>
   </step>
   <step>
    <para>
     受け取った資格情報をダッシュボードに提供します。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-access-key <replaceable>ACCESS_KEY</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-secret-key <replaceable>SECRET_KEY</replaceable>
</screen>
   </step>
  </procedure>

  <note>
   <para>
    SUSE Linux Enterprise Server 15 SP2では、デフォルトでファイアウォールが有効です。ファイアウォール設定の詳細については、<xref linkend="storage-bp-net-firewall"/>を参照してください。
   </para>
  </note>

  <para>
   考慮すべき点がいくつかあります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Object Gatewayのホスト名とポート番号は自動的に決定されます。
    </para>
   </listitem>
   <listitem>
    <para>
     複数のゾーンを使用している場合、マスタゾーングループとマスタゾーン内のホストは自動的に決定されます。ほとんどのセットアップではこれで十分ですが、状況によってはホスト名とポートを手動で設定したい場合があります。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-host <replaceable>HOST</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-port <replaceable>PORT</replaceable>
</screen>
   </listitem>
   <listitem>
    <para>
     次の追加設定が必要になる場合があります。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-scheme <replaceable>SCHEME</replaceable>  # http or https
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-admin-resource <replaceable>ADMIN_RESOURCE</replaceable>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-user-id <replaceable>USER_ID</replaceable>
</screen>
   </listitem>
   <listitem>
    <para>
     Object Gatewayのセットアップで自己署名証明書(<xref linkend="dashboard-ssl"/>)を使用している場合は、不明なCAによって署名された証明書、またはホスト名が一致しないことによって接続が拒否されないようにするため、ダッシュボードで証明書の検証を無効にします。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rgw-api-ssl-verify False
</screen>
   </listitem>
   <listitem>
    <para>
     Object Gatewayで要求の処理に時間がかかりすぎて、ダッシュボードがタイムアウトする場合は、タイムアウト値を調整できます(デフォルトは45秒)。
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard set-rest-requests-timeout <replaceable>SECONDS</replaceable>
</screen>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="dashboard-iscsi-management">
  <title>iSCSI管理の有効化</title>

  <para>
   Cephダッシュボードは、iSCSIターゲットを管理します。これには、Ceph iSCSIゲートウェイの<systemitem class="service">rbd-target-api</systemitem>サービスが提供するREST APIを使用します。REST APIがインストール済みで、iSCSIゲートウェイ上で有効化されていることを確認します。
  </para>

  <note>
   <para>
    CephダッシュボードのiSCSI管理機能は、<literal>ceph-iscsi</literal>プロジェクトの最新版であるバージョン3に依存しています。使用しているオペレーティングシステムが適切なバージョンであることを確認してください。さもなければ、CephダッシュボードはiSCSI管理機能を使用できません。
   </para>
  </note>

  <para>
   <literal>ceph-iscsi</literal> REST APIがHTTPSモードに設定されており、自己署名証明書を使用している場合、ceph-iscsi APIにアクセスした際のSSL証明書の検証を回避するようにダッシュボードを設定します。
  </para>

  <para>
   API SSL検証を無効化します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard set-iscsi-api-ssl-verification false</screen>

  <para>
   利用可能なiSCSIゲートウェイを定義します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-list
<prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-add <replaceable>scheme</replaceable>://<replaceable>username</replaceable>:<replaceable>password</replaceable>@<replaceable>host</replaceable>[:port]
<prompt>cephuser@adm &gt; </prompt>ceph dashboard iscsi-gateway-rm <replaceable>gateway_name</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="dashboard-sso">
  <title>Single Sign-Onを有効にする</title>

  <para>
   <emphasis/>SSO (「シングルサインオン」)は、ユーザが複数のアプリケーションに1つのIDとパスワードで同時にログインできるアクセス制御方法です。
  </para>

  <para>
   Cephダッシュボードは、SAML 2.0プロトコルを介したユーザの外部認証をサポートしています。<emphasis/>「権限付与」は引き続きダッシュボードによって実行されるため、まずユーザアカウントを作成し、それを目的の役割に関連付ける必要があります。ただし、<emphasis/>「認証」プロセスは、既存の<emphasis/>IdP (「Identity Provider」)によって実行できます。
  </para>

  <para>
   シングルサインオンを設定するには、次のコマンドを使用します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso setup saml2 <replaceable>CEPH_DASHBOARD_BASE_URL</replaceable> \
 <replaceable>IDP_METADATA</replaceable> <replaceable>IDP_USERNAME_ATTRIBUTE</replaceable> \
 <replaceable>IDP_ENTITY_ID</replaceable> <replaceable>SP_X_509_CERT</replaceable> \
 <replaceable>SP_PRIVATE_KEY</replaceable>
</screen>

  <para>
   パラメータは次の通りです。
  </para>

  <variablelist>
   <varlistentry>
    <term><replaceable>CEPH_DASHBOARD_BASE_URL</replaceable></term>
    <listitem>
     <para>
      Cephダッシュボードにアクセス可能なベースURL(たとえば、「https://cephdashboard.local」)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_METADATA</replaceable></term>
    <listitem>
     <para>
      IdPメタデータXMLのURL、ファイルパス、または内容(たとえば、「https://myidp/metadata」)。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_USERNAME_ATTRIBUTE</replaceable></term>
    <listitem>
     <para>
      オプション。認証応答からユーザ名を取得するために使用される属性。デフォルトは「uid」。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>IDP_ENTITY_ID</replaceable></term>
    <listitem>
     <para>
      オプション。IdPメタデータに複数のエンティティIDが存在する場合に使用します。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><replaceable>SP_X_509_CERT</replaceable> / <replaceable>SP_PRIVATE_KEY</replaceable></term>
    <listitem>
     <para>
      オプション。署名と暗号化のためにCephダッシュボード(サービスプロバイダ)によって使用される証明書のファイルパスまたは内容。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <note>
   <title>SAML要求</title>
   <para>
    SAML要求の発行者の値は次のパターンに従います。
   </para>
<screen>
<replaceable>CEPH_DASHBOARD_BASE_URL</replaceable>/auth/saml2/metadata
</screen>
  </note>

  <para>
   SAML 2.0の現在の設定を表示するには、次のコマンドを実行します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso show saml2
</screen>

  <para>
   シングルサインオンを無効にするには、次のコマンドを実行します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso disable
</screen>

  <para>
   SSOが有効かどうかを確認するには、次のコマンドを実行します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso status
</screen>

  <para>
   SSOを有効にするには、次のコマンドを実行します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph dashboard sso enable saml2
</screen>
 </sect1>
</chapter>
