<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="manager_modules.xml" version="5.0" xml:id="cha-mgr-modules">
 <title>Ceph Managerモジュール</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Ceph Managerのアーキテクチャ(概要については、<xref linkend="storage-intro-core-nodes"/>を参照)では、「ダッシュボード」(<xref linkend="part-dashboard"/>を参照)、「prometheus」(<xref linkend="monitoring-alerting"/>を参照)、「バランサ」などの「モジュール」によって機能を拡張できます。<emphasis/>
 </para>
 <para>
  使用可能なすべてのモジュールを一覧にするには、次のコマンドを実行します。
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module ls
{
        "enabled_modules": [
                "restful",
                "status"
        ],
        "disabled_modules": [
                "dashboard"
        ]
}</screen>
 <para>
  特定のモジュールを有効または無効にするには、次のコマンドを実行します。
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module enable <replaceable>MODULE-NAME</replaceable></screen>
 <para>
  以下に例を示します。
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module disable dashboard</screen>
 <para>
  有効なモジュールが提供するサービスを一覧にするには、次のコマンドを実行します。
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr services
{
        "dashboard": "http://myserver.com:7789/",
        "restful": "https://myserver.com:8789/"
}</screen>
 <sect1 xml:id="mgr-modules-balancer">
  <title>バランサ</title>

  <para>
   バランサモジュールは、OSD間でのPG (配置グループ)の分散を最適化して展開のバランスを確保します。このモジュールはデフォルトで有効になっていますが、非アクティブです。サポートされているモードは、<literal>crush-compat</literal>と<literal>upmap</literal>の2つです。
  </para>

  <tip>
   <title>バランサの現在のステータスと設定</title>
   <para>
    バランサの現在のステータスと設定に関する情報を表示するには、次のコマンドを実行します。
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer status</screen>
  </tip>

  <sect2 xml:id="mgr-balancer-crush-compat">
   <title>「crush-compat」モード</title>
   <para>
    「crush-compat」モードでは、バランサは、OSDのreweight-setsを調整して、データが適切に分散されるようにします。これは、OSDの間でPGを移動するので、PGの配置が正しくなくなり、一時的にクラスタ状態が<literal>HEALTH_WARN</literal>になります。
   </para>
   <tip>
    <title>モードのアクティベーション</title>
    <para>
     「crush-compat」はデフォルトのモードですが、SUSEでは、これを明示的に有効にすることをお勧めします。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer mode crush-compat</screen>
   </tip>
  </sect2>

  <sect2 xml:id="mgr-balancer-planning-executing">
   <title>データバランシングの計画と実行</title>
   <para>
    バランサモジュールを使用して、データバランシングの計画を作成できます。その後、計画を手動で実行することも、バランサでPGのバランスを継続的に調整することもできます。
   </para>
   <para>
    バランサを手動モードまたは自動モードのどちらで実行するかの判断は、現在のデータの不均衡、クラスタサイズ、PG数、I/Oアクティビティなど、さまざまな要因に依存します。初期計画を作成し、クラスタのI/O負荷が低いときに実行することをお勧めします。この理由は、初期の不均衡はかなり大きくなる可能性があるためで、クライアントへの影響を低く抑えることをお勧めします。初期の手動実行後、自動モードを有効にして、通常のI/O負荷でリバランストラフィックを監視することを検討します。PG分散の向上は、バランサが原因で発生するリバランストラフィックに対して比較検討する必要があります。
   </para>
   <tip>
    <title>PG (配置グループ)の移動可能な割合</title>
    <para>
     バランスプロセス中に、バランサモジュールは、PGの設定可能な部分のみが移動されるようPGの動きを制限します。デフォルトは5%ですが、次のコマンドを実行することで、この割合をたとえば9%に調整できます。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr target_max_misplaced_ratio .09</screen>
   </tip>
   <para>
    バランス計画を作成および実行するには、次の手順に従います。
   </para>
   <procedure>
    <step>
     <para>
      クラスタの現在のスコアを確認します。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer eval</screen>
    </step>
    <step>
     <para>
      計画を作成します。たとえば、「great_plan」などです。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer optimize great_plan</screen>
    </step>
    <step>
     <para>
      「great_plan」がどのような変化をもたらすかを確認します。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer show great_plan</screen>
    </step>
    <step>
     <para>
      「great_plan」を適用することを決定した場合は、クラスタの潜在的なスコアを確認します。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer eval great_plan</screen>
    </step>
    <step>
     <para>
      「great_plan」を1回だけ実行します。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer execute great_plan</screen>
    </step>
    <step>
     <para>
      <command>ceph -s</command>コマンドを使用して、クラスタのバランスを確認します。結果に問題がなければ、自動バランスを有効にします。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer on</screen>
     <para>
      後で自動バランスを無効にする場合は、次のコマンドを実行します。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer off</screen>
    </step>
   </procedure>
   <tip>
    <title>初期計画なしの自動バランス</title>
    <para>
     初期計画を実行しないで自動バランスを有効にすることができます。このような場合、配置グループのリバランスが長時間実行される可能性があることを予期してください。
    </para>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="mgr-modules-telemetry">
  <title>テレメトリモジュールの有効化</title>

  <para>
   テレメトリプラグインは、プラグインが実行されているクラスタに関するCephプロジェクトの匿名データを送信します。
  </para>

  <para>
   この(オプトイン)コンポーネントには、クラスタの展開方法、Cephのバージョン、ホストの分散、およびプロジェクトでCephの使用方法についての理解を深めるのに役立つ他のパラメータに関するカウンタと統計情報が含まれています。プール名、オブジェクト名、オブジェクトの内容、ホスト名などの機密データは含まれません。
  </para>

  <para>
   テレメトリモジュールの目的は、開発者に自動フィードバックループを提供し、これによって、導入率の定量化や追跡を行ったり、望ましくない結果を避けるために設定時により適切に説明または検証する必要がある事項を指摘したりできるようにすることです。
  </para>

  <note>
   <para>
    テレメトリモジュールを使用するには、Ceph Managerノードに、HTTPSでアップストリームサーバにデータをプッシュする機能が必要です。企業のファイアウォールでこのアクションが許可されるようにします。
   </para>
  </note>

  <procedure>
   <step>
    <para>
     テレメトリモジュールを有効にするには、次のコマンドを実行します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module enable telemetry</screen>
    <note>
     <para>
      このコマンドでは、ローカルでのみデータを表示できます。Cephコミュニティとデータを共有することはできません。
     </para>
    </note>
   </step>
   <step>
    <para>
     テレメトリモジュールがデータの共有を開始できるようにするには、次のコマンドを実行します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph telemetry on</screen>
   </step>
   <step>
    <para>
     テレメトリデータ共有を無効にするには、次のコマンドを実行します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph telemetry off</screen>
   </step>
   <step>
    <para>
     印刷可能なJSONレポートを生成するには、次のコマンドを実行します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph telemetry show</screen>
   </step>
   <step>
    <para>
     連絡先と説明をレポートに追加するには、次のコマンドを実行します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/telemetry/contact John Doe john.doe@example.com
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/telemetry/description 'My first Ceph cluster'</screen>
   </step>
   <step>
    <para>
     このモジュールは、デフォルトでは24時間ごとに新しいレポートを作成して送信します。この間隔を調整するには、次のコマンドを実行します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/telemetry/interval <replaceable>HOURS</replaceable></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
