<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Sichern und Wiederherstellen</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>Ja</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  In diesem Kapitel wird erläutert, welche Teile des Ceph-Clusters gesichert werden müssen, damit die Funktion des Clusters wiederhergestellt werden kann.
 </para>
 <sect1 xml:id="backrest-ceph">
  <title>Sichern von Cluster-Konfiguration und -Daten</title>

  <sect2 xml:id="backrest-ceph-cephsalt">
   <title>Sichern der <systemitem class="resource">ceph-salt</systemitem>-Konfiguration</title>
   <para>
    Exportieren Sie die Cluster-Konfiguration. Weitere Informationen finden Sie in <xref linkend="deploy-cephadm-configure-export"/>.
   </para>
  </sect2>

  <sect2 xml:id="backup-ceph">
   <title>Sichern der Ceph-Konfiguration</title>
   <para>
    Sichern Sie das Verzeichnis <filename>/etc/ceph</filename>. Es enthält wichtige Cluster-Konfigurationsdaten. Beispielsweise ist die <filename>/etc/ceph</filename>-Sicherung dann erforderlich, wenn Sie den Admin-Knoten ersetzen müssen.
   </para>
  </sect2>

  <sect2 xml:id="sec-deployment-backup-salt">
   <title>Sichern der Salt-Konfiguration</title>
   <para>
    Sichern Sie das Verzeichnis <filename>/etc/salt/</filename>. Es enthält die Salt-Konfigurationsdateien, beispielsweise den Salt-Master-Schlüssel und die akzeptierten Client-Schlüssel.
   </para>
   <para>
    Die Salt-Dateien sind zum Sichern des Admin-Knotens nicht unbedingt erforderlich, doch die erneute Bereitstellung des Salt Clusters wird dadurch einfacher. Wenn diese Dateien nicht gesichert sind, müssen die Salt Minions erneut beim neuen Admin-Knoten registriert werden.
   </para>
   <note>
    <title>Sicherheit des privaten Salt-Master-Schlüssels</title>
    <para>
     Vergewissern Sie sich, dass die Sicherungskopien des privaten Salt-Master-Schlüssels an einem sicheren Ort verwahrt sind. Mit dem Salt-Master-Schlüssel können alle Cluster-Knoten manipuliert werden.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="backup-config-files">
   <title>Sichern benutzerdefinierter Konfigurationen</title>
   <itemizedlist>
    <listitem>
     <para>
      Prometheus-Daten und -Anpassung
     </para>
    </listitem>
    <listitem>
     <para>
      Grafana-Anpassung
     </para>
    </listitem>
    <listitem>
     <para>
      Manuelle Änderungen an der iSCSI-Konfiguration
     </para>
    </listitem>
    <listitem>
     <para>
      Ceph-Schlüssel
     </para>
    </listitem>
    <listitem>
     <para>
      CRUSH-Zuordnung und CRUSH-Regeln Mit folgendem Kommando speichern Sie die dekompilierte CRUSH-Zuordnung zusammen mit den CRUSH-Regeln in <filename>crushmap-backup.txt</filename>:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
    </listitem>
    <listitem>
     <para>
      Samba-Gateway-Konfiguration. Wenn Sie ein einzelnes Gateway nutzen, sichern Sie <filename>/etc/samba/smb.conf</filename>. Wenn Sie eine Hochverfügbarkeitseinrichtung verwenden, müssen Sie auch die CTDB- und Pacemaker-Konfigurationsdateien sichern. Weitere Informationen zur verwendeten Konfiguration der Samba Gateways finden Sie in <xref linkend="cha-ses-cifs"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      NFS-Ganesha-Konfiguration. Nur bei einer Hochverfügbarkeitseinrichtung erforderlich. Weitere Informationen zur verwendeten Konfiguration von NFS Ganesha finden Sie in <xref linkend="cha-ceph-nfsganesha"/>.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="restore-ceph">
  <title>Wiederherstellen eines Ceph-Knotens</title>

  <para>
   Das Verfahren zur Wiederherstellung eines Knotens aus der Sicherung besteht darin, den Knoten neu zu installieren, seine Konfigurationsdateien zu ersetzen und dann den Cluster neu zu orchestrieren, so dass der Ersatzknoten wieder hinzugefügt wird.
  </para>

  <para>
   Wenn Sie den Admin-Knoten neu bereitstellen müssen, finden Sie Informationen hierzu in <xref linkend="moving-saltmaster"/>.
  </para>

  <para>
   Bei Minions ist es in der Regel einfacher, sie einfach wieder aufzubauen und neu zu verteilen.
  </para>

  <orderedlist>
   <listitem>
    <para>
     Installieren Sie den Knoten neu. Weitere Informationen finden Sie in <xref linkend="deploy-os"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Weitere Informationen zum Installieren von Salt finden Sie im <xref linkend="deploy-salt"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Aktivieren Sie nach dem Wiederherstellen des Verzeichnisses <filename>/etc/salt</filename> aus einer Sicherung die entsprechenden Salt-Services und starten Sie sie neu. Beispiel:
    </para>
<screen>
<prompt>root@master # </prompt><command>systemctl</command> enable salt-master
<prompt>root@master # </prompt><command>systemctl</command> start salt-master
<prompt>root@master # </prompt><command>systemctl</command> enable salt-minion
<prompt>root@master # </prompt><command>systemctl</command> start salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Entfernen Sie den öffentlichen Master-Schlüssel für den alten Salt-Master-Knoten aus allen Minions.
    </para>
<screen>
<prompt>root@master # </prompt><command>rm</command> /etc/salt/pki/minion/minion_master.pub
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Stellen Sie alles wieder her, was sich lokal auf dem Admin-Knoten befand.
    </para>
   </listitem>
   <listitem>
    <para>
     Importieren Sie die Cluster-Konfiguration aus der zuvor exportierten JSON-Datei. Weitere Informationen finden Sie im <xref linkend="deploy-cephadm-configure-export"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Wenden Sie die importierte Cluster-Konfiguration an:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt apply</screen>
   </listitem>
  </orderedlist>
 </sect1>
</chapter>
