<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Betrieb von Ceph-Services</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>Ja</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Sie können Ceph-Services auf Daemon-, Knoten- oder Clusterebene betreiben. Verwenden Sie je nach gewünschtem Ansatz cephadm oder das Kommando <command>systemctl</command>.
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>Betrieb einzelner Services</title>

  <para>
   Wenn Sie einen individuellen Service betreiben müssen, identifizieren Sie diesen zuerst:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   Führen Sie zum Identifizieren eines Service auf einem bestimmten Knoten folgendes Kommando aus:
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   Beispiel:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    Das Kommando <command>ceph orch ps</command> unterstützt mehrere Ausgabeformate. Hängen Sie zum Ändern die Option <option>--format <replaceable>FORMAT</replaceable></option> an, wobei <replaceable>FORMAT</replaceable> entweder <literal>json</literal>, <literal>json-pretty</literal> oder <literal>yaml</literal> sein kann. Beispiel:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   Sobald Sie den Namen des Service kennen, können Sie ihn starten, neu starten oder stoppen:
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   Führen Sie folgendes Kommando aus, um beispielsweise den OSD-Service mit der ID 0 neu zu starten:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>Betrieb der Servicetypen</title>

  <para>
   Verwenden Sie folgendes Kommando, wenn Sie einen bestimmten Servicetyp im gesamten Ceph-Cluster betreiben müssen:
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   Ersetzen Sie <replaceable>COMMAND</replaceable> durch <literal>start</literal>, <literal>stop</literal> oder <literal>restart</literal>.
  </para>

  <para>
   Mit folgendem Kommando werden beispielsweise alle MONs im Cluster neu gestartet, unabhängig davon, auf welchen Knoten sie tatsächlich ausgeführt werden:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>Betrieb von Services auf einem einzelnen Knoten</title>

  <para>
   Mit dem Kommando <command>systemctl</command> betreiben Sie Ceph-bezogene <systemitem class="daemon">systemd</systemitem>-Services und -Ziele auf einem einzelnen Knoten.
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identifizieren von Services und Zielen</title>
   <para>
    Bevor Sie Ceph-bezogene <systemitem class="daemon">systemd</systemitem>-Services und -Ziele betreiben, müssen Sie die Dateinamen der zugehörigen Einheitendateien identifizieren. Die Dateinamen der Services werden nach folgendem Muster erstellt:
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    Beispiel:
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       Eindeutige ID des Ceph-Clusters. Sie finden sie in der Ausgabe des Kommandos <command>ceph fsid</command>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       Typ des Service, beispielsweise <literal>osd</literal>, <literal>mon</literal> oder <literal>rgw</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       Identifikationszeichenkette des Service. Bei OSDs ist es die ID-Nummer des Service. Bei anderen Services kann es sich entweder um einen Hostnamen des Knotens oder um zusätzliche für den Servicetyp relevante Zeichenketten handeln.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     Der Teil <replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable> ist in der Ausgabe des Kommandos <command>ceph orch ps</command> identisch mit dem Inhalt der Spalte <literal>NAME</literal>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Betrieb aller Services auf einem Knoten</title>
   <para>
    Mit den <systemitem class="daemon">systemd</systemitem>-Zielen von Ceph können Sie entweder <emphasis>alle</emphasis> Services auf einem Knoten oder alle Services, die <emphasis>zu einem durch seine <replaceable>FSID</replaceable> identifizierten Cluster gehören</emphasis>, gleichzeitig betreiben.
   </para>
   <para>
    Führen Sie folgendes Kommando aus, um beispielsweise alle Ceph-Services auf einem Knoten zu stoppen, unabhängig davon, zu welchem Cluster die Services gehören:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    Führen Sie folgendes Kommando aus, um alle Services neu zu starten, die zu einem Ceph-Cluster mit ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal> gehören:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>Betrieb eines einzelnen Service auf einem Knoten</title>
   <para>
    Nachdem Sie den Namen eines bestimmten Service identifiziert haben, betreiben Sie ihn auf folgende Weise:
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    Führen Sie folgendes Kommando aus, um beispielsweise einen einzelnen OSD-Service mit ID 1 auf einem Cluster mit ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal> neu zu starten:
   </para>
<screen><prompt role="root">root # </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Abfragen des Servicestatus</title>
   <para>
    Eine Abfrage mit <systemitem class="daemon">systemd</systemitem> ermittelt den Status von Services. Beispiel:
   </para>
<screen><prompt role="root">root # </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Herunterfahren und Neustarten des gesamten Ceph-Clusters</title>

  <para>
   Das Herunterfahren und Neustarten des Clusters kann bei einem geplanten Stromausfall erforderlich sein. Führen Sie folgende Schritte aus, um alle Ceph-bezogenen Services zu stoppen und ohne Probleme neu zu starten.
  </para>

  <procedure>
   <title>Herunterfahren des gesamten Ceph-Clusters</title>
   <step>
    <para>
     Fahren Sie alle Clients herunter, die auf den Cluster zugreifen, oder trennen Sie deren Verbindung.
    </para>
   </step>
   <step>
    <para>
     Legen Sie den Cluster auf <literal>noout</literal> fest, um zu verhindern, dass CRUSH den Cluster automatisch neu ausbalanciert:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     Stoppen Sie alle Ceph-Services auf allen Cluster-Knoten:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     Schalten Sie alle Cluster-Knoten aus:
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>Starten des gesamten Ceph-Clusters</title>
   <step>
    <para>
     Schalten Sie den Admin-Knoten ein.
    </para>
   </step>
   <step>
    <para>
     Schalten Sie die Ceph Monitor-Knoten ein.
    </para>
   </step>
   <step>
    <para>
     Schalten Sie die Ceph OSD-Knoten ein.
    </para>
   </step>
   <step>
    <para>
     Entfernen Sie das vorher festgelegte Flag <literal>noout</literal>:
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     Schalten Sie alle konfigurierten Gateways ein.
    </para>
   </step>
   <step>
    <para>
     Schalten Sie die Cluster-Clients ein oder verbinden Sie sie.
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
