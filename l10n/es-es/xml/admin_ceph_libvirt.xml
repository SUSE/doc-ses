<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_libvirt.xml" version="5.0" xml:id="cha-ceph-libvirt">
 <title><systemitem class="library">libvirt</systemitem> y Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sí</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  La biblioteca <systemitem class="library">libvirt</systemitem> crea una capa de abstracción de máquina virtual entre las interfaces de hipervisor y las aplicaciones de software que las utilizan. Con <systemitem class="library">libvirt</systemitem>, los desarrolladores y administradores del sistema pueden centrarse en un marco de gestión común, API comunes y una interfaz de shell también común (<command>virsh</command>) para muchos hipervisores distintos, incluidos QEMU/KVM, Xen, LXC y VirtualBox.
 </para>
 <para>
  Los dispositivos de bloques de Ceph admiten QEMU/KVM. Es posible utilizar dispositivos de bloques de Ceph con software que se conecte con <systemitem class="library">libvirt</systemitem>. La solución de nube utiliza <systemitem class="library">libvirt</systemitem> para interactuar con QEMU/KVM, y QEMU/KVM interactúa con los dispositivos de bloques de Ceph a través de <systemitem>librbd</systemitem>.
 </para>
 <para>
  Para crear máquinas virtuales que utilicen dispositivos de bloques de Ceph, utilice los procedimientos de las siguientes secciones. En los ejemplos, hemos utilizado <literal>libvirt-pool</literal> para el nombre del repositorio, <literal>client.libvirt</literal> para el nombre de usuario y <literal>new-libvirt-image</literal> para el nombre de la imagen. Puede utilizar cualquier nombre que desee, pero asegúrese de sustituirlos cuando ejecute los comandos en los procedimientos siguientes.
 </para>
 <sect1 xml:id="ceph-libvirt-cfg-ceph">
  <title>Configuración de Ceph con <systemitem class="library">libvirt</systemitem></title>

  <para>
   Para configurar Ceph para su uso con <systemitem class="library">libvirt</systemitem>, realice los pasos siguientes:
  </para>

  <procedure>
   <step>
    <para>
     Cree un repositorio. En el ejemplo siguiente se utiliza el nombre de repositorio <literal>libvirt-pool</literal> con 128 grupos de colocación.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     Compruebe que el repositorio existe.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     Cree un usuario de Ceph. El siguiente ejemplo utiliza el nombre de usuario de Ceph <literal>client.libvirt</literal> y hace referencia a <literal>libvirt-pool</literal>.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-or-create client.libvirt mon 'profile rbd' osd \
 'profile rbd pool=libvirt-pool'</screen>
    <para>
     Verifique que el nombre existe.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth list</screen>
    <note>
     <title>nombre de usuario o ID</title>
     <para>
      <systemitem class="library">libvirt</systemitem> accederá a Ceph utilizando el ID <literal>libvirt</literal>, no el nombre de Ceph <literal>client.libvirt</literal>. Consulte la <xref linkend="cephx-user"/> para obtener una explicación detallada de la diferencia entre el ID y el nombre.
     </para>
    </note>
   </step>
   <step>
    <para>
     Utilice QEMU para crear una imagen en el repositorio RBD. El siguiente ejemplo utiliza el nombre de imagen <literal>new-libvirt-image</literal> y hace referencia a <literal>libvirt-pool</literal>.
    </para>
    <tip>
     <title>ubicación del archivo de anillo de claves</title>
     <para>
      La clave de usuario <systemitem class="library">libvirt</systemitem> se almacena en un archivo de claves colocado en el directorio <filename>/etc/ceph</filename>. El archivo de claves debe tener un nombre adecuado que incluya el nombre del clúster de Ceph al que pertenece. Para el nombre de clúster por defecto "ceph", el nombre del archivo de claves es <filename>/etc/ceph/ceph.client.libvirt.keyring</filename>.
     </para>
     <para>
      Si el anillo de claves no existe, créelo con:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get client.libvirt &gt; /etc/ceph/ceph.client.libvirt.keyring</screen>
    </tip>
<screen><prompt role="root">root # </prompt>qemu-img create -f raw rbd:libvirt-pool/new-libvirt-image:id=libvirt 2G</screen>
    <para>
     Verifique que la imagen existe.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-virt-manager">
  <title>Preparación del gestor de máquina virtual</title>

  <para>
   Puede utilizar <systemitem class="library">libvirt</systemitem> sin un gestor de máquina virtual, pero le resultará más fácil crear el primer dominio con <command>virt-manager</command>.
  </para>

  <procedure>
   <step>
    <para>
     Instale un gestor de máquina virtual.
    </para>
<screen><prompt role="root">root # </prompt>zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     Prepare o descargue una imagen de sistema operativo del sistema que desea ejecutar de forma virtualizada.
    </para>
   </step>
   <step>
    <para>
     Lance el gestor de máquina virtual.
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-create-vm">
  <title>Creación de una máquina virtual</title>

  <para>
   Para crear una máquina virtual con <command>virt-manager</command>, realice los siguientes pasos:
  </para>

  <procedure>
   <step>
    <para>
     Elija la conexión en la lista, haga clic con el botón derecho en ella y seleccione <guimenu>New</guimenu> (Nuevo).
    </para>
   </step>
   <step>
    <para>
     Para <guimenu>importar la imagen de disco existente</guimenu> proporcione la vía al almacenamiento actual. Especifique el tipo de sistema operativo, los valores de memoria y el <guimenu>nombre</guimenu> de la máquina virtual, por ejemplo <literal>libvirt-virtual-machine</literal>.
    </para>
   </step>
   <step>
    <para>
     Finalice la configuración e inicie la máquina virtual.
    </para>
   </step>
   <step>
    <para>
     Verifique que el dominio recién creado existe con <command>sudo virsh list</command>. Si es necesario, especifique la cadena de conexión, como:
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     Entre en la máquina virtual y deténgala antes de configurarla para su uso con Ceph.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-cfg-vm">
  <title>Configuración de la máquina virtual</title>

  <para>
   En este capítulo nos centramos en la configuración de máquinas virtuales para su integración con Ceph mediante <command>virsh</command>. Los comandos de <command>virsh</command> suelen requerir privilegios de usuario root (<command>sudo</command>) y, si no se tienen esos privilegios, no proporcionan resultados adecuados ni notifican de que esos privilegios son necesarios. Para obtener información sobre los comandos de <command>virsh</command>, consulte <command>man 1 virsh</command> (se requiere el paquete <package>libvirt-client</package> para instalarse).
  </para>

  <procedure>
   <step>
    <para>
     Abra el archivo de configuración con <command>virsh edit</command>
     <replaceable> vm-domain-name</replaceable>.
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     En &lt;devices&gt; debe haber una entrada &lt;disk&gt;.
    </para>
<screen>&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-<replaceable>SYSTEM-ARCH</replaceable>&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/image/recent-linux.img'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='drive' controller='0' bus='0' unit='0'/&gt;
    &lt;/disk&gt;</screen>
    <para>
     Sustituya <filename>/path/to/image/recent-linux.img</filename> por la vía a la imagen del sistema operativo.
    </para>
    <important>
     <para>
      Use <command>sudo virsh edit</command> en lugar de un editor de textos. Si edita el archivo de configuración en <filename>/etc/libvirt/qemu</filename> con un editor de textos, <systemitem class="library">libvirt</systemitem> puede que no reconozca el cambio. Si hay discrepancias entre el contenido del archivo XML de <filename>/etc/libvirt/qemu</filename> y el resultado de <command>sudo virsh dumpxml</command> <replaceable>vm-domain-name</replaceable>, puede que la máquina virtual no funcione correctamente.
     </para>
    </important>
   </step>
   <step>
    <para>
     Añada la imagen de Ceph RBD que ha creado anteriormente como una entrada &lt;disk&gt;.
    </para>
<screen>&lt;disk type='network' device='disk'&gt;
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'&gt;
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/&gt;
        &lt;/source&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;</screen>
    <para>
     Sustituya <replaceable>monitor-host</replaceable> por el nombre de host y sustituya el nombre del repositorio y el nombre de la imagen según sea necesario. Puede añadir varias entradas &lt;host&gt; para los monitores de Ceph. El atributo <literal>dev</literal> es el nombre del dispositivo lógico que aparecerá en el directorio <filename>/dev</filename> de la máquina virtual. El atributo de bus opcional indica el tipo de dispositivo de disco que se debe emular. Los valores válidos son específicos de cada controlador (por ejemplo ide, scsi, virtio, xen, usb o sata).
    </para>
   </step>
   <step>
    <para>
     Guarde el archivo.
    </para>
   </step>
   <step>
    <para>
     Si el clúster de Ceph tiene la autenticación habilitada (lo está por defecto), debe generar un secreto. Abra el editor que quiera y cree un archivo denominado <filename>secret.xml</filename> con el contenido siguiente:
    </para>
<screen>&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;</screen>
   </step>
   <step>
    <para>
     Defina el secreto.
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-define --file secret.xml
&lt;uuid of secret is output here&gt;</screen>
   </step>
   <step>
    <para>
     Obtenga la clave <literal>client.libvirt</literal> y guarde la cadena de clave en un archivo.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     Defina el UUID del secreto.
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     También debe definir el secreto manualmente añadiendo la siguiente entrada <literal>&lt;auth&gt;</literal> al elemento <literal>&lt;disk&gt;</literal> que introdujo antes (sustituya el valor de uuid con el resultado de la línea de comandos del ejemplo anterior).
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
    <para>
     A continuación, añada el elemento <literal>&lt;auth&gt;&lt;/auth&gt;</literal> al archivo de configuración de dominio:
    </para>
<screen>...
&lt;/source&gt;
&lt;auth username='libvirt'&gt;
        &lt;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/&gt;
&lt;/auth&gt;
&lt;target ...</screen>
    <note>
     <para>
      El ID del ejemplo es <literal>libvirt</literal>, no el nombre de Ceph <literal>client.libvirt</literal>, como se generó en el paso 2 de la <xref linkend="ceph-libvirt-cfg-ceph"/>. Asegúrese de utilizar el componente ID del nombre de Ceph que ha generado. Si por algún motivo necesita volver a generar el secreto, deberá ejecutar <command>sudo virsh secret-undefine</command> <replaceable> uuid</replaceable> antes de ejecutar <command>sudo virsh secret-set-value</command> de nuevo.
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-summary">
  <title>Resumen</title>

  <para>
   Después de configurar la máquina virtual para usarla con Ceph, puede iniciarla. Para verificar que la máquina virtual y Ceph se comunican, puede llevar a cabo los procedimientos siguientes.
  </para>

  <procedure>
   <step>
    <para>
     Compruebe que se está ejecutando Ceph:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph health</screen>
   </step>
   <step>
    <para>
     Compruebe que se está ejecutando la máquina virtual:
    </para>
<screen><prompt role="root">root # </prompt>virsh list</screen>
   </step>
   <step>
    <para>
     Compruebe que la máquina virtual se comunica con Ceph. Sustituya <replaceable>vm-domain-name</replaceable> por el nombre de su dominio de máquina virtual:
    </para>
<screen><prompt role="root">root # </prompt>virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     Compruebe que el dispositivo de <literal>&amp;target dev='hdb' bus='ide'/&gt;</literal> aparece en <filename>/dev</filename> o en <filename>/proc/partitions</filename>:
    </para>
<screen><prompt>tux &gt; </prompt>ls /dev
<prompt>tux &gt; </prompt>cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
