<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Funcionamiento de los servicios de Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sí</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Puede hacer funcionar los servicios de Ceph en el nivel de los daemons, los nodos o los clústeres. Según el enfoque que necesite, utilice cephadm o el comando <command>systemctl</command>.
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>Funcionamiento de servicios individuales</title>

  <para>
   Si necesita hacer funcionar un servicio individual, identifíquelo primero:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   Para identificar un servicio en un nodo específico, ejecute:
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   Por ejemplo:
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    El comando <command>ceph orch ps</command> admite varios formatos de salida. Para cambiarlo, añada la opción <option>--format <replaceable>FORMAT</replaceable></option> al final, donde <replaceable>FORMAT</replaceable> es uno de estas opciones: <literal>json</literal>, <literal>json-pretty</literal> o <literal>yaml</literal>. Por ejemplo:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   Una vez que sepa el nombre del servicio, puede iniciarlo, reiniciarlo o detenerlo:
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   Por ejemplo, para reiniciar el servicio OSD con el ID 0, ejecute:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>Funcionamiento de tipos de servicios</title>

  <para>
   Si necesita hacer funcionar un tipo específico de servicio en todo el clúster de Ceph, utilice el comando siguiente:
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   Sustituya <replaceable>COMMAND</replaceable> por <literal>start</literal>, <literal>stop</literal> o <literal>restart</literal>.
  </para>

  <para>
   Por ejemplo, el comando siguiente reinicia todos los MON del clúster, independientemente de los nodos en los que se ejecuten:
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>Funcionamiento de servicios en un único nodo</title>

  <para>
   Mediante el comando <command>systemctl</command>, puede hacer funcionar los servicios y destinos de <systemitem class="daemon">systemd</systemitem> relacionados con Ceph en un único nodo.
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identificación de servicios y destinos</title>
   <para>
    Antes de hacer funcionar los servicios y destinos de <systemitem class="daemon">systemd</systemitem> relacionados con Ceph, debe identificar los nombres de archivo de sus archivos de unidad. Los nombres de archivo de los servicios tienen el siguiente patrón:
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    Por ejemplo:
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       ID exclusivo del clúster de Ceph. Lo encontrará en el resultado del comando <command>ceph fsid</command>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       El tipo de servicio, por ejemplo, <literal>osd</literal>, <literal>mon</literal> o <literal>rgw</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       Cadena de identificación del servicio. Para los OSD, es el número de ID del servicio. Para otros servicios, puede ser un nombre de host del nodo o cadenas adicionales relevantes para el tipo de servicio.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     La parte de <replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable> es idéntica al contenido de la columna <literal>NAME</literal> del resultado del comando <command>ceph orch ps</command>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Funcionamiento de todos los servicios en un nodo</title>
   <para>
    Al usar los destinos de <systemitem class="daemon">systemd</systemitem> de Ceph, puede hacer funcionar simultáneamente <emphasis>todos</emphasis> los servicios en un nodo, o bien todos los servicios que <emphasis>pertenecen a un clúster</emphasis> identificado por su <replaceable>FSID</replaceable>.
   </para>
   <para>
    Por ejemplo, para detener todos los servicios de Ceph en un nodo independientemente del clúster al que pertenezcan los servicios, ejecute:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    Para reiniciar todos los servicios que pertenecen a un clúster de Ceph con el ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, ejecute:
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>Funcionamiento de un servicio individual en un nodo</title>
   <para>
    Después de identificar el nombre de un servicio específico, utilícelo de la siguiente manera:
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    Por ejemplo, para reiniciar un único servicio OSD con el ID 1 en un clúster con el ID <literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>, ejecute:
   </para>
<screen><prompt role="root">root # </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Consulta del estado del servicio</title>
   <para>
    Puede consultar <systemitem class="daemon">systemd</systemitem> para conocer el estado de los servicios. Por ejemplo:
   </para>
<screen><prompt role="root">root # </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Apagado y reinicio de todo el clúster de Ceph</title>

  <para>
   Es posible que sea necesario apagar y reiniciar el clúster en caso de que se vaya a producir un corte de energía programado. Para detener todos los servicios relacionados con Ceph y reiniciar sin problemas, siga los pasos siguientes.
  </para>

  <procedure>
   <title>Apagado de todo el clúster de Ceph</title>
   <step>
    <para>
     Apague o desconecte cualquier cliente que acceda al clúster.
    </para>
   </step>
   <step>
    <para>
     Para evitar que CRUSH reequilibre automáticamente el clúster, defina el clúster en <literal>noout</literal>:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     Detenga todos los servicios de Ceph en todos los nodos del clúster:
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     todos los nodos del clúster:
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>Inicio de todo el clúster de Ceph</title>
   <step>
    <para>
     Encienda el nodo de administración.
    </para>
   </step>
   <step>
    <para>
     Encienda los nodos de Ceph Monitor.
    </para>
   </step>
   <step>
    <para>
     Encienda los nodos de OSD de Ceph.
    </para>
   </step>
   <step>
    <para>
     Anule la definición del indicador <literal>noout</literal> definido anteriormente:
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     Encienda todas las pasarelas configuradas.
    </para>
   </step>
   <step>
    <para>
     Encienda o conecte los clientes del clúster.
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
