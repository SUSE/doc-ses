<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_gateway.xml" version="5.0" xml:id="cha-ceph-gw">

 <title>Ceph Object Gateway</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>oui</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Ce chapitre présente des détails sur les tâches d'administration liées à Object Gateway, telles que la vérification de l'état du service, la gestion des comptes, les passerelles multisites ou l'authentification LDAP.
 </para>
 <sect1 xml:id="sec-ceph-rgw-limits">
  <title>Restrictions d'Object Gateway et règles de dénomination</title>

  <para>
   Voici la liste des limites importantes d'Object Gateway :
  </para>

  <sect2 xml:id="ogw-limits-bucket">
   <title>Limitations des compartiments</title>
   <para>
    Lors de l'approche d'Object Gateway via l'API S3, les noms de compartiment doivent être conformes au DNS et peuvent contenir le caractère tiret (« - »). Lors de l'approche d'Object Gateway via l'API Swift, vous pouvez utiliser n'importe quelle combinaison de caractères UTF-8 à l'exception du caractère « / ». Le nom d'un compartiment peut comporter jusqu'à 255 caractères. Chaque nom de compartiment doit être unique.
   </para>
   <tip>
    <title>utilisation de noms de compartiment conformes au DNS</title>
    <para>
     Bien que vous puissiez utiliser n'importe quel nom de compartiment basé sur UTF-8 dans l'API Swift, il est recommandé de nommer les compartiments conformément aux règles de dénomination S3 afin d'éviter les problèmes d'accès au même compartiment via l'API S3.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ogw-limits-object">
   <title>Limitations des objets stockés</title>
   <variablelist>
    <varlistentry>
     <term>Nombre maximal d'objets par utilisateur</term>
     <listitem>
      <para>
       Aucune restriction par défaut (limite de ~ 2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Nombre maximal d'objets par compartiment</term>
     <listitem>
      <para>
       Aucune restriction par défaut (limite de ~ 2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Taille maximale d'un objet à charger/stocker</term>
     <listitem>
      <para>
       La limite est de 5 Go par chargement. Utilisez le chargement en plusieurs parties pour les objets plus volumineux. Le nombre maximal s'élève à 10 000 pour les tranches en plusieurs parties.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ogw-limits-http">
   <title>Limitations d'en-tête HTTP</title>
   <para>
    La limitation de requête et d'en-tête HTTP dépend de l'interface Web utilisée. L'entité par défaut limite la taille de l'en-tête HTTP à 16 ko.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-deploy">
  <title>Déploiement de la passerelle Object Gateway</title>

  <para>
   Le déploiement de la passerelle Ceph Object Gateway suit la même procédure que le déploiement des autres services Ceph, à l'aide de cephdm. Pour plus de détails, reportez-vous au document <xref linkend="cephadm-service-and-placement-specs"/>, en particulier au document <xref linkend="deploy-cephadm-day2-service-ogw"/>.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-operating">
  <title>Exploitation du service Object Gateway</title>

  <para>
   Vous pouvez utiliser les passerelles Object Gateway de la même manière que les autres services Ceph en identifiant d'abord le nom du service avec la commande <command>ceph orch ps</command>, puis en exécutant la commande suivante pour l'exploitation des services, par exemple :
  </para>

<screen>ceph orch daemon restart <replaceable>OGW_SERVICE_NAME</replaceable></screen>

  <para>
   Reportez-vous au <xref linkend="cha-ceph-operating"/> pour obtenir des informations complètes sur le fonctionnement des services Ceph.
  </para>
 </sect1>
 <sect1 xml:id="ogw-config-parameters">
  <title>Options de configuration</title>

  <para>
   Reportez-vous à la <xref linkend="config-ogw"/> pour obtenir une liste des options de configuration d'Object Gateway.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-access">
  <title>Gestion des accès à la passerelle Object Gateway</title>

  <para>
   Vous pouvez communiquer avec Object Gateway en utilisant une interface compatible avec S3 ou Swift. L'interface S3 est compatible avec un vaste sous-ensemble de l'API RESTful d'Amazon S3. L'interface Swift est compatible avec un vaste sous-ensemble de l'API OpenStack Swift.
  </para>

  <para>
   Les deux interfaces nécessitent la création d'un utilisateur spécifique et l'installation du logiciel client approprié pour communiquer avec la passerelle à l'aide de la clé secrète de l'utilisateur.
  </para>

  <sect2 xml:id="accessing-ragos-gateway">
   <title>Accès à Object Gateway</title>
   <sect3 xml:id="ogw-s3-interface-access">
    <title>Accès à l'interface S3</title>
    <para>
     Pour accéder à l'interface S3, un client REST est nécessaire. <command>S3cmd</command> est un client S3 de ligne de commande. Il est disponible dans <link xlink:href="https://build.opensuse.org/package/show/Cloud:Tools/s3cmd">OpenSUSE Build Service</link>. Le dépôt contient des versions de distributions SUSE Linux Enterprise et de distributions openSUSE.
    </para>
    <para>
     Si vous voulez tester votre accès à l'interface S3, vous pouvez aussi écrire un petit script Python. Le script se connecte à Object Gateway, crée un compartiment et dresse la liste de tous les compartiments. Les valeurs de <option>aws_access_key_id</option> (ID_clé_accès_AWS) et de <option>aws_secret_access_key</option> (Clé_accès_secret_AWS) sont issues des valeurs de <option>access_key</option> (clé_accès) et de <option>secret_key</option> (clé_secret) renvoyées par la commande <command>radosgw_admin</command> de la <xref linkend="adding-s3-swift-users"/>.
    </para>
    <procedure>
     <step>
      <para>
       Installez le paquetage <systemitem>python-boto</systemitem> :
      </para>
<screen><prompt role="root">root # </prompt>zypper in python-boto</screen>
     </step>
     <step>
      <para>
       Créez un script Python appelé <filename>s3test.py</filename> avec le contenu suivant : <remark role="fixme">Provide script in RPM? Is it really necessary to create pool? This script is not necessary at all, remove it from documentation?</remark>
      </para>
<screen>import boto
import boto.s3.connection
access_key = '11BS02LGFB6AL6H1ADMW'
secret_key = 'vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY'
conn = boto.connect_s3(
aws_access_key_id = access_key,
aws_secret_access_key = secret_key,
host = '<replaceable>HOSTNAME</replaceable>',
is_secure=False,
calling_format = boto.s3.connection.OrdinaryCallingFormat(),
)
bucket = conn.create_bucket('my-new-bucket')
for bucket in conn.get_all_buckets():
  print "<replaceable>NAME</replaceable>\t<replaceable>CREATED</replaceable>".format(
  name = bucket.name,
  created = bucket.creation_date,
  )</screen>
      <para>
       Remplacez <literal><replaceable>HOSTNAME</replaceable></literal> par le nom de l'hôte sur lequel vous avez configuré le service Object Gateway, par exemple <literal>gateway_host</literal>.
      </para>
     </step>
     <step>
      <para>
       Exécutez le script :
      </para>
<screen>python s3test.py</screen>
      <para>
       Le script produit un résultat similaire à ceci :
      </para>
<screen>my-new-bucket 2015-07-22T15:37:42.000Z</screen>
     </step>
    </procedure>
   </sect3>
   <sect3 xml:id="swift-interface-access">
    <title>Accès à l'interface Swift</title>
    <para>
     Pour accéder à Object Gateway via l'interface Swift, vous devez disposer du client de ligne de commande <command>swift</command>. La page de manuel <command>man 1 swift</command> fournit des informations complémentaires sur les options de ligne de commande du client.
    </para>
    <para>
     Le paquetage est inclus dans le module « Public Cloud » (Cloud public) pour SUSE Linux Enterprise 12 à partir de SP3 et SUSE Linux Enterprise 15. Avant d'installer le paquetage, vous devez activer le module et rafraîchir le dépôt des logiciels :
    </para>
<screen><prompt role="root">root # </prompt>SUSEConnect -p sle-module-public-cloud/12/<replaceable>SYSTEM-ARCH</replaceable>
sudo zypper refresh</screen>
    <para>
     Ou
    </para>
<screen><prompt role="root">root # </prompt>SUSEConnect -p sle-module-public-cloud/15/<replaceable>SYSTEM-ARCH</replaceable>
<prompt role="root">root # </prompt>zypper refresh</screen>
    <para>
     Pour installer la commande <command>swift</command>, exécutez ce qui suit :
    </para>
<screen><prompt role="root">root # </prompt>zypper in python-swiftclient</screen>
    <para>
     L'accès swift utilise la syntaxe suivante :
    </para>
<screen><prompt>tux &gt; </prompt>swift -A http://<replaceable>IP_ADDRESS</replaceable>/auth/1.0 \
-U example_user:swift -K '<replaceable>SWIFT_SECRET_KEY</replaceable>' list</screen>
    <para>
     Remplacez <replaceable>IP_ADDRESS</replaceable> par l'adresse IP du serveur de passerelle, et <replaceable>SWIFT_SECRET_KEY</replaceable> par la valeur de la clé secrète SWIFT dans la sortie de la commande <command>radosgw-admin key create</command> exécutée pour l'utilisateur <systemitem>swift</systemitem> à la <xref linkend="adding-s3-swift-users"/>.
    </para>
    <para>
     Par exemple :
    </para>
<screen><prompt>tux &gt; </prompt>swift -A http://gateway.example.com/auth/1.0 -U example_user:swift \
-K 'r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h' list</screen>
    <para>
     La sortie est la suivante :
    </para>
<screen>my-new-bucket</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="s3-swift-accounts-managment">
   <title>Gestion des comptes S3 et Swift</title>
   <sect3 xml:id="adding-s3-swift-users">
    <title>Ajout d'utilisateurs S3 et Swift</title>
    <para>
     Vous devez créer un utilisateur, une clé d'accès et un secret pour permettre aux utilisateurs finaux d'interagir avec la passerelle. Il existe deux types d'utilisateur : <emphasis>user</emphasis> et <emphasis>subuser</emphasis>. Alors que des <emphasis>users</emphasis> sont employés pour les interactions avec l'interface S3, les <emphasis>subusers</emphasis> sont les utilisateurs de l'interface Swift. Chaque subuser est associé à un user.
    </para>
    <para>
     Pour créer un utilisateur Swift, procédez de la façon suivante :
    </para>
    <procedure>
     <step>
      <para>
       Pour créer un utilisateur Swift (qui est un <emphasis>subuser</emphasis> suivant notre terminologie), vous devez d'abord créer le <emphasis>user</emphasis> qui lui est associé.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
      <para>
       Par exemple :
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
     </step>
     <step>
      <para>
       Pour créer un subuser (interface Swift) pour l'utilisateur, vous devez indiquer l'ID utilisateur (--uid=<replaceable>USERNAME</replaceable>), un ID subuser et le niveau d'accès du subuser.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser create --uid=<replaceable>UID</replaceable> \
 --subuser=<replaceable>UID</replaceable> \
 --access=[ <replaceable>read | write | readwrite | full</replaceable> ]</screen>
      <para>
       Par exemple :
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser create --uid=example_user \
 --subuser=example_user:swift --access=full</screen>
     </step>
     <step>
      <para>
       Générez une clé secrète pour l'utilisateur.
      </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create \
   --gen-secret \
   --subuser=example_user:swift \
   --key-type=swift</screen>
     </step>
     <step>
      <para>
       Les deux commandes afficheront des données au format JSON indiquant l'état de l'utilisateur. Notez les lignes suivantes et souvenez-vous de la valeur de <literal>secret_key</literal> (clé_secrète) :
      </para>
<screen>"swift_keys": [
   { "user": "example_user:swift",
     "secret_key": "r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h"}],</screen>
     </step>
    </procedure>
    <para/>
    <para>
     Lorsque vous accédez à Object Gateway via l'interface S3, vous devez créer un utilisateur S3 en exécutant :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
    <para>
     Par exemple :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
    <para>
     La commande crée également l'accès et la clé secrète de l'utilisateur. Vérifiez le résultat des mots clés <literal>access_key</literal> (clé_accès) et <literal>secret_key</literal> (clé_secret), et leurs valeurs :
    </para>
<screen>[...]
 "keys": [
       { "user": "example_user",
         "access_key": "11BS02LGFB6AL6H1ADMW",
         "secret_key": "vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY"}],
 [...]</screen>
   </sect3>
   <sect3 xml:id="removing-s3-swift-users">
    <title>Suppression d'utilisateurs S3 et Swift</title>
    <para>
     La procédure de suppression des utilisateurs est similaire pour les utilisateurs S3 et Swift. Dans le cas d'utilisateurs Swift cependant, vous devrez peut-être supprimer l'utilisateur ainsi que ses subusers.
    </para>
    <para>
     Pour supprimer un utilisateur S3 ou Swift (y compris tous ses subusers), spécifiez <option>user rm</option> et l'ID utilisateur dans la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user rm --uid=example_user</screen>
    <para>
     Pour supprimer un subuser, spécifiez <option>subuser rm</option> et l'ID de celui-ci.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin subuser rm --uid=example_user:swift</screen>
    <para>
     Vous pouvez utiliser les options suivantes :
    </para>
    <variablelist>
     <varlistentry>
      <term>--purge-data</term>
      <listitem>
       <para>
        Purge toutes les données associées à l'ID utilisateur.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>--purge-keys</term>
      <listitem>
       <para>
        Purge toutes les clés associées à l'ID utilisateur.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <tip>
     <title>suppression d'un subuser</title>
     <para>
      Lorsque vous supprimez un subuser, vous supprimez également l'accès à l'interface Swift. L'utilisateur est conservé dans le système.
     </para>
    </tip>
   </sect3>
   <sect3 xml:id="changing-s3-swift-users-password">
    <title>Modification de l'accès utilisateur S3 et Swift et des clés secrètes</title>
    <para>
     Les paramètres <literal>access_key</literal> (clé_accès) et <literal>secret_key</literal> (clé_secret) identifient l'utilisateur Object Gateway lors de l'accès à la passerelle. La modification des clés utilisateur existantes revient à créer de nouvelles clés, car les anciennes clés sont écrasées.
    </para>
    <para>
     Pour les utilisateurs S3, exécutez la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create --uid=<replaceable>EXAMPLE_USER</replaceable> --key-type=s3 --gen-access-key --gen-secret</screen>
    <para>
     Pour les utilisateurs Swift, exécutez la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin key create --subuser=<replaceable>EXAMPLE_USER</replaceable>:swift --key-type=swift --gen-secret</screen>
    <variablelist>
     <varlistentry>
      <term><option>--key-type=<replaceable>TYPE</replaceable></option></term>
      <listitem>
       <para>
        Indique le type de clé. Soit <literal>swift</literal>, soit <literal>s3</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-access-key</option></term>
      <listitem>
       <para>
        Génère une clé d'accès aléatoire (pour l'utilisateur S3 par défaut).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-secret</option></term>
      <listitem>
       <para>
        Génère une clé secrète aléatoire.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--secret=<replaceable>KEY</replaceable></option></term>
      <listitem>
       <para>
        Indique une clé secrète, par exemple générée manuellement.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="user-quota-managment">
    <title>Activation de la gestion des quotas utilisateur</title>
    <para>
     La passerelle Ceph Object Gateway vous permet de définir des quotas sur les utilisateurs et les compartiments appartenant aux utilisateurs. Les quotas incluent le nombre maximal d'objets dans un compartiment et la taille de stockage maximale en mégaoctets.
    </para>
    <para>
     Avant d'activer un quota utilisateur, vous devez tout d'abord définir ses paramètres :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota set --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable> \
 --max-objects=1024 --max-size=1024</screen>
    <variablelist>
     <varlistentry>
      <term><option>--max-objects</option></term>
      <listitem>
       <para>
        Indique le nombre maximal d'objets. Une valeur négative désactive la vérification.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--max-size</option></term>
      <listitem>
       <para>
        Indique le nombre maximal d'octets. Une valeur négative désactive la vérification.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--quota-scope</option></term>
      <listitem>
       <para>
        Définit l'étendue du quota. Les options sont <literal>bucket</literal> (compartiment) et <literal>user</literal> (utilisateur). Les quotas de compartiment s'appliquent aux compartiments appartenant à un utilisateur. Les quotas utilisateur s'appliquent à un utilisateur.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Une fois que vous avez défini un quota utilisateur, vous pouvez l'activer :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota enable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Pour désactiver un quota :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin quota disable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Pour dresser la liste des paramètres de quota :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Pour mettre à jour les statistiques de quota :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user stats --uid=<replaceable>EXAMPLE_USER</replaceable> --sync-stats</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-http-frontends">
  <title>Interfaces clients HTTP</title>

  <para>
   La passerelle Ceph Object Gateway prend en charge deux interfaces clients HTTP : <emphasis>Beast</emphasis> et <emphasis>Civetweb</emphasis>.
  </para>

  <para>
   L'interface client Beast utilise la bibliothèque Boost.Beast pour l'analyse HTTP et la bibliothèque Boost.Asio pour les entrées/sorties (I/O) réseau asynchrones.
  </para>

  <para>
   L'interface client Civetweb utilise la bibliothèque HTTP Civetweb, qui est un dérivé de Mongoose.
  </para>

  <para>
   Vous pouvez les configurer avec l'option <option>rgw_frontends</option>. Reportez-vous à la <xref linkend="config-ogw"/> pour obtenir une liste des options de configuration.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-https">
  <title>Activation de HTTPS/SSL pour les passerelles Object Gateway</title>

  <para>
   Pour activer la passerelle Object Gateway qui permet de communiquer en toute sécurité par le biais du protocole SSL, vous devez disposer d'un certificat émis par une autorité de certification ou créer un certificat auto-signé.
  </para>

  <sect2 xml:id="ogw-selfcert">
   <title>Création d'un certificat auto-signé</title>
   <tip>
    <para>
     Ignorez cette section si vous avez déjà un certificat valide signé par une autorité de certification.
    </para>
   </tip>
   <para>
    La procédure suivante décrit comment générer un certificat SSL auto-signé sur Salt Master.
   </para>
   <procedure>
    <step>
     <para>
      Si Object Gateway doit être connu par d'autres identités de sujet, ajoutez-les à l'option <option>sujetAltName</option> dans la section <literal>[v3_req]</literal> du fichier <filename>/etc/ssl/openssl.cnf</filename> :
     </para>
<screen>
[...]
[ v3_req ]
subjectAltName = DNS:server1.example.com DNS:server2.example.com
[...]
</screen>
     <tip>
      <title>adresses IP dans <option>subjectAltName</option></title>
      <para>
       Pour utiliser des adresses IP à la place de noms de domaine dans l'option <option>subjectAltName</option>, remplacez la ligne d'exemple par la suivante :
      </para>
<screen>
subjectAltName = IP:10.0.0.10 IP:10.0.0.11
</screen>
     </tip>
    </step>
    <step>
     <para>
      Créez la clé et le certificat à l'aide d'<command>openssl</command>. Entrez toutes les données que vous devez inclure dans votre certificat. Il est recommandé d'entrer le nom de domaine complet (FQDN) comme nom commun. Avant de signer le certificat, vérifiez que « X509v3 Subject Alternative Name: » est inclus dans les extensions requises et que « X509v3 Subject Alternative Name: » est défini dans le certificat généré.
     </para>
<screen>
<prompt>root@master # </prompt>openssl req -x509 -nodes -days 1095 \
 -newkey rsa:4096 -keyout rgw.key
 -out rgw.pem
</screen>
    </step>
    <step>
     <para>
      Ajoutez la clé à la fin du fichier de certificat :
     </para>
<screen>
<prompt>root@master # </prompt>cat rgw.key &gt;&gt; rgw.pem
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-sssl-config">
   <title>Configuration d'Object Gateway avec SSL</title>
   <para>
    Pour configurer Object Gateway afin d'utiliser des certificats SSL, utilisez l'option <option>rgw_frontends</option>. Par exemple :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph config set <replaceable>WHO</replaceable> rgw_frontends \
 beast ssl_port=443 ssl_certificate=config://<replaceable>CERT</replaceable> ssl_key=config://<replaceable>KEY</replaceable>
</screen>
   <para>
    Si vous ne spécifiez pas les clés de configuration <replaceable>CERT</replaceable> et <replaceable>KEY</replaceable>, le service Object Gateway recherche le certificat et la clé SSL sous les clés de configuration suivantes :
   </para>
<screen>
rgw/cert/<replaceable>RGW_REALM</replaceable>/<replaceable>RGW_ZONE</replaceable>.key
rgw/cert/<replaceable>RGW_REALM</replaceable>/<replaceable>RGW_ZONE</replaceable>.crt
</screen>
   <para>
    Si vous souhaitez remplacer l'emplacement par défaut de la clé et du certificat SSL, importez-les dans la base de données de configuration à l'aide de la commande suivante :
   </para>
<screen>ceph config-key set <replaceable>CUSTOM_CONFIG_KEY</replaceable> -i <replaceable>PATH_TO_CERT_FILE</replaceable></screen>
   <para>
    Utilisez ensuite vos clés de configuration personnalisées à l'aide de la directive <literal>config://</literal>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-sync">
  <title>Modules de synchronisation</title>

  <para>
   Object Gateway est déployé en tant que service multisite tandis que vous pouvez mettre en miroir des données et des métadonnées entre les zones. Les <emphasis>modules de synchronisation</emphasis> sont construits au sommet de la structure multisite qui permet de transmettre des données et des métadonnées à un niveau externe différent. Un module de synchronisation permet d'effectuer un ensemble d'opérations chaque fois qu'un changement se produit dans les données (par exemple, opérations de métadonnées telles que la création d'un compartiment ou d'un utilisateur). Comme les modifications multisite Object Gateway sont finalement cohérentes sur les sites distants, elles sont propagées de manière asynchrone. Cela couvre des cas d'utilisation tels que la sauvegarde du stockage d'objets sur une grappe cloud externe, une solution de sauvegarde personnalisée à l'aide de lecteurs de bande ou encore l'indexation de métadonnées dans ElasticSearch.
  </para>

  <sect2 xml:id="ogw-sync-general-config">
   <title>Configuration des modules de synchronisation</title>
   <para>
    Tous les modules de synchronisation sont configurés d'une manière similaire. Vous devez créer une zone (voir <xref linkend="ceph-rgw-fed"/> pour plus de détails) et définir son option <option>--tier_type</option>, par exemple <option>--tier-type=cloud</option>, pour le module de synchronisation cloud :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --endpoints=http://endpoint1.example.com,http://endpoint2.example.com, [...] \
 --tier-type=cloud
</screen>
   <para>
    Vous pouvez configurer le niveau spécifique à l'aide de la commande suivante :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=<replaceable>KEY1</replaceable>=<replaceable>VALUE1</replaceable>,<replaceable>KEY2</replaceable>=<replaceable>VALUE2</replaceable>
</screen>
   <para>
    <replaceable>KEY</replaceable> dans la configuration spécifie la variable de configuration que vous souhaitez mettre à jour et <replaceable>VALUE</replaceable> indique sa nouvelle valeur. Les valeurs imbriquées peuvent être accédées à l'aide d'un point. Par exemple :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=connection.access_key=<replaceable>KEY</replaceable>,connection.secret=<replaceable>SECRET</replaceable>
</screen>
   <para>
    Vous pouvez accéder aux entrées de tableau en ajoutant des crochets « [] » avec l'entrée référencée et vous pouvez ajouter une nouvelle entrée de tableau à l'aide de crochets « [] ». La valeur d'index -1 fait référence à la dernière entrée du tableau. Il n'est pas possible de créer une entrée et de la référencer à nouveau dans la même commande. Par exemple, une commande pour créer un profil pour les compartiments commençant par <replaceable>PREFIX</replaceable> se présenterait comme suit :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[].source_bucket=<replaceable>PREFIX</replaceable>'*'
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[-1].connection_id=<replaceable>CONNECTION_ID</replaceable>,profiles[-1].acls_id=<replaceable>ACLS_ID</replaceable>
</screen>
   <tip>
    <title>ajout et suppression d'entrées de configuration</title>
    <para>
     Vous pouvez ajouter une nouvelle entrée de configuration de niveau à l'aide du paramètre <option>--tier-config-add=<replaceable>KEY</replaceable>=<replaceable>VALUE</replaceable></option>.
    </para>
    <para>
     Vous pouvez supprimer une entrée existante à l'aide de <option>--tier-config-rm=<replaceable>KEY</replaceable></option>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-zones">
   <title>Synchronisation des zones</title>
   <para>
    Une configuration de module de synchronisation est locale pour une zone en particulier. Le module de synchronisation détermine si la zone exporte des données ou ne peut consommer que des données modifiées dans une autre zone. Depuis la version « Luminous », les plug-ins de synchronisation pris en charge sont <literal>ElasticSearch</literal>, <literal>rgw</literal> (qui est le plug-in de synchronisation par défaut des données entre les zones) et <literal>log</literal> (qui est un plug-in générique de synchronisation consignant les opérations de métadonnées entre zones distantes). Les sections suivantes s'appuient sur l'exemple d'une zone qui utilise le module de synchronisation <literal>ElasticSearch</literal>. Le processus serait similaire pour la configuration de tout autre plug-in de synchronisation.
   </para>
   <note>
    <title>plug-in de synchronisation par défaut</title>
    <para>
     <literal>rgw</literal> est le plug-in de synchronisation par défaut et il n'est pas nécessaire de le configurer explicitement.
    </para>
   </note>
   <sect3 xml:id="ceph-rgw-sync-zones-req">
    <title>Exigences et hypothèses</title>
    <para>
     Supposons que vous ayez la configuration multisite simple décrite à la <xref linkend="ceph-rgw-fed"/> et composée de deux zones : <literal>us-east</literal> et <literal>us-west</literal>. Maintenant, nous ajoutons une troisième zone <literal>us-east-es</literal>, qui traite uniquement les métadonnées des autres sites. Cette zone peut résider dans la même grappe Ceph ou dans une autre que <literal>us-east</literal>. Cette zone ne consommera que les métadonnées d'autres zones et les passerelles Object Gateway de cette zone ne serviront pas directement les requêtes des utilisateurs finaux.
    </para>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-zones-configure">
    <title>Configuration des zones</title>
    <procedure>
     <step>
      <para>
       Créez la troisième zone similaire à celles décrites dans la <xref linkend="ceph-rgw-fed"/>, par exemple :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone create --rgw-zonegroup=us --rgw-zone=us-east-es \
--access-key=<replaceable>SYSTEM-KEY</replaceable> --secret=<replaceable>SECRET</replaceable> --endpoints=http://rgw-es:80
      </screen>
     </step>
     <step>
      <para>
       Il est possible de configurer un module de synchronisation pour cette zone avec la commande suivante :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=<replaceable>TIER-TYPE</replaceable> \
--tier-config={set of key=value pairs}
      </screen>
     </step>
     <step>
      <para>
       Par exemple, dans le module de synchronisation <literal>ElasticSearch</literal> :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=elasticsearch \
--tier-config=endpoint=http://localhost:9200,num_shards=10,num_replicas=1
      </screen>
      <para>
       Pour les différentes options tier-config prises en charge, reportez-vous à la <xref linkend="ceph-rgw-sync-elastic"/>.
      </para>
     </step>
     <step>
      <para>
       Enfin, mettez à jour la période :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt><command>radosgw-admin</command> period update --commit
      </screen>
     </step>
     <step>
      <para>
       Démarrez ensuite la passerelle Object Gateway dans la zone :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch start rgw.<replaceable>REALM-NAME</replaceable>.<replaceable>ZONE-NAME</replaceable>
      </screen>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-elastic">
   <title>Module de synchronisation ElasticSearch</title>
   <para>
    Ce module de synchronisation écrit les métadonnées d'autres zones dans ElasticSearch. À partir de la version « Luminous », voici les champs de données JSON qui sont stockés dans ElasticSearch.
   </para>
<screen>
{
  "_index" : "rgw-gold-ee5863d6",
  "_type" : "object",
  "_id" : "34137443-8592-48d9-8ca7-160255d52ade.34137.1:object1:null",
  "_score" : 1.0,
  "_source" : {
    "bucket" : "testbucket123",
    "name" : "object1",
    "instance" : "null",
    "versioned_epoch" : 0,
    "owner" : {
      "id" : "user1",
      "display_name" : "user1"
    },
    "permissions" : [
      "user1"
    ],
    "meta" : {
      "size" : 712354,
      "mtime" : "2017-05-04T12:54:16.462Z",
      "etag" : "7ac66c0f148de9519b8bd264312c4d64"
    }
  }
}
   </screen>
   <sect3 xml:id="ceph-rgw-sync-elastic-config">
    <title>Paramètres de configuration du type de niveau ElasticSearch</title>
    <variablelist>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        Indique le noeud d'extrémité du serveur ElasticSearch auquel accéder.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_shards</term>
      <listitem>
       <para>
        <emphasis>(entier)</emphasis> Nombre de partitions avec lesquelles ElasticSearch sera configuré lors de l'initialisation de la synchronisation des données. Notez que cela ne peut pas être modifié après l'initialisation. Toute modification nécessite la reconstruction de l'index ElasticSearch et la réinitialisation du processus de synchronisation des données.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_replicas</term>
      <listitem>
       <para>
        <emphasis>(entier)</emphasis> Nombre de répliques avec lesquelles ElasticSearch sera configuré lors de l'initialisation de la synchronisation des données.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>explicit_custom_meta</term>
      <listitem>
       <para>
        <emphasis>(true | false)</emphasis> Indique si toutes les métadonnées personnalisées de l'utilisateur seront indexées ou si l'utilisateur devra configurer (au niveau compartiment) les entrées de métadonnées client à indexer. La valeur par défaut est « false ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>index_buckets_list</term>
      <listitem>
       <para>
        <emphasis>(liste de chaînes séparées par des virgules)</emphasis> Si elle est vide, tous les compartiments seront indexés. Dans le cas contraire, l'indexation portera uniquement sur les compartiments spécifiés ici. Il est possible de fournir des préfixes de compartiment (« foo * », par exemple) ou des suffixes de compartiment (« *bar », par exemple).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>approved_owners_list</term>
      <listitem>
       <para>
        <emphasis>(liste de chaînes séparées par des virgules)</emphasis> Si elle est vide, les compartiments de tous les propriétaires seront indexés (sous réserve d'autres restrictions) ; dans le cas contraire, l'indexation portera uniquement sur les compartiments appartenant aux propriétaires spécifiés. Il est également possible de définir des suffixes et des préfixes.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>override_index_path</term>
      <listitem>
       <para>
        <emphasis>(chaîne)</emphasis> Si elle n'est pas vide, cette chaîne sera utilisée comme chemin d'index ElasticSearch. Dans le cas contraire, le chemin d'index sera déterminé et généré lors de l'initialisation de la synchronisation.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>username</term>
      <listitem>
       <para>
        Spécifie un nom d'utilisateur pour ElasticSearch si l'authentification est nécessaire.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>password</term>
      <listitem>
       <para>
        Spécifie un mot de passe pour ElasticSearch si l'authentification est nécessaire.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-elastic-query">
    <title>Requêtes de métadonnées</title>
    <para>
     Étant donné que la grappe ElasticSearch stocke désormais les métadonnées d'objet, il est important que le noeud d'extrémité ElasticSearch ne soit pas exposé à tous les utilisateurs, mais accessible uniquement aux administrateurs de la grappe. L'exposition de requêtes de métadonnées à l'utilisateur final lui-même engendre un problème, car celui-ci doit interroger uniquement ses métadonnées et non pas celles des autres utilisateurs. Cette opération requiert que la grappe ElasticSearch authentifie les utilisateurs d'une manière similaire à RGW, ce qui pose problème.
    </para>
    <para>
     À partir de la version « Luminous » de RGW, la zone maître des métadonnées peut traiter les demandes des utilisateurs finaux. Cette approche présente l'avantage de masquer le noeud d'extrémité ElasticSearch pour le public et de résoudre le problème d'authentification et d'autorisation, puisque RGW peut authentifier lui-même les requêtes de l'utilisateur final. Dans cette optique, RGW introduit une nouvelle requête dans les API de compartiment pouvant desservir les requêtes ElasticSearch. Toutes ces requêtes doivent être envoyées à la zone maître de métadonnées.
    </para>
    <variablelist>
     <varlistentry>
      <term>Obtention d'une requête ElasticSearch</term>
      <listitem>
<screen>
GET /<replaceable>BUCKET</replaceable>?query=<replaceable>QUERY-EXPR</replaceable>
       </screen>
       <para>
        Paramètres de requête :
       </para>
       <itemizedlist>
        <listitem>
         <para>
          max-keys : nombre maximal d'entrées à renvoyer
         </para>
        </listitem>
        <listitem>
         <para>
          marker : marqueur de pagination
         </para>
        </listitem>
       </itemizedlist>
<screen>
expression := [(]&lt;arg&gt; &lt;op&gt; &lt;value&gt; [)][&lt;and|or&gt; ...]
       </screen>
       <para>
        op est l'un des opérateurs suivants : &lt;, &lt;=, ==, &gt;=, &gt;
       </para>
       <para>
        Par exemple :
       </para>
<screen>
GET /?query=name==foo
       </screen>
       <para>
        Renvoie toutes les clés indexées pour lesquelles l'utilisateur dispose d'une autorisation de lecture et qui s'appellent « foo ». Dans ce cas, la sortie se compose d'une liste XML de clés similaire à la sortie des compartiments de liste S3.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Configuration des champs de métadonnées personnalisés</term>
      <listitem>
       <para>
        Définissez quelles entrées de métadonnées personnalisées doivent être indexées (sous le compartiment indiqué) et précisez le type de ces clés. Si l'indexation explicite de métadonnées personnalisées est configurée, cette opération est nécessaire pour que rgw indexe les valeurs de ces métadonnées personnalisées. Dans le cas contraire, cette opération est nécessaire lorsque les clés de métadonnées indexées ne sont pas du type chaîne.
       </para>
<screen>
POST /<replaceable>BUCKET</replaceable>?mdsearch
x-amz-meta-search: &lt;key [; type]&gt; [, ...]
       </screen>
       <para>
        Les champs de métadonnées doivent être séparés les uns des autres par des virgules ; pour forcer le type d'un champ, indiquez « ; ». Les types actuellement autorisés sont « string » (chaîne - valeur par défaut), « integer » (entier) et « date ». Par exemple, si vous souhaitez indexer des métadonnées d'objet personnalisées x-amz-meta-year comme entier, x-amz-meta-date comme date et x-amz-meta-title comme chaîne, vous exécuteriez la commande suivante :
       </para>
<screen>
POST /mybooks?mdsearch
x-amz-meta-search: x-amz-meta-year;int, x-amz-meta-release-date;date, x-amz-meta-title;string
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Suppression de la configuration des métadonnées personnalisée</term>
      <listitem>
       <para>
        Supprimez la configuration de compartiment de métadonnées personnalisée.
       </para>
<screen>
DELETE /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Obtention de la configuration des métadonnées personnalisée</term>
      <listitem>
       <para>
        Récupérez la configuration de compartiment de métadonnées personnalisée.
       </para>
<screen>
GET /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-cloud-sync">
   <title>Module de synchronisation cloud</title>
   <para>
    Cette section présente un module qui synchronise les données de zone avec un service cloud distant. La synchronisation est unidirectionnelle : la date n'est pas resynchronisée à partir de la zone distante. L'objectif principal de ce module est de permettre la synchronisation des données auprès de plusieurs fournisseurs de services cloud. Actuellement, il prend en charge les fournisseurs de services cloud qui sont compatibles avec AWS (S3).
   </para>
   <para>
    Pour synchroniser les données auprès d'un service cloud distant, vous devez configurer les informations d'identification de l'utilisateur. Étant donné que de nombreux services cloud introduisent des limites sur le nombre de compartiments que chaque utilisateur peut créer, vous pouvez configurer l'assignation des objets et compartiments sources, des cibles différentes pour différents compartiments et des préfixes de compartiment. Notez que les listes d'accès (ACL) sources ne seront pas conservées. Il est possible d'assigner les autorisations d'utilisateurs sources spécifiques à des utilisateurs cibles spécifiques.
   </para>
   <para>
    En raison de limitations d'API, il n'existe aucun moyen de conserver l'heure de modification de l'objet d'origine ni la balise d'entité HTTP (Etag). Le module de synchronisation cloud enregistre ces informations sous forme d'attributs de métadonnées sur les objets cibles.
   </para>
   <sect3 xml:id="cloud-sync-module">
    <title>Configuration du module de synchronisation cloud</title>
    <para>
     Voici des exemples d'une configuration générique et non générique pour le module de synchronisation cloud. Notez que la configuration générique peut entrer en conflit avec la configuration non générique.
    </para>
    <example>
     <title>configuration générique</title>
<screen>
{
  "connection": {
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,
  },
  "acls": [ { "type": <replaceable>id | email | uri</replaceable>,
    "source_id": <replaceable>SOURCE_ID</replaceable>,
    "dest_id": <replaceable>DEST_ID</replaceable> } ... ],
  "target_path": <replaceable>TARGET_PATH</replaceable>,
}
</screen>
    </example>
    <example>
     <title>configuration non générique</title>
<screen>
{
  "default": {
    "connection": {
      "access_key": <replaceable>ACCESS</replaceable>,
      "secret": <replaceable>SECRET</replaceable>,
      "endpoint": <replaceable>ENDPOINT</replaceable>,
      "host_style" <replaceable>path | virtual</replaceable>,
    },
    "acls": [
    {
      "type": <replaceable>id | email | uri</replaceable>,   #  optional, default is id
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
    "target_path": <replaceable>PATH</replaceable> # optional
  },
  "connections": [
  {
    "connection_id": <replaceable>ID</replaceable>,
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,  # optional
  } ... ],
  "acl_profiles": [
  {
    "acls_id": <replaceable>ID</replaceable>, # acl mappings
    "acls": [ {
      "type": <replaceable>id | email | uri</replaceable>,
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
  }
  ],
  "profiles": [
  {
   "source_bucket": <replaceable>SOURCE</replaceable>,
   "connection_id": <replaceable>CONNECTION_ID</replaceable>,
   "acls_id": <replaceable>MAPPINGS_ID</replaceable>,
   "target_path": <replaceable>DEST</replaceable>,          # optional
  } ... ],
}
</screen>
    </example>
    <para>
     Voici l'explication des termes de configuration utilisés :
    </para>
    <variablelist>
     <varlistentry>
      <term>connection</term>
      <listitem>
       <para>
        Représente une connexion au service cloud distant. Contient les valeurs « connection_id », « access_key », « secret », « endpoint » et « host_style ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>access_key</term>
      <listitem>
       <para>
        Clé d'accès cloud distant qui sera utilisée pour la connexion spécifique.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>secret</term>
      <listitem>
       <para>
        Clé secrète du service cloud distant.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        URL du noeud d'extrémité du service cloud distant.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>host_style</term>
      <listitem>
       <para>
        Type de style hôte (« path » [chemin] ou « virtual » [virtuel]) à utiliser lors de l'accès au noeud d'extrémité cloud distant. La valeur par défaut est « path ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acls</term>
      <listitem>
       <para>
        Tableau des assignations de liste d'accès.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_mapping</term>
      <listitem>
       <para>
        Chaque structure « acl_mapping » contient les valeurs « type », « source_id » et « dest_id ». Celles-ci définissent la mutation ACL pour chaque objet. Une mutation ACL permet de convertir l'ID utilisateur source en ID cible.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>type</term>
      <listitem>
       <para>
        Type d'ACL : « id » définit l'identifiant utilisateur, « email » définit l'utilisateur à l'aide de son adresse électronique et « uri » définit l'utilisateur selon son URI (groupe).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>source_id</term>
      <listitem>
       <para>
        ID de l'utilisateur dans la zone source.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>dest_id</term>
      <listitem>
       <para>
        ID de l'utilisateur dans la destination.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>target_path</term>
      <listitem>
       <para>
        Chaîne qui définit la façon dont le chemin cible est créé. Le chemin cible spécifie un préfixe auquel le nom de l'objet source est ajouté. Les valeurs du chemin cible pouvant être configurées sont les variables suivantes :
       </para>
       <variablelist>
        <varlistentry>
         <term>SID</term>
         <listitem>
          <para>
           Chaîne unique qui représente l'ID d'instance de synchronisation.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP</term>
         <listitem>
          <para>
           Nom du groupe de zones.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP_ID</term>
         <listitem>
          <para>
           ID du groupe de zones.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE</term>
         <listitem>
          <para>
           Nom de la zone.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE_ID</term>
         <listitem>
          <para>
           ID de la zone.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>BUCKET</term>
         <listitem>
          <para>
           Nom du compartiment source.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>OWNER</term>
         <listitem>
          <para>
           ID du propriétaire du compartiment source.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        Par exemple : target_path = rgwx-<replaceable>ZONE</replaceable>-<replaceable>SID</replaceable>/<replaceable>OWNER</replaceable>/<replaceable>BUCKET</replaceable>
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profiles</term>
      <listitem>
       <para>
        Tableau des profils de listes d'accès.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profile</term>
      <listitem>
       <para>
        Chaque profil contient une valeur « acls_id » qui représentent le profil et un tableau « acls » qui reprend une liste des « acl_mappings ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>profiles</term>
      <listitem>
       <para>
        Liste des profils. Chaque profil contient les éléments suivants :
       </para>
       <variablelist>
        <varlistentry>
         <term>source_bucket</term>
         <listitem>
          <para>
           Nom ou préfixe (si se termine avec *) de compartiment qui définit le ou les compartiments sources de ce profil.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>target_path</term>
         <listitem>
          <para>
           Voir ci-dessus pour l'explication.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>connection_id</term>
         <listitem>
          <para>
           ID de la connexion qui sera utilisée pour ce profil.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>acls_id</term>
         <listitem>
          <para>
           ID du profil d'ACL qui sera utilisé pour ce profil.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="s3-specific-configurables">
    <title>Valeurs configurables spécifiques à S3</title>
    <para>
     Le module de synchronisation cloud fonctionne uniquement avec les interfaces dorsales compatibles avec AWS S3. Quelques valeurs configurables peuvent être utilisées pour modifier son comportement lors de l'accès aux services cloud S3 :
    </para>
<screen>
{
  "multipart_sync_threshold": <replaceable>OBJECT_SIZE</replaceable>,
  "multipart_min_part_size": <replaceable>PART_SIZE</replaceable>
}
</screen>
    <variablelist>
     <varlistentry>
      <term>multipart_sync_threshold</term>
      <listitem>
       <para>
        Les objets dont la taille est égale ou supérieure à cette valeur seront synchronisés avec le service cloud à l'aide du téléchargement en plusieurs parties.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>multipart_min_part_size</term>
      <listitem>
       <para>
        Taille minimale des parties à utiliser lors de la synchronisation d'objets à l'aide du téléchargement en plusieurs parties.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="archive-sync-module">
   <title>Module de synchronisation de l'archivage</title>
   <para>
    Le <emphasis>module de synchronisation de l'archivage</emphasis> utilise la fonction de contrôle de version des objets S3 dans Object Gateway. Vous pouvez configurer une <emphasis>zone d'archivage</emphasis> qui capture les différentes versions des objets S3 au fur et à mesure qu'elles apparaissent dans d'autres zones. L'historique des versions que la zone d'archivage conserve ne peut être éliminé que par le biais des passerelles associées à cette dernière.
   </para>
   <para>
    Avec une telle architecture, plusieurs zones sans contrôle de version peuvent mettre en miroir leurs données et métadonnées via leurs passerelles de zone de manière à offrir une haute disponibilité aux utilisateurs finaux, tandis que la zone d'archivage capture toutes les mises à jour de données pour les consolider en tant que versions d'objets S3.
   </para>
   <para>
    En incluant la zone d'archivage dans une configuration multizone, vous bénéficiez de la flexibilité d'un historique des objets S3 au sein d'une zone unique, tout en économisant l'espace que les répliques des objets S3 avec contrôle de version consommeraient dans les autres zones.
   </para>
   <sect3 xml:id="archive-sync-module-configuration">
    <title>Configuration du module de synchronisation de l'archivage</title>
    <tip>
     <title>pour en savoir plus</title>
     <para>
      Reportez-vous à la <xref linkend="ceph-rgw-fed"/> pour plus de détails sur la configuration des passerelles multisites.
     </para>
     <para>
      Reportez-vous à la <xref linkend="ceph-rgw-sync"/> pour plus de détails sur la configuration des modules de synchronisation.
     </para>
    </tip>
    <para>
     Pour utiliser le module de synchronisation de l'archivage, vous devez créer une zone dont le type de niveau est défini sur <literal>archive</literal> :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE_GROUP_NAME</replaceable> \
 --rgw-zone=<replaceable>OGW_ZONE_NAME</replaceable> \
 --endpoints=<replaceable>http://OGW_ENDPOINT1_URL[,http://OGW_ENDPOINT2_URL,...]</replaceable>
 --tier-type=archive
</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-ldap">
  <title>authentification LDAP</title>

  <para>
   Outre l'authentification par défaut des utilisateurs locaux, Object Gateway peut également utiliser les services du serveur LDAP pour authentifier les utilisateurs.
  </para>

  <sect2 xml:id="ceph-rgw-ldap-how-works">
   <title>Mécanisme d'authentification</title>
   <para>
    Object Gateway extrait les informations d'identification LDAP de l'utilisateur à partir d'un jeton. Un filtre de recherche est défini à partir du nom d'utilisateur. La passerelle Object Gateway utilise le compte de service configuré pour rechercher une entrée correspondante dans l'annuaire. Si une entrée est trouvée, la passerelle Object Gateway tente d'établir une liaison avec le nom distinctif trouvé et le mot de passe à partir du jeton. Si les informations d'identification sont valides, la liaison réussit et Object Gateway accorde l'accès.
   </para>
   <para>
    Vous pouvez limiter les utilisateurs autorisés en définissant la base de la recherche sur une unité organisationnelle spécifique ou en spécifiant un filtre de recherche personnalisé, qui, par exemple, exige l'appartenance à un groupe spécifique, des classes d'objets personnalisées ou des attributs.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-reqs">
   <title>Configuration requise</title>
   <itemizedlist>
    <listitem>
     <para>
      <emphasis>LDAP ou Active Directory</emphasis> : instance LDAP en cours d'exécution accessible par Object Gateway.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Compte de service</emphasis> : informations d'identification LDAP que la passerelle Object Gateway doit utiliser avec les autorisations de recherche.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Compte utilisateur</emphasis> : au moins un compte utilisateur dans l'annuaire LDAP.
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>différenciation des utilisateurs LDAP et des utilisateurs locaux</title>
    <para>
     Vous ne devez pas utiliser les mêmes noms d'utilisateur pour les utilisateurs locaux et les utilisateurs authentifiées à l'aide de LDAP. La passerelle Object Gateway ne peut pas les distinguer et les traite comme un même utilisateur.
    </para>
   </important>
   <tip>
    <title>contrôle d'intégrité</title>
    <para>
     Vérifiez le compte de service ou la connexion LDAP à l'aide de l'utilitaire <command>ldapsearch</command>. Par exemple :
    </para>
<screen><prompt>tux &gt; </prompt>ldapsearch -x -D "uid=ceph,ou=system,dc=example,dc=com" -W \
-H ldaps://example.com -b "ou=users,dc=example,dc=com" 'uid=*' dn</screen>
    <para>
     Veillez à utiliser les mêmes paramètres LDAP que dans le fichier de configuration Ceph pour éliminer les problèmes éventuels.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-config">
   <title>Configuration de la passerelle Object Gateway en vue de l'utilisation de l'authentification LDAP</title>
   <para>
    Les paramètres suivants sont liés à l'authentification LDAP :
   </para>
   <variablelist>
    <varlistentry>
     <term><option>rgw_ldap_uri</option></term>
     <listitem>
      <para>
       Indique le serveur LDAP à utiliser. Veillez à utiliser le paramètre <literal>ldaps://<replaceable>FQDN</replaceable>:<replaceable>PORT</replaceable></literal> afin d'éviter de transmettre les informations d'identification en texte brut sur une liaison non sécurisée.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_binddn</option></term>
     <listitem>
      <para>
       Nom distinctif (DN) du compte de service utilisé par Object Gateway.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_secret</option></term>
     <listitem>
      <para>
       Mot de passe du compte de service.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>rgw_ldap_searchdn</term>
     <listitem>
      <para>
       Indique la base dans l'arborescence des informations d'annuaire pour la recherche d'utilisateurs. Il peut s'agir de l'unité organisationnelle de vos utilisateurs ou d'une unité organisationnelle plus spécifique.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_dnattr</option></term>
     <listitem>
      <para>
       Attribut utilisé dans le filtre de recherche en vue de correspondre à un nom d'utilisateur. Il s'agit le plus souvent de <literal>uid</literal> ou <literal>cn</literal> selon votre arborescence d'annuaire.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_search_filter</option></term>
     <listitem>
      <para>
       Si cette information n'est pas indiquée, la passerelle Object Gateway s'appuie sur le paramètre <option>rgw_ldap_dnattr</option> pour définir automatiquement le filtre de recherche. Utilisez ce paramètre pour limiter librement la liste des utilisateurs autorisés. Reportez-vous à la <xref linkend="ceph-rgw-ldap-filter"/> pour plus d'informations.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-filter">
   <title>Utilisation d'un filtre de recherche personnalisé pour limiter l'accès des utilisateurs</title>
   <para>
    Il existe deux moyens d'utiliser le paramètre <option>rgw_search_filter</option>.
   </para>
   <sect3 xml:id="partial-filter-search-filter">
    <title>Filtre partiel de restriction supplémentaire du filtre de recherche construit</title>
    <para>
     Voici un exemple de filtre partiel :
    </para>
<screen>"objectclass=inetorgperson"</screen>
    <para>
     La passerelle Object Gateway génère le filtre de recherche comme d'habitude avec le nom d'utilisateur issu du jeton et la valeur de <option>rgw_ldap_dnattr</option>. Le filtre construit est ensuite combiné au filtre partiel à partir de l'attribut <option>rgw_search_filter</option>. En fonction du nom d'utilisateur et des paramètres, le filtre de recherche final peut devenir ce qui suit :
    </para>
<screen>"(&amp;(uid=hari)(objectclass=inetorgperson))"</screen>
    <para>
     Dans ce cas, l'utilisateur « hari » ne recevra un accès que s'il se trouve dans l'annuaire LDAP, possède la classe d'objets « inetorgperson » et a fourni un mot de passe valide.
    </para>
   </sect3>
   <sect3 xml:id="complete-filter">
    <title>Filtre complet</title>
    <para>
     Un filtre complet doit contenir un jeton <option>USERNAME</option> qui sera remplacé par le nom d'utilisateur lors de la tentative d'authentification. Le paramètre <option>rgw_ldap_dnattr</option> n'est plus utilisé dans ce cas. Par exemple, pour limiter les utilisateurs valides à un groupe spécifique, utilisez le filtre suivant :
    </para>
<screen>"(&amp;(uid=USERNAME)(memberOf=cn=ceph-users,ou=groups,dc=mycompany,dc=com))"</screen>
    <note>
     <title>attribut <literal>memberOf</literal></title>
     <para>
      L'utilisation de l'attribut <literal>memberOf</literal> dans les recherches LDAP requiert la prise en charge côté serveur dans votre implémentation de serveur LDAP spécifique.
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-token">
   <title>Génération d'un jeton d'accès pour l'authentification LDAP</title>
   <para>
    L'utilitaire <command>radosgw-token</command> génère le jeton d'accès basé sur le nom d'utilisateur et le mot de passe LDAP. Il génère une chaîne codée en base 64 correspondant au jeton d'accès physique. Utilisez votre client S3 favori (voir <xref linkend="accessing-ragos-gateway"/>) et spécifiez le jeton en tant que clé d'accès ainsi qu'une clé secrète vide.
   </para>
<screen><prompt>tux &gt; </prompt>export RGW_ACCESS_KEY_ID="<replaceable>USERNAME</replaceable>"
<prompt>tux &gt; </prompt>export RGW_SECRET_ACCESS_KEY="<replaceable>PASSWORD</replaceable>"
<prompt>cephuser@adm &gt; </prompt>radosgw-token --encode --ttype=ldap</screen>
   <important>
    <title>informations d'identification en texte clair</title>
    <para>
     Le jeton d'accès est une structure JSON codée en base 64 qui contient les informations d'identification LDAP en texte clair.
    </para>
   </important>
   <note>
    <title>Active Directory</title>
    <para>
     Pour Active Directory, utilisez le paramètre <option>--ttype=ad</option>.
    </para>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-bucket-sharding">
  <title>Partitionnement d'index de compartiment</title>

  <para>
   Object Gateway stocke les données d'index de compartiment dans une réserve d'index, par défaut <literal>.rgw.buckets.index</literal>. Si vous placez trop d'objets (plusieurs centaines de milliers) dans un même compartiment et que le quota du nombre maximal d'objets par compartiment (<option>rgw bucket default quota max objects</option>) n'est pas défini, les performances de la réserve d'index risquent de se dégrader. Le <emphasis>partitionnement d'index de compartiment</emphasis> maintient le niveau de performances et autorise un nombre élevé d'objets par compartiment.
  </para>

  <sect2 xml:id="ogw-bucket-reshard">
   <title>Repartitionnement d'index de compartiment</title>
   <para>
    Si un compartiment est devenu volumineux et que sa configuration initiale n'est plus suffisante, la réserve d'index du compartiment doit être redéfinie. Vous pouvez soit utiliser le repartitionnement d'index de compartiment en ligne automatique (voir <xref linkend="ogw-bucket-sharding-dyn"/>), soit repartitionner l'index de compartiment hors ligne manuellement (voir <xref linkend="ogw-bucket-sharding-re"/>).
   </para>
   <sect3 xml:id="ogw-bucket-sharding-dyn">
    <title>Repartitionnement dynamique</title>
    <para>
     Depuis la version 5 de SUSE Enterprise Storage, le repartitionnement de compartiments en ligne est pris en charge. Il vérifie si le nombre d'objets par compartiment atteint un certain seuil et augmente automatiquement le nombre de partitions utilisées par l'index de compartiment. Ce processus réduit le nombre d'entrées dans chaque partition d'index de compartiment.
    </para>
    <para>
     Le processus de détection s'exécute :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Lorsque les nouveaux objets sont ajoutés au compartiment.
      </para>
     </listitem>
     <listitem>
      <para>
       Dans un processus d'arrière-plan qui analyse périodiquement tous les compartiments. Cela est nécessaire pour traiter les compartiments existants qui ne sont pas mis à jour.
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Un compartiment devant être partitionné est ajouté à la file d'attente <option>reshard_log</option> en vue de son traitement ultérieur. Les threads de repartitionnement s'exécutent en arrière-plan et effectuent un repartitionnement planifié à la fois.
    </para>
    <variablelist>
     <title>Configuration du repartitionnement dynamique</title>
     <varlistentry>
      <term><option>rgw_dynamic_resharding</option></term>
      <listitem>
       <para>
        Active ou désactive le repartitionnement dynamique d'index de compartiment. Les valeurs admises sont « true » ou « false ». La valeur par défaut est « true ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_num_logs</option></term>
      <listitem>
       <para>
        Nombre de partitions pour le journal de repartitionnement. La valeur par défaut est 16.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_bucket_lock_duration</option></term>
      <listitem>
       <para>
        Durée de verrouillage sur l'objet Compartiment pendant le repartitionnement. La valeur par défaut est de 120 secondes.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_max_objs_per_shard</option></term>
      <listitem>
       <para>
        Nombre maximal d'objets par partition d'index de compartiment. La valeur par défaut est de 100 000 objets.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_thread_interval</option></term>
      <listitem>
       <para>
        Durée maximale entre deux exécutions du repartitionnement de threads. La valeur par défaut est de 600 secondes.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <variablelist>
     <title>Commandes d'administration du processus de repartitionnement</title>
     <varlistentry>
      <term>Ajouter un compartiment à la file d'attente du repartitionnement :</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard add \
 --bucket <replaceable>BUCKET_NAME</replaceable> \
 --num-shards <replaceable>NEW_NUMBER_OF_SHARDS</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Dresser la liste de la file d'attente de repartitionnement :</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard list
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Traiter/planifier un repartitionnement de compartiment :</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard process
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Afficher l'état du repartitionnement de compartiment :</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard status --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Annuler la mise en attente du repartitionnement de compartiment :</term>
      <listitem>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin reshard cancel --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ogw-bucket-sharding-re">
    <title>Repartitionnement manuel</title>
    <para>
     Le repartitionnement dynamique mentionné à la <xref linkend="ogw-bucket-sharding-dyn"/> est pris en charge uniquement pour les configurations Object Gateway simples. Pour les configurations multisites, utilisez le repartitionnement manuel décrit dans cette section.
    </para>
    <para>
     Pour repartitionner l'index de compartiment manuellement hors ligne, utilisez la commande suivante :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket reshard
</screen>
    <para>
     La commande <command>bucket reshard</command> effectue les opérations suivantes :
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Elle crée un nouvel ensemble d'objets d'index de compartiment pour l'objet spécifié.
      </para>
     </listitem>
     <listitem>
      <para>
       Elle propage toutes les entrées de ces objets d'index.
      </para>
     </listitem>
     <listitem>
      <para>
       Elle crée une nouvelle instance de compartiment.
      </para>
     </listitem>
     <listitem>
      <para>
       Elle lie la nouvelle occurrence de compartiment au compartiment afin que toutes les nouvelles opérations d'index passent par les nouveaux index de compartiment.
      </para>
     </listitem>
     <listitem>
      <para>
       Elle copie l'ancien ID et le nouvel ID de compartiment vers la sortie standard.
      </para>
     </listitem>
    </itemizedlist>
    <tip>
     <para>
      Lorsque vous choisissez un certain nombre de partitions, tenez compte des points suivants : visez un maximum de 100 000 entrées par partition. Les nombres premiers de partitions d'index de compartiment ont tendance à mieux répartir les entrées d'index de compartiment entre les partitions. Par exemple, 503 partitions d'index de compartiment fonctionnent mieux que 500 puisque 503 est un nombre premier.
     </para>
    </tip>
    <procedure>
     <title>Repartitionnement de l'index de compartiment</title>
     <step>
      <para>
       Assurez-vous que toutes les opérations à effectuer dans le compartiment sont bien arrêtées.
      </para>
     </step>
     <step>
      <para>
       Sauvegardez l'index de compartiment original :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bi list \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 &gt; <replaceable>BUCKET_NAME</replaceable>.list.backup
</screen>
     </step>
     <step>
      <para>
       Repartitionnez l'index de compartiment :
      </para>
<screen>
 <prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket reshard \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 --num-shards=<replaceable>NEW_SHARDS_NUMBER</replaceable>
</screen>
      <tip>
       <title>ancien ID de compartiment</title>
       <para>
        Dans le cadre de sa sortie, cette commande affiche également le nouvel ID et l'ancien ID du compartiment.
       </para>
      </tip>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-bucket-sharding-new">
   <title>Partitionnement d'index des nouveaux compartiments</title>
   <para>
    Deux options affectent le partitionnement d'index de compartiment :
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Utilisez l'option <option>rgw_override_bucket_index_max_shards</option> pour les configurations simples.
     </para>
    </listitem>
    <listitem>
     <para>
      Utilisez l'option <option>bucket_index_max_shards</option> pour les configurations multisites.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Définir les options sur <literal>0</literal> désactive le partitionnement d'index de compartiment. Une valeur supérieure à <literal>0</literal> active le partitionnement d'index de compartiment et définit le nombre maximal de partitions.
   </para>
   <para>
    La formule suivante permet de calculer le nombre recommandé de partitions :
   </para>
<screen>
number_of_objects_expected_in_a_bucket / 100000
</screen>
   <para>
    Sachez que le nombre maximal de partitions est 7877.
   </para>
   <sect3 xml:id="multisite-config-bucket">
    <title>Configurations multisites</title>
    <para>
     Les configurations multisites peuvent disposer d'une réserve d'index différente pour gérer le basculement. Pour configurer un nombre de partitions cohérent pour les zones d'un groupe de zones, définissez l'option <option>bucket_index_max_shards</option> dans la configuration du groupe de zones :
    </para>
    <procedure>
     <step>
      <para>
       Exportez la configuration du groupe de zones dans le fichier <filename>zonegroup.json</filename> :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup get &gt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Modifiez le fichier <filename>zonegroup.json</filename> et définissez l'option <option>bucket_index_max_shards</option> pour chaque zone nommée.
      </para>
     </step>
     <step>
      <para>
       Réinitialisez le groupe de zones :
      </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup set &lt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Mettez à jour la période. Reportez-vous à la <xref linkend="ceph-rgw-fed-masterzone-updateperiod"/>.
      </para>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-keystone">
  <title>Intégration à OpenStack Keystone</title>

  <para>
   OpenStack Keystone est un service d'identité pour le produit OpenStack. Vous pouvez intégrer la passerelle Object Gateway à Keystone pour configurer une passerelle qui accepte un jeton d'authentification Keystone. Un utilisateur autorisé par Keystone à accéder à la passerelle est vérifié du côté de Ceph Object Gateway et créé automatiquement, si nécessaire. Object Gateway interroge Keystone périodiquement pour obtenir la liste des jetons révoqués.
  </para>

  <sect2 xml:id="ogw-keystone-ostack">
   <title>Configuration d'OpenStack</title>
   <para>
    Avant de configurer la passerelle Ceph Object Gateway, vous devez configurer OpenStack Keystone afin d'activer le service Swift et de le faire pointer vers la passerelle Ceph Object Gateway :
   </para>
   <procedure>
    <step>
     <para>
      <emphasis>Définissez le service Swift.</emphasis> Pour utiliser OpenStack en vue de la validation des utilisateurs Swift, créez d'abord le service Swift :
     </para>
<screen>
<prompt>tux &gt; </prompt>openstack service create \
 --name=swift \
 --description="Swift Service" \
 object-store
</screen>
    </step>
    <step>
     <para>
      <emphasis>Définissez les noeuds d'extrémité.</emphasis> Après avoir créé le service Swift, pointez vers la passerelle Ceph Object Gateway. Remplacez <replaceable>REGION_NAME</replaceable> par le nom du groupe de zones ou de la région de la passerelle.
     </para>
<screen>
<prompt>tux &gt; </prompt>openstack endpoint create --region <replaceable>REGION_NAME</replaceable> \
 --publicurl   "http://radosgw.example.com:8080/swift/v1" \
 --adminurl    "http://radosgw.example.com:8080/swift/v1" \
 --internalurl "http://radosgw.example.com:8080/swift/v1" \
 swift
</screen>
    </step>
    <step>
     <para>
      <emphasis>Vérifiez les paramètres.</emphasis> Après avoir créé le service Swift et défini les noeuds d'extrémité, affichez ceux-ci pour vérifier que tous les paramètres sont corrects.
     </para>
<screen>
<prompt>tux &gt; </prompt>openstack endpoint show object-store
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-keystone-ogw">
   <title>Configuration de la passerelle Ceph Object Gateway</title>
   <sect3>
    <title>Configuration des certificats SSL</title>
    <para>
     Ceph Object Gateway interroge Keystone périodiquement pour obtenir la liste des jetons révoqués. Ces requêtes sont codées et signées. Il est également possible de configurer Keystone pour fournir des jetons signés automatiquement, qui sont aussi codés et signés. Vous devez configurer la passerelle afin qu'elle puisse décoder et vérifier ces messages signés. Par conséquent, les certificats OpenSSL que Keystone utilise pour créer les requêtes doivent être convertis au format « nss db » :
    </para>
<screen>
<prompt role="root">root # </prompt>mkdir /var/ceph/nss
<prompt role="root">root # </prompt>openssl x509 -in /etc/keystone/ssl/certs/ca.pem \
 -pubkey | certutil -d /var/ceph/nss -A -n ca -t "TCu,Cu,Tuw"
<systemitem class="username">root</systemitem>openssl x509 -in /etc/keystone/ssl/certs/signing_cert.pem \
 -pubkey | certutil -A -d /var/ceph/nss -n signing_cert -t "P,P,P"
</screen>
    <para>
     Pour permettre à Ceph Object Gateway d'interagir avec OpenStack Keystone, ce dernier peut utiliser un certificat SSL auto-signé. Installez le certificat SSL de Keystone sur le noeud exécutant Ceph Object Gateway ou définissez l'option <option>rgw keystone verify ssl</option> sur « false ». Définir <option>rgw keystone verify ssl</option> sur « false » signifie que la passerelle ne tentera pas de vérifier le certificat.
    </para>
   </sect3>
   <sect3 xml:id="config-ogw-options">
    <title>Configuration des options de la passerelle Object Gateway</title>
    <para>
     Vous pouvez configurer l'intégration de Keystone à l'aide des options suivantes :
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone api version</option></term>
      <listitem>
       <para>
        Version de l'API Keystone. Les options valides sont 2 ou 3. La valeur par défaut est 2.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone url</option></term>
      <listitem>
       <para>
        URL et numéro de port de l'API RESTful d'administration sur le serveur Keystone. Suit le modèle <replaceable>URL_SERVEUR:NUMÉRO_PORT</replaceable>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin token</option></term>
      <listitem>
       <para>
        Jeton ou secret partagé qui est configuré en interne dans Keystone pour les requêtes d'administration.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted roles</option></term>
      <listitem>
       <para>
        Rôles nécessaires pour répondre aux requêtes. Par défaut « Member, admin ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted admin roles</option></term>
      <listitem>
       <para>
        Liste des rôles autorisant un utilisateur à obtenir des privilèges d'administration.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone token cache size</option></term>
      <listitem>
       <para>
        Nombre maximal d'entrées dans le cache de jetons Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone revocation interval</option></term>
      <listitem>
       <para>
        Nombre de secondes avant le contrôle de jetons révoqués. Par défaut, 15 * 60.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone implicit tenants</option></term>
      <listitem>
       <para>
        Créez des utilisateurs dans leurs locataires du même nom. La valeur par défaut est « false ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw s3 auth use keystone</option></term>
      <listitem>
       <para>
        Si ce paramètre est défini sur « false », Ceph Object Gateway authentifie les utilisateurs à l'aide de Keystone. La valeur par défaut est « false ».
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>nss db path</option></term>
      <listitem>
       <para>
        Chemin d'accès à la base de données NSS.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Il est également possible de configurer le locataire du service Keystone, le nom d'utilisateur et le mot de passe Keystone (pour la version 2.0 de l'API Identity OpenStack) d'une façon similaire aux services OpenStack. De cette façon, vous pouvez éviter de définir le secret partagé <option>rgw keystone admin token</option> dans le fichier de configuration, qui doit être désactivé dans les environnements de production. Les informations d'identification du locataire du service doivent disposer de privilèges d'administration. Pour plus de détails, reportez-vous à la <link xlink:href="https://docs.openstack.org/keystone/latest/#setting-up-projects-users-and-roles">documentation officielle OpenStack Keystone</link>. Les options de configuration associées sont les suivantes :
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin user</option></term>
      <listitem>
       <para>
        Nom d'utilisateur de l'administrateur Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin password</option></term>
      <listitem>
       <para>
        Mot de passe de l'administrateur Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin tenant</option></term>
      <listitem>
       <para>
        Locataire de l'utilisateur administrateur Keystone version 2.0.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Un utilisateur Ceph Object Gateway est assigné à un locataire Keystone. Un utilisateur Keystone possède plusieurs rôles qui lui sont assignés, sur plusieurs locataires, le cas échéant. Lorsque la passerelle Ceph Object Gateway reçoit le ticket, elle examine le locataire et les rôles utilisateur qui lui sont attribués, et elle accepte ou rejette la demande en fonction de la valeur de l'option <option>rgw keystone accepted roles</option>.
    </para>
    <tip>
     <title>assignation aux locataires OpenStack</title>
     <para>
      Les locataires Swift sont assignés à l'utilisateur Object Gateway par défaut, mais peuvent l'être également aux locataires OpenStack grâce à l'option <option>rgw keystone implicit tenants</option>. Les conteneurs utiliseront alors l'espace de noms du locataire à la place de l'espace de noms global S3 associé par défaut à Object Gateway. Il est recommandé de choisir la méthode d'assignation au stade de la planification afin d'éviter toute confusion. En effet, l'affectation ultérieure de l'option concerne uniquement les requêtes plus récentes qui sont alors assignées sous un locataire, alors que les compartiments créés précédemment continuent à résider dans un espace de noms global.
     </para>
    </tip>
    <para>
     Pour la version 3 de l'API Identity OpenStack, vous devez remplacer l'option <option>rgw keystone admin tenant</option> par :
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin domain</option></term>
      <listitem>
       <para>
        Domaine de l'utilisateur administrateur Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin project</option></term>
      <listitem>
       <para>
        Projet de l'utilisateur administrateur Keystone.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-storage-classes">
  <title>Placement de réserve et classes de stockage</title>

  <sect2 xml:id="ogw-storage-classes-placement-targets">
   <title>Affichage des cibles de placement</title>
   <para>
    Les cibles de placement contrôlent les réserves associées à un compartiment particulier. La cible de placement d'un compartiment est sélectionnée lors de la création et ne peut pas être modifiée. Vous pouvez afficher son paramètre <literal>placement_rule</literal> en exécutant la commande suivante :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin bucket stats
</screen>
   <para>
    La configuration du groupe de zones contient une liste de cibles de placement avec une cible initiale nommée « default-placement ». La configuration de la zone assigne ensuite le nom de la cible de placement de chaque groupe de zones à son stockage local. Ces informations de placement de zone incluent le nom « index_pool » pour l'index de compartiment, le nom « data_extra_pool » pour les métadonnées sur les téléchargements multiparties incomplets et un nom « data_pool » pour chaque classe de stockage.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-itself">
   <title>Classes de stockage</title>
   <para>
    Les classes de stockage aident à personnaliser le placement des données d'objets. Les règles de cycle de vie de compartiment S3 peuvent automatiser la transition des objets entre les classes de stockage.
   </para>
   <para>
    Les classes de stockage sont définies en fonction des cibles de placement. Chaque cible de placement de groupe de zones répertorie ses classes de stockage disponibles avec une classe initiale nommée « STANDARD ». La configuration de zone fournit un nom de réserve « data_pool » pour chacune des classes de stockage du groupe de zones.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-zone-config">
   <title>Configuration des groupes de zones et des zones</title>
   <para>
    Utilisez la commande <command>radosgw-admin</command> sur les groupes de zones et les zones pour configurer leur placement. Vous pouvez interroger la configuration du placement de groupe de zones à l'aide de la commande suivante :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup get
{
    "id": "ab01123f-e0df-4f29-9d71-b44888d67cd5",
    "name": "default",
    "api_name": "default",
    ...
    "placement_targets": [
        {
            "name": "default-placement",
            "tags": [],
            "storage_classes": [
                "STANDARD"
            ]
        }
    ],
    "default_placement": "default-placement",
    ...
}
</screen>
   <para>
    Pour interroger la configuration du placement de zone, exécutez la commande suivante :
   </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone get
{
    "id": "557cdcee-3aae-4e9e-85c7-2f86f5eddb1f",
    "name": "default",
    "domain_root": "default.rgw.meta:root",
    ...
    "placement_pools": [
        {
            "key": "default-placement",
            "val": {
                "index_pool": "default.rgw.buckets.index",
                "storage_classes": {
                    "STANDARD": {
                        "data_pool": "default.rgw.buckets.data"
                    }
                },
                "data_extra_pool": "default.rgw.buckets.non-ec",
                "index_type": 0
            }
        }
    ],
    ...
}
</screen>
   <note>
    <title>aucune configuration multisite précédente</title>
    <para>
     Si vous n'avez effectué aucune configuration multisite auparavant, le système crée pour vous une zone et un groupe de zones « default » (par défaut). Les modifications apportées à cette zone/ce groupe de zones ne prennent effet qu'après avoir redémarré les passerelles Ceph Object Gateway. Si vous avez créé un domaine Kerberos pour plusieurs sites, les modifications de zone/groupe de zones entrent en vigueur une fois que vous les avez validées avec la commande <command>radosgw-admin period update --commit</command>.
    </para>
   </note>
   <sect3 xml:id="adding-placement-target">
    <title>Ajout d'une cible de placement</title>
    <para>
     Pour créer une cible de placement nommée « temporary », commencez par l'ajouter au groupe de zones :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id temporary
</screen>
    <para>
     Ensuite, fournissez les informations de placement de zone pour cette cible :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id temporary \
      --data-pool default.rgw.temporary.data \
      --index-pool default.rgw.temporary.index \
      --data-extra-pool default.rgw.temporary.non-ec
</screen>
   </sect3>
   <sect3 xml:id="adding-storage-class">
    <title>Ajout d'une classe de stockage</title>
    <para>
     Pour ajouter une nouvelle classe de stockage nommée « COLD » à la cible « default-placement », commencez par l'ajouter au groupe de zones :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id default-placement \
      --storage-class COLD
</screen>
    <para>
     Ensuite, fournissez les informations de placement de zone pour cette classe de stockage :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id default-placement \
      --storage-class COLD \
      --data-pool default.rgw.cold.data \
      --compression lz4
</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-customizing-placement">
   <title>Personnalisation du placement</title>
   <sect3 xml:id="edit-default-zgroup-placement">
    <title>Modification du placement des groupes de zones par défaut</title>
    <para>
     Par défaut, les nouveaux compartiments utilisent la cible <literal>default_placement</literal> du groupe de zones. Vous pouvez modifier ce paramètre de groupe de zones avec la commande suivante :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup placement default \
      --rgw-zonegroup default \
      --placement-id new-placement
</screen>
   </sect3>
   <sect3 xml:id="edit-default-user-placement">
    <title>Modification du placement par défaut de l'utilisateur</title>
    <para>
     Un utilisateur de Ceph Object Gateway peut remplacer la cible de placement par défaut du groupe de zones en définissant un champ <literal>default_placement</literal> non vide dans les informations utilisateur. De même, la valeur <literal>default_storage_class</literal> peut remplacer la classe de stockage <option>STANDARD</option> appliquée aux objets par défaut.
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin user info --uid testid
{
    ...
    "default_placement": "",
    "default_storage_class": "",
    "placement_tags": [],
    ...
}
</screen>
    <para>
     Si la cible de placement d'un groupe de zones contient des balises, les utilisateurs ne seront pas en mesure de créer des compartiments avec cette cible de placement, excepté si leurs informations utilisateur contiennent au moins une balise correspondante dans leur champ « placement_tags ». Cela peut être utile pour restreindre l'accès à certains types de stockage.
    </para>
    <para>
     La commande <command>radosgw-admin</command> ne peut pas modifier ces champs directement, raison pour laquelle vous devez modifier manuellement le format JSON :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>radosgw-admin metadata get user:<replaceable>USER-ID</replaceable> &gt; user.json
<prompt>tux &gt; </prompt>vi user.json     # edit the file as required
<prompt>cephuser@adm &gt; </prompt>radosgw-admin metadata put user:<replaceable>USER-ID</replaceable> &lt; user.json
</screen>
   </sect3>
   <sect3 xml:id="s3-bucket-default-placement">
    <title>Modification du placement du compartiment par défaut S3</title>
    <para>
     Lors de la création d'un compartiment avec le protocole S3, une cible de placement peut être fournie dans le cadre de l'option <option>LocationConstraint</option> pour remplacer les cibles de placement par défaut de l'utilisateur et du groupe de zones.
    </para>
    <para>
     Normalement, l'option <option>LocationConstraint</option> doit correspondre à la valeur <option>api_name</option> du groupe de zones :
    </para>
<screen>&lt;LocationConstraint&gt;default&lt;/LocationConstraint&gt;</screen>
    <para>
     Vous pouvez ajouter une cible de placement personnalisée à la valeur <option>api_name</option> en insérant à sa suite un caractère « : » suivi de la cible :
    </para>
<screen>&lt;LocationConstraint&gt;default:new-placement&lt;/LocationConstraint&gt;</screen>
   </sect3>
   <sect3 xml:id="swift-default-bucket-placement">
    <title>Modification du placement du compartiment Swift</title>
    <para>
     Lorsque vous créez un compartiment avec le protocole Swift, vous pouvez fournir une cible de placement dans l'option <literal>X-Storage-Policy</literal> de l'en-tête HTTP :
    </para>
<screen>X-Storage-Policy: <replaceable>NEW-PLACEMENT</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-usage">
   <title>Utilisation des classes de stockage</title>
   <para>
    Toutes les cibles de placement ont une classe de stockage <option>STANDARD</option> qui est appliquée par défaut aux nouveaux objets. Vous pouvez remplacer cette valeur par défaut avec son option <literal>default_storage_class</literal>.
   </para>
   <para>
    Pour créer un objet dans une classe de stockage autre que celle par défaut, spécifiez le nom de cette classe de stockage dans un en-tête HTTP avec la requête. Le protocole S3 utilise l'en-tête <literal>X-Amz-Storage-Class</literal>, tandis que le protocole Swift utilise l'en-tête <literal>X-Object-Storage-Class</literal>.
   </para>
   <para>
    Vous pouvez utiliser la fonction de gestion du cycle de vie des objets S3 (<emphasis>S3 Object Lifecycle Management</emphasis>) pour déplacer les données d'objets entre les classes de stockage à l'aide d'opérations <option>Transition</option>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-fed">
  <title>Passerelles Object Gateway multisites</title>

  <para>
   Ceph prend en charge plusieurs options de configuration multisite pour la passerelle Ceph Object Gateway :
  </para>

  <variablelist>
   <varlistentry>
    <term>Multizone</term>
    <listitem>
     <para>
      Configuration composée d'un groupe de zones et de plusieurs zones, chacune d'elles présentant une ou plusieurs instances <systemitem class="daemon">ceph-radosgw</systemitem>. Chaque zone est soutenue par sa propre grappe de stockage Ceph. Plusieurs zones au sein d'un groupe fournissent une reprise après sinistre pour le groupe de zones en cas de défaillance importante de l'une d'elles. Chaque zone est active et peut recevoir des opérations d'écriture. Outre la reprise après sinistre, plusieurs zones actives peuvent également servir de base aux réseaux de distribution de contenu.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Groupe multizone</term>
    <listitem>
     <para>
      Ceph Object Gateway prend en charge plusieurs groupes de zones, chacun d'entre eux comportant une ou plusieurs zones. Les objets stockés dans les zones d'un groupe de zones inclus dans le même domaine qu'un autre groupe de zones partagent un espace de noms d'objet global, ce qui permet de garantir l'unicité des ID d'objet dans les groupes de zones et les zones.
     </para>
     <note>
      <para>
       Il est important de noter que les groupes de zones synchronisent <emphasis>uniquement</emphasis> les métadonnées entre eux. Les données et les métadonnées sont répliquées entre les zones du groupe de zones. Aucune donnée ou métadonnée n'est partagée dans un domaine.
      </para>
     </note>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Plusieurs domaines</term>
    <listitem>
     <para>
      Ceph Object Gateway prend en charge la notion de domaines ; un espace de noms globalement unique. Plusieurs domaines sont pris en charge et peuvent englober un ou plusieurs groupes de zones.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Vous pouvez configurer chaque passerelle Object Gateway pour qu'elle fonctionne dans une configuration de zone active-active, ce qui permet d'écrire dans des zones non maîtres. La configuration multisite est stockée dans un conteneur appelé domaine. Le domaine stocke des groupes de zones, des zones et une période avec plusieurs époques pour le suivi des modifications apportées à la configuration. Les daemons <systemitem class="daemon">rgw</systemitem> gèrent la synchronisation, ce qui élimine le besoin d'un agent de synchronisation distinct. Cette approche de la synchronisation permet à la passerelle Ceph Object Gateway de fonctionner avec une configuration active-active plutôt qu'active-passive.
  </para>

  <sect2 xml:id="ceph-rgw-multi-req-assump">
   <title>Exigences et hypothèses</title>
   <para>
    Une configuration multisite nécessite au moins deux grappes de stockage Ceph et au moins deux instances Ceph Object Gateway, une pour chaque grappe de stockage Ceph. Dans la configuration suivante, au moins deux grappes de stockage Ceph doivent être situées dans des emplacements géographiquement distincts. Cependant, la configuration peut fonctionner sur le même site. Par exemple, sous les noms <literal>rgw1</literal> et <literal>rgw2</literal>.
   </para>
   <para>
    Une configuration multisite nécessite un groupe de zones maître et une zone maître. Une zone maître est une source fiable pour toutes les opérations de métadonnées dans une grappe multisite. En outre, chaque groupe de zones nécessite une zone maître. Les groupes de zones peuvent avoir une ou plusieurs zones secondaires ou non maîtres. Dans ce guide, l'hôte <literal>rgw1</literal> fait office de zone maître du groupe de zones maître et l'hôte <literal>rgw2</literal> sert de zone secondaire du groupe de zones maître.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-config-master-zone">
   <title>Configuration d'une zone maître</title>
   <para>
    Toutes les passerelles d'une configuration multisite récupèrent leur configuration à partir d'un daemon <systemitem class="daemon">ceph-radosgw</systemitem> sur un hôte au sein du groupe de zones maître et de la zone maître. Pour configurer vos passerelles dans une configuration multisite, sélectionnez une instance <systemitem class="daemon">ceph-radosgw</systemitem> pour configurer le groupe de zones maître et la zone maître.
   </para>
   <sect3 xml:id="ceph-rgw-fed-realm">
    <title>Création d'un domaine</title>
    <para>
     Un domaine représente un espace de noms globalement unique constitué d'un ou de plusieurs groupes de zones contenant une ou plusieurs zones. Les zones comportent des compartiments qui, à leur tour, contiennent des objets. Un domaine permet à Ceph Object Gateway de prendre en charge plusieurs espaces de noms et leur configuration sur le même matériel. Un domaine contient la notion de périodes. Chaque période représente l'état de la configuration du groupe de zones et de la zone dans le temps. Chaque fois que vous apportez une modification à un groupe de zones ou à une zone, mettez à jour la période et validez-la. Par défaut, la passerelle Ceph Object Gateway ne crée pas de domaine pour des raisons de compatibilité avec les versions précédentes. Il est recommandé de créer des domaines pour les nouvelles grappes.
    </para>
    <para>
     Créez un nouveau domaine appelé <literal>gold</literal> pour la configuration multisite en ouvrant une interface de ligne de commande sur un hôte identifié pour desservir le groupe de zones et la zone maîtres. Ensuite, exécutez la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm create --rgw-realm=gold --default</screen>
    <para>
     Si la grappe a un seul domaine, spécifiez l'indicateur <option>--default</option>. Si l'indicateur <option>--default</option> est spécifié, <command>radosgw-admin</command> utilise ce domaine par défaut. Si l'indicateur <option>--default</option> n'est pas spécifié, l'ajout de groupes de zones et de zones nécessite la spécification de l'indicateur <option>--rgw-realm</option> ou <option>--realm-id</option> pour identifier le domaine lors de l'ajout de groupes de zones et de zones.
    </para>
    <para>
     Une fois le domaine créé, <command>radosgw-admin</command> renvoie la configuration du domaine :
    </para>
<screen>
{
  "id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "name": "gold",
  "current_period": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "epoch": 1
}</screen>
    <note>
     <para>
      Ceph génère un ID unique pour le domaine, ce qui permet de renommer un domaine, le cas échéant.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-createmasterzonegrp">
    <title>Création d'un groupe de zones maître</title>
    <para>
     Un domaine doit compter au moins un groupe de zones maître. Créez un groupe de zones maître pour la configuration multisite en ouvrant une interface de ligne de commande sur un hôte identifié pour desservir le groupe de zones et la zone maîtres. Créez un groupe de zones maître appelé <literal>us</literal> en exécutant la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup create --rgw-zonegroup=us \
--endpoints=http://rgw1:80 --master --default</screen>
    <para>
     Si le domaine ne comporte qu'un seul groupe de zones, spécifiez l'indicateur <option>--default</option>. Si l'indicateur <option>--default</option> est spécifié, <command>radosgw-admin</command> utilise ce groupe de zones par défaut lors de l'ajout de nouvelles zones. Si l'indicateur <option>--default</option> n'est pas spécifié, l'ajout de zones nécessite l'indicateur <option>--rgw-zonegroup</option> ou <option>--zonegroup-id</option> pour identifier le groupe de zones lors de l'ajout ou de la modification de zones.
    </para>
    <para>
     Une fois le groupe de zones maître créé, <command>radosgw-admin</command> renvoie la configuration du groupe de zones. Par exemple :
    </para>
<screen>{
 "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
 "name": "us",
 "api_name": "us",
 "is_master": "true",
 "endpoints": [
     "http:\/\/rgw1:80"
 ],
 "hostnames": [],
 "hostnames_s3website": [],
 "master_zone": "",
 "zones": [],
 "placement_targets": [],
 "default_placement": "",
 "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
}</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone">
    <title>Création d'une zone maître</title>
    <important>
     <para>
      Les zones doivent être créées sur un noeud Ceph Object Gateway qui se situe dans la zone.
     </para>
    </important>
    <para>
     Créez une zone maître pour la configuration multisite en ouvrant une interface de ligne de commande sur un hôte identifié pour desservir le groupe de zones et la zone maîtres. Exécutez la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --rgw-zone=us-east-1 \
--endpoints=http://rgw1:80 --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>SYSTEM_SECRET_KEY</replaceable></screen>
    <note>
     <para>
      Les options <option>--access-key</option> et <option>--secret</option> ne sont pas spécifiées dans l'exemple ci-dessus. Ces paramètres sont ajoutés à la zone lorsque l'utilisateur est créé dans la section suivante.
     </para>
    </note>
    <para>
     Une fois la zone maître créée, <command>radosgw-admin</command> renvoie la configuration de la zone. Par exemple :
    </para>
<screen>
  {
      "id": "56dfabbb-2f4e-4223-925e-de3c72de3866",
      "name": "us-east-1",
      "domain_root": "us-east-1.rgw.meta:root",
      "control_pool": "us-east-1.rgw.control",
      "gc_pool": "us-east-1.rgw.log:gc",
      "lc_pool": "us-east-1.rgw.log:lc",
      "log_pool": "us-east-1.rgw.log",
      "intent_log_pool": "us-east-1.rgw.log:intent",
      "usage_log_pool": "us-east-1.rgw.log:usage",
      "reshard_pool": "us-east-1.rgw.log:reshard",
      "user_keys_pool": "us-east-1.rgw.meta:users.keys",
      "user_email_pool": "us-east-1.rgw.meta:users.email",
      "user_swift_pool": "us-east-1.rgw.meta:users.swift",
      "user_uid_pool": "us-east-1.rgw.meta:users.uid",
      "otp_pool": "us-east-1.rgw.otp",
      "system_key": {
          "access_key": "1555b35654ad1656d804",
          "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
      },
      "placement_pools": [
          {
              "key": "us-east-1-placement",
              "val": {
                  "index_pool": "us-east-1.rgw.buckets.index",
                  "storage_classes": {
                      "STANDARD": {
                          "data_pool": "us-east-1.rgw.buckets.data"
                      }
                  },
                  "data_extra_pool": "us-east-1.rgw.buckets.non-ec",
                  "index_type": 0
              }
          }
      ],
      "metadata_heap": "",
      "realm_id": ""
  }</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-deldefzonegrp">
    <title>Suppression de la zone et du groupe par défaut</title>
    <important>
     <para>
      Les étapes suivantes supposent une configuration multisite utilisant des systèmes nouvellement installés qui ne stockent pas encore de données. <emphasis role="bold">Ne supprimez pas</emphasis> la zone par défaut et ses réserves si vous les utilisez déjà pour stocker des données, sinon les données seront supprimées et irrécupérables.
     </para>
    </important>
    <para>
     L'installation par défaut d'Object Gateway crée le groupe de zones par défaut appelé <literal>default</literal>. Supprimez la zone par défaut si elle existe. Veillez à la supprimer d'abord du groupe de zones par défaut.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zonegroup delete --rgw-zonegroup=default</screen>
    <para>
     Supprimez les réserves par défaut de votre grappe de stockage Ceph si elles existent :
    </para>
    <important>
     <para>
      L'étape suivante suppose une configuration multisite utilisant des systèmes nouvellement installés qui ne contiennent actuellement pas de données. <emphasis role="bold">Ne supprimez pas</emphasis> le groupe de zones par défaut si vous l'utilisez déjà pour stocker des données.
     </para>
    </important>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.meta default.rgw.meta --yes-i-really-really-mean-it</screen>
    <warning>
     <para>
      La suppression du groupe de zones par défaut entraîne celle de l'utilisateur système. Si vos clés d'administrateur ne sont pas propagées, la fonctionnalité de gestion d'Object Gateway de Ceph Dashboard ne fonctionnera pas. Passez à la section suivante pour recréer votre utilisateur système si vous poursuivez cette étape.
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-createuser">
    <title>Création d'utilisateurs système</title>
    <para>
     Les daemons <systemitem class="daemon">ceph-radosgw</systemitem> doivent s'authentifier avant de récupérer les informations de domaine et de période. Dans la zone maître, créez un utilisateur système pour simplifier l'authentification entre les daemons :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin user create --uid=zone.user \
--display-name="Zone User" --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> \
--secret=<replaceable>SYSTEM_SECRET_KEY</replaceable> --system</screen>
    <para>
     Notez les paramètres <option>access_key</option> et <option>secret_key</option> car les zones secondaires exigent l'authentification auprès de la zone maître.
    </para>
    <para>
     Ajoutez l'utilisateur système à la zone maître :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=us-east-1 \
--access-key=<replaceable>ACCESS-KEY</replaceable> --secret=<replaceable>SECRET</replaceable></screen>
    <para>
     Mettez à jour la période pour que les modifications prennent effet :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-updateperiod">
    <title>Mise à jour de la période</title>
    <para>
     Après avoir mis à jour la configuration de la zone maître, mettez à jour la période :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    <para>
     Une fois la période mise à jour, <command>radosgw-admin</command> renvoie la configuration de la période. Par exemple :
    </para>
<screen>{
  "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "epoch": 1, "predecessor_uuid": "", "sync_status": [], "period_map":
  {
    "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "zonegroups": [], "short_zone_ids": []
  }, "master_zonegroup": "", "master_zone": "", "period_config":
  {
     "bucket_quota": {
     "enabled": false, "max_size_kb": -1, "max_objects": -1
     }, "user_quota": {
       "enabled": false, "max_size_kb": -1, "max_objects": -1
     }
  }, "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7", "realm_name": "gold", "realm_epoch": 1
}</screen>
    <note>
     <para>
      La mise à jour de la période modifie l'époque et garantit que les autres zones reçoivent la configuration mise à jour.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-startrgw">
    <title>Démarrage de la passerelle Gateway</title>
    <para>
     Sur l'hôte Object Gateway, démarrez et activez le service Ceph Object Gateway. Pour identifier le FSID unique de la grappe, exécutez <command>ceph fsid</command>. Pour identifier le nom du daemon Object Gateway, exécutez <command>ceph orch ps --hostname <replaceable>HOSTNAME</replaceable></command>.
    </para>
<screen><prompt>cephuser@ogw &gt; </prompt>systemctl start ceph-<replaceable>FSID</replaceable>@<replaceable>DAEMON_NAME</replaceable>
<prompt>cephuser@ogw &gt; </prompt>systemctl enable ceph-<replaceable>FSID</replaceable>@<replaceable>DAEMON_NAME</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-config-secondaryzone">
   <title>Configuration des zones secondaires</title>
   <para>
    Les zones d'un groupe de zones répliquent toutes les données pour garantir que chaque zone possède les mêmes données. Lors de la création de la zone secondaire, exécutez toutes les opérations suivantes sur un hôte identifié pour desservir cette dernière.
   </para>
   <note>
    <para>
     Pour ajouter une troisième zone, suivez les mêmes procédures que pour ajouter la zone secondaire. Utilisez un nom de zone différent.
    </para>
   </note>
   <important>
    <para>
     Vous devez exécuter les opérations de métadonnées, telles que la création d'utilisateurs, sur un hôte de la zone maître. La zone maître et la zone secondaire peuvent recevoir des opérations de compartiment, mais la zone secondaire redirige les opérations de compartiment vers la zone maître. Si la zone maître est arrêtée, les opérations de compartiment échouent.
    </para>
   </important>
   <sect3 xml:id="ceph-rgw-pull-realm">
    <title>Extraction du domaine</title>
    <para>
     À l'aide du chemin URL, de la clé d'accès et du secret de la zone maître dans le groupe de zones maître, importez la configuration du domaine vers l'hôte. Pour extraire un domaine autre que celui par défaut, spécifiez le domaine à l'aide des options de configuration <option>--rgw-realm</option> ou <option>--realm-id</option>.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm pull --url=<replaceable>url-to-master-zone-gateway</replaceable> --access-key=<replaceable>access-key</replaceable> --secret=<replaceable>secret</replaceable></screen>
    <note>
     <para>
      L'extraction du domaine récupère également la configuration de la période en cours de l'hôte distant et en fait également la période en cours sur cet hôte.
     </para>
    </note>
    <para>
     Si ce domaine est le domaine par défaut ou le seul domaine, définissez-le comme par défaut.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm default --rgw-realm=<replaceable>REALM-NAME</replaceable></screen>
   </sect3>
   <sect3 xml:id="cceph-rgw-create-secondaryzone">
    <title>Création d'une zone secondaire</title>
    <para>
     Créez une zone secondaire pour la configuration multisite en ouvrant une interface de ligne de commande sur un hôte identifié pour desservir la zone secondaire. Spécifiez l'ID du groupe de zones, le nom de la nouvelle zone et un noeud d'extrémité pour cette dernière. <emphasis>N'utilisez pas</emphasis> l'indicateur <option>--master</option>. Toutes les zones s'exécutent dans une configuration active-active par défaut. Si la zone secondaire ne doit pas accepter les opérations d'écriture, spécifiez l'indicateur <option>--read-only</option> pour créer une configuration active-passive entre la zone maître et la zone secondaire. En outre, fournissez la clé d'accès (<option>access_key</option>) et la clé secrète (<option>secret_key</option>) de l'utilisateur système généré stockées dans la zone maître du groupe de zones maître. Exécutez la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable>\
                            --rgw-zone=<replaceable>ZONE-NAME</replaceable> --endpoints=<replaceable>URL</replaceable> \
                            --access-key=<replaceable>SYSTEM-KEY</replaceable> --secret=<replaceable>SECRET</replaceable>\
                            --endpoints=http://<replaceable>FQDN</replaceable>:80 \
                            [--read-only]</screen>
    <para>
     Par exemple :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --endpoints=http://rgw2:80 \
--rgw-zone=us-east-2 --access-key=<replaceable>SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>SYSTEM_SECRET_KEY</replaceable>
{
  "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
  "name": "us-east-2",
  "domain_root": "us-east-2.rgw.data.root",
  "control_pool": "us-east-2.rgw.control",
  "gc_pool": "us-east-2.rgw.gc",
  "log_pool": "us-east-2.rgw.log",
  "intent_log_pool": "us-east-2.rgw.intent-log",
  "usage_log_pool": "us-east-2.rgw.usage",
  "user_keys_pool": "us-east-2.rgw.users.keys",
  "user_email_pool": "us-east-2.rgw.users.email",
  "user_swift_pool": "us-east-2.rgw.users.swift",
  "user_uid_pool": "us-east-2.rgw.users.uid",
  "system_key": {
      "access_key": "1555b35654ad1656d804",
      "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
  },
  "placement_pools": [
      {
          "key": "default-placement",
          "val": {
              "index_pool": "us-east-2.rgw.buckets.index",
              "data_pool": "us-east-2.rgw.buckets.data",
              "data_extra_pool": "us-east-2.rgw.buckets.non-ec",
              "index_type": 0
          }
      }
  ],
  "metadata_heap": "us-east-2.rgw.meta",
  "realm_id": "815d74c2-80d6-4e63-8cfc-232037f7ff5c"
}</screen>
    <important>
     <para>
      Les étapes suivantes supposent une configuration multisite utilisant des systèmes nouvellement installés qui ne stockent pas encore de données. <emphasis role="bold">Ne supprimez pas</emphasis> la zone par défaut et ses réserves si vous les utilisez déjà pour stocker des données, sinon les données seront perdues et irrécupérables.
     </para>
    </important>
    <para>
     Supprimez la zone par défaut si nécessaire :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone rm --rgw-zone=default</screen>
    <para>
     Supprimez les réserves par défaut de votre grappe de stockage Ceph si nécessaire :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.control default.rgw.control --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.data.root default.rgw.data.root --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.gc default.rgw.gc --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.log default.rgw.log --yes-i-really-really-mean-it
<prompt>cephuser@adm &gt; </prompt>ceph osd pool rm default.rgw.users.uid default.rgw.users.uid --yes-i-really-really-mean-it</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-secondzone-update-config">
    <title>Mise à jour du fichier de configuration Ceph</title>
    <para>
     Mettez à jour le fichier de configuration Ceph sur les hôtes de la zone secondaire en ajoutant l'option de configuration <literal>rgw_zone</literal> et le nom de la zone secondaire à l'entrée de l'instance.
    </para>
    <para>
     Pour ce faire, exécutez la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set <replaceable>SERVICE_NAME</replaceable> rgw_zone us-west</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-secondzone-updateperiod">
    <title>Mise à jour de la période</title>
    <para>
     Après avoir mis à jour la configuration de la zone maître, mettez à jour la période :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit
{
  "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
  "epoch": 2,
  "predecessor_uuid": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "sync_status": [ "[...]"
  ],
  "period_map": {
      "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
      "zonegroups": [
          {
              "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
              "name": "us",
              "api_name": "us",
              "is_master": "true",
              "endpoints": [
                  "http:\/\/rgw1:80"
              ],
              "hostnames": [],
              "hostnames_s3website": [],
              "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "zones": [
                  {
                      "id": "83859a9a-9901-4f00-aa6d-285c777e10f0",
                      "name": "us-east-1",
                      "endpoints": [
                          "http:\/\/rgw1:80"
                      ],
                      "log_meta": "true",
                      "log_data": "false",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  },
                  {
                      "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
                      "name": "us-east-2",
                      "endpoints": [
                          "http:\/\/rgw2:80"
                      ],
                      "log_meta": "false",
                      "log_data": "true",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  }

              ],
              "placement_targets": [
                  {
                      "name": "default-placement",
                      "tags": []
                  }
              ],
              "default_placement": "default-placement",
              "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
          }
      ],
      "short_zone_ids": [
          {
              "key": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "val": 630926044
          },
          {
              "key": "950c1a43-6836-41a2-a161-64777e07e8b8",
              "val": 4276257543
          }

      ]
  },
  "master_zonegroup": "d4018b8d-8c0d-4072-8919-608726fa369e",
  "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
  "period_config": {
      "bucket_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      },
      "user_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      }
  },
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "realm_name": "gold",
  "realm_epoch": 2
}</screen>
    <note>
     <para>
      La mise à jour de la période modifie l'époque et garantit que les autres zones reçoivent la configuration mise à jour.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-secondzone-startrgw">
    <title>Démarrage de la passerelle Object Gateway</title>
    <para>
     Sur l'hôte Object Gateway, démarrez et activez le service Ceph Object Gateway :
    </para>
<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch start rgw.us-east-2
</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-check-sync-status">
    <title>Vérification de l'état de la synchronisation</title>
    <para>
     Lorsque la zone secondaire est opérationnelle, vérifiez l'état de la synchronisation. La synchronisation copie les utilisateurs et les compartiments créés dans la zone maître vers la zone secondaire.
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin sync status</screen>
    <para>
     La sortie indique l'état des opérations de synchronisation. Par exemple :
    </para>
<screen>realm f3239bc5-e1a8-4206-a81d-e1576480804d (gold)
    zonegroup c50dbb7e-d9ce-47cc-a8bb-97d9b399d388 (us)
         zone 4c453b70-4a16-4ce8-8185-1893b05d346e (us-west)
metadata sync syncing
              full sync: 0/64 shards
              metadata is caught up with master
              incremental sync: 64/64 shards
    data sync source: 1ee9da3e-114d-4ae3-a8a4-056e8a17f532 (us-east)
                      syncing
                      full sync: 0/128 shards
                      incremental sync: 128/128 shards
                      data is caught up with source</screen>
    <note>
     <para>
      Les zones secondaires acceptent les opérations de compartiment ; toutefois, elles les redirigent vers la zone maître, puis se synchronisent avec la zone maître pour recevoir le résultat des opérations de compartiment. Si la zone maître est arrêtée, les opérations de compartiment exécutées sur la zone secondaire échouent, mais les opérations sur les objets réussissent.
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-maintenance">
   <title>Maintenance générale d'Object Gateway</title>
   <sect3 xml:id="ceph-rgw-check-sync">
    <title>Vérification de l'état de la synchronisation</title>
    <para>
     Pour obtenir des informations sur l'état de réplication d'une zone, exécutez la commande suivante :
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin sync status
        realm b3bc1c37-9c44-4b89-a03b-04c269bea5da (gold)
    zonegroup f54f9b22-b4b6-4a0e-9211-fa6ac1693f49 (us)
         zone adce11c9-b8ed-4a90-8bc5-3fc029ff0816 (us-west)
        metadata sync syncing
              full sync: 0/64 shards
              incremental sync: 64/64 shards
              metadata is behind on 1 shards
              oldest incremental change not applied: 2017-03-22 10:20:00.0.881361s
data sync source: 341c2d81-4574-4d08-ab0f-5a2a7b168028 (us-east)
                  syncing
                  full sync: 0/128 shards
                  incremental sync: 128/128 shards
                  data is caught up with source
          source: 3b5d1a3f-3f27-4e4a-8f34-6072d4bb1275 (us-3)
                  syncing
                  full sync: 0/128 shards
                  incremental sync: 128/128 shards
                  data is caught up with source</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-metadata-master">
    <title>Modification de la zone maître des métadonnées</title>
    <important>
     <para>
      Faites preuve de précaution lorsque vous modifiez la zone maître des métadonnées. Si une zone n'a pas terminé la synchronisation des métadonnées depuis la zone maître actuelle, elle ne peut pas desservir les entrées restantes une fois promue au rang de maître et ces modifications sont perdues. Pour cette raison, nous vous recommandons d'attendre que l'état de synchronisation <command>radosgw-admin</command> d'une zone indique que la synchronisation des métadonnées est terminée avant de la promouvoir au rang de maître. De même, si les modifications apportées aux métadonnées sont traitées par la zone maître actuelle alors qu'une autre zone est promue au rang de maître, ces modifications risquent d'être perdues. Pour éviter cela, nous vous recommandons de fermer toutes les instances d'Object Gateway sur l'ancienne zone maître. Une fois qu'une autre zone a été promue, sa nouvelle période peut être récupérée à l'aide de l'extraction de période <command>radosgw-admin</command> et la ou les passerelles peuvent être redémarrées.
     </para>
    </important>
    <para>
     Pour promouvoir une zone (par exemple, la zone <literal>us-west</literal> dans le groupe de zones <literal>us</literal>) en tant que maître de métadonnées, exécutez les commandes suivantes sur cette zone :
    </para>
<screen><prompt>cephuser@ogw &gt; </prompt>radosgw-admin zone modify --rgw-zone=us-west --master
<prompt>cephuser@ogw &gt; </prompt>radosgw-admin zonegroup modify --rgw-zonegroup=us --master
<prompt>cephuser@ogw &gt; </prompt>radosgw-admin period update --commit</screen>
    <para>
     Cela génère une nouvelle période et les instances d'Object Gateway de la zone <literal>us-west</literal> envoient cette période à d'autres zones.
    </para>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-failover-dr">
   <title>Basculement et reprise après sinistre</title>
   <para>
    Si la zone maître échoue, basculez vers la zone secondaire pour la reprise après sinistre.
   </para>
   <procedure>
    <step>
     <para>
      Faites de la zone secondaire la zone maître et la zone par défaut. Par exemple :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default</screen>
     <para>
      Par défaut, Ceph Object Gateway s'exécute dans une configuration active-active. Si la grappe a été configurée pour s'exécuter dans une configuration active-passive, la zone secondaire est une zone en lecture seule. Retirez l'état <option>--read-only</option> pour autoriser la zone à recevoir les opérations d'écriture. Par exemple :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default \
                                                   --read-only=false
</screen>
    </step>
    <step>
     <para>
      Mettez à jour la période pour que les modifications prennent effet :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Redémarrez la passerelle Ceph Object Gateway :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart rgw</screen>
    </step>
   </procedure>
   <para>
    En cas de reprise de la zone maître précédente, annulez l'opération.
   </para>
   <procedure>
    <step>
     <para>
      Depuis la zone récupérée, extrayez la dernière configuration de domaine de la zone maître actuelle.
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin realm pull --url=<replaceable>URL-TO-MASTER-ZONE-GATEWAY</replaceable> \
                           --access-key=<replaceable>ACCESS-KEY</replaceable> --secret=<replaceable>SECRET</replaceable>
</screen>
    </step>
    <step>
     <para>
      Faites de la zone récupérée la zone maître et la zone par défaut:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default</screen>
    </step>
    <step>
     <para>
      Mettez à jour la période pour que les modifications prennent effet :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Redémarrez la passerelle Ceph Object Gateway dans la zone récupérée :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart rgw@rgw</screen>
    </step>
    <step>
     <para>
      Si la zone secondaire doit être une configuration en lecture seule, mettez à jour la zone secondaire :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --read-only</screen>
    </step>
    <step>
     <para>
      Mettez à jour la période pour que les modifications prennent effet :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>radosgw-admin period update --commit</screen>
    </step>
    <step>
     <para>
      Enfin, redémarrez la passerelle Ceph Object Gateway dans la zone secondaire :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart@rgw</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
</chapter>
