<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Sauvegarde et restauration</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>oui</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Ce chapitre explique quelles parties de la grappe Ceph vous devriez sauvegarder afin d'être en mesure de restaurer sa fonctionnalité.
 </para>
 <sect1 xml:id="backrest-ceph">
  <title>Sauvegarde de la configuration et des données de grappe</title>

  <sect2 xml:id="backrest-ceph-cephsalt">
   <title>Sauvegarde de la configuration de <systemitem class="resource">ceph-salt</systemitem></title>
   <para>
    Exportez la configuration de la grappe. Pour plus d'informations, reportez-vous au document <xref linkend="deploy-cephadm-configure-export"/>.
   </para>
  </sect2>

  <sect2 xml:id="backup-ceph">
   <title>Sauvegarde de la configuration Ceph</title>
   <para>
    Sauvegardez l'annuaire <filename>/etc/ceph</filename>. Il contient des informations de configuration de grappe cruciales. Par exemple, vous avez besoin de la sauvegarde de <filename>/etc/ceph</filename> lorsque vous devez remplacer le noeud Admin.
   </para>
  </sect2>

  <sect2 xml:id="sec-deployment-backup-salt">
   <title>Sauvegarde de la configuration Salt</title>
   <para>
    Vous devez sauvegarder le répertoire <filename>/etc/salt/</filename>. Il contient les fichiers de configuration Salt, par exemple la clé de Salt Master et les clés clients acceptées.
   </para>
   <para>
    Les fichiers Salt ne sont pas strictement requis pour la sauvegarde du noeud Admin, mais facilitent le redéploiement de la grappe Salt. S'il n'existe pas de sauvegarde de ces fichiers, les minions Salt doivent être enregistrés à nouveau au niveau du nouveau noeud Admin.
   </para>
   <note>
    <title>sécurité de la clé privée de Salt Master</title>
    <para>
     Assurez-vous que la sauvegarde de la clé privée de Salt Master est stockée à un emplacement sûr. La clé de Salt Master peut être utilisée pour manipuler tous les noeuds de la grappe.
    </para>
   </note>
  </sect2>

  <sect2 xml:id="backup-config-files">
   <title>Sauvegarde des configurations personnalisées</title>
   <itemizedlist>
    <listitem>
     <para>
      Données et personnalisation de Prometheus.
     </para>
    </listitem>
    <listitem>
     <para>
      Personnalisation de Grafana.
     </para>
    </listitem>
    <listitem>
     <para>
      Modifications manuelles de la configuration iSCSI.
     </para>
    </listitem>
    <listitem>
     <para>
      Clés Ceph.
     </para>
    </listitem>
    <listitem>
     <para>
      Assignation et règles CRUSH. Enregistrez la carte CRUSH décompilée, y compris les règles CRUSH dans le fichier <filename>crushmap-backup.txt</filename> en exécutant la commande suivante :
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
    </listitem>
    <listitem>
     <para>
      Configuration de la passerelle Samba. Si vous utilisez une seule passerelle, sauvegardez <filename>/etc/samba/smb.conf</filename>. Si vous utilisez une configuration haute disponibilité, sauvegardez également les fichiers de configuration CTDB et Pacemaker. Pour plus de détails sur la configuration utilisée par les passerelles Samba, reportez-vous au <xref linkend="cha-ses-cifs"/>.
     </para>
    </listitem>
    <listitem>
     <para>
      Configuration de NFS Ganesha. Uniquement nécessaire en cas d'utilisation de la configuration HA. Pour plus de détails sur la configuration utilisée par NFS Ganesha, reportez-vous au <xref linkend="cha-ceph-nfsganesha"/>.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="restore-ceph">
  <title>Restauration d'un noeud Ceph</title>

  <para>
   La procédure de récupération d'un noeud à partir d'une sauvegarde consiste à réinstaller le noeud, à remplacer ses fichiers de configuration, puis à réorchestrer la grappe afin que le noeud de remplacement soit de nouveau ajouté.
  </para>

  <para>
   Si vous devez redéployer le noeud Admin, reportez-vous à la <xref linkend="moving-saltmaster"/>.
  </para>

  <para>
   Pour les minions, il est généralement plus simple de reconstruire et de redéployer.
  </para>

  <orderedlist>
   <listitem>
    <para>
     Réinstallez le noeud. Pour plus d'informations, reportez-vous au document <xref linkend="deploy-os"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Installez Salt. Pour plus d'informations, reportez-vous au document <xref linkend="deploy-salt"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Après avoir restauré le répertoire <filename>/etc/salt</filename> à partir d'une sauvegarde, activez et redémarrez les services Salt applicables, par exemple :
    </para>
<screen>
<prompt>root@master # </prompt><command>systemctl</command> enable salt-master
<prompt>root@master # </prompt><command>systemctl</command> start salt-master
<prompt>root@master # </prompt><command>systemctl</command> enable salt-minion
<prompt>root@master # </prompt><command>systemctl</command> start salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Supprimez la clé publique principale de l'ancien noeud Salt Master de tous les minions.
    </para>
<screen>
<prompt>root@master # </prompt><command>rm</command> /etc/salt/pki/minion/minion_master.pub
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     Restaurez tout ce qui était local sur le noeud Admin.
    </para>
   </listitem>
   <listitem>
    <para>
     Importez la configuration de la grappe à partir du fichier JSON exporté précédemment. Pour plus d'informations, reportez-vous au document <xref linkend="deploy-cephadm-configure-export"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Appliquez la configuration de grappe importée :
    </para>
<screen><prompt>root@master # </prompt>ceph-salt apply</screen>
   </listitem>
  </orderedlist>
 </sect1>
</chapter>
