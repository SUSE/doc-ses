<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha-ceph-nfsganesha">

 <title>NFS Ganesha</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  NFS Ganeshaは、オペレーティングシステムカーネルの一部としてではなく、ユーザアドレススペースで動作するNFSサーバです。NFS Ganeshaを使用することで、Cephなど独自のストレージメカニズムをプラグインして、任意のNFSクライアントからアクセスできます。詳細については、<xref linkend="deploy-cephadm-day2-service-nfs"/>を参照してください。
 </para>
 <note>
  <title>NFS Ganeshaのパフォーマンス</title>
  <para>
   NFSゲートウェイ経由でCephにアクセスすると、ネイティブのCephFSと比較してアプリケーションのパフォーマンスが大幅に低下する場合があります。これは、プロトコルオーバーヘッドが増加し、クライアントとストレージ間の余分なネットワークホップによって追加の遅延が発生するためです。
  </para>
 </note>
 <para>
  各NFS Ganeshaサービスは次のような階層状の設定から構成されます。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    ブートストラップ用の<filename>ganesha.conf</filename>
   </para>
  </listitem>
  <listitem>
   <para>
    サービスごとのRADOS共通設定オブジェクト
   </para>
  </listitem>
  <listitem>
   <para>
    エクスポートごとのRADOS設定オブジェクト
   </para>
  </listitem>
 </itemizedlist>
 <para>
  ブートストラップ設定は、コンテナ内で<systemitem class="daemon">nfs-ganesha</systemitem>デーモンを起動するために最小限必要な設定です。各ブートストラップ設定には<literal>%url</literal>ディレクティブが含まれます。このディレクティブにより、必要に応じてRADOS共通設定オブジェクトから追加の設定が読み込まれます。共通設定オブジェクトには追加の<literal>%url</literal>ディレクティブを含めることができます。このディレクティブはエクスポートRADOS設定オブジェクトで定義された各NFSエクスポートを対象とするものです。
 </para>
 <figure>
  <title>NFS Ganeshaの構造</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="nfs_ganesha_structure.png" width="75%"/>
   </imageobject>
  </mediaobject>
 </figure>
 <sect1 xml:id="ceph-nfsganesha-nfservice">
  <title>NFSサービスの作成</title>

  <para>
   Cephサービスの展開内容を指定する方法としては、YAMLフォーマットのファイルを作成して、展開したいサービスの仕様を記載することをお勧めします。サービスの種類ごとに個別の仕様ファイルを作成できます。また、複数(もしくは、すべて)の種類のサービスを1つのファイルで指定することも可能です。
  </para>

  <para>
   選択した方法に応じて、NFS Ganeshaサービスを作成するために関連するYAMLフォーマットのファイルのアップデートまたは作成が必要になります。ファイルの作成の詳細については、<xref linkend="cephadm-service-and-placement-specs"/>を参照してください。
  </para>

  <para>
   ファイルのアップデートまたは作成が完了したら、次のコマンドを実行して<literal>nfs-ganesha</literal>サービスを作成してください。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch apply -i <replaceable>FILE_NAME</replaceable>
</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-services">
  <title>NFS Ganeshaの起動または再起動</title>

  <para>
   NFS Ganeshaサービスを起動するには、次のコマンドを実行します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch start nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   NFS Ganeshaサービスを再起動するには、次のコマンドを実行します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   単一のNFS Ganeshaデーモンを再起動したいだけなら、次のコマンドを実行します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart nfs.<replaceable>SERVICE_ID</replaceable></screen>

  <para>
   NFS Ganeshaが起動または再起動した時点では、NFS v4に90秒の猶予タイムアウトが設定されています。猶予期間中、クライアントからの新しい要求はアクティブに拒否されます。したがって、NFSが猶予期間の場合、クライアントで要求の低速化が発生することがあります。
  </para>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-list-objects">
  <title>NFS回復プールのオブジェクトの一覧</title>

  <para>
   NFS回復プールのオブジェクトを一覧にするには、次のコマンドを実行します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> ls</screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-create-export">
  <title>NFSエクスポートの作成</title>

  <para>
   NFSエクスポートを作成するには、次のコマンドを実行します。
  </para>

  <note>
   <para>
    希望するcephxユーザIDとシークレットアクセスキーが含まれるように、FSALブロックを修正する必要があります。
   </para>
  </note>

<screen><prompt>cephuser@adm &gt; </prompt>rados --pool <replaceable>POOL_NAME</replaceable> --namespace <replaceable>NAMESPACE_NAME</replaceable> put <replaceable>export-1</replaceable> <replaceable>export-1</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-verify">
  <title>NFSエクスポートの確認</title>

  <para>
   NFS v4は疑似ファイルシステムのルートにエクスポートのリストを作成します。NFS Ganeshaサーバノードの<filename>/</filename>をマウントすることで、NFS共有がエクスポートされたことを確認できます。
  </para>

<screen><prompt role="root">root # </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable>
<prompt role="root">root # </prompt><command>ls</command> <replaceable>/path/to/local/mountpoint</replaceable> cephfs</screen>

  <note>
   <title>NFS Ganeshaはv4のみ</title>
   <para>
    デフォルトでは、cephadmがNFS v4サーバを設定します。NFS v4は<literal>rpcbind</literal>デーモンとも<literal>mountd</literal>デーモンとも対話しません。<command>showmount</command>のなどのNFSクライアントツールは設定済みエクスポートを表示しません。
   </para>
  </note>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-mount">
  <title>NFSエクスポートのマウント</title>

  <para>
   エクスポートされたNFS共有をクライアントホストにマウントするには、次のコマンドを実行します。
  </para>

<screen><prompt role="root">root # </prompt><command>mount</command> -t nfs <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph-nfsganesha-customrole">
  <title>複数のNFS Ganeshaクラスタ</title>

  <para>
   複数のNFS Ganeshaクラスタを定義できます。これにより、次のことが実現できます。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     CephFSへのアクセスのために分離されたNFS Ganeshaクラスタ。
    </para>
   </listitem>
  </itemizedlist>


 </sect1>
</chapter>
