<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>バックアップおよび復元</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  この章では、Cephクラスタの機能を復元できるようにするには、クラスタのどの部分をバックアップする必要があるかについて説明します。
 </para>
 <sect1 xml:id="backrest-ceph">
  <title>クラスタ設定とデータのバックアップ</title>

  <sect2 xml:id="backrest-ceph-cephsalt">
   <title><systemitem class="resource">ceph-salt</systemitem>設定のバックアップ</title>
   <para>
    クラスタ設定をエクスポートします。詳細情報については、<xref linkend="deploy-cephadm-configure-export"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="backup-ceph">
   <title>Ceph設定のバックアップ</title>
   <para>
    <filename>/etc/ceph</filename>ディレクトリをバックアップします。ここには、重要なクラスタ設定が含まれています。たとえば、管理ノードを交換する必要がある場合、<filename>/etc/ceph</filename>のバックアップが必要になります。
   </para>
  </sect2>

  <sect2 xml:id="sec-deployment-backup-salt">
   <title>Salt設定のバックアップ</title>
   <para>
    <filename>/etc/salt/</filename>ディレクトリをバックアップする必要があります。ここには、Salt Masterのキーや受け付けたクライアントキーなど、Saltの各種設定ファイルが含まれています。
   </para>
   <para>
    管理ノードをバックアップする場合にSaltのファイルは厳密には必須ではありませんが、バックアップしておくとSaltクラスタの再展開が容易になります。これらのファイルのバックアップがないと、新しい管理ノードで再度Salt Minionを登録する必要があります。
   </para>
   <note>
    <title>Salt Masterの秘密鍵のセキュリティ</title>
    <para>
     Salt Masterの秘密鍵のバックアップは必ず安全な場所に保存してください。Salt Masterのキーを使用すると、すべてのクラスタノードを操作できます。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="backup-config-files">
   <title>カスタム設定のバックアップ</title>
   <itemizedlist>
    <listitem>
     <para>
      Prometheusのデータおよびカスタマイズ。
     </para>
    </listitem>
    <listitem>
     <para>
      Grafanaのカスタマイズ。
     </para>
    </listitem>
    <listitem>
     <para>
      iSCSI設定の手動変更。
     </para>
    </listitem>
    <listitem>
     <para>
      Cephの各種キー。
     </para>
    </listitem>
    <listitem>
     <para>
      CRUSHマップおよびCRUSHルール。次のコマンドを実行して、CRUSHルールを含む、逆コンパイルされたCRUSHマップを<filename>crushmap-backup.txt</filename>に保存します。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
    </listitem>
    <listitem>
     <para>
      Samba Gatewayの設定。ゲートウェイを1つ使用している場合は、<filename>/etc/samba/smb.conf</filename>をバックアップします。HAセットアップを使用している場合は、CTDB設定ファイルとPacemaker設定ファイルもバックアップします。Samba Gatewayで使用する設定の詳細については、<xref linkend="cha-ses-cifs"/>を参照してください。
     </para>
    </listitem>
    <listitem>
     <para>
      NFS Ganeshaの設定。HAセットアップの使用時にのみ必要です。NFS Ganeshaで使用する設定の詳細については、<xref linkend="cha-ceph-nfsganesha"/>を参照してください。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="restore-ceph">
  <title>Cephノードの復元</title>

  <para>
   バックアップからノードを復元する手順では、ノードを再インストールして設定ファイルを置き換えた後、置換ノードが再度追加されるようにクラスタを再度オーケストレーションします。
  </para>

  <para>
   管理ノードの再展開が必要な場合は、<xref linkend="moving-saltmaster"/>を参照してください。
  </para>

  <para>
   ミニオンについては、単に再構築と再展開を行った方が簡単な場合が多いです。
  </para>

  <orderedlist>
   <listitem>
    <para>
     ノードを再インストールします。詳細については、<xref linkend="deploy-sles"/>を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     Saltをインストールします。詳細については<xref linkend="deploy-salt"/>を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     <filename>/etc/salt</filename>ディレクトリがバックアップから復元されると、関連するSaltサービスを再開できるようになります。以下に例を示します。
    </para>
<screen>
<prompt>root@master # </prompt><command>systemctl</command> enable salt-master
<prompt>root@master # </prompt><command>systemctl</command> start salt-master
<prompt>root@master # </prompt><command>systemctl</command> enable salt-minion
<prompt>root@master # </prompt><command>systemctl</command> start salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     すべてのミニオンから古いSalt Masterノード用の公開マスター鍵を削除します。
    </para>
<screen>
<prompt>root@master # </prompt><command>rm</command> /etc/salt/pki/minion/minion_master.pub
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion
</screen>
   </listitem>
   <listitem>
    <para>
     管理ノードのローカルに置かれていたファイルをすべて復元します。
    </para>
   </listitem>
   <listitem>
    <para>
     事前にエクスポートしたJSONファイルからクラスタ設定をインポートします。詳細については、<xref linkend="deploy-cephadm-configure-export"/>を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     インポートしたクラスタ設定を適用します。
    </para>
<screen><prompt>root@master # </prompt>ceph-salt apply</screen>
   </listitem>
  </orderedlist>
 </sect1>
</chapter>
