<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="cha-ceph-operating">
 <title>Cephサービスの運用</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Cephサービスは、デーモンレベル、ノードレベル、またはクラスタレベルで運用できます。必要なアプローチに応じて、cephadmか<command>systemctl</command>コマンドを使用してください。
 </para>
 <sect1 xml:id="cha-ceph-operating-individual">
  <title>個別のサービスの運用</title>

  <para>
   個別のサービスを運用する必要がある場合は、まずそのサービスを確認します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps
NAME                                HOST        STATUS         REFRESHED  [...]
mds.my_cephfs.ses-min1.oterul       ses-min1    running (5d)   8m ago
mgr.ses-min1.gpijpm                 ses-min1    running (5d)   8m ago
mgr.ses-min2.oopvyh                 ses-min2    running (5d)   8m ago
mon.ses-min1                        ses-min1    running (5d)   8m ago
mon.ses-min2                        ses-min2    running (5d)   8m ago
mon.ses-min4                        ses-min4    running (5d)   7m ago
osd.0                               ses-min2    running (61m)  8m ago
osd.1                               ses-min3    running (61m)  7m ago
osd.2                               ses-min4    running (61m)  7m ago
rgw.myrealm.myzone.ses-min1.kwwazo  ses-min1    running (5d)   8m ago
rgw.myrealm.myzone.ses-min2.jngabw  ses-min2    error          8m ago
</screen>

  <para>
   特定のノードのサービスを確認するには、次のコマンドを実行します。
  </para>

<screen>ceph orch ps <replaceable>NODE_HOST_NAME</replaceable></screen>

  <para>
   以下に例を示します。
  </para>

<screen>
<prompt>cephuser@adm &gt; </prompt>ceph orch ps ses-min2
NAME                                HOST      STATUS         REFRESHED
mgr.ses-min2.oopvyh                 ses-min2  running (5d)   3m ago
mon.ses-min2                        ses-min2  running (5d)   3m ago
osd.0                               ses-min2  running (67m)  3m ago
</screen>

  <tip>
   <para>
    <command>ceph orch ps</command>コマンドはいくつかの出力フォーマットをサポートしています。フォーマットを変更するには<option>--format <replaceable>FORMAT</replaceable></option>オプションを付加してください。<replaceable>ここで、FORMAT</replaceable>は<literal>json</literal>、<literal>json-pretty</literal>、または<literal>yaml</literal>のいずれかです。例:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph orch ps --format yaml</screen>
  </tip>

  <para>
   サービスの名前を確認することで、サービスの起動、再起動、停止が可能になります。
  </para>

<screen>ceph orch daemon <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>

  <para>
   たとえば、IDが0のOSDサービスを再起動するには、次のコマンドを実行します。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch daemon restart osd.0</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-service-types">
  <title>サービスタイプの運用</title>

  <para>
   Cephクラスタ全体で特定のタイプのサービスを運用する必要がある場合は、次のコマンドを使用します。
  </para>

<screen>ceph orch <replaceable>COMMAND</replaceable> <replaceable>SERVICE_TYPE</replaceable></screen>

  <para>
   <replaceable>COMMAND</replaceable>は<literal>start</literal>、<literal>stop</literal>、または<literal>restart</literal>のいずれかで置き換えます。
  </para>

  <para>
   たとえば、クラスタのすべてのMONを再起動するには次のコマンドを使用します。このコマンドでは、MONが実際にはどのノードで実行されているかを考慮しません。
  </para>

<screen><prompt>cephuser@adm &gt; </prompt>ceph orch restart mon</screen>
 </sect1>
 <sect1 xml:id="cha-ceph-operating-node">
  <title>単一のノードでサービスを運用する</title>

  <para>
   <command>systemctl</command>コマンドを使用することで、Cephに関連した<systemitem class="daemon">systemd</systemitem>サービスとターゲットを単一のノードで運用できます。
  </para>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>サービスとターゲットの確認</title>
   <para>
    Cephに関連した<systemitem class="daemon">systemd</systemitem>サービスとターゲットを運用する前に、これらのユニットファイルのファイル名を確認する必要があります。サービスのファイル名には次のようなパターンがあります。
   </para>
<screen>ceph-<replaceable>FSID</replaceable>@<replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>.service</screen>
   <para>
    例:
   </para>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@mon.doc-ses-min1.service</screen>
<screen>ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@rgw.myrealm.myzone.doc-ses-min1.kwwazo.service</screen>
   <variablelist>
    <varlistentry>
     <term>FSID</term>
     <listitem>
      <para>
       Cephクラスタの固有のIDです。<command>ceph fsid</command>コマンドの出力で確認できます。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SERVICE_TYPE</term>
     <listitem>
      <para>
       サービスの種類です。たとえば、<literal>osd</literal>、<literal>mon</literal>、<literal>rgw</literal>などがあります。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>ID</term>
     <listitem>
      <para>
       サービスの識別文字列です。OSDの場合はサービスのID番号です。他のサービスでは、ノードのホスト名の場合と、サービスタイプに関連した追加の文字列の場合があります。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
   <tip>
    <para>
     <replaceable>SERVICE_TYPE</replaceable>.<replaceable>ID</replaceable>の部分は、<command>ceph orch ps</command>コマンドの出力の<literal>NAME</literal>列の内容と同一です。
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>ノード上のすべてのサービスの運用</title>
   <para>
    Cephの<systemitem class="daemon">systemd</systemitem>ターゲットを使用することで、ノード上の「すべて」<emphasis/>のサービスを同時に運用することができます。あるいは、<replaceable>FSID</replaceable>で識別された「クラスタに属する」<emphasis/>すべてのサービスを同時に運用することもできます。
   </para>
   <para>
    たとえば、サービスがどのクラスタに所属しているかを考慮せずにノード上のCephサービスをすべて停止するには、次のコマンドを実行します。
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl stop ceph.target</screen>
   <para>
    IDが<literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>のCephクラスタに属するすべてのサービスを再起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>root@minion &gt; </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d.target</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-single">
   <title>ノード上の個別のサービスの運用</title>
   <para>
    特定のサービスの名前を確認したら、次のように運用します。
   </para>
<screen>systemctl <replaceable>COMMAND</replaceable> <replaceable>SERVICE_NAME</replaceable></screen>
   <para>
    たとえば、IDが<literal>b4b30c6e-9681-11ea-ac39-525400d7702d</literal>のクラスタ上にある、IDが1のOSDサービスを単独で再起動する場合は、次のコマンドを実行します。
   </para>
<screen><prompt role="root">root # </prompt>systemctl restart ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.1.service</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>サービス状態のクエリ</title>
   <para>
    サービスの状態を<systemitem class="daemon">systemd</systemitem>に問い合わせることができます。例:
   </para>
<screen><prompt role="root">root # </prompt>systemctl status ceph-b4b30c6e-9681-11ea-ac39-525400d7702d@osd.0.service</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Cephクラスタ全体のシャットダウンと再起動</title>

  <para>
   クラスタのシャットダウンと再起動は、計画停電の際に必要となる場合があります。すべてのCeph関連サービスを停止し、正常に再起動させるには、以下の手順に従います。
  </para>

  <procedure>
   <title>Cephクラスタ全体のシャットダウン</title>
   <step>
    <para>
     クラスタにアクセスしているすべてのクライアントをシャットダウンするか、切断します。
    </para>
   </step>
   <step>
    <para>
     CRUSHが自動的にクラスタをリバランスしないように、クラスタを<literal>noout</literal>に設定します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd set noout</screen>
   </step>
   <step>
    <para>
     すべてのクラスタノードのすべてのCephサービスを停止します。
    </para>
<screen><prompt>root@master # </prompt>ceph-salt stop</screen>
   </step>
   <step>
    <para>
     すべてのクラスタノードの電源を切ります。
    </para>
<screen><prompt>root@master # </prompt>salt -G 'ceph-salt:member' cmd.run "shutdown -h"</screen>
   </step>
  </procedure>

  <procedure>
   <title>Cephクラスタ全体の起動</title>
   <step>
    <para>
     管理ノードの電源を入れます。
    </para>
   </step>
   <step>
    <para>
     Ceph Monitorノードの電源を入れます。
    </para>
   </step>
   <step>
    <para>
     Ceph OSDノードの電源を入れます。
    </para>
   </step>
   <step>
    <para>
     以前に設定した<literal>noout</literal>フラグの設定を解除します。
    </para>
<screen><prompt>root@master # </prompt>ceph osd unset noout</screen>
   </step>
   <step>
    <para>
     すべての設定されているゲートウェイの電源を入れます。
    </para>
   </step>
   <step>
    <para>
     クラスタのクライアントの電源を入れるか、接続します。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
