<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_libvirt.xml" version="5.0" xml:id="cha-ceph-libvirt">
 <title><systemitem class="library">libvirt</systemitem>とCeph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  <systemitem class="library">libvirt</systemitem>ライブラリは、ハイパーバイザーインタフェースと、それらを使用するソフトウェアアプリケーションとの間に仮想マシン抽象化層を作成します。<systemitem class="library">libvirt</systemitem>を使用することにより、開発者やシステム管理者は、QEMU/KVM、Xen、LXC、VirtualBoxなど、さまざまなハイパーバイザーに対する共通管理フレームワーク、共通API、および共通シェルインタフェース(<command>virsh</command>)に集中できます。
 </para>
 <para>
  Ceph Block DeviceはQEMU/KVMをサポートします。<systemitem class="library">libvirt</systemitem>と連動するソフトウェアでCeph Block Deviceを使用できます。クラウドソリューションは<systemitem class="library">libvirt</systemitem>を使用してQEMU/KVMと対話し、QEMU/KVMは<systemitem>librbd</systemitem>を介してCeph Block Deviceと対話します。
 </para>
 <para>
  Ceph Block Deviceを使用するVMを作成するには、以降のセクションの手順を使用します。これらの例では、プール名に<literal>libvirt-pool</literal>、ユーザ名に<literal>client.libvirt</literal>、イメージ名に<literal>new-libvirt-image</literal>をそれぞれ使用しています。好きな値を使用できますが、後続の手順でコマンドを実行する際に値を置き換えるようにしてください。
 </para>
 <sect1 xml:id="ceph-libvirt-cfg-ceph">
  <title><systemitem class="library">libvirt</systemitem>で使用するためのCephの設定</title>

  <para>
   <systemitem class="library">libvirt</systemitem>で使用するためにCephを設定するには、次の手順を実行します。
  </para>

  <procedure>
   <step>
    <para>
     プールを作成します。次の例では、プール名<literal>libvirt-pool</literal>と128の配置グループを使用しています。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     プールが存在することを確認します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     Cephユーザを作成します。次の例では、Cephユーザ名<literal>client.libvirt</literal>を使用し、<literal>libvirt-pool</literal>を参照しています。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-or-create client.libvirt mon 'profile rbd' osd \
 'profile rbd pool=libvirt-pool'</screen>
    <para>
     名前が存在することを確認します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth list</screen>
    <note>
     <title>ユーザ名またはID</title>
     <para>
      <systemitem class="library">libvirt</systemitem>は、Cephユーザ名<literal>client.libvirt</literal>ではなくID <literal>libvirt</literal>を使用してCephにアクセスします。IDと名前の違いの詳細については、<xref linkend="cephx-user"/>を参照してください。
     </para>
    </note>
   </step>
   <step>
    <para>
     QEMUを使用してRBDプール内にイメージを作成します。次の例では、イメージ名<literal>new-libvirt-image</literal>を使用し、<literal>libvirt-pool</literal>を参照しています。
    </para>
    <tip>
     <title>キーリングファイルの場所</title>
     <para>
      <systemitem class="library">libvirt</systemitem>ユーザキーは、<filename>/etc/ceph</filename>ディレクトリに配置されたキーリングファイルに保存されます。キーリングファイルには、それが属するCephクラスタの名前が含まれた適切な名前が付いている必要があります。デフォルトのクラスタ名「ceph」の場合、キーリングファイル名は<filename>/etc/ceph/ceph.client.libvirt.keyring</filename>になります。
     </para>
     <para>
      キーリングが存在しない場合は、次のコマンドで作成します。
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get client.libvirt &gt; /etc/ceph/ceph.client.libvirt.keyring</screen>
    </tip>
<screen><prompt role="root">root # </prompt>qemu-img create -f raw rbd:libvirt-pool/new-libvirt-image:id=libvirt 2G</screen>
    <para>
     イメージが存在することを確認します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-virt-manager">
  <title>VMマネージャの準備</title>

  <para>
   <systemitem class="library">libvirt</systemitem>はVMマネージャなしでも使用できますが、最初のドメインは<command>virt-manager</command>で作成する方が簡単です。
  </para>

  <procedure>
   <step>
    <para>
     仮想マシンマネージャをインストールします。
    </para>
<screen><prompt role="root">root # </prompt>zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     仮想化して実行するシステムのOSイメージを準備/ダウンロードします。
    </para>
   </step>
   <step>
    <para>
     仮想マシンマネージャを起動します。
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-create-vm">
  <title>VMの作成</title>

  <para>
   <command>virt-manager</command>でVMを作成するには、次の手順を実行します。
  </para>

  <procedure>
   <step>
    <para>
     リストから接続を選択し、右クリックして<guimenu>New (新規作成)</guimenu>を選択します。
    </para>
   </step>
   <step>
    <para>
     <guimenu>Import existing disk image (既存のディスクイメージのインポート)</guimenu>を選択し、既存のストレージのパスを入力して、既存のディスクイメージをインポートします。OSタイプとメモリ設定を指定し、<guimenu>名前</guimenu>に仮想マシンの名前を入力します。たとえば、<literal>libvirt-virtual-machine</literal>です。
    </para>
   </step>
   <step>
    <para>
     設定を完了してVMを起動します。
    </para>
   </step>
   <step>
    <para>
     <command>sudo virsh list</command>を使用して、新しく作成したドメインが存在することを確認します。必要に応じて、次のように接続文字列を指定します。
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     VMにログインし、Cephで使用するために設定する前にVMを停止します。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-cfg-vm">
  <title>VMの設定</title>

  <para>
   この章では、<command>virsh</command>を使用してCephとの統合用にVMを設定する方法に焦点を当てて説明します。多くの場合、<command>virsh</command>コマンドにはルート特権(<command>sudo</command>)が必要で、ルート特権がないと適切な結果が返されません。また、ルート特権が必要なことは通知されません。<command>virsh</command>コマンドのリファレンスについては、<command>man 1 virsh</command>を参照してください(パッケージ <package>libvirt-client</package> をインストールする必要があります)。
  </para>

  <procedure>
   <step>
    <para>
     <command>virsh edit</command>
     <replaceable>vm-domain-name</replaceable>を使用して、設定ファイルを開きます。
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     &lt;devices&gt;の下位に&lt;disk&gt;エントリが存在する必要があります。
    </para>
<screen>&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-<replaceable>SYSTEM-ARCH</replaceable>&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/image/recent-linux.img'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='drive' controller='0' bus='0' unit='0'/&gt;
    &lt;/disk&gt;</screen>
    <para>
     <filename>/path/to/image/recent-linux.img</filename>は、OSイメージのパスに置き換えてください。
    </para>
    <important>
     <para>
      テキストエディタではなく、<command>sudo virsh edit</command>を使用してください。<filename>/etc/libvirt/qemu</filename>にある設定ファイルをテキストエディタで編集した場合、<systemitem class="library">libvirt</systemitem>が変更を認識しないことがあります。<filename>/etc/libvirt/qemu</filename>にあるXMLファイルの内容と<command>sudo virsh dumpxml</command> <replaceable>vm-domain-name</replaceable>の結果に違いがある場合、VMが適切に動作しないことがあります。
     </para>
    </important>
   </step>
   <step>
    <para>
     前に作成したCeph RBDイメージを&lt;disk&gt;エントリとして追加します。
    </para>
<screen>&lt;disk type='network' device='disk'&gt;
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'&gt;
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/&gt;
        &lt;/source&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;</screen>
    <para>
     <replaceable>monitor-host</replaceable>を実際のホスト名に置き換え、必要に応じてプールまたはイメージ、あるいはその両方の名前を置き換えてください。Ceph Monitor用に複数の&lt;host&gt;エントリを追加できます。<literal>dev</literal>属性は、VMの<filename>/dev</filename>ディレクトリに表示される論理デバイス名です。オプションのbus属性は、エミュレートするディスクデバイスのタイプを示します。有効な設定はドライバ固有です(たとえば、ide、scsi、virtio、xen、usb、sataなど)。
    </para>
   </step>
   <step>
    <para>
     ファイルを保存します。
    </para>
   </step>
   <step>
    <para>
     Cephクラスタで認証が有効になっている場合(デフォルト)、秘密を生成する必要があります。好みのエディタを開き、次の内容で<filename>secret.xml</filename>という名前のファイルを作成します。
    </para>
<screen>&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;</screen>
   </step>
   <step>
    <para>
     秘密を定義します。
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-define --file secret.xml
&lt;uuid of secret is output here&gt;</screen>
   </step>
   <step>
    <para>
     <literal>client.libvirt</literal>の鍵を取得して、鍵の文字列をファイルに保存します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     秘密のUUIDを設定します。
    </para>
<screen><prompt role="root">root # </prompt>virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     さらに、前に入力した<literal>&lt;disk&gt;</literal>要素に次の<literal>&lt;auth&gt;</literal>エントリを追加することにより、秘密を手動で設定する必要もあります(uuidの値は、上のコマンドライン例の結果に置き換えます)。
    </para>
<screen><prompt role="root">root # </prompt>virsh edit libvirt-virtual-machine</screen>
    <para>
     続いて、ドメイン設定ファイルに<literal>&lt;auth&gt;&lt;/auth&gt;</literal>要素を追加します。
    </para>
<screen>...
&lt;/source&gt;
&lt;auth username='libvirt'&gt;
        &lt;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/&gt;
&lt;/auth&gt;
&lt;target ...</screen>
    <note>
     <para>
      この例で使用しているIDは<literal>libvirt</literal>で、<xref linkend="ceph-libvirt-cfg-ceph"/>の手順2で生成したCephユーザ名<literal>client.libvirt</literal>ではありません。生成したCephユーザ名のID部分を使用するようにしてください。何らかの理由で秘密を再生成する必要がある場合は、もう一度<command>sudo virsh secret-set-value</command>を実行する前に、<command>sudo virsh secret-undefine</command> <replaceable>uuid</replaceable>を実行する必要があります。
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-summary">
  <title>まとめ</title>

  <para>
   Cephで使用するためにVMを設定したら、VMを起動できます。VMとCephが通信していることを確認するには、次の手順を実行できます。
  </para>

  <procedure>
   <step>
    <para>
     Cephが動作しているかどうかを確認します。
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph health</screen>
   </step>
   <step>
    <para>
     VMが動作しているかどうかを確認します。
    </para>
<screen><prompt role="root">root # </prompt>virsh list</screen>
   </step>
   <step>
    <para>
     VMがCephと通信しているかどうかを確認します。<replaceable>vm-domain-name</replaceable>はVMドメインの名前に置き換えてください。
    </para>
<screen><prompt role="root">root # </prompt>virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     <literal>&amp;target dev='hdb' bus='ide'/&gt;</literal>のデバイスが<filename>/dev</filename>または<filename>/proc/partitions</filename>に表示されるかどうかを確認します。
    </para>
<screen><prompt>tux &gt; </prompt>ls /dev
<prompt>tux &gt; </prompt>cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
