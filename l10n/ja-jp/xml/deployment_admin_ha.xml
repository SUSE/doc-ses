<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_admin_ha.xml" version="5.0" xml:id="cha-admin-ha">
 <title>管理ノードのHAセットアップ</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>yes</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  <emphasis/>「管理ノード」はSalt Masterサービスが動作するCephクラスタノードです。管理ノードはSalt Minionサービスのクエリと命令を行うことで、他のクラスタノードを管理します。管理ノードには通常、ほかのサービスも含まれます。たとえば、「Prometheus」<emphasis/>監視ツールキットに支援された「Grafana」<emphasis/>ダッシュボードなどです。
 </para>
 <para>
  管理ノードに障害が発生した場合、通常は、動作する新しいハードウェアをノードに提供し、最新のバックアップから完全なクラスタ設定スタックを復元する必要があります。この方法では時間がかかり、クラスタの停止も発生します。
 </para>
 <para>
  管理ノードの障害によってCephクラスタのパフォーマンスにダウンタイムが発生するのを防止するため、Ceph管理ノードにはHA (高可用性)クラスタを利用することをお勧めします。
 </para>
 <sect1 xml:id="admin-ha-architecture">
  <title>管理ノードのHAクラスタの概要</title>

  <para>
   HAクラスタは、一方のクラスタノードで障害が発生した場合に、もう一方のノードがその役割(仮想化された管理ノードを含む)を自動的に引き継ぐという考えです。こうすることで、管理ノードに障害が発生したことを他のCephクラスタノードが認識することはありません。
  </para>

  <para>
   管理ノード用の最小限のHAソリューションには、次のハードウェアが必要です。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     High Availability ExtensionをインストールしたSUSE Linux Enterpriseを実行し、管理ノードを仮想化できるベアメタルサーバ2台。
    </para>
   </listitem>
   <listitem>
    <para>
     2つ以上の冗長ネットワーク通信パス。たとえば、ネットワークデバイスボンディングを使用します。
    </para>
   </listitem>
   <listitem>
    <para>
     管理ノード仮想マシンのディスクイメージをホストするための共有ストレージ。この共有ストレージは両方のサーバからアクセス可能である必要があります。たとえば、NFSエクスポート、Samba共有、iSCSIターゲットなどを使用できます。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   クラスタの要件の詳細については、<link xlink:href="https://documentation.suse.com/sle-ha/15-SP2/single-html/SLE-HA-install-quick/#sec-ha-inst-quick-req"/>を参照してください。
  </para>

  <figure>
   <title>管理ノードの2ノードHAクラスタ</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="ceph_admin_ha1.png" width="60%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="ceph_admin_ha1.png" width="60%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>
 </sect1>
 <sect1 xml:id="admin-ha-cluster">
  <title>管理ノードを有するHAクラスタの構築</title>

  <para>
   次の手順は、管理ノードを仮想化するためのHAクラスタを構築する手順の中で最も重要なものをまとめたものです。詳細については、記載のリンクを参照してください。
  </para>

  <procedure>
   <step>
    <para>
     共有ストレージを使用する基本的な2ノードHAクラスタを設定します。<link xlink:href="https://documentation.suse.com/sle-ha/15-SP2/single-html/SLE-HA-install-quick/#art-sleha-install-quick"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     両方のクラスタノードに、KVMハイパーバイザを実行するために必要なすべてのパッケージと<systemitem class="library">libvirt</systemitem>ツールキットをインストールします。<link xlink:href="https://documentation.suse.com/sles/15-SP2/single-html/SLES-virtualization/#sec-vt-installation-kvm"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     1つ目のクラスタノードで、<systemitem class="library">libvirt</systemitem>を利用する新しいKVM VM (仮想マシン)を作成します。<link xlink:href="https://documentation.suse.com/sles/15-SP2/single-html/SLES-virtualization/#sec-libvirt-inst-virt-install"/>を参照してください。事前設定済みの共有ストレージを使用して、VMのディスクイメージを保存します。
    </para>
   </step>
   <step>
    <para>
     VMのセットアップが完了したら、その設定を共有ストレージ上のXMLファイルにエクスポートします。以下の構文を使用してください。
    </para>
<screen>
<prompt role="root">root # </prompt>virsh dumpxml <replaceable>VM_NAME</replaceable> &gt; /path/to/shared/vm_name.xml
</screen>
   </step>
   <step>
    <para>
     管理ノードVMのリソースを作成します。HAリソースの作成に関する全般的な情報については、<link xlink:href="https://documentation.suse.com/sle-ha/15-SP2/single-html/SLE-HA-guide/#cha-conf-hawk2"/>を参照してください。KVM仮想マシンのリソースの作成に関する詳細情報については、<link xlink:href="http://www.linux-ha.org/wiki/VirtualDomain_%28resource_agent%29"/>を参照してください。
    </para>
   </step>
   <step>
    <para>
     新しく作成したVMゲストで、管理ノードと、そこで必要な追加サービスを展開します。<xref linkend="deploy-salt"/>の関連手順に従います。同時に、非HAクラスタサーバに残りのCephクラスタノードを展開します。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
