<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="manager_modules.xml" version="5.0" xml:id="cha-mgr-modules">
 <title>Módulos do Ceph Manager</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sim</dm:translation>
   <dm:release>SES 7</dm:release>
  </dm:docmanager>
 </info>
 <para>
  A arquitetura do Ceph Manager (consulte o <xref linkend="storage-intro-core-nodes"/> para ver uma breve introdução) permite estender a funcionalidade dele por meio de <emphasis>módulos</emphasis>, como “dashboard” (consulte o <xref linkend="part-dashboard"/>), “prometheus” (consulte o <xref linkend="monitoring-alerting"/>) ou “balancer”.
 </para>
 <para>
  Para listar todos os módulos disponíveis, execute:
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module ls
{
        "enabled_modules": [
                "restful",
                "status"
        ],
        "disabled_modules": [
                "dashboard"
        ]
}</screen>
 <para>
  Para habilitar ou desabilitar um módulo específico, execute:
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module enable <replaceable>MODULE-NAME</replaceable></screen>
 <para>
  Por exemplo:
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module disable dashboard</screen>
 <para>
  Para listar os serviços que os módulos habilitados oferecem, execute:
 </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr services
{
        "dashboard": "http://myserver.com:7789/",
        "restful": "https://myserver.com:8789/"
}</screen>
 <sect1 xml:id="mgr-modules-balancer">
  <title>Balanceador</title>

  <para>
   O módulo balanceador otimiza a distribuição do grupo de posicionamento (PG, placement group) entre os OSDs para uma implantação mais equilibrada. Embora o módulo esteja ativado por padrão, ele está inativo. Ele suporta estes dois modos: <literal>crush-compat</literal> e <literal>upmap</literal>.
  </para>

  <tip>
   <title>Status e configuração atuais do balanceador</title>
   <para>
    Para ver o status e as informações de configuração atuais do balanceador, execute:
   </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer status</screen>
  </tip>

  <sect2 xml:id="mgr-balancer-crush-compat">
   <title>O modo “crush-compat”</title>
   <para>
    No modo “crush-compat”, o balanceador ajusta os conjuntos de reweight dos OSDs para obter uma melhor distribuição dos dados. Ele move os PGs entre os OSDs, causando temporariamente um estado de cluster <literal>HEALTH_WARN</literal> resultante dos PGs deslocados.
   </para>
   <tip>
    <title>Ativação do Modo</title>
    <para>
     Embora o “crush-compat” seja o modo padrão, recomendamos ativá-lo explicitamente:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer mode crush-compat</screen>
   </tip>
  </sect2>

  <sect2 xml:id="mgr-balancer-planning-executing">
   <title>Planejando e executando o balanceamento de dados</title>
   <para>
    Usando o módulo balanceador, você pode criar um plano para balanceamento de dados. Em seguida, você pode executar o plano manualmente ou permitir que o balanceador equilibre os PGs continuamente.
   </para>
   <para>
    A decisão de executar o balanceador no modo manual ou automático depende de vários fatores, como desequilíbrio dos dados atuais, tamanho do cluster, contagem de PGs ou atividade de E/S. Recomendamos criar um plano inicial e executá-lo durante um momento de carga baixa de E/S no cluster. A razão para isso é que o desequilíbrio inicial provavelmente será considerável, e é uma boa prática manter um baixo impacto nos clientes. Após uma execução manual inicial, considere ativar o modo automático e monitorar o tráfego de redistribuição sob carga normal de E/S. As melhorias na distribuição de PGs precisam ser ponderadas em relação ao tráfego de redistribuição causado pelo balanceador.
   </para>
   <tip>
    <title>Fração Móvel de Grupos de Posicionamento (PGs)</title>
    <para>
     Durante o processo de balanceamento, o módulo balanceador limita os movimentos de PG para que apenas uma fração configurável de PGs seja movida. O padrão é 5%, e você pode ajustar a fração para 9%, por exemplo, executando o seguinte comando:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr target_max_misplaced_ratio .09</screen>
   </tip>
   <para>
    Para criar e executar um plano de balanceamento, siga estas etapas:
   </para>
   <procedure>
    <step>
     <para>
      Confira a pontuação atual do cluster:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer eval</screen>
    </step>
    <step>
     <para>
      Crie um plano. Por exemplo, "great_plan":
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer optimize great_plan</screen>
    </step>
    <step>
     <para>
      Veja que mudanças o “great_plan” fará:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer show great_plan</screen>
    </step>
    <step>
     <para>
      Confira a possível pontuação do cluster se você decidir aplicar o “great_plan”:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer eval great_plan</screen>
    </step>
    <step>
     <para>
      Execute o “great_plan” apenas uma vez:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer execute great_plan</screen>
    </step>
    <step>
     <para>
      Observe o balanceamento do cluster com o comando <command>ceph -s</command>. Se você estiver satisfeito com o resultado, ative o balanceamento automático:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer on</screen>
     <para>
      Posteriormente, se você decidir desativar o balanceamento automático, execute:
     </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph balancer off</screen>
    </step>
   </procedure>
   <tip>
    <title>Balanceamento Automático sem Plano Inicial</title>
    <para>
     Você pode ativar o balanceamento automático sem executar um plano inicial. Neste caso, espere uma redistribuição possivelmente longa dos grupos de posicionamento.
    </para>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="mgr-modules-telemetry">
  <title>Habilitando o módulo de telemetria</title>

  <para>
   O plug-in de telemetria envia os dados anônimos do projeto do Ceph sobre o cluster no qual o plug-in está sendo executado.
  </para>

  <para>
   Esse componente (aceitação) contém contadores e estatísticas sobre como o cluster foi implantado, a versão do Ceph, a distribuição dos hosts e outros parâmetros que ajudam o projeto a obter uma melhor compreensão da forma como o Ceph é usado. Ele não contém dados confidenciais, como nomes de pool, nomes de objeto, conteúdo de objeto ou nomes de host.
  </para>

  <para>
   O objetivo do módulo de telemetria é fornecer um loop de feedback automatizado para os desenvolvedores para ajudar a quantificar as taxas de adoção, o monitoramento ou apontar elementos que precisam ser mais bem explicados ou validados durante a configuração para evitar resultados indesejáveis.
  </para>

  <note>
   <para>
    O módulo de telemetria exige que os nós do Ceph Manager consigam transmitir dados por HTTPS para os servidores de upstream. Verifique se os firewalls corporativos permitem essa ação.
   </para>
  </note>

  <procedure>
   <step>
    <para>
     Para habilitar o módulo de telemetria:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph mgr module enable telemetry</screen>
    <note>
     <para>
      Esse comando apenas permite que você veja seus dados localmente. Esse comando não compartilha seus dados com a comunidade do Ceph.
     </para>
    </note>
   </step>
   <step>
    <para>
     Para permitir que o módulo de telemetria comece a compartilhar dados:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph telemetry on</screen>
   </step>
   <step>
    <para>
     Para desabilitar o compartilhamento de dados de telemetria:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph telemetry off</screen>
   </step>
   <step>
    <para>
     Para gerar um relatório JSON que pode ser impresso:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph telemetry show</screen>
   </step>
   <step>
    <para>
     Para adicionar um contato e uma descrição ao relatório:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/telemetry/contact John Doe john.doe@example.com
<prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/telemetry/description 'My first Ceph cluster'</screen>
   </step>
   <step>
    <para>
     Por padrão, o módulo compila e envia um novo relatório a cada 24 horas. Para ajustar esse intervalo:
    </para>
<screen><prompt>cephuser@adm &gt; </prompt>ceph config set mgr mgr/telemetry/interval <replaceable>HOURS</replaceable></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
