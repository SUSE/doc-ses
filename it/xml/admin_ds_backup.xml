<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Backup della configurazione e dei dati del cluster</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modifica</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>sì</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Questo capitolo illustra quali parti del cluster Ceph sottoporre a backup per il ripristino della funzionalità.
 </para>
 <sect1 xml:id="backup-ceph">
  <title>Backup della configurazione Ceph</title>

  <para>
   Eseguire il backup della directory <filename>/etc/ceph</filename> contenente la configurazione fondamentale del cluster. Il backup di <filename>/etc/ceph</filename> sarà ad esempio necessario quando occorre sostituire il nodo admin.
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-salt">
  <title>Backup della configurazione Salt</title>

  <para>
   È necessario eseguire il backup della directory <filename>/etc/salt</filename> contenente i file di configurazione Salt, ad esempio la chiave Salt master e le chiavi del client accettate.
  </para>

  <para>
   I file Salt non sono obbligatori per il backup del nodo admin, ma semplificano la ridistribuzione del cluster Salt. Se il backup di tali file non è presente, minion è necessario registrare nuovamente i Salt minion nel nuovo nodo admin.
  </para>

  <note>
   <title>sicurezza della chiave privata del Salt master</title>
   <para>
    Verificare che il backup della chiave privata del Salt master sia memorizzato in un'ubicazione sicura. La chiave del Salt master può essere utilizzata per gestire tutti i nodi del cluster.
   </para>
  </note>

  <para>
   Dopo il ripristino della directory <filename>/etc/salt</filename> da un backup, riavviare i servizi Salt:
  </para>

<screen><prompt>root@master # </prompt><command>systemctl</command> restart salt-master
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion</screen>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-deepsea">
  <title>Backup della configurazione DeepSea</title>

  <para>
   Tutti i file richiesti da DeepSea sono memorizzati in <filename>/srv/pillar/</filename>, <filename>/srv/salt/</filename> e <filename>/etc/salt/master.d</filename>.
  </para>

  <para>
   Se occorre ridistribuire il nodo admin, installare il pacchetto DeepSea sul nuovo nodo e spostare nuovamente i dati di backup nelle directory. È quindi possibile utilizzare di nuovo DeepSea senza ulteriori modifiche. Prima di riutilizzare DeepSea, assicurarsi che tutti i Salt minion siano registrati correttamente sul nodo admin.
  </para>
 </sect1>
 <sect1 xml:id="backup-config-files">
  <title>Backup delle configurazioni personalizzate</title>

  <itemizedlist>
   <listitem>
    <para>
     Dati e personalizzazione di Prometheus.
    </para>
   </listitem>
   <listitem>
    <para>
     Personalizzazione di Grafana.
    </para>
   </listitem>
   <listitem>
    <para>
     Verificare di disporre di un record degli utenti openATTIC esistenti per poter creare nuovi account per questi ultimi nel Ceph Dashboard.
    </para>
   </listitem>
   <listitem>
    <para>
     Modifiche manuali a <filename>ceph.conf</filename> all'esterno di DeepSea.
    </para>
   </listitem>
   <listitem>
    <para>
     Modifiche manuali alla configurazione iSCSI all'esterno di DeepSea.
    </para>
   </listitem>
   <listitem>
    <para>
     Chiavi Ceph.
    </para>
   </listitem>
   <listitem>
    <para>
     Mappa CRUSH e regole CRUSH. Salvare la mappa CRUSH non compilata, incluse le regole CRUSH, in <filename>crushmap-backup.txt</filename> eseguendo il comando seguente:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
   </listitem>
   <listitem>
    <para>
     Configurazione del gateway Samba. Se si utilizza un gateway singolo, eseguire il backup di <filename>/etc/samba/smb.conf</filename>. Se si utilizza una configurazione ad alta disponibilità, eseguire il backup anche dei file di configurazione di CTDB e di Pacemaker. Fare riferimento al <xref linkend="cha-ses-cifs"/> per i dettagli sulla configurazione utilizzata dai gateway Samba.
    </para>
   </listitem>
   <listitem>
    <para>
     Configurazione di NFS Ganesha. Necessaria soltanto se si utilizza una configurazione ad alta disponibilità. Fare riferimento al <xref linkend="cha-ceph-nfsganesha"/> per i dettagli sulla configurazione utilizzata da NFS Ganesha.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
