<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_gateway.xml" version="5.0" xml:id="cha-ceph-gw">

 <title>Ceph Object Gateway</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/maintenance/ses6/xml/</dm:editurl>
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modifica</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>sì</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  In questo capitolo vengono fornite ulteriori informazioni sui task amministrativi correlati a Object Gateway, come la verifica dello stato del servizio, la gestione degli account, i gateway multisito o l'autenticazione LDAP.
 </para>
 <sect1 xml:id="sec-ceph-rgw-limits">
  <title>Restrizioni e limiti di denominazione di Object Gateway</title>

  <para>
   Di seguito è riportato un elenco di importanti limiti Object Gateway:
  </para>

  <sect2 xml:id="ogw-limits-bucket">
   <title>Limiti dei compartimenti</title>
   <para>
    Quando si inizia a utilizzare Object Gateway tramite l'API S3, i nomi dei compartimenti sono limitati ai nomi conformi a DNS in cui è consentito un trattino "-". Quando si inizia a utilizzare Object Gateway tramite l'API Swift, è possibile utilizzare una combinazione qualsiasi di caratteri UTF-8 supportati, tranne la barra "/". La lunghezza massima di un nome di compartimento è di 255 caratteri. I nomi dei compartimenti devono essere univoci.
   </para>
   <tip>
    <title>utilizzo di nomi di compartimenti conformi a DNS</title>
    <para>
     Sebbene sia possibile utilizzare qualsiasi nome di compartimento basato su UTF-8 tramite l'API Swift, si consiglia di denominare i compartimenti tenendo in considerazione i limiti di denominazione S3 in modo da evitare problemi di accesso allo stesso compartimento tramite l'API S3.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ogw-limits-object">
   <title>Limiti degli oggetti memorizzati</title>
   <variablelist>
    <varlistentry>
     <term>Numero massimo di oggetti per utente</term>
     <listitem>
      <para>
       Per default, nessuna restrizione (limite definito da ~ 2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Numero massimo di oggetti per compartimento</term>
     <listitem>
      <para>
       Per default, nessuna restrizione (limite definito da ~ 2^63).
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>Dimensioni massime di un oggetto di cui effettuare l'upload/da memorizzare</term>
     <listitem>
      <para>
       Gli upload singoli sono limitati a 5 GB. Utilizzare multipart per dimensioni grandi degli oggetti. Il numero massimo di porzioni multipart è 10000.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ogw-limits-http">
   <title>Limiti dell'intestazione HTTP</title>
   <para>
    L'intestazione HTTP e il limite di richiesta dipendono dalla front-end Web utilizzata. L'oggetto beast di default limita le dimensioni dell'intestazione HTTP a 16 KB.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-deploy">
  <title>Distribuzione di Object Gateway</title>

  <para>
   Il metodo di distribuzione consigliato per Ceph Object Gateway è tramite l'infrastruttura DeepSea aggiungendo le righe <literal>role-rgw [...]</literal> pertinenti nel file <filename>policy.cfg</filename> sul Salt master ed eseguendo le fasi DeepSea richieste.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Per includere Object Gateway durante il processo di distribuzione del cluster Ceph, fare riferimento a <xref linkend="ceph-install-stack"/> e <xref linkend="policy-configuration"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Per aggiungere il ruolo Object Gateway a un cluster già distribuito, fare riferimento a <xref linkend="salt-adding-services"/>.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="ceph-rgw-operating">
  <title>Funzionamento del servizio Object Gateway</title>

  <para>
   Il servizio Object Gateway viene attivato con il comando <command>systemctl</command>. Per attivare il servizio Object Gateway è necessario disporre dei diritti <systemitem class="username">root</systemitem>. <replaceable>GATEWAY_HOST</replaceable> è il nome host del server di cui è necessario attivare l'istanza Object Gateway.
  </para>

  <para>
   Per il servizio Object Gateway sono supportati i seguenti comandi:
  </para>

  <variablelist>
   <varlistentry>
    <term>systemctl status ceph-radosgw@rgw.<replaceable>GATEWAY_HOST</replaceable></term>
    <listitem>
     <para>
      Stampa le informazioni sullo stato del servizio.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>systemctl start ceph-radosgw@rgw.<replaceable>GATEWAY_HOST</replaceable></term>
    <listitem>
     <para>
      Avvia il servizio nel caso non sia già in esecuzione.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>systemctl restart ceph-radosgw@rgw.<replaceable>GATEWAY_HOST</replaceable></term>
    <listitem>
     <para>
      Riavvia il servizio.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>systemctl stop ceph-radosgw@rgw.<replaceable>GATEWAY_HOST</replaceable></term>
    <listitem>
     <para>
      Interrompe il servizio in esecuzione.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>systemctl enable ceph-radosgw@rgw.<replaceable>GATEWAY_HOST</replaceable></term>
    <listitem>
     <para>
      Abilita il servizio in modo che venga avviato automaticamente all'avvio del sistema.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>systemctl disable ceph-radosgw@rgw.<replaceable>GATEWAY_HOST</replaceable></term>
    <listitem>
     <para>
      Disabilita il servizio in modo che non venga avviato automaticamente all'avvio del sistema.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="ogw-config-parameters">
  <title>Opzioni di configurazione</title>

  <para>
   Fare riferimento alla <xref linkend="config-ogw"/> per un elenco delle opzioni di configurazione di Object Gateway.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-access">
  <title>Gestione dell'accesso a Object Gateway</title>

  <para>
   È possibile comunicare con Object Gateway mediante l'interfaccia compatibile con S3 o Swift. L'interfaccia S3 è compatibile con un grande sottoinsieme dell'API Amazon S3 RESTful. L'interfaccia Swift è compatibile con un grande sottoinsieme dell'API OpenStack Swift.
  </para>

  <para>
   Per entrambe le interfacce è richiesto di creare un utente specifico e installare il software client pertinente per comunicare con il gateway che utilizza la chiave segreta dell'utente.
  </para>

  <sect2 xml:id="accessing-ragos-gateway">
   <title>Accesso a Object Gateway</title>
   <sect3>
    <title>Accesso all'interfaccia S3</title>
    <para>
     Per accedere all'interfaccia S3, è necessario un client REST. <command>S3cmd</command> è un client S3 della riga di comando. È possibile trovarlo in <link xlink:href="https://build.opensuse.org/package/show/Cloud:Tools/s3cmd">openSUSE Build Service (OBS)</link> (in lingua inglese). L'archivio contiene versioni di entrambe le distribuzioni basate su SUSE Linux Enterprise e openSUSE.
    </para>
    <para>
     Se si desidera testare l'accesso all'interfaccia S3, è anche possibile scrivere un piccolo script Python, che consentirà di eseguire la connessione a Object Gateway, creare un nuovo compartimento ed elencare tutti i compartimenti. I valori per <option>aws_access_key_id</option> e <option>aws_secret_access_key</option> sono ricavati dai valori di <option>access_key</option> e <option>secret_key</option> restituiti dal comando <command>radosgw_admin</command> di cui alla <xref linkend="adding-s3-swift-users"/>.
    </para>
    <procedure>
     <step>
      <para>
       Installare il pacchetto <systemitem>python-boto</systemitem>:
      </para>
<screen><prompt>root # </prompt>zypper in python-boto</screen>
     </step>
     <step>
      <para>
       Creare un nuovo script Python denominato <filename>s3test.py</filename> con il seguente contenuto: <remark role="fixme">Provide script in RPM? Is it really necessary to create pool? This script is not necessary at all, remove it from documentation?</remark>
      </para>
<screen>import boto
import boto.s3.connection
access_key = '11BS02LGFB6AL6H1ADMW'
secret_key = 'vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY'
conn = boto.connect_s3(
aws_access_key_id = access_key,
aws_secret_access_key = secret_key,
host = '<replaceable>HOSTNAME</replaceable>',
is_secure=False,
calling_format = boto.s3.connection.OrdinaryCallingFormat(),
)
bucket = conn.create_bucket('my-new-bucket')
for bucket in conn.get_all_buckets():
  print "<replaceable>NAME</replaceable>\t<replaceable>CREATED</replaceable>".format(
  name = bucket.name,
  created = bucket.creation_date,
  )</screen>
      <para>
       Sostituire <literal><replaceable>HOSTNAME</replaceable></literal> con il nome host dell'host in cui è stato configurato il servizio Object Gateway, ad esempio <literal>gateway_host</literal>.
      </para>
     </step>
     <step>
      <para>
       Eseguire lo script:
      </para>
<screen>python s3test.py</screen>
      <para>
       L'output dello script è simile a quanto riportato di seguito:
      </para>
<screen>my-new-bucket 2015-07-22T15:37:42.000Z</screen>
     </step>
    </procedure>
   </sect3>
   <sect3>
    <title>Accesso all'interfaccia Swift</title>
    <para>
     Per accedere a Object Gateway tramite l'interfaccia Swift, è necessario il client della riga di comando <command>swift</command>. Nella relativa documentazione <command>man 1 swift</command> sono fornite ulteriori informazioni sulle rispettive opzioni della riga di comando.
    </para>
    <para>
     Il pacchetto è incluso nel modulo "Public cloud" di SUSE Linux Enterprise 12 a partire da SP3 e di SUSE Linux Enterprise 15. Prima di installare il pacchetto, è necessario attivare il modulo e aggiornare l'archivio software:
    </para>
<screen><prompt>root # </prompt>SUSEConnect -p sle-module-public-cloud/12/x86_64
sudo zypper refresh</screen>
    <para>
     Oppure
    </para>
<screen><prompt>root # </prompt>SUSEConnect -p sle-module-public-cloud/15/x86_64
<prompt>root # </prompt>zypper refresh</screen>
    <para>
     Per installare il comando <command>swift</command>, eseguire quanto riportato di seguito:
    </para>
<screen><prompt>root # </prompt>zypper in python-swiftclient</screen>
    <para>
     Per l'accesso swift si utilizza la seguente sintassi:
    </para>
<screen><prompt>tux &gt; </prompt>swift -A http://<replaceable>IP_ADDRESS</replaceable>/auth/1.0 \
-U example_user:swift -K '<replaceable>SWIFT_SECRET_KEY</replaceable>' list</screen>
    <para>
     Sostituire <replaceable>IP_ADDRESS</replaceable> con l'indirizzo IP del server gateway e <replaceable>SWIFT_SECRET_KEY</replaceable> con il valore corrispondente dell'output del comando <command>radosgw-admin key create</command> eseguito per l'utente <systemitem>swift</systemitem> nella <xref linkend="adding-s3-swift-users"/>.
    </para>
    <para>
     Ad esempio:
    </para>
<screen><prompt>tux &gt; </prompt>swift -A http://gateway.example.com/auth/1.0 -U example_user:swift \
-K 'r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h' list</screen>
    <para>
     L'output è:
    </para>
<screen>my-new-bucket</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="s3-swift-accounts-managment">
   <title>Gestione degli account S3 e Swift</title>
   <sect3 xml:id="adding-s3-swift-users">
    <title>Aggiunta di utenti S3 e Swift</title>
    <para>
     Per abilitare gli utenti finali all'iterazione con il gateway, è necessario creare un utente, una chiave di accesso e un segreto. Esistono due tipi di utenti: un <emphasis>utente</emphasis> e un <emphasis>sottoutente</emphasis>. Mentre gli <emphasis>utenti</emphasis> vengono utilizzati per l'iterazione con l'interfaccia S3, i <emphasis>sottoutenti</emphasis> sono gli utenti dell'interfaccia Swift. Ciascun sottoutente è associato a un utente.
    </para>
    <para>
     È anche possibile aggiungere gli utenti tramite il file DeepSea <filename>rgw.sls</filename>. Per un esempio, vedere <xref linkend="ceph-nfsganesha-customrole-rgw-multiusers"/>.
    </para>
    <para>
     Per creare un utente Swift, seguire la procedura indicata:
    </para>
    <procedure>
     <step>
      <para>
       Per creare un utente Swift, che nella nostra terminologia è denominato <emphasis>sottoutente</emphasis>, prima è necessario creare l'<emphasis>utente</emphasis> associato.
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
      <para>
       Ad esempio:
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
     </step>
     <step>
      <para>
       Per creare un sottoutente (interfaccia Swift) per l'utente, occorre specificare l'ID utente (--uid=<replaceable>USERNAME</replaceable>) nonché l'ID e il livello di accesso del sottoutente.
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin subuser create --uid=<replaceable>UID</replaceable> \
 --subuser=<replaceable>UID</replaceable> \
 --access=[ <replaceable>read | write | readwrite | full</replaceable> ]</screen>
      <para>
       Ad esempio:
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin subuser create --uid=example_user \
 --subuser=example_user:swift --access=full</screen>
     </step>
     <step>
      <para>
       Generare una chiave segreta per l'utente.
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin key create \
   --gen-secret \
   --subuser=example_user:swift \
   --key-type=swift</screen>
     </step>
     <step>
      <para>
       L'output di entrambi i comandi saranno i dati formattati per JSON in cui è visualizzato lo stato dell'utente. Osservare le righe seguenti e ricordare il valore di <literal>secret_key</literal>:
      </para>
<screen>"swift_keys": [
   { "user": "example_user:swift",
     "secret_key": "r5wWIxjOCeEO7DixD1FjTLmNYIViaC6JVhi3013h"}],</screen>
     </step>
    </procedure>
    <para/>
    <para>
     Se si accede a Object Gateway tramite l'interfaccia S3, è necessario creare un utente S3 eseguendo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user create --uid=<replaceable>USERNAME</replaceable> \
 --display-name="<replaceable>DISPLAY-NAME</replaceable>" --email=<replaceable>EMAIL</replaceable></screen>
    <para>
     Ad esempio:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user create \
   --uid=example_user \
   --display-name="Example User" \
   --email=penguin@example.com</screen>
    <para>
     Con questo comando si creano anche la chiave di accesso e la chiave segreta dell'utente. Verificare l'output per le parole chiave <literal>access_key</literal> e <literal>secret_key</literal> e i rispettivi valori:
    </para>
<screen>[...]
 "keys": [
       { "user": "example_user",
         "access_key": "11BS02LGFB6AL6H1ADMW",
         "secret_key": "vzCEkuryfn060dfee4fgQPqFrncKEIkh3ZcdOANY"}],
 [...]</screen>
   </sect3>
   <sect3 xml:id="removing-s3-swift-users">
    <title>Rimozione di utenti S3 e Swift</title>
    <para>
     La procedura di eliminazione degli utenti S3 e Swift è simile. Nel caso degli utenti Swift però potrebbe essere necessario eliminare l'utente e i rispettivi sottoutenti.
    </para>
    <para>
     Per rimuovere un utente S3 o Swift (inclusi tutti i rispettivi sottoutenti), specificare <option>user rm</option> e l'ID utente nel seguente comando:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user rm --uid=example_user</screen>
    <para>
     Per rimuovere un sottoutente, specificare <option>subuser rm</option> e l'ID sottoutente.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin subuser rm --uid=example_user:swift</screen>
    <para>
     È possibile utilizzare una delle seguenti opzioni:
    </para>
    <variablelist>
     <varlistentry>
      <term>--purge-data</term>
      <listitem>
       <para>
        Elimina definitivamente tutti i dati associato all'ID utente.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>--purge-keys</term>
      <listitem>
       <para>
        Elimina definitivamente tutte le chiavi associate all'ID utente.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <tip>
     <title>rimozione di un sottoutente</title>
     <para>
      Quando si rimuove un sottoutente, si rimuove l'accesso all'interfaccia Swift. L'utente rimarrà nel sistema.
     </para>
    </tip>
   </sect3>
   <sect3 xml:id="changing-s3-swift-users-password">
    <title>Modifica delle chiavi di accesso e segrete degli utenti S3 e Swift</title>
    <para>
     I parametri di <literal>access_key</literal> e <literal>secret_key</literal> identificano l'utente Object Gateway nel momento in cui accede al gateway. Modificare chiavi utente esistenti è come crearne di nuove, in quanto le chiavi precedenti vengono sovrascritte.
    </para>
    <para>
     Per gli utenti S3, eseguire quanto riportato di seguito:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin key create --uid=<replaceable>EXAMPLE_USER</replaceable> --key-type=s3 --gen-access-key --gen-secret</screen>
    <para>
     Per gli utenti Swift, eseguire quanto riportato di seguito:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin key create --subuser=<replaceable>EXAMPLE_USER</replaceable>:swift --key-type=swift --gen-secret</screen>
    <variablelist>
     <varlistentry>
      <term><option>--key-type=<replaceable>TYPE</replaceable></option></term>
      <listitem>
       <para>
        Specifica il tipo di chiave. <literal>swift</literal> o <literal>s3</literal>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-access-key</option></term>
      <listitem>
       <para>
        Genera una chiave di accesso casuale (di default per l'utente S3).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--gen-secret</option></term>
      <listitem>
       <para>
        Genera una chiave segreta casuale.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--secret=<replaceable>KEY</replaceable></option></term>
      <listitem>
       <para>
        Specifica una chiave segreta, ad esempio una chiave generata manualmente.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="user-quota-managment">
    <title>Gestione delle quote utente</title>
    <para>
     Ceph Object Gateway consente di impostare le quote su utenti e compartimenti di proprietà degli utenti. Le quote includono il numero massimo di oggetti in un compartimento e le dimensioni massime di memorizzazione espresse in megabyte.
    </para>
    <para>
     Prima di abilitare una quota utente, è necessario impostarne i parametri:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin quota set --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable> \
 --max-objects=1024 --max-size=1024</screen>
    <variablelist>
     <varlistentry>
      <term><option>--max-objects</option></term>
      <listitem>
       <para>
        Specifica il numero massimo di oggetti. Con un numero negativo la verifica viene disabilitata.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--max-size</option></term>
      <listitem>
       <para>
        Specifica il numero massimo di byte. Con un numero negativo la verifica viene disabilitata.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>--quota-scope</option></term>
      <listitem>
       <para>
        Specifica l'ambito della quota. Le opzioni sono <literal>bucket</literal> e <literal>user</literal>. Le quote dei compartimenti si riferiscono ai compartimenti di proprietà di un utente. Le quote utente si riferiscono a un utente.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Una volta impostata una quota utente, è possibile abilitarla:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin quota enable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Per disabilitare una quota:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin quota disable --quota-scope=user --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Per elencare le impostazioni della quota:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user info --uid=<replaceable>EXAMPLE_USER</replaceable></screen>
    <para>
     Per aggiornare le statistiche della quota:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user stats --uid=<replaceable>EXAMPLE_USER</replaceable> --sync-stats</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-http-frontends">
  <title>Front-end HTTP</title>

  <para>
   Ceph Object Gateway supporta due front-end HTTP integrati: <emphasis>oggetto beast</emphasis> e <emphasis>Civetweb</emphasis>.
  </para>

  <para>
   Il front-end dell'oggetto beast utilizza la libreria Boost.Beast per l'analisi HTTP e la libreria Boost.Asio per l'I/O di rete asincrono.
  </para>

  <para>
   Il front-end Civetweb utilizza la libreria HTTP Civetweb, che è un fork di Mongoose.
  </para>

  <para>
   È possibile configurarli con l'opzione <option>rgw_frontends</option> nel file <filename>/etc/ceph/ceph.conf</filename>. Fare riferimento alla <xref linkend="config-ogw"/> per un elenco delle opzioni di configurazione.
  </para>
 </sect1>
 <sect1 xml:id="ceph-rgw-https">
  <title>Abilitazione di HTTPS/SSL per gli Object Gateway</title>

  <para>
   Per abilitare il ruolo Object Gateway di default per la comunicazione sicura tramite SSL, occorre disporre di un certificato emesso da una CA o crearne uno firmato da se stessi. È possibile configurare Object Gateway con HTTPS in due modi diversi: uno semplice in cui vengono utilizzate le impostazioni di default e un modo avanzato che consente di ottimizzare le impostazioni correlate ad HTTPS.
  </para>

  <sect2 xml:id="ogw-selfcert">
   <title>Creazione di un certificato firmato da se stessi</title>
   <tip>
    <para>
     Ignorare questa sezione se si dispone già di un certificato valido firmato dalla CA.
    </para>
   </tip>
   <para>
    Per default, DeepSea si aspetta che il file certificato sia in <filename>/srv/salt/ceph/rgw/cert/rgw.pem</filename> nel Salt master. Il certificato verrà quindi distribuito a <filename>/etc/ceph/rgw.pem</filename> nel Salt minion con il ruolo Object Gateway, dove viene letto da Ceph.
   </para>
   <para>
    Nella procedura seguente è illustrato come generare un certificato SSL firmato da se stessi sul Salt master.
   </para>
   <procedure>
    <step>
     <para>
      Se è necessario che Object Gateway sia noto ad altre identità di oggetto, aggiungerle all'opzione <option>subjectAltName</option> nella sezione <literal>[v3_req]</literal> del file <filename>/etc/ssl/openssl.cnf</filename>:
     </para>
<screen>
[...]
[ v3_req ]
subjectAltName = DNS:server1.example.com DNS:server2.example.com
[...]
</screen>
     <tip>
      <title>indirizzi IP in <option>subjectAltName</option></title>
      <para>
       Per utilizzare gli indirizzi IP al posto dei nomi di dominio nell'opzione <option>subjectAltName</option>, sostituire la riga di esempio con quanto segue:
      </para>
<screen>
subjectAltName = IP:10.0.0.10 IP:10.0.0.11
</screen>
     </tip>
    </step>
    <step>
     <para>
      Creare la chiave e il certificato utilizzando <command>openssl</command>. Immettere tutti i dati che è necessario includere nel certificato. Si consiglia di immettere FQDN come nome comune. Prima di firmare il certificato, verificare che "X509v3 Subject Alternative Name:" sia incluso nelle estensioni richieste e che sia impostato nel certificato che viene generato.
     </para>
<screen>
<prompt>root@master # </prompt>openssl req -x509 -nodes -days 1095 \
 -newkey rsa:4096 -keyout rgw.key -out /srv/salt/ceph/rgw/cert/rgw.pem
</screen>
    </step>
    <step>
     <para>
      Aggiungere la chiave al file di certificato:
     </para>
<screen>
<prompt>root@master # </prompt>cat rgw.key &gt;&gt; /srv/salt/ceph/rgw/cert/rgw.pem
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-ssl-simple">
   <title>Configurazione HTTPS semplice</title>
   <para>
    Per default, Ceph sul nodo Object Gateway legge il certificato <filename>/etc/ceph/rgw.pem</filename> e utilizza la porta 443 per la comunicazione SSL sicura. Se non è necessario modificare questi valori, seguire la procedura indicata di seguito:
   </para>
   <procedure>
    <step>
     <para>
      Modificare <filename>/srv/pillar/ceph/stack/global.yml</filename> e aggiungere la riga seguente:
     </para>
<screen>
rgw_init: default-ssl
</screen>
    </step>
    <step>
     <para>
      Copiare la configurazione SSL di Object Gateway di default nella sottodirectory <filename>ceph.conf.d</filename>:
     </para>
<screen>
<prompt>root@master # </prompt>cp /srv/salt/ceph/configuration/files/rgw-ssl.conf \
 /srv/salt/ceph/configuration/files/ceph.conf.d/rgw.conf
</screen>
    </step>
    <step>
     <para>
      Eseguire le fasi 2, 3 e 4 di DeepSea per applicare le modifiche:
     </para>
<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.stage.2
<prompt>root@master # </prompt>salt-run state.orch ceph.stage.3
<prompt>root@master # </prompt>salt-run state.orch ceph.stage.4
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-ssl-advanced">
   <title>Configurazione HTTPS avanzata</title>
   <para>
    Se è necessario modificare i valori di default per le impostazioni SSL di Object Gateway, seguire la procedura indicata di seguito:
   </para>
   <procedure>
    <step>
     <para>
      Modificare <filename>/srv/pillar/ceph/stack/global.yml</filename> e aggiungere la riga seguente:
     </para>
<screen>
rgw_init: default-ssl
</screen>
    </step>
    <step>
     <para>
      Copiare la configurazione SSL di Object Gateway di default nella sottodirectory <filename>ceph.conf.d</filename>:
     </para>
<screen>
<prompt>root@master # </prompt>cp /srv/salt/ceph/configuration/files/rgw-ssl.conf \
 /srv/salt/ceph/configuration/files/ceph.conf.d/rgw.conf
</screen>
    </step>
    <step>
     <para>
      Modificare <filename>/srv/salt/ceph/configuration/files/ceph.conf.d/rgw.conf</filename> e le opzioni di default, come il numero porta o il percorso del certificato SSL in modo che riflettano la configurazione impostata.
     </para>
    </step>
    <step>
     <para>
      Eseguire le fasi 3 e 4 di DeepSea per applicare le modifiche:
     </para>
<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.stage.3
<prompt>root@master # </prompt>salt-run state.orch ceph.stage.4
</screen>
    </step>
   </procedure>
   <tip xml:id="rgw-webserver-multiport">
    <title>associazione di più porte</title>
    <para>
     Il server Oggetto beast può essere associato a più porte. Tale funzione è utile se è necessario accedere a un'istanza singola di Object Gateway con entrambe le connessioni SSL e non SSL. Di seguito è riportato un esempio di riga di configurazione con due porte:
    </para>
<screen>[client.{{ client }}]
rgw_frontends = beast port=80 ssl_port=443 ssl_certificate=/etc/ceph/rgw.pem</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-sync">
  <title>Moduli di sincronizzazione</title>

  <para>
   La funzionalità <emphasis>multisite</emphasis> di Object Gateway consente di creare più zone e di eseguire la copia speculare dei dati e dei metadati tra loro. I <emphasis>moduli di sincronizzazione</emphasis> sono costruiti in cima al framework multisito che consente l'inoltro di dati e metadati a un livello esterno diverso. Un modulo di sincronizzazione consente di eseguire un set di azioni ogni volta che ha luogo una modifica dei dati (ad esempio, operazioni correlate ai metadati come la creazione di compartimenti o di utenti). Poiché le modifiche del multisito Object Gateway sono coerenti nei siti remoti, le modifiche vengono propagate in modo asincrono. Questo concetto comprende casi d'uso come il backup della memorizzazione di oggetti in un cluster cloud esterno, una soluzione di backup personalizzata in cui vengono utilizzate unità nastro o l'indicizzazione dei metadati in ElasticSearch.
  </para>

  <sect2 xml:id="ogw-sync-general-config">
   <title>Configurazione generale</title>
   <para>
    Tutti i moduli di sincronizzazione vengono configurati in modo simile. È necessario creare una nuova zona (fare riferimento alla <xref linkend="ceph-rgw-fed"/> per ulteriori dettagli) e impostare la relativa opzione <option>--tier_type</option>, ad esempio <option>--tier-type=cloud</option>, per il modulo di sincronizzazione cloud:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --endpoints=http://endpoint1.example.com,http://endpoint2.example.com, [...] \
 --tier-type=cloud
</screen>
   <para>
    È possibile configurare un livello specifico tramite il comando seguente:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=<replaceable>KEY1</replaceable>=<replaceable>VALUE1</replaceable>,<replaceable>KEY2</replaceable>=<replaceable>VALUE2</replaceable>
</screen>
   <para>
    La variabile <replaceable>KEY</replaceable> della configurazione specifica la variabile di configurazione da aggiornare, mentre <replaceable>VALUE</replaceable> specifica il nuovo valore corrispondente. È possibile accedere ai valori nidificati utilizzando il punto. Ad esempio:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=connection.access_key=<replaceable>KEY</replaceable>,connection.secret=<replaceable>SECRET</replaceable>
</screen>
   <para>
    È possibile accedere agli elementi della matrice aggiungendo delle parentesi quadre "[]" all'elemento a cui si fa riferimento. È possibile aggiungere un nuovo elemento della matrice utilizzando le parentesi quadre "[]". Il valore di indice -1 fa riferimento all'ultimo elemento della matrice. Non è possibile creare un nuovo elemento e farvi nuovamente riferimento nello stesso comando. Ad esempio, di seguito è riportato un comando per la creazione di un nuovo profilo per i compartimenti che iniziano con <replaceable>PREFIX</replaceable>:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[].source_bucket=<replaceable>PREFIX</replaceable>'*'
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone modify --rgw-zonegroup=<replaceable>ZONE-GROUP-NAME</replaceable> \
 --rgw-zone=<replaceable>ZONE-NAME</replaceable> \
 --tier-config=profiles[-1].connection_id=<replaceable>CONNECTION_ID</replaceable>,profiles[-1].acls_id=<replaceable>ACLS_ID</replaceable>
</screen>
   <tip>
    <title>aggiunta e rimozione delle voci di configurazione</title>
    <para>
     Tramite il parametro <option>--tier-config-add=<replaceable/>=<replaceable>VALUE</replaceable></option>, è possibile aggiungere una nuova voce di configurazione del livello.
    </para>
    <para>
     Per rimuovere una voce esistente, utilizzare <option>--tier-config-rm=<replaceable>KEY</replaceable></option>.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-zones">
   <title>Sincronizzazione delle zone</title>
   <para>
    La configurazione di un modulo di sincronizzazione viene eseguita a livello locale in una zona. Il modulo di sincronizzazione determina se i dati vengono esportati dalla zona o se questa utilizza solo dati modificati in un'altra zona. A partire da Luminous, i plug-in di sincronizzazione supportati sono <literal>ElasticSearch</literal>, <literal>rgw</literal>, il plug-in di sincronizzazione di default mediante il quale vengono sincronizzati i dati tra le zone, e <literal>log</literal>, un plug-in di sincronizzazione semplice che registra le operazioni dei metadati che hanno luogo nelle zone remote. Nelle sezioni seguenti è riportato l'esempio di una zona in cui viene utilizzato il modulo di sincronizzazione <literal>ElasticSearch</literal>. Il processo è simile a quello utilizzato per la configurazione di qualsiasi altro plug-in di sincronizzazione.
   </para>
   <note>
    <title>plug-in di sincronizzazione di default</title>
    <para>
     <literal>rgw</literal> è il plug-in di sincronizzazione di default e non è necessario configurarlo esplicitamente.
    </para>
   </note>
   <sect3 xml:id="ceph-rgw-sync-zones-req">
    <title>Requisiti e presupposti</title>
    <para>
     Si supponga una semplice configurazione multisito, come descritta nella <xref linkend="ceph-rgw-fed"/>, costituita da 2 zone: <literal>us-east</literal> e <literal>us-west</literal>. Adesso si aggiunge una terza zona <literal>us-east-es</literal> nella quale vengono elaborati solo i metadati provenienti da altri siti. Questa zona può essere nello stesso cluster Ceph di <literal>us-east</literal> o in uno diverso. In questa zona vengono utilizzati solo i metadati provenienti da altre zone e gli Object Gateway in essa contenuti non serviranno direttamente alcuna richiesta dell'utente finale.
    </para>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-zones-configure">
    <title>Configurazione dei moduli di sincronizzazione</title>
    <procedure>
     <step>
      <para>
       Creare una terza zona simile a quelle descritte nella <xref linkend="ceph-rgw-fed"/>, ad esempio
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> zone create --rgw-zonegroup=us --rgw-zone=us-east-es \
--access-key=<replaceable>SYSTEM-KEY</replaceable> --secret=<replaceable>SECRET</replaceable> --endpoints=http://rgw-es:80
      </screen>
     </step>
     <step>
      <para>
       È possibile configurare un modulo di sincronizzazione per questa zona nel modo seguente
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=<replaceable>TIER-TYPE</replaceable> \
--tier-config={set of key=value pairs}
      </screen>
     </step>
     <step>
      <para>
       Ad esempio, nel modulo di sincronizzazione <literal>ElasticSearch</literal>
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --tier-type=elasticsearch \
--tier-config=endpoint=http://localhost:9200,num_shards=10,num_replicas=1
      </screen>
      <para>
       Per le varie opzioni tier-config supportate, fare riferimento a <xref linkend="ceph-rgw-sync-elastic"/>.
      </para>
     </step>
     <step>
      <para>
       Infine, aggiornare il periodo
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> period update --commit
      </screen>
     </step>
     <step>
      <para>
       Adesso avviare radosgw nella zona
      </para>
<screen>
<prompt>root # </prompt><command>systemctl</command> start ceph-radosgw@rgw.`hostname -s`
<prompt>root # </prompt><command>systemctl</command> enable ceph-radosgw@rgw.`hostname -s`
      </screen>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-sync-elastic">
   <title>Modulo di sincronizzazione ElasticSearch</title>
   <para>
    Questo modulo di sincronizzazione consente di scrivere in ElasticSearch i metadati provenienti da altre zone. A partire da Luminous, è il formato JSON dei campi dei dati che attualmente vengono memorizzati in ElasticSearch.
   </para>
<screen>
{
  "_index" : "rgw-gold-ee5863d6",
  "_type" : "object",
  "_id" : "34137443-8592-48d9-8ca7-160255d52ade.34137.1:object1:null",
  "_score" : 1.0,
  "_source" : {
    "bucket" : "testbucket123",
    "name" : "object1",
    "instance" : "null",
    "versioned_epoch" : 0,
    "owner" : {
      "id" : "user1",
      "display_name" : "user1"
    },
    "permissions" : [
      "user1"
    ],
    "meta" : {
      "size" : 712354,
      "mtime" : "2017-05-04T12:54:16.462Z",
      "etag" : "7ac66c0f148de9519b8bd264312c4d64"
    }
  }
}
   </screen>
   <sect3 xml:id="ceph-rgw-sync-elastic-config">
    <title>Parametri di configurazione di tipi di livelli ElasticSearch</title>
    <variablelist>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        Specifica l'endpoint del server ElasticSearch cui accedere.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_shards</term>
      <listitem>
       <para>
        <emphasis>(numero intero)</emphasis> Numero di partizioni che verranno configurate da ElasticSearch con l'inizializzazione della sincronizzazione sui dati. Dopo l'inizializzazione non è possibile modificare tale numero. Per qualsiasi modifica sono richieste la ricompilazione dell'indice di ElasticSearch e la reinizializzazione del processo di sincronizzazione dei dati.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>num_replicas</term>
      <listitem>
       <para>
        <emphasis>(numero intero)</emphasis> Numero di repliche che verranno configurate da ElasticSearch con l'inizializzazione della sincronizzazione sui dati.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>explicit_custom_meta</term>
      <listitem>
       <para>
        <emphasis>(true | false)</emphasis> Specifica se tutti i metadati personalizzati dell'utente verranno indicizzati o se l'utente dovrà configurare (a livello di compartimento) quali voci dei metadati del cliente devono essere indicizzate. Per default, questa opzione è impostata su false.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>index_buckets_list</term>
      <listitem>
       <para>
        <emphasis>(elenco di stringhe separate da virgole)</emphasis> Se vuoti, tutti i compartimenti verranno indicizzati. Altrimenti, verranno indicizzati solo i compartimenti specificati qui. È possibile specificare i prefissi dei compartimenti (ad esempio "foo*") o i suffissi (ad esempio "*bar").
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>approved_owners_list</term>
      <listitem>
       <para>
        <emphasis>(elenco di stringhe separate da virgole)</emphasis> Se vuoti, i compartimenti di tutti i proprietari verranno indicizzati (operazione soggetta ad altre restrizioni), altrimenti verranno indicizzati solo i compartimenti appartenenti ai proprietari specificati. È possibile specificare anche i suffissi e i prefissi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>override_index_path</term>
      <listitem>
       <para>
        <emphasis>(stringa)</emphasis> Se non è vuota, la stringa verrà utilizzata come percorso di indice di ElasticSearch. Altrimenti il percorso di indice verrà determinato e generato al momento dell'inizializzazione della sincronizzazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>nome utente</term>
      <listitem>
       <para>
        Specifica un nome utente per ElasticSearch se occorre effettuare l'autenticazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>password</term>
      <listitem>
       <para>
        Specifica una password per ElasticSearch se occorre effettuare l'autenticazione.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph-rgw-sync-elastic-query">
    <title>Interrogazioni dei metadati</title>
    <para>
     Poiché adesso nel cluster ElasticSearch vengono memorizzati metadati di oggetti, è importante che l'endpoint di ElasticSearch non sia esposto al pubblico e che sia accessibile solo dagli amministratori del cluster. Ciò rappresenta un problema per l'esposizione delle interrogazioni dei metadati all'utente finale, dato che l'utente dovrebbe interrogare solo i propri metadati e non quelli di altri utenti. Pertanto sarebbe opportuno che l'autenticazione degli utenti da parte del cluster ElasticSearch venga eseguita in modo simile a RGW, il che rappresenta un problema.
    </para>
    <para>
     A partire da Luminous RGW, adesso nella zona master dei metadata master è possibile provvedere alle richieste degli utenti finali. In tal modo l'endpoint di ElasticSearch non viene esposto al pubblico e si risolve anche il problema di autenticazione e autorizzazione in quanto RGW stesso è in grado di autenticare le richieste degli utenti finali. A tal fine, RGW introduce una nuova interrogazione nelle API del compartimento che sono in grado di provvedere alle richieste ElasticSearch. Tutte queste richieste devono essere inviate alla zona master dei metadati.
    </para>
    <variablelist>
     <varlistentry>
      <term>Ottenimento di un'interrogazione ElasticSearch</term>
      <listitem>
<screen>
GET /<replaceable>BUCKET</replaceable>?query=<replaceable>QUERY-EXPR</replaceable>
       </screen>
       <para>
        parametri di richiesta:
       </para>
       <itemizedlist>
        <listitem>
         <para>
          max-keys: numero massimo di voci da restituire
         </para>
        </listitem>
        <listitem>
         <para>
          marker: marker di impaginazione
         </para>
        </listitem>
       </itemizedlist>
<screen>
expression := [(]&lt;arg&gt; &lt;op&gt; &lt;value&gt; [)][&lt;and|or&gt; ...]
       </screen>
       <para>
        op è uno dei seguenti: &lt;, &lt;=, ==, &gt;=, &gt;
       </para>
       <para>
        Ad esempio:
       </para>
<screen>
GET /?query=name==foo
       </screen>
       <para>
        Verranno restituite tutte le chiavi indicizzate per le quali l'utente dispone l'autorizzazione in lettura e vengono denominate "foo". L'output sarà un elenco di chiavi in XML simile alla risposta dei compartimenti dell'elenco S3.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Configurazione dei campi dei metadati personalizzati</term>
      <listitem>
       <para>
        Definire quali voci dei metadati personalizzati devono essere indicizzate (nel compartimento specificato) e quali sono i tipi di queste chiavi. Se si configura l'indicizzazione esplicita dei metadati personalizzati, tale operazione è necessaria affinché rgw indicizzi i valori dei metadati personalizzati specificati. Altrimenti è necessaria nei casi in cui le chiavi dei metadati indicizzati siano di tipo diverso dalla stringa.
       </para>
<screen>
POST /<replaceable>BUCKET</replaceable>?mdsearch
x-amz-meta-search: &lt;key [; type]&gt; [, ...]
       </screen>
       <para>
        I campi di metadati multipli devono essere separati da virgole, è possibile forzare un tipo per un campo con un punto e virgola ";". I tipi attualmente consentiti sono stringa (default), numero intero e data. Ad esempio, se si desidera indicizzare i metadati di oggetto personalizzati x-amz-meta-year come int, x-amz-meta-date come tipo di data e x-amz-meta-title come stringa, procedere come indicato di seguito
       </para>
<screen>
POST /mybooks?mdsearch
x-amz-meta-search: x-amz-meta-year;int, x-amz-meta-release-date;date, x-amz-meta-title;string
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Eliminazione della configurazione dei metadati personalizzati</term>
      <listitem>
       <para>
        Eliminare la configurazione del compartimento dei metadati personalizzati.
       </para>
<screen>
DELETE /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Ottenimento della configurazione dei metadati personalizzati</term>
      <listitem>
       <para>
        Recuperare la configurazione del compartimento dei metadati personalizzati.
       </para>
<screen>
GET /<replaceable>BUCKET</replaceable>?mdsearch
       </screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-cloud-sync">
   <title>Modulo di sincronizzazione cloud</title>
   <para>
    Questa sezione descrive un modulo che effettua la sincronizzazione dei dati della zona con un servizio cloud remoto. La sincronizzazione è esclusivamente unidirezionale (ovvero la data non viene risincronizzata dalla zona remota). L'obiettivo principale di questo modulo è quello di abilitare la sincronizzazione dei dati con più provider di servizi cloud. Al momento, questo modulo supporta i provider cloud compatibili con AWS (S3).
   </para>
   <para>
    Per sincronizzare i dati con un servizio cloud remoto, occorre configurare le credenziali utente. Poiché molti servizi cloud introducono dei limiti sul numero di compartimenti che ciascun utente può creare, è possibile configurare la mappatura dei compartimenti e degli oggetti di origine, delle diverse destinazioni su compartimenti diversi e dei prefissi dei compartimenti. Tenere presente che gli elenchi di accesso all'origine (ACL) non verranno conservati. È possibile mappare le autorizzazioni degli utenti di origine specifici a determinati utenti di destinazione.
   </para>
   <para>
    A causa delle limitazioni dell'API, non è possibile conservare l'ora di modifica dell'oggetto originale e il tag dell'entità HTTP (ETag). Il modulo di sincronizzazione cloud memorizza queste informazioni come attributi di metadati sugli oggetti di destinazione.
   </para>
   <sect3>
    <title>Configurazione generale</title>
    <para>
     Di seguito sono riportati degli esempi di configurazione semplice e complessa del modulo di sincronizzazione cloud. Tenere presente che la configurazione semplice può entrare in conflitto con quella complessa.
    </para>
    <example>
     <title>Configurazione semplice</title>
<screen>
{
  "connection": {
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,
  },
  "acls": [ { "type": <replaceable>id | email | uri</replaceable>,
    "source_id": <replaceable>SOURCE_ID</replaceable>,
    "dest_id": <replaceable>DEST_ID</replaceable> } ... ],
  "target_path": <replaceable>TARGET_PATH</replaceable>,
}
</screen>
    </example>
    <example>
     <title>Configurazione complessa</title>
<screen>
{
  "default": {
    "connection": {
      "access_key": <replaceable>ACCESS</replaceable>,
      "secret": <replaceable>SECRET</replaceable>,
      "endpoint": <replaceable>ENDPOINT</replaceable>,
      "host_style" <replaceable>path | virtual</replaceable>,
    },
    "acls": [
    {
      "type": <replaceable>id | email | uri</replaceable>,   #  optional, default is id
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
    "target_path": <replaceable>PATH</replaceable> # optional
  },
  "connections": [
  {
    "connection_id": <replaceable>ID</replaceable>,
    "access_key": <replaceable>ACCESS</replaceable>,
    "secret": <replaceable>SECRET</replaceable>,
    "endpoint": <replaceable>ENDPOINT</replaceable>,
    "host_style": <replaceable>path | virtual</replaceable>,  # optional
  } ... ],
  "acl_profiles": [
  {
    "acls_id": <replaceable>ID</replaceable>, # acl mappings
    "acls": [ {
      "type": <replaceable>id | email | uri</replaceable>,
      "source_id": <replaceable>ID</replaceable>,
      "dest_id": <replaceable>ID</replaceable>
    } ... ]
  }
  ],
  "profiles": [
  {
   "source_bucket": <replaceable>SOURCE</replaceable>,
   "connection_id": <replaceable>CONNECTION_ID</replaceable>,
   "acls_id": <replaceable>MAPPINGS_ID</replaceable>,
   "target_path": <replaceable>DEST</replaceable>,          # optional
  } ... ],
}
</screen>
    </example>
    <para>
     Di seguito è riportata la spiegazione dei termini di configurazione utilizzati:
    </para>
    <variablelist>
     <varlistentry>
      <term>connessione</term>
      <listitem>
       <para>
        Rappresenta la connessione al servizio cloud remoto. Contiene "connection_id", "access_key", "secret", "endpoint", e "host_style".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>access_key</term>
      <listitem>
       <para>
        La chiave di accesso al cloud remoto che verrà utilizzata per la connessione specifica.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>secret</term>
      <listitem>
       <para>
        La chiave segreta del servizio cloud remoto.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>endpoint</term>
      <listitem>
       <para>
        URL dell'endpoint del servizio cloud remoto.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>host_style</term>
      <listitem>
       <para>
        Tipo di stile host ("path" o "virtual") da utilizzare per l'accesso all'endpoint cloud remoto. L'impostazione di default è "path".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acls</term>
      <listitem>
       <para>
        Matrice delle mappature dell'elenco accessi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_mapping</term>
      <listitem>
       <para>
        Ciascuna struttura "acl_mapping" contiene "type", "source_id" e "dest_id". Questi valori definiscono la mutazione dell'ACL di ciascun oggetto. Le mutazioni dell'ACL consentono di convertire l'ID utente di origine in un ID di destinazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>type</term>
      <listitem>
       <para>
        Tipo di ACL: "id" definisce l'ID utente, "email" definisce l'utente tramite l'indirizzo e-mail e "uri" definisce l'utente in base all'uri (gruppo).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>source_id</term>
      <listitem>
       <para>
        ID dell'utente nella zona di origine.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>dest_id</term>
      <listitem>
       <para>
        ID dell'utente nella destinazione.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>target_path</term>
      <listitem>
       <para>
        Una stringa che definisce la modalità di creazione del percorso di destinazione. Il percorso di destinazione specifica un prefisso al quale viene aggiunto il nome dell'oggetto di origine. Il percorso di destinazione configurabile può includere una delle seguenti variabili:
       </para>
       <variablelist>
        <varlistentry>
         <term>SID</term>
         <listitem>
          <para>
           Una stringa univoca che rappresenta l'ID dell'istanza di sincronizzazione.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP</term>
         <listitem>
          <para>
           Nome del gruppo di zone.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONEGROUP_ID</term>
         <listitem>
          <para>
           ID del gruppo di zone.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE</term>
         <listitem>
          <para>
           Nome della zona.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>ZONE_ID</term>
         <listitem>
          <para>
           ID della zona.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>BUCKET</term>
         <listitem>
          <para>
           Nome del compartimento di origine.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>OWNER</term>
         <listitem>
          <para>
           ID del proprietario del compartimento di origine.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>
        Ad esempio: target_path = rgwx-<replaceable>ZONE</replaceable>-<replaceable>SID</replaceable>/<replaceable>OWNER</replaceable>/<replaceable>BUCKET</replaceable>
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profiles</term>
      <listitem>
       <para>
        Una matrice dei profili dell'elenco accessi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>acl_profile</term>
      <listitem>
       <para>
        Ogni profilo contiene "acls_id", che rappresenta il profilo, e una matrice "acls" che contiene un elenco delle "acl_mappings".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>profili</term>
      <listitem>
       <para>
        Un elenco dei profili. Ogni profilo contiene quanto segue:
       </para>
       <variablelist>
        <varlistentry>
         <term>source_bucket</term>
         <listitem>
          <para>
           Il nome o il prefisso di un compartimento (se termina con *) che definisce i compartimenti di origine per il profilo.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>target_path</term>
         <listitem>
          <para>
           Vedere sopra per la spiegazione.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>connection_id</term>
         <listitem>
          <para>
           ID della connessione che verrà utilizzato per questo profilo.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term>acls_id</term>
         <listitem>
          <para>
           ID del profilo dell'ACL che verrà utilizzato per questo profilo.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3>
    <title>Elementi configurabili specifici di S3</title>
    <para>
     Il modulo di sincronizzazione cloud funziona soltanto con i back-end compatibili con AWS S3. È possibile utilizzare alcuni elementi configurabili per ottimizzarne il comportamento durante l'accesso ai servizi cloud S3:
    </para>
<screen>
{
  "multipart_sync_threshold": <replaceable>OBJECT_SIZE</replaceable>,
  "multipart_min_part_size": <replaceable>PART_SIZE</replaceable>
}
</screen>
    <variablelist>
     <varlistentry>
      <term>multipart_sync_threshold</term>
      <listitem>
       <para>
        Gli oggetti di dimensioni uguali o superiori a questo valore verranno sincronizzati con il servizio cloud tramite l'upload multipart.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>multipart_min_part_size</term>
      <listitem>
       <para>
        Dimensioni minime delle parti da utilizzare durante la sincronizzazione degli oggetti con l'upload multipart.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="archive-sync-module">
   <title>Modulo di sincronizzazione degli archivi</title>
   <para>
    Il <emphasis>modulo di sincronizzazione degli archivi</emphasis> utilizza la funzione del controllo versioni degli oggetti S3 in Object Gateway. È possibile configurare una <emphasis>zona di archiviazione</emphasis> per acquisire le diverse versioni degli oggetti S3 che hanno luogo nel corso del tempo nelle altre zone. Tramite i gateway associati alla zona di archiviazione, è possibile eliminare la cronologia delle versioni conservata nella zona stessa.
   </para>
   <para>
    Grazie a questa architettura, diverse zone senza versione possono eseguire la copia speculare dei relativi dati e metadati tramite i propri gateway di zona fornendo elevata disponibilità agli utenti finali, mentre la zona di archiviazione acquisisce tutti gli aggiornamenti dei dati per consolidarli come versioni degli oggetti S3.
   </para>
   <para>
    Includendo la zona di archiviazione in una configurazione multizona, è possibile ottenere in una zona la flessibilità della cronologia degli oggetti S3 risparmiando al contempo spazio che verrà utilizzato nelle zone rimanenti dalle repliche degli oggetti S3 con versione.
   </para>
   <sect3 xml:id="archive-sync-module-configuration">
    <title>Configurazione</title>
    <tip>
     <title>ulteriori informazioni</title>
     <para>
      Fare riferimento alla <xref linkend="ceph-rgw-fed"/> per i dettagli sulla configurazione dei gateway multisito.
     </para>
     <para>
      Fare riferimento alla <xref linkend="ceph-rgw-sync"/> per i dettagli sulla configurazione dei moduli di sincronizzazione.
     </para>
    </tip>
    <para>
     Per utilizzare il modulo di archiviazione, occorre creare una nuova zona con tipo di livello impostato su <literal>archive</literal>:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=<replaceable>ZONE_GROUP_NAME</replaceable> \
 --rgw-zone=<replaceable>OGW_ZONE_NAME</replaceable> \
 --endpoints=<replaceable>http://OGW_ENDPOINT1_URL[,http://OGW_ENDPOINT2_URL,...]</replaceable>
 --tier-type=archive
</screen>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-ldap">
  <title>Autenticazione LDAP</title>

  <para>
   Oltre all'autenticazione utente locale di default, con Object Gateway si possono utilizzare i servizi del server LDAP per autenticare anche gli utenti.
  </para>

  <sect2 xml:id="ceph-rgw-ldap-how-works">
   <title>Meccanismo di autenticazione</title>
   <para>
    Object Gateway estrae le credenziali LDAP dell'utente da un token. Dal nome utente viene costruito un filtro di ricerca. In Object Gateway si utilizza il servizio configurato per ricercare la directory di una voce corrispondente. Se si trova la voce, Object Gateway tenta di associare il nome distinto con la password ottenuta dal token. Se le credenziali sono valide, l'associazione avrà esito positivo e verrà concesso l'accesso a Object Gateway.
   </para>
   <para>
    È possibile limitare gli utenti consentiti impostando la base per la ricerca a un'unità organizzativa specifica o definendo un filtro di ricerca personalizzato, ad esempio richiedendo l'appartenenza di un gruppo specifico, classi di oggetti personalizzati o attributi.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-reqs">
   <title>Requisiti</title>
   <itemizedlist>
    <listitem>
     <para>
      <emphasis>LDAP o Active Directory</emphasis>: un'istanza LDAP in esecuzione accessibile da Object Gateway.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Account di servizio</emphasis>: credenziali LDAP che devono essere utilizzate da Object Gateway con autorizzazioni di ricerca.
     </para>
    </listitem>
    <listitem>
     <para>
      <emphasis>Account utente</emphasis>: almeno un account utente nella directory LDAP.
     </para>
    </listitem>
   </itemizedlist>
   <important>
    <title>non sovrapporre utenti LDAP e utenti locali</title>
    <para>
     Non utilizzare gli stessi nomi utente per gli utenti locali e per gli utenti che vengono autenticati mediante l'uso di LDAP. Object Gateway non è in grado di distinguerli e li considera come lo stesso utente.
    </para>
   </important>
   <tip>
    <title>test di integrità</title>
    <para>
     Utilizzare l'utility <command>ldapsearch</command> per verificare l'account di servizio o la connessione LDAP. Ad esempio:
    </para>
<screen><prompt>tux &gt; </prompt>ldapsearch -x -D "uid=ceph,ou=system,dc=example,dc=com" -W \
-H ldaps://example.com -b "ou=users,dc=example,dc=com" 'uid=*' dn</screen>
    <para>
     Assicurarsi di utilizzare gli stessi parametri LDAP del file di configurazione Ceph per eliminare eventuali problemi.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-config">
   <title>Configurazione di Object Gateway per utilizzare l'autenticazione LDAP</title>
   <para>
    I seguenti parametri nel file di configurazione <filename>/etc/ceph/ceph.conf</filename> sono correlati all'autenticazione LDAP:
   </para>
   <variablelist>
    <varlistentry>
     <term><option>rgw_ldap_uri</option></term>
     <listitem>
      <para>
       Specifica il server LDAP da utilizzare. Assicurarsi di utilizzare il parametro <literal>ldaps://<replaceable>FQDN</replaceable>:<replaceable>PORT</replaceable></literal> per evitare di trasmettere apertamente le credenziali come testo normale.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_binddn</option></term>
     <listitem>
      <para>
       Nome distinto (DN) dell'account di servizio utilizzato da Object Gateway.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_secret</option></term>
     <listitem>
      <para>
       Password per l'account di servizio.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>rgw_ldap_searchdn</term>
     <listitem>
      <para>
       Specifica la base DIT (Directory Information Tree) per la ricerca degli utenti. Questa può essere l'unità organizzativa degli utenti o una più specifica.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_ldap_dnattr</option></term>
     <listitem>
      <para>
       Attributo che viene utilizzato nel filtro di ricerca costruito per la corrispondenza con un nome utente. A seconda del DIT, è probabile che tale attributo sia <literal>uid</literal> o <literal>cn</literal>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rgw_search_filter</option></term>
     <listitem>
      <para>
       Se non è specificato, in Object Gateway il filtro di ricerca viene costruito automaticamente con l'impostazione <option>rgw_ldap_dnattr</option>. Utilizzare questo parametro per restringere l'elenco degli utenti consentiti con la massima flessibilità. Consultare <xref linkend="ceph-rgw-ldap-filter"/> per ulteriori informazioni.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-filter">
   <title>Utilizzo di un filtro di ricerca personalizzato per limitare l'accesso degli utenti</title>
   <para>
    È possibile utilizzare il parametro <option>rgw_search_filter</option> in due modi diversi.
   </para>
   <sect3>
    <title>Filtro parziale per limitare ulteriormente il filtro di ricerca costruito</title>
    <para>
     Di seguito è riportato un esempio di filtro parziale:
    </para>
<screen>"objectclass=inetorgperson"</screen>
    <para>
     In Object Gateway il filtro di ricerca verrà generato come di consueto, con il nome dell'utente ottenuto dal token del valore di <option>rgw_ldap_dnattr</option>. Il filtro costruito viene quindi combinato con il filtro parziale dell'attributo <option>rgw_search_filter</option>. A seconda del nome utente e delle impostazioni, il filtro di ricerca finale può diventare:
    </para>
<screen>"(&amp;(uid=hari)(objectclass=inetorgperson))"</screen>
    <para>
     In tal caso, all'utente 'hari' verrà concesso l'accesso solo se è presente nella directory LDAP, dispone di una classe oggetto 'inetorgperson' e ha specificato una password valida.
    </para>
   </sect3>
   <sect3>
    <title>Filtro completo</title>
    <para>
     Un filtro completo deve contenere un token <option>USERNAME</option> che verrà sostituito con il nome dell'utente durante il tentativo di autenticazione. In tal caso, il parametro <option>rgw_ldap_dnattr</option> non viene più utilizzato. Ad esempio, per limitare gli utenti validi a un gruppo specifico, utilizzare il filtro seguente:
    </para>
<screen>"(&amp;(uid=USERNAME)(memberOf=cn=ceph-users,ou=groups,dc=mycompany,dc=com))"</screen>
    <note>
     <title>attributo <literal>memberOf</literal></title>
     <para>
      Per utilizzare l'attributo <literal>memberOf</literal> nelle richieste LDAP è richiesto il supporto lato server dall'implementazione del server LDAP specificata.
     </para>
    </note>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-ldap-token">
   <title>Generazione di un token di accesso per l'autenticazione LDAP</title>
   <para>
    Il token di accesso viene generato dall'utility <command>radosgw-token</command> in base al nome utente e alla password LDAP. L'output è una stringa codificata base-64 che corrisponde al token di accesso effettivo. Utilizzare il client S3 preferito (fare riferimento a <xref linkend="accessing-ragos-gateway"/>), specificare il token come chiave di accesso e utilizzare una chiave segreta vuota.
   </para>
<screen><prompt>tux &gt; </prompt>export RGW_ACCESS_KEY_ID="<replaceable>USERNAME</replaceable>"
<prompt>tux &gt; </prompt>export RGW_SECRET_ACCESS_KEY="<replaceable>PASSWORD</replaceable>"
<prompt>cephadm@adm &gt; </prompt>radosgw-token --encode --ttype=ldap</screen>
   <important>
    <title>credenziali non cifrate</title>
    <para>
     Il token di accesso è una struttura JSON codificata base-64 e contiene le credenziali LDAP non cifrate.
    </para>
   </important>
   <note>
    <title>Active Directory</title>
    <para>
     Per Active Directory, utilizzare il parametro <option>--ttype=ad</option>.
    </para>
   </note>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-bucket-sharding">
  <title>Partizionamento dell'indice del compartimento</title>

  <para>
   In Object Gateway i dati di indice del compartimento vengono memorizzati in un pool di indice, che per default è impostato su <literal>.rgw.buckets.index</literal>. Se si inseriscono troppi (centinaia di migliaia) oggetti in un singolo compartimento e la quota massima per il numero di oggetti per compartimento (<option>rgw bucket default quota max objects</option>) non è impostata, le prestazioni del pool di indice potrebbero essere compromesse. Il <emphasis>partizionamento dell'indice del compartimento</emphasis> impedisce tali riduzioni delle prestazioni e consente un numero maggiore di oggetti per compartimento.
  </para>

  <sect2 xml:id="ogw-bucket-reshard">
   <title>Ripartizionamento dell'indice del compartimento</title>
   <para>
    Se un compartimento è diventato più grande e la rispettiva configurazione iniziale non è più sufficiente, è necessario ripartizionare il pool di indice del compartimento. È possibile utilizzare il ripartizionamento automatico dell'indice del compartimento online (fare riferimento alla <xref linkend="ogw-bucket-sharding-dyn"/>) o eseguire manualmente il ripartizionamento dell'indice del compartimento offline (fare riferimento alla <xref linkend="ogw-bucket-sharding-re"/>).
   </para>
   <sect3 xml:id="ogw-bucket-sharding-dyn">
    <title>Ripartizionamento dinamico</title>
    <para>
     A partire da SUSE Enterprise Storage 5, è supportato il ripartizionamento del compartimento online. Viene rilevato se il numero di oggetti per compartimento raggiunge una determinata soglia e viene aumentato automaticamente il numero di partizioni utilizzate dall'indice del compartimento. Questo processo consente di ridurre il numero di voci in ciascuna partizione dell'indice del compartimento.
    </para>
    <para>
     Il processo di rilevamento viene eseguito:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Quando vengono aggiunti nuovi oggetti al compartimento.
      </para>
     </listitem>
     <listitem>
      <para>
       In un processo in background che esegue periodicamente la scansione di tutti i compartimenti. Questo è necessario per gestire i compartimenti esistenti che non vengono aggiornati.
      </para>
     </listitem>
    </itemizedlist>
    <para>
     Un compartimento per il quale è richiesto il ripartizionamento viene aggiunto alla coda <option>reshard_log</option> e verrà pianificato per un ripartizionamento successivo. I thread della ripartizione vengono eseguiti in background ed eseguono un ripartizionamento pianificato alla volta.
    </para>
    <variablelist>
     <title>Configurazione del ripartizionamento dinamico</title>
     <varlistentry>
      <term><option>rgw_dynamic_resharding</option></term>
      <listitem>
       <para>
        Abilita o disabilita il ripartizionamento dinamico dell'indice del compartimento. I valori possibili sono "true" o "false". Il valore di default è "true".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_num_logs</option></term>
      <listitem>
       <para>
        Numero di partizioni per il log di ripartizionamento. Il valore di default è 16.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_bucket_lock_duration</option></term>
      <listitem>
       <para>
        Durata del bloccaggio nell'oggetto Compartimento durante il ripartizionamento. Il valore di default è 120 secondi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_max_objs_per_shard</option></term>
      <listitem>
       <para>
        Numero massimo di oggetti per partizione dell'indice del compartimento. Il valore di default è 10.0000 oggetti.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw_reshard_thread_interval</option></term>
      <listitem>
       <para>
        Durata massima tra i cicli di elaborazione dei thread delle ripartizioni. Il valore di default è 600 secondi.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <important>
     <title>configurazioni multisito</title>
     <para>
      Il ripartizionamento dinamico non è supportato negli ambienti multisito. A partire da Ceph 12.2.2 è disabilitato per default, ma si consiglia di verificare ulteriormente l'impostazione.
     </para>
    </important>
    <variablelist>
     <title>Comandi per amministrare il processo di ripartizionamento</title>
     <varlistentry>
      <term>Aggiungere un compartimento alla coda di ripartizionamento:</term>
      <listitem>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin reshard add \
 --bucket <replaceable>BUCKET_NAME</replaceable> \
 --num-shards <replaceable>NEW_NUMBER_OF_SHARDS</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Elencare la coda di ripartizionamento:</term>
      <listitem>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin reshard list
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Elaborare/pianificare un ripartizionamento del compartimento:</term>
      <listitem>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin reshard process
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Visualizzare lo stato di ripartizionamento del compartimento:</term>
      <listitem>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin reshard status --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Annullare il ripartizionamento del compartimento in sospeso:</term>
      <listitem>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin reshard cancel --bucket <replaceable>BUCKET_NAME</replaceable>
</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ogw-bucket-sharding-re">
    <title>Ripartizionamento manuale</title>
    <para>
     Il ripartizionamento dinamico di cui alla <xref linkend="ogw-bucket-sharding-dyn"/> è supportato solo per le configurazioni Object Gateway semplici. Per le configurazioni multisito, utilizzare il ripartizionamento manuale descritto nella presente sezione.
    </para>
    <para>
     Per eseguire il ripartizionamento manuale dell'indice del compartimento offline, utilizzare il comando seguente:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin bucket reshard
</screen>
    <para>
     Il comando <command>bucket reshard</command> consente di effettuare le seguenti operazioni:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Creare un nuovo set di oggetti Indice compartimento per l'oggetto specificato.
      </para>
     </listitem>
     <listitem>
      <para>
       Distribuire tutte le voci di questi oggetti di indice.
      </para>
     </listitem>
     <listitem>
      <para>
       Creare una nuova istanza del compartimento.
      </para>
     </listitem>
     <listitem>
      <para>
       Collegare la nuova istanza del compartimento al compartimento in modo che tutte le nuove operazioni di indice passino attraverso i nuovi indici del compartimento.
      </para>
     </listitem>
     <listitem>
      <para>
       Stampare il vecchio e il nuovo ID compartimento nell'output standard.
      </para>
     </listitem>
    </itemizedlist>
    <procedure>
     <title>Ripartizionamento del pool di indice del compartimento</title>
     <step>
      <para>
       Assicurarsi che tutte le operazioni nel compartimento vengano interrotte
      </para>
     </step>
     <step>
      <para>
       Eseguire il backup dell'indice del compartimento originale:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin bi list \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 &gt; <replaceable>BUCKET_NAME</replaceable>.list.backup
</screen>
     </step>
     <step>
      <para>
       Eseguire il ripartizionamento dell'indice del compartimento:
      </para>
<screen>
 <prompt>cephadm@adm &gt; </prompt>radosgw-admin reshard \
 --bucket=<replaceable>BUCKET_NAME</replaceable> \
 --num-shards=<replaceable>NEW_SHARDS_NUMBER</replaceable>
</screen>
      <tip>
       <title>ID compartimento precedente</title>
       <para>
        Come parte del rispettivo output, questo comando consente inoltre di stampare l'ID compartimento nuovo e quello precedente. So noti l'ID compartimento precedente visualizzato sotto; questo sarà necessario per eliminare definitivamente gli oggetti Indice del compartimento precedenti.
       </para>
      </tip>
     </step>
     <step>
      <para>
       Verificare che tali oggetti siano elencati correttamente confrontando l'elenco degli indici del compartimento precedenti con quello nuovo. Quindi, eliminare definitivamente gli oggetti Indice compartimento precedenti:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin bi purge
 --bucket=<replaceable>BUCKET_NAME</replaceable>
 --bucket-id=<replaceable>OLD_BUCKET_ID</replaceable>
</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-bucket-sharding-new">
   <title>Partizionamento dell'indice del compartimento per nuovi compartimenti</title>
   <para>
    Sono disponibili due opzioni che influenzano il partizionamento dell'indice del compartimento:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Utilizzare l'opzione <option>rgw_override_bucket_index_max_shards</option> per le configurazioni semplici.
     </para>
    </listitem>
    <listitem>
     <para>
      Utilizzare l'opzione <option>bucket_index_max_shards</option> per le configurazioni multisito.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Con l'impostazione delle opzioni su <literal>0</literal> si disabilita il partizionamento dell'indice del compartimento. Con un valore maggiore di <literal>0</literal> si abilita il partizionamento dell'indice del compartimento e si imposta il numero massimo di partizioni.
   </para>
   <para>
    La formula seguente consente di calcolare il numero di partizioni consigliato:
   </para>
<screen>
number_of_objects_expected_in_a_bucket / 100000
</screen>
   <para>
    Si tenga presente che il numero massimo di partizioni è 7877.
   </para>
   <sect3>
    <title>Configurazioni semplici</title>
    <procedure>
     <step>
      <para>
       Aprire il file di configurazione di Ceph e aggiungere o modificare l'opzione seguente:
      </para>
<screen>
rgw_override_bucket_index_max_shards = 12
</screen>
      <tip>
       <title>tutte o un'istanza di Object Gateway</title>
       <para>
        Per configurare il partizionamento dell'indice del compartimento per tutte le istanze di Object Gateway, includere <option>rgw_override_bucket_index_max_shards</option> nella sezione <literal>[global]</literal>.
       </para>
       <para>
        Per configurare il partizionamento dell'indice del compartimento solo per una determinata istanza di Object Gateway, includere <option>rgw_override_bucket_index_max_shards</option> nella relativa sezione dell'istanza.
       </para>
      </tip>
     </step>
     <step>
      <para>
       Riavviare Object Gateway. Per ulteriori dettagli, vedere <xref linkend="ceph-rgw-operating"/>.
      </para>
     </step>
    </procedure>
   </sect3>
   <sect3>
    <title>Configurazioni multisito</title>
    <para>
     Le configurazioni multisito possono avere un pool di indice diverso per la gestione dei failover. Per configurare un numero di partizioni coerente per le zone in un gruppo di zone, impostare l'opzione <option>bucket_index_max_shards</option> nella configurazione del gruppo di zone:
    </para>
    <procedure>
     <step>
      <para>
       Esportare la configurazione del gruppo di zone nel file <filename>zonegroup.json</filename>:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup get &gt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Modificare il file <filename>zonegroup.json</filename> e impostare l'opzione <option>bucket_index_max_shards</option> per ciascuna zona con nome.
      </para>
     </step>
     <step>
      <para>
       Reimpostare il gruppo di zone:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup set &lt; zonegroup.json
</screen>
     </step>
     <step>
      <para>
       Aggiornare il periodo:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin period update --commit
</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-keystone">
  <title>Integrazione di OpenStack Keystone</title>

  <para>
   OpenStack Keystone è un servizio di gestione delle identità per il prodotto OpenStack. È possibile integrare Object Gateway con Keystone per configurare un gateway che accetti un token di autenticazione Keystone. Un utente autorizzato da Keystone ad accedere al gateway verrà verificato sul lato Ceph Object Gateway e verrà creato automaticamente se necessario. Object Gateway interroga Keystone periodicamente per un elenco di token revocati.
  </para>

  <sect2 xml:id="ogw-keystone-ostack">
   <title>Configurazione di OpenStack</title>
   <para>
    Prima di configurare Ceph Object Gateway, è necessario configurare OpenStack Keystone all'abilitazione del servizio Swift e fare in modo questo che punti a Ceph Object Gateway:
   </para>
   <procedure>
    <step>
     <para>
      <emphasis>Impostare il servizio Swift.</emphasis> Prima di poter utilizzare OpenStack per la convalida degli utenti Swift, creare il servizio Swift:
     </para>
<screen>
<prompt>tux &gt; </prompt>openstack service create \
 --name=swift \
 --description="Swift Service" \
 object-store
</screen>
    </step>
    <step>
     <para>
      <emphasis>Impostare gli endpoint.</emphasis> Dopo aver creato il servizio Swift, fare in modo che punti a Ceph Object Gateway. Sostituire <replaceable>REGION_NAME</replaceable> con il nome del gruppo di zone o il nome dell'area del gateway.
     </para>
<screen>
<prompt>tux &gt; </prompt>openstack endpoint create --region <replaceable>REGION_NAME</replaceable> \
 --publicurl   "http://radosgw.example.com:8080/swift/v1" \
 --adminurl    "http://radosgw.example.com:8080/swift/v1" \
 --internalurl "http://radosgw.example.com:8080/swift/v1" \
 swift
</screen>
    </step>
    <step>
     <para>
      <emphasis>Verificare le impostazioni.</emphasis> Dopo aver creato il servizio Swift e impostati gli endpoint, visualizzare questi ultimi per verificare che tutte le impostazioni siano corrette.
     </para>
<screen>
<prompt>tux &gt; </prompt>openstack endpoint show object-store
</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ogw-keystone-ogw">
   <title>Configurazione di Ceph Object Gateway</title>
   <sect3>
    <title>Configurazione dei certificati SSL</title>
    <para>
     Ceph Object Gateway interroga Keystone periodicamente per un elenco di token revocati. Tali richieste sono codificate e firmate. È inoltre possibile configurare Keystone in modo che vengano forniti token firmati da se stessi, a loro volta codificati e firmati. È necessario configurare il gateway in modo che possa decodificare e verificare tali messaggi firmati. Pertanto, è necessario convertire in formato "nss db" i certificati OpenSSL utilizzati da Keystone per creare le richieste:
    </para>
<screen>
<prompt>root # </prompt>mkdir /var/ceph/nss
<prompt>root # </prompt>openssl x509 -in /etc/keystone/ssl/certs/ca.pem \
 -pubkey | certutil -d /var/ceph/nss -A -n ca -t "TCu,Cu,Tuw"
<systemitem class="username">root</systemitem>openssl x509 -in /etc/keystone/ssl/certs/signing_cert.pem \
 -pubkey | certutil -A -d /var/ceph/nss -n signing_cert -t "P,P,P"
</screen>
    <para>
     Per consentire l'interazione tra Ceph Object Gateway e OpenStack Keystone, quest'ultimo può utilizzare un certificato SSL firmato da se stessi. Installare il certificato SSL di Keystone sul nodo sul quale è in esecuzione Ceph Object Gateway o in alternativa impostare il valore dell'opzione <option>rgw keystone verify ssl</option> su "false". L'impostazione di <option>rgw keystone verify ssl</option> su "false" significa che non verrà effettuato alcun tentativo di verifica del certificato da parte del gateway.
    </para>
   </sect3>
   <sect3>
    <title>Configurazione delle opzioni di Object Gateway</title>
    <para>
     È possibile configurare l'integrazione di Keystone utilizzando le opzioni seguenti:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone api version</option></term>
      <listitem>
       <para>
        Versione dell'API Keystone. Le opzioni valide sono 2 o 3. Il valore di default è 2.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone url</option></term>
      <listitem>
       <para>
        URL e numero di porta dell'API amministrativa RESTful sul server Keystone. Segue il modello <replaceable>SERVER_URL:PORT_NUMBER</replaceable>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin token</option></term>
      <listitem>
       <para>
        Token o segreto condiviso configurato all'interno di Keystone per le richieste amministrative.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted roles</option></term>
      <listitem>
       <para>
        Ruoli richiesti per provvedere alle richieste. L'impostazione di default è "Member, admin".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone accepted admin roles</option></term>
      <listitem>
       <para>
        Elenco dei ruoli che consentono a un utente di ottenere privilegi amministrativi.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone token cache size</option></term>
      <listitem>
       <para>
        Numero massimo di voci nella cache dei token Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone revocation interval</option></term>
      <listitem>
       <para>
        Numero di secondi prima della verifica dei token revocati. Il valore di default è 15 * 60.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone implicit tenants</option></term>
      <listitem>
       <para>
        Crea nuovi utenti nei rispettivi tenant con lo stesso nome. L'impostazione di default è "false".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw s3 auth use keystone</option></term>
      <listitem>
       <para>
        Se impostata su "'true", Ceph Object Gateway eseguirà l'autenticazione degli utenti tramite Keystone. L'impostazione di default è "false".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>nss db path</option></term>
      <listitem>
       <para>
        Percorso del database NSS.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     È inoltre possibile configurare il tenant del servizio Keystone, l'utente e la password per Keystone (per la versione 2.0 di OpenStack Identity API) in modo simile a quanto avviene per la configurazione dei servizi OpenStack. In tal modo, è possibile evitare di impostare il segreto condiviso <option>rgw keystone admin token</option> nel file di configurazione, che deve essere disabilitato negli ambienti di produzione. Le credenziali del tenant del servizio devono disporre dei privilegi amministrativi. Per ulteriori dettagli, fare riferimento alla <link xlink:href="https://docs.openstack.org/keystone/latest/#setting-up-projects-users-and-roles">documentazione ufficiale di OpenStack Keystone</link> (in lingua inglese). Di seguito sono riportate le opzioni di configurazione correlate:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin user</option></term>
      <listitem>
       <para>
        Nome utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin password</option></term>
      <listitem>
       <para>
        Password utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin tenant</option></term>
      <listitem>
       <para>
        Tenant utente amministratore Keystone versione 2.0.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Un utente Ceph Object Gateway viene mappato a un tenant Keystone. A un utente Keystone vengono assegnati diversi ruoli, possibilmente su più tenant. Quando Ceph Object Gateway ottiene il ticket, fa riferimento ai ruoli del tenant e dell'utente assegnati a tale ticket, quindi accetta o rifiuta la richiesta in base all'impostazione definita per l'opzione <option>rgw keystone accepted roles</option>.
    </para>
    <tip>
     <title>mappatura ai tenant OpenStack</title>
     <para>
      Sebbene i tenant Swift vengano mappati per default all'utente Object Gateway, è possibile mapparli anche ai tenant OpenStack tramite l'opzione <option>rgw keystone implicit tenants</option>. In tal modo i container utilizzeranno lo spazio dei nomi dei tenant anziché quello globale uguale a S3 che è l'impostazione di default di Object Gateway. Per evitare di fare confusione, si consiglia di decidere il metodo di mappatura in fase di pianificazione. L'attivazione/disattivazione dell'opzione in un momento successivo influisce solo sulle richieste più recenti che vengono mappate a un tenant, mentre i compartimenti creati precedentemente continuano a risiedere in uno spazio dei nomi globale.
     </para>
    </tip>
    <para>
     Per la versione 3 di OpenStack Identity API, si deve sostituire l'opzione <option>rgw keystone admin tenant</option> con:
    </para>
    <variablelist>
     <varlistentry>
      <term><option>rgw keystone admin domain</option></term>
      <listitem>
       <para>
        Domino utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>rgw keystone admin project</option></term>
      <listitem>
       <para>
        Progetto utente amministratore Keystone.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-storage-classes">


  <title>Posizionamento di pool e classi di storage</title>

  <sect2 xml:id="ogw-storage-classes-placement-targets">
   <title>Destinazioni di posizionamento</title>
   <para>
    Le destinazioni di posizionamento consentono di controllare quali pool sono associati a un determinato compartimento. La destinazione di posizionamento di un compartimento viene selezionata al momento della creazione e non può essere modificata. Per visualizzare la regola "placement_rule" corrispondente, utilizzare il comando seguente:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin bucket stats
</screen>
   <para>
    La configurazione del gruppo di zone contiene un elenco di destinazioni di posizionamento con una destinazione iniziale denominata "default-placement". La configurazione della zona mappa quindi ogni nome della destinazione di posizionamento del gruppo di zone allo storage locale corrispondente. Queste informazioni sul posizionamento della zona includono il nome "index_pool" per l'indice del compartimento, il nome "data_extra_pool" per i metadati relativi agli upload multipart incompleti e il nome "data_pool" per ogni classe di storage.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-itself">
   <title>Classi di storage</title>
   <para>
    Le classi di storage agevolano la personalizzazione del posizionamento dei dati di oggetto. Le regole di S3 Bucket Lifecycle consentono di automatizzare la transizione degli oggetti tra le classi di storage.
   </para>
   <para>
    Le classi di storage vengono definite in termini di destinazioni di posizionamento. Per ogni destinazione di posizionamento del gruppo di zone sono elencate le relative classi di storage disponibili con una classe iniziale denominata "STANDARD". La configurazione della zona specifica il nome di pool "data_pool" per ciascuna delle classi di storage del gruppo di zone.
   </para>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-zone-config">
   <title>Configurazione del gruppo di zone/della zona</title>
   <para>
    Per configurare il posizionamento dei gruppi di zone e delle zone, utilizzare il comando <command>radosgw-admin</command>. È possibile interrogare la configurazione del posizionamento del gruppo di zone tramite il comando seguente:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup get
{
    "id": "ab01123f-e0df-4f29-9d71-b44888d67cd5",
    "name": "default",
    "api_name": "default",
    ...
    "placement_targets": [
        {
            "name": "default-placement",
            "tags": [],
            "storage_classes": [
                "STANDARD"
            ]
        }
    ],
    "default_placement": "default-placement",
    ...
}
</screen>
   <para>
    Per interrogare la configurazione del posizionamento della zona, eseguire:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone get
{
    "id": "557cdcee-3aae-4e9e-85c7-2f86f5eddb1f",
    "name": "default",
    "domain_root": "default.rgw.meta:root",
    ...
    "placement_pools": [
        {
            "key": "default-placement",
            "val": {
                "index_pool": "default.rgw.buckets.index",
                "storage_classes": {
                    "STANDARD": {
                        "data_pool": "default.rgw.buckets.data"
                    }
                },
                "data_extra_pool": "default.rgw.buckets.non-ec",
                "index_type": 0
            }
        }
    ],
    ...
}
</screen>
   <note>
    <title>nessuna configurazione multisito precedente</title>
    <para>
     Se in precedenza non è stata effettuata nessuna configurazione multisito, vengono creati un gruppo di zone e una zona "default" per l'utente e le relative modifiche apportate non saranno effettive fino al riavvio di Ceph Object Gateway. Se è stato creato un dominio per la configurazione multisito, le modifiche alla zona/al gruppo di zone verranno applicate dopo averle confermate tramite il comando <command>radosgw-admin period update --commit</command>.
    </para>
   </note>
   <sect3>
    <title>Aggiunta di una destinazione di posizionamento</title>
    <para>
     Per creare una nuova destinazione di posizionamento denominata "temporary", iniziare aggiungendola al gruppo di zone:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id temporary
</screen>
    <para>
     Quindi, fornire le informazioni sul posizionamento della zona per la destinazione specificata:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id temporary \
      --data-pool default.rgw.temporary.data \
      --index-pool default.rgw.temporary.index \
      --data-extra-pool default.rgw.temporary.non-ec
</screen>
   </sect3>
   <sect3>
    <title>Aggiunta di una classe di storage</title>
    <para>
     Per aggiungere una nuova classe di storage denominata "COLD" alla destinazione "default-placement", iniziare aggiungendola al gruppo di zone:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup placement add \
      --rgw-zonegroup default \
      --placement-id default-placement \
      --storage-class COLD
</screen>
    <para>
     Quindi, fornire le informazioni sul posizionamento della zona per la classe di storage specificata:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zone placement add \
      --rgw-zone default \
      --placement-id default-placement \
      --storage-class COLD \
      --data-pool default.rgw.cold.data \
      --compression lz4
</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-customizing-placement">
   <title>Personalizzazione del posizionamento</title>
   <sect3>
    <title>Posizionamento di default</title>
    <para>
     Per default, i nuovi compartimenti utilizzeranno la destinazione "default_placement" del gruppo di zone. È possibile modificare questa impostazione del gruppo di zone con quanto segue:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup placement default \
      --rgw-zonegroup default \
      --placement-id new-placement
</screen>
   </sect3>
   <sect3>
    <title>Posizionamento utenti</title>
    <para>
     Gli utenti di Ceph Object Gateway possono sostituire la destinazione di posizionamento di default del gruppo di zone impostando un campo "default_placement" non vuoto nella sezione delle informazioni utente. Analogamente, la classe "default_storage_class" può sostituire la classe di storage "STANDARD" applicata per default agli oggetti.
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin user info --uid testid
{
    ...
    "default_placement": "",
    "default_storage_class": "",
    "placement_tags": [],
    ...
}
</screen>
    <para>
     Se la destinazione di posizionamento di un gruppo di zone contiene tag, gli utenti non potranno creare compartimenti con questa destinazione, a meno che le relative informazioni non contengano almeno un tag corrispondente nel campo "placement_tags". Ciò può essere utile per limitare l'accesso a determinati tipi di storage.
    </para>
    <para>
     Poiché il comando <command>radosgw-admin</command> non è in grado di modificare direttamente questi campi, è necessario modificare manualmente il formato JSON:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>radosgw-admin metadata get user:<replaceable>USER-ID</replaceable> &gt; user.json
<prompt>tux &gt; </prompt>vi user.json     # edit the file as required
<prompt>cephadm@adm &gt; </prompt>radosgw-admin metadata put user:<replaceable>USER-ID</replaceable> &lt; user.json
</screen>
   </sect3>
   <sect3>
    <title>Posizionamento del compartimento S3</title>
    <para>
     Durante la creazione di un compartimento con il protocollo S3, è possibile specificare una destinazione di posizionamento come parte del <option>LocationConstraint</option> al fine di sostituire le destinazioni di posizionamento di default per l'utente e il gruppo di zone.
    </para>
    <para>
     In genere, il <option>LocationConstraint</option> deve corrispondere all'<option>api_name</option> del gruppo di zone:
    </para>
<screen>
&lt;LocationConstraint&gt;default&lt;/LocationConstraint&gt;
</screen>
    <para>
     È possibile aggiungere una destinazione di posizionamento personalizzata all'<option>api_name</option> dopo i due punti:
    </para>
<screen>
&lt;LocationConstraint&gt;default:new-placement&lt;/LocationConstraint&gt;
</screen>
   </sect3>
   <sect3>
    <title>Posizionamento del compartimento Swift</title>
    <para>
     Durante la creazione di un compartimento con il protocollo Swift, è possibile specificare una destinazione di posizionamento nell'"X-Storage-Policy" dell'intestazione HTTP:
    </para>
<screen>
 X-Storage-Policy: <replaceable>NEW-PLACEMENT</replaceable>
</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ogw-storage-classes-usage">
   <title>Utilizzo delle classi di storage</title>
   <para>
    Tutte le destinazioni di posizionamento dispongono di una classe di storage "STANDARD" che viene applicata per default ai nuovi oggetti. È possibile sostituire questa classe di default con la relativa "default_storage_class".
   </para>
   <para>
    Per creare un oggetto in una classe di storage non di default, specificare il nome di tale classe in un'intestazione HTTP insieme alla richiesta. Il protocollo S3 utilizza l'intestazione "X-Amz-Storage-Class", mentre il protocollo Swift utilizza l'intestazione "X-Object-Storage-Class".
   </para>
   <para>
    È possibile utilizzare <emphasis>S3 Object Lifecycle Management</emphasis> per spostare i dati degli oggetti tra le classi di storage con le azioni "Transition".
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rgw-fed">


  <title>Object Gateway multisito</title>

  <variablelist>
   <varlistentry>
    <term>Zona</term>
    <listitem>
     <para>
      Raggruppamento logico di una o più istanze Object Gateway. È necessario designare una zona come <emphasis>master</emphasis> in un <emphasis>gruppo di zone</emphasis>, dalla quale gestire la creazione di tutti i compartimenti e di tutti gli utenti.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Gruppo di zone</term>
    <listitem>
     <para>
      Un gruppo di zone è costituito da più zone. Le modifiche alla configurazione del sistema dovranno essere gestite da un gruppo di zone master.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Mappa del gruppo di zone</term>
    <listitem>
     <para>
      Struttura di configurazione che contiene la mappa dell'intero sistema, ad esempio indica il gruppo di zone master, le relazioni tra gruppi di zone diversi e alcune opzioni di configurazione come le policy di memorizzazione.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Dominio</term>
    <listitem>
     <para>
      Container per i gruppi di zone. Consente la separazione dei gruppi di zone tra i cluster. È possibile creare più domini in modo da semplificare l'esecuzione di configurazioni completamente diverse nello stesso cluster.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Periodo</term>
    <listitem>
     <para>
      Un periodo contiene la struttura di configurazione per lo stato attuale del dominio. Ciascun periodo contiene un ID univoco e un'epoca. A ogni dominio è associato un periodo attuale, con lo stato attuale della configurazione dei gruppi di zone e le policy di memorizzazione. Qualsiasi modifica alla configurazione per una zona non master aumenterà l'epoca del periodo. Se si modifica la zona master in una zona diversa, verranno attivate le seguenti modifiche:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        Viene generato un nuovo periodo con un ID periodo nuovo e un'epoca pari a 1.
       </para>
      </listitem>
      <listitem>
       <para>
        Il periodo attuale del dominio viene aggiornato in modo che punti all'ID periodo appena generato.
       </para>
      </listitem>
      <listitem>
       <para>
        L'epoca del dominio aumenta di valore.
       </para>
      </listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   È possibile configurare ciascun Object Gateway in modo che faccia parte di un'architettura federata, operando in una configurazione di zona attiva e consentendo al contempo le scritture in zone non master.
  </para>

  <sect2 xml:id="ceph-rgw-fed-term">
   <title>Terminologia</title>
   <para>
    Di seguito è riportata una descrizione dei termini specifici di un'architettura federata:
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-intro">
   <title>Esempio di configurazione cluster</title>
   <para>
    Questo esempio è incentrato sulla creazione di un singolo gruppo di zone con tre zone distinte, in cui vengono sincronizzati attivamente i rispettivi dati. Due zone appartengono allo stesso cluster, mentre la terza appartiene a un cluster diverso. Non è presente alcun agente di sincronizzazione coinvolto nel processo di copia speculare delle modifiche dei dati tra gli Object Gateway. In tal modo si ottengono uno schema di configurazione e configurazioni attive-attive più semplici. Le operazioni dei metadati, come la creazione di un nuovo utente, devono continuare a passare dalla zona master. Le operazioni dei dati, tuttavia, come la creazione di compartimenti e oggetti, possono essere gestite da qualsiasi zona.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-keys">
   <title>Chiavi di sistema</title>
   <para>
    Durante la configurazione delle zone, Object Gateway si aspetta la creazione di un utente del sistema compatibile con S3 e delle rispettive chiavi di accesso e segreta. Ciò consente a un'altra istanza di Object Gateway di recuperare la configurazione in remoto tramite le chiavi di accesso e segreta. Per ulteriori informazioni sulla creazione di utenti S3, vedere <xref linkend="adding-s3-swift-users"/>.
   </para>
   <tip>
    <para>
     È utile generare la chiave di accesso e la chiave segreta prima della creazione della zona stessa perché così facendo, successivamente la creazione di script e l'uso degli strumenti di gestione della configurazione risulteranno più semplici.
    </para>
   </tip>
   <para>
    Ai fini del presente esempio, presupporre che la chiave di accesso e la chiave segreta siano impostate nelle variabili ambiente:
   </para>
<screen># SYSTEM_ACCESS_KEY=1555b35654ad1656d805
# SYSTEM_SECRET_KEY=h7GhxuBLTrlhVUyxSPUKUV8r/2EI4ngqJxD7iBdBYLhwluN30JaT3Q==</screen>
   <para>
    Di norma, le chiavi di accesso sono costituite da 20 caratteri alfanumerici, mentre le chiavi segrete da 40 caratteri alfanumerici (possono contenere anche i caratteri +/=). È possibile generare tali chiavi nella riga di comando:
   </para>
<screen># SYSTEM_ACCESS_KEY=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 20 | head -n 1)
# SYSTEM_SECRET_KEY=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 40 | head -n 1)</screen>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-naming">
   <title>Convenzioni di denominazione</title>
   <para>
    In questo esempio è illustrato il processo di configurazione di una zona master. Si prenda come riferimento un gruppo di zone denominato <literal>us</literal> esteso agli Stati Uniti che sarà il gruppo di zone master. Tale gruppo conterrà due zone scritte nel formato <replaceable>ZONEGROUP</replaceable>-<replaceable>ZONE</replaceable>. Il formato dell'esempio è quello convenzionale, ma è possibile scegliere il formato che si preferisce. Nel riepilogo:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Gruppo di zone master: Stati Uniti <literal>us</literal>
     </para>
    </listitem>
    <listitem>
     <para>
      Zona master: Stati Uniti, Area Est 1: <literal>us-east-1</literal>
     </para>
    </listitem>
    <listitem>
     <para>
      Zona secondaria: Stati Uniti, Area Est 2: <literal>us-east-2</literal>
     </para>
    </listitem>
    <listitem>
     <para>
      Zona secondaria: Stati Uniti, Area Ovest: <literal>us-west</literal>
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Questa farà parte di un dominio più grande denominato <literal>gold</literal>. Le zone <literal>us-east-1</literal> e <literal>us-east-2</literal> fanno parte dello stesso cluster Ceph, <literal>us-east-1</literal>che è quello primario. <literal>us-west</literal> rientra in un cluster Ceph diverso.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-pools">
   <title>Pool di default</title>
   <para>
    Quando è configurato con le autorizzazioni appropriate, Object Gateway crea pool di default propri. I valori <literal>pg_num</literal> e <literal>pgp_num</literal> sono ricavati dal file di configurazione <filename>ceph.conf</filename>. I pool correlati a una zona per default seguono la convenzione <replaceable>ZONE-NAME</replaceable>.<replaceable>POOL-NAME</replaceable>. Ad esempio, per la zona <literal>us-east-1</literal>, verranno creati i pool seguenti:
   </para>
<screen>.rgw.root
us-east-1.rgw.control
us-east-1.rgw.data.root
us-east-1.rgw.gc
us-east-1.rgw.log
us-east-1.rgw.intent-log
us-east-1.rgw.usage
us-east-1.rgw.users.keys
us-east-1.rgw.users.email
us-east-1.rgw.users.swift
us-east-1.rgw.users.uid
us-east-1.rgw.buckets.index
us-east-1.rgw.buckets.data
us-east-1.rgw.meta</screen>
   <para>
    È possibile creare tali pool anche in altre zone sostituendo <literal>us-east-1</literal> con il nome zona appropriato.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-realm">
   <title>Creazione di un dominio</title>
   <para>
    Configurare un dominio denominato <literal>gold</literal> e renderlo il dominio di default:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin realm create --rgw-realm=gold --default
{
  "id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "name": "gold",
  "current_period": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "epoch": 1
}</screen>
   <para>
    Si noti che ciascun dominio dispone di un ID ai fini della flessibilità, ad esempio consente di rinominarlo in un momento successivo in caso di necessità. Il <literal>current_period</literal> cambia ogni volta che si modifica la zona master. Il valore di <literal>epoch</literal> aumenta quando una modifica nella configurazione della zona master risulta in una modifica del periodo attuale.
   </para>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-deldefzonegrp">
   <title>Eliminazione del gruppo di zone di default</title>
   <para>
    L'installazione di default di Object Gateway crea un gruppo di zone di default denominato <literal>default</literal>. Poiché il gruppo di zone di default non è più necessario, rimuoverlo.
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup delete --rgw-zonegroup=default</screen>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-createmasterzonegrp">
   <title>Creazione di un gruppo di zone master</title>
   <para>
    Creare un gruppo di zone master denominato <literal>us</literal>. Il gruppo di zone gestirà la mappa del gruppo di zone e propagherà le modifiche al resto del sistema. Contrassegnando il gruppo di zone come default, si consentirà la menzione esplicita dello switch rgw-zonegroup per i comandi successivi.
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup create --rgw-zonegroup=us \
--endpoints=http://rgw1:80 --master --default
{
  "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
  "name": "us",
  "api_name": "us",
  "is_master": "true",
  "endpoints": [
      "http:\/\/rgw1:80"
  ],
  "hostnames": [],
  "hostnames_s3website": [],
  "master_zone": "",
  "zones": [],
  "placement_targets": [],
  "default_placement": "",
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
}</screen>
   <para>
    In alternativa, è possibile contrassegnare un gruppo di zone come default con il comando seguente:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup default --rgw-zonegroup=us</screen>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-masterzone">
   <title>Creazione di una zona master</title>
   <para>
    Adesso creare una zona di default e aggiungerla al gruppo di zone di default. Questa zona verrà utilizzata per le operazioni dei metadati, come la creazione di un utente:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --rgw-zone=us-east-1 \
--endpoints=http://rgw1:80 --access-key=<replaceable>$SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>$SYSTEM_SECRET_KEY</replaceable>
{
  "id": "83859a9a-9901-4f00-aa6d-285c777e10f0",
  "name": "us-east-1",
  "domain_root": "us-east-1/gc.rgw.data.root",
  "control_pool": "us-east-1/gc.rgw.control",
  "gc_pool": "us-east-1/gc.rgw.gc",
  "log_pool": "us-east-1/gc.rgw.log",
  "intent_log_pool": "us-east-1/gc.rgw.intent-log",
  "usage_log_pool": "us-east-1/gc.rgw.usage",
  "user_keys_pool": "us-east-1/gc.rgw.users.keys",
  "user_email_pool": "us-east-1/gc.rgw.users.email",
  "user_swift_pool": "us-east-1/gc.rgw.users.swift",
  "user_uid_pool": "us-east-1/gc.rgw.users.uid",
  "system_key": {
      "access_key": "1555b35654ad1656d804",
      "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
  },
  "placement_pools": [
      {
          "key": "default-placement",
          "val": {
              "index_pool": "us-east-1/gc.rgw.buckets.index",
              "data_pool": "us-east-1/gc.rgw.buckets.data",
              "data_extra_pool": "us-east-1/gc.rgw.buckets.non-ec",
              "index_type": 0
          }
      }
  ],
  "metadata_heap": "us-east-1/gc.rgw.meta",
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
}</screen>
   <para>
    Gli switch <option>--rgw-zonegroup</option> e <option>--default</option> consentono di aggiungere la zona a un gruppo di zone e la rendono la zona di default. In alternativa, è possibile effettuare la stessa operazione con i comandi seguenti:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zone default --rgw-zone=us-east-1
<prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup add --rgw-zonegroup=us --rgw-zone=us-east-1</screen>
   <sect3 xml:id="ceph-rgw-fed-masterzone-createuser">
    <title>Creazione di utenti di sistema</title>
    <para>
     Per accedere ai pool di zone, è necessario creare un utente di sistema. Queste chiavi saranno necessarie anche quando si configura la zona secondaria.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin user create --uid=zone.user \
--display-name="Zone User" --access-key=<replaceable>$SYSTEM_ACCESS_KEY</replaceable> \
--secret=<replaceable>$SYSTEM_SECRET_KEY</replaceable> --system</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-updateperiod">
    <title>Aggiornamento del periodo</title>
    <para>
     Poiché si è modificata la configurazione della zona master, è necessario confermare le modifiche per poterle applicare alla struttura di configurazione del dominio. Inizialmente il dominio ha il seguente aspetto:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin period get
{
  "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "epoch": 1, "predecessor_uuid": "", "sync_status": [], "period_map":
  {
    "id": "09559832-67a4-4101-8b3f-10dfcd6b2707", "zonegroups": [], "short_zone_ids": []
  }, "master_zonegroup": "", "master_zone": "", "period_config":
  {
     "bucket_quota": {
     "enabled": false, "max_size_kb": -1, "max_objects": -1
     }, "user_quota": {
       "enabled": false, "max_size_kb": -1, "max_objects": -1
     }
  }, "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7", "realm_name": "gold", "realm_epoch": 1
}</screen>
    <para>
     Aggiornare il periodo e confermare le modifiche:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin period update --commit
{
  "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
  "epoch": 1,
  "predecessor_uuid": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "sync_status": [ "[...]"
  ],
  "period_map": {
      "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
      "zonegroups": [
          {
              "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
              "name": "us",
              "api_name": "us",
              "is_master": "true",
              "endpoints": [
                  "http:\/\/rgw1:80"
              ],
              "hostnames": [],
              "hostnames_s3website": [],
              "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "zones": [
                  {
                      "id": "83859a9a-9901-4f00-aa6d-285c777e10f0",
                      "name": "us-east-1",
                      "endpoints": [
                          "http:\/\/rgw1:80"
                      ],
                      "log_meta": "true",
                      "log_data": "false",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  }
              ],
              "placement_targets": [
                  {
                      "name": "default-placement",
                      "tags": []
                  }
              ],
              "default_placement": "default-placement",
              "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
          }
      ],
      "short_zone_ids": [
          {
              "key": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "val": 630926044
          }
      ]
  },
  "master_zonegroup": "d4018b8d-8c0d-4072-8919-608726fa369e",
  "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
  "period_config": {
      "bucket_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      },
      "user_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      }
  },
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "realm_name": "gold",
  "realm_epoch": 2
}</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-masterzone-startrgw">
    <title>Avvio di Object Gateway</title>
    <para>
     Prima di avviare Object Gateway, è necessario menzionare nel file di configurazione le opzioni relative alla zona e alla porta Object Gateway. Per ulteriori informazioni su Object Gateway e la relativa configurazione, vedere <xref linkend="cha-ceph-gw"/>. La sezione di configurazione di Object Gateway deve avere un aspetto simile a quanto riportato di seguito:
    </para>
<screen>[client.rgw.us-east-1]
rgw_frontends="beast port=80"
rgw_zone=us-east-1</screen>
    <para>
     Avviare Object Gateway:
    </para>
<screen><prompt>root # </prompt>systemctl start ceph-radosgw@rgw.us-east-1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-secondaryzone">
   <title>Creazione di una zona secondaria</title>
   <para>
    Le zone all'interno di un gruppo di zone replicano tutti i dati per fare in modo che in ogni zona siano presenti gli stessi dati. Durante la creazione di una zona secondaria, effettuare tutte le operazioni seguenti su un host identificato per servire tale zona.
   </para>
   <para>
    Nel cluster secondario, creare e configurare la zona secondaria denominata <literal>us-east-2</literal>. È possibile eseguire tutti i comandi seguenti nel nodo che ospita la zona master stessa.
   </para>
   <para>
    Per creare una zona secondaria, utilizzare lo stesso comando impiegato per la creazione della zona primaria, ad eccezione del rilascio del flag master:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --endpoints=http://rgw2:80 \
--rgw-zone=us-east-2 --access-key=<replaceable>$SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>$SYSTEM_SECRET_KEY</replaceable>
{
  "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
  "name": "us-east-2",
  "domain_root": "us-east-2.rgw.data.root",
  "control_pool": "us-east-2.rgw.control",
  "gc_pool": "us-east-2.rgw.gc",
  "log_pool": "us-east-2.rgw.log",
  "intent_log_pool": "us-east-2.rgw.intent-log",
  "usage_log_pool": "us-east-2.rgw.usage",
  "user_keys_pool": "us-east-2.rgw.users.keys",
  "user_email_pool": "us-east-2.rgw.users.email",
  "user_swift_pool": "us-east-2.rgw.users.swift",
  "user_uid_pool": "us-east-2.rgw.users.uid",
  "system_key": {
      "access_key": "1555b35654ad1656d804",
      "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
  },
  "placement_pools": [
      {
          "key": "default-placement",
          "val": {
              "index_pool": "us-east-2.rgw.buckets.index",
              "data_pool": "us-east-2.rgw.buckets.data",
              "data_extra_pool": "us-east-2.rgw.buckets.non-ec",
              "index_type": 0
          }
      }
  ],
  "metadata_heap": "us-east-2.rgw.meta",
  "realm_id": "815d74c2-80d6-4e63-8cfc-232037f7ff5c"
}</screen>
   <sect3 xml:id="ceph-rgw-fed-secondzone-updateperiod">
    <title>Aggiornamento del periodo</title>
    <para>
     Informare tutti i gateway in merito alla nuova modifica della mappa di sistema eseguendo un aggiornamento del periodo e confermando le modifiche:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin period update --commit
{
  "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
  "epoch": 2,
  "predecessor_uuid": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "sync_status": [ "[...]"
  ],
  "period_map": {
      "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
      "zonegroups": [
          {
              "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
              "name": "us",
              "api_name": "us",
              "is_master": "true",
              "endpoints": [
                  "http:\/\/rgw1:80"
              ],
              "hostnames": [],
              "hostnames_s3website": [],
              "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "zones": [
                  {
                      "id": "83859a9a-9901-4f00-aa6d-285c777e10f0",
                      "name": "us-east-1",
                      "endpoints": [
                          "http:\/\/rgw1:80"
                      ],
                      "log_meta": "true",
                      "log_data": "false",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  },
                  {
                      "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
                      "name": "us-east-2",
                      "endpoints": [
                          "http:\/\/rgw2:80"
                      ],
                      "log_meta": "false",
                      "log_data": "true",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  }

              ],
              "placement_targets": [
                  {
                      "name": "default-placement",
                      "tags": []
                  }
              ],
              "default_placement": "default-placement",
              "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
          }
      ],
      "short_zone_ids": [
          {
              "key": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "val": 630926044
          },
          {
              "key": "950c1a43-6836-41a2-a161-64777e07e8b8",
              "val": 4276257543
          }

      ]
  },
  "master_zonegroup": "d4018b8d-8c0d-4072-8919-608726fa369e",
  "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
  "period_config": {
      "bucket_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      },
      "user_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      }
  },
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "realm_name": "gold",
  "realm_epoch": 2
}</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-secondzone-startrgw">
    <title>Avvio di Object Gateway</title>
    <para>
     Regolare la configurazione di Object Gateway per una zona secondaria e avviarlo:
    </para>
<screen>[client.rgw.us-east-2]
rgw_frontends="beast port=80"
rgw_zone=us-east-2</screen>
<screen><prompt>cephadm@adm &gt; </prompt>sudo systemctl start ceph-radosgw@rgw.us-east-2</screen>
   </sect3>
   <sect3 xml:id="ceph-update-dashboard-config">
    <title>Aggiornare la configurazione del Ceph Dashboard</title>
    <procedure>
     <step>
      <para>
       Impostare quanto segue per aggiornare la configurazione del dashboard per la modalità multisito in base alle variabili secret-key e access-key:
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph dashboard set-rgw-api-access-key <replaceable>ACCESS-KEY</replaceable>
<prompt>cephadm@adm &gt; </prompt>ceph dashboard set-rgw-api-secret-key <replaceable>SECRET-KEY</replaceable>
</screen>
     </step>
     <step>
      <para>
       Configurare l'impostazione di default del dashboard su <literal>admin</literal>:
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph dashboard set-rgw-api-user-id admin</screen>
     </step>
     <step>
      <para>
       Disabilitare e riabilitare il dashboard per applicare le impostazioni.
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph mgr module disable dashboard
<prompt>cephadm@adm &gt; </prompt> ceph mgr module enable dashboard
</screen>
     </step>
     <step>
      <para>
       Se il nodo Object Gateway è stato modificato o se è in uso un servizio di bilanciamento del carico al posto degli Object Gateway, aggiornare il dashboard:
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>dashboard set-rgw-api-host <replaceable>HOST</replaceable>
<prompt>cephadm@adm &gt; </prompt>dashboard set-rgw-api-port <replaceable>PORT</replaceable>
</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-seccluster">
   <title>Aggiunta di Object Gateway al secondo cluster</title>
   <para>
    Il secondo cluster Ceph appartiene allo stesso gruppo di zone di quello iniziale, ma è geograficamente ubicato altrove.
   </para>
   <sect3 xml:id="ceph-rgw-fed-seccluster-realm">
    <title>Dominio e gruppo di zone di default</title>
    <para>
     Poiché si è già creato il dominio per il primo gruppo di zone, recuperare qui il dominio e renderlo quello di default:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin realm pull --url=http://rgw1:80 \
--access-key=<replaceable>$SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>$SYSTEM_SECRET_KEY</replaceable>
{
  "id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "name": "gold",
  "current_period": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
  "epoch": 2
}
<prompt>cephadm@adm &gt; </prompt>radosgw-admin realm default --rgw-realm=gold</screen>
    <para>
     Ottenere la configurazione dalla zona master recuperando il periodo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin period pull --url=http://rgw1:80 \
--access-key=<replaceable>$SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>$SYSTEM_SECRET_KEY</replaceable></screen>
    <para>
     Impostare il gruppo di zone di default a quello <literal>us</literal> che è già stato creato:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zonegroup default --rgw-zonegroup=us</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-seccluster-seczone">
    <title>Configurazione della zona secondaria</title>
    <para>
     Creare una nuova zona denominata <literal>us-west</literal> con le stesse chiavi di sistema:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin zone create --rgw-zonegroup=us --rgw-zone=us-west \
--access-key=<replaceable>$SYSTEM_ACCESS_KEY</replaceable> --secret=<replaceable>$SYSTEM_SECRET_KEY</replaceable> \
--endpoints=http://rgw3:80 --default
{
  "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
  "name": "us-west",
  "domain_root": "us-west.rgw.data.root",
  "control_pool": "us-west.rgw.control",
  "gc_pool": "us-west.rgw.gc",
  "log_pool": "us-west.rgw.log",
  "intent_log_pool": "us-west.rgw.intent-log",
  "usage_log_pool": "us-west.rgw.usage",
  "user_keys_pool": "us-west.rgw.users.keys",
  "user_email_pool": "us-west.rgw.users.email",
  "user_swift_pool": "us-west.rgw.users.swift",
  "user_uid_pool": "us-west.rgw.users.uid",
  "system_key": {
      "access_key": "1555b35654ad1656d804",
      "secret_key": "h7GhxuBLTrlhVUyxSPUKUV8r\/2EI4ngqJxD7iBdBYLhwluN30JaT3Q=="
  },
  "placement_pools": [
      {
          "key": "default-placement",
          "val": {
              "index_pool": "us-west.rgw.buckets.index",
              "data_pool": "us-west.rgw.buckets.data",
              "data_extra_pool": "us-west.rgw.buckets.non-ec",
              "index_type": 0
          }
      }
  ],
  "metadata_heap": "us-west.rgw.meta",
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
}</screen>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-seccluster-period">
    <title>Aggiornamento del periodo</title>
    <para>
     Per propagare le modifiche del gruppo di zone, si aggiorna e si conferma il periodo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>radosgw-admin period update --commit --rgw-zone=us-west
{
  "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
  "epoch": 3,
  "predecessor_uuid": "09559832-67a4-4101-8b3f-10dfcd6b2707",
  "sync_status": [
      "", # truncated
  ],
  "period_map": {
      "id": "b5e4d3ec-2a62-4746-b479-4b2bc14b27d1",
      "zonegroups": [
          {
              "id": "d4018b8d-8c0d-4072-8919-608726fa369e",
              "name": "us",
              "api_name": "us",
              "is_master": "true",
              "endpoints": [
                  "http:\/\/rgw1:80"
              ],
              "hostnames": [],
              "hostnames_s3website": [],
              "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "zones": [
                  {
                      "id": "83859a9a-9901-4f00-aa6d-285c777e10f0",
                      "name": "us-east-1",
                      "endpoints": [
                          "http:\/\/rgw1:80"
                      ],
                      "log_meta": "true",
                      "log_data": "true",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  },
                                  {
                      "id": "950c1a43-6836-41a2-a161-64777e07e8b8",
                      "name": "us-east-2",
                      "endpoints": [
                          "http:\/\/rgw2:80"
                      ],
                      "log_meta": "false",
                      "log_data": "true",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  },
                  {
                      "id": "d9522067-cb7b-4129-8751-591e45815b16",
                      "name": "us-west",
                      "endpoints": [
                          "http:\/\/rgw3:80"
                      ],
                      "log_meta": "false",
                      "log_data": "true",
                      "bucket_index_max_shards": 0,
                      "read_only": "false"
                  }
              ],
              "placement_targets": [
                  {
                      "name": "default-placement",
                      "tags": []
                  }
              ],
              "default_placement": "default-placement",
              "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7"
          }
      ],
      "short_zone_ids": [
          {
              "key": "83859a9a-9901-4f00-aa6d-285c777e10f0",
              "val": 630926044
          },
          {
              "key": "950c1a43-6836-41a2-a161-64777e07e8b8",
              "val": 4276257543
          },
          {
              "key": "d9522067-cb7b-4129-8751-591e45815b16",
              "val": 329470157
          }
      ]
  },
  "master_zonegroup": "d4018b8d-8c0d-4072-8919-608726fa369e",
  "master_zone": "83859a9a-9901-4f00-aa6d-285c777e10f0",
  "period_config": {
      "bucket_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      },
      "user_quota": {
          "enabled": false,
          "max_size_kb": -1,
          "max_objects": -1
      }
  },
  "realm_id": "4a367026-bd8f-40ee-b486-8212482ddcd7",
  "realm_name": "gold",
  "realm_epoch": 2
}</screen>
    <para>
     Il numero di epoca del periodo aumenta a indicare una modifica nella configurazione.
    </para>
   </sect3>
   <sect3 xml:id="ceph-rgw-fed-seccluster-rgwstart">
    <title>Avvio di Object Gateway</title>
    <para>
     Questa operazione è simile all'avvio di Object Gateway nella prima zona, con l'unica differenza che la configurazione di zona di Object Gateway deve riflettere il nome zona <literal>us-west</literal>:
    </para>
<screen>[client.rgw.us-west]
rgw_frontends="beast port=80"
rgw_zone=us-west</screen>
    <para>
     Avviare il secondo Object Gateway:
    </para>
<screen><prompt>root # </prompt>systemctl start ceph-radosgw@rgw.us-west</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-rgw-fed-failover">
   <title>Failover e disaster recovery</title>
   <para>
    Qualora la zona master dovesse venire meno, eseguire il failover nella zona secondaria per il disaster recovery.
   </para>
   <procedure>
    <step>
     <para>
      Rendere la zona secondaria la zona master e di default. Ad esempio:
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default
     </screen>
     <para>
      Per default, Ceph Object Gateway verrà eseguito in una configurazione attiva-attiva. Se si è configurato il cluster per l'esecuzione in una configurazione attiva-passiva, la zona secondaria è di sola lettura. Rimuovere lo stato --read-per consentire alla zona di ricevere operazioni di scrittura. Ad esempio:
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default \
--read-only=False
     </screen>
    </step>
    <step>
     <para>
      Aggiornare il periodo per applicare le modifiche.
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> period update --commit
     </screen>
    </step>
    <step>
     <para>
      Infine, riavviare Ceph Object Gateway.
     </para>
<screen>
<prompt>root # </prompt><command>systemctl</command> restart ceph-radosgw@rgw.`hostname -s`
     </screen>
    </step>
   </procedure>
   <para>
    Se la zona master precedente viene recuperata, ripristinare l'operazione.
   </para>
   <procedure>
    <step>
     <para>
      Dalla zona recuperata, recuperare il periodo dall'attuale zona master.
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> period pull --url=<replaceable>URL-TO-MASTER-ZONE-GATEWAY</replaceable> \
--access-key=<replaceable>ACCESS-KEY</replaceable> --secret=<replaceable>SECRET</replaceable>
     </screen>
    </step>
    <step>
     <para>
      Rendere la zona recuperata la zona master e di default.
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --master --default
     </screen>
    </step>
    <step>
     <para>
      Aggiornare il periodo per applicare le modifiche.
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> period update --commit
     </screen>
    </step>
    <step>
     <para>
      Quindi, riavviare Ceph Object Gateway nella zona recuperata.
     </para>
<screen>
<prompt>root # </prompt><command>systemctl</command> restart ceph-radosgw@rgw.`hostname -s`
     </screen>
    </step>
    <step>
     <para>
      Se la configurazione della zona secondaria deve essere in sola lettura, aggiornare la zona secondaria.
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> zone modify --rgw-zone=<replaceable>ZONE-NAME</replaceable> --read-only
     </screen>
    </step>
    <step>
     <para>
      Aggiornare il periodo per applicare le modifiche.
     </para>
<screen>
<prompt>cephadm@adm &gt; </prompt><command>radosgw-admin</command> period update --commit
     </screen>
    </step>
    <step>
     <para>
      Infine, riavviare Ceph Object Gateway nella zona secondaria.
     </para>
<screen>
<prompt>root # </prompt><command>systemctl</command> restart ceph-radosgw@rgw.`hostname -s`
     </screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="ogw-haproxy">
  <title>Bilanciamento del carico dei server Object Gateway con HAProxy</title>

  <para>
   È possibile utilizzare il bilanciamento del carico HAProxy per distribuire tutte le richieste in più server back-end Object Gateway. Per ulteriori dettagli sulla configurazione di HAProxy, fare riferimento a <link xlink:href="https://www.suse.com/documentation/sle-ha-15/book_sleha_guide/data/sec_ha_lb_haproxy.html"/> (in lingua inglese).
  </para>

  <para>
   Di seguito è riportata una configurazione semplice di HAProxy per il bilanciamento dei nodi Object Gateway mediante l'uso di Round Robin come algoritmo di bilanciamento:
  </para>

<screen>
<prompt>tux &gt; </prompt>cat /etc/haproxy/haproxy.cfg
[...]
frontend <replaceable>HTTPS_FRONTEND</replaceable>
bind *:443 crt <replaceable>path-to-cert.pem</replaceable> [ciphers: ... ]
default_backend rgw

backend rgw
mode http
balance roundrobin
server rgw_server1 <replaceable>RGW-ENDPOINT1</replaceable> weight 1 maxconn 100 check
server rgw_server2 <replaceable>RGW-ENDPOINT2</replaceable> weight 1 maxconn 100 check
[...]
</screen>
 </sect1>
</chapter>
