<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph-operating-services">
 <title>Attivazione dei servizi Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sì</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Per attivare i servizi Ceph è possibile utilizzare <systemitem class="daemon">systemd</systemitem> o DeepSea.
 </para>
 <sect1 xml:id="operate-services-systemd">
  <title>Attivazione dei servizi correlati al cluster Ceph con <systemitem class="daemon">systemd</systemitem></title>

  <para>
   Utilizzare il comando <command>systemctl</command> per attivare tutti i servizi correlati a Ceph. Tali servizi vengono messi in funzione nel nodo al quale si è attualmente eseguito il login. Per poter operare sui servizi Ceph è necessario disporre dei privilegi <systemitem class="username">radice</systemitem>.
  </para>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Avvio, interruzione e riavvio dei servizi mediante l'uso di destinazioni</title>
   <para>
    Per semplificare l'avvio, l'interruzione e il riavvio di tutti i servizi di un determinato tipo (ad esempio tutti i servizi Ceph o tutti i MON o OSD) in un nodo, in Ceph sono disponibili i seguenti file di unità <systemitem class="daemon">systemd</systemitem>:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    Per avviare/interrompere/riavviare tutti i servizi Ceph sul nodo, eseguire:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl restart ceph.target
</screen>
   <para>
    Per avviare/interrompere/riavviare tutti gli OSD sul nodo, eseguire:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target
</screen>
   <para>
    I comandi per le altre destinazioni sono analoghi.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-individual">
   <title>Avvio, interruzione e riavvio di servizi individuali</title>
   <para>
    È possibile attivare servizi individuali utilizzando i seguenti file di unità <systemitem class="daemon">systemd</systemitem> on parametri:
   </para>
<screen>
ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-mgr@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service
</screen>
   <para>
    Per utilizzare questi comandi, è prima necessario identificare il nome del servizio da attivare. Per ulteriori informazioni sull'identificazione dei servizi, vedere <xref linkend="ceph-operating-services-finding-names"/>.
   </para>
   <para>
    Per avviare/interrompere/riavviare il servizio <literal>osd.1</literal>, eseguire:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service
</screen>
   <para>
    I comandi per gli altri tipi di servizi sono analoghi.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identificazione di servizi individuali</title>
   <para>
    È possibile individuare i nomi/numeri di un particolare tipo di servizio in molti modi. I comandi seguenti consentono di ottenere risultati per i servizi <literal>ceph*</literal>. È possibile eseguirli in un nodo qualsiasi del cluster Ceph.
   </para>
   <para>
    Per visualizzare un elenco di tutti i servizi (anche quelli inattivi) del tipo <literal>ceph*</literal>, eseguire:
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --type=service ceph*
</screen>
   <para>
    Per visualizzare un elenco composto soltanto dai servizi inattivi, eseguire:
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --state=inactive --type=service ceph*
</screen>
   <para>
    È inoltre possibile utilizzare <command>salt</command> per interrogare i servizi tra più nodi:
   </para>
<screen>
<prompt>root@master # </prompt>salt <replaceable>TARGET</replaceable> cmd.shell \
 "systemctl list-units --all --type=service ceph* | sed -e '/^$/,$ d'"
</screen>
   <para>
    Per interrogare soltanto i nodi di storage:
   </para>
<screen>
<prompt>root@master # </prompt>salt -I 'roles:storage' cmd.shell \
 'systemctl list-units --all --type=service ceph*'
</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Stato dei servizi</title>
   <para>
    È possibile interrogare <systemitem class="daemon">systemd</systemitem> per lo stato dei servizi. Ad esempio:
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    Sostituire <replaceable>HOSTNAME</replaceable> con il nome host sul quale è in esecuzione il daemon.
   </para>
   <para>
    Se non si conosce il nome/numero esatto del servizio, vedere <xref linkend="ceph-operating-services-finding-names"/>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea-restart">
  <title>Riavvio dei servizi Ceph mediante l'uso di DeepSea</title>

  <para>
   Dopo aver applicato gli aggiornamenti ai nodi del cluster, è necessario riavviare i servizi correlati a Ceph interessati. Di norma, DeepSea effettua automaticamente il riavvio di tali servizi. Questa sezione descrive come riavviarli manualmente.
  </para>

  <tip>
   <title>osservazione del riavvio</title>
   <para>
    Il processo di riavvio del cluster può richiedere tempo. È possibile osservare gli eventi utilizzando il bus di eventi Salt eseguendo:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
   <para>
    Un altro comando per il monitoraggio dei lavori attivi è
   </para>
<screen>
<prompt>root@master # </prompt>salt-run jobs.active
</screen>
  </tip>

  <sect2 xml:id="deepsea-restart-all">
   <title>Riavvio di tutti i servizi</title>
   <warning>
    <title>interruzione dei servizi</title>
    <para>
     Se i servizi correlati a Ceph, specificamente iSCSI o NFS Ganesha, sono configurati come singoli punti di accesso senza nessuna configurazione a elevata disponibilità, il loro riavvio comporterà un'interruzione temporanea sul lato client.
    </para>
   </warning>
   <tip>
    <title>Samba non gestito da DeepSea</title>
    <para>
     Poiché al momento DeepSea e il Ceph Dashboard non supportano le distribuzioni Samba, è necessario gestire manualmente i servizi correlati a Samba. Per ulteriori informazioni, vedere <xref linkend="cha-ses-cifs"/>.
    </para>
   </tip>
   <para>
    Per riavviare <emphasis>tutti</emphasis> i servizi sul cluster, eseguire il seguente comando:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <itemizedlist>
    <listitem>
     <para>
      Per le versioni precedenti a DeepSea 0.8.4, i servizi Metadata Server, iSCSI Gateway, Object Gateway e NFS Ganesha vengono riavviati parallelamente.
     </para>
    </listitem>
    <listitem>
     <para>
      Per DeepSea 0.8.4 e versioni successive, tutti i ruoli configurati vengono riavviati nel seguente ordine: Ceph Monitor, Ceph Manager, Ceph OSD, Metadata Server, Object Gateway, iSCSI Gateway, NFS Ganesha. Per mantenere basso il tempo di inattività e trovare potenziali problemi il prima possibile, i nodi vengono riavviati in ordine sequenziale. Ad esempio, viene avviato un solo nodo di monitoraggio alla volta.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Il comando attende il recupero del cluster se questo si trova in uno stato danneggiato o non integro.
   </para>
  </sect2>

  <sect2 xml:id="deepsea-restart-specific">
   <title>Riavvio di servizi specifici</title>
   <para>
    Per riavviare un servizio specifico sul cluster, eseguire:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    Ad esempio, per riavviare tutti gli Object Gateway, eseguire:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    È possibile utilizzare le destinazioni seguenti:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Spegnimento normale dell'intero cluster Ceph</title>

  <para>
   In alcune occasioni è necessario interrompere tutti i servizi correlati a Ceph nel cluster seguendo l'ordine consigliato e quindi riavviarli, ad esempio nel caso di un'interruzione pianificata della corrente.
  </para>

  <para>
   Per spegnere l'intero cluster Ceph, disabilitare le misure di sicurezza ed eseguire lo strumento di esecuzione <command>ceph.shutdown</command>:
  </para>

<screen>
<prompt>root@master # </prompt>salt-run disengage.safety
<prompt>root@master # </prompt>salt-run state.orch ceph.shutdown
</screen>

  <para>
   Per avviare l'intero cluster Ceph, usare lo strumento di esecuzione <command>ceph.startup</command>:
  </para>

<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.startup
</screen>
 </sect1>
</chapter>
