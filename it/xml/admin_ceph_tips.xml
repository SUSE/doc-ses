<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_tips.xml" version="5.0" xml:id="storage.tips">
 <title>Suggerimenti</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>sì</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  In questo capito sono fornite le informazioni necessarie per migliorare le prestazioni del cluster Ceph e vengono forniti i suggerimenti su come impostare il cluster.
 </para>
 <sect1 xml:id="tips.scrubbing">
  <title>Regolazione della pulitura</title>

  <para>
   Per default, Ceph esegue la pulitura leggera (ulteriori dettagli sono disponibili nella <xref linkend="scrubbing"/>) giornaliera e la pulitura approfondita settimanale. Con la pulitura <emphasis>leggera</emphasis> vengono verificati le dimensioni e i checksum degli oggetti per assicurare che i gruppi di posizionamento memorizzino gli stessi dati oggetto. Con la pulitura <emphasis>approfondita</emphasis> viene verificato il contenuto di un oggetto con quello delle rispettive repliche per assicurare che i contenuti effettivi siano gli stessi. Il prezzo per la verifica dell'integrità dei dati è un carico I/O maggiore sul cluster durante la procedura di pulitura.
  </para>

  <para>
   Le impostazioni di default consentono ai Ceph OSD di iniziare la pulitura in momenti inappropriati, ad esempio durante i periodi di carichi pesanti. I clienti possono riscontrare latenza e prestazioni scarse quando le operazioni di pulitura sono in conflitto con le rispettive operazioni. In Ceph sono disponibili diverse impostazioni di pulitura che possono limitare la pulitura a periodi con carichi inferiori o durante le ore non di punta.
  </para>

  <para>
   Se il cluster riscontra carichi elevati durante il giorno e carichi bassi durante la notte, considerare di limitare la pulitura alle ore notturne, ad esempio dalle 23.00 alle 06.00:
  </para>

<screen>
[osd]
osd_scrub_begin_hour = 23
osd_scrub_end_hour = 6
</screen>

  <para>
   Se la restrizione dell'orario non è un metodo efficace per determinare la pianificazione di una pulitura, considerare di utilizzare l'opzione <option>osd_scrub_load_threshold</option>. Il valore di default è 0,5, ma è possibile modificarlo per condizioni di carico inferiore:
  </para>

<screen>
[osd]
osd_scrub_load_threshold = 0.25
</screen>
 </sect1>
 <sect1 xml:id="tips.stopping_osd_without_rebalancing">
  <title>Interruzione degli ODS senza ribilanciamento</title>

  <para>
   Potrebbe essere necessario interrompere gli ODS per la manutenzione periodica. Se non si desidera che CRUSH esegua automaticamente il ribilanciamento del cluster in modo da evitare il trasferimento di grandi quantità di dati, prima impostare il cluster su <literal>noout</literal>:
  </para>

<screen>
<prompt>root@minion &gt; </prompt>ceph osd set noout
</screen>

  <para>
   Quando il cluster è impostato su <literal>noout</literal>, è possibile iniziare a interrompere gli OSD nel dominio di errore per il quale è richiesta la manutenzione:
  </para>

<screen>
<prompt>root@minion &gt; </prompt>systemctl stop ceph-osd@<replaceable>OSD_NUMBER</replaceable>.service
</screen>

  <para>
   Per ulteriori informazioni, vedere <xref linkend="ceph.operating.services.individual"/>.
  </para>

  <para>
   Una volta completata la manutenzione, avviare di nuovo gli OSD:
  </para>

<screen>
<prompt>root@minion &gt; </prompt>systemctl start ceph-osd@<replaceable>OSD_NUMBER</replaceable>.service
</screen>

  <para>
   Dopo l'avvio dei servizi OSD, annullare l'impostazione <literal>noout</literal>:
  </para>

<screen>
<prompt>root@minion &gt; </prompt>ceph osd unset noout
</screen>
 </sect1>
 <sect1 xml:id="Cluster_Time_Setting">
  <title>Sincronizzazione dell'orario dei nodi</title>

  <para>
   Ceph richiede la sincronizzazione precisa dell'orario tra nodi particolari. Si deve configurare un nodo con il proprio server NTP. Anche se è possibile puntare tutte le istanze ntpd a un server dell'orario pubblico remoto, si sconsiglia di farlo con Ceph. Con tale configurazione, ciascun nodo del cluster dispone di un deamon NTP proprio che comunica continuamente su Internet con un set di tre o quattro server dell'orario, tutti abbastanza distanziati. Questa soluzione comporta un alto grado di variabilità della latenza, per cui è difficile, se non impossibile, mantenere l'orologio in moto al di sotto di 0,05 secondi (che è il valore richiesto dai Ceph monitor).
  </para>

  <para>
   Utilizzare quindi un computer singolo come server NTP per l'intero cluster. L'istanza ntpd del server NTP può quindi puntare al server NTP (pubblico) remoto o può disporre di una propria origine dell'orario. Le istanze ntpd su tutti i nodi vengono quindi puntate a tale server locale. Tale soluzione presenta diversi vantaggi, come l'eliminazione del traffico di rete inutile e gli sfasamenti di orario, nonché la riduzione del carico sui server NTP pubblici. Per informazioni dettagliate su come configurare il server NTP, fare riferimento a <link xlink:href="https://www.suse.com/documentation/sled11/book_sle_admin/data/cha_netz_xntp.html">SUSE Linux Enterprise Server Administration Guide</link> (in lingua inglese).
  </para>

  <para>
   Quindi, per modificare l'orario sul cluster, eseguire quanto riportato di seguito:
  </para>

  <important>
   <title>impostazione dell'orario</title>
   <para>
    Talvolta potrebbe essere necessario impostare indietro l'ora, ad esempio nel passaggio dall'ora legale all'ora solare. Non è consigliato spostare indietro l'ora per un periodo più lungo di quello di inattività del cluster. Lo spostamento dell'ora in avanti non causa alcun problema.
   </para>
  </important>

  <procedure>
   <title>Sincronizzazione dell'orario sul cluster</title>
   <step>
    <para>
     Interrompere tutti i client che accedono al cluster Ceph, soprattutto quelli che utilizzano iSCSI.
    </para>
   </step>
   <step>
    <para>
     Spegnere il cluster Ceph. Su ciascun nodo eseguire:
    </para>
<screen>systemctl stop ceph.target</screen>
    <note>
     <para>
      Se si utilizzano Ceph e SUSE OpenStack Cloud, interrompere anche SUSE OpenStack Cloud.
     </para>
    </note>
   </step>
   <step>
    <para>
     Verificare che il server NTP sia configurato correttamente, dove l'ora di tutti daemon ntpd è ricavata da una o più origini nella rete locale.
    </para>
   </step>
   <step>
    <para>
     Impostare l'ora corretta sul server NTP.
    </para>
   </step>
   <step>
    <para>
     Verificare che NTP sia in esecuzione e funzioni correttamente, quindi eseguire su tutti i nodi:
    </para>
<screen>status ntpd.service</screen>
    <para>
     oppure
    </para>
<screen>ntpq -p</screen>
   </step>
   <step>
    <para>
     Avviare tutti i nodi di monitoraggio e verificare che non vi siano sfasamenti di orario:
    </para>
<screen>systemctl start <replaceable>target</replaceable></screen>
   </step>
   <step>
    <para>
     Avviare tutti i nodi OSD.
    </para>
   </step>
   <step>
    <para>
     Avviare altri servizi Ceph.
    </para>
   </step>
   <step>
    <para>
     Avviare SUSE OpenStack Cloud se disponibile.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="storage.bp.cluster_mntc.unbalanced">
  <title>Verifica della scrittura dati non bilanciata</title>

  <para>
   Quando i dati vengono scritti negli OSD in modo uniforme, il cluster è considerato bilanciato. A ciascun OSD in un cluster viene assegnato il rispettivo <emphasis>peso</emphasis>. Il peso è un numero relativo e indica a Ceph la quantità di dati da scrivere nell'OSD correlato. Più alto è il peso, maggiore sarà la quantità di dati che vengono scritti. Se il peso di un OSD è pari a zero, non verranno scritti dati al suo interno. Se il peso di un OSD è relativamente alto rispetto ad altri OSD, in esso verrà scritta una grande porzione di dati causando uno sbilanciamento del cluster.
  </para>

  <para>
   I cluster non bilanciati hanno prestazioni scarse e nel caso in cui un OSD dal peso elevato si blocchi improvvisamente, è necessario spostare una gran quantità di dati in altri OSD, con un conseguente rallentamento del cluster.
  </para>

  <para>
   Per evitare tale problema, è necessario verificare regolarmente la quantità di dati scritti negli ODS. Se la quantità è compresa tra 30% e 50% della capacità di un gruppo di OSD specificato da un determinato set di regole, è necessario pesare di nuovo gli OSD. Verificare la presenta di dischi individuali e scoprire quali si riempiono più velocemente degli altri (o generalmente sono più lenti) e ridurne il peso. La stessa cosa vale per gli OSD in cui la quantità di dati scritti è insufficiente: è possibile aumentarne il peso in modo che Ceph scriva in essi una quantità maggiore di dati. Nell'esempio seguente, si individuerà il peso di un OSD con ID 13, che verrà modificato da 3 a 3,05:
  </para>

<screen>$ ceph osd tree | grep osd.13
 13  3                   osd.13  up  1

 $ ceph osd crush reweight osd.13 3.05
 reweighted item id 13 name 'osd.13' to 3.05 in crush map

 $ ceph osd tree | grep osd.13
 13  3.05                osd.13  up  1</screen>

  <para/>

  <tip>
   <title>nuovo peso dell'OSD in base all'utilizzo</title>
   <para>
    Il comando <command>ceph osd reweight-by-utilization</command>
    <replaceable>threshold</replaceable> consente di automatizzare il processo di riduzione del peso degli OSD utilizzati eccessivamente. Per default i pesi saranno arrotondati per difetto negli OSD che raggiungono il 120% di utilizzo medio, ma se si include la soglia verrà utilizzata invece tale percentuale.
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="storage.tips.ceph_btrfs_subvol">
  <title>Sottovolume Btrfs per /var/lib/ceph</title>

  <para>
   Per default SUSE Linux Enterprise è installato su una partizione Btrfs. La directory <filename>/var/lib/ceph</filename> deve essere esclusa dagli snapshot e dai rollback Btrfs, soprattutto quando sul nodo è in esecuzione un MON. In DeepSea viene fornito lo strumento di esecuzione <literal>fs</literal> che è in grado di configurare un sottovolume per questo percorso.
  </para>

  <sect2 xml:id="storage.tips.ceph_btrfs_subvol.req-new">
   <title>Requisiti per una nuova installazione</title>
   <para>
    Se si configura il cluster per la prima volta, è necessario soddisfare i requisiti seguenti prima di poter utilizzare lo strumento di esecuzione DeepSea:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Salt e DeepSea sono installati correttamente e funzionano come descritto nella presente documentazione.
     </para>
    </listitem>
    <listitem>
     <para>
      <command>salt-run state.orch ceph.stage.0</command> è stato richiamato per sincronizzare tutti i moduli Salt e DeepSea nei minion.
     </para>
    </listitem>
    <listitem>
     <para>
      Ceph non è ancora installato, pertanto ceph.stage.3 non è stato ancora eseguito e <filename>/var/lib/ceph</filename> non esiste.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="storage.tips.ceph_btrfs_subvol.req-existing">
   <title>Requisiti per un'installazione esistente</title>
   <para>
    Se il cluster è già installato, è necessario soddisfare i requisiti seguenti prima di poter utilizzare lo strumento di esecuzione DeepSea:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      È stato eseguito l'upgrade a SUSE Enterprise Storage e il cluster è controllato da DeepSea.
     </para>
    </listitem>
    <listitem>
     <para>
      Il cluster Ceph è attivo e integro.
     </para>
    </listitem>
    <listitem>
     <para>
      Il processo di upgrade ha sincronizzato i moduli Salt e DeepSea in tutti i nodi minion.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="storage.tips.ceph_btrfs_subvol.automatic">
   <title>Installazione automatica</title>
   <procedure>
    <step>
     <para>
      Su Salt Master eseguire:
     </para>
<screen><prompt>root@master # </prompt><command>salt-run</command> state.orch ceph.migrate.subvolume</screen>
     <para>
      Nei nodi senza una directory <filename>/var/lib/ceph</filename> esistente, in un nodo alla volta sarà possibile:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        Creare <filename>/var/lib/ceph</filename> come sottovolume Btrfs <literal>@/var/lib/ceph</literal>.
       </para>
      </listitem>
      <listitem>
       <para>
        Montare il nuovo sottovolume e aggiornare <filename>/etc/fstab</filename> in modo appropriato.
       </para>
      </listitem>
      <listitem>
       <para>
        Disabilitare la copia su scrittura per <filename>/var/lib/ceph</filename>.
       </para>
      </listitem>
     </itemizedlist>
     <para>
      Nei nodi con un'installazione Ceph esistente, in un nodo alla volta sarà possibile:
     </para>
     <itemizedlist>
      <listitem>
       <para>
        Terminare l'esecuzione dei processi Ceph.
       </para>
      </listitem>
      <listitem>
       <para>
        Smontare gli OSD sul nodo.
       </para>
      </listitem>
      <listitem>
       <para>
        Creare il sottovolume Btrfs <literal>@/var/lib/ceph</literal> ed eseguire la migrazione dei dati <filename>/var/lib/ceph</filename> esistenti.
       </para>
      </listitem>
      <listitem>
       <para>
        Montare il nuovo sottovolume e aggiornare <filename>/etc/fstab</filename> in modo appropriato.
       </para>
      </listitem>
      <listitem>
       <para>
        Disabilitare la copia su scrittura per <filename>/var/lib/ceph/*</filename>, omettendo <filename>/var/lib/ceph/osd/*</filename>.
       </para>
      </listitem>
      <listitem>
       <para>
        Montare di nuovo gli OSD.
       </para>
      </listitem>
      <listitem>
       <para>
        Riavviare i daemon Ceph.
       </para>
      </listitem>
     </itemizedlist>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="storage.tips.ceph_btrfs_subvol.manually">
   <title>Installazione manuale</title>
   <para>
    Per questa installazione viene utilizzato il nuovo strumento di esecuzione <literal>fs</literal>.
   </para>
   <procedure>
    <step>
     <para>
      Esaminare lo stato di <filename>/var/lib/ceph</filename> su tutti i nodi e stampare i suggerimenti su come procedere:
     </para>
<screen><prompt>root@master # </prompt><command>salt-run</command> fs.inspect_var</screen>
     <para>
      In tal modo verrà restituito uno dei seguenti comandi:
     </para>
<screen>salt-run fs.create_var
salt-run fs.migrate_var
salt-run fs.correct_var_attrs</screen>
    </step>
    <step>
     <para>
      Eseguire il comando restituito al passaggio precedente.
     </para>
     <para>
      Se si verifica un errore su uno dei nodi, verrà interrotta anche l'esecuzione per tutto gli altri nodi e lo strumento di esecuzione tenterà di ripristinare le modifiche apportate. Consultare i file di log sui minion problematici per determinare la natura del problema. È possibile eseguire di nuovo lo strumento di esecuzione una volta risolto il problema.
     </para>
    </step>
   </procedure>
   <para>
    Il comando <command>salt-run fs.help</command> fornisce un elenco di tutti i comandi dello strumento di esecuzione e del modulo per il modulo <literal>fs</literal>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="storage.bp.srv_maint.fds_inc">
  <title>Aumento dei descrittori di file</title>

  <para>
   Per i daemon OSD, le operazioni di lettura/scrittura sono critiche per mantenere bilanciato il cluster Ceph. Spesso sono richiesti numerosi file aperti per eseguire operazioni di lettura e scrittura contemporaneamente. A livello di sistema operativo, il numero massimo di file aperti simultaneamente è denominato "numero massimo di descrittori di file".
  </para>

  <para>
   Per impedire che gli OSD esauriscano i descrittori di file, è possibile ignorare il valore di default del sistema operativo e specificare il numero in <filename>/etc/ceph/ceph.conf</filename>, ad esempio:
  </para>

<screen>max_open_files = 131072</screen>

  <para>
   Dopo che si modifica <option>max_open_files</option>, è necessario riavviare il servizio OSD sul nodo Ceph pertinente.
  </para>
 </sect1>
 <sect1 xml:id="bp.osd_on_exisitng_partitions">
  <title>Come utilizzare partizioni esistenti per gli OSD, tra cui i journal OSD</title>

  <important>
   <para>
    In questa sezione è descritto un argomento avanzato riservato solo agli esperti di memorizzazione e agli sviluppatori. Si tratta di una procedura necessaria soprattutto quando si utilizzano dimensioni del journal ODS non standard. Se le dimensioni della partizione OSD sono inferiori a 10 GB, il rispettivo peso iniziale viene arrotondato a 0 e poiché in essa non vengono collocati dati, è necessario aumentarne il peso. La società non si assume alcuna responsabilità per l'eventuale sovrariempimento dei journal.
   </para>
  </important>

  <para>
   Se è necessario utilizzare partizioni del disco come nodo OSD, il journal OSD e le partizioni dei dati devono essere inclusi in una tabella delle partizioni GPT.
  </para>

  <para>
   È necessario impostare i tipi di partizioni corretti nelle partizioni OSD in modo che vengano riconosciute correttamente da <systemitem>udev</systemitem> e ne venga impostata la proprietà a <literal>ceph:ceph</literal>.
  </para>

  <para>
   Ad esempio, per impostare il tipo di partizione per la partizione del journal <filename>/dev/vdb1</filename> e la partizione dei dati <filename>/dev/vdb2</filename>, eseguire quanto riportato di seguito:
  </para>

<screen>sudo sgdisk --typecode=1:45b0969e-9b03-4f30-b4c6-b4b80ceff106 /dev/vdb
sudo sgdisk --typecode=2:4fbd7e29-9d25-41b8-afd0-062c0ceff05d /dev/vdb</screen>

  <tip>
   <para>
    I tipi di tabelle delle partizioni Ceph sono elencati in <filename>/usr/lib/udev/rules.d/95-ceph-osd.rules</filename>:
   </para>
<screen>cat /usr/lib/udev/rules.d/95-ceph-osd.rules
# OSD_UUID
ACTION=="add", SUBSYSTEM=="block", \
  ENV{DEVTYPE}=="partition", \
  ENV{ID_PART_ENTRY_TYPE}=="4fbd7e29-9d25-41b8-afd0-062c0ceff05d", \
  OWNER:="ceph", GROUP:="ceph", MODE:="660", \
  RUN+="/usr/sbin/ceph-disk --log-stdout -v trigger /dev/$name"
ACTION=="change", SUBSYSTEM=="block", \
  ENV{ID_PART_ENTRY_TYPE}=="4fbd7e29-9d25-41b8-afd0-062c0ceff05d", \
  OWNER="ceph", GROUP="ceph", MODE="660"

# JOURNAL_UUID
ACTION=="add", SUBSYSTEM=="block", \
  ENV{DEVTYPE}=="partition", \
  ENV{ID_PART_ENTRY_TYPE}=="45b0969e-9b03-4f30-b4c6-b4b80ceff106", \
  OWNER:="ceph", GROUP:="ceph", MODE:="660", \
  RUN+="/usr/sbin/ceph-disk --log-stdout -v trigger /dev/$name"
ACTION=="change", SUBSYSTEM=="block", \
  ENV{ID_PART_ENTRY_TYPE}=="45b0969e-9b03-4f30-b4c6-b4b80ceff106", \
  OWNER="ceph", GROUP="ceph", MODE="660"
[...]</screen>
  </tip>
 </sect1>
 <sect1 xml:id="storage.admin.integration">
  <title>Integrazione con il software di virtualizzazione</title>

  <sect2 xml:id="storage.bp.integration.kvm">
   <title>Memorizzazione dei dischi KVM nel cluster Ceph</title>
   <para>
    È possibile creare un'immagine disco per la macchina virtuale basata su KVM, memorizzarla in un pool Ceph, convertire facoltativamente il contenuto di un'immagine esistente in tale immagine disco ed eseguire quindi la macchina virtuale con <command>qemu-kvm</command> utilizzando l'immagine disco memorizzata nel cluster. Per informazioni dettagliate, vedere <xref linkend="cha.ceph.kvm"/>.
   </para>
  </sect2>

  <sect2 xml:id="storage.bp.integration.libvirt">
   <title>Memorizzazione dei dischi <systemitem class="library">libvirt</systemitem> nel cluster Ceph</title>
   <para>
    Analogamente a KVM (vedere <xref linkend="storage.bp.integration.kvm"/>), è possibile utilizzare Ceph per memorizzare macchine virtuali basate su <systemitem class="library">libvirt</systemitem>. Il vantaggio è dato dalla possibilità di eseguire qualsiasi soluzione di virtualizzazione supportata da <systemitem class="library">libvirt</systemitem>, come KVM, Xen o LXC. Per ulteriori informazioni, consultare <xref linkend="cha.ceph.libvirt"/>.
   </para>
  </sect2>

  <sect2 xml:id="storage.bp.integration.xen">
   <title>Memorizzazione dei dischi Xen nel cluster Ceph</title>
   <para>
    Un modo per utilizzare Ceph per memorizzare i dischi Xen consiste nell'utilizzare <systemitem class="library">libvirt</systemitem> come descritto in <xref linkend="cha.ceph.libvirt"/>.
   </para>
   <para>
    Un'altra opzione è di fare in modo che Xen comunichi direttamente con il driver del dispositivo di blocco <systemitem>rbd</systemitem>:
   </para>
   <procedure>
    <step>
     <para>
      Se non si dispone di alcuna immagine disco preparata per Xen, crearne una nuova:
     </para>
<screen>rbd create myimage --size 8000 --pool mypool</screen>
    </step>
    <step>
     <para>
      Elencare le immagini nel pool <literal>mypool</literal> e verificare la presenza dell'immagine nuova al suo interno:
     </para>
<screen>rbd list mypool</screen>
    </step>
    <step>
     <para>
      Creare un nuovo dispositivo di blocco mappando <literal>myimage</literal> al modulo kernel <systemitem>rbd</systemitem>:
     </para>
<screen>sudo rbd map --pool mypool myimage</screen>
     <tip>
      <title>nome e autenticazione utente</title>
      <para>
       Per specificare un nome utente, utilizzare <option>--id <replaceable>user-name</replaceable></option>. Inoltre, se si utilizza l'autenticazione <systemitem>cephx</systemitem>, è necessario specificare anche un segreto. Quest'ultimo potrebbe essere ricavato da un portachiavi o da un file contenente il segreto:
      </para>
<screen>sudo rbd map --pool rbd myimage --id admin --keyring /path/to/keyring</screen>
      <para>
       oppure
      </para>
<screen>sudo rbd map --pool rbd myimage --id admin --keyfile /path/to/file</screen>
     </tip>
    </step>
    <step>
     <para>
      Elencare tutti i dispositivi mappati:
     </para>
<screen><command>rbd showmapped</command>
 id pool   image   snap device
 0  mypool myimage -    /dev/rbd0</screen>
    </step>
    <step>
     <para>
      Adesso è possibile configurare Xen per l'uso del dispositivo come disco per eseguire una macchina virtuale. Ad esempio, è possibile aggiungere la riga seguente al file di configurazione del dominio di stile <command>xl</command>:
     </para>
<screen>disk = [ '/dev/rbd0,,sda', '/dev/cdrom,,sdc,cdrom' ]</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="storage.bp.net.firewall">
  <title>Impostazioni firewall per Ceph</title>

  <warning>
   <title>le fasi DeepSea si concludono con esito negativo con il firewall</title>
   <para>
    Le fasi di distribuzione DeepSea si concludono con esito negativo quando il firewall è attivo (e anche configurato). Per superare le fasi correttamente, è necessario disattivare il firewall eseguendo
   </para>
<screen>
<prompt>root@master # </prompt>systemctl stop SuSEfirewall2.service
</screen>
   <para>
    o impostare l'opzione <option>FAIL_ON_WARNING</option> su "False" in <filename>/srv/pillar/ceph/stack/global.yml</filename>:
   </para>
<screen>
FAIL_ON_WARNING: False
</screen>
  </warning>

  <para>
   Si consiglia di proteggere le comunicazioni del cluster di rete con SUSE Firewall. È possibile modificarne la configurazione selezionando <menuchoice><guimenu>YaST</guimenu><guimenu>Security and Users (Sicurezza e utenti)</guimenu><guimenu>Firewall</guimenu><guimenu>Allowed Services (Servizi consentiti)</guimenu></menuchoice>.
  </para>

  <para>
   Di seguito è riportato un elenco di servizi correlati a Ceph e dei numeri di porte normalmente utilizzati da tali servizi:
  </para>

  <variablelist>
   <varlistentry>
    <term>Ceph Monitor</term>
    <listitem>
     <para>
      Abilitare il servizio <guimenu>Ceph MON</guimenu> o la porta 6789 (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Ceph OSD o Metadata Server</term>
    <listitem>
     <para>
      Abilitare il servizio <guimenu>Ceph OSD/MDS</guimenu> o le porte 6800-7300 (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>iSCSI Gateway</term>
    <listitem>
     <para>
      Aprire la porta 3260 (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Object Gateway</term>
    <listitem>
     <para>
      Aprire la porta di comunicazione di Object Gateway. È impostato in <filename>/etc/ceph.conf</filename> alla riga che inizia con <literal>rgw frontends =</literal>. Il valore di default è 80 per HTTP e 443 per HTTPS (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NFS Ganesha</term>
    <listitem>
     <para>
      Per default, NFS Ganesha utilizza le porte 2049 (servizio NFS, TCP) e 875 (supporto rquota, TCP). Fare rifermento a <xref linkend="ganesha.nfsport"/> per ulteriori informazioni su come modificare le porte NFS Ganesha di default.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Servizi basati su Apache, come openATTIC, SMT o SUSE Manager</term>
    <listitem>
     <para>
      Aprire le porte 80 per HTTP e 443 per HTTPS (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>SSH</term>
    <listitem>
     <para>
      Aprire la porta 22 (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NTP</term>
    <listitem>
     <para>
      Aprire la porta 123 (UDP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Salt</term>
    <listitem>
     <para>
      Aprire le porte 4505 e 4506 (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Grafana</term>
    <listitem>
     <para>
      Aprire la porta 3000 (TCP).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Prometheus</term>
    <listitem>
     <para>
      Aprire la porta 9100 (TCP).
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="storage.bp.network_test">
  <title>Test delle prestazioni della rete</title>

  <para>
   Per testare le prestazioni della rete, nello strumento di esecuzione DeepSea <literal>net</literal> sono disponibili i seguenti comandi.
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Ping semplice a tutti i nodi:
    </para>
<screen><prompt>root@master # </prompt><command>salt-run</command> net.ping
Succeeded: 9 addresses from 9 minions average rtt 1.35 ms</screen>
   </listitem>
   <listitem>
    <para>
     Ping enorme a tutti i nodi:
    </para>
<screen><prompt>root@master # </prompt><command>salt-run</command> net.jumbo_ping
Succeeded: 9 addresses from 9 minions average rtt 2.13 ms</screen>
   </listitem>
   <listitem>
    <para>
     Test della larghezza di banda:
    </para>
<screen><prompt>root@master # </prompt><command>salt-run</command> net.iperf
Fastest 2 hosts:
    |_
      - 192.168.58.106
      - 2981 Mbits/sec
    |_
      - 192.168.58.107
      - 2967 Mbits/sec
Slowest 2 hosts:
    |_
      - 192.168.58.102
      - 2857 Mbits/sec
    |_
      - 192.168.58.103
      - 2842 Mbits/sec</screen>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="storage.bd.replacing_disk">
  <title>Sostituzione del disco di memorizzazione</title>

  <para>
   Se è necessario sostituire un disco di memorizzazione in un cluster Ceph, è possibile farlo durante il pieno funzionamento del cluster. La sostituzione causerà un aumento temporaneo nel trasferimento dei dati.
  </para>

  <para>
   Se il disco risulta completamente impossibile da eseguire, Ceph deve riscrivere almeno la stessa quantità di dati della capacità del disco in errore. Se il disco viene rimosso e quindi aggiunto di nuovo per evitare la ridondanza durante il processo, la quantità di dati riscritti raddoppierà. Se le dimensioni del disco nuovo sono diverse da quello sostituito, alcuni dati aggiuntivi verranno ridistribuiti per livellare l'utilizzo di tutti gli OSD.
  </para>
 </sect1>
</chapter>
