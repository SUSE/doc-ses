<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="lvmcache.xml" version="5.0" xml:id="lvmcache">

 <title>Miglioramento delle prestazioni con la cache LVM</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modifica</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>sì</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <warning>
  <title>tecnologia in anteprima</title>
  <para>
   La cache LVM è attualmente una tecnologia in anteprima.
  </para>
 </warning>
 <para>
  Si tratta di un meccanismo di memorizzazione nella cache utilizzato per il miglioramento delle prestazioni di un volume logico (LV). Per migliorare le prestazioni I/O di un volume logico più grande e lento, di solito viene utilizzato un dispositivo più piccolo e rapido. Fare riferimento alla relativa documentazione (<command>man 7 lvmcache</command>) per ulteriori dettagli sulla cache LVM.
 </para>
 <para>
  In SUSE Enterprise Storage, la cache LVM può migliorare le prestazioni degli OSD. Il relativo supporto è fornito dal plug-in <command>ceph-volume</command>. Per informazioni dettagliate sul suo utilizzo, eseguire <command>ceph-volume lvmcache</command>.
 </para>
 <sect1 xml:id="lvmcache-prerequisites">
  <title>Prerequisiti</title>

  <para>
   Per utilizzare le funzioni della cache LVM per il miglioramento delle prestazioni di un cluster Ceph, è necessario disporre di:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Un cluster Ceph in esecuzione in uno stato stabile ("HEALTH_OK").
    </para>
   </listitem>
   <listitem>
    <para>
     OSD distribuiti con BlueStore e LVM. Questa è l'opzione di default se gli OSD sono stati distribuiti con SUSE Enterprise Storage 6 o versioni successive.
    </para>
   </listitem>
   <listitem>
    <para>
     Dischi o partizioni vuoti da utilizzare per la memorizzazione nella cache.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="lvmcache-planning">
  <title>Aspetti da considerare</title>

  <para>
   Prendere in considerazione gli aspetti seguenti prima di configurare gli OSD per l'utilizzo della cache LVM:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <emphasis role="bold">Verificare che la cache LVM sia adatta al proprio caso d'uso.</emphasis> Come regola generale, se sono disponibili soltanto alcune unità rapide che <emphasis role="bold">non</emphasis> sono utilizzate per gli OSD, si consiglia di utilizzarle come dispositivi WAL/DB per gli OSD. In questo caso, le operazioni WAL e DB (brevi e poco frequenti) vengono applicate all'unità rapida, mentre le operazioni sui dati vengono applicate all'unità OSD più lenta.
    </para>
    <tip>
     <para>
      Se nella distribuzione attiva la latenza è più importante delle operazioni IOPS o della velocità effettiva, è possibile utilizzare le unità rapide come cache LVM al posto delle partizioni WAL/DB.
     </para>
    </tip>
   </listitem>
   <listitem>
    <para>
     Se si pianifica di utilizzare un'unità rapida come cache LVM per più OSD, tenere presente che <emphasis role="bold">tutte le operazioni degli OSD (inclusa la replica) passeranno attraverso il dispositivo di memorizzazione nella cache</emphasis>. Tutte le operazioni di lettura vengono interrogate dal dispositivo di memorizzazione nella cache e sono soddisfatte dal dispositivo più lento solo in caso di un mancato riscontro nella cache. Le operazioni di scrittura vengono sempre applicate innanzitutto al dispositivo di memorizzazione nella cache e quindi svuotate in un secondo momento nel dispositivo più lento (la modalità di memorizzazione nella cache di default è la modalità "writeback").
    </para>
    <para>
     Per decidere se è opportuno utilizzare una cache LVM, verificare se l'unità rapida è in grado di fungere da elemento anteriore di più OSD e fornire al contempo una quantità accettabile di IOPS. È possibile testare questa capacità misurando la quantità massima di IOPS a cui il dispositivo rapido è in grado di provvedere e dividere il risultato per il numero di OSD posteriori a tale dispositivo. Se il risultato è inferiore o vicino alla quantità massima di IOPS che l'OSD può fornire senza la cache, probabilmente non è opportuno utilizzare la cache LVM per la configurazione attuale.
    </para>
   </listitem>
   <listitem>
    <para>
     <emphasis role="bold">L'interazione del dispositivo della cache LVM con gli OSD è un fattore importante.</emphasis> Le operazioni di scrittura vengono svuotate periodicamente dal dispositivo di memorizzazione nella cache nel dispositivo lento. Se il traffico in entrata è sostenuto ed elevato, il dispositivo di memorizzazione nella cache avrà difficoltà a restare al passo con le richieste in entrata e con il processo di svuotamento, causando un calo delle prestazioni. Nel caso di workload con un volume costantemente elevato, non utilizzare la cache LVM a meno che il dispositivo rapido non sia in grado di fornire un numero molto più elevato di IOPS a una latenza migliore rispetto al dispositivo lento. Il traffico che segue un modello burst è invece molto più adeguato per la cache LVM, poiché le consente di svuotare i dati modificati senza interferire con il traffico del client. Nel caso di workload prolungati con un traffico costantemente ridotto, è difficile sapere in anticipo se l'utilizzo della cache LVM migliorerebbe le prestazioni. Per farsi un'idea, eseguire un benchmark e un confronto tra la configurazione della cache LVM e quella del WAL/DB. Inoltre, dal momento che le operazioni di scrittura di piccole dimensioni gravano significativamente sulla partizione WAL, si suggerisce di utilizzare il dispositivo rapido per il DB e/o WAL al posto della cache LVM.
    </para>
   </listitem>
   <listitem>
    <para>
     Se non si ha la certezza che la cache LVM sia la scelta giusta, utilizzare il dispositivo rapido come dispositivo WAL e/o DB.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="lvmcache-preparation">
  <title>Preparazione</title>

  <para>
   È necessario suddividere il dispositivo rapido in più partizioni. Ogni OSD necessita di due partizioni per la relativa cache: una per i dati e una per i metadati della cache. Le dimensioni minime di entrambe le partizioni sono 2 GB. È possibile utilizzare un solo dispositivo rapido per memorizzare nella cache più OSD. Basta semplicemente suddividerlo in partizioni di conseguenza.
  </para>
 </sect1>
 <sect1 xml:id="lvmcache-configuring">
  <title>Configurazione della cache LVM</title>

  <para>
   Per informazioni dettagliate sull'aggiunta, sulla rimozione e sulla configurazione della cache LVM, eseguire il comando <command>ceph-volume lvmcache</command>.
  </para>

  <sect2 xml:id="lvmcache-adding">
   <title>Aggiunta della cache LVM</title>
   <para>
    Per aggiungere la cache LVM a un OSD esistente, utilizzare il comando seguente:
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache add
 --cachemetadata <replaceable>METADATA-PARTITION</replaceable>
 --cachedata <replaceable>DATA-PARTITION</replaceable>
 --osd-id <replaceable>OSD-ID</replaceable>
</screen>
   <para>
    L'impostazione facoltativa <option>--data</option>, <option>--db</option> o <option>--wal</option> consente di specificare la partizione da memorizzare nella cache. L'impostazione di default è <option>--data</option>.
   </para>
   <tip>
    <title>specifica del volume logico (LV)</title>
    <para>
     In alternativa, è possibile utilizzare l'opzione <option>--origin</option> al posto di <option>--osd-id</option> per specificare il volume logico da memorizzare nella cache:
    </para>
<screen>
[...]
--origin <replaceable>VOLUME-GROUP</replaceable>/<replaceable>LOGICAL-VOLUME</replaceable>
</screen>
   </tip>
  </sect2>

  <sect2 xml:id="lvmcache-removing">
   <title>Rimozione della cache LVM</title>
   <para>
    Per rimuovere una cache LVM esistente da un OSD, utilizzare il comando seguente:
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache rm --osd-id <replaceable>OSD-ID</replaceable>
</screen>
  </sect2>

  <sect2 xml:id="lvmcache-mode">
   <title>Impostazione della modalità della cache LVM</title>
   <para>
    Per specificare la modalità di memorizzazione nella cache, utilizzare il comando seguente:
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache mode --set <replaceable>CACHING-MODE</replaceable> --osd-id <replaceable>OSD-ID</replaceable>
</screen>
   <para>
    <replaceable>CACHING-MODE</replaceable> può essere "writeback" (default) o "writethrough"
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="lvmcache-failures">
  <title>Gestione degli errori</title>

  <para>
   In caso di errori del dispositivo di memorizzazione nella cache, è necessario rimuovere tutti gli OSD posteriori a tale dispositivo dal cluster (vedere la <xref linkend="salt-removing-osd"/>), eliminarli definitivamente e ridistribuirli. In caso di errori dell'unità OSD, il volume logico dell'OSD e quello della relativa cache saranno attivi ma non funzionanti. Utilizzare <command>pvremove <replaceable>PARTITION</replaceable></command> per eliminare definitivamente le partizioni (volumi fisici) utilizzate per le partizioni dei metadati e dei dati di cache dell'OSD. Il comando <command>pvs</command> consente di visualizzare un elenco di tutti i volumi fisici.
  </para>
 </sect1>
 <sect1 xml:id="lvmcache-faq">
  <title>Domande frequenti</title>

  <qandaset>
   <qandaentry>
    <question>
     <para>
      Cosa succede se un OSD viene rimosso?
     </para>
    </question>
    <answer>
     <para>
      Se si rimuove il volume logico dell'OSD tramite il comando <command>lvremove</command>, verranno rimossi anche i volumi logici della cache. Tuttavia, sarà comunque necessario richiamare <command>pvremove</command> nelle partizioni per assicurarsi che tutte le etichette siano state eliminate.
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      Cosa succede se l'OSD viene cancellato con <command>ceph-volume zap</command>?
     </para>
    </question>
    <answer>
     <para>
      Vale la stessa risposta alla domanda <emphasis role="bold">Cosa succede se un OSD viene rimosso?</emphasis>
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      Cosa succede se si verificano errori nell'unità di origine?
     </para>
    </question>
    <answer>
     <para>
      I volumi logici continuano a esistere e a risultare come disponibili in <command>cache info</command>. Dal momento che il dispositivo del volume logico di origine non esiste più, LVM non riuscirà a svuotare la cache e pertanto non sarà possibile rimuoverla. In questa situazione, esiste il volume logico, ma non il relativo dispositivo di supporto. È possibile correggere il problema con il comando <command>pvs</command>, individuare i dispositivi associati al volume logico di origine e rimuoverli con
     </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>sudo pvremove /dev/<replaceable>DEVICE</replaceable> or <replaceable>PARTITION</replaceable>
</screen>
     <para>
      Per le partizioni della cache si applica la stessa procedura, tramite cui è possibile rimuovere il volume logico di origine e quello della cache. È inoltre possibile utilizzare
     </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>sudo dd if=/dev/zero of=/dev/<replaceable>DEVICE</replaceable> or <replaceable>PARTITION</replaceable>
</screen>
     <para>
      per cancellarli prima di utilizzare <command>pvremove</command>.
     </para>
    </answer>
   </qandaentry>
  </qandaset>
 </sect1>
</chapter>
