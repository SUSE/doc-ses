<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_kvm.xml" version="5.0" xml:id="cha-ceph-kvm">
 <title>Ceph como back end para instância de KVM QEMU</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>editando</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes (sim)</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  O caso de uso mais frequente do Ceph envolve fornecer imagens de dispositivos de blocos para máquinas virtuais. Por exemplo, um usuário pode criar uma imagem “perfeita” com um OS e qualquer software relevante em uma configuração ideal. Em seguida, ele captura um instantâneo da imagem. Por fim, ele clona o instantâneo (normalmente, várias vezes. Consulte a <xref linkend="cha-ceph-snapshots-rbd"/> para obter detalhes). A capacidade de criar clones de cópia em gravação de um instantâneo significa que o Ceph pode provisionar imagens de dispositivos de blocos para máquinas virtuais rapidamente, pois o cliente não precisa fazer download de uma imagem inteira cada vez que capturar uma nova máquina virtual.
 </para>
 <para>
  Os dispositivos de blocos do Ceph podem ser integrados às máquinas virtuais QEMU. Para obter mais informações sobre a KVM QEMU, consulte <link xlink:href="https://www.suse.com/documentation/sles-15/book_virt/data/part_virt_qemu.html"/>.
 </para>
 <sect1 xml:id="ceph-kvm-install">
  <title>Instalação</title>

  <para>
   Para usar os dispositivos de blocos do Ceph, o QEMU precisa ter o driver apropriado instalado. Verifique se o pacote <systemitem>qemu-bloco-rbd</systemitem> está instalado (instale-o se necessário):
  </para>

<screen><prompt>root # </prompt>zypper install qemu-block-rbd</screen>
 </sect1>
 <sect1 xml:id="ceph-kvm-usage">
  <title>Uso</title>

  <para>
   A linha de comando do QEMU espera você especificar o nome do pool e da imagem. Você também pode especificar o nome de um instantâneo.
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable><replaceable>:option1=value1</replaceable><replaceable>:option2=value2...</replaceable></screen>

  <para>
   Por exemplo, se você especificar as opções <replaceable>id</replaceable> e <replaceable>conf</replaceable>, a aparência deverá ser a seguinte:
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable>:<option>id=glance:conf=/etc/ceph/ceph.conf</option></screen>
 </sect1>
 <sect1>
  <title>Criando imagens com o QEMU</title>

  <para>
   Você pode criar uma imagem de dispositivo de blocos no QEMU. Você deve especificar <literal>rbd</literal>, o nome do pool e o nome da imagem que deseja criar. Você também deve especificar o tamanho da imagem.
  </para>

<screen>qemu-img create -f raw rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Por exemplo:
  </para>

<screen>qemu-img create -f raw rbd:pool1/image1 10G
Formatting 'rbd:pool1/image1', fmt=raw size=10737418240 nocow=off cluster_size=0</screen>

  <important>
   <para>
    O formato de dados <literal>brutos</literal> é realmente a única opção de formato sensível para usar com o RBD. Tecnicamente, você pode usar outros formatos compatíveis com o QEMU, como <literal>qcow2</literal>, mas isso aumentará o overhead e também tornará o volume não seguro para migração dinâmica da máquina virtual quando o cache estiver habilitado.
   </para>
  </important>
 </sect1>
 <sect1>
  <title>Redimensionando imagens com o QEMU</title>

  <para>
   É possível redimensionar uma imagem de dispositivo de blocos usando o QEMU. Você deve especificar <literal>rbd</literal>, o nome do pool e o nome da imagem que deseja redimensionar. Você também deve especificar o tamanho da imagem.
  </para>

<screen>qemu-img resize rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Por exemplo:
  </para>

<screen>qemu-img resize rbd:pool1/image1 9G
Image resized.</screen>
 </sect1>
 <sect1>
  <title>Recuperando informações da imagem com o QEMU</title>

  <para>
   Você pode recuperar informações da imagem do dispositivo de blocos usando o QEMU. Você deve especificar <literal>rbd</literal>, o nome do pool e o nome da imagem.
  </para>

<screen>qemu-img info rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>

  <para>
   Por exemplo:
  </para>

<screen>qemu-img info rbd:pool1/image1
image: rbd:pool1/image1
file format: raw
virtual size: 9.0G (9663676416 bytes)
disk size: unavailable
cluster_size: 4194304</screen>
 </sect1>
 <sect1>
  <title>Executando o QEMU com o RBD</title>

  <para>
   O QEMU pode acessar uma imagem como dispositivo de blocos virtual diretamente pelo <systemitem>librbd</systemitem>. Isso evita um switch de contexto adicional e pode ser melhor do que o cache do RBD.
  </para>

  <para>
   Você pode usar <command>qemu-img</command> para converter as imagens existentes de máquinas virtuais em imagens de dispositivos de blocos do Ceph. Por exemplo, se você tem uma imagem qcow2, pode executar:
  </para>

<screen>qemu-img convert -f qcow2 -O raw sles12.qcow2 rbd:pool1/sles12</screen>

  <para>
   Para executar uma inicialização de máquina virtual dessa imagem, você pode executar:
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12</screen>

  <para>
   O cache do RBD pode melhorar o desempenho significativamente. As opções de cache do QEMU controlam o cache do <systemitem>librbd</systemitem>:
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=rbd,file=rbd:pool1/sles12,cache=writeback</screen>

  <para>
   Para obter mais informações sobre cache do RBD, consulte a <xref linkend="rbd-cache-settings"/>.
  </para>
 </sect1>
 <sect1>
  <title>Habilitando descarte/TRIM</title>

  <para>
   Os dispositivos de blocos do Ceph suportam a operação de descarte. Isso significa que um convidado pode enviar solicitações TRIM para permitir que um dispositivo de blocos do Ceph reaproveite o espaço não usado. Para habilitar esse recurso, monte o <systemitem>XFS</systemitem> com a opção de descarte.
  </para>

  <para>
   Para que ele fique disponível ao convidado, é necessário habilitá-lo explicitamente no dispositivo de blocos. Para fazer isso, você deve especificar <option>discard_granularity</option> associado à unidade:
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12,id=drive1,if=none \
-device driver=ide-hd,drive=drive1,discard_granularity=512</screen>

  <note>
   <para>
    O exemplo acima usa o driver IDE. O driver virtio não suporta descarte.
   </para>
  </note>

  <para>
   Se for usar o <systemitem>libvirt</systemitem>, edite o arquivo de configuração do domínio libvirt usando <command>virsh edit</command> para incluir o valor <literal>xmlns:qemu</literal>. Em seguida, adicione <literal>qemu:commandline block</literal> como filho desse domínio. O exemplo a seguir mostra como definir dois dispositivos com <literal>qemu id=</literal> com valores <literal>discard_granularity</literal> diferentes.
  </para>

<screen>
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
 &lt;qemu:commandline&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-0.discard_granularity=4096'/&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-1.discard_granularity=65536'/&gt;
 &lt;/qemu:commandline&gt;
&lt;/domain&gt;</screen>
 </sect1>
 <sect1>
  <title>Opções de cache do QEMU</title>

  <para>
   As opções de cache do QEMU correspondem às seguintes configurações de Cache do Ceph RBD.
  </para>

  <para>
   Writeback:
  </para>

<screen>rbd_cache = true</screen>

  <para>
   Writethrough:
  </para>

<screen>rbd_cache = true
rbd_cache_max_dirty = 0</screen>

  <para>
   Nenhuma:
  </para>

<screen>rbd_cache = false</screen>

  <para>
   As configurações de cache do QEMU anulam as configurações padrão do Ceph (configurações que não são explicitamente definidas no arquivo de configuração do Ceph). Se você definir explicitamente as configurações de Cache do RBD no arquivo de configuração do Ceph (consulte a <xref linkend="rbd-cache-settings"/>), as configurações do Ceph anularão as configurações de cache do QEMU. Se você definir as configurações de cache na linha de comando do QEMU, elas anularão as configurações do arquivo de configuração do Ceph.
  </para>
 </sect1>
</chapter>
