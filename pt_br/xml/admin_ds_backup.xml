<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Fazendo backup da configuração e dos dados do cluster</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>editando</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes (sim)</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Este capítulo explica quais partes do cluster do Ceph devem ser incluídas no backup para que seja possível restaurar a funcionalidade dele.
 </para>
 <sect1 xml:id="backup-ceph">
  <title>Fazendo backup da configuração do Ceph</title>

  <para>
   Faça backup do diretório <filename>/etc/ceph</filename>. Ele inclui a configuração essencial do cluster. Você precisará fazer backup do <filename>/etc/ceph</filename>, por exemplo, quando for necessário substituir o Nó de Admin.
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-salt">
  <title>Fazendo backup da configuração do Salt</title>

  <para>
   Você precisa fazer backup do diretório <filename>/etc/salt/</filename>. Ele contém os arquivos de configuração do Salt. Por exemplo, a chave master do Salt e as chaves aceitas do cliente.
  </para>

  <para>
   Os arquivos do Salt não são estritamente necessários para fazer backup do Nó de Admin, mas facilitam a reimplantação do cluster do Salt. Se não houver nenhum backup desses arquivos, os minions Salt precisarão ser registrados novamente no novo Nó de Admin.
  </para>

  <note>
   <title>Segurança da chave privada master do Salt</title>
   <para>
    Garanta que o backup da chave privada master do Salt esteja armazenado em um local seguro. A chave master do Salt pode ser usada para manipular todos os nós do cluster.
   </para>
  </note>

  <para>
   Após a restauração do diretório <filename>/etc/salt</filename> de um backup, reinicie os serviços Salt:
  </para>

<screen><prompt>root@master # </prompt><command>systemctl</command> restart salt-master
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion</screen>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-deepsea">
  <title>Fazendo backup da configuração do DeepSea</title>

  <para>
   Todos os arquivos necessários ao DeepSea são armazenados em <filename>/srv/pillar/</filename>, <filename>/srv/salt/</filename> e <filename>/etc/salt/master.d</filename>.
  </para>

  <para>
   Se você precisar reimplantar o Nó de Admin, instale o pacote do DeepSea no novo nó e mova os dados dos quais foi feito o backup de volta aos diretórios. Em seguida, o DeepSea poderá ser usado novamente sem a necessidade de outras modificações. Antes de usar o DeepSea de novo, verifique se todos os minions Salt estão registrados corretamente no Nó de Admin.
  </para>
 </sect1>
 <sect1 xml:id="backup-config-files">
  <title>Configurações personalizadas de backup</title>

  <itemizedlist>
   <listitem>
    <para>
     Dados e personalização do Prometheus.
    </para>
   </listitem>
   <listitem>
    <para>
     Personalização do Grafana.
    </para>
   </listitem>
   <listitem>
    <para>
     Verifique se você tem um registro de usuários existentes do openATTIC para que possa criar novas contas para esses usuários no Ceph Dashboard.
    </para>
   </listitem>
   <listitem>
    <para>
     Mudanças manuais no <filename>ceph.conf</filename> fora do DeepSea.
    </para>
   </listitem>
   <listitem>
    <para>
     Mudanças manuais na configuração do iSCSI fora do DeepSea.
    </para>
   </listitem>
   <listitem>
    <para>
     Chaves do Ceph.
    </para>
   </listitem>
   <listitem>
    <para>
     Mapa CRUSH e regras CRUSH. Execute o comando a seguir para gravar o Mapa CRUSH descompilado incluindo as regras CRUSH no <filename>crushmap-backup.txt</filename>:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
   </listitem>
   <listitem>
    <para>
     Configuração do Gateway do Samba. Se você usa um único gateway, faça backup do <filename>/etc/samba/smb.conf</filename>. Se você usa a configuração de HA, faça backup também dos arquivos de configuração CTDB e Pacemaker. Consulte o <xref linkend="cha-ses-cifs"/> para obter detalhes sobre a configuração que é usada pelos Gateways do Samba.
    </para>
   </listitem>
   <listitem>
    <para>
     Configuração do NFS Ganesha. Necessário apenas ao usar a configuração de HA. Consulte o <xref linkend="cha-ceph-nfsganesha"/> para obter detalhes sobre a configuração que é usada pelo NFS Ganesha.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
