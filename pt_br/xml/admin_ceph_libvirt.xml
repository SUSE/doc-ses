<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_libvirt.xml" version="5.0" xml:id="cha-ceph-libvirt">
 <title>Usando a <systemitem class="library">libvirt</systemitem> com o Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>editando</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes (sim)</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  A biblioteca <systemitem class="library">libvirt</systemitem> cria uma camada de abstração de máquina virtual entre as interfaces de hipervisor e os aplicativos de software que as utilizam. Com a <systemitem class="library">libvirt</systemitem>, os desenvolvedores e administradores de sistema podem se dedicar a uma estrutura comum de gerenciamento, API comum e interface de shell comum (<command>virsh</command>) com vários hipervisores diferentes, incluindo QEMU/KVM, Xen, LXC ou VirtualBox.
 </para>
 <para>
  Os dispositivos de blocos do Ceph suportam o QEMU/KVM. Você pode usá-los com um software que estabeleça interface com a <systemitem class="library">libvirt</systemitem>. A solução de nuvem usa a <systemitem class="library">libvirt</systemitem> para interagir com o QEMU/KVM, e o QEMU/KVM interage com os dispositivos de blocos do Ceph pela <systemitem>librbd</systemitem>.
 </para>
 <para>
  Para criar VMs que usam os dispositivos de blocos do Ceph, siga os procedimentos nas seções abaixo. Nos exemplos, usamos <literal>libvirt-pool</literal> para o nome do pool, <literal>client.libvirt</literal> para o nome de usuário e <literal>new-libvirt-image</literal> para o nome da imagem. Você pode usar qualquer valor desejado, mas deve substituí-los durante a execução dos comandos nos procedimentos seguintes.
 </para>
 <sect1 xml:id="ceph-libvirt-cfg-ceph">
  <title>Configurando o Ceph</title>

  <para>
   Para configurar o Ceph para uso com a <systemitem class="library">libvirt</systemitem>, execute as seguintes etapas:
  </para>

  <procedure>
   <step>
    <para>
     Crie um pool. O exemplo a seguir usa o nome do pool <literal>libvirt-pool</literal> com 128 grupos de posicionamento.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     Verifique se o pool existe.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     Crie um Usuário do Ceph. O exemplo a seguir utiliza o nome de usuário do Ceph <literal>client.libvirt</literal> e faz referência ao <literal>libvirt-pool</literal>.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth get-or-create client.libvirt mon 'profile rbd' osd \
 'profile rbd pool=libvirt-pool'</screen>
    <para>
     Verifique se o nome existe.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth list</screen>
    <note>
     <title>Nome de Usuário ou ID</title>
     <para>
      A <systemitem class="library">libvirt</systemitem> acessará o Ceph usando o ID <literal>libvirt</literal>, não o nome do Ceph <literal>client.libvirt</literal>. Consulte a <xref linkend="cephx-user"/> para ver uma explicação detalhada da diferença entre ID e nome.
     </para>
    </note>
   </step>
   <step>
    <para>
     Use o QEMU para criar uma imagem em seu pool RBD. O exemplo a seguir usa o nome da imagem <literal>new-libvirt-image</literal> e faz referência ao <literal>libvirt-pool</literal>.
    </para>
    <tip>
     <title>Local do Arquivo de Chaveiro</title>
     <para>
      A chave de usuário <systemitem class="library">libvirt</systemitem> é armazenada em um arquivo de chaveiro salvo no diretório <filename>/etc/ceph</filename>. O arquivo de chaveiro precisa ter um nome apropriado que inclua o nome do cluster do Ceph ao qual ele pertence. Para o nome do cluster padrão “ceph”, o nome do arquivo de chaveiro é <filename>/etc/ceph/ceph.client.libvirt.keyring</filename>.
     </para>
     <para>
      Se o chaveiro não existir, crie-o com:
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth get client.libvirt &gt; /etc/ceph/ceph.client.libvirt.keyring</screen>
    </tip>
<screen><prompt>root # </prompt>qemu-img create -f raw rbd:libvirt-pool/new-libvirt-image:id=libvirt 2G</screen>
    <para>
     Verifique se a imagem existe.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-virt-manager">
  <title>Preparando o gerenciador de VM</title>

  <para>
   É possível usar a <systemitem class="library">libvirt</systemitem> sem um gerenciador de VM, mas talvez você ache mais simples criar primeiro o domínio com <command>virt-manager</command>.
  </para>

  <procedure>
   <step>
    <para>
     Instale um gerenciador de máquina virtual.
    </para>
<screen><prompt>root # </prompt>zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     Prepare/faça download de uma imagem de OS do sistema que deseja virtualizar.
    </para>
   </step>
   <step>
    <para>
     Inicie o gerenciador de máquina virtual.
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-create-vm">
  <title>Criando uma VM</title>

  <para>
   Para criar uma VM com <command>virt-manager</command>, execute as seguintes etapas:
  </para>

  <procedure>
   <step>
    <para>
     Escolha a conexão na lista, clique o botão direito do mouse nela e selecione <guimenu>New</guimenu> (Novo).
    </para>
   </step>
   <step>
    <para>
     <guimenu>Importe a imagem de disco existente</guimenu> informando o caminho para o armazenamento existente. Especifique o tipo de OS, as configurações de memória e <guimenu>nomeie</guimenu> a máquina virtual. Por exemplo, <literal>libvirt-virtual-machine</literal>.
    </para>
   </step>
   <step>
    <para>
     Conclua a configuração e inicie a VM.
    </para>
   </step>
   <step>
    <para>
     Verifique se o domínio recém-criado existe com <command>sudo virsh list</command>. Se necessário, especifique a string de conexão, como
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     Efetue login na VM e pare-a antes de configurá-la para uso com o Ceph.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-cfg-vm">
  <title>Configurando a VM</title>

  <para>
   Neste capítulo, vamos nos concentrar na configuração de VMs para integração com o Ceph usando <command>virsh</command>. Geralmente, os comandos <command>virsh</command> exigem privilégios de root (<command>sudo</command>) e não retornarão os resultados apropriados nem o notificarão sobre a necessidade dos privilégios de root. Para uma referência dos comandos <command>virsh</command>, consulte <command>man 1 virsh</command> (requer o pacote <package>libvirt-client</package> instalado).

  </para>

  <procedure>
   <step>
    <para>
     Abra o arquivo de configuração com <command>virsh edit</command> <replaceable>vm-domain-name</replaceable>.
    </para>
<screen><prompt>root # </prompt>virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     Em &lt;devices&gt;, deve haver uma entrada &lt;disk&gt;.
    </para>
<screen>&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;
    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw'/&gt;
      &lt;source file='/path/to/image/recent-linux.img'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='drive' controller='0' bus='0' unit='0'/&gt;
    &lt;/disk&gt;</screen>
    <para>
     Substitua <filename>/path/to/image/recent-linux.img</filename> pelo caminho para a imagem do OS.
    </para>
    <important>
     <para>
      No lugar de um editor de texto, use <command>sudo virsh edit</command>. Se você editar o arquivo de configuração em <filename>/etc/libvirt/qemu</filename> com um editor de texto, a <systemitem class="library">libvirt</systemitem> poderá não reconhecer a mudança. Em caso de qualquer diferença entre o conteúdo do arquivo XML em <filename>/etc/libvirt/qemu</filename> e o resultado de <command>sudo virsh dumpxml</command> <replaceable>vm-domain-name</replaceable>, a VM pode não funcionar apropriadamente.
     </para>
    </important>
   </step>
   <step>
    <para>
     Adicione a imagem RBD do Ceph que você já criou como uma entrada &lt;disk&gt;.
    </para>
<screen>&lt;disk type='network' device='disk'&gt;
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'&gt;
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/&gt;
        &lt;/source&gt;
        &lt;target dev='vda' bus='virtio'/&gt;
&lt;/disk&gt;</screen>
    <para>
     Substitua <replaceable>monitor-host</replaceable> pelo nome do seu host e substitua o nome do pool e/ou da imagem, conforme necessário. Você pode adicionar várias entradas &lt;host&gt; aos Ceph Monitors. O atributo <literal>dev</literal> é o nome do dispositivo lógico que aparecerá no diretório <filename>/dev</filename> da VM. O atributo de barramento opcional indica o tipo de dispositivo de disco a ser emulado. As configurações válidas são específicas do driver (por exemplo, ide, scsi, virtio, xen, usb ou sata).
    </para>
   </step>
   <step>
    <para>
     Grave o arquivo.
    </para>
   </step>
   <step>
    <para>
     Se a autenticação estiver habilitada no cluster do Ceph (que é o padrão), você deverá gerar um segredo. Abra o editor de sua preferência e crie um arquivo chamado <filename>secret.xml</filename> com o seguinte conteúdo:
    </para>
<screen>&lt;secret ephemeral='no' private='no'&gt;
        &lt;usage type='ceph'&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;</screen>
   </step>
   <step>
    <para>
     Defina o segredo.
    </para>
<screen><prompt>root # </prompt>virsh secret-define --file secret.xml
&lt;uuid of secret is output here&gt;</screen>
   </step>
   <step>
    <para>
     Obtenha a chave <literal>client.libvirt</literal> e grave a string de chave em um arquivo.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     Defina o UUID do segredo.
    </para>
<screen><prompt>root # </prompt>virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     Você também deve definir o segredo manualmente adicionando a seguinte entrada <literal>&lt;auth&gt;</literal> ao elemento <literal>&lt;disk&gt;</literal> que você inseriu antes (substituindo o valor do uuid pelo resultado do exemplo de linha de comando acima).
    </para>
<screen><prompt>root # </prompt>virsh edit libvirt-virtual-machine</screen>
    <para>
     Em seguida, adicione o elemento <literal>&lt;auth&gt;&lt;/auth&gt;</literal> ao arquivo de configuração do domínio:
    </para>
<screen>...
&lt;/source&gt;
&lt;auth username='libvirt'&gt;
        &lt;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/&gt;
&lt;/auth&gt;
&lt;target ...</screen>
    <note>
     <para>
      O ID do exemplo é <literal>libvirt</literal>, e não o nome do Ceph <literal>client.libvirt</literal>, conforme gerado na etapa 2 da <xref linkend="ceph-libvirt-cfg-ceph"/>. Use o componente de ID do nome do Ceph que você gerou. Se, por algum motivo, você precisar gerar novamente o segredo, terá que executar <command>sudo virsh secret-undefine</command> <replaceable>uuid</replaceable> antes de executar <command>sudo virsh secret-set-value</command> outra vez.
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="ceph-libvirt-summary">
  <title>Resumo</title>

  <para>
   Após configurar a VM para uso com o Ceph, você poderá iniciá-la. Para verificar se a VM e o Ceph estão se comunicando, você pode executar os procedimentos a seguir.
  </para>

  <procedure>
   <step>
    <para>
     Verifique se o Ceph está em execução:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph health</screen>
   </step>
   <step>
    <para>
     Verifique se a VM está em execução:
    </para>
<screen><prompt>root # </prompt>virsh list</screen>
   </step>
   <step>
    <para>
     Verifique se a VM está se comunicando com o Ceph. Substitua <replaceable>vm-domain-name</replaceable> pelo nome do domínio da sua VM:
    </para>
<screen><prompt>root # </prompt>virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     Verifique se o dispositivo de <literal>&amp;target dev='hdb' bus='ide'/&gt;</literal> aparece em <filename>/dev</filename> ou em <filename>/proc/partitions</filename>:
    </para>
<screen><prompt>tux &gt; </prompt>ls /dev
<prompt>tux &gt; </prompt>cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
