<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph-operating-services">
 <title>Operando serviços do Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sim</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Você pode operar serviços do Ceph usando o <systemitem class="daemon">systemd</systemitem> ou o DeepSea.
 </para>
 <sect1 xml:id="operate-services-systemd">
  <title>Operando serviços relacionados ao cluster do Ceph por meio do <systemitem class="daemon">systemd</systemitem></title>

  <para>
   Use o comando <command>systemctl</command> para operar todos os serviços relacionados ao Ceph. A operação é realizada no nó em que você efetuou login. Você precisa ter privilégios de <systemitem class="username">root</systemitem> para operar serviços do Ceph.
  </para>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Iniciando, parando e reiniciando serviços usando destinos</title>
   <para>
    Para tornar mais simples iniciar, parar e reiniciar todos os serviços de determinado tipo (por exemplo, todos os serviços do Ceph, os MONs ou os OSDs) em um nó, o Ceph oferece os seguintes arquivos da unidade <systemitem class="daemon">systemd</systemitem>:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    Para iniciar/parar/reiniciar todos os serviços do Ceph no nó, execute:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl restart ceph.target
</screen>
   <para>
    Para iniciar/parar/reiniciar todos os OSDs no nó, execute:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target
</screen>
   <para>
    Os comandos para os outros destinos são semelhantes.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-individual">
   <title>Iniciando, parando e reiniciando serviços individuais</title>
   <para>
    Você pode operar serviços individuais usando os seguintes arquivos parametrizados da unidade <systemitem class="daemon">systemd</systemitem>:
   </para>
<screen>
ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-mgr@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service
</screen>
   <para>
    Para usar esses comandos, primeiro você precisa identificar o nome do serviço que deseja operar. Consulte a <xref linkend="ceph-operating-services-finding-names"/> para saber mais sobre a identificação de serviços.
   </para>
   <para>
    Para iniciar/parar/reiniciar o serviço <literal>osd.1</literal>, execute:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service
</screen>
   <para>
    Os comandos para os outros tipos de serviço são semelhantes.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identificando serviços individuais</title>
   <para>
    Você pode descobrir nomes/números de um determinado tipo de serviço de várias maneiras. Os seguintes comandos apresentam resultados para os serviços do <literal>ceph*</literal>. Você pode executá-los em qualquer nó do cluster do Ceph.
   </para>
   <para>
    Para listar todos os serviços (até os inativos) do tipo <literal>ceph*</literal>, execute:
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --type=service ceph*
</screen>
   <para>
    Para listar apenas os serviços inativos, execute:
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --state=inactive --type=service ceph*
</screen>
   <para>
    Você também pode usar o <command>salt</command> para consultar serviços em vários nós:
   </para>
<screen>
<prompt>root@master # </prompt>salt <replaceable>TARGET</replaceable> cmd.shell \
 "systemctl list-units --all --type=service ceph* | sed -e '/^$/,$ d'"
</screen>
   <para>
    Consultar apenas nós de armazenamento:
   </para>
<screen>
<prompt>root@master # </prompt>salt -I 'roles:storage' cmd.shell \
 'systemctl list-units --all --type=service ceph*'
</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Status do serviço</title>
   <para>
    É possível consultar o <systemitem class="daemon">systemd</systemitem> para saber o status dos serviços. Por exemplo:
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    Substitua <replaceable>HOSTNAME</replaceable> pelo nome de host no qual o daemon está em execução.
   </para>
   <para>
    Se você não souber o nome/número exato do serviço, consulte a <xref linkend="ceph-operating-services-finding-names"/>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea-restart">
  <title>Reiniciando serviços do Ceph usando DeepSea</title>

  <para>
   Após aplicar atualizações aos nós do cluster, os serviços relacionados ao Ceph afetados precisarão ser reiniciados. Normalmente, as reinicializações são executadas automaticamente pelo DeepSea. Esta seção descreve como reiniciar os serviços manualmente.
  </para>

  <tip>
   <title>Observando a reinicialização</title>
   <para>
    O processo de reinicialização do cluster pode levar algum tempo. Para observar os eventos, você pode usar o barramento de evento do Salt ao executar o comando:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
   <para>
    Outro comando para monitorar tarefas ativas é
   </para>
<screen>
<prompt>root@master # </prompt>salt-run jobs.active
</screen>
  </tip>

  <sect2 xml:id="deepsea-restart-all">
   <title>Reiniciando todos os serviços</title>
   <warning>
    <title>Interrupção de Serviços</title>
    <para>
     Se os serviços relacionados ao Ceph, especificamente o iSCSI ou o NFS Ganesha, forem configurados como pontos únicos de acesso sem configuração de Alta Disponibilidade, a reinicialização deles resultará na interrupção temporária quando vistos do lado do cliente.
    </para>
   </warning>
   <tip>
    <title>Samba Não Gerenciado pelo DeepSea</title>
    <para>
     Como o DeepSea e o Ceph Dashboard não suportam implantações do Samba no momento, você precisa gerenciar os serviços relacionados ao Samba manualmente. Para ver mais detalhes, consulte o <xref linkend="cha-ses-cifs"/>.
    </para>
   </tip>
   <para>
    Para reiniciar <emphasis>todos</emphasis> os serviços no cluster, execute o seguinte comando:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <itemizedlist>
    <listitem>
     <para>
      Para o DeepSea anterior à versão 0.8.4, os serviços Servidor de Metadados, iSCSI Gateway, Object Gateway e NFS Ganesha são reiniciados em paralelo.
     </para>
    </listitem>
    <listitem>
     <para>
      Para o DeepSea 0.8.4 e versões mais recentes, todas as funções configuradas são reiniciadas na seguinte ordem: Ceph Monitor, Ceph Manager, Ceph OSD, Servidor de Metadados, Object Gateway, iSCSI Gateway, NFS Ganesha. Para manter o tempo de espera baixo e detectar possíveis problemas o quanto antes, os nós são reiniciados sequencialmente. Por exemplo, apenas um nó de monitoramento é reiniciado de cada vez.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    O comando aguardará a recuperação do cluster se ele estiver degradado, não saudável.
   </para>
  </sect2>

  <sect2 xml:id="deepsea-restart-specific">
   <title>Reiniciando serviços específicos</title>
   <para>
    Para reiniciar um serviço específico no cluster, execute:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    Por exemplo, para reiniciar todos os Object Gateways, execute:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    Você pode usar os seguintes destinos:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Encerramento normal de todo o cluster do Ceph</title>

  <para>
   Há ocasiões em que você precisa parar todos os serviços relacionados ao Ceph no cluster na ordem recomendada e depois apenas iniciá-los novamente. Por exemplo, em caso de queda de energia planejada.
  </para>

  <para>
   Para encerrar todo o cluster do Ceph, desabilite as medidas de segurança e execute o <command>ceph.shutdown</command>:
  </para>

<screen>
<prompt>root@master # </prompt>salt-run disengage.safety
<prompt>root@master # </prompt>salt-run state.orch ceph.shutdown
</screen>

  <para>
   Para iniciar todo o cluster do Ceph, execute o <command>ceph.startup</command>:
  </para>

<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.startup
</screen>
 </sect1>
</chapter>
