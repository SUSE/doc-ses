<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>備份叢集組態和資料</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/maintenance/ses6/xml/</dm:editurl>
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>編輯</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  本章說明您應當備份 Ceph 叢集的哪些部分才能還原叢集功能。
 </para>
 <sect1 xml:id="backup-ceph">
  <title>備份 Ceph 組態</title>

  <para>
   備份 <filename>/etc/ceph</filename> 目錄。該目錄包含至關重要的叢集組態。例如，當您需要更換管理節點時，就需要備份 <filename>/etc/ceph</filename>。
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-salt">
  <title>備份 Salt 組態</title>

  <para>
   您需要備份 <filename>/etc/salt/</filename> 目錄。該目錄包含 Salt 組態檔案，例如 Salt Master 金鑰和已接受的用戶端金鑰。
  </para>

  <para>
   從嚴格意義上來說，備份管理節點並不需要備份 Salt 檔案，但這些檔案能夠簡化 Salt 叢集的重新部署。如果不備份這些檔案，就需要在新管理節點上重新註冊 Salt Minion。
  </para>

  <note>
   <title>Salt Master 私密金鑰的安全性</title>
   <para>
    請務必將 Salt Master 私密金鑰的備份儲存在安全位置。Salt Master 金鑰可用於操縱所有叢集節點。
   </para>
  </note>

  <para>
   從備份還原 <filename>/etc/salt</filename> 目錄後，請重新啟動 Salt 服務：
  </para>

<screen><prompt>root@master # </prompt><command>systemctl</command> restart salt-master
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion</screen>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-deepsea">
  <title>備份 DeepSea 組態</title>

  <para>
   DeepSea 所需的所有檔案都儲存在 <filename>/srv/pillar/</filename>、<filename>/srv/salt/</filename> 和 <filename>/etc/salt/master.d</filename> 中。
  </para>

  <para>
   如果您需要重新部署管理節點，請在新節點上安裝 DeepSea 套件，並將備份的資料移回這些目錄。然後，無需做出更多變更，即可再次使用 DeepSea。在再次使用 DeepSea 之前，請確定已在管理節點上正確註冊所有 Salt Minion。
  </para>
 </sect1>
 <sect1 xml:id="backup-config-files">
  <title>備份自訂組態</title>

  <itemizedlist>
   <listitem>
    <para>
     Prometheus 資料和自訂。
    </para>
   </listitem>
   <listitem>
    <para>
     Grafana 自訂。
    </para>
   </listitem>
   <listitem>
    <para>
     確認您擁有現有 openATTIC 使用者的記錄，這樣您才能在 Ceph Dashboard 中為這些使用者建立新帳戶。
    </para>
   </listitem>
   <listitem>
    <para>
     在 DeepSea 之外手動對 <filename>ceph.conf</filename> 進行的變更。
    </para>
   </listitem>
   <listitem>
    <para>
     在 DeepSea 之外手動對 iSCSI 組態進行的變更。
    </para>
   </listitem>
   <listitem>
    <para>
     Ceph 金鑰。
    </para>
   </listitem>
   <listitem>
    <para>
     CRUSH 地圖和 CRUSH 規則。透過執行以下指令將包含 CRUSH 規則的反編譯 CRUSH 地圖儲存到 <filename>crushmap-backup.txt</filename> 中：
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
   </listitem>
   <listitem>
    <para>
     Samba 閘道組態。如果您使用的是單一閘道，請備份 <filename>/etc/samba/smb.conf</filename>。如果您使用的是 HA 設定，另請備份 CTDB 和 Pacemaker 組態檔案。如需 Samba 閘道所使用組態的詳細資料，請參閱<xref linkend="cha-ses-cifs"/>。
    </para>
   </listitem>
   <listitem>
    <para>
     NFS Ganesha 組態。僅當使用 HA 設定時需要備份。如需 NFS Ganesha 所使用組態的詳細資料，請參閱<xref linkend="cha-ceph-nfsganesha"/>。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
