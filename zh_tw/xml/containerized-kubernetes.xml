<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="containerized-kubernetes.xml" version="5.0" xml:id="cha-container-kubernetes">

 <title>在 SUSE CaaS Platform 4 Kubernetes 叢集上部署的 SUSE Enterprise Storage 6</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>編輯</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <warning>
  <title>技術預覽</title>
  <para>
   在 SUSE CaaS Platform 上執行容器化 Ceph 叢集是一項技術預覽功能。請不要在生產 Kubernetes 叢集上部署。
  </para>
 </warning>
 <para>
  本章介紹如何在 SUSE CaaS Platform 4 Kubernetes 叢集上部署容器化 SUSE Enterprise Storage 6。
 </para>
 <sect1 xml:id="kube-consider">
  <title>考量事項</title>

  <para>
   開始部署前，請考慮以下事項：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     若要在 Kubernetes 中執行 Ceph，SUSE Enterprise Storage 6 會使用名為 Rook 的上游專案 (<link xlink:href="https://rook.io/"/>)。
    </para>
   </listitem>
   <listitem>
    <para>
     Rook 可能會佔用 Kubernetes 叢集中所有節點的<emphasis>全部</emphasis>未使用磁碟，具體視組態而定。
    </para>
   </listitem>
   <listitem>
    <para>
     該設定需要特權容器。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-prereq">
  <title>先決條件</title>

  <para>
   開始部署前，您需要具有以下資源：
  </para>

  <itemizedlist>
   <listitem>
    <para>
     執行中的 SUSE CaaS Platform 4 叢集。
    </para>
   </listitem>
   <listitem>
    <para>
     連接了一些額外磁碟做為 Ceph 叢集儲存的 SUSE CaaS Platform 4 工作節點。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-rook-manifests">
  <title>獲取 Rook 資訊清單</title>

  <para>
   Rook 協調器使用稱為<emphasis>資訊清單</emphasis>的 YAML 格式組態檔案。您所需的資訊清單包含在
   <package>rook-k8s-yaml</package> RPM 套件中。可透過執行以下指令來安裝該套件：
  </para>

<screen><prompt>root # </prompt>zypper install rook-k8s-yaml</screen>
 </sect1>
 <sect1 xml:id="kube-install">
  <title>安裝</title>

  <para>
   Rook-Ceph 包含兩個主要元件：由 Kubernetes 執行且可用於建立 Ceph 叢集的「操作者」，以及 Ceph「叢集」自身，由操作者建立並管理它的一部分。
  </para>

  <sect2 xml:id="kube-configure">
   <title>組態</title>
   <sect3 xml:id="kube-configure-global">
    <title>全域組態</title>
    <para>
     此設定中使用的資訊清單會將所有 Rook 和 Ceph 元件都安裝在「rook-ceph」名稱空間中。如果您需要變更該設定，請相應地將對該名稱空間的所有參考納入 Kubernetes 資訊清單。
    </para>
    <para>
     依據您要使用的 Rook 功能，更改 <filename>common.yaml</filename> 中的「Pod 安全性規則」組態，以限制 Rook 的安全性要求。依照資訊清單檔案中的備註操作。
    </para>
   </sect3>
   <sect3 xml:id="kube-config-operator">
    <title>操作者組態</title>
    <para>
     資訊清單 <filename>operator.yaml</filename> 用於設定 Rook 操作者。通常情況下，您不需要進行變更。如需詳細資訊，請參閱資訊清單檔案中的備註。
    </para>
   </sect3>
   <sect3 xml:id="kube-config-ceph">
    <title>Ceph 叢集組態</title>
    <para>
     資訊清單 <filename>cluster.yaml</filename> 負責設定將在 Kubernetes 中執行的實際的 Ceph 叢集。如需所有可用選項的詳細描述，請參閱 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html"/> 中的上游 Rook 文件。
    </para>
    <para>
     Rook 預設設定為使用未透過 <option>node-role.kubernetes.io/master:NoSchedule</option> 污染的所有節點，並將依照組態的放置設定執行 (請參閱 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html#placement-configuration-settings"/>)。下面的範例禁止此類行為，並僅使用節點區段中明確列出的節點：
    </para>
<screen>
storage:
  useAllNodes: false
  nodes:
    - name: caasp4-worker-0
    - name: caasp4-worker-1
    - name: caasp4-worker-2
</screen>
    <note>
     <para>
      Rook 預設設定為使用每個節點上的所有可用和空的磁碟來做為 Ceph 儲存。
     </para>
    </note>
   </sect3>
   <sect3 xml:id="kube-config-docs">
    <title>文件</title>
    <itemizedlist>
     <listitem>
      <para>
       Rook-Ceph 上游文件 (<link xlink:href="https://rook.github.io/docs/rook/v1.3/ceph-storage.html"/>) 包含有關設定更進階部署的更多詳細資訊。在進行更進階的組態前，請參閱此文件以瞭解 Rook-Ceph 的基本知識。
      </para>
     </listitem>
     <listitem>
      <para>
       如需 SUSE CaaS Platform 產品的更多詳細資料，請參閱 <link xlink:href="https://www.suse.com/documentation/suse-caasp"/>。
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>

  <sect2 xml:id="kube-config-rook-operator">
   <title>建立 Rook 操作者</title>
   <para>
    透過在 SUSE CaaS Platform 主節點上執行以下指令，安裝 Rook-Ceph 通用元件、CSI 角色和 Rook-Ceph 操作者：
   </para>
<screen><prompt>root # </prompt>kubectl apply -f common.yaml -f operator.yaml</screen>
   <para>
    <filename>common.yaml</filename> 將建立「rook-ceph」名稱空間、Ceph 自訂資源定義 (Custom Resource Definitions，CRD) (請參閱 <link xlink:href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/"/>)，以使 Kubernetes 可感知 Ceph 物件 (例如「CephCluster」)，以及 Rook 管理叢集特定資源所必需的 RBAC 角色和 Pod 安全性規則 (請參閱 <link xlink:href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/"/>)。
   </para>
   <tip>
    <title><option>hostNetwork</option> 和 <option>hostPorts</option> 的使用</title>
    <para>
     如果在叢集資源定義中使用 <option>hostNetwork: true</option>，則必須允許使用 <option>hostNetwork</option>。還需要在 <literal>PodSecurityPolicy</literal> 中允許使用 <option>hostPorts</option>。
    </para>
   </tip>
   <para>
    透過在 SUSE CaaS Platform 主節點上執行 <command>kubectl get pods -n rook-ceph</command> 指令以確認安裝，例如：
   </para>
<screen><prompt>root # </prompt>kubectl get pods -n rook-ceph
NAME                                     READY   STATUS      RESTARTS   AGE
rook-ceph-agent-57c9j                    1/1     Running     0          22h
rook-ceph-agent-b9j4x                    1/1     Running     0          22h
rook-ceph-operator-cf6fb96-lhbj7         1/1     Running     0          22h
rook-discover-mb8gv                      1/1     Running     0          22h
rook-discover-tztz4                      1/1     Running     0          22h</screen>
  </sect2>

  <sect2 xml:id="kube-create-ceph-cluster">
   <title>建立 Ceph 叢集</title>
   <para>
    視需要修改 <filename>cluster.yaml</filename> 後，您便可建立 Ceph 叢集。在 SUSE CaaS Platform 主節點上執行以下指令：
   </para>
<screen><prompt>root # </prompt>kubectl apply -f cluster.yaml</screen>
   <para>
    監看「rook-ceph」名稱空間以查看 Ceph 叢集的建立過程。您將看到 <filename>cluster.yaml</filename> 資訊清單中所設定數量的 Ceph 監控程式 (預設為 3)、一個 Ceph 管理員，以及與可用磁碟數量一樣多的 Ceph OSD。
   </para>
   <tip>
    <title>暫存 OSD Pod</title>
    <para>
     在將 Ceph 叢集開機時，您會發現一些名為 <literal>rook-ceph-osd-prepare-<replaceable>NODE-NAME</replaceable></literal> 的 Pod 在執行一段時間後會以「已完成」狀態終止。其名稱表明了這些 Pod 用於佈建 Ceph OSD。系統不會將這些 Pod 刪除，而是將其保留下來，以便您可在其終止後檢查其記錄。例如：
    </para>
<screen><prompt>root # </prompt>kubectl get pods --namespace rook-ceph
NAME                                         READY  STATUS     RESTARTS  AGE
rook-ceph-agent-57c9j                        1/1    Running    0         22h
rook-ceph-agent-b9j4x                        1/1    Running    0         22h
rook-ceph-mgr-a-6d48564b84-k7dft             1/1    Running    0         22h
rook-ceph-mon-a-cc44b479-5qvdb               1/1    Running    0         22h
rook-ceph-mon-b-6c6565ff48-gm9wz             1/1    Running    0         22h
rook-ceph-operator-cf6fb96-lhbj7             1/1    Running    0         22h
rook-ceph-osd-0-57bf997cbd-4wspg             1/1    Running    0         22h
rook-ceph-osd-1-54cf468bf8-z8jhp             1/1    Running    0         22h
rook-ceph-osd-prepare-caasp4-worker-0-f2tmw  0/2    Completed  0         9m35s
rook-ceph-osd-prepare-caasp4-worker-1-qsfhz  0/2    Completed  0         9m33s
rook-ceph-tools-76c7d559b6-64rkw             1/1    Running    0         22h
rook-discover-mb8gv                          1/1    Running    0         22h
rook-discover-tztz4                          1/1    Running    0         22h</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="kube-using-rook">
  <title>使用 Rook 做為 Kubernetes 工作負載的儲存</title>

  <para>
   Rook 允許您使用三種不同類型的儲存：
  </para>

  <variablelist>
   <varlistentry>
    <term><emphasis role="bold">物件儲存</emphasis></term>
    <listitem>
     <para>
      物件儲存會向儲存叢集公開 S3 API，以供應用程式存放和獲取資料。如需詳細描述，請參閱 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-object.html"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共用檔案系統</term>
    <listitem>
     <para>
      可以使用讀取/寫入權限從多個 Pod 掛接共用檔案系統。這對於使用共用檔案系統叢集化的應用程式非常有用。如需詳細描述，請參閱 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-filesystem.html"/>。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>區塊儲存</term>
    <listitem>
     <para>
      區塊儲存可讓您將儲存掛接到單個 Pod。如需詳細描述，請參閱 <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-block.html"/>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="kube-uninstall">
  <title>解除安裝 Rook</title>

  <para>
   若要解除安裝 Rook，請執行以下步驟：
  </para>

  <procedure>
   <step>
    <para>
     刪除任何佔用 Rook 儲存的 Kubernetes 應用程式。
    </para>
   </step>
   <step>
    <para>
     刪除您依照<xref linkend="kube-using-rook"/>所述建立的所有物件、檔案和/或區塊儲存產出工件。
    </para>
   </step>
   <step>
    <para>
     刪除 Ceph 叢集、操作者和相關資源：
    </para>
<screen>
<prompt>root # </prompt>kubectl delete -f cluster.yaml
<prompt>root # </prompt>kubectl delete -f operator.yaml
<prompt>root # </prompt>kubectl delete -f common.yaml
</screen>
   </step>
   <step>
    <para>
     刪除主機上的資料：
    </para>
<screen><prompt>root # </prompt>rm -rf /var/lib/rook</screen>
   </step>
   <step>
    <para>
     必要時，抹除 Rook 已使用的磁碟。如需更多詳細資料，請參閱 <link xlink:href="https://rook.io/docs/rook/v1.3/ceph-teardown.html"/>。
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
