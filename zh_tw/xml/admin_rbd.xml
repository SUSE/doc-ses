<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_rbd.xml" version="5.0" xml:id="ceph.rbd">
 <title>RADOS 區塊裝置</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>yes</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  區塊是一個位元組序列，例如 512 位元組的資料區塊。區塊式儲存介面是使用旋轉媒體 (例如硬碟、CD、軟碟) 儲存資料最常見的方式。區塊裝置介面的普及，也使得虛擬區塊裝置成為與大量資料儲存系統 (例如 Ceph) 進行互動的理想選擇。
 </para>
 <para>
  Ceph 區塊裝置允許共用實體資源，並且可以調整大小。它們會在 Ceph 叢集中的多個 OSD 上等量儲存資料。Ceph 區塊裝置會利用 RADOS 功能，例如建立快照、複製和一致性。Ceph 的 RADOS 區塊裝置 (RBD) 使用核心模組或 <systemitem>librbd</systemitem> 程式庫與 OSD 互動。
 </para>
 <figure>
  <title>RADOS 通訊協定</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <para>
  Ceph 的區塊裝置為核心模組提供高效能及無限的延展性。它們支援虛擬化解決方案 (例如 QEMU)，或依賴於 <systemitem class="library">libvirt</systemitem> 的雲端運算系統 (例如 OpenStack)。您可以使用同一個叢集來同時操作物件閘道、CephFS 和 RADOS 區塊裝置。
 </para>
 <sect1 xml:id="ceph.rbd.commands">
  <title>區塊裝置指令</title>

  <para>
   使用 <command>rbd</command> 指令可建立、列出、內省和移除區塊裝置影像。您還可以使用它來執行其他操作，例如，複製影像、建立快照、將影像復原到快照，或檢視快照。
  </para>

  <tip>
   <title>存取叢集</title>
   <para>
    若要使用 RADOS 區塊裝置指令，您必須擁有對執行中 Ceph 叢集的存取權。
   </para>
  </tip>

  <sect2 xml:id="ceph.rbd.cmds.create">
   <title>建立區塊裝置影像</title>
   <para>
    您必須先在叢集中為區塊裝置建立影像，然後才能將其新增至節點。若要建立區塊裝置影像，請執行以下指令︰
   </para>
<screen><prompt>root # </prompt>rbd create --size <replaceable>megabytes</replaceable> <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
   <para>
    例如，若要建立名為「bar」的 1GB 影像，並將資訊儲存在名為「swimmingpool」的池中，請執行以下指令︰
   </para>
<screen><prompt>root # </prompt>rbd create --size 1024 swimmingpool/bar</screen>
   <tip>
    <title>預設池</title>
    <para>
     如果您在建立影像時不指定池，影像將儲存在預設池「rbd」中。
    </para>
   </tip>
   <note>
    <title>首先建立池</title>
    <para>
     您需要先建立池，然後才能將它指定為來源。請參閱<xref linkend="ceph.pools"/>，以取得詳細資料。
    </para>
   </note>
  </sect2>

  <sect2 xml:id="ceph.rbd.cmds.create-ec">
   <title>在糾刪碼池中建立區塊裝置影像</title>
   <para>
    自 SUSE Enterprise Storage 5 起，可以將區塊裝置影像的資料儲存在糾刪碼池中。只能將 RBD 影像的「資料」部分儲存在糾刪碼池中。另外，糾刪碼池必須將「overwrite」旗標設定為 <emphasis>true</emphasis>，而只有在所有 OSD 都使用 BlueStore 的情況下，才能將此旗標設定為 <emphasis>true</emphasis>。
   </para>
   <para>
    影像中繼資料不能存放在糾刪碼池中。中繼資料可以存放在預設的「rbd」池中，或者使用者使用參數 <parameter>--pool=</parameter> 在 <command>rbd create</command> 指令中明確指定的池中。
   </para>
   <note>
    <title>需要 BlueStore</title>
    <para>
     所有節點都需要 BlueStore 才能使用糾刪碼池儲存區塊裝置影像。
    </para>
   </note>
   <para>
    使用以下步驟可在糾刪碼池中建立 RBD 影像︰
   </para>
<screen><prompt>root # </prompt><command>ceph</command> osd pool create <replaceable>POOL_NAME</replaceable> 12 12 erasure
<prompt>root # </prompt><command>ceph</command> osd pool set <replaceable>POOL_NAME</replaceable> allow_ec_overwrites true

# Metadata will reside in pool "rbd", and data in pool "<replaceable>POOL_NAME</replaceable>"
<prompt>root # </prompt><command>rbd</command> create <replaceable>IMAGE_NAME</replaceable> --size=1G --data-pool <replaceable>POOL_NAME</replaceable>

#Metadata will reside in pool "<replaceable>OTHER_POOL</replaceable>", and data in pool "<replaceable>POOL_NAME</replaceable>"
<prompt>root # </prompt><command>rbd</command> create <replaceable>IMAGE_NAME</replaceable> --size=1G --data-pool <replaceable>POOL_NAME</replaceable> --pool=<replaceable>OTHER_POOL</replaceable></screen>
  </sect2>

  <sect2 xml:id="ceph.rbd.cmds.list">
   <title>列出區塊裝置影像</title>
   <para>
    若要列出「rbd」池中的區塊裝置，請執行以下指令 (「rbd」是預設池名稱)︰
   </para>
<screen><prompt>root # </prompt>rbd ls</screen>
   <para>
    若要列出名為「swimmingpool」的池中的區塊裝置，請執行以下指令︰
   </para>
<screen><prompt>root # </prompt>rbd ls swimmingpool</screen>
  </sect2>

  <sect2 xml:id="ceph.rbd.cmds.info">
   <title>擷取影像資訊</title>
   <para>
    若要擷取名為「swimmingpool」的池內影像「bar」中的資訊，請執行以下指令︰
   </para>
<screen><prompt>root # </prompt>rbd info swimmingpool/bar</screen>
  </sect2>

  <sect2 xml:id="ceph.rbd.cmds.resize">
   <title>調整區塊裝置影像的大小</title>
   <para>
    RADOS 區塊裝置影像是簡易佈建的 — 在您開始將資料儲存到這些影像之前，它們實際上並不會使用任何實體儲存。但是，這些影像具有您使用 <option>--size</option> 選項設定的最大容量。如果您要增大 (或減小) 影像的最大大小，請執行以下指令︰
   </para>
<screen><prompt>root # </prompt>rbd resize --size 2048 foo # to increase
rbd resize --size 2048 foo --allow-shrink # to decrease</screen>
  </sect2>

  <sect2 xml:id="ceph.rbd.cmds.rm">
   <title>移除區塊裝置影像</title>
   <para>
    若要移除與名為「swimmingpool」的池內影像「bar」對應的區塊裝置，請執行以下指令︰
   </para>
<screen><prompt>root # </prompt>rbd rm swimmingpool/bar</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="storage.bp.integration.mount_rbd">
  <title>掛接和卸載 RBD 影像</title>

  <para>
   建立 RADOS 區塊裝置之後，便可以格式化並掛接它以便能夠交換檔案，然後在完成時將其卸載。
  </para>

  <procedure>
   <step>
    <para>
     確定您的 Ceph 叢集包含要掛接的磁碟影像所在的池。假設池名為 <literal>mypool</literal>，影像名為 <literal>myimage</literal>。
    </para>
<screen>rbd list mypool</screen>
   </step>
   <step>
    <para>
     將影像對應到新的區塊裝置。
    </para>
<screen><prompt>root # </prompt>rbd map --pool mypool myimage</screen>
    <tip>
     <title>使用者名稱和驗證</title>
     <para>
      若要指定使用者名稱，請使用 <option>--id <replaceable>user-name</replaceable></option>。此外，如果您使用了 <systemitem>cephx</systemitem> 驗證，則還必須指定機密。該機密可能來自金鑰圈，或某個包含機密的檔案︰
     </para>
<screen><prompt>root # </prompt>rbd map --pool rbd myimage --id admin --keyring /path/to/keyring</screen>
     <para>
      或
     </para>
<screen><prompt>root # </prompt>rbd map --pool rbd myimage --id admin --keyfile /path/to/file</screen>
    </tip>
   </step>
   <step>
    <para>
     列出所有對應的裝置︰
    </para>
<screen><prompt>root # </prompt>rbd showmapped
 id pool   image   snap device
 0  mypool myimage -    /dev/rbd0</screen>
    <para>
     我們要使用的裝置是 <filename>/dev/rbd0</filename>。
    </para>
   </step>
   <step>
    <para>
     在 <filename>/dev/rbd0</filename> 裝置上建立 XFS 檔案系統。
    </para>
<screen><prompt>root # </prompt>mkfs.xfs /dev/rbd0
 log stripe unit (4194304 bytes) is too large (maximum is 256KiB)
 log stripe unit adjusted to 32KiB
 meta-data=/dev/rbd0              isize=256    agcount=9, agsize=261120 blks
          =                       sectsz=512   attr=2, projid32bit=1
          =                       crc=0        finobt=0
 data     =                       bsize=4096   blocks=2097152, imaxpct=25
          =                       sunit=1024   swidth=1024 blks
 naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
 log      =internal log           bsize=4096   blocks=2560, version=2
          =                       sectsz=512   sunit=8 blks, lazy-count=1
 realtime =none                   extsz=4096   blocks=0, rtextents=0</screen>
   </step>
   <step>
    <para>
     掛接裝置並檢查它是否已正確掛接。以您的掛接點取代 <filename>/mnt</filename>。
    </para>
<screen><prompt>root # </prompt>mount /dev/rbd0 /mnt
<prompt>root # </prompt>mount | grep rbd0
/dev/rbd0 on /mnt type xfs (rw,relatime,attr2,inode64,sunit=8192,...</screen>
    <para>
     現在，您便可以將資料移入和移出裝置，就如同它是本地目錄一樣。
    </para>
    <tip>
     <title>增大 RBD 裝置的大小</title>
     <para>
      如果您發現 RBD 裝置的大小不再夠用，可以輕鬆增大大小。
     </para>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        增大 RBD 影像的大小，例如增大到 10GB。
       </para>
<screen><prompt>root # </prompt>rbd resize --size 10000 mypool/myimage
 Resizing image: 100% complete...done.</screen>
      </listitem>
      <listitem>
       <para>
        擴充檔案系統以填入裝置的新大小。
       </para>
<screen><prompt>root # </prompt>xfs_growfs /mnt
 [...]
 data blocks changed from 2097152 to 2560000</screen>
      </listitem>
     </orderedlist>
    </tip>
   </step>
   <step>
    <para>
     當您存取過裝置後，可以將其卸載。
    </para>
<screen><prompt>root # </prompt>unmount /mnt</screen>
   </step>
  </procedure>

  <tip>
   <title>手動掛接 (卸載)</title>
   <para>
    由於在開機後手動對應和掛接 RBD 影像以及在關機前卸載和取消對應會非常麻煩，我們提供了 <command>rbdmap</command> 程序檔和 <systemitem class="daemon">systemd</systemitem> 單位。請參閱<xref linkend="ceph.rbd.rbdmap"/>。
   </para>
  </tip>
 </sect1>
 <sect1 xml:id="cha.ceph.snapshots.rbd">
  <title>區塊裝置快照</title>

  <para>
   RBD 快照是 RADOS 區塊裝置影像的快照。透過快照，您可以保留影像狀態的歷程。Ceph 還支援快照分層，這可讓您輕鬆快捷地複製虛擬機器影像。Ceph 使用 <command>rbd</command> 指令和許多高階介面 (包括 QEMU、<systemitem>libvirt</systemitem>、OpenStack 和 CloudStack) 支援區塊裝置快照。
  </para>

  <note>
   <para>
    在建立影像快照之前，請停止輸入和輸出操作。如果影像包含檔案系統，則在建立快照<emphasis>之前</emphasis>，檔案系統必須處於一致狀態。
   </para>
  </note>

  <sect2>
   <title>Cephx 注意事項</title>
   <para>
    如果 <systemitem>cephx</systemitem> 處於啟用狀態 (如需詳細資訊，請參閱<link xlink:href="http://ceph.com/docs/master/rados/configuration/auth-config-ref/"/>)，您必須指定使用者名稱或 ID，以及包含使用者相應金鑰的金鑰圈路徑。如需詳細資料，請參閱<link xlink:href="http://ceph.com/docs/master/rados/operations/user-management/">使用者管理</link>。您還可以新增 <systemitem>CEPH_ARGS</systemitem> 環境變數，以免重新輸入以下參數。
   </para>
<screen><prompt>root # </prompt>rbd --id <replaceable>user-ID</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable>
<prompt>root # </prompt>rbd --name <replaceable>username</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable></screen>
   <para>
    例如︰
   </para>
<screen><prompt>root # </prompt>rbd --id admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable>
<prompt>root # </prompt>rbd --name client.admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable></screen>
   <tip>
    <para>
     將使用者和機密新增至 <systemitem>CEPH_ARGS</systemitem> 環境變數，如此您便無需每次都輸入它們。
    </para>
   </tip>
  </sect2>

  <sect2>
   <title>快照基礎知識</title>
   <para>
    下面的程序展示如何在指令行上使用 <command>rbd</command> 指令來建立、列出和移除快照。
   </para>
   <sect3>
    <title>建立快照</title>
    <para>
     若要使用 <command>rbd</command> 建立快照，請指定 <option>snap create</option> 選項、池名稱和影像名稱。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap create --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap create <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool rbd snap create --snap snapshot1 image1
<prompt>root # </prompt>rbd snap create rbd/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>列出快照</title>
    <para>
     若要列出影像的快照，請指定池名稱和影像名稱。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap ls <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap ls <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool rbd snap ls image1
<prompt>root # </prompt>rbd snap ls rbd/image1</screen>
   </sect3>
   <sect3>
    <title>復原快照</title>
    <para>
     若要使用 <command>rbd</command> 復原快照，請指定 <option>snap rollback</option> 選項、池名稱、影像名稱和快照名稱。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rollback --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap rollback <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap rollback --snap snapshot1 image1
<prompt>root # </prompt>rbd snap rollback pool1/image1@snapshot1</screen>
    <note>
     <para>
      將影像復原到快照意味著會使用快照中的資料覆寫目前版本的影像。執行復原所需的時間將隨影像大小的增加而延長。從快照<emphasis>複製較快</emphasis>，而從影像到快照的<emphasis>復原較慢</emphasis>，因此複製是恢復到先前存在狀態的慣用方法。
     </para>
    </note>
   </sect3>
   <sect3>
    <title>刪除快照</title>
    <para>
     若要使用 <command>rbd</command> 刪除快照，請指定 <option>snap rm</option> 選項、池名稱、影像名稱和使用者名稱。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rm --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap rm <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap rm --snap snapshot1 image1
<prompt>root # </prompt>rbd snap rm pool1/image1@snapshot1</screen>
    <note>
     <para>
      Ceph OSD 會以非同步方式刪除資料，因此刪除快照不能立即釋放磁碟空間。
     </para>
    </note>
   </sect3>
   <sect3>
    <title>清除快照</title>
    <para>
     若要使用 <command>rbd</command> 刪除影像的所有快照，請指定 <option>snap purge</option> 選項和影像名稱。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap purge <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd snap purge <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap purge image1
<prompt>root # </prompt>rbd snap purge pool1/image1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph.snapshoti.layering">
   <title>分層</title>
   <para>
    使用 Ceph 可建立許多區塊裝置快照的寫入時複製 (COW) 複製品。快照分層可讓 Ceph 區塊裝置用戶端能夠極快地建立影像。例如，您可以建立區塊裝置影像並將 Linux 虛擬機器寫入其中，然後建立影像的快照、保護快照，並建立您所需數量的「寫入時複製」複製品。快照是唯讀的，因此複製快照簡化了語意，如此可快速建立複製品。
   </para>
   <note>
    <para>
     下面的指令行範例中提到的「父」和「子」這兩個術語是指 Ceph 區塊裝置快照 (父) 和從快照複製的相應影像 (子)。
    </para>
   </note>
   <para>
    每個複製的影像 (子) 都儲存了對其父影像的參考，這可讓複製的影像開啟父快照並讀取其內容。
   </para>
   <para>
    快照的 COW 複製品運作方式與任何其他 Ceph 區塊裝置影像完全相同。您可針對複製的影像執行讀取、寫入、複製和調整大小操作。系統對複製的影像沒有特殊限制。但是，快照的寫入時複製複製品會參考快照，因此您<emphasis>必須</emphasis>在複製快照之前保護快照。
   </para>
   <note>
    <para>
     Ceph 僅支援複製<emphasis>格式 2</emphasis> 影像 (即使用 <command>rbd create --image-format 2</command> 建立的影像)。
    </para>
   </note>
   <sect3>
    <title>分層入門</title>
    <para>
     Ceph 區塊裝置分層是一個簡單的過程。您必須有一個影像。您必須建立影像的快照。您必須保護快照。在您執行這些步驟之後，就可以開始複製快照了。
    </para>
    <para>
     複製的影像具有對父快照的參考，並且包含池 ID、影像 ID 和快照 ID。包含池 ID 表示您可以將快照從一個池複製到另一個池中的影像。
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <emphasis>影像範本</emphasis>︰一種常見的區塊裝置分層使用案例是建立主影像和當成複製品範本使用的快照。例如，使用者可為 Linux 套裝作業系統 (如 SUSE Linux Enterprise Server) 建立影像並為它建立快照。使用者可以定期更新影像和建立新的快照 (例如，先執行 <command>zypper ref &amp;&amp; zypper patch</command>，接著執行 <command>rbd snap create</command>)。隨著影像日趨成熟，使用者可以複製任何一個快照。
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>延伸的範本</emphasis>︰更進階的使用案例包括延伸比基礎影像提供的資訊更多的範本影像。例如，使用者可以複製影像 (虛擬機器範本) 並安裝其他軟體 (例如，資料庫、內容管理系統或分析系統)，然後建立延伸影像的快照，這個延伸影像可以如基礎影像一般更新。
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>範本池</emphasis>︰使用區塊裝置分層的一種方法是建立包含主影像 (用做範本) 的池，然後建立這些範本的快照。之後，您便可以擴充使用者的唯讀特權，使他們可以複製快照，卻不能寫入池或在池中執行。
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>影像移轉/復原</emphasis>︰使用區塊裝置分層的一種方法是將資料從一個池移轉或復原到另一個池。
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
   <sect3>
    <title>保護快照</title>
    <para>
     複製品會存取父快照。如果使用者意外刪除了父快照，則所有複製品都會損毀。為了防止資料遺失，您需要先保護快照，然後才能複製它。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap protect \
 --image <replaceable>image-name</replaceable> --snap <replaceable>snapshot-name</replaceable>
<prompt>root # </prompt>rbd snap protect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap protect --image image1 --snap snapshot1
<prompt>root # </prompt>rbd snap protect pool1/image1@snapshot1</screen>
    <note>
     <para>
      您無法刪除受保護的快照。
     </para>
    </note>
   </sect3>
   <sect3>
    <title>複製快照</title>
    <para>
     若要複製快照，您需要指定父池、影像、快照、子池和影像名稱。您需要先保護快照，然後才能複製它。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> --image <replaceable>parent-image</replaceable> \
 --snap <replaceable>snap-name</replaceable> --dest-pool <replaceable>pool-name</replaceable> \
 --dest <replaceable>child-image</replaceable>
<prompt>root # </prompt>rbd clone <replaceable>pool-name</replaceable>/<replaceable>parent-image</replaceable>@<replaceable>snap-name</replaceable> \
<replaceable>pool-name</replaceable>/<replaceable>child-image-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd clone pool1/image1@snapshot1 pool1/image2</screen>
    <note>
     <para>
      您可以將快照從一個池複製到另一個池中的影像。例如，可以在一個池中將唯讀影像和快照做為範本維護，而在另一個池中維護可寫入複製品。
     </para>
    </note>
   </sect3>
   <sect3>
    <title>取消保護快照</title>
    <para>
     您必須先取消保護快照，然後才能刪除它。另外，您<emphasis>無法</emphasis>刪除複製品所參考的快照。您需要先壓平快照的每個複製品，然後才能刪除快照。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> snap unprotect --image <replaceable>image-name</replaceable> \
 --snap <replaceable>snapshot-name</replaceable>
<prompt>root # </prompt>rbd snap unprotect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 snap unprotect --image image1 --snap snapshot1
<prompt>root # </prompt>rbd snap unprotect pool1/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>列出快照的子項</title>
    <para>
     若要列出快照的子項，請執行以下指令︰
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> children --image <replaceable>image-name</replaceable> --snap <replaceable>snap-name</replaceable>
<prompt>root # </prompt>rbd children <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 children --image image1 --snap snapshot1
<prompt>root # </prompt>rbd children pool1/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>壓平複製的影像</title>
    <para>
     複製的影像會保留對父快照的參考。移除子複製品對父快照的參考時，可透過將資訊從快照複製到複製品，高效「壓平」影像。壓平複製品所需的時間隨快照大小的增加而延長。若要刪除快照，必須先壓平子影像。
    </para>
<screen><prompt>root # </prompt>rbd --pool <replaceable>pool-name</replaceable> flatten --image <replaceable>image-name</replaceable>
<prompt>root # </prompt>rbd flatten <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --pool pool1 flatten --image image1
<prompt>root # </prompt>rbd flatten pool1/image1</screen>
    <note>
     <para>
      由於壓平的影像包含快照中的所有資訊，壓平的影像佔用的儲存空間將比分層複製品多。
     </para>
    </note>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph.rbd.rbdmap">
  <title>rbdmap︰在開機時對應 RBD 裝置</title>

  <para>
   <command>rbdmap</command> 是一個外圍程序程序檔，可針對一或多個 RADOS 區塊裝置影像自動執行 <command>rbd map</command> 和 <command>rbd unmap</command> 操作。雖然您隨時都可以手動執行該程序檔，但其主要用於在開機時自動對應和掛接 RBD 影像 (以及在關機時卸載和取消對應影像)，此操作由 Init 系統觸發。<systemitem>ceph-common</systemitem> 套件中隨附了一個 <systemitem class="daemon">systemd</systemitem> 單位檔案 <filename>rbdmap.service</filename> 用於執行此操作。
  </para>

  <para>
   該程序檔使用單個引數，可以是 <option>map</option> 或 <option>unmap</option>。使用任一引數時，該程序檔都會剖析組態檔案。它預設為 <filename>/etc/ceph/rbdmap</filename>，但可透過環境變數 <literal>rbdmapFILE</literal> 覆寫。該組態檔案的每一行相當於一個要對應或取消對應的 RBD 影像。
  </para>

  <para>
   組態檔案採用以下格式︰
  </para>

<screen>image_specification rbd_options</screen>

  <variablelist>
   <varlistentry>
    <term>image_specification</term>
    <listitem>
     <para>
      池中影像的路徑。以 <replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable> 格式指定。如果您省略 <replaceable>pool_name</replaceable>，則假設使用預設名稱「rbd」。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>rbd_options</term>
    <listitem>
     <para>
      要傳遞給基礎 <command>rbd map</command> 指令的參數的選擇性清單。應該以逗號分隔的字串指定這些參數及其值，例如︰
     </para>
<screen>PARAM1=VAL1,PARAM2=VAL2,...</screen>
     <para>
      該範例讓 <command>rbdmap</command> 程序檔執行以下指令︰
     </para>
<screen>rbd map <replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable> --PARAM1 VAL1 --PARAM2 VAL2</screen>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   以 <command>rbdmap map</command> 形式執行時，該程序檔會剖析組態檔案，並且對於每個指定的 RBD 影像，它會嘗試先對應影像 (使用 <command>rbd map</command> 指令)，然後再掛接影像。
  </para>

  <para>
   以 <command>rbdmap unmap</command> 形式執行時，將卸載並取消對應組態檔案中列出的影像。
  </para>

  <para>
   <command>rbdmap unmap-all</command> 會嘗試卸載然後取消對應所有目前已對應的 RBD 影像，而不論它們是否列在組態檔案中。
  </para>

  <para>
   如果成功，rbd map 操作會將影像對應到 /dev/rbdX 裝置，此時會觸發 udev 規則，以建立易記的裝置名稱符號連結 <filename>/dev/rbd/<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable></filename>，該連結指向實際對應的裝置。
  </para>

  <para>
   為了使掛接和卸載成功，「易記的」裝置名稱在 <filename>/etc/fstab</filename> 中需有對應項。寫入 RBD 影像的 <filename>/etc/fstab</filename> 項目時，指定「noauto」(或「nofail」) 掛接選項。這可防止 Init 系統過早 (尚未出現有問題的裝置時) 嘗試掛接裝置，因為 <filename>rbdmap.service</filename> 一般在開機序列中相當靠後的時間觸發。
  </para>

  <para>
   如需 <command>rbd</command> 選項的完整清單，請參閱 <command>rbd</command> 手冊頁 (<command>man 8 rbd</command>)。
  </para>

  <para>
   如需 <command>rbdmap</command> 用法的範例，請參閱 <command>rbdmap</command> 手冊頁 (<command>man 8 rbdmap</command>)。
  </para>
 </sect1>
 <sect1 xml:id="ceph.rbd.mirror">
  <title>RADOS 區塊裝置鏡像</title>

  <para>
   RBD 影像可以在兩個 Ceph 叢集之間以非同步方式鏡像。此功能使用 RBD 記錄影像功能來確保叢集之間的複製在當機時保持一致。鏡像在對等叢集中依池設定，並且可以設定為自動鏡像池中的所有影像，或僅鏡像特定的影像子集。使用 <command>rbd</command> 指令來設定鏡像。<systemitem>rbd-mirror</systemitem> 精靈負責從遠端對等叢集提取影像更新，並將它們套用於本地叢集中的影像。
  </para>

  <important>
   <title>rbd-mirror 精靈</title>
   <para>
    若要使用 RBD 鏡像，您需要有兩個 Ceph 叢集，每個叢集都執行 <systemitem>rbd-mirror</systemitem> 精靈。
   </para>
  </important>

  <sect2 xml:id="rbd.mirror.daemon">
   <title>rbd-mirror 精靈</title>
   <para>
    兩個 <systemitem>rbd-mirror</systemitem> 精靈負責監看遠端對等叢集上的影像記錄，並針對本地叢集重放記錄事件。RBD 影像記錄功能會依發生的順序記錄對影像進行的所有修改。如此可確保遠端影像當機狀態一致的鏡像可在本地使用。
   </para>
   <para>
    <systemitem>rbd-mirror</systemitem> 精靈在 <systemitem>rbd-mirror</systemitem> 套件中提供。在其中一個叢集節點上安裝、啟用並啟動它︰
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper install rbd-mirror
<prompt>root@minion &gt; </prompt>systemctl enable ceph-rbd-mirror@<replaceable>server_name</replaceable>.service
<prompt>root@minion &gt; </prompt>systemctl start ceph-rbd-mirror@<replaceable>server_name</replaceable>.service</screen>
   <important>
    <para>
     每個 <systemitem>rbd-mirror</systemitem> 精靈都必須能夠同時連接到兩個叢集。
    </para>
   </important>
  </sect2>

  <sect2 xml:id="ceph.rbd.mirror.poolconfig">
   <title>池組態</title>
   <para>
    下面的程序展示如何使用 <command>rbd</command> 指令來執行設定鏡像的基本管理任務。在 Ceph 叢集中依池來設定鏡像。
   </para>
   <para>
    您需要在兩個對等叢集上執行池組態步驟。為清楚起見，這些程序假設可從單部主機存取名為「local」和「remote」的兩個叢集。
   </para>
   <para>
    如需如何連接到不同 Ceph 叢集的更多詳細資料，請參閱 <command>rbd</command> 手冊頁 (<command>man 8 rbd</command>)。
   </para>
   <tip>
    <title>多個叢集</title>
    <para>
     在下面的範例中，叢集名稱與同名的 Ceph 組態檔案 <filename>/etc/ceph/remote.conf</filename> 相對應。如需如何設定多個叢集的資訊，請參閱 <link xlink:href="http://docs.ceph.com/docs/master/rados/configuration/ceph-conf/#running-multiple-clusters">ceph-conf</link> 文件。
    </para>
   </tip>
   <sect3>
    <title>啟用鏡像</title>
    <para>
     若要針對池啟用鏡像，請指定 <command>mirror pool enable</command> 子指令、池名稱和鏡像模式。鏡像模式可以是池或影像︰
    </para>
    <variablelist>
     <varlistentry>
      <term>pool</term>
      <listitem>
       <para>
        系統會鏡像啟用了記錄功能的池中的所有影像。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>image</term>
      <listitem>
       <para>
        需要針對每個影像明確啟用鏡像。如需詳細資訊，請參閱<xref linkend="rbd.mirror.enable_image_mirroring"/>。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     例如︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool enable image-pool pool
<prompt>root # </prompt>rbd --cluster remote mirror pool enable image-pool pool</screen>
   </sect3>
   <sect3>
    <title>停用鏡像</title>
    <para>
     若要對池停用鏡像，請指定 <command>mirror pool disable</command> 子指令和池名稱。使用這種方法對池停用鏡像時，還會對已為其明確啟用鏡像的所有影像 (該池中) 停用鏡像。
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool disable image-pool
<prompt>root # </prompt>rbd --cluster remote mirror pool disable image-pool</screen>
   </sect3>
   <sect3>
    <title>新增叢集對等</title>
    <para>
     為了讓 <systemitem>rbd-mirror</systemitem> 精靈探查它的對等叢集，需要向池註冊該對等叢集。若要新增鏡像對等叢集，請指定 <command>mirror pool peer add</command> 子指令、池名稱和叢集規格︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool peer add image-pool client.remote@remote
<prompt>root # </prompt>rbd --cluster remote mirror pool peer add image-pool client.local@local</screen>
   </sect3>
   <sect3>
    <title>移除叢集對等</title>
    <para>
     若要移除鏡像對等叢集，請指定 <command>mirror pool peer remove</command> 子指令、池名稱和對等 UUID (可透過 <command>rbd mirror pool info</command> 指令獲得)︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool peer remove image-pool \
 55672766-c02b-4729-8567-f13a66893445
<prompt>root # </prompt>rbd --cluster remote mirror pool peer remove image-pool \
 60c0e299-b38f-4234-91f6-eed0a367be08</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd.mirror.imageconfig">
   <title>影像組態</title>
   <para>
    與池組態不同，影像組態只需要針對單個鏡像對等 Ceph 叢集執行。
   </para>
   <para>
    系統會將鏡像的 RBD 影像指定為<emphasis>主要</emphasis>或<emphasis>非主要</emphasis>。這是影像的內容，而不是池的內容。不能修改指定為非主要的影像。
   </para>
   <para>
    當首次對某個影像啟用鏡像時 (如果池鏡像模式是「池」並且影像已啟用記錄影像功能，則暗示已啟用，或者可透過 <command>rbd</command> 指令明確啟用 (請參閱<xref linkend="rbd.mirror.enable_image_mirroring"/>))，影像會自動升級為主要影像。
   </para>
   <sect3>
    <title>啟用影像記錄支援</title>
    <para>
     RBD 鏡像使用 RBD 記錄功能來確保複製的影像永遠在當機時保持一致狀態。在將影像鏡像到對等叢集之前，必須啟用記錄功能。在建立影像時，可以透過將 <option>--image-feature exclusive-lock,journaling</option> 選項提供給 <command>rbd</command> 指令來啟用該功能。
    </para>
    <para>
     您也可以針對預先存在的 RBD 影像動態啟用記錄功能。若要啟用記錄，請指定 <command>feature enable</command> 子指令、池和影像名稱以及功能名稱︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local feature enable image-pool/image-1 journaling</screen>
    <note>
     <title>選項相依項</title>
     <para>
      <option>journaling</option> 功能依賴於 <option>exclusive-lock</option> 功能。如果 <option>exclusive-lock</option> 功能尚未啟用，您需要先啟用它，再啟用 <option>journaling</option> 功能。
     </para>
    </note>
    <tip>
     <title>針對所有新影像啟用記錄</title>
     <para>
      依預設，可透過將下面一行新增至 Ceph 組態檔案來針對所有新影像啟用記錄︰
     </para>
<screen>rbd default features = 125</screen>
    </tip>
   </sect3>
   <sect3 xml:id="rbd.mirror.enable_image_mirroring">
    <title>啟用影像鏡像</title>
    <para>
     如果以「影像」模式對影像的池設定鏡像，則需要為池中的每個影像明確啟用鏡像。若要為特定影像啟用鏡像，請指定 <command>mirror image enable</command> 子指令以及池和影像名稱︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image enable image-pool/image-1</screen>
   </sect3>
   <sect3>
    <title>停用影像鏡像</title>
    <para>
     若要為特定影像停用鏡像，請指定 <command>mirror image disable</command> 子指令以及池和影像名稱︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image disable image-pool/image-1</screen>
   </sect3>
   <sect3>
    <title>影像升級和降級</title>
    <para>
     在需要將主要指定移動到對等叢集中影像的容錯移轉情況下，您需要停止存取主要影像、降級目前主要影像、升級新的主要影像，然後繼續存取替代叢集上的影像。
    </para>
    <para>
     若要將特定影像降級為非主要影像，請指定 <command>mirror image demote</command> 子指令以及池和影像名稱︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror image demote image-pool/image-1</screen>
    <para>
     若要將池中的所有主要影像都降級為非主要影像，請指定 <command>mirror pool demote</command> 子指令以及池名稱︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool demote image-pool</screen>
    <para>
     若要將特定影像升級為主要影像，請指定 <command>mirror image promote</command> 子指令以及池和影像名稱︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster remote mirror image promote image-pool/image-1</screen>
    <para>
     若要將池中的所有非主要影像都升級為主要影像，請指定 <command>mirror pool promote</command> 子指令以及池名稱︰
    </para>
<screen><prompt>root # </prompt>rbd --cluster local mirror pool promote image-pool</screen>
    <tip>
     <title>拆分 I/O 負載</title>
     <para>
      因為主要或非主要狀態都是針對每個影像指定的，所以可以將兩個叢集拆分為 IO 負載和階段容錯移轉或錯誤回復。
     </para>
    </tip>
    <note>
     <title>強制升級</title>
     <para>
      可以使用 <option>--force</option> 選項強制升級。降級不能傳播到對等叢集時 (例如，當叢集發生故障或通訊中斷時)，就需要強制升級。這將導致兩個對等叢集之間出現電腦分裂的情況，並且影像將不再同步，直到發出了 <command>resync</command> 子指令。
     </para>
    </note>
   </sect3>
   <sect3>
    <title>強制影像重新同步</title>
    <para>
     如果 <systemitem>rbd-mirror</systemitem> 精靈偵測到電腦分裂事件，則在該情況解決之前，它不會嘗試鏡像受影響的影像。若要繼續鏡像影像，請先降級確定已過期的影像，然後要求與主要影像重新同步。若要要求影像重新同步，請指定 <command>mirror image resync</command> 子指令以及池和影像名稱︰
    </para>
<screen><prompt>root # </prompt>rbd mirror image resync image-pool/image-1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd.mirror.status">
   <title>鏡像狀態</title>
   <para>
    系統會儲存每個主要鏡像影像的對等叢集複製狀態。可使用 <command>mirror image status</command> 和 <command>mirror pool status</command> 子指令來擷取此狀態︰
   </para>
   <para>
    若要要求鏡像影像狀態，請指定 <command>mirror image status</command> 子指令以及池和影像名稱︰
   </para>
<screen><prompt>root # </prompt>rbd mirror image status image-pool/image-1</screen>
   <para>
    若要要求鏡像池摘要狀態，請指定 <command>mirror pool status</command> 子指令以及池名稱︰
   </para>
<screen><prompt>root # </prompt>rbd mirror pool status image-pool</screen>
   <tip>
    <title/>
    <para>
     將 <option>--verbose</option> 選項新增至 <command>mirror pool status</command> 子指令會額外地輸出池中每個鏡像影像的狀態詳細資料。
    </para>
   </tip>
  </sect2>
 </sect1>
</chapter>
