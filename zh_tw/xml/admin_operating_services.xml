<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph-operating-services">
 <title>操作 Ceph 服務</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>是</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  您可以使用 <systemitem class="daemon">systemd</systemitem> 或透過 DeepSea 來操作 Ceph 服務。
 </para>
 <sect1 xml:id="operate-services-systemd">
  <title>使用 <systemitem class="daemon">systemd</systemitem> 操作與 Ceph Cluster 相關的服務</title>

  <para>
   使用 <command>systemctl</command> 指令操作所有與 Ceph 相關的服務。操作在您目前登入的節點上進行。您需要具有 <systemitem class="username">root</systemitem> 特權才能操作 Ceph 服務。
  </para>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>使用目標啟動、停止和重新啟動服務</title>
   <para>
    為了簡化啟動、停止和重新啟動節點上特定類型的所有服務 (例如所有 Ceph 服務、所有 MON 或所有 OSD) 的操作，Ceph 提供了以下 <systemitem class="daemon">systemd</systemitem> 單位檔案：
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    若要啟動/停止/重新啟動節點上的所有 Ceph 服務，請執行以下指令：
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl restart ceph.target
</screen>
   <para>
    若要啟動/停止/重新啟動節點上的所有 OSD，請執行以下指令：
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target
</screen>
   <para>
    針對其他目標的指令與此類似。
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-individual">
   <title>啟動、停止和重新啟動個別服務</title>
   <para>
    您可以使用以下參數化 <systemitem class="daemon">systemd</systemitem> 單位檔案來操作個別服務：
   </para>
<screen>
ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-mgr@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service
</screen>
   <para>
    若要使用這些指令，您首先需要確定要操作的服務名稱。請參閱<xref linkend="ceph-operating-services-finding-names"/>以瞭解有關如何識別服務的詳細資訊。
   </para>
   <para>
    若要啟動/停止/重新啟動 <literal>osd.1</literal> 服務，請執行以下指令：
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service
</screen>
   <para>
    針對其他服務類型的指令與此類似。
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>識別個別服務</title>
   <para>
    您可以透過以下幾種方式獲得某種服務類型的名稱/編號。以下指令提供 <literal>ceph*</literal> 服務的結果。您可以在 Ceph 叢集的任何節點上執行這些指令。
   </para>
   <para>
    若要列出 <literal>ceph*</literal> 類型的所有 (甚至是非使用中) 服務，請執行以下指令：
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --type=service ceph*
</screen>
   <para>
    若只想列出非使用中服務，請執行以下指令：
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --state=inactive --type=service ceph*
</screen>
   <para>
    您也可以使用 <command>salt</command> 查詢多個節點上的服務：
   </para>
<screen>
<prompt>root@master # </prompt>salt <replaceable>TARGET</replaceable> cmd.shell \
 "systemctl list-units --all --type=service ceph* | sed -e '/^$/,$ d'"
</screen>
   <para>
    僅查詢儲存節點：
   </para>
<screen>
<prompt>root@master # </prompt>salt -I 'roles:storage' cmd.shell \
 'systemctl list-units --all --type=service ceph*'
</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>服務狀態</title>
   <para>
    您可以查詢 <systemitem class="daemon">systemd</systemitem> 來瞭解服務的狀態。例如：
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    請以用於執行精靈的主機名稱取代 <replaceable>HOSTNAME</replaceable>。
   </para>
   <para>
    如果您不知道服務的確切名稱/編號，請參閱<xref linkend="ceph-operating-services-finding-names"/>。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea-restart">
  <title>使用 DeepSea 重新啟動 Ceph 服務</title>

  <para>
   將更新套用至叢集節點後，需要重新啟動與 Ceph 相關的受影響服務。通常情況下，DeepSea 會自動執行重新啟動操作。本節介紹如何手動重新啟動服務。
  </para>

  <tip>
   <title>監看重新啟動</title>
   <para>
    重新啟動叢集的過程可能需要一段時間。您可以透過執行以下指令來使用 Salt 事件匯流排監看事件：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
   <para>
    另一個用於監控使用中工作的指令為：
   </para>
<screen>
<prompt>root@master # </prompt>salt-run jobs.active
</screen>
  </tip>

  <sect2 xml:id="deepsea-restart-all">
   <title>重新啟動所有服務</title>
   <warning>
    <title>服務中斷</title>
    <para>
     如果與 Ceph 相關的服務 (特別是 iSCSI 或 NFS Ganesha) 設定為單點存取，並且未設定高可用性，重新啟動這些服務將導致從用戶端進行檢視時會出現暫時中斷現象。
    </para>
   </warning>
   <tip>
    <title>Samba 不受 DeepSea 管理</title>
    <para>
     由於 DeepSea 和 Ceph Dashboard 目前不支援 Samba 部署，您需要手動管理與 Samba 相關的服務。如需詳細資訊，請參閱<xref linkend="cha-ses-cifs"/>。
    </para>
   </tip>
   <para>
    若要重新啟動叢集上的<emphasis>所有</emphasis>服務，請執行以下指令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <itemizedlist>
    <listitem>
     <para>
      如果 DeepSea 版本低於 0.8.4，則中繼資料伺服器、iSCSI 閘道、物件閘道和 NFS Ganesha 服務將平行重新啟動。
     </para>
    </listitem>
    <listitem>
     <para>
      如果 DeepSea 為 0.8.4 或更新版本，您已設定的所有角色將依以下順序重新啟動：Ceph 監控程式、Ceph 管理員、Ceph OSD、中繼資料伺服器、物件閘道、iSCSI 閘道、NFS Ganesha。為了保持較短的停機時間並儘早發現潛在問題，請循序重新啟動各節點。例如，一次僅重新啟動一個監控節點。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    如果叢集處於降級、不良的狀態，該指令會等待叢集復原。
   </para>
  </sect2>

  <sect2 xml:id="deepsea-restart-specific">
   <title>重新啟動特定服務</title>
   <para>
    若要重新啟動叢集上的特定服務，請執行以下指令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    例如，若要重新啟動所有物件閘道，請執行以下指令：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    您可以使用以下目標：
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>正常關閉整個 Ceph 叢集</title>

  <para>
   在某些情況下，您需要依建議的順序停止叢集中所有與 Ceph 相關的服務，然後才能再次依任意順序將其啟動。例如，發生計劃中停電的情況時。
  </para>

  <para>
   若要關閉整個 Ceph 叢集，請停用安全措施並執行 <command>ceph.shutdown</command> 執行程式：
  </para>

<screen>
<prompt>root@master # </prompt>salt-run disengage.safety
<prompt>root@master # </prompt>salt-run state.orch ceph.shutdown
</screen>

  <para>
   若要啟動整個 Ceph 叢集，請執行 <command>ceph.startup</command> 執行程式：
  </para>

<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.startup
</screen>
 </sect1>
</chapter>
