<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="containerized-kubernetes.xml" version="5.0" xml:id="cha-container-kubernetes">

 <title>SUSE Enterprise Storage 6 sobre clúster de Kubernetes de SUSE CaaS Platform 4</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/master/xml/</dm:editurl>
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>editar</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>sí</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <warning>
  <title>tecnología en fase preliminar</title>
  <para>
   Ejecutar clústeres de Ceph en contenedores en SUSE CaaS Platform es una tecnología en fase preliminar. No realice la distribución en un clúster de Kubernetes de producción.
  </para>
 </warning>
 <para>
  En este capítulo se describe cómo distribuir SUSE Enterprise Storage 6 en contenedores sobre el clúster de Kubernetes de SUSE CaaS Platform 4.
 </para>
 <sect1 xml:id="kube-consider">
  <title>Observaciones</title>

  <para>
   Antes de iniciar la distribución, tenga en cuenta los puntos siguientes:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Para ejecutar Ceph en Kubernetes, SUSE Enterprise Storage 6 utiliza un proyecto de fases anteriores denominado Rook (<link xlink:href="https://rook.io/"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Dependiendo de la configuración, Rook puede consumir <emphasis>todos</emphasis> los discos sin utilizar de todos los nodos de un clúster de Kubernetes.
    </para>
   </listitem>
   <listitem>
    <para>
     La configuración requiere contenedores con privilegios.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-prereq">
  <title>Requisitos previos</title>

  <para>
   Antes de iniciar la distribución, debe tener lo siguiente:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Un clúster de SUSE CaaS Platform 4 en ejecución.
    </para>
   </listitem>
   <listitem>
    <para>
     Nodos de trabajo de SUSE CaaS Platform 4 con varios discos adicionales conectados como almacenamiento para el clúster de Ceph.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-rook-manifests">
  <title>Obtención de manifiestos de Rook</title>

  <para>
   El orquestador Rook utiliza archivos de configuración en formato YAML denominados <emphasis>manifiestos</emphasis>. Los manifiestos que se necesitan están incluidos en el paquete RPM
   <package>rook-k8s-yaml</package>. Para instalarlo, ejecute:
  </para>

<screen><prompt>root # </prompt>zypper install rook-k8s-yaml</screen>
 </sect1>
 <sect1 xml:id="kube-install">
  <title>Instalación</title>

  <para>
   Rook-Ceph incluye dos componentes principales: el "operador" que es ejecutado por Kubernetes y permite la creación de clústeres de Ceph, y el propio "clúster" de Ceph que es creado y administrado parcialmente por el operador.
  </para>

  <sect2 xml:id="kube-configure">
   <title>Configuración</title>
   <sect3 xml:id="kube-configure-global">
    <title>Configuración global</title>
    <para>
     Los manifiestos utilizados en esta configuración instalan todos los componentes de Rook y Ceph en el espacio de nombres "rook-ceph". Si necesita cambiarlo, adopte en consecuencia todas las referencias al espacio de nombres en los manifiestos de Kubernetes.
    </para>
    <para>
     Dependiendo de las características de Rook que tenga previstas usar, modifique la configuración de "Política de seguridad de pods" en <filename>common.yaml</filename> para limitar los requisitos de seguridad de Rook. Consulte los comentarios del archivo de manifiesto.
    </para>
   </sect3>
   <sect3 xml:id="kube-config-operator">
    <title>Configuración del operador</title>
    <para>
     El manifiesto <filename>operator.yaml</filename> configura el operador de Rook. Por lo general, no es necesario efectuar ningún cambio. Encontrará más información en los comentarios del archivo de manifiesto.
    </para>
   </sect3>
   <sect3 xml:id="kube-config-ceph">
    <title>Configuración del clúster de Ceph</title>
    <para>
     El manifiesto <filename>cluster.yaml</filename> es el responsable de configurar el clúster de Ceph actual que se ejecutará en Kubernetes. Encontrará una descripción detallada de todas las opciones disponibles en la documentación de Rook en <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html"/>.
    </para>
    <para>
     Por defecto, Rook está configurado para utilizar todos los nodos que no están contaminados con <option>node-role.kubernetes.io/master:NoSchedule</option> y aceptará los ajustes de colocación configurados (consulte <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html#placement-configuration-settings"/>). En el ejemplo siguiente, se inhabilita este comportamiento y solo se utilizan los nodos mostrados explícitamente en la sección de nodos:
    </para>
<screen>
storage:
  useAllNodes: false
  nodes:
    - name: caasp4-worker-0
    - name: caasp4-worker-1
    - name: caasp4-worker-2
</screen>
    <note>
     <para>
      Por defecto, Rook está configurado para usar todos los discos libres y vacíos de cada nodo para su uso como almacenamiento de Ceph.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="kube-config-docs">
    <title>Documentación</title>
    <itemizedlist>
     <listitem>
      <para>
       La documentación de Rook-Ceph de <link xlink:href="https://rook.github.io/docs/rook/master/ceph-storage.html"/> contiene información más detallada sobre la configuración de distribuciones más avanzadas. Utilícela como referencia para comprender los conceptos básicos de Rook-Ceph antes de realizar configuraciones más avanzadas.
      </para>
     </listitem>
     <listitem>
      <para>
       Encontrará más detalles sobre el producto SUSE CaaS Platform en <link xlink:href="https://www.suse.com/documentation/suse-caasp"/>.
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>

  <sect2 xml:id="kube-config-rook-operator">
   <title>Creación del operador de Rook</title>
   <para>
    Para instalar los componentes comunes de Rook-Ceph, las funciones CSI y el operador Rook-Ceph, ejecute el comando siguiente en el nodo master de SUSE CaaS Platform:
   </para>
<screen><prompt>root # </prompt>kubectl apply -f common.yaml -f operator.yaml</screen>
   <para>
    <filename>common.yaml</filename> creará el espacio de nombres "rook-ceph"; definiciones de recursos personalizados de Ceph (CRD, consulte <link xlink:href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/"/>) para que Kubernetes tenga constancia de los objetos de Ceph (por ejemplo, "CephCluster"), y las funciones RBAC y las directivas de seguridad de pods (consulte <link xlink:href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/"/>), que son necesarias para permitir que Rook gestione los recursos específicos del clúster.
   </para>
   <tip>
    <title>uso de <option>hostNetwork</option> y <option>hostPorts</option></title>
    <para>
     Si en la definición de recursos del clúster se usa <option>hostNetwork: true</option> es necesario usar <option>hostNetwork</option>. También es necesario usar <option>hostPorts</option> en <literal>PodSecurityPolicy</literal>.
    </para>
   </tip>
   <para>
    Verifique la instalación ejecutando <command>kubectl get pods -n rook-ceph</command> en el nodo master de SUSE CaaS Platform, por ejemplo:
   </para>
<screen><prompt>root # </prompt>kubectl get pods -n rook-ceph
NAME                                     READY   STATUS      RESTARTS   AGE
rook-ceph-agent-57c9j                    1/1     Running     0          22h
rook-ceph-agent-b9j4x                    1/1     Running     0          22h
rook-ceph-operator-cf6fb96-lhbj7         1/1     Running     0          22h
rook-discover-mb8gv                      1/1     Running     0          22h
rook-discover-tztz4                      1/1     Running     0          22h</screen>
  </sect2>

  <sect2 xml:id="kube-create-ceph-cluster">
   <title>Creación del clúster de Ceph</title>
   <para>
    Después de modificar <filename>cluster.yaml</filename> según sus necesidades, puede crear el clúster de Ceph. Ejecute el comando siguiente en el nodo master de SUSE CaaS Platform:
   </para>
<screen><prompt>root # </prompt>kubectl apply -f cluster.yaml</screen>
   <para>
    Observe el espacio de nombres "rook-ceph" para comprobar qué clúster de Ceph se va a crear. Verá tantos monitores Ceph Monitor como haya configurados en el manifiesto <filename>cluster.yaml</filename> (el valor por defecto es 3), una instancia de Ceph Manager y tantos daemons Ceph OSD como discos libres tenga.
   </para>
   <tip>
    <title>pods OSD temporales</title>
    <para>
     Al arrancar el clúster de Ceph, verá ejecutarse algunos pods con el nombre <literal>rook-ceph-osd-prepare-<replaceable>NOMBRE-NODO</replaceable></literal> durante un tiempo que, después, terminarán con el estado "Completado". Como su nombre indica, estos pods sirven para provisionar los Ceph OSD. No se suprimen para que pueda inspeccionar sus registros cuando terminen. Por ejemplo:
    </para>
<screen><prompt>root # </prompt>kubectl get pods --namespace rook-ceph
NAME                                         READY  STATUS     RESTARTS  AGE
rook-ceph-agent-57c9j                        1/1    Running    0         22h
rook-ceph-agent-b9j4x                        1/1    Running    0         22h
rook-ceph-mgr-a-6d48564b84-k7dft             1/1    Running    0         22h
rook-ceph-mon-a-cc44b479-5qvdb               1/1    Running    0         22h
rook-ceph-mon-b-6c6565ff48-gm9wz             1/1    Running    0         22h
rook-ceph-operator-cf6fb96-lhbj7             1/1    Running    0         22h
rook-ceph-osd-0-57bf997cbd-4wspg             1/1    Running    0         22h
rook-ceph-osd-1-54cf468bf8-z8jhp             1/1    Running    0         22h
rook-ceph-osd-prepare-caasp4-worker-0-f2tmw  0/2    Completed  0         9m35s
rook-ceph-osd-prepare-caasp4-worker-1-qsfhz  0/2    Completed  0         9m33s
rook-ceph-tools-76c7d559b6-64rkw             1/1    Running    0         22h
rook-discover-mb8gv                          1/1    Running    0         22h
rook-discover-tztz4                          1/1    Running    0         22h</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="kube-using-rook">
  <title>Uso de Rook como almacenamiento para la carga de trabajo de Kubernetes</title>

  <para>
   Rook permite utilizar tres tipos diferentes de almacenamiento:
  </para>

  <variablelist>
   <varlistentry>
    <term><emphasis role="bold">Almacenamiento de objeto</emphasis></term>
    <listitem>
     <para>
      El almacenamiento de objeto expone una API de S3 al clúster de almacenamiento para que las aplicaciones coloquen y obtengan datos. Consulte <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-object.html"/> para obtener una descripción detallada.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Sistema de archivos compartido</term>
    <listitem>
     <para>
      Es posible montar un sistema de archivos compartido con permisos de lectura y escritura desde varios pods. Esto resulta útil para las aplicaciones que se agrupan en clúster mediante un sistema de archivos compartido. Consulte <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-filesystem.html"/> para obtener una descripción detallada.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Almacenamiento de bloques</term>
    <listitem>
     <para>
      El almacenamiento de bloques permite montar el almacenamiento en un solo pod. Consulte <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-block.html"/> para obtener una descripción detallada.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="kube-uninstall">
  <title>Desinstalación de Rook</title>

  <para>
   Para desinstalar Rook, siga estos pasos:
  </para>

  <procedure>
   <step>
    <para>
     Suprima todas las aplicaciones de Kubernetes que consuman almacenamiento de Rook.
    </para>
   </step>
   <step>
    <para>
     Suprima todos los objetos, archivos o artefactos de almacenamiento de bloques que haya creado siguiendo las instrucciones de la <xref linkend="kube-using-rook"/>.
    </para>
   </step>
   <step>
    <para>
     Suprima el clúster de Ceph, el operador y los recursos relacionados:
    </para>
<screen>
<prompt>root # </prompt>kubectl delete -f cluster.yaml
<prompt>root # </prompt>kubectl delete -f operator.yaml
<prompt>root # </prompt>kubectl delete -f common.yaml
</screen>
   </step>
   <step>
    <para>
     Suprima los datos de los hosts:
    </para>
<screen><prompt>root # </prompt>rm -rf /var/lib/rook</screen>
   </step>
   <step>
    <para>
     Si fuera necesario, limpie los discos utilizados por Rook. Consulte <link xlink:href="https://rook.io/docs/rook/master/ceph-teardown.html"/> para obtener más información.
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
