<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_rbd.xml" version="5.0" xml:id="ceph-rbd">
 <title>Dispositivo de bloques RADOS</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/maintenance/ses6/xml/</dm:editurl>
   <dm:translation>sí</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Un bloque es una secuencia de bytes, por ejemplo, un bloque de 4 MB de datos. Las interfaces de almacenamiento basadas en bloques son la forma más habitual de almacenar los datos en soportes de uso rotativo, como discos duros, CD o disquetes. La ubicuidad de las interfaces de dispositivos de bloques hacen que un dispositivo de bloques virtual sea el candidato idóneo para interactuar con un sistema de almacenamiento masivo de datos como Ceph.
 </para>
 <para>
  Los dispositivos de bloques de Ceph permiten compartir recursos físicos y se puede modificar su tamaño. Los datos se almacenan repartidos en varios OSD en un clúster de Ceph. Los dispositivos de bloques de Ceph aprovechan las funciones de RADOS, como la realización de instantáneas, las réplicas y la comprobación de coherencia. Los dispositivos de bloques RADOS (RBD) de Ceph interactúan con los OSD mediante módulos del kernel o la biblioteca <systemitem>librbd</systemitem>.
 </para>
 <figure>
  <title>Protocolo RADOS</title>
  <mediaobject>
   <imageobject role="fo">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
   <imageobject role="html">
    <imagedata fileref="ceph_rbd_schema.png" width="70%" format="PNG"/>
   </imageobject>
  </mediaobject>
 </figure>
 <para>
  Los dispositivos de bloques de Ceph ofrecen un alto rendimiento con infinitas posibilidades de escalabilidad para los módulos de kernel. Son compatibles con soluciones de virtualización como QEMU o sistemas informáticos basados en la nube que dependen de <systemitem class="library">libvirt</systemitem>, como OpenStack. Puede utilizar el mismo clúster para gestionar Object Gateway, CephFS y los dispositivos de bloques RADOS al mismo tiempo.
 </para>
 <sect1 xml:id="ceph-rbd-commands">
  <title>Comandos del dispositivo de bloques</title>

  <para>
   El comando <command>rbd</command> permite crear, enumerar, examinar y eliminar imágenes de los dispositivos de bloques. También se puede emplear, por ejemplo, para clonar imágenes, crear instantáneas, revertir una imagen al estado de una instantánea o ver una instantánea.
  </para>

  <sect2 xml:id="ceph-rbd-cmds-create">
   <title>Creación de una imagen del dispositivo de bloques en un repositorio replicado</title>
   <para>
    Antes de poder añadir un dispositivo de bloques a un cliente, debe crear una imagen relacionada en un repositorio existente (consulte el <xref linkend="ceph-pools"/>):
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>rbd create --size <replaceable>MEGABYTES</replaceable> <replaceable>POOL-NAME</replaceable>/<replaceable>IMAGE-NAME</replaceable>
</screen>
   <para>
    Por ejemplo, para crear una imagen de 1 GB denominada "myimage" que almacena información en un repositorio llamado "mypool", ejecute lo siguiente:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd create --size 1024 mypool/myimage</screen>
   <tip>
    <title>unidades de tamaño de imagen</title>
    <para>
     Si omite un acceso directo de unidad de tamaño ("G" o "T"), el tamaño de la imagen se indicará en megabytes. Utilice "G" o "T" después del número de tamaño para especificar gigabytes o terabytes.
    </para>
   </tip>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-create-ec">
   <title>Creación de una imagen del dispositivo de bloques en un repositorio codificado de borrado</title>
   <para>
    A partir de SUSE Enterprise Storage 5, es posible almacenar datos de una imagen de dispositivo de bloques directamente en repositorios codificados de borrado. Una imagen de dispositivo de bloques RADOS está formada por elementos de <emphasis>datos</emphasis> y <emphasis>metadatos</emphasis>. Solo se puede almacenar la parte de "datos" de una imagen de dispositivo de bloques RADOS en un repositorio codificado de borrado. El repositorio debe tener el valor <emphasis>true</emphasis> definido en el indicador "overwrite", y eso solo es posible si todos los OSD donde se almacena el repositorio utilizan BlueStore.
   </para>
   <para>
    No se puede almacenar la parte de "metadatos" de la imagen en un repositorio codificado de borrado. Debe especificar el repositorio replicado para almacenar los metadatos de la imagen con la opción <option>‑‑pool</option> del comando <command>rbd create</command>.
   </para>
   <para>
    Lleve a cabo los pasos siguientes para crear una imagen RBD en un repositorio codificado de borrado recién creado:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt><command>ceph</command> osd pool create <replaceable>POOL_NAME</replaceable> 12 12 erasure
<prompt>cephadm@adm &gt; </prompt><command>ceph</command> osd pool set <replaceable>POOL_NAME</replaceable> allow_ec_overwrites true

#Metadata will reside in pool "<replaceable>OTHER_POOL</replaceable>", and data in pool "<replaceable>POOL_NAME</replaceable>"
<prompt>cephadm@adm &gt; </prompt><command>rbd</command> create <replaceable>IMAGE_NAME</replaceable> --size=1G --data-pool <replaceable>POOL_NAME</replaceable> --pool=<replaceable>OTHER_POOL</replaceable></screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-list">
   <title>Enumeración de imágenes de dispositivos de bloques</title>
   <para>
    Para mostrar los dispositivos de bloques en un repositorio denominado "mypool", ejecute lo siguiente:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd ls mypool</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-info">
   <title>Recuperación de información de la imagen</title>
   <para>
    Para recuperar información de una imagen denominada "myimage" dentro de un repositorio denominado "mypool", ejecute lo siguiente:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd info mypool/myimage</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-resize">
   <title>Cambio de tamaño de la imagen de un dispositivo de bloques</title>
   <para>
    Las imágenes de los dispositivos de bloques RADOS emplean un sistema de provisión ligera, lo que significa que no emplean espacio físico real hasta que empieza a guardar datos en ellos. No obstante, tienen una capacidad máxima que se define mediante la opción <option>‑‑size</option>. Si desea aumentar (o reducir) el tamaño máximo de la imagen (o disminuir), ejecute lo siguiente:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>rbd resize --size 2048 <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable> # to increase
<prompt>cephadm@adm &gt; </prompt>rbd resize --size 2048 <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable> --allow-shrink # to decrease
</screen>
  </sect2>

  <sect2 xml:id="ceph-rbd-cmds-rm">
   <title>Eliminación de una imagen de dispositivo de bloques</title>
   <para>
    Para eliminar un dispositivo de bloques que se corresponde con una imagen llamada "myimage" en un repositorio denominado "mypool", ejecute lo siguiente:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd rm mypool/myimage</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="storage-bp-integration-mount-rbd">
  <title>Montaje y desmontaje</title>

  <para>
   Después de crear un dispositivo de bloques RADOS, puede usarlo como cualquier otro dispositivo de disco: formatearlo, montarlo para que permita el intercambio de archivos y desmontarlo cuando haya terminado.
  </para>

  <procedure>
   <step>
    <para>
     Asegúrese de que el clúster de Ceph incluye un repositorio con la imagen de disco que desea asignar. Supongamos que el repositorio se denomina <literal>mypool</literal> y la imagen <literal>myimage</literal>.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd list mypool</screen>
   </step>
   <step>
    <para>
     Asigne la imagen a un nuevo dispositivo de bloques.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd map --pool mypool myimage</screen>
    <tip>
     <title>nombre de usuario y autenticación</title>
     <para>
      Para especificar un nombre de usuario, utilice <option>‑‑id <replaceable>nombre de usuario</replaceable></option>. Si utiliza la autenticación de <systemitem>cephx</systemitem>, también debe especificar un secreto. Puede proceder de un anillo de claves o de un archivo que contenga el secreto:
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd map --pool rbd myimage --id admin --keyring /path/to/keyring</screen>
     <para>
      O bien
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd map --pool rbd myimage --id admin --keyfile /path/to/file</screen>
    </tip>
   </step>
   <step>
    <para>
     Enumerar todos los dispositivos asignados:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd showmapped
 id pool   image   snap device
 0  mypool myimage -    /dev/rbd0</screen>
    <para>
     El dispositivo en el que queremos trabajar es <filename>/dev/rbd0</filename>.
    </para>
    <tip>
     <title>vía del dispositivo RBD</title>
     <para>
      En lugar de <filename>/dev/rbd<replaceable>NÚMERO_DISPOSITIVO</replaceable></filename>, puede utilizar <filename>/dev/rbd/<replaceable>NOMBRE_REPOSITORIO</replaceable>/<replaceable>NOMBRE_IMAGEN</replaceable></filename> como vía persistente del dispositivo. Por ejemplo:
     </para>
<screen>
/dev/rbd/mypool/myimage
</screen>
    </tip>
   </step>
   <step>
    <para>
     Cree un sistema de archivos XFS en el dispositivo <filename>/dev/rbd0</filename>.
    </para>
<screen><prompt>root # </prompt>mkfs.xfs /dev/rbd0
 log stripe unit (4194304 bytes) is too large (maximum is 256KiB)
 log stripe unit adjusted to 32KiB
 meta-data=/dev/rbd0              isize=256    agcount=9, agsize=261120 blks
          =                       sectsz=512   attr=2, projid32bit=1
          =                       crc=0        finobt=0
 data     =                       bsize=4096   blocks=2097152, imaxpct=25
          =                       sunit=1024   swidth=1024 blks
 naming   =version 2              bsize=4096   ascii-ci=0 ftype=0
 log      =internal log           bsize=4096   blocks=2560, version=2
          =                       sectsz=512   sunit=8 blks, lazy-count=1
 realtime =none                   extsz=4096   blocks=0, rtextents=0</screen>
   </step>
   <step>
    <para>
     Monte el dispositivo y compruebe que está montado correctamente. Sustituya <filename>/mnt</filename> por el punto de montaje.
    </para>
<screen><prompt>root # </prompt>mount /dev/rbd0 /mnt
<prompt>root # </prompt>mount | grep rbd0
/dev/rbd0 on /mnt type xfs (rw,relatime,attr2,inode64,sunit=8192,...</screen>
    <para>
     Ya puede mover datos al dispositivo y desde él como si fuese un directorio local.
    </para>
    <tip>
     <title>Aumento del tamaño del dispositivo RBD</title>
     <para>
      Si descubre que el tamaño del dispositivo RBD es insuficiente, puede aumentarlo con facilidad.
     </para>
     <orderedlist spacing="normal">
      <listitem>
       <para>
        Aumente el tamaño de la imagen RBD, por ejemplo, hasta 10 GB.
       </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd resize --size 10000 mypool/myimage
 Resizing image: 100% complete...done.</screen>
      </listitem>
      <listitem>
       <para>
        Aumente el sistema de archivos hasta llenar el nuevo tamaño del dispositivo.
       </para>
<screen><prompt>root # </prompt>xfs_growfs /mnt
 [...]
 data blocks changed from 2097152 to 2560000</screen>
      </listitem>
     </orderedlist>
    </tip>
   </step>
   <step>
    <para>
     Cuando termine de acceder al dispositivo, puede desasignarlo y desmontarlo.
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>rbd unmap /dev/rbd0
<prompt>root # </prompt>unmount /mnt
</screen>
   </step>
  </procedure>

  <tip>
   <title>montaje o desmontaje manual</title>
   <para>
    Dado que asignar y montar las imágenes RBD manualmente después del arranque y desmontarlas y desasignarlas antes de apagar el equipo puede resultar tedioso, se proporciona un guion <command>rbdmap</command> y una unidad <systemitem class="daemon">systemd</systemitem>. Consulte la <xref linkend="ceph-rbd-rbdmap"/>.
   </para>
  </tip>

  <sect2 xml:id="ceph-rbd-rbdmap">
   <title>rbdmap: asignación de dispositivos RBD durante el arranque</title>
   <para>
    <command>rbdmap</command> es un guion de shell que automatiza las operaciones <command>rbd map</command> y <command>rbd unmap</command> en una o varias imágenes RBD. Aunque es posible ejecutar el guion manualmente en cualquier momento, la ventaja principal consiste en asignar y montar automáticamente las imágenes RBD durante el arranque (y desmontarlas y desasignarlas al apagar el equipo), activándose mediante el sistema Init. Con este fin, el paquete <systemitem>ceph-common</systemitem> incluye el archivo de unidad <systemitem class="daemon">systemd</systemitem> <filename>rbdmap.service</filename>.
   </para>
   <para>
    El guion solo acepta un argumento, que puede ser <option>map</option> o <option>unmap</option>. En ambos casos, el guion analiza un archivo de configuración. Se utiliza <filename>/etc/ceph/rbdmap</filename> por defecto, pero se puede anular mediante una variable de entorno <literal>RBDMAPFILE</literal>. Cada línea del archivo de configuración se corresponde con una imagen RBD que se debe asignar o desasignar.
   </para>
   <para>
    El archivo de configuración tiene el formato siguiente:
   </para>
<screen>image_specification rbd_options</screen>
   <variablelist>
    <varlistentry>
     <term><option>image_specification</option></term>
     <listitem>
      <para>
       Vía a una imagen dentro de un repositorio. Se debe especificar como <replaceable>nombre_repositorio</replaceable>/<replaceable>nombre_imagen</replaceable>.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><option>rbd_options</option></term>
     <listitem>
      <para>
       Una lista opcional de parámetros que se puedan pasar al comando <command>rbd map</command> subyacente. Estos parámetros y sus valores se deben especificar como una cadena separada por comas, por ejemplo:
      </para>
<screen>PARAM1=VAL1,PARAM2=VAL2,...</screen>
      <para>
       El ejemplo hace que el guion <command>rbdmap</command> ejecute el siguiente comando:
      </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd map <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable> --PARAM1 VAL1 --PARAM2 VAL2</screen>
      <para>
       En el ejemplo siguiente puede se explica cómo especificar un nombre de usuario y un anillo de claves con un secreto correspondiente:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>rbdmap map mypool/myimage id=rbd_user,keyring=/etc/ceph/ceph.client.rbd.keyring
</screen>
     </listitem>
    </varlistentry>
   </variablelist>
   <para>
    Si se ejecuta como <command>rbdmap map</command>, el guion analiza el archivo de configuración y, para cada imagen RBD especificada, primero intenta asignar la imagen (mediante el comando <command>rbd map</command>) y luego montarla.
   </para>
   <para>
    Si se ejecuta como <command>rbdmap unmap</command>, las imágenes enumeradas en el archivo de configuración se desmontarán y se desasignarán.
   </para>
   <para>
    <command>rbdmap unmap-all</command> intenta desmontar y posteriormente desasignar todas las imágenes RBD asignadas actualmente, independientemente de que estén enumeradas o no en el archivo de configuración.
   </para>
   <para>
    Si la operación se realiza correctamente, rbd map asigna la imagen a un dispositivo /dev/rbdX, momento en el que se activa una regla udev para crear un enlace simbólico de nombre de dispositivo de confianza <filename>/dev/rbd/<replaceable>nombre_repositorio</replaceable>/<replaceable>nombre_imagen</replaceable></filename> que señala al dispositivo real asignado.
   </para>
   <para>
    Para que las operaciones de montaje y desmontaje se lleven a cabo correctamente, el nombre del dispositivo de confianza debe tener una entrada correspondiente en <filename>/etc/fstab</filename>. Al escribir entradas <filename>/etc/fstab</filename> para imágenes RBD, especifique la opción de montaje "noauto" (o "nofail"). Esto impide que el sistema Init intente montar el dispositivo demasiado pronto, antes de que el dispositivo en cuestión aún exista, ya que <filename>rbdmap.service</filename> normalmente se activa bastante tarde en la secuencia de arranque.
   </para>
   <para>
    Para una lista completa de opciones de <command>rbd</command>, consulte la página man de <command>rbd</command> (<command>man 8 rbd</command>).
   </para>
   <para>
    Para consultar ejemplos de uso de <command>rbdmap</command>, consulte la página man de <command>rbdmap</command> (<command>man 8 rbdmap</command>).
   </para>
  </sect2>

  <sect2>
   <title>aumento del tamaño del dispositivo RBD</title>
   <para>
    Si descubre que el tamaño del dispositivo RBD es insuficiente, puede aumentarlo con facilidad.
   </para>
   <orderedlist spacing="normal">
    <listitem>
     <para>
      Aumente el tamaño de la imagen RBD, por ejemplo, hasta 10 GB.
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd resize --size 10000 mypool/myimage
 Resizing image: 100% complete...done.</screen>
    </listitem>
    <listitem>
     <para>
      Aumente el sistema de archivos hasta llenar el nuevo tamaño del dispositivo.
     </para>
<screen><prompt>root # </prompt>xfs_growfs /mnt
 [...]
 data blocks changed from 2097152 to 2560000</screen>
    </listitem>
   </orderedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="cha-ceph-snapshots-rbd">
  <title>Instantáneas</title>

  <para>
   Una instantánea RBD es una instantánea de una imagen de dispositivo de bloques RADOS. Las instantáneas permiten conservar un historial de los estados de la imagen. Ceph también es compatible con capas de instantáneas, lo que permite clonar imágenes de máquinas virtuales de forma rápida y sencilla. Ceph admite las instantáneas de dispositivos de bloques mediante el comando <command>rbd</command> y muchas interfaces de alto nivel, incluidas QEMU, <systemitem>libvirt</systemitem>, OpenStack y CloudStack.
  </para>

  <note>
   <para>
    Detenga las operaciones de entrada y salida y vacíe todas las escrituras pendientes antes de tomar una instantánea de una imagen. Si la imagen contiene un sistema de archivos, este debe tener un estado coherente en el momento de realizar la instantánea.
   </para>
  </note>

  <sect2>
   <title>Notas de cephx</title>
   <para>
    Si <systemitem>cephx</systemitem> está habilitado, debe especificar un nombre de usuario o ID y una vía al anillo de claves que contiene la clave correspondiente para el usuario. Consulte el <xref linkend="cha-storage-cephx"/> para obtener más información. También puede añadir la variable de entorno <systemitem>CEPH_ARGS</systemitem> para evitar la reintroducción de los siguientes parámetros.
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --id <replaceable>user-ID</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd --name <replaceable>username</replaceable> --keyring=/path/to/secret <replaceable>commands</replaceable></screen>
   <para>
    Por ejemplo:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --id admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd --name client.admin --keyring=/etc/ceph/ceph.keyring <replaceable>commands</replaceable></screen>
   <tip>
    <para>
     Añada el usuario y el secreto a la variable de entorno <systemitem>CEPH_ARGS</systemitem> para no tener que introducir estos datos en cada ocasión.
    </para>
   </tip>
  </sect2>

  <sect2>
   <title>Conceptos básicos de la instantánea</title>
   <para>
    Los procedimientos siguientes muestran cómo crear, enumerar y eliminar instantáneas mediante el comando <command>rbd</command> en la línea de comandos.
   </para>
   <sect3>
    <title>Creación de instantáneas</title>
    <para>
     Para crear una instantánea con <command>rbd</command>, especifique la opción <option>snap create</option>, el nombre del repositorio y el nombre de la imagen.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> snap create --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd snap create <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool rbd snap create --snap snapshot1 image1
<prompt>cephadm@adm &gt; </prompt>rbd snap create rbd/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Enumeración de instantáneas</title>
    <para>
     Para enumerar las instantáneas de una imagen, especifique el nombre del repositorio y el de la imagen.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> snap ls <replaceable>image-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd snap ls <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool rbd snap ls image1
<prompt>cephadm@adm &gt; </prompt>rbd snap ls rbd/image1</screen>
   </sect3>
   <sect3>
    <title>Reversión de instantáneas</title>
    <para>
     Para revertir una instantánea con <command>rbd</command>, especifique la opción <option>snap rollback</option>, el nombre del repositorio, el nombre de la imagen y el nombre de la instantánea.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rollback --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd snap rollback <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool pool1 snap rollback --snap snapshot1 image1
<prompt>cephadm@adm &gt; </prompt>rbd snap rollback pool1/image1@snapshot1</screen>
    <note>
     <para>
      Revertir una imagen a una instantánea significa sobrescribir la versión actual de la imagen con los datos de la instantánea. El tiempo necesario para ejecutar una reversión aumenta según el tamaño de la imagen. Es más rápido <emphasis>clonar</emphasis> una instantánea que <emphasis>revertir</emphasis> una imagen a una instantánea, por lo que es el método preferible para volver a un estado preexistente.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Supresión de una instantánea</title>
    <para>
     Para suprimir una instantánea con <command>rbd</command>, especifique la opción <option>snap rm</option>, el nombre del repositorio, el nombre de la imagen y el nombre de usuario.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> snap rm --snap <replaceable>snap-name</replaceable> <replaceable>image-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd snap rm <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snap-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool pool1 snap rm --snap snapshot1 image1
<prompt>cephadm@adm &gt; </prompt>rbd snap rm pool1/image1@snapshot1</screen>
    <note>
     <para>
      Los OSD de Ceph suprimen los datos de forma asíncrona, por lo que al suprimir una instantánea, no se libera el espacio de disco inmediatamente.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Limpieza de instantáneas</title>
    <para>
     Para suprimir todas las instantáneas de una imagen con <command>rbd</command>, especifique la opción <option>snap purge</option> y el nombre de la imagen.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> snap purge <replaceable>image-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd snap purge <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool pool1 snap purge image1
<prompt>cephadm@adm &gt; </prompt>rbd snap purge pool1/image1</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph-snapshoti-layering">
   <title>Capas</title>
   <para>
    Ceph admite la posibilidad de crear varios clones de copia de escritura (COW, por sus siglas en inglés) de una instantánea de dispositivo de bloques. Las capas de instantáneas permiten que los clientes de dispositivos de bloques de Ceph creen imágenes muy rápidamente. Por ejemplo, puede crear una imagen de dispositivo de bloques con una máquina virtual Linux escrita en él y, a continuación, realizar una instantánea de la imagen, protegerla y crear tantos clones de copia de escritura como desee. Las instantáneas son de solo lectura, por lo que clonar una instantánea simplifica la semántica y permite crear clones rápidamente.
   </para>
   <note>
    <para>
     Los términos "parent" (padre) y "child" (hijo) mencionados en los siguientes ejemplos de la línea de comandos hacen referencia a una instantánea de un dispositivo de bloques de Ceph (padre) y la imagen correspondiente clonada de la instantánea (hijo).
    </para>
   </note>
   <para>
    Cada imagen clonada (hijo) almacena una referencia a su imagen padre que permite que la imagen clonada abra la instantánea padre y la lea.
   </para>
   <para>
    Un clon COW de una instantánea se comporta exactamente igual que cualquier otra imagen de dispositivo de bloques de Ceph. Puede leer las imágenes clonadas, escribir en ellas, clonarlas y redimensionarlas. No existen restricciones especiales que afecten a las imágenes clonadas. No obstante, la clonación de copia de escritura de una instantánea hace referencia a la instantánea, por lo que <emphasis>debe</emphasis> proteger la instantánea antes de clonarla.
   </para>
   <note>
    <title><option>‑‑image-format 1</option> no se admite</title>
    <para>
     No es posible crear instantáneas de imágenes creadas con la opción obsoleta <command>rbd create ‑‑image-format 1</command>. Ceph solo admite la clonación de las imágenes <emphasis>format 2</emphasis> por defecto.
    </para>
   </note>
   <sect3>
    <title>Procedimientos iniciales con las capas</title>
    <para>
     La aplicación de capas a un dispositivo de bloques de Ceph es un proceso sencillo. Debe disponer de una imagen. Debe crear una instantánea de la imagen. Debe proteger la instantánea. Una vez realizados estos pasos, puede empezar a clonar la instantánea.
    </para>
    <para>
     La imagen clonada tendrá una referencia a la instantánea padre e incluirá el ID del repositorio, el ID de la imagen y el ID de la instantánea. La inclusión del ID del repositorio significa que se pueden clonar instantáneas de un repositorio como imágenes en un repositorio distinto.
    </para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>
       <emphasis>Plantilla de imagen:</emphasis> un ejemplo de uso habitual para crear capas de dispositivos de bloques es crear una imagen principal y una instantánea que sirva como plantilla para los clones. Por ejemplo, un usuario puede crear una imagen de una distribución de Linux (como SUSE Linux Enterprise Server) y crear una instantánea para ella. El usuario puede actualizar periódicamente la imagen y crear una instantánea nueva (por ejemplo, <command>zypper ref &amp;&amp; zypper patch</command>, seguido de <command>rbd snap create</command>). A medida que la imagen crezca, el usuario puede clonar cualquiera de las instantáneas.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Plantilla extendida:</emphasis> un ejemplo de uso más avanzado implica la posibilidad de extender una imagen de plantilla para que proporcione más información que una imagen base. Por ejemplo, un usuario puede clonar una imagen (una plantilla de máquina virtual) e instalar otro software (por ejemplo, una base de datos, un sistema de gestión de contenido o un sistema de análisis) y, a continuación, realizar una instantánea de la imagen extendida, que a su vez se puede actualizar de la misma manera que la imagen base.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Repositorio de plantillas:</emphasis> una manera de utilizar capas de dispositivos de bloques es crear un repositorio que contenga imágenes principales que actúen como plantillas e instantáneas de dichas plantillas. A continuación, puede ampliar los privilegios de solo lectura a los usuarios, de modo que tengan la posibilidad de clonar las instantáneas sin la capacidad de escribir o ejecutar dentro del repositorio.
      </para>
     </listitem>
     <listitem>
      <para>
       <emphasis>Migración y recuperación de imágenes:</emphasis> una manera de utilizar capas de dispositivos de bloques consiste en migrar o recuperar datos de un repositorio a otro.
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
   <sect3>
    <title>Protección de una instantánea</title>
    <para>
     Los clones acceden a las instantáneas padre. Todos los clones dejarán de funcionar si un usuario suprime por error la instantánea padre. Para evitar la pérdida de datos, debe proteger la instantánea antes de clonarla.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> snap protect \
 --image <replaceable>image-name</replaceable> --snap <replaceable>snapshot-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd snap protect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool pool1 snap protect --image image1 --snap snapshot1
<prompt>cephadm@adm &gt; </prompt>rbd snap protect pool1/image1@snapshot1</screen>
    <note>
     <para>
      No es posible suprimir una instantánea protegida.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Clonación de una instantánea</title>
    <para>
     Para clonar una instantánea, debe especificar el repositorio padre, la imagen, la instantánea, el repositorio hijo y el nombre de la imagen. Debe proteger la instantánea para poder clonarla.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd clone --pool <replaceable>pool-name</replaceable> --image <replaceable>parent-image</replaceable> \
 --snap <replaceable>snap-name</replaceable> --dest-pool <replaceable>pool-name</replaceable> \
 --dest <replaceable>child-image</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd clone <replaceable>pool-name</replaceable>/<replaceable>parent-image</replaceable>@<replaceable>snap-name</replaceable> \
<replaceable>pool-name</replaceable>/<replaceable>child-image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd clone pool1/image1@snapshot1 pool1/image2</screen>
    <note>
     <para>
      Puede clonar una instantánea de un repositorio como una imagen de otro repositorio. Por ejemplo, puede mantener imágenes e instantáneas de solo lectura como plantillas en un repositorio y clones con acceso de escritura en otro.
     </para>
    </note>
   </sect3>
   <sect3>
    <title>Desprotección de una instantánea</title>
    <para>
     Para suprimir una instantánea, primero debe desprotegerla. Además, <emphasis>no puede</emphasis> suprimir instantáneas que tengan referencias de clones. Debe aplanar todos los clones de una instantánea para poder eliminarla.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> snap unprotect --image <replaceable>image-name</replaceable> \
 --snap <replaceable>snapshot-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd snap unprotect <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool pool1 snap unprotect --image image1 --snap snapshot1
<prompt>cephadm@adm &gt; </prompt>rbd snap unprotect pool1/image1@snapshot1</screen>
   </sect3>
   <sect3>
    <title>Enumeración de los hijos de una instantánea</title>
    <para>
     Para enumerar los hijos de una instantánea, ejecute lo siguiente:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> children --image <replaceable>image-name</replaceable> --snap <replaceable>snap-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd children <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool pool1 children --image image1 --snap snapshot1
<prompt>cephadm@adm &gt; </prompt>rbd children pool1/image1@snapshot1</screen>
   </sect3>
   <sect3 xml:id="rbd-flatten">
    <title>Aplanamiento de una imagen clonada</title>
    <para>
     Las imágenes clonadas retienen una referencia a la instantánea padre. Si elimina la referencia del clon a la instantánea padre, la imagen se "aplana" copiando la información de la instantánea en el clon. El tiempo que se tarda en aplanar un clon aumenta según el tamaño de la instantánea. Para suprimir una instantánea, primero debe aplanar las imágenes hijo.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool <replaceable>pool-name</replaceable> flatten --image <replaceable>image-name</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd flatten <replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --pool pool1 flatten --image image1
<prompt>cephadm@adm &gt; </prompt>rbd flatten pool1/image1</screen>
    <note>
     <para>
      Dado que una imagen plana contiene toda la información de la instantánea, ocupará más espacio de almacenamiento que un clon con capas.
     </para>
    </note>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-rbd-mirror">
  <title>Duplicación</title>

  <para>
   Las imágenes RBD se pueden duplicar de forma asincrónica entre dos clústeres de Ceph. Esta función utiliza las imágenes RBD transaccionales para garantizar la replicación protegida contra bloqueos entre los clústeres. La duplicación se configura para cada repositorio con clústeres conectores y se puede configurar para que duplique automáticamente todas las imágenes de un repositorio o solo un subconjunto específico de imágenes. La duplicación se configura mediante el comando <command>rbd</command>. El daemon <systemitem>rbd-mirror</systemitem> es el responsable de la extracción de actualizaciones de imágenes en el clúster conector remoto y de aplicarlos a la imagen en el clúster local.
  </para>

  <note>
   <title>daemon rbd-mirror</title>
   <para>
    Para utilizar la duplicación RBD, debe disponer de dos clústeres Ceph con el daemon <systemitem>rbd-mirror</systemitem> en ejecución en ambos.
   </para>
  </note>

  <important>
   <title>dispositivos de bloques RADOS exportados a través de iSCSI</title>
   <para>
    No es posible duplicar los dispositivos RBD que se exportan a través de iSCSI mediante una pasarela iSCSI Gateway basada en el kernel.
   </para>
   <para>
    Consulte el <xref linkend="cha-ceph-iscsi"/> para obtener más detalles sobre iSCSI.
   </para>
  </important>

  <sect2 xml:id="rbd-mirror-daemon">
   <title>Daemon rbd-mirror</title>
   <para>
    Los dos daemons <systemitem>rbd-mirror</systemitem> son responsables de vigilar los diarios transaccionales de las imágenes en el clúster conector remoto y reproducir los eventos del diario en el clúster local. Las imágenes RBD transaccionales almacenan todas las modificaciones realizadas en la imagen en el orden en que se producen. Esto garantiza que exista localmente una duplicación de la imagen remota protegida contra errores.
   </para>
   <para>
    El daemon <systemitem>rbd-mirror</systemitem> está disponible en el paquete
    <package>rbd-mirror.</package>  Puede instalar el paquete en nodos OSD, nodos de pasarela o incluso en nodos dedicados. No se recomienda instalar el daemon <package>rbd-mirror</package> en el nodo de administración. Para instalar, habilitar e iniciar <package>rbd-mirror:</package>
   </para>
<screen><prompt>root@minion &gt; </prompt>zypper install rbd-mirror
<prompt>root@minion &gt; </prompt>systemctl enable ceph-rbd-mirror@<replaceable>server_name</replaceable>.service
<prompt>root@minion &gt; </prompt>systemctl start ceph-rbd-mirror@<replaceable>server_name</replaceable>.service</screen>
   <important>
    <para>
     Cada daemon <systemitem>rbd-mirror</systemitem> requiere la capacidad de conectarse a ambos clústeres de forma simultánea.
    </para>
   </important>
  </sect2>

  <sect2 xml:id="ceph-rbd-mirror-poolconfig">
   <title>Configuración del repositorio</title>
   <para>
    Los siguientes procedimientos demuestran cómo llevar a cabo las tareas administrativas básicas para configurar la duplicación mediante el comando <command>rbd</command>. La duplicación se configura de forma independiente para cada repositorio dentro de los clústeres de Ceph.
   </para>
   <para>
    Debe llevar a cabo los pasos de configuración del repositorio en ambos clústeres conectores. Para simplificar los ejemplos, en estos procedimientos se presupone que hay dos clústeres, denominados "local" y "remote", accesibles desde un único host.
   </para>
   <para>
    Consulte la página man de <command>rbd</command> (<command>man 8 rbd</command>) para obtener información adicional acerca de cómo conectarse a clústeres de Ceph diferentes.
   </para>
   <tip>
    <title>varios clústeres</title>
    <para>
     En los siguientes ejemplos, el nombre del clúster se corresponde con un archivo de configuración de Ceph con el mismo nombre <filename>/etc/ceph/remote.conf</filename>.
    </para>
   </tip>
   <sect3>
    <title>Cómo habilitar la duplicación en un repositorio</title>
    <para>
     Para habilitar la duplicación en un repositorio, especifique el subcomando <command>mirror pool enable</command>, el nombre del repositorio y el modo de duplicación. El modo de duplicación puede ser de repositorio o de imagen:
    </para>
    <variablelist>
     <varlistentry>
      <term>pool</term>
      <listitem>
       <para>
        Se duplican todas las imágenes del repositorio con el registro transaccional habilitado.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>image</term>
      <listitem>
       <para>
        La duplicación se debe habilitar explícitamente en cada imagen. Consulte la <xref linkend="rbd-mirror-enable-image-mirroring"/> para obtener más información. 
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     Por ejemplo:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror pool enable <replaceable>POOL_NAME</replaceable> pool
<prompt>cephadm@adm &gt; </prompt>rbd --cluster remote mirror pool enable <replaceable>POOL_NAME</replaceable> pool</screen>
   </sect3>
   <sect3>
    <title>Cómo inhabilitar la duplicación</title>
    <para>
     Para inhabilitar la duplicación en un repositorio, especifique el subcomando <command>mirror pool disable</command> y el nombre del repositorio. Cuando se inhabilita la duplicación en un repositorio de esta forma, la duplicación también se inhabilitará en cualquier imagen (dentro del repositorio) para la que se haya habilitado la duplicación explícitamente.
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror pool disable <replaceable>POOL_NAME</replaceable>
<prompt>cephadm@adm &gt; </prompt>rbd --cluster remote mirror pool disable <replaceable>POOL_NAME</replaceable></screen>
   </sect3>
   <sect3>
    <title>Adición de un clúster conector</title>
    <para>
     Para que el daemon <systemitem>rbd-mirror</systemitem> descubra su clúster conector, el conector debe estar registrado en el repositorio. Para añadir un clúster conector duplicado, especifique el subcomando <command>mirror pool peer add</command>, el nombre del repositorio y una especificación de clúster:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror pool peer add <replaceable>POOL_NAME</replaceable> client.remote@remote
<prompt>cephadm@adm &gt; </prompt>rbd --cluster remote mirror pool peer add <replaceable>POOL_NAME</replaceable> client.local@local</screen>
   </sect3>
   <sect3>
    <title>Eliminación de un clúster conector</title>
    <para>
     Para eliminar un clúster conector duplicado, especifique el subcomando <command>mirror pool peer remove</command>, el nombre del repositorio y el UUID del conector (disponible mediante el comando <command>rbd mirror pool info</command>):
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror pool peer remove <replaceable>POOL_NAME</replaceable> \
 55672766-c02b-4729-8567-f13a66893445
<prompt>cephadm@adm &gt; </prompt>rbd --cluster remote mirror pool peer remove <replaceable>POOL_NAME</replaceable> \
 60c0e299-b38f-4234-91f6-eed0a367be08</screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd-mirror-imageconfig">
   <title>Configuración de la imagen</title>
   <para>
    A diferencia de la configuración del repositorio, la configuración de la imagen solo se debe realizar en un único clúster conector duplicado de Ceph.
   </para>
   <para>
    Las imágenes RBD duplicadas se designan como <emphasis>primary</emphasis> (principal) o <emphasis>non-primary</emphasis> (no principal). Se trata de una propiedad de la imagen, no del repositorio. Las imágenes designadas como no principales no se pueden modificar.
   </para>
   <para>
    Las imágenes suben de nivel a principal automáticamente cuando la duplicación se habilita por primera vez en una imagen (ya sea implícita, si el modo de duplicación del repositorio es "pool" [repositorio] y la imagen cuenta con la función de imagen transaccional habilitada, o explícita [consulte la <xref linkend="rbd-mirror-enable-image-mirroring"/>], mediante el comando <command>rbd</command>).
   </para>
   <sect3>
    <title>Compatibilidad con imágenes transaccionales</title>
    <para>
     La duplicación RBD utiliza las imágenes RBD transaccionales para garantizar que la imagen replicada siempre esté protegida contra fallos. Para que una imagen se pueda duplicar en un clúster conector, es necesario habilitar la función de registro transaccional. La función se puede habilitar en el momento de creación de la imagen proporcionando la opción <option>‑‑image-feature exclusive-lock,journaling</option> al comando <command>rbd</command>.
    </para>
    <para>
     Como alternativa, la función de registro transaccional se puede habilitar de forma dinámica en las imágenes RBD preexistentes. Para habilitar el registro transaccional, especifique el subcomando <command>feature enable</command>, el nombre del repositorio y la imagen y el nombre de la función:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local feature enable <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable> journaling</screen>
    <note>
     <title>dependencia de opciones</title>
     <para>
      La función <option>journaling</option> (registro transaccional) depende de la función <option>exclusive-lock</option> (bloqueo exclusivo). Si la función <option>exclusive-lock</option> no está habilitada, deberá habilitarla antes que la función <option>journaling</option>.
     </para>
    </note>
    <warning>
     <title>registro transaccional en todas las imágenes nuevas</title>
     <para>
      Puede habilitar el registro transaccional en todas las imágenes nuevas por defecto añadiendo el valor <literal>journaling</literal> al final de la opción <option>rbd default features</option> en el archivo de configuración de Ceph. Por ejemplo:
     </para>
<screen>rbd default features = layering,exclusive-lock,object-map,deep-flatten,journaling</screen>
     <para>
      Antes de aplicar este cambio, considere cuidadosamente si habilitar el registro transaccional en todas las imágenes nuevas es beneficioso para la distribución, ya que puede afectar negativamente al rendimiento.
     </para>
    </warning>
   </sect3>
   <sect3 xml:id="rbd-mirror-enable-image-mirroring">
    <title>Cómo habilitar la duplicación de imágenes</title>
    <para>
     Si la duplicación está configurada en el modo de "imagen", es necesario habilitar explícitamente la duplicación para cada imagen del repositorio. Para habilitar la duplicación de una imagen concreta, especifique el subcomando <command>mirror image enable</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror image enable <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable></screen>
   </sect3>
   <sect3>
    <title>Cómo inhabilitar la duplicación de imágenes</title>
    <para>
     Para habilitar la duplicación de una imagen concreta, especifique el subcomando <command>mirror image disable</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror image disable <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable></screen>
   </sect3>
   <sect3>
    <title>Cómo bajar o subir de nivel una imagen</title>
    <para>
     En una situación de failover en la que sea necesario mover la designación primara a la imagen del clúster conector, debe detener el acceso a la imagen principal, bajarla de nivel, subir el nivel de la nueva imagen principal y reanudar el acceso a la imagen en el clúster alternativo.
    </para>
    <note>
     <title>subida de nivel forzosa</title>
     <para>
      Puede forzar la subida de nivel mediante la opción <option>‑‑force</option>. Es necesario forzar la subida de nivel cuando la bajada de nivel no se puede propagar al clúster conector (por ejemplo, en caso de fallo del clúster o interrupción de la comunicación). Esto provocará una situación de división entre ambos conectores y la imagen dejará de sincronizarse hasta que se emita un subcomando <command>resync</command>.
     </para>
    </note>
    <para>
     Para bajar de nivel una imagen y convertirla en no principal, especifique el subcomando <command>mirror image demote</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror image demote <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable></screen>
    <para>
     Para bajar de nivel todas las imágenes principales de un repositorio a no principales, especifique el subcomando <command>mirror pool demote</command> junto con el nombre del repositorio:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror pool demote <replaceable>POOL_NAME</replaceable></screen>
    <para>
     Para subir de nivel una imagen y convertirla en principal, especifique el subcomando <command>mirror image promote</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster remote mirror image promote <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable></screen>
    <para>
     Para subir de nivel todas las imágenes de un repositorio a principales, especifique el subcomando <command>mirror pool promote</command> junto con el nombre del repositorio:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd --cluster local mirror pool promote <replaceable>POOL_NAME</replaceable></screen>
    <tip>
     <title>división de la carga de E/S</title>
     <para>
      Puesto que el estado primario o no primario se establece para cada imagen, es posible que haya dos clústeres que dividan la carga de E/S y el failover o failback por fases.
     </para>
    </tip>
   </sect3>
   <sect3>
    <title>Cómo forzar la resincronización de la imagen</title>
    <para>
     Si el daemon <systemitem>rbd-mirror</systemitem> detecta un evento dividido, no intentará duplicar la imagen afectada hasta que se corrija. Para reanudar la duplicación de una imagen, primero baje de nivel la imagen considerada obsoleta y, a continuación, realice una petición de resincronización de la imagen principal. Para pedir una resincronización de la imagen, especifique el subcomando <command>mirror image resync</command> junto con el nombre del repositorio y el de la imagen:
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd mirror image resync <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable></screen>
   </sect3>
  </sect2>

  <sect2 xml:id="rbd-mirror-status">
   <title>Estado de la duplicación</title>
   <para>
    El estado de replicación de clúster conector se almacena para cada imagen principal duplicada. Este estado se puede recuperar mediante los subcomandos <command>mirror image status</command> y <command>mirror pool status</command>:
   </para>
   <para>
    Para pedir el estado de la imagen duplicada, especifique el subcomando <command>mirror image status</command> junto con el nombre del repositorio y el de la imagen:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd mirror image status <replaceable>POOL_NAME</replaceable>/<replaceable>IMAGE_NAME</replaceable></screen>
   <para>
    Para pedir el estado resumido del repositorio de duplicación, especifique el subcomando <command>mirror pool status</command> junto con el nombre del repositorio:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>rbd mirror pool status <replaceable>POOL_NAME</replaceable></screen>
   <tip>
    <title/>
    <para>
     Si se añade la opción <option>‑‑verbose</option> al subcomando <command>mirror pool status</command>, también se mostrará la información de estado de todas las imágenes duplicadas del repositorio.
    </para>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="rbd-cache-settings">
  <title>Ajustes de caché</title>

  <para>
   La implementación del espacio de usuario del dispositivo de bloques Ceph (<systemitem>librbd</systemitem>) no puede hacer uso del caché de paginación de Linux. Por lo tanto, incluye su propio almacenamiento en caché en memoria. El almacenamiento en caché de RBD tiene un comportamiento similar al almacenamiento en caché del disco duro. Cuando el sistema operativo envía una barrera o una petición de vaciado, todos los datos "sucios" se escriben en los OSD. Esto significa que el uso del almacenamiento en caché en modo write-back es tan seguro como usar un disco duro físico de buen comportamiento con una máquina virtual que envía correctamente los vaciados. La memoria caché utiliza un algoritmo <emphasis>LRU</emphasis> (del inglés Least Recently Used, menos usadas recientemente) y, en el modo write-back, puede combinar peticiones adyacentes para obtener un mejor rendimiento.
  </para>

  <para>
   Ceph admite el modo write-back de almacenamiento en caché para los RBD. Para habilitarlo, añada:
  </para>

<screen>
[client]
...
rbd cache = true
</screen>

  <para>
   a la sección <literal>[client]</literal> del archivo <filename>ceph.conf</filename>. Por defecto, <systemitem>librbd</systemitem> no realiza ningún almacenamiento en caché. Las escrituras y lecturas van directamente al clúster de almacenamiento. Las escrituras solo se devuelven cuando los datos están en el disco en todas las réplicas. Con el almacenamiento en caché habilitado, las escrituras se devuelven de inmediato, a menos que haya más bytes sin vaciar de los definidos en la opción <option>rbd cache max dirty</option>. En tal caso, la escritura activa la escritura diferida y se bloquea hasta que se vacían suficientes bytes.
  </para>

  <para>
   Ceph admite el modo write-through de almacenamiento en caché para los RBD. Es posible definir el tamaño de la memoria caché y establecer destinos y límites para cambiar del modo write-back al modo write-through de almacenamiento en caché. Para habilitar el modo write-through, defina:
  </para>

<screen>
rbd cache max dirty = 0
</screen>

  <para>
   Esto significa que las escrituras solo se devuelven cuando los datos están en el disco en todas las réplicas, pero las lecturas pueden provenir de la memoria caché. La memoria caché está en memoria en el cliente y cada imagen RBD tiene su propia memoria caché. Puesto que la memoria caché es local para el cliente, si hay otros usuarios que acceden a la imagen, la coherencia se pierde. Ejecutar GFS u OCFS sobre el RBD no funcionará si el almacenamiento en caché está habilitado.
  </para>

  <para>
   Los valores del archivo <filename>ceph.conf</filename> para el RBD deben definirse en la sección <literal>[client]</literal> del archivo de configuración. Algunos de los valores son:
  </para>

  <variablelist>
   <varlistentry>
    <term><option>rbd cache</option></term>
    <listitem>
     <para>
      Habilita el almacenamiento en caché para el dispositivo de bloques RADOS (RBD). El valor por defecto es "true" (verdadero).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd cache size</option></term>
    <listitem>
     <para>
      El tamaño de la memoria caché del RBD en bytes. El valor por defecto es 32 MB.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd cache max dirty</option></term>
    <listitem>
     <para>
      El límite de bytes "sucios" en el que la memoria caché activa el modo write-back. El valor de <option>rbd cache max dirty</option> debe ser menor que el de <option>rbd cache size</option>. Si se define en 0, se utiliza el almacenamiento en caché en modo write-through. El valor por defecto es 24 MB.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd cache target dirty</option></term>
    <listitem>
     <para>
      El "destino sucio" antes de que la memoria caché comience a escribir datos en el almacenamiento de datos. No bloquea las escrituras en la memoria caché. El valor por defecto es 16 MB.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd cache max dirty age</option></term>
    <listitem>
     <para>
      El número de segundos que los datos sucios están en la memoria caché antes de que se inicie la escritura diferida. El valor por defecto es 1.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd cache writethrough until flush</option></term>
    <listitem>
     <para>
      Comienza en modo write-through y cambia al modo write-back después de que se reciba la primera petición de vaciado. Habilitar esta opción es una medida conservadora pero segura en caso de que las máquinas virtuales que se ejecutan en <systemitem>rbd</systemitem> sean demasiado antiguas para enviar vaciados (por ejemplo, el controlador virtio de Linux antes del kernel 2.6.32). El valor por defecto es "true" (verdadero).
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="rbd-qos">
  <title>Configuración de QoS</title>

  <para>
   Por norma general, la calidad de servicio (QoS) hace referencia a los métodos de priorización del tráfico y de reserva de recursos. Es particularmente importante para el transporte del tráfico con requisitos especiales.
  </para>

  <important>
   <title>no es compatible con iSCSI</title>
   <para>
    Los valores de QoS siguientes solo se utilizan en la implementación <systemitem class="daemon">librbd</systemitem> del RBD de espacio de nombres, pero <emphasis>no</emphasis> por la implementación <systemitem>kRBD</systemitem>. Dado que iSCSI utiliza <systemitem>kRBD</systemitem>, no utiliza los valores de QoS. Sin embargo, para iSCSI puede configurar QoS en la capa de dispositivo de bloques del kernel mediante instalaciones del kernel estándar.
   </para>
  </important>

  <variablelist>
   <varlistentry>
    <term><option>rbd qos iops limit</option></term>
    <listitem>
     <para>
      El límite deseado de operaciones de E/S por segundo. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos bps limit</option></term>
    <listitem>
     <para>
      El límite deseado de bytes de E/S por segundo. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos read iops limit</option></term>
    <listitem>
     <para>
      El límite deseado de operaciones de lectura por segundo. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos write iops limit</option></term>
    <listitem>
     <para>
      El límite deseado de operaciones de escritura por segundo. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos read bps limit</option></term>
    <listitem>
     <para>
      El límite deseado de bytes de lectura por segundo. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos write bps limit</option></term>
    <listitem>
     <para>
      El límite deseado de bytes de escritura por segundo. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos iops burst</option></term>
    <listitem>
     <para>
      El límite de ráfaga deseado de operaciones de E/S. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos bps burst</option></term>
    <listitem>
     <para>
      El límite de ráfaga deseado de bytes de E/S. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos read iops burst</option></term>
    <listitem>
     <para>
      El límite de ráfaga deseado de operaciones de lectura. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos write iops burst</option></term>
    <listitem>
     <para>
      El límite de ráfaga deseado de operaciones de escritura. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos read bps burst</option></term>
    <listitem>
     <para>
      El límite de ráfaga deseado de bytes de lectura. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos write bps burst</option></term>
    <listitem>
     <para>
      El límite de ráfaga deseado de bytes de escritura. El valor por defecto es 0 (sin límite).
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd qos schedule tick min</option></term>
    <listitem>
     <para>
      La pulsación de programación mínima (en milisegundos) para QoS. El valor por defecto es 50.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="rbd-readahead-settings">
  <title>Configuración de lectura anticipada</title>

  <para>
   El dispositivo de bloques RADOS admite la lectura anticipada y la captura previa para optimizar las lecturas pequeñas y secuenciales. Normalmente, el sistema operativo invitado se encargaría de gestionar esta función en una máquina virtual, pero es posible que los cargadores de arranque no emitan lecturas eficientes. La lectura anticipada se inhabilita automáticamente si el almacenamiento en caché está inhabilitado.
  </para>

  <variablelist>
   <varlistentry>
    <term><option>rbd readahead trigger requests</option></term>
    <listitem>
     <para>
      El número de peticiones de lectura secuenciales necesarias para activar la lectura anticipada. El valor por defecto es 10.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd readahead max bytes</option></term>
    <listitem>
     <para>
      El tamaño máximo de una petición de lectura anticipada. Si se define en 0, la lectura anticipada estará inhabilitada. El valor por defecto es 512 kB.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>rbd readahead disable after bytes</option></term>
    <listitem>
     <para>
      Después de que se hayan leído este número de bytes de una imagen RBD, la lectura anticipada se inhabilita para esa imagen hasta que se cierra. Esto permite que el sistema operativo invitado recupere la función de lectura anticipada cuando se arranca. Si se define en 0, la lectura anticipada sigue habilitada. El valor por defecto es 50 MB.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="rbd-features">
  <title>Funciones avanzadas</title>

  <para>
   El dispositivo de bloques RADOS admite funciones avanzadas que mejoran la funcionalidad de las imágenes RBD. Puede especificar las funciones en la línea de comandos cuando se crea una imagen RBD o en el archivo de configuración de Ceph mediante la opción <option>rbd_default_features</option>.
  </para>

  <para>
   Es posible especificar los valores de la opción <option>rbd_default_features</option> de dos maneras:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Como una suma de los valores internos de las funciones. Cada función tiene su propio valor interno; por ejemplo, la "layering" tiene 1 y "fast-diff" tiene 16. Por lo tanto, para activar estas dos funciones por defecto, incluya lo siguiente:
    </para>
<screen>
rbd_default_features = 17
</screen>
   </listitem>
   <listitem>
    <para>
     Como una lista separada por comas de funciones. El ejemplo anterior tendrá el siguiente aspecto:
    </para>
<screen>
rbd_default_features = layering,fast-diff
</screen>
   </listitem>
  </itemizedlist>

  <note>
   <title>funciones no compatibles con iSCSI</title>
   <para>
    Las imágenes RBD con las siguientes funciones no son compatibles con iSCSI: <option>deep-flatten</option>, <option>object-map</option>, <option>journaling</option>, <option>fast-diff</option> y <option>striping</option>
   </para>
  </note>

  <para>
   A continuación se muestra una lista de funciones avanzadas de RBD:
  </para>

  <variablelist>
   <varlistentry>
    <term><option>layering</option></term>
    <listitem>
     <para>
      La disposición en capas permite utilizar la clonación.
     </para>
     <para>
      El valor interno es 1, el valor por defecto es "sí".
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>striping</option></term>
    <listitem>
     <para>
      La repartición striping distribuye los datos entre varios objetos y ayuda a las cargas de trabajo de lectura y escritura secuenciales mediante paralelismo. Evita los cuellos de botella en un solo nodo en dispositivos de bloques RADOS de gran volumen u ocupación.
     </para>
     <para>
      El valor interno es 2, el valor por defecto es "sí".
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>exclusive-lock</option></term>
    <listitem>
     <para>
      Si está habilitado, requiere que un cliente obtenga un bloqueo en un objeto antes de realizar una escritura. Habilita el bloqueo exclusivo solo si un único cliente accede a una imagen al mismo tiempo. El valor interno es 4. El valor por defecto es "sí".
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>object-map</option></term>
    <listitem>
     <para>
      La compatibilidad con el mapa de objetos depende de la compatibilidad con el bloqueo exclusivo. Los dispositivos de bloque son de provisión ligera, lo que significa que solo almacenan datos que realmente existen. La compatibilidad con el mapa de objetos ayuda a realizar un seguimiento de los objetos que realmente existen (que tienen datos almacenados en una unidad). Al habilitar la compatibilidad con el mapa de objetos, se aceleran las operaciones de E/S para clonar, importar y exportar una imagen escasamente poblada y suprimirla.
     </para>
     <para>
      El valor interno es 8, el valor por defecto es "sí".
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>fast-diff</option></term>
    <listitem>
     <para>
      La compatibilidad con diff rápida depende de la compatibilidad con el mapa de objetos y con el bloqueo exclusivo. Añade otra propiedad al mapa de objetos, lo que hace que sea mucho más rápido generar diffs entre las instantáneas de una imagen y el uso de datos real de una instantánea.
     </para>
     <para>
      El valor interno es 16, el valor por defecto es "sí".
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>deep-flatten</option></term>
    <listitem>
     <para>
      El aplanamiento profundo hace que <command>rbd flatten</command> (consulte la <xref linkend="rbd-flatten"/>) funcione en todas las instantáneas de una imagen, además de en la propia imagen. Sin él, las instantáneas de una imagen seguirían dependiendo de la imagen padre y, por lo tanto, no se podría suprimir la imagen padre hasta que se eliminaran las instantáneas. El aplanamiento profundo provoca que una imagen padre sea independiente de sus clones, incluso si tienen instantáneas.
     </para>
     <para>
      El valor interno es 32, el valor por defecto es "sí".
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><option>journaling</option></term>
    <listitem>
     <para>
      La compatibilidad con el registro transaccional depende de la compatibilidad con el bloqueo exclusivo. El registro transaccional guarda todas las modificaciones en una imagen en el orden en el que se producen. La duplicación del RBD (consulte la <xref linkend="ceph-rbd-mirror"/>) utiliza el diario para replicar una imagen coherente con la detención por fallo en un clúster remoto.
     </para>
     <para>
      El valor interno es 64 y el valor por defecto es "no".
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="rbd-old-clients-map">
  <title>Asignación del RBD utilizando clientes de kernel antiguos</title>

  <para>
   Es posible que los clientes antiguos (por ejemplo, SLE11 SP4) no puedan asignar imágenes RBD porque un clúster distribuido con SUSE Enterprise Storage 6 aplica algunas funciones (tanto funciones de nivel de imagen RBD como funciones de nivel de RADOS) que estos clientes antiguos no admiten. Si esto sucede, los registros del OSD mostrarán mensajes similares a los siguientes:
  </para>

<screen>2019-05-17 16:11:33.739133 7fcb83a2e700  0 -- 192.168.122.221:0/1006830 &gt;&gt; \
192.168.122.152:6789/0 pipe(0x65d4e0 sd=3 :57323 s=1 pgs=0 cs=0 l=1 c=0x65d770).connect \
protocol feature mismatch, my 2fffffffffff &lt; peer 4010ff8ffacffff missing 401000000000000
</screen>

  <warning>
   <title>el cambio de tipos de depósito del mapa de CRUSH provoca un reequilibrio masivo</title>
   <para>
    Si tiene previsto cambiar los tipos de depósito del mapa de CRUSH entre "straw" y "straw2", hágalo de una manera planificada. Tenga previsto que el impacto en la carga del clúster será significativo, ya que provocará un reequilibrio masivo del clúster.
   </para>
  </warning>

  <procedure>
   <step>
    <para>
     Inhabilite las funciones de la imagen RBD que no sean compatibles. Por ejemplo:
    </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>rbd feature disable pool1/image1 object-map
<prompt>cephadm@adm &gt; </prompt>rbd feature disable pool1/image1 exclusive-lock
</screen>
   </step>
   <step>
    <para>
     Cambie los tipos de depósito del mapa de CRUSH de "straw2" a "straw":
    </para>
    <substeps>
     <step>
      <para>
       Guarde el mapa de CRUSH:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph osd getcrushmap -o crushmap.original
</screen>
     </step>
     <step>
      <para>
       Descompile el mapa de CRUSH.
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>crushtool -d crushmap.original -o crushmap.txt
</screen>
     </step>
     <step>
      <para>
       Edite el mapa de CRUSH y sustituya "straw2" por "straw".
      </para>
     </step>
     <step>
      <para>
       Vuelva a compilar el mapa de CRUSH:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>crushtool -c crushmap.txt -o crushmap.new
</screen>
     </step>
     <step>
      <para>
       Defina el nuevo mapa de CRUSH:
      </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph osd setcrushmap -i crushmap.new
</screen>
     </step>
    </substeps>
   </step>
  </procedure>
 </sect1>
</chapter>
