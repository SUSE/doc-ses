<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="lvmcache.xml" version="5.0" xml:id="lvmcache">

 <title>Mejora del rendimiento con el caché de LVM</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>editar</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>sí</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <warning>
  <title>tecnología en fase preliminar</title>
  <para>
   El caché de LVM es actualmente una tecnología en fase preliminar.
  </para>
 </warning>
 <para>
  El caché de LVM es un mecanismo de almacenamiento en caché que se utiliza para mejorar el rendimiento de un volumen lógico (LV). Normalmente, se utiliza un dispositivo más pequeño y más rápido para mejorar el rendimiento de E/S de un LV más grande y lento. Consulte la página man (<command>man 7 lvmcache</command>) para obtener más detalles sobre el caché de LVM.
 </para>
 <para>
  En SUSE Enterprise Storage, el caché de LVM puede mejorar el rendimiento de los OSD. La compatibilidad con el caché de LVM se proporciona mediante un complemento <command>ceph-volume</command>. Encontrará información detallada sobre su uso ejecutando el comando <command>ceph-volume lvmcache</command>.
 </para>
 <sect1 xml:id="lvmcache-prerequisites">
  <title>Requisitos previos</title>

  <para>
   Para utilizar las características de caché de LVM para mejorar el rendimiento de un clúster de Ceph, debe tener lo siguiente:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Un clúster de Ceph en ejecución en un estado estable ("HEALTH_OK").
    </para>
   </listitem>
   <listitem>
    <para>
     OSD distribuidos con BlueStore y LVM. Este es el valor por defecto si los OSD se han distribuido con SUSE Enterprise Storage 6 o una versión posterior.
    </para>
   </listitem>
   <listitem>
    <para>
     Discos o particiones vacíos que se utilizarán para el almacenamiento en caché.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="lvmcache-planning">
  <title>Puntos que se deben tener en cuenta</title>

  <para>
   Tenga en cuenta los siguientes puntos antes de configurar los OSD para utilizar el caché de LVM:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <emphasis role="bold">Verifique que el caché de LVM es adecuado para su situación.</emphasis> Si solo tiene unas pocas unidades rápidas disponibles que <emphasis role="bold">no</emphasis> se utilizan para los OSD, la recomendación general es utilizarlas como dispositivos WAL/DB para los OSD. En tal caso, las operaciones de WAL y DB (operaciones de poco volumen y raras) se aplican en la unidad rápida, mientras que las operaciones de datos se aplican en la unidad OSD más lenta.
    </para>
    <tip>
     <para>
      Si la latencia es más importante para la distribución que el valor de IOPS o el rendimiento, puede utilizar las unidades rápidas como caché de LVM en lugar de como particiones WAL/DB.
     </para>
    </tip>
   </listitem>
   <listitem>
    <para>
     Si tiene previsto utilizar una unidad rápida como caché de LVM para varios OSD, tenga en cuenta que <emphasis role="bold">todas las operaciones de OSD (incluida la réplica) pasarán por el dispositivo de almacenamiento en caché</emphasis>. Todas las lecturas se consultarán desde el dispositivo de almacenamiento en caché y solo se proporcionarán desde el dispositivo lento en caso de que se pierda la memoria caché. Las escrituras siempre se aplican primero al dispositivo de almacenamiento en caché y se vacían en el dispositivo lento más tarde (el modo de almacenamiento en caché por defecto es "writeback").
    </para>
    <para>
     A la hora de decidir si se debe utilizar el caché de LVM, verifique si la unidad rápida puede servir como parte frontal para varios OSD mientras sigue proporcionando una cantidad aceptable de IOPS. Puede probarlo midiendo la cantidad máxima de IOPS que puede proporcionar el dispositivo rápido y, a continuación, dividiendo el resultado por el número de OSD cubiertos por el dispositivo rápido. Si el resultado es menor o cercano a la cantidad máxima de IOPS que el OSD puede proporcionar sin la memoria caché, probablemente el caché de LVM no sea adecuado para esta configuración.
    </para>
   </listitem>
   <listitem>
    <para>
     <emphasis role="bold">La interacción del dispositivo de caché de LVM con los OSD es importante.</emphasis> Las escrituras se vacían periódicamente desde el dispositivo de almacenamiento en caché en el dispositivo lento. Si el tráfico entrante es constante y significativo, el dispositivo de almacenamiento en caché tendrá problemas para mantenerse al día con las peticiones entrantes, así como con el proceso de vaciado y, como consecuencia, el rendimiento se verá afectado. A menos que el dispositivo rápido pueda proporcionar mucha más IOPS con mejor latencia que el dispositivo lento, no utilice el caché de LVM con cargas de trabajo constantes de gran volumen. El caché de LVM es más adecuado para el tráfico a ráfagas, ya que la memoria caché tiene tiempo para vaciar los datos sucios sin interferir con el tráfico del cliente. En el caso de cargas de trabajo continuas de bajo tráfico, es difícil determinar de antemano si el uso del caché de LVM mejorará el rendimiento. La mejor prueba es testar y comparar la configuración del caché de LVM con la configuración de WAL/DB. Además, como los procesos de escritura de poco volumen resultan una carga pesada en la partición WAL, se sugiere utilizar el dispositivo rápido para DB y/o WAL en lugar de caché de LVM.
    </para>
   </listitem>
   <listitem>
    <para>
     Si no tiene claro si desea utilizar el caché de LVM, utilice el dispositivo rápido como dispositivo WAL y/o DB.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="lvmcache-preparation">
  <title>Preparación</title>

  <para>
   El dispositivo rápido debe dividirse en varias particiones. Cada OSD necesita dos particiones para su caché: una para los datos de caché y otra para los metadatos de caché. El tamaño mínimo de cualquiera de las particiones es de 2 GB. Puede utilizar un único dispositivo rápido para almacenar en caché varios OSD. Simplemente necesita que se particione en consecuencia.
  </para>
 </sect1>
 <sect1 xml:id="lvmcache-configuring">
  <title>Configuración del caché de LVM</title>

  <para>
   Encontrará información detallada sobre cómo añadir, quitar y configurar el caché de LVM ejecutando el comando <command>ceph-volume lvmcache</command>.
  </para>

  <sect2 xml:id="lvmcache-adding">
   <title>Adición de caché de LVM</title>
   <para>
    Para añadir caché de LVM a un OSD existente, utilice el comando siguiente:
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache add
 --cachemetadata <replaceable>METADATA-PARTITION</replaceable>
 --cachedata <replaceable>DATA-PARTITION</replaceable>
 --osd-id <replaceable>OSD-ID</replaceable>
</screen>
   <para>
    Los indicadores opcionales <option>‑‑data</option>, <option>‑‑db</option> o <option>‑‑wal</option> especifican qué partición se debe almacenar en caché. El valor por defecto es <option>‑‑data</option>.
   </para>
   <tip>
    <title>especificación del volumen lógico (LV)</title>
    <para>
     Como alternativa, puede usar el indicador <option>‑‑origin</option> en lugar de la opción <option>‑‑osd-id</option> para especificar qué LV se debe almacenar en caché:
    </para>
<screen>
[...]
--origin <replaceable>VOLUME-GROUP</replaceable>/<replaceable>LOGICAL-VOLUME</replaceable>
</screen>
   </tip>
  </sect2>

  <sect2 xml:id="lvmcache-removing">
   <title>Eliminación del caché de LVM</title>
   <para>
    Para eliminar el caché de LVM existente de un OSD, utilice el siguiente comando:
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache rm --osd-id <replaceable>OSD-ID</replaceable>
</screen>
  </sect2>

  <sect2 xml:id="lvmcache-mode">
   <title>Configuración del modo de caché de LVM</title>
   <para>
    Para especificar el modo de almacenamiento en caché, utilice el comando siguiente:
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache mode --set <replaceable>CACHING-MODE</replaceable> --osd-id <replaceable>OSD-ID</replaceable>
</screen>
   <para>
    <replaceable>CACHING-MODE</replaceable> es "writeback" (por defecto) o "writethrough".
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="lvmcache-failures">
  <title>Gestión de fallos</title>

  <para>
   Si se produce un error en el dispositivo de almacenamiento en caché, será necesario quitar todos los OSD cubiertos por el dispositivo de almacenamiento en caché del clúster (consulte la <xref linkend="salt-removing-osd"/>), purgarlos y volver a distribuirlos. Si la unidad OSD falla, el LV del OSD y el LV de su caché estarán activos, pero no funcionarán. Utilice <command>pvremove <replaceable>PARTICIÓN</replaceable></command> para purgar las particiones (volúmenes físicos) utilizadas para las particiones de datos y metadatos de caché del OSD. Puede utilizar <command>pvs</command> para mostrar todos los volúmenes físicos.
  </para>
 </sect1>
 <sect1 xml:id="lvmcache-faq">
  <title>Preguntas más frecuentes</title>

  <qandaset>
   <qandaentry>
    <question>
     <para>
      ¿Qué sucede si se elimina un OSD?
     </para>
    </question>
    <answer>
     <para>
      Al eliminar el LV del OSD mediante <command>lvremove</command>, los volúmenes lógicos de caché también se eliminarán. Sin embargo, seguirá siendo necesario utilizar el comando <command>pvremove</command> en las particiones para asegurarse de que todas las etiquetas se han borrado.
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      ¿Qué sucede si la tabla de particiones del OSD se borra usando <command>ceph-volume zap</command>?
     </para>
    </question>
    <answer>
     <para>
      Se aplica la misma respuesta que a la pregunta <emphasis role="bold">¿Qué sucede si se elimina un OSD?</emphasis>
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      ¿Qué sucede si se produce un error en la unidad de origen?
     </para>
    </question>
    <answer>
     <para>
      Los volúmenes lógicos de caché siguen existiendo y el comando <command>cache info</command> sigue mostrando que están disponibles. No podrá quitar el almacenamiento en caché porque LVM no vaciará la memoria caché, ya que el dispositivo del volumen lógico del origen ya no existe. La situación ahora es que el LV de origen existe, pero su dispositivo de respaldo no. Puede solucionar este problema, use el comando <command>pvs</command> y localice los dispositivos asociados con el LV de origen. A continuación, elimínelos utilizando:
     </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>sudo pvremove /dev/<replaceable>DEVICE</replaceable> or <replaceable>PARTITION</replaceable>
</screen>
     <para>
      Puede hacer lo mismo con las particiones de caché. Este procedimiento hará que el LV de origen y los LV de caché desaparezcan. También puede usar:
     </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>sudo dd if=/dev/zero of=/dev/<replaceable>DEVICE</replaceable> or <replaceable>PARTITION</replaceable>
</screen>
     <para>
      para eliminarlos antes de usar <command>pvremove</command>.
     </para>
    </answer>
   </qandaentry>
  </qandaset>
 </sect1>
</chapter>
