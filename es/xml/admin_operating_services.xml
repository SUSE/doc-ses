<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph.operating.services">
 <title>Gestión de los servicios de Ceph</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>sí</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  Puede gestionar los servicios de Ceph mediante <systemitem class="daemon">systemd</systemitem> o con DeepSea.
 </para>
 <sect1 xml:id="operate.services.systemd">
  <title>Gestión de los servicios de Ceph con <systemitem class="daemon">systemd</systemitem></title>

  <para>
   Utilice el comando <command>systemctl</command> para gestionar todos los servicios relacionados con Ceph. Las operaciones se llevan a cabo en el nodo en el que haya entrado a la sesión. Debe tener privilegios de usuario <systemitem class="username">Root</systemitem> para gestionar los servicios de Ceph.
  </para>

  <sect2 xml:id="ceph.operating.services.targets">
   <title>Inicio, detención y reinicio de servicios con destinos</title>
   <para>
    Para simplificar las tareas de inicio, detención y reinicio de todos los servicios de un tipo concreto (por ejemplo, todos los servicios de Ceph, todos los MON o todos los OSD) de un nodo, Ceph proporciona los siguientes archivos de unidad <systemitem class="daemon">systemd</systemitem>:
   </para>
<screen><prompt>root # </prompt> ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    Para iniciar/detener/reiniciar todos los servicios de Ceph del nodo, ejecute:
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl restart ceph.target</screen>
   <para>
    Para iniciar/detener/reiniciar todos los OSD del nodo, ejecute:
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target</screen>
   <para>
    Los comandos para otros objetivos son similares.
   </para>
  </sect2>

  <sect2 xml:id="ceph.operating.services.individual">
   <title>Inicio, detención y reinicio de servicios individuales</title>
   <para>
    Puede gestionar servicios individuales mediante los siguientes archivos de unidad <systemitem class="daemon">systemd</systemitem> parametrizados:
   </para>
<screen>ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service</screen>
   <para>
    Para utilizar estos comandos, primero debe identificar el nombre del servicio que desea gestionar. Consulte la <xref linkend="ceph.operating.services.finding_names"/> para obtener más información sobre la identificación de servicios.
   </para>
   <para>
    Para iniciar/detener/reiniciar el servicio <literal>osd.1</literal>, ejecute:
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service</screen>
   <para>
    Los comandos para otros tipos de servicios son similares.
   </para>
  </sect2>

  <sect2 xml:id="ceph.operating.services.finding_names">
   <title>Identificación de servicios individuales</title>
   <para>
    Puede consultar los nombres/números de un determinado tipo de servicio ejecutando <command>systemctl</command> y filtrando los resultados con el comando <command>grep</command>. Por ejemplo:
   </para>
<screen><prompt>root # </prompt>systemctl | grep -i 'ceph-osd.*service'
<prompt>root # </prompt>systemctl | grep -i 'ceph-mon.*service'
[...]</screen>
  </sect2>

  <sect2 xml:id="ceph.operating.services.status">
   <title>Estado del servicio</title>
   <para>
    Puede consultar <systemitem class="daemon">systemd</systemitem> para conocer el estado de los servicios. Por ejemplo:
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    Sustituya <replaceable>HOSTNAME</replaceable> por el nombre del host en el que se ejecuta el daemon.
   </para>
   <para>
    Si no conoce el nombre y el número exacto del servicio, consulte la <xref linkend="ceph.operating.services.finding_names"/>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea.restart">
  <title>Reinicio de los servicios de Ceph mediante DeepSea</title>

  <para>
   Después de aplicar las actualizaciones en los nodos del clúster, es necesario reiniciar los servicios asignados para hacer uso de la versión recién instalada.
  </para>

  <note>
   <title>supervisión del reinicio</title>
   <para>
    El proceso de reinicio del clúster puede tardar bastante. Puede observar los eventos mediante el bus de eventos de Salt ejecutando:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
  </note>

  <sect2 xml:id="deepsea.restart.all">
   <title>Reinicio de todos los servicios</title>
   <para>
    Para reiniciar <emphasis>todos</emphasis> los servicios del clúster, ejecute el siguiente comando:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <para>
    El orden de reinicio de las funciones individuales varía según la versión de DeepSea (<command>rpm -q deepsea</command>):
   </para>
   <itemizedlist>
    <listitem>
     <para>
      En las versiones de DeepSea anteriores a la 0.8.4, el servidor de metadatos, iSCSI Gateway, Object Gateway y los servicios de NFS Ganesha se reinician en paralelo.
     </para>
    </listitem>
    <listitem>
     <para>
      En DeepSea 0.8.4 y las versiones posteriores, todas las funciones que haya configurado se reinician en el siguiente orden: Ceph Monitor, Ceph Manager, Ceph OSD, servidor de metadatos, Object Gateway, iSCSI Gateway y NFS Ganesha. Para reducir el tiempo de inactividad y detectar los posibles problemas lo antes posible, los nodos se reinician secuencialmente. Por ejemplo, no se reinicia más de un nodo de supervisión al mismo tiempo.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    El comando espera a que el clúster se recupere si se encuentra en un estado incorrecto o degradado.
   </para>
  </sect2>

  <sect2 xml:id="deepsea.restart.specific">
   <title>Reinicio de servicios específicos</title>
   <para>
    Para reiniciar un servicio específico en el clúster, ejecute:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    Por ejemplo, para reiniciar todos los servicios de tipo Object Gateway, ejecute:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    Puede emplear los siguientes objetivos:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
</chapter>
