<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph-operating-services">
 <title>Gestión de los servicios de Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>sí</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Puede gestionar los servicios de Ceph mediante <systemitem class="daemon">systemd</systemitem> o con DeepSea.
 </para>
 <sect1 xml:id="operate-services-systemd">
  <title>Gestión de servicios relacionados con el clúster de Ceph mediante <systemitem class="daemon">systemd</systemitem></title>

  <para>
   Utilice el comando <command>systemctl</command> para gestionar todos los servicios relacionados con Ceph. Las operaciones se llevan a cabo en el nodo en el que haya entrado a la sesión. Debe tener privilegios de usuario <systemitem class="username">root</systemitem> para gestionar los servicios de Ceph.
  </para>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Inicio, detención y reinicio de servicios con destinos</title>
   <para>
    Para simplificar las tareas de inicio, detención y reinicio de todos los servicios de un tipo concreto (por ejemplo, todos los servicios de Ceph, todos los MON o todos los OSD) de un nodo, Ceph proporciona los siguientes archivos de unidad <systemitem class="daemon">systemd</systemitem>:
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    Para iniciar/detener/reiniciar todos los servicios de Ceph del nodo, ejecute:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl restart ceph.target
</screen>
   <para>
    Para iniciar/detener/reiniciar todos los OSD del nodo, ejecute:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target
</screen>
   <para>
    Los comandos para otros objetivos son similares.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-individual">
   <title>Inicio, detención y reinicio de servicios individuales</title>
   <para>
    Puede gestionar servicios individuales mediante los siguientes archivos de unidad <systemitem class="daemon">systemd</systemitem> parametrizados:
   </para>
<screen>
ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-mgr@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service
</screen>
   <para>
    Para utilizar estos comandos, primero debe identificar el nombre del servicio que desea gestionar. Consulte la <xref linkend="ceph-operating-services-finding-names"/> para obtener más información sobre la identificación de servicios.
   </para>
   <para>
    Para iniciar/detener/reiniciar el servicio <literal>osd.1</literal>, ejecute:
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service
</screen>
   <para>
    Los comandos para otros tipos de servicios son similares.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identificación de servicios individuales</title>
   <para>
    Es posible averiguar los nombres/números de un tipo determinado de servicio de varias maneras. Los comandos siguientes proporcionan resultados para los servicios de <literal>ceph*</literal>. Puede ejecutarlos en cualquier nodo del clúster de Ceph.
   </para>
   <para>
    Para mostrar todos los servicios de tipo <literal>ceph*</literal> (incluso los inactivos), ejecute:
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --type=service ceph*
</screen>
   <para>
    Para mostrar solo los servicios inactivos, ejecute:
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --state=inactive --type=service ceph*
</screen>
   <para>
    También puede usar <command>salt</command> para consultar servicios en varios nodos:
   </para>
<screen>
<prompt>root@master # </prompt>salt <replaceable>TARGET</replaceable> cmd.shell \
 "systemctl list-units --all --type=service ceph* | sed -e '/^$/,$ d'"
</screen>
   <para>
    Para consultar solo los nodos de almacenamiento:
   </para>
<screen>
<prompt>root@master # </prompt>salt -I 'roles:storage' cmd.shell \
 'systemctl list-units --all --type=service ceph*'
</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>Estado del servicio</title>
   <para>
    Puede consultar <systemitem class="daemon">systemd</systemitem> para conocer el estado de los servicios. Por ejemplo:
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    Sustituya <replaceable>HOSTNAME</replaceable> por el nombre del host en el que se ejecuta el daemon.
   </para>
   <para>
    Si no conoce el nombre y el número exacto del servicio, consulte la <xref linkend="ceph-operating-services-finding-names"/>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea-restart">
  <title>Reinicio de los servicios de Ceph mediante DeepSea</title>

  <para>
   Después de aplicar actualizaciones a los nodos de clúster, es necesario reiniciar los servicios afectados relacionados con Ceph. Normalmente, DeepSea realiza los reinicios automáticamente. En esta sección se describe cómo reiniciar los servicios manualmente.
  </para>

  <tip>
   <title>supervisión del reinicio</title>
   <para>
    El proceso de reinicio del clúster puede tardar bastante. Puede observar los eventos mediante el bus de eventos de Salt ejecutando:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
   <para>
    Otro comando para supervisar los trabajos activos es:
   </para>
<screen>
<prompt>root@master # </prompt>salt-run jobs.active
</screen>
  </tip>

  <sect2 xml:id="deepsea-restart-all">
   <title>Reinicio de todos los servicios</title>
   <warning>
    <title>interrupción de servicios</title>
    <para>
     Si los servicios relacionados con Ceph, específicamente iSCSI o NFS Ganesha, están configurados como puntos únicos de acceso sin configuración de alta disponibilidad, al reiniciarlos se interrumpirán temporalmente desde el punto de vista del cliente.
    </para>
   </warning>
   <tip>
    <title>DeepSea no gestiona Samba</title>
    <para>
     Dado que DeepSea y Ceph Dashboard no admiten actualmente distribuciones de Samba, debe gestionar manualmente los servicios relacionados con Samba. Para obtener más información, consulte el <xref linkend="cha-ses-cifs"/>.
    </para>
   </tip>
   <para>
    Para reiniciar <emphasis>todos</emphasis> los servicios del clúster, ejecute el siguiente comando:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <itemizedlist>
    <listitem>
     <para>
      En las versiones de DeepSea anteriores a la 0.8.4, el servidor de metadatos, iSCSI Gateway, Object Gateway y los servicios de NFS Ganesha se reinician en paralelo.
     </para>
    </listitem>
    <listitem>
     <para>
      En DeepSea 0.8.4 y las versiones posteriores, todas las funciones que haya configurado se reinician en el siguiente orden: Ceph Monitor, Ceph Manager, Ceph OSD, servidor de metadatos, Object Gateway, iSCSI Gateway y NFS Ganesha. Para reducir el tiempo de inactividad y detectar los posibles problemas lo antes posible, los nodos se reinician secuencialmente. Por ejemplo, no se reinicia más de un nodo de supervisión al mismo tiempo.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    El comando espera a que el clúster se recupere si se encuentra en un estado incorrecto o degradado.
   </para>
  </sect2>

  <sect2 xml:id="deepsea-restart-specific">
   <title>Reinicio de servicios específicos</title>
   <para>
    Para reiniciar un servicio específico en el clúster, ejecute:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    Por ejemplo, para reiniciar todos los servicios de tipo Object Gateway, ejecute:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    Puede emplear los siguientes objetivos:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Apagado controlado del clúster de Ceph completo</title>

  <para>
   Hay ocasiones en las que puede ser necesario detener todos los servicios relacionados con Ceph del clúster en el orden recomendado y, a continuación, poder simplemente iniciarlos de nuevo. Por ejemplo, en caso de un corte de energía planificado.
  </para>

  <para>
   Para apagar todo el clúster de Ceph, inhabilite las medidas de seguridad y ejecute el runner <command>ceph.shutdown</command>:
  </para>

<screen>
<prompt>root@master # </prompt>salt-run disengage.safety
<prompt>root@master # </prompt>salt-run state.orch ceph.shutdown
</screen>

  <para>
   Para iniciar todo el clúster de Ceph, ejecute el runner <command>ceph.startup</command>:
  </para>

<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.startup
</screen>
 </sect1>
</chapter>
