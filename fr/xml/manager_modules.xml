<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="manager_modules.xml" version="5.0" xml:id="cha-mgr-modules">
 <title>Modules Ceph Manager</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/master/xml/</dm:editurl>
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modification</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>oui</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  L'architecture de Ceph Manager (voir <xref linkend="storage-intro-core-nodes"/> pour une brève présentation) permet d'étendre ses fonctionnalités par le biais de <emphasis>modules</emphasis>, tels que le tableau de bord (« dashboard » - voir <xref linkend="ceph-dashboard"/>), Prometheus (voir <xref linkend="monitoring-alerting"/>) ou l'équilibreur (« balancer »).
 </para>
 <para>
  Pour répertorier tous les modules disponibles, exécutez :
 </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph mgr module ls
{
        "enabled_modules": [
                "restful",
                "status"
        ],
        "disabled_modules": [
                "dashboard"
        ]
}</screen>
 <para>
  Pour activer ou désactiver un module spécifique, exécutez :
 </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph mgr module enable <replaceable>MODULE-NAME</replaceable></screen>
 <para>
  Par exemple :
 </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph mgr module disable dashboard</screen>
 <para>
  Pour répertorier les services fournis par les modules activés, exécutez :
 </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph mgr services
{
        "dashboard": "http://myserver.com:7789/",
        "restful": "https://myserver.com:8789/"
}</screen>
 <sect1 xml:id="mgr-modules-balancer">
  <title>Équilibreur</title>

  <para>
   Le module de l'équilibreur optimise la distribution des groupes de placement (PG) sur les OSD pour assurer un déploiement plus équilibré. Bien que le module soit activé par défaut, il est inactif. Il prend en charge les deux modes suivants : « crush-compat » et « upmap »'.
  </para>

  <tip>
   <title>configuration actuelle de l'équilibreur</title>
   <para>
    Pour afficher la configuration actuelle de l'équilibreur, exécutez la commande suivante :
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph config-key dump</screen>
  </tip>

  <important>
   <title>mode pris en charge</title>
   <para>
    À l'heure actuelle, nous ne prenons en charge que le mode « crush-compat », car le mode « upmap » nécessite une fonction OSD qui empêche tout OSD antérieur à la version Luminous de se connecter à la grappe.
   </para>
  </important>

  <sect2 xml:id="mgr-balancer-crush-compat">
   <title>Mode « crush-compat »</title>
   <para>
    En mode « crush-compat », l'équilibreur ajuste les définitions de repondération des OSD pour améliorer la distribution des données. Il déplace les groupes de placement entre les OSD, ce qui entraîne temporairement un état de grappe HEALTH_WARN en raison de groupes de placement mal placés.
   </para>
   <tip>
    <title>activation du mode</title>
    <para>
     Bien que le mode « crush-compat » soit le mode par défaut, nous vous recommandons de l'activer explicitement :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer mode crush-compat</screen>
   </tip>
  </sect2>

  <sect2 xml:id="mgr-balancer-planning-executing">
   <title>Planification et exécution de l'équilibrage des données</title>
   <para>
    À l'aide du module de l'équilibreur, vous pouvez créer un plan d'équilibrage des données. Vous pouvez ensuite exécuter le plan manuellement ou laisser en permanence l'équilibreur répartir les groupes de placement.
   </para>
   <para>
    Pour décider d'exécuter l'équilibreur en mode manuel ou automatique, vous devez tenir compte de plusieurs facteurs, tels que le déséquilibre actuel des données, la taille de la grappe, le nombre de groupes de placement ou l'activité E/S. Nous vous recommandons de créer un plan initial et de l'exécuter à un moment de faible charge E/S dans la grappe. La raison est que le déséquilibre initial sera probablement considérable et qu'il est bon de limiter l'impact sur les clients. Après une première exécution manuelle, vous pouvez envisager d'activer le mode automatique et veiller à ce que le trafic de rééquilibrage reste sous une charge normale d'E/S. Les améliorations apportées à la distribution des groupes de placement doivent être évaluées par rapport au trafic de rééquilibrage causé par l'équilibreur.
   </para>
   <tip>
    <title>fraction mobile des groupes de placement</title>
    <para>
     Pendant le processus d'équilibrage, le module de l'équilibreur limite les mouvements de groupes de placement, de sorte que seule une fraction configurable de groupes de placement est déplacée. La valeur par défaut est de 5 %, mais vous pouvez ajuster la fraction, à 9 % par exemple, en exécutant la commande suivante :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph config set mgr target_max_misplaced_ratio .09</screen>
   </tip>
   <para>
    Pour créer et exécuter un plan d'équilibrage, procédez comme suit :
   </para>
   <procedure>
    <step>
     <para>
      Vérifiez le score actuel de la grappe :
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer eval</screen>
    </step>
    <step>
     <para>
      Créez un plan. Par exemple, « great_plan » :
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer optimize great_plan</screen>
    </step>
    <step>
     <para>
      Vérifiez les changements que « great_plan » entraînera :
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer show great_plan</screen>
    </step>
    <step>
     <para>
      Vérifiez le score potentiel de la grappe si vous décidez d'appliquer « great_plan » :
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer eval great_plan</screen>
    </step>
    <step>
     <para>
      Exécutez « great_plan » une seule fois :
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer execute great_plan</screen>
    </step>
    <step>
     <para>
      Observez l'équilibrage de la grappe avec la commande <command>ceph -s</command>. Si vous êtes satisfait du résultat, activez l'équilibrage automatique :
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer on</screen>
     <para>
      Si vous décidez par la suite de désactiver l'équilibrage automatique, exécutez la commande suivante :
     </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph balancer off</screen>
    </step>
   </procedure>
   <tip>
    <title>équilibrage automatique sans plan initial</title>
    <para>
     Vous pouvez activer l'équilibrage automatique sans exécuter de plan initial. Dans ce cas, attendez-vous à un rééquilibrage potentiellement long des groupes de placement.
    </para>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="mgr-modules-telemetry">
  <title>Module de télémétrie</title>

  <para>
   Le plug-in de télémétrie envoie au projet Ceph des données anonymes sur la grappe dans laquelle le plug-in est en cours d'exécution.
  </para>

  <para>
   Ce composant (en option) contient des compteurs et des statistiques sur la façon dont la grappe a été déployée, la version de Ceph, la distribution des hôtes et d'autres paramètres qui aident le projet à mieux comprendre la façon dont Ceph est utilisé. Il ne reprend pas de données sensibles comme les noms de réserves, d'objets ou d'hôtes, ni le contenu des objets.
  </para>

  <para>
   Le but du module de télémétrie est de fournir une boucle de rétroaction automatisée pour les développeurs afin d'aider à quantifier les taux d'adoption et le suivi, ou de repérer les points à expliquer davantage ou à mieux valider lors de la configuration pour éviter des résultats indésirables.
  </para>

  <note>
   <para>
    Le module de télémétrie nécessite que les noeuds Ceph Manager puissent transmettre des données aux serveurs en amont via HTTPS. Assurez-vous que les pare-feu de votre entreprise permettent cette opération.
   </para>
  </note>



  <procedure>
   <step>
    <para>
     Pour activer le module de télémétrie :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph mgr module enable telemetry</screen>
    <note>
     <para>
      Cette commande vous permet uniquement de visualiser vos données localement. Cette commande ne partage pas vos données avec la communauté Ceph.
     </para>
    </note>
   </step>
   <step>
    <para>
     Pour permettre au module de télémétrie de commencer à partager des données :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph telemetry on</screen>
   </step>
   <step>
    <para>
     Pour désactiver le partage de données de télémétrie :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph telemetry off</screen>
   </step>
   <step>
    <para>
     Pour générer un rapport JSON pouvant être imprimé :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph telemetry show</screen>
   </step>
   <step>
    <para>
     Pour ajouter un contact et une description au rapport :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph config set mgr mgr/telemetry/contact ‘John Doe <literal>john.doe@example.com</literal>’
<prompt>cephadm@adm &gt; </prompt>ceph config set mgr mgr/telemetry/description ‘My first Ceph cluster’</screen>
   </step>
   <step>
    <para>
     Le module compile et envoie un nouveau rapport toutes les 24 heures par défaut. Pour ajuster cet intervalle :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph config set mgr mgr/telemetry/interval HOURS</screen>
   </step>
  </procedure>


 </sect1>
</chapter>
