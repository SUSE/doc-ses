<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph-operating-services">
 <title>Fonctionnement des services Ceph</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:translation>oui</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Vous pouvez faire fonctionner les services Ceph à l'aide de <systemitem class="daemon">systemd</systemitem> ou DeepSea.
 </para>
 <sect1 xml:id="operate-services-systemd">
  <title>Exploitation des services associés à la grappe Ceph à l'aide de <systemitem class="daemon">systemd</systemitem></title>

  <para>
   La commande <command>systemctl</command> permet de faire fonctionner tous les services liés à Ceph. Ces derniers fonctionnent sur le noeud auquel vous êtes actuellement connecté. Pour utiliser les services Ceph, vous devez disposer des privilèges <systemitem class="username">root</systemitem>.
  </para>

  <sect2 xml:id="ceph-operating-services-targets">
   <title>Démarrage, arrêt et redémarrage des services à l'aide de cibles</title>
   <para>
    Pour simplifier le démarrage, l'arrêt et le redémarrage de tous les services d'un type particulier (par exemple tous les services Ceph, tous les MON ou tous les OSD) sur un noeud, Ceph fournit les fichiers d'unité <systemitem class="daemon">systemd</systemitem> suivants :
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    Pour démarrer/arrêter/redémarrer tous les services Ceph sur le noeud, exécutez :
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl restart ceph.target
</screen>
   <para>
    Pour démarrer/arrêter/redémarrer tous les OSD sur le noeud, exécutez :
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target
</screen>
   <para>
    Les commandes sont analogues pour les autres cibles.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-individual">
   <title>Démarrage, arrêt et redémarrage de services individuels</title>
   <para>
    Vous pouvez faire fonctionner des services individuels à l'aide des fichiers d'unité <systemitem class="daemon">systemd</systemitem> paramétrés suivants :
   </para>
<screen>
ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-mgr@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service
</screen>
   <para>
    Pour utiliser ces commandes, vous devez d'abord identifier le nom du service qui vous intéresse. Reportez-vous à la <xref linkend="ceph-operating-services-finding-names"/> pour en savoir plus sur l'identification des services.
   </para>
   <para>
    Pour démarrer/arrêter/redémarrer le service <literal>osd.1</literal>, exécutez la commande correspondante :
   </para>
<screen>
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service
</screen>
   <para>
    Les commandes sont analogues pour les autres types de service.
   </para>
  </sect2>

  <sect2 xml:id="ceph-operating-services-finding-names">
   <title>Identification des services individuels</title>
   <para>
    Vous pouvez trouver les noms/numéros d'un type particulier de service de plusieurs façons. Les commandes suivantes fournissent des résultats pour les services <literal>ceph*</literal>. Vous pouvez les exécuter sur n'importe quel noeud de la grappe Ceph.
   </para>
   <para>
    Pour lister tous les services (même inactifs) de type <literal>ceph*</literal>, exécutez :
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --type=service ceph*
</screen>
   <para>
    Pour lister uniquement les services inactifs, exécutez :
   </para>
<screen>
<prompt>root # </prompt>systemctl list-units --all --state=inactive --type=service ceph*
</screen>
   <para>
    Vous pouvez également utiliser <command>salt</command> pour interroger les services sur plusieurs noeuds :
   </para>
<screen>
<prompt>root@master # </prompt>salt <replaceable>TARGET</replaceable> cmd.shell \
 "systemctl list-units --all --type=service ceph* | sed -e '/^$/,$ d'"
</screen>
   <para>
    Pour interroger uniquement les noeuds de stockage, exécutez :
   </para>
<screen>
<prompt>root@master # </prompt>salt -I 'roles:storage' cmd.shell \
 'systemctl list-units --all --type=service ceph*'
</screen>
  </sect2>

  <sect2 xml:id="ceph-operating-services-status">
   <title>État Service</title>
   <para>
    Vous pouvez interroger <systemitem class="daemon">systemd</systemitem> pour connaître l'état des services. Par exemple :
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    Remplacez <replaceable>HOSTNAME</replaceable> par le nom d'hôte sur lequel le daemon s'exécute.
   </para>
   <para>
    Si vous ne connaissez pas le nom/numéro exact du service, reportez-vous à la <xref linkend="ceph-operating-services-finding-names"/>.
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea-restart">
  <title>Redémarrage des services Ceph à l'aide de DeepSea</title>

  <para>
   Après avoir appliqué des mises à jour aux noeuds de la grappe, les services concernés associés à Ceph doivent être redémarrés. Normalement, les redémarrages sont effectués automatiquement par DeepSea. Cette section décrit comment redémarrer manuellement les services.
  </para>

  <tip>
   <title>observation du redémarrage</title>
   <para>
    Le processus de redémarrage de la grappe peut prendre un certain temps. Vous pouvez surveiller les événements à l'aide du bus d'événements Salt en exécutant la commande :
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
   <para>
    Voici une autre commande pour surveiller les travaux actifs :
   </para>
<screen>
<prompt>root@master # </prompt>salt-run jobs.active
</screen>
  </tip>

  <sect2 xml:id="deepsea-restart-all">
   <title>Redémarrage de tous les services</title>
   <warning>
    <title>interruption des services</title>
    <para>
     Si les services associés à Ceph, en particulier iSCSI ou NFS Ganesha, sont configurés comme points d'accès uniques sans configuration haute disponibilité, leur redémarrage entraînera leur indisponibilité temporaire côté client.
    </para>
   </warning>
   <tip>
    <title>Samba non géré par DeepSea</title>
    <para>
     Étant donné que pour l'instant, DeepSea et Ceph Dashboard ne prennent pas en charge les déploiements Samba, vous devez gérer manuellement les services associés à Samba. Pour plus de détails, reportez-vous au <xref linkend="cha-ses-cifs"/>.
    </para>
   </tip>
   <para>
    Pour redémarrer <emphasis>tous</emphasis> les services sur la grappe, exécutez la commande suivante:
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <itemizedlist>
    <listitem>
     <para>
      Pour les versions de DeepSea antérieures à la 0.8.4, les services Metadata Server, iSCSI Gateway, Object Gateway et NFS Ganesha redémarrent en parallèle.
     </para>
    </listitem>
    <listitem>
     <para>
      Pour DeepSea 0.8.4 et versions ultérieures, tous les rôles que vous avez configurés redémarrent dans l'ordre suivant : Ceph Monitor, Ceph Manager, Ceph OSD, Metadata Server, Object Gateway, iSCSI Gateway, NFS Ganesha. Pour réduire au maximum les temps d'arrêt et pour détecter les problèmes potentiels le plus tôt possible, les noeuds sont redémarrés de manière séquentielle. Par exemple, un seul noeud de surveillance est redémarré à la fois.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    La commande attend la reprise de la grappe si celle-ci se trouve dans un état dégradé.
   </para>
  </sect2>

  <sect2 xml:id="deepsea-restart-specific">
   <title>Redémarrage de services spécifiques</title>
   <para>
    Pour redémarrer un service spécifique sur la grappe, exécutez la commande :
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    Par exemple, pour redémarrer toutes les instances Object Gateway, exécutez :
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    Vous pouvez utiliser les cibles suivantes :
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph-cluster-shutdown">
  <title>Arrêt approprié de l'ensemble de la grappe Ceph</title>

  <para>
   À certaines occasions, vous avez besoin d'arrêter tous les services associés à Ceph dans la grappe selon l'ordre recommandé, puis de les redémarrer facilement, par exemple, en cas de panne de courant prévue.
  </para>

  <para>
   Pour arrêter l'ensemble de la grappe Ceph, désactives les mesures de sécurité et lancez l'exécuteur <command>ceph.shutdown</command> :
  </para>

<screen>
<prompt>root@master # </prompt>salt-run disengage.safety
<prompt>root@master # </prompt>salt-run state.orch ceph.shutdown
</screen>

  <para>
   Pour démarrer l'ensemble de la grappe Ceph, lancez l'exécuteur <command>ceph.startup</command> :
  </para>

<screen>
<prompt>root@master # </prompt>salt-run state.orch ceph.startup
</screen>
 </sect1>
</chapter>
