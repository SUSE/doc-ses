<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>Sauvegarde de la configuration et des données de grappe</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modification</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>oui</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Ce chapitre explique quelles parties de la grappe Ceph vous devriez sauvegarder afin d'être en mesure de restaurer sa fonctionnalité.
 </para>
 <sect1 xml:id="backup-ceph">
  <title>Sauvegarde de la configuration Ceph</title>

  <para>
   Sauvegardez l'annuaire <filename>/etc/ceph</filename>. Il contient des informations de configuration de grappe cruciales. Vous avez besoin de la sauvegarde de <filename>/etc/ceph</filename>, par exemple, lorsque vous devez remplacer le noeud Admin.
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-salt">
  <title>Sauvegarde de la configuration Salt</title>

  <para>
   Vous devez sauvegarder le répertoire <filename>/etc/salt/</filename>. Il contient les fichiers de configuration Salt, par exemple la clé de Salt Master et les clés clients acceptées.
  </para>

  <para>
   Les fichiers Salt ne sont pas strictement requis pour la sauvegarde du noeud Admin, mais facilitent le redéploiement de la grappe Salt. S'il n'existe pas de sauvegarde de ces fichiers, les minions Salt doivent être enregistrés à nouveau au niveau du nouveau noeud Admin.
  </para>

  <note>
   <title>sécurité de la clé privée de Salt Master</title>
   <para>
    Assurez-vous que la sauvegarde de la clé privée de Salt Master est stockée à un emplacement sûr. La clé de Salt Master peut être utilisée pour manipuler tous les noeuds de la grappe.
   </para>
  </note>

  <para>
   Après avoir restauré le répertoire <filename>salt/etc/</filename> à partir d'une sauvegarde, redémarrez les services Salt :
  </para>

<screen><prompt>root@master # </prompt><command>systemctl</command> restart salt-master
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion</screen>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-deepsea">
  <title>Sauvegarde de la configuration DeepSea</title>

  <para>
   Tous les fichiers requis par DeepSea sont stockés dans <filename>/srv/pillar</filename>, <filename>/srv/salt/</filename> et <filename>/etc/salt/master.d</filename>.
  </para>

  <para>
   Si vous avez besoin de redéployer le noeud Admin, installez le paquetage DeepSea sur le nouveau noeud et replacez les données sauvegardées dans les répertoires. DeepSea peut ensuite être réutilisé sans qu'aucune modification ne soit nécessaire. Avant d'utiliser à nouveau DeepSea, assurez-vous que tous les minions Salt sont correctement enregistrés sur le noeud Admin.
  </para>
 </sect1>
 <sect1 xml:id="backup-config-files">
  <title>Sauvegarde des configurations personnalisées</title>

  <itemizedlist>
   <listitem>
    <para>
     Données et personnalisation de Prometheus.
    </para>
   </listitem>
   <listitem>
    <para>
     Personnalisation de Grafana.
    </para>
   </listitem>
   <listitem>
    <para>
     Vérifiez que vous disposez d'un enregistrement des utilisateurs openATTIC existants afin que vous puissiez créer des comptes pour ces utilisateurs dans Ceph Dashboard.
    </para>
   </listitem>
   <listitem>
    <para>
     Changements manuels de <filename>ceph.conf</filename> en dehors de DeepSea.
    </para>
   </listitem>
   <listitem>
    <para>
     Changements manuels de la configuration iSCSI en dehors de DeepSea.
    </para>
   </listitem>
   <listitem>
    <para>
     Clés Ceph.
    </para>
   </listitem>
   <listitem>
    <para>
     Assignation et règles CRUSH. Enregistrez la carte CRUSH décompilée, y compris les règles CRUSH dans le fichier <filename>crushmap-backup.txt</filename> en exécutant la commande suivante :
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
   </listitem>
   <listitem>
    <para>
     Configuration de la passerelle Samba. Si vous utilisez une seule passerelle, sauvegardez <filename>/etc/samba/smb.conf</filename>. Si vous utilisez une configuration haute disponibilité (HA), sauvegardez également les fichiers de configuration CTDB et Pacemaker. Pour plus de détails sur la configuration utilisée par les passerelles Samba, reportez-vous au <xref linkend="cha-ses-cifs"/>.
    </para>
   </listitem>
   <listitem>
    <para>
     Configuration de NFS Ganesha. Uniquement nécessaire en cas d'utilisation de la configuration HA. Pour plus de détails sur la configuration utilisée par NFS Ganesha, reportez-vous au <xref linkend="cha-ceph-nfsganesha"/>.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
