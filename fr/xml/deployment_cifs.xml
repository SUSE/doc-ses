<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_cifs.xml" version="5.0" xml:id="cha.ses.cifs">

 <title>Exportation de CephFS via Samba</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer>tbazant@suse.com</dm:maintainer>
        <dm:status>modification</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>oui</dm:translation>
        <dm:languages/>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  Cette section décrit comment exporter CephFS via un partage Samba/CIFS. Les partages Samba peuvent être utilisés avec les clients Windows*.
 </para>
 <warning>
  <title>aperçu de la technologie</title>
  <para>
   À compter de SUSE Enterprise Storage 5, l'exportation des partages Samba est considérée comme un aperçu de la technologie et n'est pas prise en charge.
  </para>
 </warning>
 <sect1 xml:id="sec.ses.cifs.example">
  <title>Exemple d'installation</title>

  <para>
   L'exportation de CephFS est un aperçu de la technologie et n'est pas prise en charge. Pour exporter un partage Samba, vous devez installer manuellement Samba sur un noeud de grappe et le configurer. La fonctionnalité de basculement peut être fournie par CTDB et l'extension SUSE Linux Enterprise High Availability Extension.
  </para>

  <procedure>
   <step>
    <para>
     Assurez-vous qu'un CephFS actif existe déjà dans votre grappe. Pour plus de détails, reportez-vous au <xref linkend="cha.ceph.as.cephfs"/>.
    </para>
   </step>
   <step>
    <para>
     Créez un porte-clés spécifique à la passerelle Samba sur Salt Master et copiez-le vers le noeud de la passerelle Samba :
    </para>
<screen><prompt>root@master # </prompt><command>ceph</command> auth get-or-create client.samba.gw mon 'allow r' \
    osd 'allow *' mds 'allow *' -o ceph.client.samba.gw.keyring
<prompt>root@master # </prompt><command>scp</command> ceph.client.samba.gw.keyring <replaceable>SAMBA_NODE</replaceable>:/etc/ceph/</screen>
    <para>
     Remplacez <replaceable>SAMBA_NODE</replaceable> par le nom du noeud de la passerelle Samba.
    </para>
   </step>
   <step>
    <para>
     Les étapes suivantes sont exécutées sur le noeud de la passerelle Samba. Installez le daemon Samba sur le noeud de la passerelle Samba :
    </para>
<screen><prompt>root # </prompt><command>zypper</command> in samba samba-ceph</screen>
   </step>
   <step>
    <para>
     Modifiez <filename>/etc/samba/smb.conf</filename> et ajoutez la section suivante :
    </para>
<screen>[<replaceable>SHARE_NAME</replaceable>]
        path = /
        vfs objects = ceph
        ceph:config_file = /etc/ceph/ceph.conf
        ceph: user_id = samba.gw
        read only = no</screen>
   </step>
   <step>
    <para>
     Démarrez et activez le daemon Samba :
    </para>
<screen><prompt>root # </prompt><command>systemctl</command> start smb.service
<prompt>root # </prompt><command>systemctl</command> enable smb.service
<prompt>root # </prompt><command>systemctl</command> start nmb.service
<prompt>root # </prompt><command>systemctl</command> enable nmb.service</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.ses.cifs.ha">
  <title>Configuration haute disponibilité</title>

  <para>
   Cette section fournit un exemple de configuration à haute disponibilité à deux noeuds des serveurs Samba. La configuration requiert l'extension SUSE Linux Enterprise High Availability Extension. Les deux noeuds sont appelés <systemitem class="domainname">earth</systemitem> (<systemitem class="ipaddress">192.168.1.1</systemitem>) et <systemitem class="domainname">mars</systemitem> (<systemitem class="ipaddress">192.168.1.2</systemitem>).
  </para>

  <para>
   Pour plus d'informations sur l'extension SUSE Linux Enterprise High Availability Extension, reportez-vous au manuel <link xlink:href="https://www.suse.com/documentation/sle-ha-12/"/>.
  </para>

  <para>
   Par ailleurs, deux adresses IP virtuelles flottantes permettent aux clients de se connecter au service quel que soit le noeud physique sur lequel il s'exécute. L'adresse IP <systemitem class="ipaddress">192.168.1.10</systemitem> est utilisée pour l'administration des grappes avec Hawk2 et <systemitem class="ipaddress">192.168.2.1</systemitem> exclusivement pour les exportations CIFS. Cela facilite l'application des restrictions de sécurité ultérieurement.
  </para>

  <para>
   La procédure suivante décrit l'exemple d'installation. Pour plus d'informations, reportez-vous au manuel <link xlink:href="https://www.suse.com/documentation/sle-ha-12/install-quick/data/install-quick.html"/>.
  </para>

  <procedure xml:id="proc.sec.ses.cifs.ha">
   <step>
    <para>
     Créez un porte-clés spécifique à la passerelle Samba sur Salt Master et copiez-le vers les deux noeuds :
    </para>
<screen><prompt>root@master # </prompt><command>ceph</command> auth get-or-create client.samba.gw mon 'allow r' \
    osd 'allow *' mds 'allow *' -o ceph.client.samba.gw.keyring
<prompt>root@master # </prompt><command>scp</command> ceph.client.samba.gw.keyring <systemitem class="domainname">earth</systemitem>:/etc/ceph/
<prompt>root@master # </prompt><command>scp</command> ceph.client.samba.gw.keyring <systemitem class="domainname">mars</systemitem>:/etc/ceph/</screen>
   </step>
   <step>
    <para>
     Préparez <systemitem class="domainname">earth</systemitem> et <systemitem class="domainname">mars</systemitem> pour héberger le service Samba :
    </para>
    <substeps>
     <step>
      <para>
       Assurez-vous que les paquetages suivants sont installés avant de poursuivre :
       <package>ctdb</package>, <package>tdb-tools</package> et
       <package>samba</package> (requis pour les ressources smb et nmb.)
      </para>
<screen><prompt>root # </prompt><command>zypper</command> in ctdb tdb-tools samba samba-ceph</screen>
     </step>
     <step>
      <para>
       Assurez-vous que les services <literal>ctdb</literal>, <literal>smb</literal> et <literal>nmb</literal> sont arrêtés et désactivés :
      </para>
<screen><prompt>root # </prompt><command>systemctl</command> disable ctdb
<prompt>root # </prompt><command>systemctl</command> disable smb
<prompt>root # </prompt><command>systemctl</command> disable nmb
<prompt>root # </prompt><command>systemctl</command> stop smb
<prompt>root # </prompt><command>systemctl</command> stop nmb</screen>
     </step>
     <step>
      <para>
       Ouvrez le port <literal>4379</literal> de votre pare-feu sur tous les noeuds. Cette ouverture est nécessaire pour que CTDB communique avec d'autres noeuds de la grappe.
      </para>
     </step>
     <step>
      <para>
       Créez un répertoire pour le verrou CTDB sur le système de fichiers partagé :
      </para>
<screen><prompt>root # </prompt><command>mkdir</command> -p /srv/samba/</screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Sur <systemitem class="domainname">earth</systemitem>, créez les fichiers de configuration de Samba. Ils seront ensuite automatiquement synchronisés avec <systemitem class="domainname">mars</systemitem>.
    </para>
    <substeps>
     <step>
      <para>
       Dans <filename>/etc/ctdb/nodes</filename>, insérez tous les noeuds qui contiennent toutes les adresses IP privées de chaque noeud de la grappe :
      </para>
<screen>192.168.1.1
192.168.1.2</screen>
     </step>
     <step>
      <para>
       Configurez Samba. Ajoutez les lignes suivantes à la section <literal>[global]</literal> de <filename>/etc/samba/smb.conf</filename>. Utilisez le nom d'hôte de votre choix à la place de « CTDB-SERVER » (tous les noeuds de la grappe apparaîtront sous la forme d'un gros noeud portant ce nom) :
      </para>
<screen>[global]
    netbios name = CTDB-SERVER
    clustering = yes
    idmap config * : backend = tdb2
    passdb backend = tdbsam
    ctdbd socket = /var/lib/ctdb/ctdb.socket</screen>
      <para>
       Pour plus d'informations sur <command>csync2</command>, reportez-vous à l'adresse <link xlink:href="https://www.suse.com/documentation/sle-ha-12/singlehtml/book_sleha/book_sleha.html#pro.ha.installation.setup.csync2.start"/>.
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Installez et amorcez la grappe SUSE Linux Enterprise High Availability.
    </para>
    <substeps>
     <step>
      <para>
       Enregistrez l'extension SUSE Linux Enterprise High Availability Extension sur <systemitem class="domainname">earth</systemitem> et <systemitem class="domainname">mars</systemitem>.
      </para>
<screen><prompt>root@earth # </prompt><command>SUSEConnect</command> -r <replaceable>ACTIVATION_CODE</replaceable> -e <replaceable>E_MAIL</replaceable></screen>
<screen><prompt>root@mars # </prompt><command>SUSEConnect</command> -r <replaceable>ACTIVATION_CODE</replaceable> -e <replaceable>E_MAIL</replaceable></screen>
     </step>
     <step>
      <para>
       Installez <package>ha-cluster-bootstrap</package> sur les deux noeuds :
      </para>
<screen><prompt>root@earth # </prompt><command>zypper</command> in ha-cluster-bootstrap</screen>
<screen><prompt>root@mars # </prompt><command>zypper</command> in ha-cluster-bootstrap</screen>
     </step>
     <step>
      <para>
       Initialisez la grappe sur <systemitem class="domainname">earth</systemitem> :
      </para>
<screen>
<prompt>root@earth # </prompt><command>ha-cluster-init</command>
      </screen>
     </step>
     <step>
      <para>
       Permettez à <systemitem class="domainname">mars</systemitem> de rejoindre la grappe :
      </para>
<screen>
<prompt>root@mars # </prompt><command>ha-cluster-join</command> -c earth
      </screen>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     Vérifiez l'état de la grappe. Vous devriez voir deux noeuds ajoutés à la grappe :
    </para>
<screen><prompt>root@earth # </prompt><command>crm</command> status
2 nodes configured
1 resource configured

Online: [ earth mars ]

Full list of resources:

 admin-ip       (ocf::heartbeat:IPaddr2):       Started earth</screen>
   </step>
   <step>
    <para>
     Exécutez les commandes suivantes sur <systemitem class="domainname">earth</systemitem> pour configurer la ressource CTDB :
    </para>

<screen><prompt>root@earth # </prompt><command>crm</command> configure
<prompt>crm(live)configure# </prompt><command>primitive</command> ctdb ocf:heartbeat:CTDB params \
    ctdb_manages_winbind="false" \
    ctdb_manages_samba="false" \
    ctdb_recovery_lock="!/usr/lib64/ctdb/ctdb_mutex_ceph_rados_helper
        ceph client.samba.gw cephfs_metadata ctdb-mutex"
    ctdb_socket="/var/lib/ctdb/ctdb.socket" \
        op monitor interval="10" timeout="20" \
        op start interval="0" timeout="90" \
        op stop interval="0" timeout="100"
<prompt>crm(live)configure# </prompt><command>primitive</command> nmb systemd:nmb \
    op start timeout="60" interval="0" \
    op stop timeout="60" interval="0" \
    op monitor interval="60" timeout="60"
<prompt>crm(live)configure# </prompt><command>primitive</command> smb systemd:smb \
    op start timeout="60" interval="0" \
    op stop timeout="60" interval="0" \
    op monitor interval="60" timeout="60"
<prompt>crm(live)configure# </prompt><command>group</command> g-ctdb ctdb nmb smb
<prompt>crm(live)configure# </prompt><command>clone</command> cl-ctdb g-ctdb meta interleave="true"
<prompt>crm(live)configure# </prompt><command>commit</command></screen>
    <para>
     Le fichier binaire <command>/usr/lib64/ctdb/ctdb_mutex_ceph_rados_helper</command> de l'option de configuration <literal>ctdb_recovery_lock</literal> possède les paramètres <replaceable>CLUSTER_NAME</replaceable> <replaceable>CEPHX_USER</replaceable> <replaceable>CEPH_POOL</replaceable> <replaceable>CEPHX_USER</replaceable>, dans cet ordre.
    </para>
   </step>
   <step>
    <para>
     Ajoutez une adresse IP en grappe :
    </para>
<screen><prompt>crm(live)configure# </prompt><command>primitive</command> ip ocf:heartbeat:IPaddr2 params ip=192.168.2.1 \
    unique_clone_address="true" \
    op monitor interval="60" \
    meta resource-stickiness="0"
<prompt>crm(live)configure# </prompt><command>clone</command> cl-ip ip \
    meta interleave="true" clone-node-max="2" globally-unique="true"
<prompt>crm(live)configure# </prompt><command>colocation</command> col-with-ctdb 0: cl-ip cl-ctdb
<prompt>crm(live)configure# </prompt><command>order</command> o-with-ctdb 0: cl-ip cl-ctdb
<prompt>crm(live)configure# </prompt><command>commit</command></screen>
    <para>
     Si <literal>unique_clone_address</literal> est défini sur <literal>true</literal>, l'agent de ressource IPaddr2 ajoute un ID de clone à l'adresse spécifiée, ce qui permet d'obtenir trois adresses IP différentes. Elles ne sont généralement pas nécessaires, mais aident à l'équilibrage de la charge. Pour plus d'informations sur ce sujet, reportez-vous à l'adresse <link xlink:href="https://www.suse.com/documentation/sle-ha-12/book_sleha/data/cha_ha_lb.html"/>.
    </para>
   </step>
   <step>
    <para>
     Vérifiez le résultat :
    </para>
<screen><prompt>root@earth # </prompt><command>crm</command> status
Clone Set: base-clone [dlm]
     Started: [ factory-1 ]
     Stopped: [ factory-0 ]
 Clone Set: cl-ctdb [g-ctdb]
     Started: [ factory-1 ]
     Started: [ factory-0 ]
 Clone Set: cl-ip [ip] (unique)
     ip:0       (ocf:heartbeat:IPaddr2):       Started factory-0
     ip:1       (ocf:heartbeat:IPaddr2):       Started factory-1</screen>
   </step>
   <step>
    <para>
     Effectuez un test à partir d'une machine client. Sur un client Linux, exécutez la commande suivante pour vérifier si vous pouvez copier des fichiers depuis et vers le système :
    </para>
<screen><prompt>root # </prompt><command>smbclient</command> <option>//192.168.2.1/myshare</option></screen>
   </step>
  </procedure>
 </sect1>
</chapter>
