<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="lvmcache.xml" version="5.0" xml:id="lvmcache">

 <title>Amélioration des performances avec le cache LVM</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modification</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>oui</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <warning>
  <title>avant-première technologique</title>
  <para>
   Le cache LVM est actuellement une avant-première technologique.
  </para>
 </warning>
 <para>
  Il s'agit d'un mécanisme de caching utilisé pour améliorer les performances d'un volume logique (Logical Volume, LV). Généralement, un périphérique plus petit et plus rapide est utilisé pour améliorer les performances E/S d'un volume logique plus grand et plus lent. Pour plus de détails sur le cache LVM, reportez-vous à sa page de manuel (<command>man 7 lvmcache</command>).
 </para>
 <para>
  Dans SUSE Enterprise Storage, le cache LVM peut améliorer les performances des OSD. La prise en charge du cache LVM est assurée par le biais d'un plug-in <command>ceph-volume</command>. Pour des informations détaillées sur son utilisation, exécutez la commande <command>ceph-volume lvmcache</command>.
 </para>
 <sect1 xml:id="lvmcache-prerequisites">
  <title>Conditions préalables</title>

  <para>
   Pour utiliser les fonctions de cache LVM afin d'améliorer les performances d'une grappe Ceph, vous devez disposer des éléments suivants :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Une grappe Ceph en cours d'exécution dans un état stable (« HEALTH_OK »).
    </para>
   </listitem>
   <listitem>
    <para>
     Des OSD déployés avec BlueStore et LVM. C'est la situation par défaut si les OSD ont été déployés à l'aide de SUSE Enterprise Storage 6 ou version ultérieure.
    </para>
   </listitem>
   <listitem>
    <para>
     Des disques ou des partitions vides qui seront utilisés pour le caching.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="lvmcache-planning">
  <title>Considérations</title>

  <para>
   Considérez les points suivants avant de configurer vos OSD pour utiliser le cache LVM :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <emphasis role="bold">Vérifiez que le cache LVM convient à votre cas d'utilisation.</emphasis> Si vous disposez uniquement de quelques unités rapides qui ne sont <emphasis role="bold">pas</emphasis> utilisées pour les OSD, la recommandation générale est de les employer comme périphériques WAL/DB pour les OSD. Dans un tel cas, les opérations WAL et DB (petites opérations peu fréquentes) sont appliquées sur l'unité rapide, tandis que les opérations de données sont exécutées sur l'unité OSD plus lente.
    </para>
    <tip>
     <para>
      Si la latence est plus importante pour votre déploiement que le débit ou les entrées/sorties par secondes (IOPS), vous pouvez utiliser les unités rapides comme cache LVM plutôt que comme partitions WAL/DB.
     </para>
    </tip>
   </listitem>
   <listitem>
    <para>
     Si vous prévoyez d'utiliser une unité rapide comme cache LVM pour plusieurs OSD, sachez que <emphasis role="bold">toutes les opérations OSD (y compris la réplication) passeront par le périphérique de caching</emphasis>. Toutes les lectures seront demandées à partir du périphérique de caching et ne seront desservies qu'à partir du périphérique lent en cas d'absence dans le cache. Les écritures sont toujours appliquées d'abord au périphérique de caching, puis sont vidées sur le périphérique lent ultérieurement (l'écriture différée, ou « writeback », est le mode de caching par défaut).
    </para>
    <para>
     Lorsque vous décidez d'utiliser un cache LVM ou pas, vérifiez si l'unité rapide peut servir d'interface client pour plusieurs OSD, tout en fournissant une quantité acceptable d'IOPS. Vous pouvez tester cet aspect en mesurant la quantité maximale d'IOPS que le périphérique rapide peut desservir, puis en divisant le résultat par le nombre d'OSD derrière le périphérique rapide. Si le résultat est inférieur ou proche de la quantité maximale d'IOPS que l'OSD peut fournir sans le cache, le cache LVM n'est probablement pas adapté à cette configuration.
    </para>
   </listitem>
   <listitem>
    <para>
     <emphasis role="bold">L'interaction du périphérique de cache LVM avec les OSD est importante.</emphasis> Les écritures sont régulièrement vidées du périphérique de caching vers le périphérique lent. Si le trafic entrant est soutenu et important, le périphérique de caching rencontrera des difficultés à suivre le rythme des demandes entrantes ainsi que le processus de vidage, ce qui entraînera une baisse des performances. Utilisez le cache LVM avec un workload élevé prolongé que si le périphérique rapide peut fournir une quantité IOPS bien supérieure avec une meilleure latence que le périphérique lent. Le trafic dans un modèle de rafales est plus adapté pour le cache LVM, car il donne au cache le temps de vider ses données altérées sans interférer avec le trafic client. Pour un workload de trafic soutenu, mais lent, il est difficile de prédire si l'utilisation du cache LVM améliorera les performances. Le meilleur test est de comparer la configuration de cache LVM avec la configuration WAL/DB. En outre, comme les petites écritures sont lourdes sur la partition WAL, il est suggéré d'utiliser le périphérique rapide pour DB et/ou WAL, au lieu d'un cache LVM.
    </para>
   </listitem>
   <listitem>
    <para>
     Si vous n'êtes pas sûr d'utiliser le cache LVM, utilisez le périphérique rapide comme périphérique WAL et/ou DB.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="lvmcache-preparation">
  <title>Préparation</title>

  <para>
   Vous devez diviser le périphérique rapide en plusieurs partitions. Chaque OSD a besoin de deux partitions pour son cache : une pour les données de cache et une pour les métadonnées de cache. La taille minimale de l'une ou l'autre partition est de 2 Go. Vous pouvez utiliser un seul périphérique rapide pour mettre en cache plusieurs OSD. Il doit simplement être partitionné en conséquence.
  </para>
 </sect1>
 <sect1 xml:id="lvmcache-configuring">
  <title>Configuration du cache LVM</title>

  <para>
   Pour obtenir des informations détaillées sur l'ajout, la suppression et la configuration du cache LVM, exécutez la commande <command>ceph-volume lvmcache</command>.
  </para>

  <sect2 xml:id="lvmcache-adding">
   <title>Ajout du cache LVM</title>
   <para>
    Pour ajouter le cache LVM à un OSD existant, utilisez la commande suivante :
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache add
 --cachemetadata <replaceable>METADATA-PARTITION</replaceable>
 --cachedata <replaceable>DATA-PARTITION</replaceable>
 --osd-id <replaceable>OSD-ID</replaceable>
</screen>
   <para>
    Les valeurs facultatives <option>--data</option>, <option>--db</option> ou <option>--wal</option> spécifient quelle partition mettre en cache. La valeur par défaut est <option>--data</option>.
   </para>
   <tip>
    <title>spécification du volume logique (LV)</title>
    <para>
     Vous pouvez également utiliser l'option <option>--origin</option> au lieu de <option>--osd-id</option> pour spécifier le volume logique à mettre en cache :
    </para>
<screen>
[...]
--origin <replaceable>VOLUME-GROUP</replaceable>/<replaceable>LOGICAL-VOLUME</replaceable>
</screen>
   </tip>
  </sect2>

  <sect2 xml:id="lvmcache-removing">
   <title>Suppression du cache LVM</title>
   <para>
    Pour supprimer le cache LVM existant d'un OSD, utilisez la commande suivante :
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache rm --osd-id <replaceable>OSD-ID</replaceable>
</screen>
  </sect2>

  <sect2 xml:id="lvmcache-mode">
   <title>Définition du mode de cache LVM</title>
   <para>
    Pour spécifier le mode de caching, utilisez la commande suivante :
   </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>ceph-volume lvmcache mode --set <replaceable>CACHING-MODE</replaceable> --osd-id <replaceable>OSD-ID</replaceable>
</screen>
   <para>
    La valeur de <replaceable>CACHING-MODE</replaceable> est « writeback » (écriture différée - valeur par défaut) ou « writethrough » (écriture immédiate).
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="lvmcache-failures">
  <title>Gestion des échecs</title>

  <para>
   Si le périphérique de caching tombe en panne, tous les OSD derrière celui-ci doivent être retirés de la grappe (voir <xref linkend="salt-removing-osd"/>), purgés et redéployés. Si l'unité OSD échoue, le volume logique de l'OSD ainsi que le volume logique de son cache seront actifs, mais pas opérationnels. Utilisez <command>pvremove <replaceable>PARTITION</replaceable></command> pour purger les partitions (volumes physiques) utilisées pour les données de cache et les partitions de métadonnées de l'OSD. Vous pouvez utiliser la commande <command>pvs</command> pour lister tous les volumes physiques.
  </para>
 </sect1>
 <sect1 xml:id="lvmcache-faq">
  <title>Foire aux questions</title>

  <qandaset>
   <qandaentry>
    <question>
     <para>
      Que se passe-t-il si un OSD est supprimé ?
     </para>
    </question>
    <answer>
     <para>
      Lors de la suppression du volume logique d'un OSD à l'aide de <command>lvremove</command>, les volumes logiques de cache sont également supprimés. Cependant, vous devez toujours appeler <command>pvremove</command> sur les partitions pour vous assurer que toutes les étiquettes ont été effacées.
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      Que se passe-t-il si l'OSD est effacé à l'aide de la commande <command>ceph-volume zap</command> ?
     </para>
    </question>
    <answer>
     <para>
      La réponse est la même que pour la question <emphasis role="bold">Que se passe-t-il si un OSD est supprimé ?</emphasis>.
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      Que se passe-t-il si l'unité d'origine tombe en panne ?
     </para>
    </question>
    <answer>
     <para>
      Les volumes logiques de cache existent toujours et la commande <command>cache info</command> continue de les présenter comme étant disponibles. En revanche, vous ne serez pas en mesure d'annuler la mise en cache, car LVM ne parviendra pas à vider le cache puisque le périphérique du volume logique d'origine a disparu. À présent, le volume logique d'origine existe, mais plus le périphérique qui le soutenait. Vous pouvez résoudre ce problème à l'aide de la commande <command>pvs</command> afin de localiser les périphériques qui sont associés au volume logique d'origine. Vous pouvez ensuite les supprimer à l'aide de la commande suivante :
     </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>sudo pvremove /dev/<replaceable>DEVICE</replaceable> or <replaceable>PARTITION</replaceable>
</screen>
     <para>
      Vous pouvez faire de même pour les partitions de cache. Cette procédure fera disparaître le volume logique d'origine ainsi que les volumes logiques de cache. Vous pouvez également utiliser la commande
     </para>
<screen>
<prompt>cephadm@osd &gt; </prompt>sudo dd if=/dev/zero of=/dev/<replaceable>DEVICE</replaceable> or <replaceable>PARTITION</replaceable>
</screen>
     <para>
      pour les effacer avant d'utiliser <command>pvremove</command>.
     </para>
    </answer>
   </qandaentry>
  </qandaset>
 </sect1>
</chapter>
