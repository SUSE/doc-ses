<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="containerized-kubernetes.xml" version="5.0" xml:id="cha-container-kubernetes">

 <title>SUSE Enterprise Storage 6 sur une grappe Kubernetes SUSE CaaS Platform 4</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/master/xml/</dm:editurl>
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modification</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>oui</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <warning>
  <title>avant-première technologique</title>
  <para>
   L'exécution d'une grappe Ceph conteneurisée sur SUSE CaaS Platform est une avant-première technologique. Ne déployez pas cette approche sur une grappe Kubernetes en production.
  </para>
 </warning>
 <para>
  Ce chapitre décrit comment déployer SUSE Enterprise Storage 6 sur une grappe Kubernetes SUSE CaaS Platform 4 conteneurisée.
 </para>
 <sect1 xml:id="kube-consider">
  <title>Considérations</title>

  <para>
   Avant de commencer le déploiement, considérez les points suivants :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Pour exécuter Ceph dans Kubernetes, SUSE Enterprise Storage 6 utilise un projet en amont appelé Rook (<link xlink:href="https://rook.io/"/>).
    </para>
   </listitem>
   <listitem>
    <para>
     Selon la configuration, Rook peut consommer <emphasis>tous</emphasis> les disques inutilisés sur tous les noeuds d'une grappe Kubernetes.
    </para>
   </listitem>
   <listitem>
    <para>
     L'installation des conteneurs privilégiés.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-prereq">
  <title>Conditions préalables</title>

  <para>
   Avant de commencer le déploiement, vous devez disposer des éléments suivants :
  </para>

  <itemizedlist>
   <listitem>
    <para>
     une grappe SUSE CaaS Platform 4 en cours d'exécution ;
    </para>
   </listitem>
   <listitem>
    <para>
     des noeuds de travail SUSE CaaS Platform 4 avec un certain nombre de disques supplémentaires attachés en tant que stockage pour la grappe Ceph.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 xml:id="kube-rook-manifests">
  <title>Obtention des manifestes Rook</title>

  <para>
   L'orchestrateur Rook utilise des fichiers de configuration au format YAML appelés <emphasis>manifestes</emphasis>. Les manifestes dont vous avez besoin sont inclus dans le paquetage RPM
   <package>rook-k8s-yaml</package>. Installez-le en exécutant la commande suivante :
  </para>

<screen><prompt>root # </prompt>zypper install rook-k8s-yaml</screen>
 </sect1>
 <sect1 xml:id="kube-install">
  <title>Installation</title>

  <para>
   Rook-Ceph comprend deux composants principaux : l'opérateur (« operator ») qui est géré par Kubernetes et permet la création de grappes Ceph et la grappe (« cluster ») Ceph proprement dite, qui est créée et partiellement gérée par l'opérateur.
  </para>

  <sect2 xml:id="kube-configure">
   <title>Configuration</title>
   <sect3 xml:id="kube-configure-global">
    <title>Configuration globale</title>
    <para>
     Les manifestes utilisés dans cette configuration installent tous les composants Rook et Ceph dans l'espace de noms « rook-ceph ». Si vous avez besoin de le changer, adaptez en conséquence toutes les références à l'espace de noms dans les manifestes Kubernetes.
    </para>
    <para>
     Selon les fonctions de Rook que vous prévoyez d'utiliser, modifiez la configuration de la stratégie de sécurité des pods (« Pod Security Policy ») dans <filename>common.yaml</filename> pour limiter les exigences de sécurité de Rook. Suivez les commentaires dans le fichier manifeste.
    </para>
   </sect3>
   <sect3 xml:id="kube-config-operator">
    <title>Configuration de l'opérateur</title>
    <para>
     Le manifeste <filename>operator.yaml</filename> configure l'opérateur Rook. Normalement, vous n'avez pas besoin de le modifier. Pour plus d'informations, reportez-vous aux commentaires dans le fichier manifeste.
    </para>
   </sect3>
   <sect3 xml:id="kube-config-ceph">
    <title>Configuration de la grappe Ceph</title>
    <para>
     Le manifeste <filename>cluster.yaml</filename> est responsable de la configuration de la grappe Ceph réelle qui s'exécutera dans Kubernetes. Pour une description détaillée de toutes les options disponibles, reportez-vous à la documentation Rook en amont à la page <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html"/>.
    </para>
    <para>
     Par défaut, Rook est configuré pour utiliser tous les noeuds qui ne sont pas marqués avec l'option <option>node-role.kubernetes.io/master:NoSchedule</option> et obéiront aux paramètres de placement configurés (voir <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-cluster-crd.html#placement-configuration-settings"/>). L'exemple suivant désactive un tel comportement et n'utilise que les noeuds explicitement répertoriés dans la section « nodes » :
    </para>
<screen>
storage:
  useAllNodes: false
  nodes:
    - name: caasp4-worker-0
    - name: caasp4-worker-1
    - name: caasp4-worker-2
</screen>
    <note>
     <para>
      Par défaut, Rook est configuré pour utiliser tous les disques libres et vides sur chaque noeud à des fins de stockage Ceph.
     </para>
    </note>
   </sect3>
   <sect3 xml:id="kube-config-docs">
    <title>Documentation</title>
    <itemizedlist>
     <listitem>
      <para>
       La documentation Rook-Ceph en amont à la page <link xlink:href="https://rook.github.io/docs/rook/master/ceph-storage.html"/> contient des informations plus détaillées sur la configuration de déploiements plus avancés. Utilisez-la comme référence pour comprendre les bases de Rook-Ceph avant d'élaborer des configurations plus complexes.
      </para>
     </listitem>
     <listitem>
      <para>
       Pour plus de détails sur le produit SUSE CaaS Platform, reportez-vous à la page <link xlink:href="https://www.suse.com/documentation/suse-caasp"/>.
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
  </sect2>

  <sect2 xml:id="kube-config-rook-operator">
   <title>Création de l'opérateur Rook</title>
   <para>
    Installez les composants communs Rook-Ceph, les rôles CSI et l'opérateur Rook-Ceph en exécutant la commande suivante sur le noeud maître SUSE CaaS Platform :
   </para>
<screen><prompt>root # </prompt>kubectl apply -f common.yaml -f operator.yaml</screen>
   <para>
    <filename>common.yaml</filename> crée alors l'espace de noms « rook-ceph », les définitions de ressources personnalisées (CRD) Ceph (voir <link xlink:href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/"/>) pour que Kubernetes ait connaissance des objets Ceph (par exemple, « CephCluster »), ainsi que les rôles RBAC et les stratégies de sécurité des pods (voir <link xlink:href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/"/>) qui sont nécessaires pour permettre à Rook de gérer les ressources spécifiques à la grappe.
   </para>
   <tip>
    <title>utilisation de <option>hostNetwork</option> et de <option>hostPorts</option></title>
    <para>
     Permettre l'emploi de <option>hostNetwork</option> est nécessaire en cas d'utilisation de <option>hostNetwork: true</option> dans la définition de ressource de grappe. De même, il est nécessaire d'autoriser l'utilisation de <option>hostPorts</option> dans <literal>PodSecurityPolicy</literal>.
    </para>
   </tip>
   <para>
    Vérifiez l'installation en exécutant <command>kubectl get pods -n rook-ceph</command> sur le noeud maître SUSE CaaS Platform, par exemple :
   </para>
<screen><prompt>root # </prompt>kubectl get pods -n rook-ceph
NAME                                     READY   STATUS      RESTARTS   AGE
rook-ceph-agent-57c9j                    1/1     Running     0          22h
rook-ceph-agent-b9j4x                    1/1     Running     0          22h
rook-ceph-operator-cf6fb96-lhbj7         1/1     Running     0          22h
rook-discover-mb8gv                      1/1     Running     0          22h
rook-discover-tztz4                      1/1     Running     0          22h</screen>
  </sect2>

  <sect2 xml:id="kube-create-ceph-cluster">
   <title>Création de la grappe Ceph</title>
   <para>
    Après avoir modifié <filename>cluster.yaml</filename> en fonction de vos besoins, vous pouvez créer la grappe Ceph. Exécutez la commande suivante sur le noeud maître SUSE CaaS Platform :
   </para>
<screen><prompt>root # </prompt>kubectl apply -f cluster.yaml</screen>
   <para>
    Surveillez l'espace de noms « rook-ceph » pour voir la création de la grappe Ceph. Vous remarquerez autant d'instances Ceph Monitor que le nombre configuré dans le manifeste <filename>cluster.yaml</filename> (3 par défaut), une instance Ceph Manager et autant de Ceph OSD que vous avez de disques libres.
   </para>
   <tip>
    <title>pods OSD temporaires</title>
    <para>
     Pendant l'amorçage de la grappe Ceph, vous constaterez que certains pods nommés <literal>rook-ceph-osd-prepare-<replaceable>NOM-NOEUD</replaceable></literal> s'exécutent un moment, puis s'arrêtent avec le statut « Completed » (Terminé). Comme leur nom l'indique, ces pods provisionnent les Ceph OSD. Ils se ferment sans être supprimés afin que vous puissiez inspecter leurs journaux lorsqu'ils ont fini. Par exemple :
    </para>
<screen><prompt>root # </prompt>kubectl get pods --namespace rook-ceph
NAME                                         READY  STATUS     RESTARTS  AGE
rook-ceph-agent-57c9j                        1/1    Running    0         22h
rook-ceph-agent-b9j4x                        1/1    Running    0         22h
rook-ceph-mgr-a-6d48564b84-k7dft             1/1    Running    0         22h
rook-ceph-mon-a-cc44b479-5qvdb               1/1    Running    0         22h
rook-ceph-mon-b-6c6565ff48-gm9wz             1/1    Running    0         22h
rook-ceph-operator-cf6fb96-lhbj7             1/1    Running    0         22h
rook-ceph-osd-0-57bf997cbd-4wspg             1/1    Running    0         22h
rook-ceph-osd-1-54cf468bf8-z8jhp             1/1    Running    0         22h
rook-ceph-osd-prepare-caasp4-worker-0-f2tmw  0/2    Completed  0         9m35s
rook-ceph-osd-prepare-caasp4-worker-1-qsfhz  0/2    Completed  0         9m33s
rook-ceph-tools-76c7d559b6-64rkw             1/1    Running    0         22h
rook-discover-mb8gv                          1/1    Running    0         22h
rook-discover-tztz4                          1/1    Running    0         22h</screen>
   </tip>
  </sect2>
 </sect1>
 <sect1 xml:id="kube-using-rook">
  <title>Utilisation de Rook comme stockage pour le workload Kubernetes</title>

  <para>
   Rook vous permet d'utiliser trois types différents de stockage :
  </para>

  <variablelist>
   <varlistentry>
    <term><emphasis role="bold">Stockage d'objets</emphasis></term>
    <listitem>
     <para>
      Le stockage d'objets expose une API S3 à la grappe de stockage afin que les applications puissent placer des données et en obtenir. Pour une description détaillée, reportez-vous à la page <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-object.html"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Système de fichiers partagé</term>
    <listitem>
     <para>
      Un système de fichiers partagé peut être monté avec des autorisations de lecture/écriture à partir de plusieurs pods. Cela est utile pour les applications qui sont mises en grappe avec un système de fichiers partagé. Pour une description détaillée, reportez-vous à la page <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-filesystem.html"/>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Stockage de bloc</term>
    <listitem>
     <para>
      Le stockage en bloc vous permet de monter le stockage sur un seul pod. Pour une description détaillée, reportez-vous à la page <link xlink:href="https://rook.io/docs/rook/v1.0/ceph-block.html"/>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="kube-uninstall">
  <title>Désinstallation de Rook</title>

  <para>
   Pour désinstaller Rook, procédez comme suit :
  </para>

  <procedure>
   <step>
    <para>
     Supprimez toutes les applications Kubernetes qui consomment du stockage Rook.
    </para>
   </step>
   <step>
    <para>
     Supprimez tous les artefacts de stockage d'objets, de fichiers et/ou de blocs que vous avez créés selon les explications de la <xref linkend="kube-using-rook"/>.
    </para>
   </step>
   <step>
    <para>
     Supprimez la grappe Ceph, l'opérateur et les ressources associées :
    </para>
<screen>
<prompt>root # </prompt>kubectl delete -f cluster.yaml
<prompt>root # </prompt>kubectl delete -f operator.yaml
<prompt>root # </prompt>kubectl delete -f common.yaml
</screen>
   </step>
   <step>
    <para>
     Supprimez les données sur les hôtes :
    </para>
<screen><prompt>root # </prompt>rm -rf /var/lib/rook</screen>
   </step>
   <step>
    <para>
     Si nécessaire, effacez les disques qui ont été utilisés par Rook. Pour plus d'informations, reportez-vous à la page <link xlink:href="https://rook.io/docs/rook/master/ceph-teardown.html"/>.
    </para>
   </step>
  </procedure>
 </sect1>
</chapter>
