<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_kvm.xml" version="5.0" xml:id="cha-ceph-kvm">
 <title>Ceph comme support de l'instance QEMU/KVM</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>modification</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>oui</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Le cas d'utilisation le plus courant de Ceph consiste à fournir des images de périphériques de bloc aux machines virtuelles. Par exemple, un utilisateur peut créer une image « golden » avec un système d'exploitation et tout logiciel pertinent dans une configuration idéale. Il réalise ensuite un instantané de l'image. Enfin, l'utilisateur clone l'instantané (généralement plusieurs fois, voir <xref linkend="cha-ceph-snapshots-rbd"/> pour plus de détails). La possibilité de créer des clones de copie sur écritures (copy-on-write, COW) d'un instantané signifie que Ceph peut rapidement bloquer les images de périphérique de bloc sur des machines virtuelles, car le client n'a pas besoin de télécharger une image entière chaque fois qu'il fait tourner une nouvelle machine virtuelle.
 </para>
 <para>
  Les périphériques de bloc Ceph peuvent s'intégrer aux machines virtuelles QEMU. Pour plus d'informations sur QEMU KVM, reportez-vous à la page <link xlink:href="https://www.suse.com/documentation/sles-15/book_virt/data/part_virt_qemu.html"/>.
 </para>
 <sect1 xml:id="ceph-kvm-install">
  <title>Installation</title>

  <para>
   Pour pouvoir utiliser les périphériques de bloc Ceph, QEMU doit disposer du pilote approprié. Vérifiez si le paquetage <systemitem>qemu-block-rbd</systemitem> est installé ; installez-le si nécessaire :
  </para>

<screen><prompt>root # </prompt>zypper install qemu-block-rbd</screen>
 </sect1>
 <sect1 xml:id="ceph-kvm-usage">
  <title>Syntaxe</title>

  <para>
   Vous devez indiquer le nom de la réserve et le nom de l'image sur la ligne de commande QEMU. Vous pouvez également spécifier un nom d'instantané.
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable><replaceable>:option1=value1</replaceable><replaceable>:option2=value2...</replaceable></screen>

  <para>
   Par exemple, les options <replaceable>id</replaceable> et <replaceable>conf</replaceable> peuvent se présenter ainsi :
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable>:<option>id=glance:conf=/etc/ceph/ceph.conf</option></screen>
 </sect1>
 <sect1>
  <title>Création d'images avec QEMU</title>

  <para>
   Vous pouvez créer une image de périphérique de bloc à partir de QEMU. Vous devez spécifier <literal>rbd</literal>, le nom de la réserve et le nom de l'image que vous souhaitez créer. Vous devez également indiquer la taille de l'image.
  </para>

<screen>qemu-img create -f raw rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Par exemple :
  </para>

<screen>qemu-img create -f raw rbd:pool1/image1 10G
Formatting 'rbd:pool1/image1', fmt=raw size=10737418240 nocow=off cluster_size=0</screen>

  <important>
   <para>
    Le format de données <literal>raw</literal> (brut) est le seul format qu'il est raisonnable d'utiliser avec RBD. Techniquement, vous pouvez utiliser d'autres formats pris en charge par QEMU, tels que <literal>qcow2</literal>, mais cela ajoutera un overhead supplémentaire et fera que le volume ne sera plus sécurisé pour la migration en direct de la machine virtuelle si le caching est activé.
   </para>
  </important>
 </sect1>
 <sect1>
  <title>Redimensionnement d'images avec QEMU</title>

  <para>
   Vous pouvez redimensionner une image de périphérique de bloc à partir de QEMU. Vous devez spécifier <literal>rbd</literal>, le nom de la réserve et le nom de l'image que vous souhaitez redimensionner. Vous devez également indiquer la taille de l'image.
  </para>

<screen>qemu-img resize rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   Par exemple :
  </para>

<screen>qemu-img resize rbd:pool1/image1 9G
Image resized.</screen>
 </sect1>
 <sect1>
  <title>Récupération d'informations d'image avec QEMU</title>

  <para>
   Vous pouvez récupérer des informations d'image de périphérique de bloc à partir de QEMU. Vous devez spécifier <literal>rbd</literal>, le nom de la réserve et le nom de l'image.
  </para>

<screen>qemu-img info rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>

  <para>
   Par exemple :
  </para>

<screen>qemu-img info rbd:pool1/image1
image: rbd:pool1/image1
file format: raw
virtual size: 9.0G (9663676416 bytes)
disk size: unavailable
cluster_size: 4194304</screen>
 </sect1>
 <sect1>
  <title>Exécution de QEMU avec RBD</title>

  <para>
   QEMU peut accéder à une image en tant que périphérique de bloc virtuel directement via <systemitem>librbd</systemitem>. Cela évite un changement de contexte supplémentaire et permet de tirer parti du caching RBD.
  </para>

  <para>
   Vous pouvez utiliser <command>qemu-img</command> pour convertir des images de machines virtuelles existantes en images de périphériques de bloc Ceph. Par exemple, si vous disposez d'une image qcow2, vous pouvez exécuter :
  </para>

<screen>qemu-img convert -f qcow2 -O raw sles12.qcow2 rbd:pool1/sles12</screen>

  <para>
   Pour exécuter un démarrage de machine virtuelle à partir de cette image, vous pouvez exécuter :
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12</screen>

  <para>
   Le caching RBD peut améliorer considérablement les performances. Les options de cache de QEMU contrôlent le caching <systemitem>librbd</systemitem> :
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=rbd,file=rbd:pool1/sles12,cache=writeback</screen>

  <para>
   Pour plus d'informations sur le caching RBD, reportez-vous à la <xref linkend="rbd-cache-settings"/>.
  </para>
 </sect1>
 <sect1>
  <title>Activation du rejet/TRIM</title>

  <para>
   Les périphériques de bloc Ceph prennent en charge l'opération de rejet. Cela signifie qu'un invité peut envoyer des requêtes TRIM pour permettre à un périphérique de bloc Ceph de récupérer l'espace inutilisé. Cette fonction peut être activée sur l'invité en montant le système de fichiers <systemitem>XFS</systemitem> avec l'option discard.
  </para>

  <para>
   Afin que cette option soit disponible pour l'invité, elle doit être activée explicitement pour le périphérique de bloc. Pour ce faire, vous devez spécifier une option <option>discard_granularity</option> associée à l'unité :
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12,id=drive1,if=none \
-device driver=ide-hd,drive=drive1,discard_granularity=512</screen>

  <note>
   <para>
    L'exemple ci-dessus utilise le pilote IDE. Le pilote virtio ne prend pas en charge le rejet.
   </para>
  </note>

  <para>
   Si vous utilisez <systemitem>libvirt</systemitem>, modifiez le fichier de configuration de votre domaine libvirt à l'aide de <command>virsh edit</command> afin d'inclure la valeur <literal>xmlns:qemu</literal>. Ajoutez ensuite un <literal>qemu:commandline block</literal> en tant qu'enfant de ce domaine. L'exemple suivant montre comment définir deux périphériques avec <literal>qemu id =</literal> et associer des valeurs <literal>discard_granularity</literal> différentes à cet identifiant. 
  </para>

<screen>
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
 &lt;qemu:commandline&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-0.discard_granularity=4096'/&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-1.discard_granularity=65536'/&gt;
 &lt;/qemu:commandline&gt;
&lt;/domain&gt;</screen>
 </sect1>
 <sect1>
  <title>Options du cache QEMU</title>

  <para>
   Les options du cache QEMU correspondent aux paramètres du cache Ceph RBD suivants.
  </para>

  <para>
   Writeback (Écriture différée) :
  </para>

<screen>rbd_cache = true</screen>

  <para>
   WriteThrough (Écriture immédiate) :
  </para>

<screen>rbd_cache = true
rbd_cache_max_dirty = 0</screen>

  <para>
   Aucun :
  </para>

<screen>rbd_cache = false</screen>

  <para>
   Les paramètres du cache QEMU remplacent les paramètres par défaut de Ceph (paramètres qui ne sont pas explicitement définis dans le fichier de configuration de Ceph). Si vous définissez explicitement les paramètres de cache RBD dans votre fichier de configuration Ceph (voir <xref linkend="rbd-cache-settings"/>), vos paramètres Ceph remplacent les paramètres du cache QEMU. Si vous définissez les paramètres du cache sur la ligne de commande QEMU, les paramètres de ligne de commande QEMU remplacent les paramètres du fichier de configuration Ceph.
  </para>
 </sect1>
</chapter>
