<?xml version="1.0" encoding="UTF-8"?>
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ceph_maintenance_updates.xml" version="5.0">
 <title>アップストリーム「Nautilus」ポイントリリースに基づくCeph保守更新</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>編集</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  SUSE Enterprise Storage 6のいくつかの主要パッケージは、CephのNautilusリリースシリーズに基づいています。Cephプロジェクト(<link xlink:href="https://github.com/ceph/ceph"/>)がNautilusシリーズの新しいポイントリリースを公開した場合、SUSE Enterprise Storage 6は、アップストリームの最新のバグ修正や機能のバックポートのメリットを得られるように更新されます。
 </para>
 <para>
  この章には、製品に組み込み済みか、組み込みが予定されている各アップストリームポイントリリースに含まれる重要な変更点についての概要が記載されています。
 </para>
 <bridgehead renderas="sect1">Nautilus 14.2.9ポイントリリース</bridgehead>
 <para>
  このアップストリームリリースでは、次の2つのセキュリティ上の欠陥を修正しました。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    CVE-2020-1759: msgr V2セキュアモードでのナンスの再利用を修正
   </para>
  </listitem>
  <listitem>
   <para>
    CVE-2020-1760: RGW GetObjectヘッダー分割によるXSSを修正
   </para>
  </listitem>
 </itemizedlist>
 <para>
  SES 6では、これらの欠陥はCephバージョン14.2.5.389+gb0f23ac248でパッチが適用されました。
 </para>
 <bridgehead renderas="sect1">Nautilus 14.2.8ポイントリリース</bridgehead>
 <para>
  バグ修正に加えて、このメジャーアップストリームリリースでは、いくつかの注目すべき変更が行われました。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <option>bluestore_min_alloc_size_ssd</option>のデフォルト値は、すべてのワークロードにわたるパフォーマンスを向上させるために4Kに変更されました。
   </para>
  </listitem>
  <listitem>
   <para>
    BlueStoreキャッシュの自動調整に関連する次のOSDメモリ設定オプションは、実行時に設定できるようになりました。
   </para>
<screen>
osd_memory_base (default: 768 MB)
osd_memory_cache_min (default: 128 MB)
osd_memory_expected_fragmentation (default: 0.15)
osd_memory_target (default: 4 GB)
</screen>
   <para>
    次のコマンドを実行して、前述のオプションを設定できます。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph config set osd <replaceable>OPTION</replaceable> <replaceable>VALUE</replaceable></screen>
  </listitem>
  <listitem>
   <para>
    Ceph Managerは、<literal>プロファイルrbd</literal>および<literal>プロファイルrbd-read-only</literal>ユーザ機能を受け入れるようになりました。これらの機能を使用して、<literal>rbd perf image iostat</literal>や<literal>rbd perf image iotop</literal>などのMGRベースのRBD機能へのアクセスをユーザに提供できます。
   </para>
  </listitem>
  <listitem>
   <para>
    アップマップバランシングに使用される設定値<option>osd_calc_pg_upmaps_max_stddev</option>は削除されました。代わりに、Ceph Managerバランサ設定オプション<option>upmap_max_deviation</option>を使用します。これは現在は、OSDごとのターゲットPGからの偏差PGの整数です。次のコマンドで設定できます。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph config set mgr mgr/balancer/upmap_max_deviation 2</screen>
   <para>
    デフォルトの<option>upmap_max_deviation</option>は5です。Crushルールにより、プールでPGのバランスを完全に調整できない状況があります。たとえば、Crushが3つの各ラックに1つのレプリカを必要とするが、ラックの1つでOSDが少ない場合などです。このような場合は、設定値を増やすことができます。
   </para>
  </listitem>
  <listitem>
   <para>
    CephFS: 複数のアクティブなメタデータサーバ転送スクラブが拒否されるようになりました。現在、スクラブはシングルランクのファイルシステムでのみ許可されています。<command>ceph fs set <replaceable>FS_NAME</replaceable> max_mds 1</command>を介して、ランクを1に減らします。
   </para>
  </listitem>
  <listitem>
   <para>
    Cephは、RADOSプールに2の累乗ではない<option>pg_num</option>値がある場合、ヘルス警告を発行します。これは、プールを近くの2の累乗に調整することで修正できます。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd pool set <replaceable>POOL_NAME</replaceable> pg_num <replaceable>NEW_PG_NUM</replaceable></screen>
   <para>
    または、次のようにして警告を消音することもできます。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph config set global mon_warn_on_pool_pg_num_not_power_of_two false</screen>
  </listitem>
 </itemizedlist>
 <bridgehead renderas="sect1">Nautilus 14.2.7ポイントリリース</bridgehead>
 <para>
  このアップストリームリリースでは、次の2つのセキュリティ上の欠陥を修正しました。
 </para>
 <itemizedlist>
  <listitem>
   <para>
    CVE-2020-1699: Cephダッシュボードのパストラバーサルの欠陥により、情報漏洩の可能性があります。
   </para>
  </listitem>
  <listitem>
   <para>
    CVE-2020-1700: 認証されていないクライアントからのサービス拒否につながる可能性のあるRGWビーストフロントエンドの欠陥。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  SES 6では、これらの欠陥にCephバージョン14.2.5.382+g8881d33957bでパッチが適用されました。
 </para>
 <bridgehead renderas="sect1">Nautilus 14.2.6ポイントリリース</bridgehead>
 <para>
  このリリースでは、大規模なクラスタでMGRが応答しなくなるCeph Managerのバグが修正されました。SESユーザはこのバグにさらされていません。
 </para>
 <bridgehead renderas="sect1">Nautilus 14.2.5ポイントリリース</bridgehead>
 <itemizedlist>
  <listitem>
   <para>
    <emphasis role="bold">デーモンが最近クラッシュした場合、ヘルス警告が発行されるようになりました。</emphasis>デーモンが最近クラッシュした場合、Cephでヘルス警告が発行されます。Cephは最初のNautilusリリースからクラッシュレポートを収集していますが、ヘルスアラートは新しいものです。新しいクラッシュ(アップグレードしたばかりの場合は、すべてのクラッシュ)を表示するには、次のコマンドを実行します。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph crash ls-new</screen>
   <para>
    特定のクラッシュ(またはすべてのクラッシュ)を確認して、ヘルス警告を消音するには、次のコマンドを実行します。
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph crash archive <replaceable>CRASH-ID</replaceable>
<prompt>cephadm@adm &gt; </prompt>ceph crash archive-all
</screen>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold"><option>pg_num</option>は2の累乗である必要があります。そうでない場合、<literal>HEALTH_WARN</literal>が報告されます。</emphasis> Cephは、RADOSプールに2の累乗ではない<option>pg_num</option>値がある場合、ヘルス警告を発行します。これは、プールを近くの2の累乗に調整することで修正できます。
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph osd pool set <replaceable>POOL-NAME</replaceable> pg_num <replaceable>NEW-PG-NUM</replaceable>
</screen>
   <para>
    または、次のようにして警告を消音することもできます。
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph config set global mon_warn_on_pool_pg_num_not_power_of_two false
</screen>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">プールサイズは1より大きくする必要があります。そうでない場合、<literal>HEALTH_WARN</literal>が報告されます。</emphasis>RADOSプールのサイズが1に設定されている場合、またはプールが冗長性なしで設定されている場合、Cephはヘルス警告を発行します。プールサイズが最小推奨値に設定されている場合、Cephは警告の発行を停止します。
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph osd pool set <replaceable>POOL-NAME</replaceable> size <replaceable>NUM-REPLICAS</replaceable>
</screen>
   <para>
    次のようにして警告を消音することができます。
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph config set global mon_warn_on_pool_no_redundancy false
</screen>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">OSDハートビートpingの平均時間がしきい値を超えると、ヘルス警告が報告されます。</emphasis>OSDハートビートpingの平均時間が、計算された間隔のいずれかで設定可能なしきい値を超えると、ヘルス警告が生成されるようになりました。OSDは、平均値、最小値、最大値を使用して、1分、5分、15分の間隔を計算します。
   </para>
   <para>
    新しい設定オプション<option>mon_warn_on_slow_ping_ratio</option>は、<option>osd_heartbeat_grace</option>のパーセンテージを指定して、しきい値を決定します。ゼロの値は警告を無効にします。
   </para>
   <para>
    ミリ秒単位で指定された新しい設定オプション<option>mon_warn_on_slow_ping_time</option>は、計算された値を上書きし、OSDハートビートpingが指定された値より長くかかる場合に警告を発生させます。
   </para>
   <para>
    新しいコマンド<command>ceph daemon mgr.<replaceable>MGR-NUMBER</replaceable> dump_osd_network <replaceable>THRESHOLD</replaceable></command>は、3つの間隔のいずれかの平均に対して、ping時間が、指定されたしきい値または設定オプションで決定された値よりも長いすべての接続を一覧にします。
   </para>
   <para>
    新しいコマンド<command>ceph daemon osd.# dump_osd_network <replaceable>THRESHOLD</replaceable></command>は以前のものと同じですが、指定されたOSDによって開始されたハートビートのみが含まれます。
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">テレメトリMGRモジュールの変更。</emphasis>
   </para>
   <para>
    新しい「デバイス」チャネル(デフォルトで有効)は、デバイスの障害予測アルゴリズムを構築および改善するために、匿名のハードディスクとSSDの正常性メトリックを<literal>telemetry.ceph.com</literal>に報告します。
   </para>
   <para>
    テレメトリは、CephFSファイルシステムに関する次の情報を報告します。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      MDSデーモンの数(合計およびファイルシステムごと)。
     </para>
    </listitem>
    <listitem>
     <para>
      どの機能が有効か(または有効になっているか)。
     </para>
    </listitem>
    <listitem>
     <para>
      データプールの数。
     </para>
    </listitem>
    <listitem>
     <para>
      ファイルシステムの概算年数(作成された年と月)。
     </para>
    </listitem>
    <listitem>
     <para>
      ファイル、バイト、およびスナップショットの数。
     </para>
    </listitem>
    <listitem>
     <para>
      キャッシュされているメタデータの量。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    その他の情報:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      モニターが実行されているCephリリース。
     </para>
    </listitem>
    <listitem>
     <para>
      MSGR v1またはv2アドレスがモニターに使用されているかどうか。
     </para>
    </listitem>
    <listitem>
     <para>
      IPv4またはIPv6アドレスがモニターに使用されているかどうか。
     </para>
    </listitem>
    <listitem>
     <para>
      RADOSキャッシュ階層化が有効かどうか(およびモード)。
     </para>
    </listitem>
    <listitem>
     <para>
      プールが複製されるか、イレイジャコード化済みか、どのイレイジャコードプロファイルプラグインとパラメータが使用されているか。
     </para>
    </listitem>
    <listitem>
     <para>
      クラスタ内にあるホストの数、および各タイプのデーモンを持つホストの数。
     </para>
    </listitem>
    <listitem>
     <para>
      個別のOSDクラスタネットワークが使用されているかどうか。
     </para>
    </listitem>
    <listitem>
     <para>
      クラスタ内にあるRBDプールとイメージの数、およびRBDミラーリングが有効になっているプールの数。
     </para>
    </listitem>
    <listitem>
     <para>
      存在するRGWデーモン、ゾーン、およびゾーングループの数、および使用されているRGWフロントエンド。
     </para>
    </listitem>
    <listitem>
     <para>
      使用されているアルゴリズム、バケットの大きさ、定義されているルールの数、使用中の調整可能パラメータなど、CRUSHマップに関する統計情報の集約。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    14.2.5より前にテレメトリを有効にしていた場合は、以下を使用して再度オプトインする必要があります。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph telemetry on</screen>
   <para>
    デバイスメトリックの共有に不安がある場合は、最初にそのチャネルを無効にしてから再度オプトインすることができます。
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph config set mgr mgr/telemetry/channel_device false
<prompt>cephadm@adm &gt; </prompt>ceph telemetry on
</screen>
   <para>
    最初に報告される情報を正確に表示するには、次のようにします。
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph telemetry show        # see everything
<prompt>cephadm@adm &gt; </prompt>ceph telemetry show device # just the device info
<prompt>cephadm@adm &gt; </prompt>ceph telemetry show basic  # basic cluster info
</screen>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">新しいOSDデーモンコマンド<command>dump_recovery_reservations</command></emphasis>。保持されている(<option>in_progress</option>)回復ロックと、優先キューで待機している回復ロックが表示されます。説明:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph daemon osd.<replaceable>ID</replaceable> dump_recovery_reservations
</screen>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">新しいOSDデーモンコマンド<command>dump_scrub_reservations</command>。</emphasis>これは、ローカル(プライマリ)およびリモート(レプリカ) PGに対して保持されているスクラブ予約を表示します。説明:
   </para>
<screen>
<prompt>cephadm@adm &gt; </prompt>ceph daemon osd.<replaceable>ID</replaceable> dump_scrub_reservations
</screen>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">RGWは、S3オブジェクトロックAPIセットをサポートするようになりました。</emphasis>RGWは、オブジェクトを格納するためのWORMモデルを可能にするS3オブジェクトロックAPIセットをサポートするようになりました。6つの新しいAPIが追加されました。これは、PUT/GETバケットオブジェクトロック、PUT/GETオブジェクトリテンション、PUT/GETオブジェクトの法的保持です。
   </para>
  </listitem>
  <listitem>
   <para>
    <emphasis role="bold">RGWがList Objects V2をサポートするようになりました。</emphasis>RGWは、以下のリンクで指定されたList Objects V2をサポートするようになりました: <link xlink:href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjectsV2.html"/>
   </para>
  </listitem>
 </itemizedlist>
 <bridgehead renderas="sect1">Nautilus 14.2.4ポイントリリース</bridgehead>
 <para>
  このポイントリリースでは、14.2.3ポイントリリースで見つかった重大なリグレッションが修正されます。SUSEは14.2.3に基づくバージョンを出荷していないため、このバグはSUSE Enterprise Storageのお客様には影響しませんでした。
 </para>
 <bridgehead renderas="sect1">Nautilus 14.2.3ポイントリリース</bridgehead>
 <itemizedlist>
  <listitem>
   <para>
    サービス拒否の脆弱性により、認証されていないCeph Object Gatewayクライアントが、キャッチされない例外によるクラッシュをトリガする可能性がありました。この脆弱性を修正しました。
   </para>
  </listitem>
  <listitem>
   <para>
    NautilusベースのlibrbdクライアントでJewelクラスタ上のイメージを開くことができるようになりました。
   </para>
  </listitem>
  <listitem>
   <para>
    Object Gateway <option>num_rados_handles</option>が削除されました。1より大きい <option>num_rados_handles</option>の値を使用している場合に、同じ調整動作を実現するには、現在の <option>objecter_inflight_ops</option>パラメータと<option>objecter_inflight_op_bytes</option>パラメータに古い <option>num_rados_handles</option>を掛けます。
   </para>
  </listitem>
  <listitem>
   <para>
    このリリースにより、Messenger v2プロトコルのセキュアモードは実験用ではなくなりました。このモードは、モニター接続の優先モードになりました。
   </para>
  </listitem>
  <listitem>
   <para>
    <option>osd_deep_scrub_large_omap_object_key_threshold</option>の値を下げ、大量のomapキーが含まれるオブジェクトをより簡単に検出できるようにしました。
   </para>
  </listitem>
  <listitem>
   <para>
    CephダッシュボードがPrometheus通知の無音化をサポートしました。
   </para>
  </listitem>
 </itemizedlist>
 <bridgehead renderas="sect1">Nautilus 14.2.2ポイントリリース</bridgehead>
 <itemizedlist>
  <listitem>
   <para>
    <literal>no{up,down,in,out}</literal>関連のコマンドが刷新されました。<literal>no{up,down,in,out}</literal>フラグを設定する方法は2つあります。古いコマンドは次のとおりです。
   </para>
<screen>ceph osd [un]set <replaceable>FLAG</replaceable></screen>
   <para>
    これは、クラスタ全体にフラグを設定します。新しいコマンドは次のとおりです。
   </para>
<screen>ceph osd [un]set-group <replaceable>FLAGS</replaceable> <replaceable>WHO</replaceable></screen>
   <para>
    これは、クラッシュノードまたはデバイスクラスの粒度でバッチでフラグを設定します。
   </para>
  </listitem>
  <listitem>
   <para>
    古いバージョンのObject Gatewayでは、バケットのリシャーディング後に、期限切れの古いオブジェクトが残ることがありました。<command>radosgw-admin</command>に、このようなオブジェクトを管理できるサブコマンドが2つ導入されました。Expire-staleオブジェクトは、自動的に消去されるはずであるがまだ存在し、手動で一覧表示および削除する必要がある期限切れオブジェクトです。一方のサブコマンドは、このようなオブジェクトを一覧にし、他方のサブコマンドはこれらを削除します。
   </para>
  </listitem>
  <listitem>
   <para>
    以前のNautilusリリース(14.2.1および14.2.0)には、アップグレードされたクラスタ(元々、Nautilus以前に導入されたクラスタ)に単一の新しいNautilus BlueStore OSDを導入すると、<command>ceph df</command>によってレポートされるプール使用率統計情報が壊れるという問題がありました。すべてのOSDを再プロビジョニングまたは更新するまで(<command>ceph-bluestore-tool repair</command>を使用)、プール統計情報には、実際の値より小さい値が表示されます。これが14.2.2で解決され、クラスタはより正確なプールごとの統計を使用するように切り替わります。ただし、<emphasis/>「すべて」のOSDが14.2.2以降であること、ブロックストレージであること、かつNautilusより前に作成されている場合は修復機能を使用して更新されていること、という条件があります。
   </para>
  </listitem>
  <listitem>
   <para>
    <option>mon_crush_min_required_version</option>のデフォルト値が<literal>firefly</literal>から<literal>hammer</literal>に変更されました。つまり、CRUSH調整可能パラメータがHammerより古い場合、クラスタによってヘルス警告が発行されます。一般的には、Hammer調整可能パラメータに切り替わったあとでリバランスされるデータの量は、わずかです(ただし、ゼロではありません)。
   </para>
   <para>
    可能な場合は、許可されている最も古いクライアントを<literal>hammer</literal>以降に設定することをお勧めします。現在許可されている最も古いクライアントを表示するには、次のコマンドを実行します。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd dump | grep min_compat_client</screen>
   <para>
    現在の値が<literal>hammer</literal>より古い場合は、次のコマンドを実行して、現在クラスタに接続しているクライアントの中にHammerより古いものがないことを確認し、この変更を行っても安全かどうかを判断してください。
   </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph features</screen>
   <para>
    新しい<literal>straw2</literal> CRUSHバケットタイプがHammerに導入されました。すべてのクライアントがHammer以降であることを確認したら、バランサの<literal>crush-compat</literal>モードを含む、<literal>straw2</literal>バケットでのみサポートされる新機能を使用できます(<xref linkend="mgr-modules-balancer"/>)。
   </para>
  </listitem>
 </itemizedlist>
 <para>
  パッチの詳細については、<link xlink:href="https://download.suse.com/Download?buildid=D38A7mekBz4~"/>を参照してください。
 </para>
 <bridgehead renderas="sect1">Nautilus 14.2.1ポイントリリース</bridgehead>
 <para>
  これは、元のNautilusリリース(14.2.0)に続く最初のポイントリリースでした。SUSE Enterprise Storage 6の元の(「一般提供」または「GA」)バージョンは、このポイントリリースに基づいていました。
 </para>
</appendix>
