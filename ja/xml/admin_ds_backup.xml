<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ds_backup.xml" version="5.0" xml:id="cha-deployment-backup">
 <title>クラスタ設定とデータのバックアップ</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>編集</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  この章では、Cephクラスタの機能を復元できるようにするには、クラスタのどの部分をバックアップする必要があるかについて説明します。
 </para>
 <sect1 xml:id="backup-ceph">
  <title>Ceph設定のバックアップ</title>

  <para>
   <filename>/etc/ceph</filename>ディレクトリをバックアップします。ここには、重要なクラスタ設定が含まれています。たとえば、管理ノードを交換する必要がある場合、<filename>/etc/ceph</filename>のバックアップが必要になります。
  </para>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-salt">
  <title>Salt設定のバックアップ</title>

  <para>
   <filename>/etc/salt/</filename>ディレクトリをバックアップする必要があります。ここには、Salt Masterのキーや受け付けたクライアントキーなど、Saltの各種設定ファイルが含まれています。
  </para>

  <para>
   管理ノードをバックアップする場合にSaltのファイルは厳密には必須ではありませんが、バックアップしておくとSaltクラスタの再展開が容易になります。これらのファイルのバックアップがないと、新しい管理ノードで再度Salt Minionを登録する必要があります。
  </para>

  <note>
   <title>Salt Masterの秘密鍵のセキュリティ</title>
   <para>
    Salt Masterの秘密鍵のバックアップは必ず安全な場所に保存してください。Salt Masterのキーを使用すると、すべてのクラスタノードを操作できます。
   </para>
  </note>

  <para>
   <filename>/etc/salt</filename>ディレクトリをバックアップから復元した後、Saltサービスを再起動します。
  </para>

<screen><prompt>root@master # </prompt><command>systemctl</command> restart salt-master
<prompt>root@master # </prompt><command>systemctl</command> restart salt-minion</screen>
 </sect1>
 <sect1 xml:id="sec-deployment-backup-deepsea">
  <title>DeepSea設定のバックアップ</title>

  <para>
   DeepSeaに必要なファイルはすべて<filename>/srv/pillar/</filename>、<filename>/srv/salt/</filename>、および<filename>/etc/salt/master.d</filename>に保存されます。
  </para>

  <para>
   管理ノードの再展開が必要になった場合は、新しいノードにDeepSeaパッケージをインストールして、バックアップデータをこれらのディレクトリに戻します。これにより、ほかの変更を行うことなくDeepSeaを再び使用できます。DeepSeaを再び使用する前に、管理ノードにすべてのSalt Minionが正しく登録されていることを確認してください。
  </para>
 </sect1>
 <sect1 xml:id="backup-config-files">
  <title>カスタム設定のバックアップ</title>

  <itemizedlist>
   <listitem>
    <para>
     Prometheusのデータおよびカスタマイズ。
    </para>
   </listitem>
   <listitem>
    <para>
     Grafanaのカスタマイズ。
    </para>
   </listitem>
   <listitem>
    <para>
     既存のopenATTICユーザのレコードがあり、Cephダッシュボードでこれらのユーザの新しいアカウントを作成できることを確認します。
    </para>
   </listitem>
   <listitem>
    <para>
     DeepSeaの外部で行った、<filename>ceph.conf</filename>への手動変更。
    </para>
   </listitem>
   <listitem>
    <para>
     DeepSeaの外部で行った、iSCSI設定への手動変更。
    </para>
   </listitem>
   <listitem>
    <para>
     Cephの各種キー。
    </para>
   </listitem>
   <listitem>
    <para>
     CRUSHマップおよびCRUSHルール。次のコマンドを実行して、CRUSHルールを含む、逆コンパイルされたCRUSHマップを<filename>crushmap-backup.txt</filename>に保存します。
    </para>
<screen><prompt>cephadm@adm &gt; </prompt>ceph osd getcrushmap | crushtool -d - -o crushmap-backup.txt</screen>
   </listitem>
   <listitem>
    <para>
     Samba Gatewayの設定。ゲートウェイを1つ使用している場合は、<filename>/etc/samba/smb.conf</filename>をバックアップします。HAセットアップを使用している場合は、CTDBおよびPacemakerの設定ファイルもバックアップします。Samba Gatewayで使用する設定の詳細については、<xref linkend="cha-ses-cifs"/>を参照してください。
    </para>
   </listitem>
   <listitem>
    <para>
     NFS Ganeshaの設定。HAセットアップの使用時にのみ必要。NFS Ganeshaで使用する設定の詳細については、<xref linkend="cha-ceph-nfsganesha"/>を参照してください。
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
