<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="deployment_ganesha.xml" version="5.0" xml:id="cha.as.ganesha">

 <title>NFS Ganeshaのインストール</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer>tbazant@suse.com</dm:maintainer>
        <dm:status>編集</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  NFS Ganeshaは、Object GatewayまたはCephFSにNFSアクセスを提供します。SUSE Enterprise Storage 5では、NFSバージョン3と4がサポートされています。NFS Ganeshaはカーネル空間ではなくユーザ空間で動作し、Object GatewayまたはCephFSと直接対話します。
 </para>
 <sect1 xml:id="sec.as.ganesha.preparation">
  <title>準備</title>

  <sect2 xml:id="sec.as.ganesha.preparation.general">
   <title>一般情報</title>
   <para>
    NFS Ganeshaを正しく展開するには、<filename>/srv/pillar/ceph/proposals/policy.cfg</filename>に<literal>role-ganesha</literal>を追加する必要があります。詳細については、<xref linkend="policy.configuration"/>を参照してください。さらに、<filename>policy.cfg</filename>に<literal>role-rgw</literal>または<literal>role-mds</literal>も存在する必要があります。
   </para>
   <para>
    すでに存在するCephノードにNFS Ganeshaサーバをインストールして実行することはできますが、Cephクラスタにアクセスできる専用のホストで実行することをお勧めします。通常、クライアントホストはクラスタには含まれませんが、NFS Ganeshaサーバに対するネットワークアクセスが必要です。
   </para>
   <para>
    NFS Ganeshaサーバを初期インストール後の任意の時点で有効にするには、<filename>policy.cfg</filename>に<literal>role-ganesha</literal>を追加して、少なくともDeepSeaのステージ2および4をもう一度実行します。詳細については、<xref linkend="ceph.install.stack"/>を参照してください。
   </para>
   <para>
    NFS Ganeshaの設定には、NFS Ganeshaノードに存在するファイル<filename>/etc/ganesha/ganesha.conf</filename>を使用します。ただし、このファイルはDeepSeaステージ4を実行するたびに上書きされます。したがって、Saltが使用するテンプレートを編集することをお勧めします。このテンプレートは、Salt Master上にあるファイル<filename>/srv/salt/ceph/ganesha/files/ganesha.conf.j2</filename>です。設定ファイルの詳細については、<xref linkend="ceph.nfsganesha.config"/>を参照してください。
   </para>
  </sect2>

  <sect2 xml:id="sec.as.ganesha.preparation.requirements">
   <title>要件の概要</title>
   <para>
    DeepSeaステージ2および4を実行してNFS Ganeshaをインストールするには、以下の要件を満たす必要があります。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      少なくとも1つのノードに<literal>role-ganesha</literal>が割り当てられている必要があります。
     </para>
    </listitem>
    <listitem>
     <para>
      1つのミニオンに定義できる<literal>role-ganesha</literal>は1つだけです。
     </para>
    </listitem>
    <listitem>
     <para>
      NFS Ganeshaが動作するにはObject GatewayまたはCephFSが必要です。
     </para>
    </listitem>
    <listitem>
     <para>
      NFS GaneshaがObject Gatewayを使用してクラスタと連携する予定の場合は、Salt Masterの<filename>/srv/pillar/ceph/rgw.sls</filename>にデータを設定する必要があります。
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.as.ganesha.basic_example">
  <title>インストールの例</title>

  <para>
   この手順では、Object GatewayとNFS GaneshaのCephFS FSAL (File System Abstraction Layers)の両方を使用するインストールの例について説明します。
  </para>

  <procedure>
   <step>
    <para>
     DeepSeaステージ0と1をまだ実行していない場合は、この手順に進む前に実行します。
    </para>
<screen><prompt>root # </prompt><command>salt-run</command> state.orch ceph.stage.0
<prompt>root # </prompt><command>salt-run</command> state.orch ceph.stage.1</screen>
   </step>
   <step>
    <para>
     DeepSeaステージ1の実行後、<filename>/srv/pillar/ceph/proposals/policy.cfg</filename>を編集して次の行を追加します。
    </para>
<screen>role-ganesha/cluster/<replaceable>NODENAME</replaceable></screen>
    <para>
     <replaceable>NODENAME</replaceable>は実際のクラスタのノード名に置き換えてください。
    </para>
    <para>
     さらに、<literal>role-mds</literal>と<literal>role-rgw</literal>が割り当てられていることを確認します。
    </para>
   </step>
   <step>
    <para>
     ファイル<filename>/srv/pillar/ceph/rgw.sls</filename>を作成して、次の内容を挿入します。
    </para>
<screen>rgw_configurations:
  rgw:
    users:
      - { uid: "demo", name: "Demo", email: "demo@demo.nil" }
      - { uid: "demo1", name: "Demo1", email: "demo1@demo.nil" }</screen>
    <para>
     これらのユーザは後でObject Gatewayユーザとして作成され、APIキーが生成されます。Object Gatewayノードで、後で<command>radosgw-admin user list</command>を実行して、作成されたすべてのユーザを一覧にしたり、<command>radosgw-admin user info --uid=demo</command>を実行して、単一のユーザの詳細を取得したりできます。
    </para>
    <para>
     DeepSeaは、Object GatewayとNFS Ganeshaの両方が、<filename>rgw.sls</filename>の<literal>rgw</literal>セクションに記述されたすべてのユーザの資格情報を受け取っていることを確認します。
    </para>
    <para>
     エクスポートされたNFSは、ファイルシステムの第1レベルでこれらのユーザ名を使用します。この例では、パス<filename>/demo</filename>および<filename>/demo1</filename>がエクスポートされます。
    </para>
   </step>
   <step>
    <para>
     少なくともDeepSeaステージ2と4を実行します。その間にステージ3を実行することをお勧めします。
    </para>
<screen><prompt>root # </prompt><command>salt-run</command> state.orch ceph.stage.2
<prompt>root # </prompt><command>salt-run</command> state.orch ceph.stage.3 # optional but recommended
<prompt>root # </prompt><command>salt-run</command> state.orch ceph.stage.4</screen>
   </step>
   <step>
    <para>
     クライアントノードからNFS共有をマウントして、NFS Ganeshaが動作していることを確認します。
    </para>
<screen><prompt>root # </prompt><command>mount</command> -o sync -t nfs <replaceable>GANESHA_NODE</replaceable>:/ /mnt
<prompt>root # </prompt><command>ls</command> /mnt
cephfs  demo  demo1</screen>
    <para>
     <filename>/mnt</filename>に、エクスポートされたパスがすべて含まれている必要があります。CephFSとObject Gatewayの両方のユーザのディレクトリが存在する必要があります。ユーザが所有する各バケットに対して、パス<filename>/mnt/<replaceable>USERNAME</replaceable>/<replaceable>BUCKETNAME</replaceable></filename>がエクスポートされます。
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec.as.ganesha.ha-ap">
  <title>高可用性のアクティブ-パッシブ設定</title>

  <para>
   このセクションでは、NFS Ganeshaサーバの2ノードのアクティブ-パッシブ設定を行う方法について例を挙げて説明します。このセットアップでは、SUSE Linux Enterprise High Availability Extensionが必要です。これら2つのノードは、<systemitem class="domainname">earth</systemitem>および<systemitem class="domainname">mars</systemitem>という名前です。
  </para>

  <para>
   SUSE Linux Enterprise High Availability Extensionの詳細については、<link xlink:href="https://www.suse.com/documentation/sle-ha-12/"/>を参照してください。
  </para>

  <sect2 xml:id="sec.as.ganesha.ha-ap.basic">
   <title>基本的なインストール</title>
   <para>
    このセットアップでは、<systemitem class="domainname">earth</systemitem>にIPアドレス<systemitem class="ipaddress">192.168.1.1</systemitem>、<systemitem class="domainname">mars</systemitem>にアドレス<systemitem class="ipaddress">192.168.1.2</systemitem>が設定されています。
   </para>
   <para>
    さらに、2つの浮動仮想IPアドレスが使用されており、実行している物理ノードがどれであれ、クライアントからの該当サービスへの接続が可能になります。Hawk2でのクラスタ管理には<systemitem class="ipaddress">192.168.1.10</systemitem>を使用し、NFSエクスポートには<systemitem class="ipaddress">192.168.2.1</systemitem>を排他的に使用します。これにより、後で簡単にセキュリティ制約を適用できます。
   </para>
   <para>
    次の手順では、インストールの例について説明します。詳細については、<link xlink:href="https://www.suse.com/documentation/sle-ha-12/install-quick/data/install-quick.html"/>を参照してください。
   </para>
   <procedure xml:id="proc.as.ganesha.ha-ap">
    <step>
     <para>
      Salt Master上にNFS Ganeshaノードを準備します。
     </para>
     <substeps>
      <step>
       <para>
        Salt MasterでDeepSeaステージ0と1を実行します。
       </para>
<screen>
<prompt>root@master # </prompt><command>salt-run</command> state.orch ceph.stage.0
<prompt>root@master # </prompt><command>salt-run</command> state.orch ceph.stage.1
</screen>
      </step>
      <step>
       <para>
        <filename>/srv/pillar/ceph/proposals/policy.cfg</filename>でノード<systemitem class="domainname">earth</systemitem>および<systemitem class="domainname">mars</systemitem>に<literal>role-ganesha</literal>を割り当てます。
       </para>
<screen>role-ganesha/cluster/earth*.sls
role-ganesha/cluster/mars*.sls</screen>
      </step>
      <step>
       <para>
        Salt MasterでDeepSeaステージ3と4を実行します。
       </para>
<screen><prompt>root@master # </prompt><command>salt-run</command> state.orch ceph.stage.3
<prompt>root@master # </prompt><command>salt-run</command> state.orch ceph.stage.4</screen>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      <systemitem class="domainname">earth</systemitem>および<systemitem class="domainname">mars</systemitem>でSUSE Linux Enterprise High Availability Extensionを登録します。
     </para>
<screen>
<prompt>root # </prompt><command>SUSEConnect</command> -r <replaceable>ACTIVATION_CODE</replaceable> -e <replaceable>E_MAIL</replaceable>
</screen>
    </step>
    <step>
     <para>
      両方のノードに <package>ha-cluster-bootstrap</package> をインストールします。
     </para>
<screen><prompt>root # </prompt><command>zypper</command> in ha-cluster-bootstrap</screen>
    </step>
    <step>
     <substeps>
      <step>
       <para>
        <systemitem class="domainname">earth</systemitem>でクラスタを初期化します。
       </para>
<screen><prompt>root@earth # </prompt><command>ha-cluster-init</command></screen>
      </step>
      <step>
       <para>
        <systemitem class="domainname">mars</systemitem>をクラスタに参加させます。
       </para>
<screen><prompt>root@mars # </prompt><command>ha-cluster-join</command> -c earth</screen>
      </step>
     </substeps>
    </step>
    <step>
     <para>
      クラスタの状態を確認します。クラスタに2つのノードが追加されたことがわかります。
     </para>
<screen><prompt>root@earth # </prompt><command>crm</command> status</screen>
    </step>
    <step>
     <para>
      両方のノードで、起動時のNFS Ganeshaサービスの自動起動を無効にします。
     </para>
<screen><prompt>root # </prompt><command>systemctl</command> disable nfs-ganesha</screen>
    </step>
    <step>
     <para>
      <systemitem class="domainname">earth</systemitem>で<command>crm</command>シェルを起動します。
     </para>
<screen><prompt>root@earth # </prompt><command>crm</command> configure</screen>
     <para>
      以降のコマンドはcrmシェルで実行されます。
     </para>
    </step>
    <step>
     <para>
      <systemitem class="domainname">earth</systemitem>で、crmシェルを実行して次のコマンドを実行し、NFS Ganeshaデーモンのリソースをsystemdリソースタイプのクローンとして設定します。
     </para>
<screen>
<prompt>crm(live)configure# </prompt>primitive nfs-ganesha-server systemd:nfs-ganesha \
op monitor interval=30s
<prompt>crm(live)configure# </prompt>clone nfs-ganesha-clone nfs-ganesha-server meta interleave=true
<prompt>crm(live)configure# </prompt>commit
<prompt>crm(live)configure# </prompt>status
    2 nodes configured
    2 resources configured

    Online: [ earth mars ]

    Full list of resources:
         Clone Set: nfs-ganesha-clone [nfs-ganesha-server]
         Started:  [ earth mars ]</screen>
    </step>
    <step>
     <para>
      crmシェルでプリミティブIPAddr2を作成します。
     </para>
<screen>
<prompt>crm(live)configure# </prompt>primitive ganesha-ip IPaddr2 \
params ip=192.168.2.1 cidr_netmask=24 nic=eth0 \
op monitor interval=10 timeout=20

<prompt>crm(live)# </prompt>status
Online: [ earth mars  ]
Full list of resources:
 Clone Set: nfs-ganesha-clone [nfs-ganesha-server]
     Started: [ earth mars ]
 ganesha-ip    (ocf::heartbeat:IPaddr2):    Started earth</screen>
    </step>
    <step>
     <para>
      NFS Ganeshaサーバと浮動仮想IPとの間の関係を設定するため、コロケーションと順序付けを使用します。
     </para>
<screen>
<prompt>crm(live)configure# </prompt>colocation ganesha-ip-with-nfs-ganesha-server inf: ganesha-ip nfs-ganesha-clone
<prompt>crm(live)configure# </prompt>order ganesha-ip-after-nfs-ganesha-server Mandatory: nfs-ganesha-clone ganesha-ip
</screen>
    </step>
    <step>
     <para>
      クライアントから<command>mount</command>コマンドを使用して、クラスタのセットアップが完了していることを確認します。
     </para>
<screen><prompt>root # </prompt><command>mount</command> -t nfs -v -o sync,nfsvers=4 192.168.2.1:/ /mnt</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec.as.ganesha.ha-ap.cleanup">
   <title>リソースのクリーンアップ</title>
   <para>
    いずれかのノード(たとえば、<systemitem class="domainname">earth</systemitem>)でNFS Ganeshaに障害が発生した場合、問題を修正してリソースをクリーンアップします。<systemitem class="domainname">mars</systemitem>でNFS Ganeshaに障害が発生した場合、リソースをクリーンアップした後でのみ、リソースを<systemitem class="domainname">earth</systemitem>にフェールバックできます。
   </para>
   <para>
    リソースをクリーンアップするには、次のコマンドを実行します。
   </para>
<screen><prompt>root@earth # </prompt><command>crm</command> resource cleanup nfs-ganesha-clone earth
<prompt>root@earth # </prompt><command>crm</command> resource cleanup ganesha-ip earth</screen>
  </sect2>

  <sect2 xml:id="sec.as.ganesha.ha-ap.ping-resource">
   <title>Pingリソースの設定</title>
   <para>
    ネットワークの問題により、サーバがクライアントにアクセスできなくなることがあります。Pingリソースによってこの問題を検出および緩和できます。このリソースの設定はオプションです。
   </para>
   <procedure>
    <step>
     <para>
      Pingリソースを定義します。
     </para>
<screen><prompt>crm(live)configure# </prompt>primitive ganesha-ping ocf:pacemaker:ping \
        params name=ping dampen=3s multiplier=100 host_list="<replaceable>CLIENT1</replaceable> <replaceable>CLIENT2</replaceable>" \
        op monitor interval=60 timeout=60 \
        op start interval=0 timeout=60 \
        op stop interval=0 timeout=60</screen>
     <para>
      <literal>host_list</literal>は、IPアドレスをスペース文字で区切ったリストです。これらのIPアドレスに定期的にpingが送信されて、ネットワークが停止していないかどうかが確認されます。クライアントが常にNFSサーバにアクセスできる必要がある場合は、そのクライアントを<literal>host_list</literal>に追加します。
     </para>
    </step>
    <step>
     <para>
      クローンを作成します。
     </para>
<screen><prompt>crm(live)configure# </prompt>clone ganesha-ping-clone ganesha-ping \
        meta interleave=true</screen>
    </step>
    <step>
     <para>
      次のコマンドは、NFS Ganeshaサービスに対して制約を作成します。これにより、<literal>host_list</literal>がアクセス不可能になった場合、サービスを強制的に別のノードに移動します。
     </para>
<screen><prompt>crm(live)configure# </prompt>location nfs-ganesha-server-with-ganesha-ping
        nfs-ganesha-clone \
        rule -inf: not_defined ping or ping lte 0</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ganesha_ha_deepsea">
   <title>NFS Ganesha HAとDeepSea</title>
   <para>
    DeepSeaでは、NFS Ganesha HAの設定はサポートされていません。NFS Ganesha HAの設定後にDeepSeaで障害が発生するのを防止するには、DeepSeaステージ4からNFS Ganeshaサービスの起動と停止を除外します。
   </para>
   <procedure>
    <step>
     <para>
      <filename>/srv/salt/ceph/ganesha/default.sls</filename>を<filename>/srv/salt/ceph/ganesha/ha.sls</filename>にコピーします。
     </para>
    </step>
    <step>
     <para>
      <filename>/srv/salt/ceph/ganesha/ha.sls</filename>から<literal>.service</literal>エントリを削除し、次のようにします。
     </para>
<screen>include:
- .keyring
- .install
- .configure</screen>
    </step>
    <step>
     <para>
      <filename>/srv/pillar/ceph/stack/global.yml</filename>に次の行を追加します。
     </para>
<screen>ganesha_init: ha</screen>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="sec.as.ganesha.info">
  <title>詳細情報</title>

  <para>
   詳細については、<xref linkend="cha.ceph.nfsganesha"/>を参照してください。
  </para>
 </sect1>
</chapter>
