<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_operating_services.xml" version="5.0" xml:id="ceph.operating.services">
 <title>Cephのサービスの操作</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:translation>○</dm:translation>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    <para>
  Cephのサービスは、<systemitem class="daemon">systemd</systemitem>またはDeepSeaを使用して操作できます。
 </para>
 <sect1 xml:id="operate.services.systemd">
  <title><systemitem class="daemon">systemd</systemitem>を使用したCephのサービスの操作</title>

  <para>
   すべてのCeph関連サービスを操作するには、<command>systemctl</command>コマンドを使用します。操作は、現在ログインしているノードに対して実行されます。Cephのサービスを操作できるようにするには、<systemitem class="username">root</systemitem>特権が必要です。
  </para>

  <sect2 xml:id="ceph.operating.services.targets">
   <title>ターゲットを使用したサービスの起動、停止、および再起動</title>
   <para>
    ノード上の特定タイプの全サービス(たとえば、すべてのCephサービス、すべてのMON、すべてのOSD)の起動、停止、および再起動を簡素化するため、Cephでは、次の<systemitem class="daemon">systemd</systemitem>ユニットファイルが提供されています。
   </para>
<screen><prompt>root # </prompt> ls /usr/lib/systemd/system/ceph*.target
ceph.target
ceph-osd.target
ceph-mon.target
ceph-mgr.target
ceph-mds.target
ceph-radosgw.target
ceph-rbd-mirror.target</screen>
   <para>
    ノード上のすべてのCephサービスを起動/停止/再起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph.target
<prompt>root # </prompt>systemctl start ceph.target
<prompt>root # </prompt>systemctl restart ceph.target</screen>
   <para>
    ノード上のすべてのOSDを起動/停止/再起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph-osd.target
<prompt>root # </prompt>systemctl start ceph-osd.target
<prompt>root # </prompt>systemctl restart ceph-osd.target</screen>
   <para>
    他のターゲット用のコマンドも同様です。
   </para>
  </sect2>

  <sect2 xml:id="ceph.operating.services.individual">
   <title>個々のサービスの起動、停止、および再起動</title>
   <para>
    次のパラメータ化された<systemitem class="daemon">systemd</systemitem>ユニットファイルを使用して、個々のサービスを操作できます。
   </para>
<screen>ceph-osd@.service
ceph-mon@.service
ceph-mds@.service
ceph-radosgw@.service
ceph-rbd-mirror@.service</screen>
   <para>
    これらのコマンドを使用するには、最初に、操作するサービスの名前を識別する必要があります。サービスの識別の詳細については、<xref linkend="ceph.operating.services.finding_names"/>を参照してください。
   </para>
   <para>
    <literal>osd.1</literal>サービスを起動/停止/再起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>root # </prompt>systemctl stop ceph-osd@1.service
<prompt>root # </prompt>systemctl start ceph-osd@1.service
<prompt>root # </prompt>systemctl restart ceph-osd@1.service</screen>
   <para>
    他のサービスタイプ用のコマンドも同様です。
   </para>
  </sect2>

  <sect2 xml:id="ceph.operating.services.finding_names">
   <title>個々のサービスの識別</title>
   <para>
    <command>systemctl</command>を実行して結果を<command>grep</command>コマンドでフィルタリングすることにより、特定のタイプのサービスの名前/番号を確認できます。次に例を示します。
   </para>
<screen><prompt>root # </prompt>systemctl | grep -i 'ceph-osd.*service'
<prompt>root # </prompt>systemctl | grep -i 'ceph-mon.*service'
[...]</screen>
  </sect2>

  <sect2 xml:id="ceph.operating.services.status">
   <title>サービスの状態</title>
   <para>
    サービスの状態を<systemitem class="daemon">systemd</systemitem>に問い合わせることができます。次に例を示します。
   </para>
<screen><prompt>root # </prompt>systemctl status ceph-osd@1.service
<prompt>root # </prompt>systemctl status ceph-mon@<replaceable>HOSTNAME</replaceable>.service</screen>
   <para>
    <replaceable>HOSTNAME</replaceable>は、デーモンが実行されているホスト名に置き換えてください。
   </para>
   <para>
    サービスの正確な名前/番号がわからない場合は、<xref linkend="ceph.operating.services.finding_names"/>を参照してください。
   </para>
  </sect2>
 </sect1>
 <sect1 xml:id="Deepsea.restart">
  <title>DeepSeaを使用したCephのサービスの再起動</title>

  <para>
   クラスタノードに更新を適用した後に、最近インストールしたバージョンを利用するには、割り当てられているサービスを再起動する必要があります。
  </para>

  <note>
   <title>再起動の監視</title>
   <para>
    クラスタの再起動プロセスには時間がかかることがあります。次のコマンドを実行することにより、Saltイベントバスを使用してイベントを監視できます。
   </para>
<screen><prompt>root@master # </prompt>salt-run state.event pretty=True</screen>
  </note>

  <sect2 xml:id="deepsea.restart.all">
   <title>すべてのサービスの再起動</title>
   <para>
    クラスタ上の「すべて」<emphasis/>のサービスを再起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart</screen>
   <para>
    個々の役割の再起動順序は、DeepSeaのバージョン(<command>rpm -q deepsea</command>)によって異なります。
   </para>
   <itemizedlist>
    <listitem>
     <para>
      バージョン0.8.4より前のDeepSeaでは、Metadata Server、iSCSI Gateway、Object Gateway、およびNFS Ganeshaサービスは並行して再起動されます。
     </para>
    </listitem>
    <listitem>
     <para>
      DeepSea 0.8.4以上では、設定されているすべての役割は、Ceph Monitor、Ceph Manager、Ceph OSD、Metadata Server、Object Gateway、iSCSI Gateway、NFS Ganeshaの順に再起動されます。ダウンタイムを短く抑え、潜在的な問題をできる限り早期に見つけるため、各ノードは順番に再起動されます。たとえば、モニタリングノードは一度に1つずつ起動されます。
     </para>
    </listitem>
   </itemizedlist>
   <para>
    クラスタが機能低下した正常でない状態の場合、このコマンドはクラスタが回復するまで待機します。
   </para>
  </sect2>

  <sect2 xml:id="deepsea.restart.specific">
   <title>特定のサービスの再起動</title>
   <para>
    クラスタ上の特定のサービスを再起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.<replaceable>service_name</replaceable></screen>
   <para>
    たとえば、すべてのObject Gatewayを再起動するには、次のコマンドを実行します。
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
   <para>
    次のターゲットを使用できます。
   </para>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mon</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mgr</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.osd</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.mds</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.rgw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.igw</screen>
<screen><prompt>root@master # </prompt>salt-run state.orch ceph.restart.ganesha</screen>
  </sect2>
 </sect1>
</chapter>
