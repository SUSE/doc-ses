<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_ceph_kvm.xml" version="5.0" xml:id="cha-ceph-kvm">
 <title>QEMU KVMインスタンスのバックエンドとしてのCephの使用</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/maintenance/ses6/xml/</dm:editurl>
   <dm:maintainer>tbazant@suse.com</dm:maintainer>
   <dm:status>編集</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>yes</dm:translation>
   <dm:languages/>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
  Cephの最も一般的な使用事例として、仮想マシンにBlock Deviceイメージを提供することがあります。たとえば、理想的な設定のOSと関連ソフトウェアを使用して「ゴールデン」イメージを作成できます。続いて、そのイメージのスナップショットを作成します。最後に、スナップショットのクローンを作成します(通常は複数回。詳細については、<xref linkend="cha-ceph-snapshots-rbd"/>を参照してください)。スナップショットのコピーオンライトクローンを作成できるということは、新しい仮想マシンを起動するたびにクライアントがイメージ全体をダウンロードしないで済むため、CephはBlock Deviceイメージを仮想マシンに素早くプロビジョニングできることを意味します。
 </para>
 <para>
  Ceph Block DeviceをQEMU仮想マシンと統合できます。QEMU KVMの詳細については、<link xlink:href="https://www.suse.com/documentation/sles-15/book_virt/data/part_virt_qemu.html"/>を参照してください。
 </para>
 <sect1 xml:id="ceph-kvm-install">
  <title>インストール</title>

  <para>
   Ceph Block Deviceを使用するには、QEMUに適切なドライバがインストールされている必要があります。<systemitem>qemu-block-rbd</systemitem>パッケージがインストールされているかどうかを確認し、必要に応じてインストールします。
  </para>

<screen><prompt>root # </prompt>zypper install qemu-block-rbd</screen>
 </sect1>
 <sect1 xml:id="ceph-kvm-usage">
  <title>使用法</title>

  <para>
   QEMUのコマンドラインで、プール名とイメージ名を指定する必要があります。スナップショット名も指定できます。
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable>@<replaceable>snapshot-name</replaceable><replaceable>:option1=value1</replaceable><replaceable>:option2=value2...</replaceable></screen>

  <para>
   たとえば、<replaceable>id</replaceable>および<replaceable>conf</replaceable>のオプションを指定すると、次のようになります。
  </para>

<screen>qemu-img <replaceable>command</replaceable> <replaceable>options</replaceable> \
rbd:<replaceable>pool_name</replaceable>/<replaceable>image_name</replaceable>:<option>id=glance:conf=/etc/ceph/ceph.conf</option></screen>
 </sect1>
 <sect1>
  <title>QEMUでのイメージの作成</title>

  <para>
   QEMUからBlock Deviceイメージを作成できます。<literal>rbd</literal>、プール名、および作成するイメージの名前を指定する必要があります。イメージのサイズも指定する必要があります。
  </para>

<screen>qemu-img create -f raw rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   次に例を示します。
  </para>

<screen>qemu-img create -f raw rbd:pool1/image1 10G
Formatting 'rbd:pool1/image1', fmt=raw size=10737418240 nocow=off cluster_size=0</screen>

  <important>
   <para>
    RBDで使用するフォーマットオプションとして実用的なものは、実際のところ<literal>raw</literal>データフォーマットだけです。技術的には、<literal>qcow2</literal>などQEMUでサポートされている他のフォーマットを使用できますが、そうするとオーバーヘッドが追加されるほか、キャッシングが有効な場合に、仮想マシンのライブマイグレーションにおいてボリュームが不安定になります。
   </para>
  </important>
 </sect1>
 <sect1>
  <title>QEMUでのイメージのサイズ変更</title>

  <para>
   QEMUからBlock Deviceイメージのサイズを変更できます。<literal>rbd</literal>、プール名、およびサイズを変更するイメージの名前を指定する必要があります。イメージのサイズも指定する必要があります。
  </para>

<screen>qemu-img resize rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable> <replaceable>size</replaceable></screen>

  <para>
   次に例を示します。
  </para>

<screen>qemu-img resize rbd:pool1/image1 9G
Image resized.</screen>
 </sect1>
 <sect1>
  <title>QEMUでのイメージ情報の取得</title>

  <para>
   QEMUからBlock Deviceイメージの情報を取得できます。<literal>rbd</literal>、プール名、およびイメージの名前を指定する必要があります。
  </para>

<screen>qemu-img info rbd:<replaceable>pool-name</replaceable>/<replaceable>image-name</replaceable></screen>

  <para>
   次に例を示します。
  </para>

<screen>qemu-img info rbd:pool1/image1
image: rbd:pool1/image1
file format: raw
virtual size: 9.0G (9663676416 bytes)
disk size: unavailable
cluster_size: 4194304</screen>
 </sect1>
 <sect1>
  <title>RBDでのQEMUの実行</title>

  <para>
   QEMUは、<systemitem>librbd</systemitem>を介して仮想Block Deviceとしてイメージに直接アクセスできます。これにより、追加のコンテキストスイッチを避け、RBDキャッシングを利用できます。
  </para>

  <para>
   <command>qemu-img</command>を使用して、既存の仮想マシンイメージをCeph Block Deviceイメージに変換できます。たとえば、qcow2イメージがある場合、次のコマンドを実行できます。
  </para>

<screen>qemu-img convert -f qcow2 -O raw sles12.qcow2 rbd:pool1/sles12</screen>

  <para>
   そのイメージから仮想マシンの起動を実行するには、次のコマンドを実行できます。
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12</screen>

  <para>
   RBDキャッシングはパフォーマンスを大幅に向上できます。QEMUのキャッシュオプションで<systemitem>librbd</systemitem>のキャッシングを制御します。
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=rbd,file=rbd:pool1/sles12,cache=writeback</screen>

  <para>
   RBDキャッシングの詳細については、<xref linkend="rbd-cache-settings"/>を参照してください。
  </para>
 </sect1>
 <sect1>
  <title>Discard/TRIMの有効化</title>

  <para>
   Ceph Block Deviceはdiscard操作をサポートしています。つまり、ゲストはTRIM要求を送信してCeph Block Deviceに未使用領域を解放させることができます。ゲストでこれを有効にするには、discardオプションを指定して<systemitem>XFS</systemitem>をマウントします。
  </para>

  <para>
   ゲストがこれを利用できるようにするには、Block Deviceに対して明示的に有効にする必要があります。このためには、ドライブに関連付けられている<option>discard_granularity</option>を指定する必要があります。
  </para>

<screen><prompt>root # </prompt>qemu -m 1024 -drive format=raw,file=rbd:pool1/sles12,id=drive1,if=none \
-device driver=ide-hd,drive=drive1,discard_granularity=512</screen>

  <note>
   <para>
    上の例では、IDEドライバを使用しています。virtioドライブはdiscardをサポートしません。
   </para>
  </note>

  <para>
   <systemitem>libvirt</systemitem>を使用する場合、<command>virsh edit</command>を使用してlibvirtドメインの設定ファイルを編集し、<literal>xmlns:qemu</literal>の値を含めます。その後、<literal>qemu:commandline block</literal>をそのドメインの子として追加します。次の例に、<literal>qemu id=</literal>を使用して2台のデバイスを異なる<literal>discard_granularity</literal>の値に設定する方法を示します。
  </para>

<screen>
&lt;domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'&gt;
 &lt;qemu:commandline&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-0.discard_granularity=4096'/&gt;
  &lt;qemu:arg value='-set'/&gt;
  &lt;qemu:arg value='block.scsi0-0-1.discard_granularity=65536'/&gt;
 &lt;/qemu:commandline&gt;
&lt;/domain&gt;</screen>
 </sect1>
 <sect1>
  <title>QEMUのキャッシュオプション</title>

  <para>
   QEMUのキャッシュオプションは、次のCeph RBDキャッシュ設定に対応します。
  </para>

  <para>
   ライトバック:
  </para>

<screen>rbd_cache = true</screen>

  <para>
   ライトスルー:
  </para>

<screen>rbd_cache = true
rbd_cache_max_dirty = 0</screen>

  <para>
   なし:
  </para>

<screen>rbd_cache = false</screen>

  <para>
   QEMUのキャッシュ設定は、Cephのデフォルト設定(Cephの設定ファイルで明示的に設定されていない設定)を上書きします。Cephの設定ファイルでRBDキャッシュ設定を明示的に設定した場合(<xref linkend="rbd-cache-settings"/>を参照)、Cephの設定がQEMUのキャッシュ設定を上書きします。QEMUのコマンドラインでキャッシュ設定を行った場合、QEMUのコマンドラインの設定がCephの設定ファイルの設定を上書きします。
  </para>
 </sect1>
</chapter>
