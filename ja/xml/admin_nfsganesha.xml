<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha.ceph.nfsganesha">

 <title>NFS Ganesha: NFS経由でのCephデータのエクスポート</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer>tbazant@suse.com</dm:maintainer>
        <dm:status>編集</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>yes</dm:translation>
        <dm:languages/>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    
 <para>
  NFS Ganeshaは、オペレーティングシステムカーネルの一部としてではなく、ユーザアドレススペースで動作するNFSサーバです(「<link xlink:href="https://www.suse.com/documentation/sles-12/book_sle_admin/data/cha_nfs.html">Sharing File Systems with NFS</link>」を参照してください)。NFS Ganeshaを使用することで、Cephなど独自のストレージメカニズムをプラグインして、任意のNFSクライアントからアクセスできます。
 </para>
 <para>
  S3バケットはユーザごとにNFSにエクスポートされます。たとえば、パス<filename><replaceable>GANESHA_NODE:</replaceable>/<replaceable>USERNAME</replaceable>/<replaceable>BUCKETNAME</replaceable></filename>を使用してエクスポートされます。
 </para>
 <para>
  CephFSは、デフォルトではパス<filename><replaceable>GANESHA_NODE:</replaceable>/cephfs</filename>を介してエクスポートされます。
 </para>
 <sect1 xml:id="ceph.nfsganesha.install">
  <title>インストール</title>

  <para>
   詳細については、<xref linkend="cha.as.ganesha"/>を参照してください。
  </para>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.config">
  <title>設定</title>

  <para>
   設定ファイルで利用可能なすべてのパラメータのリストについては、次のマニュアルページを参照してください。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <command>man ganesha-config</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man ganesha-ceph-config</command> (CephFS FSAL (File System Abstraction Layer)のオプション)
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man ganesha-rgw-config</command> (Object GatewayのFSALのオプション)
    </para>
   </listitem>
  </itemizedlist>

  <para>
   このセクションには、Object GatewayとCephFSを介してアクセス可能なクラスタデータをエクスポートするようNFS Ganeshaサーバを設定する際に役立つ情報が記載されています。
  </para>

  <para>
   NFS Ganeshaの設定は<filename>/etc/ganesha/ganesha.conf</filename>で制御します。DeepSeaステージ4を実行すると、このファイルへの変更が上書きされることに注意してください。設定を永続的に変更するには、Salt Master上にあるファイル<filename>/srv/salt/ceph/ganesha/files/ganesha.conf.j2</filename>を編集します。
  </para>

  <sect2 xml:id="ceph.nfsganesha.config.general">
   <title>Exportセクション</title>
   <para>
    このセクションでは、<filename>ganesha.conf</filename>の<literal>EXPORT</literal>の各セクションを設定する方法について説明します。
   </para>
<screen>EXPORT
{
  Export_Id = 1;
  Path = "/";
  Pseudo = "/";
  Access_Type = RW;
  Squash = No_Root_Squash;
  [...]
  FSAL {
    Name = CEPH;
  }
}</screen>
   <sect3 xml:id="ceph.nfsganesha.config.general.export">
    <title>Exportの主要セクション</title>
    <variablelist>
     <varlistentry>
      <term>Export_Id</term>
      <listitem>
       <para>
        各エクスポートには固有の「Export_Id」が必要です(必須)。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Path</term>
      <listitem>
       <para>
        関連するCephFSプール内のエクスポートパス(必須)。これにより、CephFSからサブディレクトリをエクスポートできます。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Pseudo</term>
      <listitem>
       <para>
        ターゲットNFSのエクスポートパス(NFSv4では必須)。エクスポートデータを利用可能なNFSのエクスポートパスを定義します。
       </para>
       <para>
        例: 値<literal>/cephfs/</literal>を使用して、次のコマンドを実行したとします。
       </para>
<screen>
<prompt>root # </prompt>mount <replaceable>GANESHA_IP</replaceable>:/cephfs/ /mnt/
</screen>
       <para>
        これにより、CephFSのデータがクライアントのディレクトリ<filename>/mnt/cephfs/</filename>で利用可能になります。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Access_Type</term>
      <listitem>
       <para>
        読み込み専用の場合は「RO」、デフォルトは「None」です。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Squash</term>
      <listitem>
       <para>
        NFSのsquash (ルート権限無効化)オプション。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>FSAL</term>
      <listitem>
       <para>
        「File System Abstraction Layer」をエクスポートします。詳細については、<xref linkend="ceph.nfsganesha.config.general.fsal"/>を参照してください。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph.nfsganesha.config.general.fsal">
    <title>FSALサブセクション</title>
<screen>EXPORT
{
  [...]
  FSAL {
    Name = CEPH;
  }
}</screen>
    <variablelist>
     <varlistentry>
      <term>Name</term>
      <listitem>
       <para>
        NFS Ganeshaが使用するバックエンドを定義します。使用できる値は、CephFSの場合は<literal>CEPH</literal>、Object Gatewayの場合は<literal>RGW</literal>です。選択した値に応じて、<filename>policy.cfg</filename>で<literal>role-mds</literal>または<literal>role-rgw</literal>を定義する必要があります。
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph.nfsganesha.config.rgw">
   <title>RGWセクション</title>
<screen>RGW {
  ceph_conf = "/etc/ceph/ceph.conf";
  name = "name";
  cluster = "ceph";
}</screen>
   <variablelist>
    <varlistentry>
     <term>ceph_conf</term>
     <listitem>
      <para>
       <filename>ceph.conf</filename>ファイルを指します。DeepSeaを使用して展開する場合は、この値を変更する必要はありません。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>name</term>
     <listitem>
      <para>
       NFS Ganeshaによって使用されるCephクライアントユーザの名前。
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>cluster</term>
     <listitem>
      <para>
       Cephクラスタの名前。SUSE Enterprise Storage 5で現在サポートされているクラスタ名は1つだけです(デフォルトは<literal>ceph</literal>)。
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ganesha.nfsport">
   <title>NFS Ganeshaのデフォルトポートの変更</title>
   <para>
    NFS Ganeshaは、NFSにポート2049、rquotaサポートに875をデフォルトで使用します。デフォルトのポート番号を変更するには、<literal>NFS_CORE_PARAM</literal>セクション内で<option>NFS_Port</option>および<option>RQUOTA_Port</option>のオプションを使用します。次に例を示します。
   </para>
<screen>
NFS_CORE_PARAM
{
 NFS_Port = 2060;
 RQUOTA_Port = 876;
}
</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.customrole">
  <title>NFS Ganeshaのカスタムの役割</title>

  <para>
   クラスタノード用にNFS Ganeshaのカスタムの役割を定義できます。その後、これらの役割を<filename>policy.cfg</filename>でノードに割り当てます。これらの役割により、以下が可能になります。
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Object GatewayとCephFSにアクセスするために別々のNFS Ganeshaノードを使用する。
    </para>
   </listitem>
   <listitem>
    <para>
     複数のNFS Ganeshaノードに異なるObject Gatewayユーザを割り当てる。
    </para>
   </listitem>
  </itemizedlist>

  <para>
   複数のObject Gatewayユーザを使用することで、複数のNFS Ganeshaノードから異なるS3バケットにアクセスできます。S3バケットをアクセス制御に使用できます。注: S3バケットを、CRUSHマップで使用されるCephのバケットと混同しないでください。
  </para>

  <sect2 xml:id="ceph.nfsganesha.customrole.rgw_multiusers">
   <title>NFS Ganesha用の異なるObject Gatewayユーザ</title>
   <para>
    次に示すSalt Master用の手順の例では、異なるObject Gatewayユーザを持つ2つのNFS Ganeshaの役割を作成する方法について説明します。この例では、役割<literal>gold</literal>と<literal>silver</literal>を使用します。これらの役割には、DeepSeaによってサンプル設定ファイルがすでに用意されています。
   </para>
   <procedure xml:id="proc.ceph.nfsganesha.rgw_multiusers">
    <step>
     <para>
      ファイル<filename>/srv/pillar/ceph/stack/global.yml</filename>を好みのエディタで開きます。ファイルが存在しない場合は作成します。
     </para>
    </step>
    <step>
     <para>
      このファイルには次の行が含まれる必要があります。
     </para>
<screen>rgw_configurations:
  - rgw
  - silver
  - gold
ganesha_configurations:
  - silver
  - gold</screen>
     <para>
      後で、これらの役割を<filename>policy.cfg</filename>で割り当てることができます。
     </para>
    </step>
    <step>
     <para>
      ファイル<filename>/srv/salt/ceph/rgw/users/users.d/gold.yml</filename>を作成して、次の内容を追加します。
     </para>
<screen>- { uid: "gold1", name: "gold1", email: "gold1@demo.nil" }</screen>
     <para>
      ファイル<filename>/srv/salt/ceph/rgw/users/users.d/silver.yml</filename>を作成して、次の内容を追加します。
     </para>
<screen>- { uid: "silver1", name: "silver1", email: "silver1@demo.nil" }</screen>
    </step>
    <step>
     <para>
      ここで、各役割に対して<filename>ganesha.conf</filename>のテンプレートを作成する必要があります。DeepSeaの元のテンプレートを利用するのが便利です。コピーを2つ作成します。
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/ganesha/files/
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 silver.conf.j2
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 gold.conf.j2</screen>
    </step>
    <step>
     <para>
      新しい役割には、クラスタにアクセスするためのキーリングが必要です。アクセスを提供するため、<filename>ganesha.j2</filename>をコピーします。
     </para>
<screen><prompt>root # </prompt><command>cp</command> ganesha.j2 silver.j2
<prompt>root # </prompt><command>cp</command> ganesha.j2 gold.j2</screen>
    </step>
    <step>
     <para>
      Object Gatewayのキーリングをコピーします。
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/rgw/files/
<prompt>root # </prompt><command>cp</command> rgw.j2 silver.j2
<prompt>root # </prompt><command>cp</command> rgw.j2 gold.j2</screen>
    </step>
    <step>
     <para>
      Object Gatewayに、異なる役割用の設定も必要です。
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/configuration/files/
<prompt>root # </prompt><command>cp</command> ceph.conf.rgw silver.conf
<prompt>root # </prompt><command>cp</command> ceph.conf.rgw gold.conf</screen>
    </step>
    <step>
     <para>
      <filename>/srv/pillar/ceph/proposals/policy.cfg</filename>で、新しく作成した役割をクラスタノードに割り当てます。
     </para>
<screen>role-silver/cluster/<replaceable>NODE1</replaceable>.sls
role-gold/cluster/<replaceable>NODE2</replaceable>.sls
 </screen>
     <para>
      <replaceable>NODE1</replaceable>および<replaceable>NODE2</replaceable>は、役割の割り当て先にするノードの名前に置き換えてください。
     </para>
    </step>
    <step>
     <para>
      DeepSeaステージ0～4を実行します。
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ceph.nfsganesha.customrole.rgw_cephfs">
   <title>CephFSとObject GatewayのFSALの分離</title>
   <para>
    次に示すSalt Master用の手順の例では、CephFSとObject Gatewayを使用する2つの異なる役割を新しく作成する方法について説明します。
   </para>
   <procedure xml:id="proc.ceph.nfsganesha.customrole">
    <step>
     <para>
      ファイル<filename>/srv/pillar/ceph/rgw.sls</filename>を好みのエディタで開きます。ファイルが存在しない場合は作成します。
     </para>
    </step>
    <step>
     <para>
      このファイルには次の行が含まれる必要があります。
     </para>
<screen>rgw_configurations:
  ganesha_cfs:
    users:
      - { uid: "demo", name: "Demo", email: "demo@demo.nil" }
  ganesha_rgw:
    users:
      - { uid: "demo", name: "Demo", email: "demo@demo.nil" }

ganesha_configurations:
  - ganesha_cfs
  - ganesha_rgw</screen>
     <para>
      後で、これらの役割を<filename>policy.cfg</filename>で割り当てることができます。
     </para>
    </step>
    <step>
     <para>
      ここで、各役割に対して<filename>ganesha.conf</filename>のテンプレートを作成する必要があります。DeepSeaの元のテンプレートを利用するのが便利です。コピーを2つ作成します。
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/ganesha/files/
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 ganesha_rgw.conf.j2
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 ganesha_cfs.conf.j2</screen>
    </step>
    <step>
     <para>
      <filename>ganesha_rgw.conf.j2</filename>を編集して次のセクションを削除します。
     </para>
<screen>{% if salt.saltutil.runner('select.minions', cluster='ceph', roles='mds') != [] %}
        [...]
{% endif %}</screen>
    </step>
    <step>
     <para>
      <filename>ganesha_cfs.conf.j2</filename>を編集して次のセクションを削除します。
     </para>
<screen>{% if salt.saltutil.runner('select.minions', cluster='ceph', roles=role) != [] %}
        [...]
{% endif %}</screen>
    </step>
    <step>
     <para>
      新しい役割には、クラスタにアクセスするためのキーリングが必要です。アクセスを提供するため、<filename>ganesha.j2</filename>をコピーします。
     </para>
<screen><prompt>root # </prompt><command>cp</command> ganesha.j2 ganesha_rgw.j2
<prompt>root # </prompt><command>cp</command> ganesha.j2 ganesha_cfs.j2</screen>
     <para>
      行<literal>caps mds = "allow *"</literal>は<filename>ganesha_rgw.j2</filename>から削除できます。
     </para>
    </step>
    <step>
     <para>
      Object Gatewayのキーリングをコピーします。
     </para>
<screen><prompt>root # </prompt><command>cp</command> /srv/salt/ceph/rgw/files/rgw.j2 \
/srv/salt/ceph/rgw/files/ganesha_rgw.j2</screen>
    </step>
    <step>
     <para>
      Object Gatewayに、新しい役割用の設定が必要です。
     </para>
<screen><prompt>root # </prompt><command>cp</command> /srv/salt/ceph/configuration/files/ceph.conf.rgw \
/srv/salt/ceph/configuration/files/ceph.conf.ganesha_rgw</screen>
    </step>
    <step>
     <para>
      <filename>/srv/pillar/ceph/proposals/policy.cfg</filename>で、新しく作成した役割をクラスタノードに割り当てます。
     </para>
<screen>role-ganesha_rgw/cluster/<replaceable>NODE1</replaceable>.sls
role-ganesha_cfs/cluster/<replaceable>NODE1</replaceable>.sls
 </screen>
     <para>
      <replaceable>NODE1</replaceable>および<replaceable>NODE2</replaceable>は、役割の割り当て先にするノードの名前に置き換えてください。
     </para>
    </step>
    <step>
     <para>
      DeepSeaステージ0～4を実行します。
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.services">
  <title>NFS Ganeshaの起動または再起動</title>

  <para>
   NFS Ganeshaサービスを有効にして起動するには、次のコマンドを実行します。
  </para>

<screen><prompt>root # </prompt><command>systemctl</command> enable nfs-ganesha
<prompt>root # </prompt><command>systemctl</command> start nfs-ganesha</screen>

  <para>
   次のコマンドを使用して、NFS Ganeshaを再起動します。
  </para>

<screen><prompt>root # </prompt><command>systemctl</command> restart nfs-ganesha</screen>

  <para>
   NFS Ganeshaが起動または再起動した時点では、NFS v4に90秒の猶予タイムアウトが設定されています。猶予期間中、クライアントからの新しい要求はアクティブに拒否されます。したがって、NFSが猶予状態の場合、クライアントで要求の低速化が発生することがあります。
  </para>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.loglevel">
  <title>ログレベルの設定</title>

  <para>
   デフォルトのデバッグレベル<literal>NIV_EVENT</literal>を変更するには、ファイル<filename>/etc/sysconfig/nfs-ganesha</filename>を編集します。<literal>NIV_EVENT</literal>を<literal>NIV_DEBUG</literal>または<literal>NIV_FULL_DEBUG</literal>に置き換えます。ログの詳細度を上げると、ログファイル内に大量のデータが生成される可能性があります。
  </para>

<screen>OPTIONS="-L /var/log/ganesha/ganesha.log -f /etc/ganesha/ganesha.conf -N NIV_EVENT"</screen>

  <para>
   ログレベルを変更した場合、サービスの再起動が必要です。
  </para>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.verify">
  <title>エクスポートされたNFS共有の検証</title>

  <para>
   NFS v3を使用する場合、NFS共有がNFS Ganeshaサーバノード上にエクスポートされているかどうかを検証できます。
  </para>

<screen><prompt>root # </prompt><command>showmount</command> -e
/ (everything)</screen>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.mount">
  <title>エクスポートされたNFS共有のマウント</title>

  <para>
   エクスポートされたNFS共有(<xref linkend="ceph.nfsganesha.config"/>で設定)をクライアントホストにマウントするには、次のコマンドを実行します。
  </para>

<screen><prompt>root # </prompt><command>mount</command> -t nfs -o rw,noatime,sync \
 <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.more">
  <title>その他の資料</title>

  <para>
   NFS Ganeshaの元のドキュメントは、<link xlink:href="https://github.com/nfs-ganesha/nfs-ganesha/wiki/Docs"/>に掲載されています。
  </para>
 </sect1>
</chapter>
