<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE appendix
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
    %entities;
]>
<appendix xmlns="http://docbook.org/ns/docbook"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="tuning-appendix-a">
 <title>&salt; State for Kernel Tuning</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:editurl>https://github.com/SUSE/doc-ses/edit/master/xml/</dm:editurl>
   <dm:translation>yes</dm:translation>
   <dm:release>SES 6</dm:release>
  </dm:docmanager>
 </info>
 <para>
   There are a significant number of items that can be tuned to provide
   improved performance of a &ceph; cluster. While the material provided
   in previous sections attempts to showcase important items, it should
   not be considered exhaustive. It is highly recommended that use of
   the information contained herein be done so with a scientific
   approach to understanding the performance needs and outcomes of
   specific tuning in comparison with baseline performance.
 </para>
   <para>
     To utilize this &salt; state follow these steps:
   </para>
   <procedure>
     <step>
       <para>
         Create directory named <filename>my_kerntune</filename> in <filename>/srv/salt/</filename>.
       </para>
     </step>
     <step>
       <para>
         Create <filename>/srv/salt/my_kerntune/init.sls</filename> with the
         following contents:
       </para>
<screen>
  my_kern_tune:
    file.replace:
      - name: /etc/default/grub
      - pattern: showopts.*
      - repl: showopts intel_idle.max_cstate=0 processor.max_cstate=0 idle=poll scsi_mod.use_blk_mq=1 nospec spectre_v2=off pti=off spec_store_bypass_disable=off l1tf=off"

  grub2_mkconfig:
    cmd.run:
      - runas: root
      - name: grub2-mkconfig -o /boot/grub2/grub.cfg
      - onchanges:
        - file: my_kern_tune
</screen>
     </step>
     <step>
       <para>
         Issue the following command to set the state:
       </para>
<screen>
salt '*' state.apply my_kerntune
</screen>
     </step>
     <step>
       <para>
         Reboot the nodes.
       </para>
     </step>
   </procedure>
   <warning>
     <para>
       Verify the <command>grub</command> kernel command line and ensure the pattern match
       specified by the pattern: parameter is appropriate. As is,
       this will overwrite anything after the <option>showopts</option> kernel command
       line argument.
     </para>
   </warning>
 </appendix>
