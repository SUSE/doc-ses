<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="admin_nfsganesha.xml" version="5.0" xml:id="cha.ceph.nfsganesha">

 <title>NFS Ganesha: Exportieren von Ceph-Daten über NFS</title>
 <info>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:maintainer>tbazant@suse.com</dm:maintainer>
        <dm:status>Bearbeiten</dm:status>
        <dm:deadline/>
        <dm:priority/>
        <dm:translation>Ja</dm:translation>
        <dm:languages/>
        <dm:release>SES 5</dm:release>
      </dm:docmanager>
    </info>
    
 <para>
  NFS Ganesha ist ein NFS-Server (weitere Informationen hierzu finden Sie unter <link xlink:href="https://www.suse.com/documentation/sles-12/book_sle_admin/data/cha_nfs.html">Sharing File Systems with NFS (Freigabe von Dateisystemen mit NFS)</link> ), der in einem Benutzeradressenbereich anstatt als Teil des Betriebssystem-Kernels ausgeführt wird. Mit NFS Ganesha binden Sie Ihren eigenen Speichermechanismus ein, wie zum Beispiel Ceph, und greifen von einem beliebigen NFS Client darauf zu.
 </para>
 <para>
  S3 Buckets werden pro Benutzer zu NFS exportiert, beispielsweise über den Pfad <filename><replaceable>GANESHA_NODE:</replaceable>/<replaceable>USERNAME</replaceable>/<replaceable>BUCKETNAME</replaceable></filename>.
 </para>
 <para>
  Ein CephFS wird standardmäßig über den Pfad <filename><replaceable>GANESHA_NODE:</replaceable>/cephfs</filename> exportiert.
 </para>
 <sect1 xml:id="ceph.nfsganesha.install">
  <title>Installation</title>

  <para>
   Die Installationsanweisungen finden Sie unter <xref linkend="cha.as.ganesha"/>.
  </para>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.config">
  <title>Konfiguration</title>

  <para>
   Eine Liste aller Parameter, die in der Konfigurationsdatei verfügbar sind, finden Sie unter:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <command>man ganesha-config</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man ganesha-ceph-config</command> für Optionen zur Dateisystem-Abstraktionsschicht (File System Abstraction Layer, FSAL) zu CephFS.
    </para>
   </listitem>
   <listitem>
    <para>
     <command>man ganesha-rgw-config</command> für FSAL-Optionen zu Object Gateway. 
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Dieser Abschnitt enthält Informationen, die Ihnen beim Konfigurieren des NFS Ganesha-Servers für den Export der Cluster-Daten über Object Gateway und CephFS helfen.
  </para>

  <para>
   Die Konfiguration von NFS Ganesha wird gesteuert durch <filename>/etc/ganesha/ganesha.conf</filename>. Beachten Sie, dass Änderungen an dieser Datei überschrieben werden, wenn DeepSea-Phase 4 ausgeführt wird. Bearbeiten Sie zum dauerhaften Ändern der Einstellungen die Datei <filename>/srv/salt/ceph/ganesha/files/ganesha.conf.j2</filename>, die sich am Salt Master befindet.
  </para>

  <sect2 xml:id="ceph.nfsganesha.config.general">
   <title>Export-Abschnitte</title>
   <para>
    In diesem Abschnitt wird erläutert, wie die <literal>EXPORT</literal>-Abschnitte in <filename>ganesha.conf</filename> konfiguriert werden.
   </para>
<screen>EXPORT
{
  Export_Id = 1;
  Path = "/";
  Pseudo = "/";
  Access_Type = RW;
  Squash = No_Root_Squash;
  [...]
  FSAL {
    Name = CEPH;
  }
}</screen>
   <sect3 xml:id="ceph.nfsganesha.config.general.export">
    <title>Export-Hauptabschnitt</title>
    <variablelist>
     <varlistentry>
      <term>Export_Id</term>
      <listitem>
       <para>
        Jeder Export benötigt eine eindeutige "Export_Id" (obligatorisch).
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Path</term>
      <listitem>
       <para>
        Exportpfad im entsprechenden CephFS Pool (obligatorisch). Damit können Unterverzeichnisse vom CephFS exportiert werden.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Pseudo</term>
      <listitem>
       <para>
        Pfad für das NFS-Exportziel (obligatorisch für NFSv4). Damit wird definiert, unter welchem NFS-Exportpfad die exportierten Daten verfügbar sind.
       </para>
       <para>
        Beispiel: Mit dem Wert <literal>/cephfs/</literal> und nach dem Ausführen von
       </para>
<screen>
<prompt>root # </prompt>mount <replaceable>GANESHA_IP</replaceable>:/cephfs/ /mnt/
</screen>
       <para>
        Die CephFS-Daten sind im Verzeichnis <filename>/mnt/cephfs/</filename> am Client verfügbar.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Access_Type</term>
      <listitem>
       <para>
        "RO" für schreibgeschützten Zugriff. Die Standardeinstellung ist "None".
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Squash</term>
      <listitem>
       <para>
        NFS Squash-Option.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>FSAL</term>
      <listitem>
       <para>
        Exportieren der Dateisystem-Abstraktionsschicht (File System Abstraction Layer, FSAL). Weitere Informationen hierzu finden Sie in <xref linkend="ceph.nfsganesha.config.general.fsal"/>.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="ceph.nfsganesha.config.general.fsal">
    <title>FSAL-Unterabschnitt</title>
<screen>EXPORT
{
  [...]
  FSAL {
    Name = CEPH;
  }
}</screen>
    <variablelist>
     <varlistentry>
      <term>Name</term>
      <listitem>
       <para>
        Definiert, welches Back-End NFS Ganesha verwendet. Zulässige Werte sind <literal>CEPH</literal> für CephFS oder <literal>RGW</literal> für Object Gateway. Je nach Auswahl muss eine <literal>role-mds</literal> oder <literal>role-rgw</literal> in der <filename>policy.cfg</filename> definiert werden.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
  </sect2>

  <sect2 xml:id="ceph.nfsganesha.config.rgw">
   <title>RGW-Abschnitt</title>
<screen>RGW {
  ceph_conf = "/etc/ceph/ceph.conf";
  name = "name";
  cluster = "ceph";
}</screen>
   <variablelist>
    <varlistentry>
     <term>ceph_conf</term>
     <listitem>
      <para>
       Zeigt auf die Datei <filename>ceph.conf</filename>. Bei der Bereitstellung mit DeepSea ist es nicht erforderlich, diesen Wert zu ändern.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>name</term>
     <listitem>
      <para>
       Der Name des Ceph Client-Benutzers. der von NFS Ganesha verwendet wird.
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>cluster</term>
     <listitem>
      <para>
       Der Name des Ceph Clusters. SUSE Enterprise Storage 5 unterstützt derzeit nur einen Cluster-Namen, nämlich standardmäßig <literal>ceph</literal>.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </sect2>

  <sect2 xml:id="ganesha.nfsport">
   <title>Ändern der standardmäßigen NFS Ganesha Ports</title>
   <para>
    NFS Ganesha verwendet standardmäßig Port 2049 für NFS und 875 für die Unterstützung von "rquota". Die standardmäßigen Portnummern ändern Sie mit den Optionen <option>NFS_Port</option> und <option>RQUOTA_Port</option> im Abschnitt <literal>NFS_CORE_PARAM</literal>. Beispiel:
   </para>
<screen>
NFS_CORE_PARAM
{
 NFS_Port = 2060;
 RQUOTA_Port = 876;
}
</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.customrole">
  <title>Benutzerdefinierte NFS Ganesha-Rollen</title>

  <para>
   Sie können NFS Ganesha-Rollen für Cluster Nodes definieren. Diese Rollen werden dann den Nodes in der <filename>policy.cfg</filename> zugewiesen. Die Rollen ermöglichen Folgendes:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Getrennte NFS Ganesha Nodes für den Zugriff auf Object Gateway und CephFS.
    </para>
   </listitem>
   <listitem>
    <para>
     Zuweisen verschiedener Object Gateway-Benutzer zu NFS Ganesha Nodes.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Mit verschiedenen Object Gateway-Benutzern können NFS Ganesha Nodes auf verschiedene S3 Buckets zugreifen. S3 Buckets werden für die Zugriffskontrolle verwendet. Hinweis: S3 Buckets dürfen nicht mit Ceph Buckets verwechselt werden, die in der CRUSH Map verwendet werden.
  </para>

  <sect2 xml:id="ceph.nfsganesha.customrole.rgw_multiusers">
   <title>Verschiedene Object Gateway-Benutzer für NFS Ganesha</title>
   <para>
    Im folgenden Verfahrensbeispiel für den Salt Master sehen Sie, wie zwei NFS Ganesha-Rollen mit verschiedenen Object Gateway-Benutzern erstellt werden. In diesem Beispiel werden die Rollen <literal>gold</literal> und <literal>silver</literal> verwendet, für die DeepSea bereits Beispiele zu Konfigurationsdateien bereitstellt.
   </para>
   <procedure xml:id="proc.ceph.nfsganesha.rgw_multiusers">
    <step>
     <para>
      Öffnen Sie die Datei <filename>/srv/pillar/ceph/stack/global.yml</filename> mit einem Editor Ihrer Wahl. Erstellen Sie die Datei, falls noch nicht vorhanden.
     </para>
    </step>
    <step>
     <para>
      Die Datei muss folgende Zeilen enthalten:
     </para>
<screen>rgw_configurations:
  - rgw
  - silver
  - gold
ganesha_configurations:
  - silver
  - gold</screen>
     <para>
      Diese Rollen werden später in der <filename>policy.cfg</filename> zugewiesen.
     </para>
    </step>
    <step>
     <para>
      Erstellen Sie eine Datei <filename>/srv/salt/ceph/rgw/users/users.d/gold.yml</filename> und fügen Sie folgenden Inhalt hinzu:
     </para>
<screen>- { uid: "gold1", name: "gold1", email: "gold1@demo.nil" }</screen>
     <para>
      Erstellen sie eine Datei <filename>/srv/salt/ceph/rgw/users/users.d/silver.yml</filename> und fügen Sie folgenden Inhalt hinzu:
     </para>
<screen>- { uid: "silver1", name: "silver1", email: "silver1@demo.nil" }</screen>
    </step>
    <step>
     <para>
      Nun müssen für jede Rolle Schablonen für die <filename>ganesha.conf</filename> erstellt werden. Die Originalschablone von DeepSea ist ein guter Anfang. Erstellen Sie zwei Kopien:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/ganesha/files/
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 silver.conf.j2
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 gold.conf.j2</screen>
    </step>
    <step>
     <para>
      Für die neuen Rollen sind Schlüsselbunde für den Zugriff auf den Cluster erforderlich. Kopieren Sie <filename>ganesha.j2</filename>, um den Zugriff zu gewähren:
     </para>
<screen><prompt>root # </prompt><command>cp</command> ganesha.j2 silver.j2
<prompt>root # </prompt><command>cp</command> ganesha.j2 gold.j2</screen>
    </step>
    <step>
     <para>
      Kopieren Sie den Schlüsselbund für das Object Gateway:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/rgw/files/
<prompt>root # </prompt><command>cp</command> rgw.j2 silver.j2
<prompt>root # </prompt><command>cp</command> rgw.j2 gold.j2</screen>
    </step>
    <step>
     <para>
      Object Gateway benötigt auch die Konfiguration für die verschiedenen Rollen:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/configuration/files/
<prompt>root # </prompt><command>cp</command> ceph.conf.rgw silver.conf
<prompt>root # </prompt><command>cp</command> ceph.conf.rgw gold.conf</screen>
    </step>
    <step>
     <para>
      Weisen Sie die neu erstellten Rollen zu den Cluster Nodes in der Datei <filename>/srv/pillar/ceph/proposals/policy.cfg</filename> zu:
     </para>
<screen>role-silver/cluster/<replaceable>NODE1</replaceable>.sls
role-gold/cluster/<replaceable>NODE2</replaceable>.sls
 </screen>
     <para>
      Ersetzen Sie <replaceable>NODE1</replaceable> und <replaceable>NODE2</replaceable> durch die Namen der Nodes, denen Sie die Rollen zuweisen möchten.
     </para>
    </step>
    <step>
     <para>
      Führen Sie die DeepSea-Phasen 0 bis 4 aus.
     </para>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="ceph.nfsganesha.customrole.rgw_cephfs">
   <title>Trennen der CephFS- und Object Gateway-FSAL</title>
   <para>
    Im folgenden Verfahrensbeispiel für den Salt Master sehen Sie, wie zwei neue verschiedene Rollen erstellt werden, die CephFS und Object Gateway verwenden:
   </para>
   <procedure xml:id="proc.ceph.nfsganesha.customrole">
    <step>
     <para>
      Öffnen Sie die Datei <filename>/srv/pillar/ceph/rgw.sls</filename> mit einem Editor Ihrer Wahl. Erstellen Sie die Datei, falls noch nicht vorhanden.
     </para>
    </step>
    <step>
     <para>
      Die Datei muss folgende Zeilen enthalten:
     </para>
<screen>rgw_configurations:
  ganesha_cfs:
    users:
      - { uid: "demo", name: "Demo", email: "demo@demo.nil" }
  ganesha_rgw:
    users:
      - { uid: "demo", name: "Demo", email: "demo@demo.nil" }

ganesha_configurations:
  - ganesha_cfs
  - ganesha_rgw</screen>
     <para>
      Diese Rollen werden später in der <filename>policy.cfg</filename> zugewiesen.
     </para>
    </step>
    <step>
     <para>
      Nun müssen für jede Rolle Schablonen für die <filename>ganesha.conf</filename> erstellt werden. Die Originalschablone von DeepSea ist ein guter Anfang. Erstellen Sie zwei Kopien:
     </para>
<screen><prompt>root # </prompt><command>cd</command> /srv/salt/ceph/ganesha/files/
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 ganesha_rgw.conf.j2
<prompt>root # </prompt><command>cp</command> ganesha.conf.j2 ganesha_cfs.conf.j2</screen>
    </step>
    <step>
     <para>
      Bearbeiten Sie die Datei <filename>ganesha_rgw.conf.j2</filename> und entfernen Sie den Abschnitt:
     </para>
<screen>{% if salt.saltutil.runner('select.minions', cluster='ceph', roles='mds') != [] %}
        [...]
{% endif %}</screen>
    </step>
    <step>
     <para>
      Bearbeiten Sie die Datei <filename>ganesha_cfs.conf.j2</filename> und entfernen Sie den Abschnitt:
     </para>
<screen>{% if salt.saltutil.runner('select.minions', cluster='ceph', roles=role) != [] %}
        [...]
{% endif %}</screen>
    </step>
    <step>
     <para>
      Für die neuen Rollen sind Schlüsselbunde für den Zugriff auf den Cluster erforderlich. Kopieren Sie <filename>ganesha.j2</filename>, um den Zugriff zu gewähren:
     </para>
<screen><prompt>root # </prompt><command>cp</command> ganesha.j2 ganesha_rgw.j2
<prompt>root # </prompt><command>cp</command> ganesha.j2 ganesha_cfs.j2</screen>
     <para>
      Die Zeile <literal>caps mds = "allow *"</literal> kann aus der Datei <filename>ganesha_rgw.j2</filename> entfernt werden.
     </para>
    </step>
    <step>
     <para>
      Kopieren Sie den Schlüsselbund für das Object Gateway:
     </para>
<screen><prompt>root # </prompt><command>cp</command> /srv/salt/ceph/rgw/files/rgw.j2 \
/srv/salt/ceph/rgw/files/ganesha_rgw.j2</screen>
    </step>
    <step>
     <para>
      Object Gateway benötigt die Konfiguration für die neue Rolle:
     </para>
<screen><prompt>root # </prompt><command>cp</command> /srv/salt/ceph/configuration/files/ceph.conf.rgw \
/srv/salt/ceph/configuration/files/ceph.conf.ganesha_rgw</screen>
    </step>
    <step>
     <para>
      Weisen Sie die neu erstellten Rollen zu den Cluster Nodes in der Datei <filename>/srv/pillar/ceph/proposals/policy.cfg</filename> zu:
     </para>
<screen>role-ganesha_rgw/cluster/<replaceable>NODE1</replaceable>.sls
role-ganesha_cfs/cluster/<replaceable>NODE1</replaceable>.sls
 </screen>
     <para>
      Ersetzen Sie <replaceable>NODE1</replaceable> und <replaceable>NODE2</replaceable> durch die Namen der Nodes, denen Sie die Rollen zuweisen möchten.
     </para>
    </step>
    <step>
     <para>
      Führen Sie die DeepSea-Phasen 0 bis 4 aus.
     </para>
    </step>
   </procedure>
  </sect2>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.services">
  <title>Starten oder Neustarten von NFS Ganesha</title>

  <para>
   Führen Sie zum Aktivieren und Starten des NFS Ganesha Service folgende  Kommandos aus:
  </para>

<screen><prompt>root # </prompt><command>systemctl</command> enable nfs-ganesha
<prompt>root # </prompt><command>systemctl</command> start nfs-ganesha</screen>

  <para>
   Starten Sie NFS Ganesha neu mit:
  </para>

<screen><prompt>root # </prompt><command>systemctl</command> restart nfs-ganesha</screen>

  <para>
   Wenn NFS Ganesha gestartet oder neu gestartet wird, hat es eine Kulanzzeitüberschreitung von 90 Sekunden für NFS v4. Während des Kulanzzeitraums werden neue Anforderungen von Clients aktiv abgelehnt. Somit erfahren Clients möglicherweise eine Verlangsamung ihrer Anforderungen, wenn sich NFS im Kulanzzustand befindet.
  </para>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.loglevel">
  <title>Festlegen des Protokollierumfangs</title>

  <para>
   Sie ändern die standardmäßige Fehlersuchestufe <literal>NIV_EVENT</literal> durch Bearbeiten der Datei <filename>/etc/sysconfig/nfs-ganesha</filename>. Ersetzen Sie <literal>NIV_EVENT</literal> durch <literal>NIV_DEBUG</literal> oder <literal>NIV_FULL_DEBUG</literal>. Durch Erhöhen der Protokollausführlichkeit können in den Protokolldateien große Datenmengen produziert werden.
  </para>

<screen>OPTIONS="-L /var/log/ganesha/ganesha.log -f /etc/ganesha/ganesha.conf -N NIV_EVENT"</screen>

  <para>
   Nach dem Ändern des Protokollierumfangs ist ein Neustart des Service erforderlich.
  </para>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.verify">
  <title>Verifizieren der exportierten NFS-Freigabe</title>

  <para>
   In NFS v3 können Sie überprüfen, ob die NFS-Freigaben im NFS Ganesha Server Node exportiert werden:
  </para>

<screen><prompt>root # </prompt><command>showmount</command> -e
/ (everything)</screen>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.mount">
  <title>Einhängen der exportierten NFS-Freigabe</title>

  <para>
   Führen Sie zum Einhängen der exportierten NFS-Freigabe (wie in <xref linkend="ceph.nfsganesha.config"/> konfiguriert) auf einem Client-Host folgendes Kommando aus:
  </para>

<screen><prompt>root # </prompt><command>mount</command> -t nfs -o rw,noatime,sync \
 <replaceable>nfs_ganesha_server_hostname:/ /path/to/local/mountpoint</replaceable></screen>
 </sect1>
 <sect1 xml:id="ceph.nfsganesha.more">
  <title>Zusätzliche Ressourcen</title>

  <para>
   Die Originaldokumentation zu NFS Ganesha finden Sie unter <link xlink:href="https://github.com/nfs-ganesha/nfs-ganesha/wiki/Docs"/>.
  </para>
 </sect1>
</chapter>
