<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN"
"novdocx.dtd"
[
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<chapter id="cha.ceph.libvirt">
 <title>Using &libvirt; with &ceph;</title>
 <para>
  The &libvirt; library creates a virtual machine abstraction layer between
  hypervisor interfaces and the software applications that use them. With
  &libvirt;, developers and system administrators can focus on a common
  management framework, common API, and common shell interface (i.e.,
  <command>virsh</command>) to many different hypervisors, including
  &qemu;/&kvm;, &xen;, LXC, or VirtualBox.
 </para>
 <para>
  &ceph; block devices support &qemu;/&kvm;. You can use &ceph; block
  devices with software that interfaces with &libvirt;. The cloud solution
  uses &libvirt; to interact with &qemu;/&kvm;, and &qemu;/&kvm; interacts
  with Ceph block devices via <systemitem>librbd</systemitem>.
 </para>
 <para>
  To create VMs that use &ceph; block devices, use the procedures in the
  following sections. In the examples, we have used
  <literal>libvirt-pool</literal> for the pool name,
  <literal>client.libvirt</literal> for the user name, and
  <literal>new-libvirt-image</literal> for the image name. You may use any
  value you like, but ensure you replace those values when executing
  commands in the subsequent procedures.
 </para>
 <sect1 id="ceph.libvirt.cfg_ceph">
  <title>Configuring &ceph;</title>

  <para>
   To configure Ceph for use with &libvirt;, perform the following steps:
  </para>

  <procedure>
   <step>
    <para>
     Create a pool. The following example uses the pool name
     <literal>libvirt-pool</literal> with 128 placement groups.
    </para>
<screen>ceph osd pool create libvirt-pool 128 128</screen>
    <para>
     Verify that the pool exists.
    </para>
<screen>ceph osd lspools</screen>
   </step>
   <step>
    <para>
     Create a &ceph; User. The following example uses the &ceph; user name
     <literal>client.libvirt</literal> and references
     <literal>libvirt-pool</literal>.
    </para>
<screen>ceph auth get-or-create client.libvirt mon 'allow r' osd \
 'allow class-read object_prefix rbd_children, allow rwx pool=libvirt-pool'</screen>
    <para>
     Verify the name exists.
    </para>
<screen>ceph auth list</screen>
    <note>
     <para>
      &libvirt; will access &ceph; using the ID <literal>libvirt</literal>,
      not the &ceph; name <literal>client.libvirt</literal>. See
      <ulink
 url="http://ceph.com/docs/master/rados/operations/user-management#user"/>
      for a detailed explanation of the difference between ID and name.
     </para>
    </note>
   </step>
   <step>
    <para>
     Use &qemu; to create an image in your RBD pool. The following example
     uses the image name <literal>new-libvirt-image</literal> and references
     <literal>libvirt-pool</literal>.
    </para>
<screen>qemu-img create -f rbd rbd:libvirt-pool/new-libvirt-image 2G</screen>
    <para>
     Verify the image exists.
    </para>
<screen>rbd -p libvirt-pool ls</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 id="ceph.libvirt.virt-manager">
  <title>Preparing the VM Manager</title>

  <para>
   You may use &libvirt; without a VM manager, but you may find it simpler
   to create your first domain with <command>virt-manager</command>.
  </para>

  <procedure>
   <step>
    <para>
     Install a virtual machine manager.
    </para>
<screen>sudo zypper in virt-manager</screen>
   </step>
   <step>
    <para>
     Prepare/download an OS image of the system you want to run virtualized.
    </para>
   </step>
   <step>
    <para>
     Launch the virtual machine manager.
    </para>
<screen>virt-manager</screen>
   </step>
  </procedure>
 </sect1>
 <sect1 id="ceph.libvirt.create_vm">
  <title>Creating a VM</title>

  <para>
   To create a VM with <command>virt-manager</command>, perform the
   following steps:
  </para>

  <procedure>
   <step>
    <para>
     Choose the connection from the list, right-click it, and select
     <guimenu>New</guimenu>.
    </para>
   </step>
   <step>
    <para>
     <guimenu>Import existing disk image</guimenu> by providing path to the
     existing storage. Specify OS type, memory settings, and
     <guimenu>Name</guimenu> the virtual machine, for example
     <literal>libvirt-virtual-machine</literal>.
    </para>
   </step>
   <step>
    <para>
     Finish the configuration and start the VM.
    </para>
   </step>
   <step>
    <para>
     Verify that the newly created domain exists with <command>sudo virsh
     list</command>. If needed, specify the connection string, such as
    </para>
<screen role="ceph.libvirt.create_vm1"><command>virsh -c qemu+ssh://root@vm_host_hostname/system list</command>
Id    Name                           State
-----------------------------------------------
[...]
 9     libvirt-virtual-machine       running</screen>
   </step>
   <step>
    <para>
     Login to the VM and stop it before configuring it for use with &ceph;.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="ceph.libvirt.cfg_vm">
  <title>Configuring the VM</title>

  <para>
   When configuring the VM for use with &ceph;, it is important to use
   <command>virsh</command> where appropriate. Additionally,
   <command>virsh</command> commands often require root privileges (i.e.,
   <command>sudo</command>) and will not return appropriate results or
   notify you that that root privileges are required. For a reference of
   <command>virsh</command> commands, refer to
   <ulink url="http://www.libvirt.org/virshcmdref.html">Virsh Command
   Reference</ulink>.
  </para>

  <procedure>
   <step>
    <para>
     Open the configuration file with <command>virsh edit
     <replaceable>vm-domain-name</replaceable></command>.
    </para>
<screen>sudo virsh edit libvirt-virtual-machine</screen>
   </step>
   <step>
    <para>
     Under &lt;devices> there should be a &lt;disk> entry.
    </para>
<screen>&lt;devices>
    &lt;emulator>/usr/bin/qemu-system-x86_64&lt;/emulator>
    &lt;disk type='file' device='disk'>
      &lt;driver name='qemu' type='raw'/>
      &lt;source file='/path/to/image/recent-linux.img'/>
      &lt;target dev='vda' bus='virtio'/>
      &lt;address type='drive' controller='0' bus='0' unit='0'/>
    &lt;/disk></screen>
    <para>
     Replace <filename>/path/to/image/recent-linux.img</filename> with the
     path to the OS image.
    </para>
    <important>
     <para>
      Use <command>sudo virsh edit</command> instead of a text editor. If
      you edit the configuration file under
      <filename>/etc/libvirt/qemu</filename> with a text editor, &libvirt;
      may not recognize the change. If there is a discrepancy between the
      contents of the XML file under <filename>/etc/libvirt/qemu</filename>
      and the result of <command>sudo virsh dumpxml
      <replaceable>vm-domain-name</replaceable></command>, then your VM may
      not work properly.
     </para>
    </important>
   </step>
   <step>
    <para>
     Add the &ceph; RBD image you previously created as a &lt;disk> entry.
    </para>
<screen>&lt;disk type='network' device='disk'>
        &lt;source protocol='rbd' name='libvirt-pool/new-libvirt-image'>
                &lt;host name='<replaceable>monitor-host</replaceable>' port='6789'/>
        &lt;/source>
        &lt;target dev='vda' bus='virtio'/>
&lt;/disk></screen>
    <para>
     Replace <replaceable>monitor-host</replaceable> with the name of your
     host, and replace the pool and/or image name as necessary. You may add
     multiple &lt;host> entries for your &ceph; monitors. The
     <literal>dev</literal> attribute is the logical device name that will
     appear under the <filename>/dev</filename> directory of your VM. The
     optional bus attribute indicates the type of disk device to emulate.
     The valid settings are driver specific (e.g., ide, scsi, virtio, xen,
     usb or sata). See
     <ulink
url="http://www.libvirt.org/formatdomain.html#elementsDisks">Disks</ulink>
     for details of the &lt;disk> element, and its child elements and
     attributes.
    </para>
   </step>
   <step>
    <para>
     Save the file.
    </para>
   </step>
   <step>
    <para>
     If your &ceph; cluster has authentication enabled (it does by default),
     you must generate a secret.
    </para>
<screen>cat > secret.xml &lt;&lt;EOF
&lt;secret ephemeral='no' private='no'>
        &lt;usage type='ceph'>
                &lt;name>client.libvirt secret&lt;/name>
        &lt;/usage>
&lt;/secret>
EOF</screen>
   </step>
   <step>
    <para>
     Define the secret.
    </para>
<screen>sudo virsh secret-define --file secret.xml
&lt;uuid of secret is output here></screen>
   </step>
   <step>
    <para>
     Get the <literal>client.libvirt</literal> key and save the key string
     to a file.
    </para>
<screen>ceph auth get-key client.libvirt | sudo tee client.libvirt.key</screen>
   </step>
   <step>
    <para>
     Set the UUID of the secret.
    </para>
<screen>sudo virsh secret-set-value --secret <replaceable>uuid of secret</replaceable> \
--base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml</screen>
    <para>
     You must also set the secret manually by adding the following
     <literal>&amp;auth></literal> entry to the
     <literal>&amp;disk></literal> element you entered earlier (replacing
     the uuid value with the result from the command line example above).
    </para>
<screen>sudo virsh edit libvirt-virtual-machine</screen>
    <para>
     Then, add <literal>&amp;auth>&amp;/auth></literal> element to the
     domain configuration file:
    </para>
<screen>...
&amp;/source>
&amp;auth username='libvirt'>
        &amp;secret type='ceph' uuid='9ec59067-fdbc-a6c0-03ff-df165c0587b8'/>
&amp;/auth>
&amp;target ...</screen>
    <note>
     <para>
      The exemplary ID is <literal>libvirt</literal>, not the &ceph; name
      <literal>client.libvirt</literal> as generated at step 2 of
      <xref linkend="ceph.libvirt.cfg_ceph"/>. Ensure you use the ID
      component of the Ceph name you generated. If for some reason you need
      to regenerate the secret, you will have to execute <command>sudo virsh
      secret-undefine <replaceable>uuid</replaceable></command> before
      executing <command>sudo virsh secret-set-value</command> again.
     </para>
    </note>
   </step>
  </procedure>
 </sect1>
 <sect1 id="ceph.libvirt.summary">
  <title>Summary</title>

  <para>
   Once you have configured the VM for use with &ceph;, you can start the
   VM. To verify that the VM and &ceph; are communicating, you may perform
   the following procedures.
  </para>

  <procedure>
   <step>
    <para>
     Check to see if Ceph is running:
    </para>
<screen>ceph health</screen>
   </step>
   <step>
    <para>
     Check to see if the VM is running.
    </para>
<screen>sudo virsh list</screen>
   </step>
   <step>
    <para>
     Check to see if the VM is communicating with Ceph. Replace
     <replaceable>vm-domain-name</replaceable> with the name of your VM
     domain:
    </para>
<screen>sudo virsh qemu-monitor-command --hmp <replaceable>vm-domain-name</replaceable> 'info block'</screen>
   </step>
   <step>
    <para>
     Check to see if the device from &amp;target dev='hdb' bus='ide'/>
     appears under <filename>/dev</filename> or under
     <filename>/proc/partitions</filename>.
    </para>
<screen>ls /dev
cat /proc/partitions</screen>
   </step>
  </procedure>
 </sect1>
</chapter>
